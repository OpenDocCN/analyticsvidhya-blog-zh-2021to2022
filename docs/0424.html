<html>
<head>
<title>How to Auto Shutdown An Idle VM Instance on GCP to Cut Fat Bills</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何自动关闭GCP上的一个空闲虚拟机实例来削减高额账单</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/how-to-auto-shutdown-an-idle-vm-instance-on-gcp-to-cut-fat-bills-b08ae20437af?source=collection_archive---------5-----------------------#2021-01-16">https://medium.com/analytics-vidhya/how-to-auto-shutdown-an-idle-vm-instance-on-gcp-to-cut-fat-bills-b08ae20437af?source=collection_archive---------5-----------------------#2021-01-16</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="7c44" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">自动关闭GCP上的空闲虚拟机实例以控制您的GCP账单的配置</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es jd"><img src="../Images/b359cd89bc200c9db861d928f39f2e43.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*H1WcfW1kbQpfJMGEf7ECJQ.jpeg"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx translated">(图片来自<a class="ae jt" href="https://unsplash.com/" rel="noopener ugc nofollow" target="_blank">https://unsplash.com/</a>)</figcaption></figure><p id="b3a4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现收现付云计算(PAYG云计算)是一种流行的按使用量收费的云计算支付方式。你只需在使用服务时付费。这听起来非常好，除了一个问题，您可能会忘记关闭实例，这最终会花费大量不使用的时间。这篇文章介绍了如何在GCP上配置空闲VM实例的自动关闭。</p><p id="bc8f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">步骤1:将空闲关闭shell脚本上传到VM实例。</strong></p><p id="476a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Justin Shenk提供了idle-shutdown shell脚本作为Github gist(<a class="ae jt" href="https://gist.github.com/justinshenk/312b5e0ab7acc3b116f7bf3b6d888fa4" rel="noopener ugc nofollow" target="_blank">https://gist . Github . com/Justin Shenk/312 b5 E0 ab 7 ACC 3 b 116 f 7 BF 3 b 6d 888 fa 4</a>)。该脚本监控虚拟机实例的CPU使用情况。我们需要将它上传到虚拟机实例。</p><p id="09bb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果您通过GCP AI笔记本访问VM实例，您可以使用以下代码通过Jupyterlab下的终端加载文件:</p><pre class="je jf jg jh fd ju jv jw jx aw jy bi"><span id="7103" class="jz ka hi jv b fi kb kc l kd ke">cd /opt/deeplearning/bin</span><span id="8acc" class="jz ka hi jv b fi kf kc l kd ke">sudo wget <a class="ae jt" href="https://gist.githubusercontent.com/justinshenk/312b5e0ab7acc3b116f7bf3b6d888fa4/raw/59f021c2bf0388ba36e5a589dba52e233ee84964/idle-shutdown.sh" rel="noopener ugc nofollow" target="_blank">https://gist.githubusercontent.com/justinshenk/312b5e0ab7acc3b116f7bf3b6d888fa4/raw/59f021c2bf0388ba36e5a589dba52e233ee84964/idle-shutdown.sh</a><br/></span></pre><p id="5221" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">确保使用sudo命令。否则，由于权限问题，文件不会保存在文件夹中。</p><p id="3b72" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">第二步:配置实例的元数据</strong></p><p id="20cf" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">接下来，我们需要通过虚拟机实例编辑模式添加一个元数据“启动脚本”。滚动到“自定义元数据”部分，单击“添加项目”，在左侧框中输入“启动脚本”，在右侧框中输入“/opt/deep learning/bin/idle-shut down . sh”(我们在步骤1中保存的脚本的路径)。保存并退出实例编辑模式。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es kg"><img src="../Images/0084cf5d299cb81f6347ea496006b4ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wy1dT0joft0eLNvs0Zp-Zg.jpeg"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx translated">(虚拟机实例编辑元数据)</figcaption></figure><p id="172a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">第三步:配置启动脚本</strong></p><p id="86c5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">启动脚本中的默认设置是，当实例cpu使用率连续一小时不超过10%时，关闭VM实例。您可以自定义cpu使用率阈值(10%)和/或空闲时间窗口(一小时)。</p><p id="f8ce" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">步骤4:安装软件包“bc”</strong></p><p id="e9e6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">需要程序包' bc '来检查实例cpu使用情况。您可以在Linux VM实例上安装软件包，如下所示:</p><pre class="je jf jg jh fd ju jv jw jx aw jy bi"><span id="b441" class="jz ka hi jv b fi kb kc l kd ke">sudo apt-get install bc</span></pre><p id="a778" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果它在某些Linux版本上失败了，您可能需要更新您的apt，如下所示:</p><pre class="je jf jg jh fd ju jv jw jx aw jy bi"><span id="b6ca" class="jz ka hi jv b fi kb kc l kd ke">sudo apt-get --update<br/>sudo apt-get --upgrade<br/>sudo apt-get install --reinstall apt</span></pre><p id="a84f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">重启您的实例，您应该能够享受自动关机功能，以削减庞大的云账单。</p></div></div>    
</body>
</html>