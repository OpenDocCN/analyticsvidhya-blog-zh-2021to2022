<html>
<head>
<title>Build Email Spam Classification Model Using Python and SpaCy</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">利用Python和SpaCy构建垃圾邮件分类模型</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/build-email-spam-classification-model-using-python-and-spacy-a0c914a83f4d?source=collection_archive---------3-----------------------#2021-08-22">https://medium.com/analytics-vidhya/build-email-spam-classification-model-using-python-and-spacy-a0c914a83f4d?source=collection_archive---------3-----------------------#2021-08-22</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/cfacffb15d7bc8334a8ff53fbe94b920.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mzV-OS06C68MRDkI-xaLbA.jpeg"/></div></div></figure><p id="8834" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">目前，在这个数字世界中，来自不同来源和不同格式的数据呈指数级增长，这包括不同类型的数据，包括结构化(数字、表格)、半结构化(JSON)和非结构化(文本、音频、视频)。</p><p id="06ac" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">数字数据是构建各种机器学习和统计模型的主要来源，但随着文本数据的增加，人们正在使用自然语言处理技术来处理和提取文本中有意义的信息，最终有助于做出正确的决策</p><p id="26e6" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">从文本数据中生成洞察不像从数字数据中生成洞察那么简单，因为文本数据不是结构化的。为了处理文本数据，第一步是将非结构化文本数据转换成结构化数据。</p><p id="46cc" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们有各种Python库来提取文本数据，如<strong class="is hj"> NLTK、spacy、文本blob </strong>。</p><p id="830a" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">在本文中，我们使用了</strong> <a class="ae jo" href="http://spacy.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="is hj"> spacy </strong> </a> <strong class="is hj">自然语言python库</strong> <strong class="is hj">构建了一个垃圾邮件分类模型，只用几行代码就能识别出一封邮件是不是垃圾邮件。</strong></p><p id="e960" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">有几种不同的算法来构建这个分类器模型，但今天我们将使用spacy和python来构建一个，因为它们为我们提供了以更优化的方式和最少的代码量来构建模型的好处。</p><p id="22d8" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">获得完整的代码签出我的Kaggle笔记本<a class="ae jo" href="https://www.kaggle.com/divyhshah/30-days-of-ml-sms-classifier-using-spacy" rel="noopener ugc nofollow" target="_blank">这里</a></p><p id="19cf" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">现在没有任何延迟，让我们开始一步一步地构建模型</strong></p><h1 id="2de7" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated"><strong class="ak">导入库</strong></h1><pre class="kn ko kp kq fd kr ks kt ku aw kv bi"><span id="6497" class="kw jq hi ks b fi kx ky l kz la">import nltk<br/>import random<br/>import pandas as pd<br/>import numpy as np<br/>import seaborn as sns<br/>import spacy<br/>from spacy.util import minibatch<br/>import matplotlib.pyplot as plt<br/>from sklearn.metrics import precision_score, recall_score, plot_confusion_matrix, classification_report, accuracy_score, f1_score, confusion_matrix<br/>from sklearn import metrics<br/>%matplotlib inline</span></pre><h1 id="091f" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated"><strong class="ak">数据加载</strong></h1><pre class="kn ko kp kq fd kr ks kt ku aw kv bi"><span id="9638" class="kw jq hi ks b fi kx ky l kz la">data = pd.read_csv('../input/sms-spam-collection-dataset/spam.csv')</span></pre><p id="d092" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">你可以参考我的笔记本<a class="ae jo" href="https://www.kaggle.com/divyhshah/30-days-of-ml-sms-classifier-using-spacy" rel="noopener ugc nofollow" target="_blank">这里</a>下载数据集</p><h1 id="52f5" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated"><strong class="ak">探索类别标签</strong></h1><figure class="kn ko kp kq fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lb"><img src="../Images/c10e6df7ca6d1c0e138edbdac23e8972.png" data-original-src="https://miro.medium.com/v2/resize:fit:1236/format:webp/0*duQLgR2Fdt1N5_ke.png"/></div></div></figure><p id="4c20" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">正如您在这里看到的，火腿和垃圾邮件的分布分别为87 %和13 %</p><p id="f768" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">让我们进一步创建一个<strong class="is hj">空间</strong>模型和管道</p><pre class="kn ko kp kq fd kr ks kt ku aw kv bi"><span id="aae5" class="kw jq hi ks b fi kx ky l kz la"><em class="lc"># create empty model</em><br/>nlp = spacy.blank("en")<br/><br/>text_cls = nlp.create_pipe("textcat", config={"exclusive_classes": True, "architecture": "bow"})<br/><br/><em class="lc"># add pipeline in model we can add other steps in pipeline also but for now i am not adding tokenization, lemmetization, stop word removation etc. steps</em><br/>nlp.add_pipe(text_cls)<br/><br/><em class="lc"># add your customer label in pipeline</em><br/>text_cls.add_label('ham')<br/>text_cls.add_label('spam')</span></pre><p id="120c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们已经用英语创建了空空间模型。</p><p id="0036" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在下一步中，我们只是创建一个管道定义来执行文本分类，在配置(config)部分，我们必须在这里指定字典，我们将其指定为一个独占类，这意味着我们将在我们的情况下提供目标类spam或ham。使用<strong class="is hj"> bow (bag-of-words) </strong>架构。</p><p id="0e28" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们也可以使用内置的空间架构。</p><p id="d4e8" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在，我们在空模型中添加了这个管道。</p><p id="1008" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">接下来，我们添加目标类spam和ham来创建文本分类模型</p><h1 id="765f" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated"><strong class="ak">训练-测试和分割</strong></h1><p id="db6e" class="pw-post-body-paragraph iq ir hi is b it ld iv iw ix le iz ja jb lf jd je jf lg jh ji jj lh jl jm jn hb bi translated">与其他ML模型开发类似，我们使用训练测试分割将数据集分割为训练和测试部分。</p><p id="7526" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">训练数据集-用于训练模型</p><p id="e925" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">测试数据集—用于验证模型的性能</p><pre class="kn ko kp kq fd kr ks kt ku aw kv bi"><span id="1997" class="kw jq hi ks b fi kx ky l kz la">x_train, x_test, y_train, y_test = train_test_split(data['text'], data['target'], test_size=0.3, random_state = 7)</span></pre><p id="b994" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">与其他sklearn模型不同，在spacy中，您不能将目标数据指定为单个列，我们必须创建一个目标类的布尔列表。</p><pre class="kn ko kp kq fd kr ks kt ku aw kv bi"><span id="9d38" class="kw jq hi ks b fi kx ky l kz la"><em class="lc"># Create the train and test data for the spacy model</em><br/>train_lables = [{'cats': {'ham': label == 'ham',<br/>                          'spam': label == 'spam'}}  for label <strong class="ks hj">in</strong> y_train]<br/>test_lables = [{'cats': {'ham': label == 'ham',<br/>                      'spam': label == 'spam'}}  for label <strong class="ks hj">in</strong> y_test]<br/><br/><em class="lc"># Spacy model data</em><br/>train_data = list(zip(x_train, train_lables))<br/>test_data = list(zip(x_test, test_lables))</span></pre><p id="b4cb" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在我们已经做好了所有的数据准备，所以让我们快速进入模型构建阶段。</p><pre class="kn ko kp kq fd kr ks kt ku aw kv bi"><span id="47bb" class="kw jq hi ks b fi kx ky l kz la">def train_model(model, train_data, optimizer, batch_size, epochs=10):<br/>    losses = {}<br/>    random.seed(1)<br/><br/>    for epoch <strong class="ks hj">in</strong> range(epochs):<br/>        random.shuffle(train_data)<br/><br/>        batches = minibatch(train_data, size=batch_size)<br/>        for batch <strong class="ks hj">in</strong> batches:<br/>            <em class="lc"># Split batch into texts and labels</em><br/>            texts, labels = zip(*batch)<br/><br/>            <em class="lc"># Update model with texts and labels</em><br/>            model.update(texts, labels, sgd=optimizer, losses=losses)<br/>        print("Loss: <strong class="ks hj">{}</strong>".format(losses['textcat']))<br/><br/>    return losses['textcat']</span></pre><p id="e33e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这里我创建了上面的函数来训练空间模型。</p><pre class="kn ko kp kq fd kr ks kt ku aw kv bi"><span id="f5d6" class="kw jq hi ks b fi kx ky l kz la">optimizer = nlp.begin_training()<br/>batch_size = 5<br/>epochs = 20<br/><br/><em class="lc"># Training the model</em><br/>train_model(nlp, train_data, optimizer, batch_size, epochs)</span></pre><p id="3276" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">尼斯（法国城市名）..我们刚刚完成了模型训练，现在让我们进入预测部分</p><pre class="kn ko kp kq fd kr ks kt ku aw kv bi"><span id="c2e9" class="kw jq hi ks b fi kx ky l kz la">def get_predictions(model, texts):<br/>    <em class="lc"># Use the model's tokenizer to tokenize each input text</em><br/>    docs = [model.tokenizer(text) for text <strong class="ks hj">in</strong> texts]<br/><br/>    <em class="lc"># Use textcat to get the scores for each doc</em><br/>    text_cls = model.get_pipe('textcat')<br/>    scores, _ = text_cls.predict(docs)<br/><br/>    <em class="lc"># From the scores, find the label with the highest score/probability</em><br/>    predicted_labels = scores.argmax(axis=1)<br/>    predicted_class = [text_cls.labels[label] for label <strong class="ks hj">in</strong> predicted_labels]<br/><br/>    return predicted_class</span></pre><p id="83f1" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我创建了上面的广义函数来生成预测</p><pre class="kn ko kp kq fd kr ks kt ku aw kv bi"><span id="1e76" class="kw jq hi ks b fi kx ky l kz la">train_predictions = get_predictions(nlp, x_train)<br/>test_predictions = get_predictions(nlp, x_test)<br/>train_accuracy = accuracy_score(y_train, train_predictions)<br/>test_accuracy = accuracy_score(y_test, test_predictions)<br/><br/>print("Train accuracy: <strong class="ks hj">{}</strong>".format(train_accuracy))<br/>print("Test accuracy: <strong class="ks hj">{}</strong>".format(test_accuracy))</span></pre><p id="4dc1" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">哇..我们获得了很好的精确度</p><pre class="kn ko kp kq fd kr ks kt ku aw kv bi"><span id="c9a3" class="kw jq hi ks b fi kx ky l kz la">Train accuracy: 1.0<br/>Test accuracy: 0.9802631578947368</span></pre><p id="4b2a" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在，最后让我们检查混淆矩阵</p><figure class="kn ko kp kq fd ij er es paragraph-image"><div class="er es li"><img src="../Images/0e616c89612b0410e2d3fa2e6db6cb3a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1118/format:webp/0*1GZRkWjhUj5M1yOR.png"/></div><figcaption class="lj lk et er es ll lm bd b be z dx translated">模型测试混淆矩阵</figcaption></figure><p id="0685" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">测试混淆矩阵</p><p id="691d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">恭喜你！你只需学习如何使用spacy和python创建一个模型，并在自己的电脑上进行实验<a class="ae jo" href="https://www.kaggle.com/divyhshah/30-days-of-ml-sms-classifier-using-spacy" rel="noopener ugc nofollow" target="_blank">看看这个笔记本</a>并玩玩它。</p><p id="af37" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">请不要忘记给笔记本投票。</p><p id="e38f" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如果你觉得这篇文章有用，请关注并喜欢它。</p><p id="5ebf" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">快乐学习！</p></div></div>    
</body>
</html>