<html>
<head>
<title>Object Detection Model on Custom Dataset Using YOLO Pre-Trained Weights — The Training</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用YOLO预训练权重的自定义数据集上的对象检测模型——训练</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/object-detection-model-on-custom-dataset-using-yolo-v3-tiny-pre-trained-weights-the-training-34ab74100147?source=collection_archive---------5-----------------------#2021-04-18">https://medium.com/analytics-vidhya/object-detection-model-on-custom-dataset-using-yolo-v3-tiny-pre-trained-weights-the-training-34ab74100147?source=collection_archive---------5-----------------------#2021-04-18</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><h1 id="b911" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated">物体检测:</h1><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="ji jj di jk bf jl"><div class="er es jc"><img src="../Images/9cf4f6d670c528c5ffbfb6588fcd468b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*zY1Ses3gpZVKeehRvsOEeA.gif"/></div></div></figure><h1 id="1775" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated">数据准备</h1><p id="8f0d" class="pw-post-body-paragraph jo jp hh jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ha bi translated">通过在终端中运行以下代码片段下载<a class="ae km" href="https://github.com/tzutalin/labelImg" rel="noopener ugc nofollow" target="_blank"> LabelImg </a>:</p><pre class="jd je jf jg fd kn ko kp kq aw kr bi"><span id="41f9" class="ks if hh ko b fi kt ku l kv kw">git clone https://github.com/tzutalin/labelImg.git</span></pre><p id="1a95" class="pw-post-body-paragraph jo jp hh jq b jr kx jt ju jv ky jx jy jz kz kb kc kd la kf kg kh lb kj kk kl ha bi translated">现在，打开目录，运行“python3 labelImage.py”。它会打开一个这样的窗口。</p><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="ji jj di jk bf jl"><div class="er es lc"><img src="../Images/962526fc3f7b9237f5299ba163f08c4e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3dDEwbyv7mij1lBsLQBGJw.png"/></div></div></figure><p id="988b" class="pw-post-body-paragraph jo jp hh jq b jr kx jt ju jv ky jx jy jz kz kb kc kd la kf kg kh lb kj kk kl ha bi translated">点击“打开目录”并选择包含数据的目录。</p><p id="672a" class="pw-post-body-paragraph jo jp hh jq b jr kx jt ju jv ky jx jy jz kz kb kc kd la kf kg kh lb kj kk kl ha bi translated">现在点击RectBox上的Create，做一个盒子，标上你想要的名字…</p><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="ji jj di jk bf jl"><div class="er es lc"><img src="../Images/869096fd19639d24cbe6e6f829ff2a31.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_XSmogE-HScOwFfmIBbd1g.png"/></div></div></figure><p id="f8c5" class="pw-post-body-paragraph jo jp hh jq b jr kx jt ju jv ky jx jy jz kz kb kc kd la kf kg kh lb kj kk kl ha bi translated">在标记数据后，我们必须制作一个模型(大脑)，它将把盒子放在正确的位置，也就是物体所在的位置。</p><p id="4554" class="pw-post-body-paragraph jo jp hh jq b jr kx jt ju jv ky jx jy jz kz kb kc kd la kf kg kh lb kj kk kl ha bi translated">将包含标签的文件夹上传到您的驱动器。</p><p id="4be7" class="pw-post-body-paragraph jo jp hh jq b jr kx jt ju jv ky jx jy jz kz kb kc kd la kf kg kh lb kj kk kl ha bi translated">所以这里有一个<a class="ae km" href="https://github.com/nisargbhatt09/Object-Detection-Custom-Data/blob/main/Yolo_Training.ipynb" rel="noopener ugc nofollow" target="_blank">链接</a>来训练模型:“<a class="ae km" href="https://github.com/nisargbhatt09/Object-Detection-Custom-Data/blob/main/Yolo_Training.ipynb" rel="noopener ugc nofollow" target="_blank">https://github . com/nisargbhatt 09/Object-Detection-Custom-Data/blob/main/Yolo _ training . ipynb</a>”</p></div><div class="ab cl ld le go lf" role="separator"><span class="lg bw bk lh li lj"/><span class="lg bw bk lh li lj"/><span class="lg bw bk lh li"/></div><div class="ha hb hc hd he"><h1 id="3bb5" class="ie if hh bd ig ih lk ij ik il ll in io ip lm ir is it ln iv iw ix lo iz ja jb bi translated">让我们编码</h1><p id="5b4b" class="pw-post-body-paragraph jo jp hh jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ha bi translated">如果你的设备上没有GPU，我更喜欢你使用Google Colab。</p><p id="1e72" class="pw-post-body-paragraph jo jp hh jq b jr kx jt ju jv ky jx jy jz kz kb kc kd la kf kg kh lb kj kk kl ha bi translated">因此，首先让我们检查是否启用了GPU。</p><pre class="jd je jf jg fd kn ko kp kq aw kr bi"><span id="7cea" class="ks if hh ko b fi kt ku l kv kw">!nvidia-smi</span></pre><p id="c629" class="pw-post-body-paragraph jo jp hh jq b jr kx jt ju jv ky jx jy jz kz kb kc kd la kf kg kh lb kj kk kl ha bi translated">如果你得到这样的东西，GPU是启用的。</p><pre class="jd je jf jg fd kn ko kp kq aw kr bi"><span id="4109" class="ks if hh ko b fi kt ku l kv kw">+------------------------------------------------------------------+ | NVIDIA-SMI 460.56  Driver Version: 460.32.03  CUDA Version: 11.2 | |---------------------------+------------------+-------------------+ | GPU  Name        Persistence-M| Bus-Id        Disp.A | Volatile Uncorr. ECC | | Fan  Temp  Perf  Pwr:Usage/Cap|         Memory-Usage | GPU-Util  Compute M. | |                               |                      |               MIG M. | |===============================+======================+======================| |   0  Tesla P100-PCIE...  Off  | 00000000:00:04.0 Off |                    0 | | N/A   37C    P0    26W / 250W |      0MiB / 16280MiB |      0%      Default | |                               |                      |                  N/A | +-------------------------------+----------------------+----------------------+                                                                                 +-----------------------------------------------------------------------------+ | Processes:                                                                  | |  GPU   GI   CI        PID   Type   Process name                  GPU Memory | |        ID   ID                                                   Usage      | |=============================================================================| |  No running processes found                                                 | +-----------------------------------------------------------------------------+</span></pre><p id="7970" class="pw-post-body-paragraph jo jp hh jq b jr kx jt ju jv ky jx jy jz kz kb kc kd la kf kg kh lb kj kk kl ha bi translated">访问Google Drive</p><pre class="jd je jf jg fd kn ko kp kq aw kr bi"><span id="3c93" class="ks if hh ko b fi kt ku l kv kw">from google.colab import drive</span><span id="2592" class="ks if hh ko b fi lp ku l kv kw">drive.mount('/content/gdrive')</span></pre><p id="5f19" class="pw-post-body-paragraph jo jp hh jq b jr kx jt ju jv ky jx jy jz kz kb kc kd la kf kg kh lb kj kk kl ha bi translated">驱动器上的项目列表</p><pre class="jd je jf jg fd kn ko kp kq aw kr bi"><span id="1fb5" class="ks if hh ko b fi kt ku l kv kw">!ln -s /content/gdrive/My\ Drive/ /mydrive</span><span id="62ce" class="ks if hh ko b fi lp ku l kv kw">!ls /mydrive</span></pre><p id="aaf6" class="pw-post-body-paragraph jo jp hh jq b jr kx jt ju jv ky jx jy jz kz kb kc kd la kf kg kh lb kj kk kl ha bi translated">Darknet:是一个开源的神经网络框架。我们稍后将使用它来训练预训练的权重。</p><p id="5533" class="pw-post-body-paragraph jo jp hh jq b jr kx jt ju jv ky jx jy jz kz kb kc kd la kf kg kh lb kj kk kl ha bi translated">克隆黑暗网络:</p><pre class="jd je jf jg fd kn ko kp kq aw kr bi"><span id="e3c7" class="ks if hh ko b fi kt ku l kv kw">!git clone https://github.com/AlexeyAB/darknet</span></pre><p id="7315" class="pw-post-body-paragraph jo jp hh jq b jr kx jt ju jv ky jx jy jz kz kb kc kd la kf kg kh lb kj kk kl ha bi translated">用GPU设置OpenCV</p><pre class="jd je jf jg fd kn ko kp kq aw kr bi"><span id="3141" class="ks if hh ko b fi kt ku l kv kw"># change makefile to have GPU and OPENCV enable</span><span id="9f9f" class="ks if hh ko b fi lp ku l kv kw">%cd darknet</span><span id="23d4" class="ks if hh ko b fi lp ku l kv kw">!sed -i 's/OPENCV=0/OPENCV=1/' Makefile</span><span id="f92d" class="ks if hh ko b fi lp ku l kv kw">!sed -i 's/GPU=0/GPU=1/' Makefile</span><span id="5bbf" class="ks if hh ko b fi lp ku l kv kw">!sed -i 's/CUDNN=0/CUDNN=1/' Makefile</span><span id="c2fd" class="ks if hh ko b fi lp ku l kv kw">!make</span></pre><p id="40a3" class="pw-post-body-paragraph jo jp hh jq b jr kx jt ju jv ky jx jy jz kz kb kc kd la kf kg kh lb kj kk kl ha bi translated">现在让我们从darknet的cfg目录中更改配置文件“yolov3-tiny.cfg”。这是针对一个类的，你可能有不止一个，只需用你想要的类的数量来改变1。</p><pre class="jd je jf jg fd kn ko kp kq aw kr bi"><span id="3494" class="ks if hh ko b fi kt ku l kv kw">!cp cfg/yolov3-tiny.cfg cfg/yolov3_training.cfg</span><span id="561d" class="ks if hh ko b fi lp ku l kv kw">!sed -i 's/batch=1/batch=64/' cfg/yolov3_training.cfg</span><span id="e634" class="ks if hh ko b fi lp ku l kv kw">!sed -i 's/subdivisions=1/subdivisions=16/' cfg/yolov3_training.cfg</span><span id="64fb" class="ks if hh ko b fi lp ku l kv kw">!sed -i 's/max_batches = 500200/max_batches = 4000/' cfg/yolov3_training.cfg</span><span id="97b0" class="ks if hh ko b fi lp ku l kv kw">!sed -i '610 s@classes=80@classes=1@' cfg/yolov3_training.cfg</span><span id="a3f2" class="ks if hh ko b fi lp ku l kv kw">!sed -i '696 s@classes=80@classes=1@' cfg/yolov3_training.cfg</span><span id="528c" class="ks if hh ko b fi lp ku l kv kw">!sed -i '783 s@classes=80@classes=1@' cfg/yolov3_training.cfg</span><span id="6a25" class="ks if hh ko b fi lp ku l kv kw">!sed -i '603 s@filters=255@filters=18@' cfg/yolov3_training.cfg</span><span id="2a3d" class="ks if hh ko b fi lp ku l kv kw">!sed -i '689 s@filters=255@filters=18@' cfg/yolov3_training.cfg</span><span id="984d" class="ks if hh ko b fi lp ku l kv kw">!sed -i '776 s@filters=255@filters=18@' cfg/yolov3_training.cfg</span></pre><p id="579b" class="pw-post-body-paragraph jo jp hh jq b jr kx jt ju jv ky jx jy jz kz kb kc kd la kf kg kh lb kj kk kl ha bi translated">在您的驱动器上创建一个文件夹来保存权重。</p><pre class="jd je jf jg fd kn ko kp kq aw kr bi"><span id="0785" class="ks if hh ko b fi kt ku l kv kw"># Create folder on google drive so that we can save there the weights</span><span id="e551" class="ks if hh ko b fi lp ku l kv kw">!mkdir "/mydrive/yolov3_w1"</span></pre><p id="de02" class="pw-post-body-paragraph jo jp hh jq b jr kx jt ju jv ky jx jy jz kz kb kc kd la kf kg kh lb kj kk kl ha bi translated">我们将在数据目录中创建一个名为“obj.data”的文件来保存所有的类名，这里我只使用了一个类，所以请耐心等待😌️</p><pre class="jd je jf jg fd kn ko kp kq aw kr bi"><span id="4428" class="ks if hh ko b fi kt ku l kv kw">!echo "Class_Name" &gt; data/obj.names</span><span id="9bee" class="ks if hh ko b fi lp ku l kv kw">!echo -e 'classes= 1\ntrain  = data/train.txt\nvalid  = data/test.txt\nnames = data/obj.names\nbackup = /mydrive/yolov3_w1' &gt; data/obj.data</span><span id="a999" class="ks if hh ko b fi lp ku l kv kw">!mkdir data/obj</span></pre><p id="83b8" class="pw-post-body-paragraph jo jp hh jq b jr kx jt ju jv ky jx jy jz kz kb kc kd la kf kg kh lb kj kk kl ha bi translated">现在我们需要预先训练的权重，您可以使用darknet53.conv.74。这个权重将根据给定的数据进行重新训练。</p><pre class="jd je jf jg fd kn ko kp kq aw kr bi"><span id="46eb" class="ks if hh ko b fi kt ku l kv kw">!wget https://pjreddie.com/media/files/darknet53.conv.74</span></pre><p id="4163" class="pw-post-body-paragraph jo jp hh jq b jr kx jt ju jv ky jx jy jz kz kb kc kd la kf kg kh lb kj kk kl ha bi translated">从驱动器中提取目录，将目录解压缩到data/obj。</p><pre class="jd je jf jg fd kn ko kp kq aw kr bi"><span id="8fc8" class="ks if hh ko b fi kt ku l kv kw">!unzip /mydrive/data.zip -d data/obj</span></pre><p id="58e2" class="pw-post-body-paragraph jo jp hh jq b jr kx jt ju jv ky jx jy jz kz kb kc kd la kf kg kh lb kj kk kl ha bi translated">我们将把。txt文件。因为我们只处理一个类，所以应该是类0。(缩进不正确，请参考代码<a class="ae km" href="https://github.com/nisargbhatt09/Object-Detection-Custom-Data/blob/main/Yolo_Training.ipynb" rel="noopener ugc nofollow" target="_blank">链接</a>。)</p><pre class="jd je jf jg fd kn ko kp kq aw kr bi"><span id="af89" class="ks if hh ko b fi kt ku l kv kw">import glob</span><span id="a4cf" class="ks if hh ko b fi lp ku l kv kw">import os</span><span id="8013" class="ks if hh ko b fi lp ku l kv kw">import re</span><span id="39c2" class="ks if hh ko b fi lp ku l kv kw">txt_file_paths = glob.glob(r"data/obj/new_dataset/*.txt")</span><span id="bba0" class="ks if hh ko b fi lp ku l kv kw">for i, file_path in enumerate(txt_file_paths):</span><span id="cc39" class="ks if hh ko b fi lp ku l kv kw"># get image size</span><span id="76a3" class="ks if hh ko b fi lp ku l kv kw">with open(file_path, "r") as f_o:</span><span id="ac4b" class="ks if hh ko b fi lp ku l kv kw">lines = f_o.readlines()</span><span id="fb5b" class="ks if hh ko b fi lp ku l kv kw">text_converted = []</span><span id="4235" class="ks if hh ko b fi lp ku l kv kw">for line in lines:</span><span id="5519" class="ks if hh ko b fi lp ku l kv kw">print(line)</span><span id="f61f" class="ks if hh ko b fi lp ku l kv kw">numbers = re.findall("[0-9.]+", line)</span><span id="4bf3" class="ks if hh ko b fi lp ku l kv kw">print(numbers)</span><span id="6079" class="ks if hh ko b fi lp ku l kv kw">if numbers:</span><span id="395c" class="ks if hh ko b fi lp ku l kv kw"># Define coordinates</span><span id="f33f" class="ks if hh ko b fi lp ku l kv kw">text = "{} {} {} {} {}".format(0, numbers[1], numbers[2], numbers[3], numbers[4])</span><span id="9bbb" class="ks if hh ko b fi lp ku l kv kw">text_converted.append(text)</span><span id="6cf9" class="ks if hh ko b fi lp ku l kv kw">print(i, file_path)</span><span id="d645" class="ks if hh ko b fi lp ku l kv kw">print(text)</span><span id="3c2d" class="ks if hh ko b fi lp ku l kv kw"># Write file</span><span id="dd7a" class="ks if hh ko b fi lp ku l kv kw">with open(file_path, 'w') as fp:</span><span id="dc17" class="ks if hh ko b fi lp ku l kv kw">for item in text_converted:</span><span id="0dd0" class="ks if hh ko b fi lp ku l kv kw">fp.writelines("%s\n" % item)</span></pre><p id="05fd" class="pw-post-body-paragraph jo jp hh jq b jr kx jt ju jv ky jx jy jz kz kb kc kd la kf kg kh lb kj kk kl ha bi translated">收集jpg文件</p><pre class="jd je jf jg fd kn ko kp kq aw kr bi"><span id="65c0" class="ks if hh ko b fi kt ku l kv kw">import glob</span><span id="9c73" class="ks if hh ko b fi lp ku l kv kw">images_list = glob.glob("data/obj/new_dataset/*.jpg")</span><span id="1eb7" class="ks if hh ko b fi lp ku l kv kw">## Perform Normalization!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!</span><span id="9e1f" class="ks if hh ko b fi lp ku l kv kw">### I have not done it........</span><span id="e98a" class="ks if hh ko b fi lp ku l kv kw">print(images_list)</span></pre><p id="3170" class="pw-post-body-paragraph jo jp hh jq b jr kx jt ju jv ky jx jy jz kz kb kc kd la kf kg kh lb kj kk kl ha bi translated">创建train.txt文件，其中包含jpg文件的名称。</p><pre class="jd je jf jg fd kn ko kp kq aw kr bi"><span id="42c6" class="ks if hh ko b fi kt ku l kv kw">file = open("data/train.txt", "w")</span><span id="57ae" class="ks if hh ko b fi lp ku l kv kw">file.write("\n".join(images_list))</span><span id="7598" class="ks if hh ko b fi lp ku l kv kw">file.close()</span></pre><p id="4d43" class="pw-post-body-paragraph jo jp hh jq b jr kx jt ju jv ky jx jy jz kz kb kc kd la kf kg kh lb kj kk kl ha bi translated">开始训练，等到模型收敛。</p><h1 id="a9b3" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated">等待永恒…</h1><pre class="jd je jf jg fd kn ko kp kq aw kr bi"><span id="0b25" class="ks if hh ko b fi kt ku l kv kw">!./darknet detector train data/obj.data cfg/yolov3_training.cfg darknet53.conv.74 -dont_show</span></pre><p id="d880" class="pw-post-body-paragraph jo jp hh jq b jr kx jt ju jv ky jx jy jz kz kb kc kd la kf kg kh lb kj kk kl ha bi translated">此后，重量将存储在驱动器的“yolov3_w1”中。</p><h1 id="659c" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated">你猜对了！！！</h1><p id="108e" class="pw-post-body-paragraph jo jp hh jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ha bi translated">感谢阅读，请鼓掌并分享这篇文章。</p></div></div>    
</body>
</html>