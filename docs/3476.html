<html>
<head>
<title>Let’s talk about Spark (Un)Cache/(Un)Persist in Table/View/DataFrame, In depth</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">让我们深入讨论一下表/视图/数据帧中的Spark (Un)Cache/(Un)Persist</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/lets-talk-about-spark-un-cache-un-persist-in-table-view-dataframe-in-depth-3b943a45fb3e?source=collection_archive---------0-----------------------#2021-07-03">https://medium.com/analytics-vidhya/lets-talk-about-spark-un-cache-un-persist-in-table-view-dataframe-in-depth-3b943a45fb3e?source=collection_archive---------0-----------------------#2021-07-03</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/1663ad1fae19ca9bf02ea0c11f8a5d71.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*0C_Sc0i4QCO2KxiQ"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">Jason Dent 在<a class="ae iu" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><p id="de6b" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我们有100多个博客和页面讨论spark中的缓存和持久化。</p><p id="8952" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在这篇博客中，我们的目的不仅仅是谈论<strong class="ix hj">缓存或持久化</strong>，而是向前迈出一步，向您介绍它是如何在<strong class="ix hj">表、视图和数据帧</strong>之上工作的。</p><p id="013c" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">对于DataFrame，我们知道cache或persist命令不会立即在内存中缓存数据，因为它是一个<strong class="ix hj">转换</strong>。</p><p id="534a" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在调用任何像<strong class="ix hj"> count </strong>这样的动作时，它会将数据具体化。</p><p id="bac1" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">但是万一<strong class="ix hj">spark . sqlcontext . cachetable(dbname . table)</strong>会实现吗？</p><p id="986e" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">没有</strong>，所以还是那句话。cacheTable也是转换，而不是动作。</p><p id="6989" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我们应该显式地调用一个<strong class="ix hj">动作</strong>来实现它。</p><p id="52a3" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">让我们创建一个简单的表。</p><figure class="ju jv jw jx fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es jt"><img src="../Images/2c43d61bb1e93865007e773057d4d204.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*d74Jcb4Lkn71-DL5pyHIvw.png"/></div></div></figure><p id="3eff" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">检查PersistentRDDs，它是空的。</p><figure class="ju jv jw jx fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es jy"><img src="../Images/115c9fc0803b7b4cf72901b09132d6f0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2ajsJOyGF_ipaG8ZmHiBiw.png"/></div></div></figure><p id="136b" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">让我们缓存该表并查看持久rdd</p><figure class="ju jv jw jx fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es jz"><img src="../Images/163825ede0d100f6fb99c193d0e300b5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-uBnZdPkUnvljndgipdQcA.png"/></div></div></figure><p id="8b68" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我们可以看到persistentRDDs的列表仍然是空的，所以还没有缓存任何东西。</p><p id="f70a" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">让我们在表上运行一个<strong class="ix hj">动作</strong>并检查persistentRDDs列表。</p><figure class="ju jv jw jx fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ka"><img src="../Images/09a9fe497d56a1832ac9aab3f2903ce9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5rh_WOXI6VdtRvfj3u-Mig.png"/></div></div></figure><p id="95ce" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">现在，由于我们已经在表上运行了一个<strong class="ix hj">动作</strong>，rdd已经被持久化。</p><h1 id="c996" class="kb kc hi bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky bi translated">让我们把它放到临时视图中，看看它是如何工作的</h1><p id="48aa" class="pw-post-body-paragraph iv iw hi ix b iy kz ja jb jc la je jf jg lb ji jj jk lc jm jn jo ld jq jr js hb bi translated">让我们确认persistentRDDs是空的。</p><p id="8da6" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">创建数据帧并检查persistentRDDs以确保没有差异。</p><figure class="ju jv jw jx fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es le"><img src="../Images/ef3b68539b74c8c3555ac918f1f04fa1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*V11l1HmcMwEzOGGiK-d99g.png"/></div></div></figure><p id="9d60" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">现在让我们创建临时视图并检查持久rdd</p><figure class="ju jv jw jx fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lf"><img src="../Images/0d3ddef895dc149a707287c18c0ed8fb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WKu0PnwzFyyw02OLJcFMHA.png"/></div></div></figure><p id="99b9" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">持久rdd仍然是空的，所以创建TempView <strong class="ix hj">不会在内存中缓存数据。</strong></p><p id="317c" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">现在，让我们运行一个操作并查看persistentRDDs。</p><figure class="ju jv jw jx fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lg"><img src="../Images/def66c82367444a91b9a3938444ee74a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sisgrBx3yQiKREqyV6teKw.png"/></div></div></figure><p id="6de7" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">因此，在这里您可以看到，temp视图下的数据已经被缓存。</p><p id="1230" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">让我们确认数据已经从内存中读取。</p><figure class="ju jv jw jx fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lh"><img src="../Images/b58c355158191ccb6e9d567ab3fa2881.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*M_xGm76NUDrxKxkl4F0mnQ.png"/></div></div></figure><figure class="ju jv jw jx fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es li"><img src="../Images/f58e255355b85b58f3e0687d86fe5116.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Y_Q1IhEy7-1MXzSDfpZWnw.png"/></div></div></figure><h1 id="8a5e" class="kb kc hi bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky bi translated">不同存储级别的SQL查询缓存</h1><p id="a373" class="pw-post-body-paragraph iv iw hi ix b iy kz ja jb jc la je jf jg lb ji jj jk lc jm jn jo ld jq jr js hb bi translated">我们甚至可以在缓存表时提供存储级别，类似于DataFrame persist。</p><figure class="ju jv jw jx fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lj"><img src="../Images/40224ac182fad7c54eb4cad2302af6c5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9RTK5ZvhcOXN2DctmkqCJw.png"/></div></div></figure><p id="a007" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">有效的存储级别包括:</p><ul class=""><li id="d19c" class="lk ll hi ix b iy iz jc jd jg lm jk ln jo lo js lp lq lr ls bi translated"><code class="du lt lu lv lw b">DISK_ONLY</code></li><li id="994d" class="lk ll hi ix b iy lx jc ly jg lz jk ma jo mb js lp lq lr ls bi translated"><code class="du lt lu lv lw b">DISK_ONLY_2</code></li><li id="d22d" class="lk ll hi ix b iy lx jc ly jg lz jk ma jo mb js lp lq lr ls bi translated"><code class="du lt lu lv lw b">MEMORY_ONLY</code></li><li id="03d6" class="lk ll hi ix b iy lx jc ly jg lz jk ma jo mb js lp lq lr ls bi translated"><code class="du lt lu lv lw b">MEMORY_ONLY_2</code></li><li id="12ba" class="lk ll hi ix b iy lx jc ly jg lz jk ma jo mb js lp lq lr ls bi translated"><code class="du lt lu lv lw b">MEMORY_ONLY_SER</code></li><li id="c913" class="lk ll hi ix b iy lx jc ly jg lz jk ma jo mb js lp lq lr ls bi translated"><code class="du lt lu lv lw b">MEMORY_ONLY_SER_2</code></li><li id="17f5" class="lk ll hi ix b iy lx jc ly jg lz jk ma jo mb js lp lq lr ls bi translated"><code class="du lt lu lv lw b">MEMORY_AND_DISK</code></li><li id="79e6" class="lk ll hi ix b iy lx jc ly jg lz jk ma jo mb js lp lq lr ls bi translated"><code class="du lt lu lv lw b">MEMORY_AND_DISK_2</code></li><li id="a3ea" class="lk ll hi ix b iy lx jc ly jg lz jk ma jo mb js lp lq lr ls bi translated"><code class="du lt lu lv lw b">MEMORY_AND_DISK_SER</code></li><li id="77c1" class="lk ll hi ix b iy lx jc ly jg lz jk ma jo mb js lp lq lr ls bi translated"><code class="du lt lu lv lw b">MEMORY_AND_DISK_SER_2</code></li><li id="7992" class="lk ll hi ix b iy lx jc ly jg lz jk ma jo mb js lp lq lr ls bi translated"><code class="du lt lu lv lw b">OFF_HEAP</code></li></ul><p id="5e74" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">类似于Dataframe persist，如果没有明确提供，默认存储级别也是MEMORY_AND_DISK。</p><h1 id="1f0d" class="kb kc hi bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky bi translated">现在让我们来谈谈如何清除缓存</h1><p id="cb71" class="pw-post-body-paragraph iv iw hi ix b iy kz ja jb jc la je jf jg lb ji jj jk lc jm jn jo ld jq jr js hb bi translated">我们有两种清除缓存的方法。</p><ol class=""><li id="b761" class="lk ll hi ix b iy iz jc jd jg lm jk ln jo lo js mc lq lr ls bi translated">清除缓存</li><li id="544b" class="lk ll hi ix b iy lx jc ly jg lz jk ma jo mb js mc lq lr ls bi translated">未缓存表</li></ol><p id="a00b" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">清除缓存</strong></p><p id="1f4f" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">用于清除整个缓存。</p><figure class="ju jv jw jx fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es md"><img src="../Images/d0c1d1e33105308482b3438b3915c176.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tfIt6fM0OTMgaSNRVc8mDw.png"/></div></div></figure><p id="4915" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">打开缓存表</strong></p><p id="c63a" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">对于给定的表或视图，从内存和/或磁盘高速缓存中删除相关数据，认为它在使用<code class="du lt lu lv lw b">CACHE TABLE</code>操作之前已经被高速缓存。注意，如果没有指定<code class="du lt lu lv lw b">IF EXISTS</code>，不存在的表上的<code class="du lt lu lv lw b">UNCACHE TABLE</code>会抛出异常。</p><figure class="ju jv jw jx fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es me"><img src="../Images/1d70ff7c6a75331f2679ada62ef5311d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Raulmxf8a9n7Z695Yz12rA.png"/></div></div></figure><p id="0b13" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">类似地，我们可以持久存储或缓存数据帧。</p><figure class="ju jv jw jx fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es md"><img src="../Images/007adce6449177f7a818a485cbd43cac.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rWFgBxV5z6Hpx5dMPvRYAQ.png"/></div></div></figure><p id="589c" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在这里，您可以看到我们已经从一个表中创建了一个数据帧，并保持不变。</p><p id="ce20" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">默认存储级别是内存和磁盘。</p><p id="f27c" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在计算之后，我们可以不持久。</p><p id="a264" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在非持久化过程中，我们有两种方法。</p><p id="842b" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj"> unpersist() </strong></p><p id="cbd8" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">不持久(真)</strong></p><p id="3873" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这里是相同的源代码。</p><figure class="ju jv jw jx fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mf"><img src="../Images/67c339938bfc6b097ebc4bbd1e3bb5cf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XGPqWPcOrNQWXHa2LmNA7A.png"/></div></div></figure><p id="df3f" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">默认情况下，<strong class="ix hj">不持久化器</strong>采用布尔值FALSE。</p><p id="db76" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这意味着，直到所有的块都被删除，它才阻塞，并且异步运行。</p><p id="3a7c" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">但是如果你需要它阻塞直到所有的块都被删除，使用unpersist(true)。</p><figure class="ju jv jw jx fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mg"><img src="../Images/b6a896e144b41211696275126d3d6b35.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bdSnmWxnofU00J8wKGEKMg.png"/></div></div></figure><p id="f0a0" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">你可以在我的github repo中找到上面的代码样本。</p><div class="mh mi ez fb mj mk"><a href="https://github.com/ajithshetty/SparkInMemoryValidation" rel="noopener  ugc nofollow" target="_blank"><div class="ml ab dw"><div class="mm ab mn cl cj mo"><h2 class="bd hj fi z dy mp ea eb mq ed ef hh bi translated">ajithshetty/SparkInMemoryValidation</h2><div class="mr l"><h3 class="bd b fi z dy mp ea eb mq ed ef dx translated">通过在GitHub上创建一个帐户，为ajithshetty/SparkInMemoryValidation开发做贡献。</h3></div><div class="ms l"><p class="bd b fp z dy mp ea eb mq ed ef dx translated">github.comYou你可以联系我的链接在:https://www.linkedin.com/in/ajshetty28</p></div></div><div class="mt l"><div class="mu l mv mw mx mt my io mk"/></div></div></a></div><figure class="ju jv jw jx fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mz"><img src="../Images/0564afa916f47d189c7aef68aa837e17.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qiGLGnfnMfJCvTyhLgt5jg.png"/></div></div></figure><p id="5c5a" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">你可以在评论中发表你的反馈。</p><p id="0591" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">阿吉特·库玛尔·谢蒂</p><p id="3636" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">大数据工程师—热爱大数据、分析、云和基础设施。</p><p id="2216" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><a class="ae iu" href="https://ajithshetty28.medium.com/subscribe" rel="noopener">订阅</a> ✉️ || <a class="ae iu" href="https://ajithshetty28.medium.com/" rel="noopener">更多博客</a>📝|| <a class="ae iu" href="https://www.linkedin.com/in/ajshetty28" rel="noopener ugc nofollow" target="_blank">挂在</a>📊|| <a class="ae iu" href="https://ajithshetty.github.io/" rel="noopener ugc nofollow" target="_blank">个人资料页面</a>📚|| <a class="ae iu" href="https://github.com/ajithshetty/" rel="noopener ugc nofollow" target="_blank"> Git回购</a>👓</p><p id="5672" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">订阅我的:</strong> <a class="ae iu" href="https://justenoughdata.substack.com/" rel="noopener ugc nofollow" target="_blank"> <strong class="ix hj">每周简讯刚好够数据</strong> </a></p></div></div>    
</body>
</html>