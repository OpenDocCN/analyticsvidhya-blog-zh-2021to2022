<html>
<head>
<title>Azure Synapse Analytics — End to End with Synapse Spark for Training</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Azure Synapse Analytics —使用Synapse Spark进行端到端培训</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/azure-synapse-analytics-end-to-end-with-synapse-spark-for-training-b4241d163bd8?source=collection_archive---------1-----------------------#2021-12-04">https://medium.com/analytics-vidhya/azure-synapse-analytics-end-to-end-with-synapse-spark-for-training-b4241d163bd8?source=collection_archive---------1-----------------------#2021-12-04</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><h1 id="3ef5" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated">使用Azure Synapse Analytics Workspace移动数据、处理数据、训练模型</h1><h1 id="6c68" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated">为数据和数据科学生命周期管理提供统一的平台，以提高工作效率</h1><h1 id="de71" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated">注意</h1><ul class=""><li id="9abd" class="jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt bi translated">本文将展示这一功能</li></ul><h1 id="8a07" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated">先决条件</h1><ul class=""><li id="5feb" class="jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt bi translated">Azure帐户</li><li id="be1b" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">Azure synapse分析工作区</li><li id="acda" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">Azure SQL数据库</li><li id="ea7b" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">Azure存储</li><li id="2898" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">从kaggel下载Covid19数据，并作为外部源模拟数据导入Azure SQL</li><li id="10b8" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">创建一个表作为dbo.covid19data并上传数据</li></ul><figure class="ka kb kc kd fd ke er es paragraph-image"><div role="button" tabindex="0" class="kf kg di kh bf ki"><div class="er es jz"><img src="../Images/b072364d7e89c25a6ebae9c61d136047.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*NND05g_fZY92wNLj.jpg"/></div></div></figure><ul class=""><li id="a4cf" class="jc jd hh je b jf kl jh km jj kn jl ko jn kp jp jq jr js jt bi translated">上述架构流程有3个组成部分</li><li id="8d25" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">复制活动以从外部源移动数据，并将其带到原始或输入区域</li><li id="daf6" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">接下来是数据流活动，通过拖放ETL/ELT来转换或处理数据并最终完成</li><li id="d42c" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">使用spark运行机器学习模型来运行自动化ML sdk的笔记本电脑</li><li id="7504" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">我们使用回归来预测covid 19导致的死亡</li><li id="d2fb" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">登录Azure Synapse工作区</li><li id="f31f" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">创建管道/集成</li><li id="5218" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">拖放复制活动</li><li id="60d2" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">对于源，选择上面的SQL server —(需要创建链接服务)</li></ul><figure class="ka kb kc kd fd ke er es paragraph-image"><div role="button" tabindex="0" class="kf kg di kh bf ki"><div class="er es kq"><img src="../Images/918c513cd4fa8aaaf3c3cbc564a3f6e9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*ZYhCh2yha-BmgmdO.jpg"/></div></div></figure><figure class="ka kb kc kd fd ke er es paragraph-image"><div role="button" tabindex="0" class="kf kg di kh bf ki"><div class="er es kr"><img src="../Images/e56e1fc19023ff89ad35693cbe4943d2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*fhUAbmM3zAgZiA5M.jpg"/></div></div></figure><figure class="ka kb kc kd fd ke er es paragraph-image"><div role="button" tabindex="0" class="kf kg di kh bf ki"><div class="er es ks"><img src="../Images/d24ba83eae9f7e2383ed07db55fefa64.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*VpwaFbf4qmFnS653.jpg"/></div></div></figure><ul class=""><li id="fa72" class="jc jd hh je b jf kl jh km jj kn jl ko jn kp jp jq jr js jt bi translated">接下来创建一个数据流来处理数据</li><li id="0cab" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">对于示例，我使用delta来简化CDC</li><li id="82fb" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">创建具有复制活动目标的来源</li></ul><figure class="ka kb kc kd fd ke er es paragraph-image"><div role="button" tabindex="0" class="kf kg di kh bf ki"><div class="er es kt"><img src="../Images/99a17c1d836250b327e61fcffd43e6c6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*rOXfRuNXe8PuypfW.jpg"/></div></div></figure><ul class=""><li id="613c" class="jc jd hh je b jf kl jh km jj kn jl ko jn kp jp jq jr js jt bi translated">我们可以恢复复制活动目标链接服务本身</li><li id="c745" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">现在拖动选择</li></ul><figure class="ka kb kc kd fd ke er es paragraph-image"><div role="button" tabindex="0" class="kf kg di kh bf ki"><div class="er es ku"><img src="../Images/ef20aa59eb1e03e3dd1181a6597a2835.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*cMbZhxoQlTafgpxt.jpg"/></div></div></figure><ul class=""><li id="aa9f" class="jc jd hh je b jf kl jh km jj kn jl ko jn kp jp jq jr js jt bi translated">选择所有列</li><li id="d3c9" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">启用调试并查看结果。这个数据集是开源的，所以没有PII</li></ul><figure class="ka kb kc kd fd ke er es paragraph-image"><div role="button" tabindex="0" class="kf kg di kh bf ki"><div class="er es kv"><img src="../Images/8011869993e3430a5402096b749f658e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*lLra-2AiAussCKaY.jpg"/></div></div></figure><figure class="ka kb kc kd fd ke er es paragraph-image"><div role="button" tabindex="0" class="kf kg di kh bf ki"><div class="er es kw"><img src="../Images/4f43c2d7df18c24be32539eb00749df0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*EFgrSMOuXXKlzkuH.jpg"/></div></div></figure><figure class="ka kb kc kd fd ke er es paragraph-image"><div role="button" tabindex="0" class="kf kg di kh bf ki"><div class="er es kx"><img src="../Images/b3a406e25b9d96dc305f9cf5b3db44be.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*Vy14SR3PmlfF71_-.jpg"/></div></div></figure><figure class="ka kb kc kd fd ke er es paragraph-image"><div role="button" tabindex="0" class="kf kg di kh bf ki"><div class="er es ky"><img src="../Images/5268cee9175ef0d51269ca639e0baf0a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*Luxy3gicfh2k4ytI.jpg"/></div></div></figure><figure class="ka kb kc kd fd ke er es paragraph-image"><div role="button" tabindex="0" class="kf kg di kh bf ki"><div class="er es kz"><img src="../Images/ec2fc4d55b196c5ac4e6edf57a62170d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*5eAHFsbGSlgz1jhn.jpg"/></div></div></figure><ul class=""><li id="7f64" class="jc jd hh je b jf kl jh km jj kn jl ko jn kp jp jq jr js jt bi translated">选择列</li><li id="da04" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">查看调试以验证数据已处理</li></ul><figure class="ka kb kc kd fd ke er es paragraph-image"><div role="button" tabindex="0" class="kf kg di kh bf ki"><div class="er es kv"><img src="../Images/68c99a34c9c8b8412a09a863c499592f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*owjzDgaPJKDtl1pw.jpg"/></div></div></figure><figure class="ka kb kc kd fd ke er es paragraph-image"><div role="button" tabindex="0" class="kf kg di kh bf ki"><div class="er es la"><img src="../Images/b88aa4c94630fe41a808cef09a08a72b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*F3bdZVgH9Q5sd8lR.jpg"/></div></div></figure><ul class=""><li id="7414" class="jc jd hh je b jf kl jh km jj kn jl ko jn kp jp jq jr js jt bi translated">现在谈谈机器学习</li><li id="21ae" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">创建笔记本</li><li id="1698" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">访问上述汇数据集作为建模的输入</li><li id="7073" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">创建笔记本</li></ul><h1 id="990b" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated">密码</h1><ul class=""><li id="8398" class="jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt bi translated">加载数据</li></ul><pre class="ka kb kc kd fd lb lc ld le aw lf bi"><span id="76f9" class="lg if hh lc b fi lh li l lj lk">%%pyspark<br/>df = spark.read.load('abfss://container@storageaccount.dfs.core.windows.net/covid19aggroutput/*.parquet', format='parquet')<br/>display(df.limit(10))</span></pre><figure class="ka kb kc kd fd ke er es paragraph-image"><div role="button" tabindex="0" class="kf kg di kh bf ki"><div class="er es kv"><img src="../Images/815cbf69cb4e5b36fd301407cd484f38.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*QITIS063-SEEZ-Zj.jpg"/></div></div></figure><ul class=""><li id="1b49" class="jc jd hh je b jf kl jh km jj kn jl ko jn kp jp jq jr js jt bi translated">打印模式</li></ul><pre class="ka kb kc kd fd lb lc ld le aw lf bi"><span id="09b9" class="lg if hh lc b fi lh li l lj lk">df.printSchema</span></pre><ul class=""><li id="73e3" class="jc jd hh je b jf kl jh km jj kn jl ko jn kp jp jq jr js jt bi translated">需要进口</li></ul><pre class="ka kb kc kd fd lb lc ld le aw lf bi"><span id="ab63" class="lg if hh lc b fi lh li l lj lk">from pyspark.sql.functions import *<br/>from pyspark.sql import *</span></pre><ul class=""><li id="360a" class="jc jd hh je b jf kl jh km jj kn jl ko jn kp jp jq jr js jt bi translated">将日期转换为日期数据类型</li></ul><pre class="ka kb kc kd fd lb lc ld le aw lf bi"><span id="ec72" class="lg if hh lc b fi lh li l lj lk">df1 = df.withColumn("Date", to_date("ObservationDate", "MM/dd/yyyy")) <br/>display(df1)</span></pre><figure class="ka kb kc kd fd ke er es paragraph-image"><div role="button" tabindex="0" class="kf kg di kh bf ki"><div class="er es kv"><img src="../Images/321cf4202e598a0c878d956269cbd800.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*iAMpoB2yG2F3MWV7.jpg"/></div></div></figure><ul class=""><li id="7466" class="jc jd hh je b jf kl jh km jj kn jl ko jn kp jp jq jr js jt bi translated">创建新列</li></ul><pre class="ka kb kc kd fd lb lc ld le aw lf bi"><span id="2cd0" class="lg if hh lc b fi lh li l lj lk">df2 = df1.withColumn("year", year(col("Date"))).withColumn("month", month(col("Date"))).withColumn("day", dayofmonth(col("Date")))</span></pre><figure class="ka kb kc kd fd ke er es paragraph-image"><div role="button" tabindex="0" class="kf kg di kh bf ki"><div class="er es kv"><img src="../Images/07abf663e2fc4a42e0607c63436ccbd5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*Dz7kVPxNQd66-6CO.jpg"/></div></div></figure><ul class=""><li id="8516" class="jc jd hh je b jf kl jh km jj kn jl ko jn kp jp jq jr js jt bi translated">接下来是导入ML库</li><li id="211a" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">仅获取必要的列</li></ul><pre class="ka kb kc kd fd lb lc ld le aw lf bi"><span id="f7be" class="lg if hh lc b fi lh li l lj lk">dffinal = df2[["year","month", "day", "Confirmed", "Deaths", "Recovered"]]</span></pre><ul class=""><li id="ea4f" class="jc jd hh je b jf kl jh km jj kn jl ko jn kp jp jq jr js jt bi translated">火花ML从这里开始</li></ul><pre class="ka kb kc kd fd lb lc ld le aw lf bi"><span id="2a20" class="lg if hh lc b fi lh li l lj lk">from pyspark.ml.regression import LinearRegression<br/>from pyspark.ml.feature import VectorAssembler<br/>vectorAssembler = VectorAssembler(inputCols = ["year","month", "day", "Confirmed", "Recovered"], outputCol = 'features')<br/>mldf = vectorAssembler.transform(dffinal)<br/>mldf = mldf.select(['features', 'Deaths'])<br/>mldf.show(3)</span></pre><ul class=""><li id="7517" class="jc jd hh je b jf kl jh km jj kn jl ko jn kp jp jq jr js jt bi translated">拆分训练和测试数据集</li></ul><pre class="ka kb kc kd fd lb lc ld le aw lf bi"><span id="bf3f" class="lg if hh lc b fi lh li l lj lk">splits = mldf.randomSplit([0.7, 0.3])<br/>train_df = splits[0]<br/>test_df = splits[1]</span></pre><ul class=""><li id="e4ea" class="jc jd hh je b jf kl jh km jj kn jl ko jn kp jp jq jr js jt bi translated">配置模型</li></ul><pre class="ka kb kc kd fd lb lc ld le aw lf bi"><span id="5cb1" class="lg if hh lc b fi lh li l lj lk">from pyspark.ml.regression import LinearRegression<br/>lr = LinearRegression(featuresCol = 'features', labelCol='Deaths', maxIter=10, regParam=0.3, elasticNetParam=0.8)<br/>lr_model = lr.fit(train_df)<br/>print("Coefficients: " + str(lr_model.coefficients))<br/>print("Intercept: " + str(lr_model.intercept))</span></pre><ul class=""><li id="9975" class="jc jd hh je b jf kl jh km jj kn jl ko jn kp jp jq jr js jt bi translated">打印模型精度</li></ul><pre class="ka kb kc kd fd lb lc ld le aw lf bi"><span id="b1f7" class="lg if hh lc b fi lh li l lj lk">trainingSummary = lr_model.summary<br/>print("RMSE: %f" % trainingSummary.rootMeanSquaredError)<br/>print("r2: %f" % trainingSummary.r2)</span></pre><ul class=""><li id="c18c" class="jc jd hh je b jf kl jh km jj kn jl ko jn kp jp jq jr js jt bi translated">用测试数据评估</li></ul><pre class="ka kb kc kd fd lb lc ld le aw lf bi"><span id="f932" class="lg if hh lc b fi lh li l lj lk">lr_predictions = lr_model.transform(test_df)<br/>lr_predictions.select("prediction","Deaths","features").show(5)<br/>from pyspark.ml.evaluation import RegressionEvaluator<br/>lr_evaluator = RegressionEvaluator(predictionCol="prediction", \<br/>                 labelCol="Deaths",metricName="r2")<br/>print("R Squared (R2) on test data = %g" % lr_evaluator.evaluate(lr_predictions))</span></pre><ul class=""><li id="9f5e" class="jc jd hh je b jf kl jh km jj kn jl ko jn kp jp jq jr js jt bi translated">显示结果</li></ul><pre class="ka kb kc kd fd lb lc ld le aw lf bi"><span id="b3d8" class="lg if hh lc b fi lh li l lj lk">test_result = lr_model.evaluate(test_df)<br/>print("Root Mean Squared Error (RMSE) on test data = %g" % test_result.rootMeanSquaredError)</span></pre><ul class=""><li id="9833" class="jc jd hh je b jf kl jh km jj kn jl ko jn kp jp jq jr js jt bi translated">现在运行预测</li></ul><pre class="ka kb kc kd fd lb lc ld le aw lf bi"><span id="b101" class="lg if hh lc b fi lh li l lj lk">predictions = lr_model.transform(test_df)<br/>predictions.select("prediction","Deaths","features").show()</span></pre><ul class=""><li id="b89e" class="jc jd hh je b jf kl jh km jj kn jl ko jn kp jp jq jr js jt bi translated">记住模型输出不是我们本教程的目的。只是给大家展示一下过程。</li><li id="3ffb" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">保存管道并运行调试</li></ul><figure class="ka kb kc kd fd ke er es paragraph-image"><div role="button" tabindex="0" class="kf kg di kh bf ki"><div class="er es ll"><img src="../Images/e80185bd24a3f097acfb4518fe46d954.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*XBFnhn4eL7Btktss.jpg"/></div></div></figure></div><div class="ab cl lm ln go lo" role="separator"><span class="lp bw bk lq lr ls"/><span class="lp bw bk lq lr ls"/><span class="lp bw bk lq lr"/></div><div class="ha hb hc hd he"><p id="9e4b" class="pw-post-body-paragraph lt lu hh je b jf kl lv lw jh km lx ly jj lz ma mb jl mc md me jn mf mg mh jp ha bi translated"><em class="mi">最初发表于</em><a class="ae mj" href="https://github.com/balakreshnan/Samples2021/blob/main/Synapseworkspace/e2esparkml.md" rel="noopener ugc nofollow" target="_blank"><em class="mi">【https://github.com】</em></a><em class="mi">。</em></p></div></div>    
</body>
</html>