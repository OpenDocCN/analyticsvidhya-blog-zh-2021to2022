<html>
<head>
<title>Protect PII by encrypting using Fernet in Azure Synapse Spark</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">通过在Azure Synapse Spark中使用Fernet加密来保护PII</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/protect-pii-by-encrypting-using-fernet-in-azure-synapse-spark-edd157e2963a?source=collection_archive---------2-----------------------#2021-10-09">https://medium.com/analytics-vidhya/protect-pii-by-encrypting-using-fernet-in-azure-synapse-spark-edd157e2963a?source=collection_archive---------2-----------------------#2021-10-09</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/182b88a31237a1640c81c54712e01e0a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*hWNEiKbhcKlt8Pzw"/></div></div></figure><h1 id="364a" class="iq ir hi bd is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn bi translated">通过在Azure Synapse Spark中使用Fernet加密来保护PII</h1><h1 id="36bd" class="iq ir hi bd is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn bi translated">用fernet加密密钥——对称加密</h1><h1 id="6c63" class="iq ir hi bd is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn bi translated">先决条件</h1><ul class=""><li id="1299" class="jo jp hi jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf bi translated">Azure帐户</li><li id="af6e" class="jo jp hi jq b jr kg jt kh jv ki jx kj jz kk kb kc kd ke kf bi translated">Azure存储</li><li id="a9a3" class="jo jp hi jq b jr kg jt kh jv ki jx kj jz kk kb kc kd ke kf bi translated">带有Spark的Azure Synapse分析工作区</li></ul><h1 id="c93f" class="iq ir hi bd is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn bi translated">用例</h1><ul class=""><li id="2f89" class="jo jp hi jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf bi translated">使用加密来加密PII或其他敏感数据</li><li id="c927" class="jo jp hi jq b jr kg jt kh jv ki jx kj jz kk kb kc kd ke kf bi translated">数据应该加密存储</li><li id="336a" class="jo jp hi jq b jr kg jt kh jv ki jx kj jz kk kb kc kd ke kf bi translated">只有有权使用密钥的人才能解密</li><li id="0cfa" class="jo jp hi jq b jr kg jt kh jv ki jx kj jz kk kb kc kd ke kf bi translated">加密列级别，因此只有必要的列可以加密，其他列可用于报告</li><li id="3d14" class="jo jp hi jq b jr kg jt kh jv ki jx kj jz kk kb kc kd ke kf bi translated">这里是开源加密项目—<a class="ae kl" href="https://cryptography.io/en/latest/fernet/" rel="noopener ugc nofollow" target="_blank">https://cryptography.io/en/latest/fernet/</a></li></ul><h1 id="3c07" class="iq ir hi bd is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn bi translated">密码</h1><ul class=""><li id="2c2e" class="jo jp hi jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf bi translated">首先创建一个火花簇</li><li id="d516" class="jo jp hi jq b jr kg jt kh jv ki jx kj jz kk kb kc kd ke kf bi translated">安装加密库</li><li id="6aec" class="jo jp hi jq b jr kg jt kh jv ki jx kj jz kk kb kc kd ke kf bi translated">创建environment.yaml文件</li></ul><pre class="km kn ko kp fd kq kr ks kt aw ku bi"><span id="7c8d" class="kv ir hi kr b fi kw kx l ky kz">name: stats<br/>dependencies:<br/>  - numpy<br/>  - pandas<br/>  - cryptography</span></pre><ul class=""><li id="5db3" class="jo jp hi jq b jr la jt lb jv lc jx ld jz le kb kc kd ke kf bi translated">等待软件包安装</li><li id="0b38" class="jo jp hi jq b jr kg jt kh jv ki jx kj jz kk kb kc kd ke kf bi translated">创建新笔记本</li><li id="419e" class="jo jp hi jq b jr kg jt kh jv ki jx kj jz kk kb kc kd ke kf bi translated">添加包yml文件</li></ul><pre class="km kn ko kp fd kq kr ks kt aw ku bi"><span id="840f" class="kv ir hi kr b fi kw kx l ky kz">from cryptography.fernet import Fernet<br/># &gt;&gt;&gt; Put this somewhere safe!<br/>key = Fernet.generate_key()</span></pre><ul class=""><li id="4ed1" class="jo jp hi jq b jr la jt lb jv lc jx ld jz le kb kc kd ke kf bi translated">打印并查看</li></ul><pre class="km kn ko kp fd kq kr ks kt aw ku bi"><span id="e4d7" class="kv ir hi kr b fi kw kx l ky kz">f = Fernet(key)<br/>token = f.encrypt(b"A really secret message. Not for prying eyes.")<br/>print(token)<br/>print(f.decrypt(token))</span></pre><ul class=""><li id="ddbd" class="jo jp hi jq b jr la jt lb jv lc jx ld jz le kb kc kd ke kf bi translated">创建用于加密和解密的UDF</li></ul><pre class="km kn ko kp fd kq kr ks kt aw ku bi"><span id="f086" class="kv ir hi kr b fi kw kx l ky kz"># Define Encrypt User Defined Function <br/>def encrypt_val(clear_text,MASTER_KEY):<br/>    from cryptography.fernet import Fernet<br/>    f = Fernet(MASTER_KEY)<br/>    clear_text_b=bytes(clear_text, 'utf-8')<br/>    cipher_text = f.encrypt(clear_text_b)<br/>    cipher_text = str(cipher_text.decode('ascii'))<br/>    return cipher_text</span><span id="e2ce" class="kv ir hi kr b fi lf kx l ky kz"># Define decrypt user defined function <br/>def decrypt_val(cipher_text,MASTER_KEY):<br/>    from cryptography.fernet import Fernet<br/>    f = Fernet(MASTER_KEY)<br/>    clear_val=f.decrypt(cipher_text.encode()).decode()<br/>    return clear_val</span></pre><ul class=""><li id="c201" class="jo jp hi jq b jr la jt lb jv lc jx ld jz le kb kc kd ke kf bi translated">读出数据</li></ul><pre class="km kn ko kp fd kq kr ks kt aw ku bi"><span id="600a" class="kv ir hi kr b fi kw kx l ky kz">df = spark.read.load('abfss://containername@storagename.dfs.core.windows.net/titanic/Titanic.csv', format='csv'<br/>## If header exists uncomment line below<br/>, header=True<br/>)</span><span id="d00d" class="kv ir hi kr b fi lf kx l ky kz">print(df)</span></pre><ul class=""><li id="643c" class="jo jp hi jq b jr la jt lb jv lc jx ld jz le kb kc kd ke kf bi translated">加密数据</li></ul><pre class="km kn ko kp fd kq kr ks kt aw ku bi"><span id="b29b" class="kv ir hi kr b fi kw kx l ky kz">from pyspark.sql.functions import udf, lit, md5<br/>from pyspark.sql.types import StringType</span><span id="e96d" class="kv ir hi kr b fi lf kx l ky kz"># Register UDF's<br/>encrypt = udf(encrypt_val, StringType())<br/>decrypt = udf(decrypt_val, StringType())</span><span id="bc4f" class="kv ir hi kr b fi lf kx l ky kz"># Fetch key from secrets<br/># encryptionKey = dbutils.preview.secret.get(scope = "encrypt", key = "fernetkey")<br/>encryptionKey = key</span><span id="04af" class="kv ir hi kr b fi lf kx l ky kz"># Encrypt the data <br/>#df = spark.table("Test_Encryption")<br/>encrypted = df.withColumn("Name", encrypt("Name",lit(encryptionKey)))<br/>encrypted.head()</span></pre><ul class=""><li id="9be9" class="jo jp hi jq b jr la jt lb jv lc jx ld jz le kb kc kd ke kf bi translated">解密测试</li></ul><pre class="km kn ko kp fd kq kr ks kt aw ku bi"><span id="85be" class="kv ir hi kr b fi kw kx l ky kz">decrypted = encrypted.withColumn("Name", decrypt("Name",lit(encryptionKey)))<br/>decrypted.head()</span></pre></div><div class="ab cl lg lh gp li" role="separator"><span class="lj bw bk lk ll lm"/><span class="lj bw bk lk ll lm"/><span class="lj bw bk lk ll"/></div><div class="hb hc hd he hf"><p id="916c" class="pw-post-body-paragraph ln lo hi jq b jr la lp lq jt lb lr ls jv lt lu lv jx lw lx ly jz lz ma mb kb hb bi translated"><em class="mc">最初发表于</em><a class="ae kl" href="https://github.com/balakreshnan/Samples2021/blob/main/Synapseworkspace/fernetenc.md" rel="noopener ugc nofollow" target="_blank">T5【https://github.com】</a><em class="mc">。</em></p></div></div>    
</body>
</html>