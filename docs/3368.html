<html>
<head>
<title>Azure Machine Learning Automated Machine Learning Deployment using Azure DevOps — CI/CD</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Azure DevOps的Azure机器学习自动化机器学习部署— CI/CD</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/azure-machine-learning-automated-machine-learning-deployment-using-azure-devops-ci-cd-d6a4861bb4af?source=collection_archive---------11-----------------------#2021-06-27">https://medium.com/analytics-vidhya/azure-machine-learning-automated-machine-learning-deployment-using-azure-devops-ci-cd-d6a4861bb4af?source=collection_archive---------11-----------------------#2021-06-27</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><h1 id="bfb5" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated">在Azure DevOps中为自动化ML视觉创建训练管道</h1><h1 id="5f3a" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated">先决条件</h1><ul class=""><li id="e48b" class="jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt bi translated">Azure帐户</li><li id="7a8f" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">Azure存储</li><li id="a9e1" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">Azure机器学习服务</li><li id="260b" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">Azure DevOps</li><li id="3e8a" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">Github帐户和存储库</li><li id="d2b8" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">Azure服务主帐户</li><li id="96c2" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">向服务主要贡献者提供对机器学习资源的访问</li><li id="250c" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">Azure Keyvault存储秘密</li><li id="dc95" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">用服务主体机密更新密钥库</li><li id="eb09" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">训练脚本被设计成接受3个参数</li><li id="9f2c" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">租户id</li><li id="8d1c" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">服务主体客户端id</li><li id="5d65" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">服务主要机密</li><li id="00a5" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">上述细节将从Azure DevOps作为秘密变量传递</li><li id="5b38" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">这将自动化训练代码并注册模型</li></ul><h1 id="41ed" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated">步伐</h1><ul class=""><li id="2f42" class="jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt bi translated">创建一个训练脚本</li><li id="6583" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">创建代理依赖关系脚本</li><li id="db7b" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">创建Azure DevOps管道</li></ul><h1 id="bd2a" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated">训练脚本</h1><ul class=""><li id="c362" class="jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt bi translated">打开Visual Studio代码</li><li id="8364" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">创建一个名为visionautoml的新项目</li><li id="0be4" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">创建一个名为train的新目录</li><li id="ed10" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">创建一个名为train.py的新python文件</li><li id="ff74" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">训练脚本使用服务主体进行身份验证，以便它可以自动运行</li><li id="661c" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">替换您的订阅id、资源组名称和工作区名称来运行</li><li id="7bd5" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">DevOps将实验运行交给Azure ML服务来运行。</li><li id="eaf6" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">DevOps将保持监视并输出日志</li></ul><figure class="ka kb kc kd fd ke er es paragraph-image"><div role="button" tabindex="0" class="kf kg di kh bf ki"><div class="er es jz"><img src="../Images/26d2a36cb1310ac02d7ec5a9722118f9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*Dmlqi6F7eQQGRZmP.jpg"/></div></div></figure><pre class="ka kb kc kd fd kl km kn ko aw kp bi"><span id="5114" class="kq if hh km b fi kr ks l kt ku">import azureml.core<br/>from azureml.core import Workspace<br/>from azureml.core import Keyvault<br/>import os<br/><br/>from azureml.core import Workspace, Experiment<br/>from azureml.train.automl import AutoMLImageConfig<br/>from azureml.train.hyperdrive import GridParameterSampling<br/>from azureml.train.hyperdrive import choice<br/><br/>from azureml.contrib.dataset.labeled_dataset import _LabeledDatasetFactory, LabeledDatasetTask<br/>from azureml.core import Dataset<br/><br/>from azureml.core.authentication import ServicePrincipalAuthentication<br/>from azureml.core.compute import AmlCompute, ComputeTarget<br/>from azureml.core import Experiment<br/><br/>from azureml.core import Workspace<br/>import os<br/>import urllib<br/>from zipfile import ZipFile<br/><br/><br/>print("SDK version:", azureml.core.VERSION)<br/><br/>import argparse <br/><br/>parse = argparse.ArgumentParser()<br/>parse.add_argument("--tenantid")<br/>parse.add_argument("--clientid")<br/>parse.add_argument("--secret")<br/>    <br/>args = parse.parse_args()<br/><br/><br/>sp = ServicePrincipalAuthentication(tenant_id=args.tenantid, # tenantID<br/>                                    service_principal_id=args.clientid, # clientId<br/>                                    service_principal_password=args.secret) # clientSecret<br/><br/>ws = Workspace.get(name="workspacename",<br/>                   auth=sp,<br/>                   subscription_id="xxxxxxxxxxxxxxxxxxxxxxx", resource_group="resourcegroupname")<br/><br/>#ws = Workspace.from_config()<br/>keyvault = ws.get_default_keyvault()<br/>tenantid = keyvault.get_secret(name="tenantid")<br/>acclientid = keyvault.get_secret(name="acclientid")<br/>accsvcname = keyvault.get_secret(name="accsvcname")<br/>accsecret = keyvault.get_secret(name="accsecret")<br/><br/>print(accsvcname)<br/><br/>sp = ServicePrincipalAuthentication(tenant_id=tenantid, # tenantID<br/>                                    service_principal_id=acclientid, # clientId<br/>                                    service_principal_password=accsecret) # clientSecret<br/><br/>ws = Workspace.get(name="gputraining",<br/>                   auth=sp,<br/>                   subscription_id="c46a9435-c957-4e6c-a0f4-b9a597984773", resource_group="mlops")<br/>ws.get_details()<br/><br/>print('Workspace name: ' + ws.name, <br/>      'Azure region: ' + ws.location, <br/>      'Subscription id: ' + ws.subscription_id, <br/>      'Resource group: ' + ws.resource_group, sep = '\n')<br/><br/><br/><br/>cluster_name = "gpu-cluster"<br/><br/>try:<br/>    compute_target = ws.compute_targets[cluster_name]<br/>    print('Found existing compute target.')<br/>except KeyError:<br/>    print('Creating a new compute target...')<br/>    compute_config = AmlCompute.provisioning_configuration(vm_size='Standard_NC6', <br/>                                                           idle_seconds_before_scaledown=1800,<br/>                                                           min_nodes=0, <br/>                                                           max_nodes=4)<br/><br/>    compute_target = ComputeTarget.create(ws, cluster_name, compute_config)<br/>    <br/># Can poll for a minimum number of nodes and for a specific timeout.<br/># If no min_node_count is provided, it will use the scale settings for the cluster.<br/>compute_target.wait_for_completion(show_output=True, min_node_count=None, timeout_in_minutes=20)<br/><br/>experiment_name = 'automl-image-notebook' <br/>experiment = Experiment(ws, name=experiment_name)<br/><br/># download data<br/>download_url = 'https://cvbp-secondary.z19.web.core.windows.net/datasets/object_detection/odFridgeObjects.zip'<br/>data_file = './odFridgeObjects.zip'<br/>urllib.request.urlretrieve(download_url, filename=data_file)<br/><br/># extract files<br/>with ZipFile(data_file, 'r') as zip:<br/>    print('extracting files...')<br/>    zip.extractall()<br/>    print('done')<br/>    <br/># delete zip file<br/>os.remove(data_file)<br/><br/>from IPython.display import Image<br/>Image(filename='./odFridgeObjects/images/31.jpg')<br/><br/>import json<br/>import os<br/>import xml.etree.ElementTree as ET<br/><br/>src = "./odFridgeObjects/"<br/>train_validation_ratio = 5<br/><br/># Retrieving default datastore that got automatically created when we setup a workspace<br/>workspaceblobstore = ws.get_default_datastore().name<br/><br/># Path to the annotations<br/>annotations_folder = os.path.join(src, "annotations")<br/><br/># Path to the training and validation files<br/>train_annotations_file = os.path.join(src, "train_annotations.jsonl")<br/>validation_annotations_file = os.path.join(src, "validation_annotations.jsonl")<br/><br/># sample json line dictionary<br/>json_line_sample = \<br/>    {<br/>        "image_url": "AmlDatastore://" + workspaceblobstore + "/"<br/>                     + os.path.basename(os.path.dirname(src)) + "/" + "images",<br/>        "image_details": {"format": None, "width": None, "height": None},<br/>        "label": []<br/>    }<br/><br/># Read each annotation and convert it to jsonl line<br/>with open(train_annotations_file, 'w') as train_f:<br/>    with open(validation_annotations_file, 'w') as validation_f:<br/>        for i, filename in enumerate(os.listdir(annotations_folder)):<br/>            if filename.endswith(".xml"):<br/>                print("Parsing " + os.path.join(src, filename))<br/><br/>                root = ET.parse(os.path.join(annotations_folder, filename)).getroot()<br/><br/>                width = int(root.find('size/width').text)<br/>                height = int(root.find('size/height').text)<br/><br/>                labels = []<br/>                for object in root.findall('object'):<br/>                    name = object.find('name').text<br/>                    xmin = object.find('bndbox/xmin').text<br/>                    ymin = object.find('bndbox/ymin').text<br/>                    xmax = object.find('bndbox/xmax').text<br/>                    ymax = object.find('bndbox/ymax').text<br/>                    isCrowd = int(object.find('difficult').text)<br/>                    labels.append({"label": name,<br/>                                   "topX": float(xmin)/width,<br/>                                   "topY": float(ymin)/height,<br/>                                   "bottomX": float(xmax)/width,<br/>                                   "bottomY": float(ymax)/height,<br/>                                   "isCrowd": isCrowd})<br/>                # build the jsonl file<br/>                image_filename = root.find("filename").text<br/>                _, file_extension = os.path.splitext(image_filename)<br/>                json_line = dict(json_line_sample)<br/>                json_line["image_url"] = json_line["image_url"] + "/" + image_filename<br/>                json_line["image_details"]["format"] = file_extension[1:]<br/>                json_line["image_details"]["width"] = width<br/>                json_line["image_details"]["height"] = height<br/>                json_line["label"] = labels<br/><br/>                if i % train_validation_ratio == 0:<br/>                    # validation annotation<br/>                    validation_f.write(json.dumps(json_line) + "\n")<br/>                else:<br/>                    # train annotation<br/>                    train_f.write(json.dumps(json_line) + "\n")<br/>            else:<br/>                print("Skipping unknown file: {}".format(filename))<br/><br/>ds = ws.get_default_datastore()<br/>ds.upload(src_dir='./odFridgeObjects', target_path='odFridgeObjects')<br/><br/><br/>training_dataset_name = 'odFridgeObjectsTrainingDataset'<br/>if training_dataset_name in ws.datasets:<br/>    training_dataset = ws.datasets.get(training_dataset_name)<br/>    print('Found the training dataset', training_dataset_name)<br/>else:<br/>    # create training dataset<br/>    training_dataset = _LabeledDatasetFactory.from_json_lines(<br/>        task=LabeledDatasetTask.OBJECT_DETECTION, path=ds.path('odFridgeObjects/train_annotations.jsonl'))<br/>    training_dataset = training_dataset.register(workspace=ws, name=training_dataset_name)<br/>    <br/># create validation dataset<br/>validation_dataset_name = "odFridgeObjectsValidationDataset"<br/>if validation_dataset_name in ws.datasets:<br/>    validation_dataset = ws.datasets.get(validation_dataset_name)<br/>    print('Found the validation dataset', validation_dataset_name)<br/>else:<br/>    validation_dataset = _LabeledDatasetFactory.from_json_lines(<br/>        task=LabeledDatasetTask.OBJECT_DETECTION, path=ds.path('odFridgeObjects/validation_annotations.jsonl'))<br/>    validation_dataset = validation_dataset.register(workspace=ws, name=validation_dataset_name)<br/>    <br/>    <br/>print("Training dataset name: " + training_dataset.name)<br/>print("Validation dataset name: " + validation_dataset.name)<br/><br/>training_dataset.to_pandas_dataframe()<br/><br/>image_config_yolov5 = AutoMLImageConfig(task='image-object-detection',<br/>                                        compute_target=compute_target,<br/>                                        training_data=training_dataset,<br/>                                        validation_data=validation_dataset,<br/>                                        hyperparameter_sampling=GridParameterSampling({'model_name': choice('yolov5')}))<br/>                                    <br/>automl_image_run = experiment.submit(image_config_yolov5)<br/><br/>automl_image_run.wait_for_completion(wait_post_processing=True)</span></pre><h1 id="efc1" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated">创建代理依赖项文件</h1><ul class=""><li id="cf24" class="jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt bi translated">创建新的外壳文件</li><li id="61e4" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">安装Azure ML SDK所需的所有必要组件</li></ul><pre class="ka kb kc kd fd kl km kn ko aw kp bi"><span id="f876" class="kq if hh km b fi kr ks l kt ku">python --version<br/>pip install azure-cli==2.0.72<br/>pip install --upgrade azureml-sdk<br/>pip install azureml-sdk[notebooks]<br/>pip install --upgrade azureml-sdk[cli]<br/>pip install argparse<br/>pip install tensorflow==2.0.0<br/>pip install --upgrade "azureml-train-core&lt;0.1.1" "azureml-train-automl&lt;0.1.1" "azureml-contrib-dataset&lt;0.1.1"  --extra-index-url "https://azuremlsdktestpypi.azureedge.net/automl_for_images_private_preview/"</span></pre><ul class=""><li id="52c4" class="jc jd hh je b jf kv jh kw jj kx jl ky jn kz jp jq jr js jt bi translated">将它们都存储在github中，以便可以为版本维护代码</li></ul><h1 id="3a5a" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated">Azure DevOps</h1><ul class=""><li id="0108" class="jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt bi translated">登录Azure DevOps</li><li id="4e00" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">创建新项目</li><li id="9d4d" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">选择Github作为存储库</li><li id="4d35" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">选择已创建的项目或回购</li></ul><figure class="ka kb kc kd fd ke er es paragraph-image"><div role="button" tabindex="0" class="kf kg di kh bf ki"><div class="er es la"><img src="../Images/1785bfbb8f534dbf699ce4d0b32969af.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*enJiIxv_mTQyTy2l.jpg"/></div></div></figure><figure class="ka kb kc kd fd ke er es paragraph-image"><div role="button" tabindex="0" class="kf kg di kh bf ki"><div class="er es lb"><img src="../Images/7b2276da1c1a9f34c562364d8a5f193d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*qokV5jozIUCTDxv9.jpg"/></div></div></figure><figure class="ka kb kc kd fd ke er es paragraph-image"><div role="button" tabindex="0" class="kf kg di kh bf ki"><div class="er es lc"><img src="../Images/e411feb98f2c7f72df11e48f6486031f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*NjPwsw16DfRyEXSq.jpg"/></div></div></figure><figure class="ka kb kc kd fd ke er es paragraph-image"><div role="button" tabindex="0" class="kf kg di kh bf ki"><div class="er es ld"><img src="../Images/f5c4940f9545e9367990348d021eeb4e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*cRAgn9qPhUn34EoP.jpg"/></div></div></figure><figure class="ka kb kc kd fd ke er es paragraph-image"><div role="button" tabindex="0" class="kf kg di kh bf ki"><div class="er es le"><img src="../Images/45073316c03d19323dbfc48091d793ea.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*xOyyNIoCYx4h5BCG.jpg"/></div></div></figure><figure class="ka kb kc kd fd ke er es paragraph-image"><div role="button" tabindex="0" class="kf kg di kh bf ki"><div class="er es lf"><img src="../Images/25fc9bb3817839e23cfb4d138c55fd77.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*GS4lUIITM9S6k2VT.jpg"/></div></div></figure><figure class="ka kb kc kd fd ke er es paragraph-image"><div role="button" tabindex="0" class="kf kg di kh bf ki"><div class="er es lg"><img src="../Images/9752bcab8d4534bb68d702f24561221a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*NgAJojyDmr2z75B4.jpg"/></div></div></figure><pre class="ka kb kc kd fd kl km kn ko aw kp bi"><span id="43f0" class="kq if hh km b fi kr ks l kt ku">--tenantid $(tenatid) --acclientid $(acclientid) --accsecret $(accsecret)</span></pre><figure class="ka kb kc kd fd ke er es paragraph-image"><div role="button" tabindex="0" class="kf kg di kh bf ki"><div class="er es lh"><img src="../Images/b7648b1f8d653e3c78f2521e0f57797b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*W_AcW_rcdd5aAP2h.jpg"/></div></div></figure><figure class="ka kb kc kd fd ke er es paragraph-image"><div role="button" tabindex="0" class="kf kg di kh bf ki"><div class="er es li"><img src="../Images/de465d7d3a33872491dd680dc962c2f0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*M0QZtkIO9w0Zaxiy.jpg"/></div></div></figure></div><div class="ab cl lj lk go ll" role="separator"><span class="lm bw bk ln lo lp"/><span class="lm bw bk ln lo lp"/><span class="lm bw bk ln lo"/></div><div class="ha hb hc hd he"><p id="f588" class="pw-post-body-paragraph lq lr hh je b jf kv ls lt jh kw lu lv jj lw lx ly jl lz ma mb jn mc md me jp ha bi translated"><em class="mf">最初发表于</em><a class="ae mg" href="https://github.com/balakreshnan/Samples2021/blob/main/AutoML/automltraindevops.md" rel="noopener ugc nofollow" target="_blank"><em class="mf">【https://github.com】</em></a><em class="mf">。</em></p></div></div>    
</body>
</html>