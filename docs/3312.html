<html>
<head>
<title>Deploying a ML Model with FastAPI on Google Kubernetes Engine(Google Cloud Platform)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Google Kubernetes引擎(Google云平台)上使用FastAPI部署ML模型</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/deploying-a-ml-model-with-fastapi-on-google-kubernetes-engine-google-cloud-platform-bc2adbe0a35a?source=collection_archive---------7-----------------------#2021-06-24">https://medium.com/analytics-vidhya/deploying-a-ml-model-with-fastapi-on-google-kubernetes-engine-google-cloud-platform-bc2adbe0a35a?source=collection_archive---------7-----------------------#2021-06-24</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="44e2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">注意:整个项目可以在Youtube上看到，但是目前只有土耳其语版本。我相信我很快就会录制英文版或者中文版。</p><p id="788a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">以相当高的准确度(或者你使用的任何度量标准)训练一个模型是很棒的，绝对值得开一瓶香槟。但是你现在打算怎么用呢？批量预测你电脑上的一切？这将是机器学习，相当于在你当地的咖啡店里，从你的笔记本电脑上显示你的网站。</p><p id="4c21" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们要做的是让每个人都能通过一个API来访问它。如果你不知道API是什么，就把它想象成用户的一个端点。他们可以向您的API发送预测数据，这是一个POST请求，API将使用预测进行响应。</p><p id="b718" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这篇文章由两部分组成:</p><ol class=""><li id="d4ea" class="je jf hi ih b ii ij im in iq jg iu jh iy ji jc jj jk jl jm bi translated">开发API</li></ol><p id="1f27" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们将使用预训练的yolo-v3和yolo-v3-tiny模型，因为这里的重点不是训练模型，而是部署它。我们将围绕您的模型包装FastAPI。当我们完成这一部分时，我们将能够向本地主机上的API发送请求。</p><p id="f842" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">2.将它部署在谷歌云的Kubernetes引擎上</p><p id="27b3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在第一部分之后，我们将能够向本地主机上的API发送请求。为了向世界开放您的模型，我们需要将它部署到公共端点。我选择了云和Kubernetes来消除可伸缩性问题。</p><h2 id="484d" class="jn jo hi bd jp jq jr js jt ju jv jw jx iq jy jz ka iu kb kc kd iy ke kf kg kh bi translated">开发API</h2><figure class="ki kj kk kl fd km"><div class="bz dy l di"><div class="kn ko l"/></div></figure><p id="df7b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">代码的某些部分来自Andrew NG的MLOps课程，但我打算比他走得更远。如果你熟悉计算机视觉，代码是很容易理解的，但是我必须为新手解释FastAPI部分。</p><p id="7d1b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">FastAPI几乎是类固醇的烧瓶，所以我们将创建不同的页面，如website.com/home的<em class="kp"/>或website.com/about的<em class="kp"/>。我们可以使用<strong class="ih hj">@ app</strong>decorator；即@ app(“/”)的意思是主页。此外，您可以通过/docs页面测试您的FastAPI应用程序，这与Flask相比是一大优势。由于<a class="ae jd" href="https://docs.python.org/3/library/typing.html" rel="noopener ugc nofollow" target="_blank">类型提示</a>，这成为可能。换句话说，FastAPI自动记录您的应用程序。</p><p id="1729" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们还在本地系统上创建一个目录来保存客户端发送给我们的图像和我们将在对象周围绘制框的图像。我们将把后者返回给客户，这样他们就可以看到我们模型的预测。</p><p id="9534" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">运行此代码后，您可以从本地主机访问它；如果您转到localhost，您可以看到消息<em class="kp">“API正在按预期工作。”</em>或<a class="ae jd" href="http://localhost:8000/docs" rel="noopener ugc nofollow" target="_blank">http://localhost:8000/docs</a>显示一个与此相同的屏幕:</p><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="er es kq"><img src="../Images/562f81bb49ef49e2d03ca65fba4907db.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bEDzDFTG6mbas70WFFd5kA.png"/></div></div><figcaption class="kx ky et er es kz la bd b be z dx translated">我们创建的FastAPI文档页面</figcaption></figure><p id="ab7e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您可以尝试预测方法，看看您的模型是否工作正常。</p><h2 id="39a9" class="jn jo hi bd jp jq jr js jt ju jv jw jx iq jy jz ka iu kb kc kd iy ke kf kg kh bi translated">在Google Cloud的Kubernetes引擎上部署应用程序</h2><p id="8471" class="pw-post-body-paragraph if ig hi ih b ii lb ik il im lc io ip iq ld is it iu le iw ix iy lf ja jb jc hb bi translated">我们现在已经进行了一半，但是这部分有点复杂；这就是我与同事合作完成这一部分的原因。我们将这个过程分为4个部分:</p><ol class=""><li id="44d7" class="je jf hi ih b ii ij im in iq jg iu jh iy ji jc jj jk jl jm bi translated">将应用容器化</li><li id="0e5b" class="je jf hi ih b ii lg im lh iq li iu lj iy lk jc jj jk jl jm bi translated">将其上传到容器注册表</li><li id="0ebf" class="je jf hi ih b ii lg im lh iq li iu lj iy lk jc jj jk jl jm bi translated">在谷歌云上创建一个Kubernetes集群</li><li id="13c2" class="je jf hi ih b ii lg im lh iq li iu lj iy lk jc jj jk jl jm bi translated">在群集上运行容器</li><li id="c49a" class="je jf hi ih b ii lg im lh iq li iu lj iy lk jc jj jk jl jm bi translated">(奖金)设置自动缩放策略</li></ol><p id="c0e4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">既然你现在知道了这些步骤，无论何时你感到失落，你都可以回头看看这些步骤，然后找出我们在哪里。</p><p id="b834" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果您设置了您的帐户、项目和账单，我们可以立即开始行动。你把你的app放在一个名为“app”的文件夹下。在应用程序外部创建一个名为“Docker file”的Docker文件。就像这样:</p><figure class="ki kj kk kl fd km er es paragraph-image"><div class="er es ll"><img src="../Images/2fd3bd6482b5f6d26d71f0bf78765295.png" data-original-src="https://miro.medium.com/v2/resize:fit:696/format:webp/1*LRpJx7KsAv8DvmSsTNE8Bg.png"/></div><figcaption class="kx ky et er es kz la bd b be z dx translated">目录树</figcaption></figure><p id="10fb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后写一个Dockerfile文件:</p><figure class="ki kj kk kl fd km"><div class="bz dy l di"><div class="kn ko l"/></div></figure><p id="964c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我不打算详细介绍docker容器。如果你是Docker的新用户，你可以阅读Docker文档或者在<a class="ae jd" href="https://github.com/samozturk/Docker-Notes/blob/main/Docker%20Notes%205f4cbe0250a64983972a6a3d0bbf70db.md" rel="noopener ugc nofollow" target="_blank"> my github </a>上查看我的Docker笔记。</p><p id="4b78" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">基础映像是python，然后我们定义了工作目录。然后我们把所有东西都复制到容器的主目录中；已安装所需的库；暴露端口80，并告诉Docker在运行容器时运行哪些命令。</p><figure class="ki kj kk kl fd km"><div class="bz dy l di"><div class="kn ko l"/></div></figure><p id="a61b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们构建了容器并在本地机器上运行。第二个是可选的，它只是为了演示的目的；只是想看看有没有用。第三个命令是把我们的容器推到一个注册中心，我们不喜欢Docker Hub，Google Container Registry(gcr.io)。</p><p id="5ba1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果你在第三个命令之前没有登录，打开终端，键入<strong class="ih hj"> gcloud init </strong>按照步骤操作。然后输入<strong class="ih hj">g cloud auth configure-docker</strong>。这部分只是从你的本地机器上运行你的gcloud命令，我就不赘述了。</p><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="er es lm"><img src="../Images/5517df6a570785939e2306fa6f93f796.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*I0zu0776tzrdOhiZ_6ao-w.png"/></div></div><figcaption class="kx ky et er es kz la bd b be z dx translated">谷歌云Kubernetes引擎</figcaption></figure><p id="cbe9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果你想看到所有正在运行的节点，你可以向云控制台输入<strong class="ih hj"> kubectl get nodes -A </strong>。(-标志表示所有节点)</p><p id="8e60" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">下一步，我们将需要云壳编辑器，而不是云壳终端。</p><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="er es ln"><img src="../Images/205a44db3851c326f9e655ba48c94903.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TtGK3cvWIGUpuMmp-yOvWw.png"/></div></div><figcaption class="kx ky et er es kz la bd b be z dx translated">云壳编辑器</figcaption></figure><p id="d3e2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们将为Kubernetes部署创建yaml文件。这是:</p><figure class="ki kj kk kl fd km"><div class="bz dy l di"><div class="kn ko l"/></div></figure><p id="21bf" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">关于kubernetes yaml文件的更多细节，请访问<a class="ae jd" href="https://www.mirantis.com/blog/introduction-to-yaml-creating-a-kubernetes-deployment/" rel="noopener ugc nofollow" target="_blank">这个站点</a>。然后我们需要使用这个build.yaml文件。</p><figure class="ki kj kk kl fd km"><div class="bz dy l di"><div class="kn ko l"/></div></figure><p id="a96d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们还可以看到第二个命令的部署。我们就快到了；我们所要做的就是公开我们的kubernetes工作负载，这可以在UI上完成。然后我们将有一个IP地址来发送请求给我们的API。</p><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="er es lo"><img src="../Images/206d649af3776116a2e1c467c7eb5f1c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Q_qXpbL9S2YGnV4Hm7gang.png"/></div></div><figcaption class="kx ky et er es kz la bd b be z dx translated">Kubernetes工作负载暴露</figcaption></figure><p id="c63a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这项工作完成后，您可以前往“服务和入口”选项卡并查看您的端点。</p><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="er es lp"><img src="../Images/14e3e2881df578e4c1761ecfdd7b061a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yi1BvPuDGeFbWY-b67FG8g.png"/></div></div><figcaption class="kx ky et er es kz la bd b be z dx translated">我们的终点</figcaption></figure><p id="70a3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您可以单击端点，您将看到:“API正在按预期工作。”如果你想测试你的模型，你可以在IP地址中添加“/docs”并发送文件进行预测。你只需要上传一个文件，然后点击执行。</p><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="er es lq"><img src="../Images/0e809faa32577002902075d22bcca580.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*880ccRinX9i58aJYKbUIew.png"/></div></div></figure><p id="3949" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">就这样了，伙计们。现在你为你的模型服务了。</p><p id="dd50" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">奖励:设置自动缩放</p><figure class="ki kj kk kl fd km"><div class="bz dy l di"><div class="kn ko l"/></div></figure><p id="86bc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果我们在控制台上键入以下命令，我们会说kubernetes在90%的CPU利用率后，将自动扩展到6个节点。</p></div></div>    
</body>
</html>