<html>
<head>
<title>How to Schedule Python Scrapy Spiders on Heroku using Custom Clock Process for Free</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在Heroku上免费使用定制时钟进程调度Python Scrapy Spiders</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/how-to-schedule-python-scrapy-spiders-on-heroku-using-custom-clock-process-for-free-7f3eb9310ba4?source=collection_archive---------3-----------------------#2021-06-29">https://medium.com/analytics-vidhya/how-to-schedule-python-scrapy-spiders-on-heroku-using-custom-clock-process-for-free-7f3eb9310ba4?source=collection_archive---------3-----------------------#2021-06-29</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><figure class="ev ex if ig ih ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es ie"><img src="../Images/2b7b5defe8e3aa50ee2d85ca2fb8f858.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*oTE3MYdgYJpNmfz6"/></div></div><figcaption class="ip iq et er es ir is bd b be z dx translated">照片由<a class="ae it" href="https://unsplash.com/@donramxn?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">拉蒙·萨利内罗</a>在<a class="ae it" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</figcaption></figure><p id="b162" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi js translated">你有没有试过在亚马逊印度大减价期间，每隔几个小时就查看你渴望购买的iPhone的价格下降情况？</p><p id="397b" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">你的愿望清单中是否有高价产品，并希望得到降价通知？</p><p id="c9e1" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">当股票/密码跌破特定价格时，你希望得到通知吗？</p><p id="ae1b" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">然后，您可能想要构建、部署并定期安排一个刮刀，免费从目标网站上刮取数据。</p><p id="5a87" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">在开发的早期阶段，我们很容易在本地机器上运行和调度Scrapy spiders，但最终我们希望在云中部署和运行我们的spider。</p><p id="2693" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">在这篇文章中，我将向你解释如何部署你的Scrapy spiders，并使用Heroku上的一个定制时钟进程定期调度它们。</p><h1 id="d010" class="kb kc hh bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky bi translated"><strong class="ak">先决条件</strong></h1><p id="30a1" class="pw-post-body-paragraph iu iv hh iw b ix kz iz ja jb la jd je jf lb jh ji jj lc jl jm jn ld jp jq jr ha bi translated">本教程希望你准备好你的Scrapy项目，以便能够将你的蜘蛛部署到Heroku。</p><h1 id="76b0" class="kb kc hh bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky bi translated">让我们开始吧</h1><p id="3ae6" class="pw-post-body-paragraph iu iv hh iw b ix kz iz ja jb la jd je jf lb jh ji jj lc jl jm jn ld jp jq jr ha bi translated">我们需要安装部署和运行Scrapy spiders所需的几个模块:</p><ul class=""><li id="f493" class="le lf hh iw b ix iy jb jc jf lg jj lh jn li jr lj lk ll lm bi translated">运行<code class="du ln lo lp lq b">pip install scrapyd</code>安装scrapyd守护进程。</li><li id="57a3" class="le lf hh iw b ix lr jb ls jf lt jj lu jn lv jr lj lk ll lm bi translated">运行<code class="du ln lo lp lq b">pip install git+https://github.com/scrapy/scrapyd-client.git</code>安装scrapyd-client。</li><li id="61ef" class="le lf hh iw b ix lr jb ls jf lt jj lu jn lv jr lj lk ll lm bi translated">运行<code class="du ln lo lp lq b">pip install herokuify_scrapyd</code>来安装herokuify_scrapyd python模块，该模块简化了向Heroku部署Scrapy蜘蛛。</li></ul><p id="089f" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">你需要通过pip在Heroku上指定你的Scrapy项目的Python包依赖关系，通过运行<code class="du ln lo lp lq b">pip freeze &gt; requirements.txt</code>在你的项目根目录下创建一个requirements.txt文件。</p><h1 id="688a" class="kb kc hh bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky bi translated"><strong class="ak">Heroku入门</strong></h1><ul class=""><li id="dd8b" class="le lf hh iw b ix kz jb la jf lw jj lx jn ly jr lj lk ll lm bi translated">在<a class="ae it" href="https://www.heroku.com/" rel="noopener ugc nofollow" target="_blank"> Heroku </a>上创建账户。</li><li id="3d78" class="le lf hh iw b ix lr jb ls jf lt jj lu jn lv jr lj lk ll lm bi translated">安装<a class="ae it" href="https://devcenter.heroku.com/articles/heroku-cli" rel="noopener ugc nofollow" target="_blank"> Heroku CLI </a>，让你直接从终端创建和管理Heroku应用。</li><li id="6881" class="le lf hh iw b ix lr jb ls jf lt jj lu jn lv jr lj lk ll lm bi translated"><code class="du ln lo lp lq b">cd</code>到你的项目文件夹，运行<code class="du ln lo lp lq b">heroku login -i</code>登录你的Heroku账户。</li><li id="6848" class="le lf hh iw b ix lr jb ls jf lt jj lu jn lv jr lj lk ll lm bi translated">运行<code class="du ln lo lp lq b">heroku create</code>创建一个Heroku app。</li></ul><pre class="lz ma mb mc fd md lq me mf aw mg bi"><span id="909c" class="mh kc hh lq b fi mi mj l mk ml">$heroku create</span><span id="3720" class="mh kc hh lq b fi mm mj l mk ml">Creating app… done, ⬢ &lt;HEROKU_APP_NAME&gt;<br/>Created http://&lt;HEROKU_APP_NAME&gt;.herokuapp.com/ | git@heroku.com:&lt;HEROKU_APP_NAME&gt;.git</span></pre><ul class=""><li id="350f" class="le lf hh iw b ix iy jb jc jf lg jj lh jn li jr lj lk ll lm bi translated">运行<code class="du ln lo lp lq b">heroku git:remote -a &lt;HEROKU_APP_NAME&gt;</code>向您的Heroku应用添加遥控器。</li></ul><p id="36fb" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">创建Heroku应用程序后，您需要编辑scrapy.cfg文件，如下所示:</p><figure class="lz ma mb mc fd ii"><div class="bz dy l di"><div class="mn mo l"/></div><figcaption class="ip iq et er es ir is bd b be z dx translated">用于Heroku上部署的scrapy项目的scrapy.cfg文件</figcaption></figure><h1 id="0e42" class="kb kc hh bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky bi translated"><strong class="ak">自定义时钟流程</strong></h1><p id="3ccb" class="pw-post-body-paragraph iu iv hh iw b ix kz iz ja jb la jd je jf lb jh ji jj lc jl jm jn ld jp jq jr ha bi translated">Heroku Scheduler 是一个免费的附加软件，可以在指定的时间每10分钟、每小时或每天安排简单的任务。但是，如果您希望每5秒钟运行一次蜘蛛，或者每天运行三次蜘蛛，或者在特定的时间运行蜘蛛，该怎么办呢？在这些独特而复杂的场景中，使用自定义时钟进程调度蜘蛛可以提供更好的控制，建议在生产中使用。</p><p id="6680" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">请记住，scheduler add-on并不保证作业在预定时间执行，在极少数情况下，作业可能会被跳过或运行两次。</p><p id="cd06" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">现在，让我们创建一个定制的时钟进程来定期调度Heroku上的Scrapy spider。我们将使用来自APScheduler Python库的TwistedScheduler，因为Scrapy是建立在Twisted networking框架之上的。APScheduler是一个轻量级的进程内任务调度程序，它提供了一个干净、易用的调度API。</p><p id="13ed" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">让我们通过运行<code class="du ln lo lp lq b">pip install pytz</code>和<code class="du ln lo lp lq b">pip install apscheduler</code>开始安装调度所需的模块。重新运行<code class="du ln lo lp lq b">pip freeze &gt; requirements.txt</code>来更新你的requirements.txt文件。</p><p id="463f" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">现在，在项目根目录下创建一个scheduler.py文件，如下所示。</p><figure class="lz ma mb mc fd ii"><div class="bz dy l di"><div class="mn mo l"/></div><figcaption class="ip iq et er es ir is bd b be z dx translated">一个日程安排程序触发了我们在Heroku的战斗蜘蛛</figcaption></figure><p id="11e7" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated"><code class="du ln lo lp lq b">send_request()</code>函数向<code class="du ln lo lp lq b">schedule.json</code> Scrapyd JSON API发出POST请求。您的Scrapy项目名称和蜘蛛名称作为post请求的一部分发送。</p><p id="7742" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">有关APScheduler cron trigger提供的选项的更多详细信息，请参考本文档。</p><p id="525a" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">在项目根目录中创建一个Procfile，显式声明启动应用程序时要执行的命令。您的Scrapy项目的Procfile将如下所示:</p><figure class="lz ma mb mc fd ii"><div class="bz dy l di"><div class="mn mo l"/></div><figcaption class="ip iq et er es ir is bd b be z dx translated">Procfile用于Scrapy项目</figcaption></figure><p id="82ea" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">在项目根目录中创建runtime.txt文件，指定Python运行时，如下所示:</p><p id="5e23" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated"><code class="du ln lo lp lq b">python-3.7.10</code></p><h1 id="aa8b" class="kb kc hh bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky bi translated"><strong class="ak">向Heroku部署蜘蛛</strong></h1><ul class=""><li id="b096" class="le lf hh iw b ix kz jb la jf lw jj lx jn ly jr lj lk ll lm bi translated">运行<code class="du ln lo lp lq b">git init</code>、<code class="du ln lo lp lq b">git add .</code>、<code class="du ln lo lp lq b">git commit -m &lt;COMMIT_MESSAGE&gt;</code>来初始化一个本地Git存储库，并将您的应用程序代码提交给它。</li><li id="f54b" class="le lf hh iw b ix lr jb ls jf lt jj lu jn lv jr lj lk ll lm bi translated">运行<code class="du ln lo lp lq b">git push heroku master</code>将您的应用部署到Heroku。</li></ul><p id="447d" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">在将您的spider部署到Heroku之后，运行<code class="du ln lo lp lq b">heroku ps:scale clock=1</code>将时钟进程扩展到单个dyno，从而避免调度重复的作业。</p><p id="9a93" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">瞧啊。你现在已经成功地将你的战斗蜘蛛部署到Heroku。您可以通过运行<code class="du ln lo lp lq b">heroku logs --tail</code>来检查日志，您将能够找到通过scheduler.py文件发送的POST请求。</p><p id="2a32" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">现在，如果您转到<code class="du ln lo lp lq b">http://&lt;HEROKU_APP_NAME&gt;.herokuapp.com</code>，您应该会看到Scrapyd欢迎页面，在这里您可以找到您的未决、正在运行和已完成的作业，并且您可以检查日志。</p><p id="9836" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">要完全停止你的调度程序，运行<code class="du ln lo lp lq b">heroku ps:scale clock=0</code>将你的时钟进程缩减到0。</p><blockquote class="mp mq mr"><p id="c55c" class="iu iv ms iw b ix iy iz ja jb jc jd je mt jg jh ji mu jk jl jm mv jo jp jq jr ha bi translated"><strong class="iw hi">注意:</strong> Heroku免费和爱好计划适用于非商业应用，你可能需要升级到其他计划来安排你的蜘蛛生产。</p></blockquote><p id="fd6c" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">恭喜你！你已经完成了教程的最后部分，我希望这对你有所帮助。</p></div><div class="ab cl mw mx go my" role="separator"><span class="mz bw bk na nb nc"/><span class="mz bw bk na nb nc"/><span class="mz bw bk na nb"/></div><div class="ha hb hc hd he"><blockquote class="mp mq mr"><p id="7f4b" class="iu iv ms iw b ix iy iz ja jb jc jd je mt jg jh ji mu jk jl jm mv jo jp jq jr ha bi translated"><strong class="iw hi">源代码:</strong>可以参考我的<a class="ae it" href="https://github.com/yashashreesuresh/amazon_price_tracker" rel="noopener ugc nofollow" target="_blank"> <strong class="iw hi">亚马逊价格追踪器</strong> </a> Scrapy spider在Heroku上使用自定义时钟进程定时调度。它跟踪你想要购买的亚马逊产品的可用性和价格，并在价格下降时通过电子邮件通知你！</p></blockquote></div></div>    
</body>
</html>