# 三月疯狂——蒙特卡罗模拟与 R

> 原文：<https://medium.com/analytics-vidhya/march-madness-a-case-study-in-monte-carlo-simulation-b6ee9cce52e1?source=collection_archive---------15----------------------->

![](img/7f15e48331994982e3a035104ad7729c.png)

疯狂三月——最激动人心和最典型的美国体育赛事之一。

疯狂三月——最激动人心和最典型的美国体育赛事之一。一个球队赛季的成功通常不是由赢得的比赛数量或他们在会议锦标赛中持续的时间来定义的，而是他们在这场激动人心的锦标赛中的表现。然而，对于其他较小的节目来说，一季的成功可以通过他们是否有资格参加大型舞会来定义。想办法成为种子选手可能是提前结束赛季的区别，也可能是[永远巩固你的学校在大学田径比赛中的地位的区别。](http://www.usatoday.com/story/sports/ncaab/2018/03/16/no-16-seed-umbc-stuns-virginia-make-ncaa-tournament-history/434445002)

如果一个项目经常发现自己站在泡沫的错误一边，或者只是停留在游戏点(例如圣玛丽山发现自己在 2014 年、2017 年和 2021 年的[前四名](https://www.ncaa.com/news/basketball-men/bracketiq/2021-02-25/first-four-ncaa-tournament-ultimate-guide))，那么一个自然的问题是:“有哪些有资格的团队在做我们没有做的事情？”简单的答案可能是“赢得更多”，“投篮 3 分更好”，“更强的防守”，“更少的失误”，但这些都是模糊和无目的的。这就是数据科学可以伸出援手的地方:对于某些性能指标，种子团队和非种子团队是否属于显著不同的组？也就是说，我们的目标是确定这些指标的*分布*对于合格团队和不合格团队是否不同。提示蒙特卡罗模拟。

# **蒙特卡洛模拟——什么、如何以及为什么？**

广义而言，蒙特卡罗模拟是一种用于统计和数据科学的技术，它依赖于重复采样和数字生成来解决优化和从概率分布中提取的问题。例如，您可以通过样本均值(蒙特卡罗积分)来估计没有封闭形式解的积分。例如，如果积分在(0，1)的范围内，您可以在 0 和 1 之间生成 10，000 个点，在这些点的每个点上计算函数，并找到这些计算的平均值。计算出的平均值就是我们对积分的估计。[这个用蒙特卡罗技术近似圆周率](https://www.youtube.com/watch?v=ELetCV_wX_c)的额外视觉示例有助于提供更直观的理解。像这样的方法不仅常用于统计学，也常用于物理学、工程学、金融、商业等等。

使用蒙特卡罗技术解决问题的一般策略如下:

1.  根据看起来接近您的数据的分布，随机生成您正在分析的样本
2.  计算这个样本的一些感兴趣的值
3.  多次重复步骤 1-2(试探性地，至少 1000 次)
4.  汇总结果

反映了我们之前的整体示例:

1.  从 0 到 1 随机生成一个 u [均匀随机变量](https://en.wikipedia.org/wiki/Continuous_uniform_distribution)。这利用了均匀分布的特征，即所有点在给定范围内的概率相等，并且在计算曲线下的面积时，我们不对特定范围赋予权重。
2.  评估在该生成点上要积分的函数
3.  多次重复步骤 1-2，收集大量样本
4.  计算样本的平均值来估计积分的答案

这些技术通过利用现代计算能力来工作。我们可以相对容易地多次生成大样本，如果我们采样的分布反映了我们问题的真实分布，那么我们将得到非常接近真实答案的结果。

# 数据

我们将在这次分析中使用的数据来自于从 [Kenpom](https://kenpom.com/) 收集的男子 2010-2019 赛季的效率和杂项统计数据。添加了一个二进制响应来指示该赛季的给定球队是否在锦标赛中获得了种子。关注的变量是三分球命中率，或三分球命中率与三分球命中率的比率。众所周知，今天的比赛更加注重远射([或更好或更坏](https://fivethirtyeight.com/features/did-moving-the-arc-bring-the-3-pointer-to-a-breaking-point/))，各队都不想落后。除了我们关注的变量之外，我们还可以使用来自 Kenpom 的各种其他指标进行更多的未来分析。因此，我们将把数据编译成一个单独的源文件。下面的脚本演示了我如何收集 20。csv 文件，并使用球队名称和赛季将它们与唯一标识符合并。

## 探索性可视化

同样，我们将探索种子队和非种子队的三分球命中率分布是否不同。首先，让我们创建一个分布直方图，并根据我们的系统初始响应对数据点进行分组。

![](img/7e54124fd04f985e85e5ab375a90c78e.png)

从我们数据的形状中，我们可以看到这两种分布都是近似正态的(钟形)，但不是集中在相同的值上，这使我们相信这些分布是不同的。需要明确的是，同一个*系列*的分布和同一个*系列*的分布是不同的。例如，以 0 和 5 为中心的钟形曲线都是*正态*分布，但不是同一个分布。

为了测试它们是否是不同的分布，我们将使用一个 2 样本排列 t 检验和一个均值差异检验统计量(也称为韦尔奇 t 检验)。

> ….一个什么？

# 解释和直觉

置换 t 检验背后的思想与统计学中的典型假设检验非常相似。但是现在，我们的零假设是每个变量的*分布*对于种子队和非种子队是相等的，我们的另一个假设是它们不相等——我们的检验统计量是这些分布的平均值的差异。我们创建一个检验统计的初步(零)分布，作为我们在零假设为真的情况下预期数据的行为。但是我们怎么做呢？简单！如果种子和非种子团队的分布实际上是相同的，那么(非种子)标签在我们的测试中不应该产生差异。这是置换 t 检验背后的关键直觉。我们随机打乱标签本身，从这些打乱的数据中计算出我们的测试统计量，然后重复很多次来创建我们的分布。如果我们观察到的非模拟数据的均值差异明显远离这个零分布，那么我们得出结论，这个标签实际上是重要的，我们的分布是不同的。换句话说，我们拒绝我们的无效假设。

用我们之前的一般蒙特卡罗策略来描述:

1.  从我们的数据中随机抽取种子/非种子标签
2.  计算混洗标签平均值的差异
3.  重复多次(在本例中是 10，000 次)来创建我们的空分布
4.  计算我们观察到的差异的 p 值——如果零假设为真，我们得到至少这个极端值的概率

## 你确定吗？

> 这个*听起来*像是个好主意，但是我们怎么能确定呢？

我们可以通过查看 t-test 的大小和功效来做到这一点。提醒一下，大小是拒绝真零假设的概率，功效是拒绝假零假设的概率。

## 大小

排列测试的设计使得大小不大于 alpha 级别，在本例中为 0.05。换句话说，当零假设为真的概率不超过 5%时，我们会拒绝它。

## 力量

即使排列测试有很好的规模，如果我们选择了一个很差的测试统计，我们的测试能力仍然很差。我们将使用代表真实数据集的模拟数据进行实验性分析，然后针对模拟数据的子集重复引发偏移。我们在每个场景中执行排列测试，并计算我们拒绝了多少次已知为假的零假设。这使我们能够确定我们的测试在分布均值的增量差异上的功效。换句话说，*一个观察到的 X 的平均差给我们一个 Y 的近似幂*。

调查我们的三分球命中率功能，我们可以看到球队大约 80/20-80%的时间分裂，球队没有资格参加 NCAA 锦标赛，而 20%的球队有资格。播种和未播种的分布形状都呈现正态分布，具有大约 3 的相似标准偏差，但是具有移动的平均值。我们经常喜欢用这样的模拟来描绘我们分析的大致轮廓，所以相对近似的估计就足够了。

下面的代码演示了零分布的创建和模拟的一个副本的创建

现在，对于我们想要分析的每个位移量，我们重复这个过程 1000 次。对于每组重复，我们查看小于 0.05 的 p 值，并计算平均值。换句话说，我们执行 1000 次复制，然后平均找出我们拒绝了多少次已知为假的零假设。

现在，我们对从 0 到 1.5 的 20 个不同位移值重复这一过程，并绘制结果图:

![](img/9eb4ceb17bb7f0ac8f25089bdbc138e7.png)

从上面的功率图中，我们可以看到，观察到的幅度约为 0.5 或更大的平均差对应于约 95%或更大的功率。换句话说，如果我们观察到种子队与非种子队的三分球命中率的平均差异约为+/- 0.5 或更大，那么当零假设不成立时，拒绝零假设的概率约为 95%。

那么这一切有什么意义呢？蒙特卡洛模拟的假设检验表明，在真实数据中观察到一定程度的差异后，我们可以对自己的结论相当有信心。

# 测试

在这里，我们最后执行置换 t 检验，但是使用我们观察到的数据。我们通过计算置换标签 10，000 的平均差异来创建检验统计的零分布，并与没有任何改组的观察到的平均差异进行比较。现在，我们不是*模拟生成的*数据，而是*采样的* *观测到的*数据。我们之前的模拟模拟了在特定条件下会发生的情况，这有助于我们对结果充满信心。

![](img/9f657a265b4fa85799d01f30f46dd61f.png)

我们可以从上面看到，我们观察到的差异与我们的零分布相差很远，因此我们可以确信，在三月疯狂中，种子队与非种子队的 3 分投篮命中率的平均差异显著不同。为了增加另一层保证，我们可以计算均值差异的 95%分层 bootstrap 置信区间。

分层自举样本是通过对两组进行替换取样，每次计算平均差异而产生的。当数据独立但分布不一致时，可以使用这种方法。我们可以假设我们的指标是独立的(A 队的 3 分投篮命中率不影响 B 队的 3 分投篮命中率),我们已经表明它们不是同分布的。因此，分层自举是合适的。下面的代码使用 95%的置信度默认值计算我们的置信区间，并提供了 1000 次重复和结果。

这些结果告诉我们，在 95%的置信度下，三分球命中率平均值的真实差异在(-11.526，-0.253)的范围内。这里强调的一点是，区间不包含 0，以高度的信心确认 3 分投篮命中率的真实平均差不为 0，并且它们实际上具有不同的分布。

既然我们已经确定了分布是不同的，我们可以在未来以此为基础——也许通过使用[拒绝抽样](https://en.wikipedia.org/wiki/Rejection_sampling#Adaptive_rejection_sampling)来近似一个指标的真实分布，或者通过建立一个分类模型来预测一支球队在给定的常规赛统计数据下是否合格。

最后，如果你有兴趣学习更多关于蒙特卡罗方法的知识，我强烈推荐 Maria Rizzo 的书《R 的统计计算》。

*所有代码和附带的 markdown 文件都可以在* [*我的 Github 页面*](https://github.com/DImsirovic) *找到。随时* [*在 LinkedIn 上和我联系*](https://www.linkedin.com/in/dinko-imsirovic/) *！*