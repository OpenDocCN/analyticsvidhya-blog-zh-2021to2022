<html>
<head>
<title>Optimizing MySQL insertions at scale (Python 3.7)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">大规模优化MySQL插入(Python 3.7)</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/optimizing-mysql-insertions-at-scale-python-3-7-b8b5aa73af4c?source=collection_archive---------15-----------------------#2021-01-30">https://medium.com/analytics-vidhya/optimizing-mysql-insertions-at-scale-python-3-7-b8b5aa73af4c?source=collection_archive---------15-----------------------#2021-01-30</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><figure class="ev ex if ig ih ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es ie"><img src="../Images/731966366f745c49b95601764aae72a8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XSl5z9T7WCvf-7_wX6B0cA.jpeg"/></div></div><figcaption class="ip iq et er es ir is bd b be z dx translated">在<a class="ae it" href="https://unsplash.com/s/photos/time?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上由<a class="ae it" href="https://unsplash.com/@insungyoon?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">尹新荣</a>拍摄的照片</figcaption></figure><p id="0939" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">当我们谈到规模(比如在一个表中插入250万行)时，MySQL事务可能非常昂贵。虽然<em class="js">可以传输到</em><strong class="iw hi"><em class="js">MySQL</em></strong><em class="js">8.0服务器或客户端的最大可能</em> <strong class="iw hi"> <em class="js">数据包</em> </strong> <em class="js">数据包是</em> <a class="ae it" href="https://dev.mysql.com/doc/refman/8.0/en/packet-too-large.html#:~:text=The%20largest%20possible%20packet%20that,error%20and%20closes%20the%20connection." rel="noopener ugc nofollow" target="_blank"> <em class="js"> 1GB </em> </a>，但这可能不是一个高效的事务。正如我的数据结构和算法教授所说:</p><blockquote class="jt ju jv"><p id="bdab" class="iu iv js iw b ix iy iz ja jb jc jd je jw jg jh ji jx jk jl jm jy jo jp jq jr ha bi translated">作为工程师/计算机科学家，我们不仅对找出问题的可能解决方案感兴趣(就像数学家一样)，而且对开发问题的有效和优化的解决方案感兴趣。</p></blockquote><p id="a24d" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">在这篇博客中，我们将学习如何高效地优化昂贵的MySQL事务。在开始之前，我想让你读一下我以前的博客— <a class="ae it" rel="noopener" href="/analytics-vidhya/using-aws-lambda-environment-variables-from-local-env-file-python-3-7-f3edacdea015">使用本地的AWS Lambda环境变量。env文件</a> <em class="js">。</em></p><p id="4a35" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">假设我们有一个<strong class="iw hi">文本文件</strong>，其中包含了<strong class="iw hi">250万个</strong>世界各地随机出现的人的姓名和联系电话<em class="js">(为了简单起见，我们在整个示例中只考虑一个实体，即</em><strong class="iw hi"><em class="js">【name】</em></strong><em class="js">)</em>，我们希望将它传输到一个MySQL表中—<strong class="iw hi">random . student</strong>(random是数据库名称)。我们可以通过三种可能的方式将它们插入到表中:</p><ul class=""><li id="5001" class="jz ka hh iw b ix iy jb jc jf kb jj kc jn kd jr ke kf kg kh bi translated"><strong class="iw hi">一次插入一个</strong> —就时间复杂性而言，该事务成本太高，但仍然可行。</li><li id="1384" class="jz ka hh iw b ix ki jb kj jf kk jj kl jn km jr ke kf kg kh bi translated"><strong class="iw hi">一次插入全部内容</strong> —这是不可行的，因为为如此繁重的事务构建插入查询代价太高。</li><li id="5efa" class="jz ka hh iw b ix ki jb kj jf kk jj kl jn km jr ke kf kg kh bi translated"><strong class="iw hi">插入小数据包</strong> —这在时间复杂度和执行方面都是高效可行的。</li></ul><p id="b7f2" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">让我们首先创建一个python文件并编写一个函数来<strong class="iw hi">连接</strong>到我们的远程或本地MySQL实例<em class="js">(我将用一个远程AWS RDS实例</em>来展示这个例子)。我将我的DB凭证存储在一个单独的配置文件中，我将使用python <code class="du kn ko kp kq b">dotenv</code>模块获取该文件。您可以做同样的事情或硬编码您的凭据；第一个是一个很好的实践。</p><pre class="kr ks kt ku fd kv kq kw kx aw ky bi"><span id="6777" class="kz la hh kq b fi lb lc l ld le">import pymysql<br/>from dotenv import load_dotenv<br/>import os</span><span id="6704" class="kz la hh kq b fi lf lc l ld le"># loading environment variables<br/>laod_dotenv()</span><span id="e213" class="kz la hh kq b fi lf lc l ld le">hostName  = os.environ.get('RDS_HOST')<br/>name = os.environ.get('NAME')<br/>password = os.environ.get('PASSWORD')<br/>port = os.environ.get('PORT')</span><span id="7e0a" class="kz la hh kq b fi lf lc l ld le">def connectDB():<br/>    try:<br/>        conn = pymysql.connect(host=hostName, port=int(port),<br/>        user=name, passwd=password)<br/>        print("SUCCESS: Connection to RDS MySQL instance succeeded")<br/>        return conn</span><span id="7491" class="kz la hh kq b fi lf lc l ld le">    except Exception as e:<br/>        print("ERROR: Unexpected error: Could not connect to MySQL<br/>        instance.")<br/>        raise Exception(e)</span></pre><p id="2a63" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">现在，我们必须从文本文件中读取学生姓名，并将它们以小包的形式插入到表中，即一次插入250行。我们将首先从文本文件中读取名称，并将它们存储在一个列表中，稍后我们将在小的<em class="js">批</em>中迭代该列表，以创建插入查询。</p><pre class="kr ks kt ku fd kv kq kw kx aw ky bi"><span id="2b86" class="kz la hh kq b fi lb lc l ld le">names = []</span><span id="e03a" class="kz la hh kq b fi lf lc l ld le">with open('studentFile.txt') as f:<br/>    lines = f.readlines()<br/>    for data in lines:<br/>        name = data[:-1]<br/>        # print(name)<br/>        names.append(name)</span></pre><p id="8c8d" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">一旦我们有了名字列表，我们将创建两个函数— <code class="du kn ko kp kq b">insertNames()</code>和<code class="du kn ko kp kq b">buildQuery(range)</code>。<code class="du kn ko kp kq b">insertNames()</code>函数<strong class="iw hi">根据我们的<code class="du kn ko kp kq b">BATCH_SIZE</code>计算</strong>插入所有名字所需的总迭代次数，并创建一个for循环来执行相同的操作。在循环中，它在每次迭代中调用<code class="du kn ko kp kq b">buildQuery(range)</code>来创建<code class="du kn ko kp kq b">INSERT</code>查询的<code class="du kn ko kp kq b">VALUES</code>,方法是将每次使用的<strong class="iw hi">名称范围</strong>作为函数的参数。</p><pre class="kr ks kt ku fd kv kq kw kx aw ky bi"><span id="78c9" class="kz la hh kq b fi lb lc l ld le">def insertNames():<br/>    BATCH_SIZE = 250<br/>    iterationNumber = round(len(names)/BATCH_SIZE)+1</span><span id="0571" class="kz la hh kq b fi lf lc l ld le">    conn = connectDB()<br/>    cursor = conn.cursor()</span><span id="5996" class="kz la hh kq b fi lf lc l ld le">    print(f"Total iterations to make: {iterationNumber}")<br/>    insertQuery = ""<br/>    for i in range(0, iterationNumber):<br/>        try:<br/>            namesToUse = names[i*BATCH_SIZE<br/>            :(i+1)*BATCH_SIZE]<br/>            insertQuery = buildInsertQuery(namesToUse)</span><span id="2a7b" class="kz la hh kq b fi lf lc l ld le">            # run sql query<br/>            query = (<br/>                f"INSERT INTO random.student(name)<br/>                VALUES{insertQuery}"<br/>            )<br/>            cursor.execute(query)<br/>            conn.commit()<br/>            print(f"MySQL insertion {i} completed")</span><span id="876e" class="kz la hh kq b fi lf lc l ld le">        except Exception as e:<br/>            print(f"Exception while inserting row {i} <br/>            - ignore. Error: {e}")</span></pre><p id="6886" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated"><code class="du kn ko kp kq b">buildQuery()</code>返回<code class="du kn ko kp kq b">INSERT</code>查询的<code class="du kn ko kp kq b">VALUES</code>，它基本上由<code class="du kn ko kp kq b">insertNames()</code>用来插入MySQL</p><pre class="kr ks kt ku fd kv kq kw kx aw ky bi"><span id="fd5b" class="kz la hh kq b fi lb lc l ld le">def buildQuery(range):<br/>    insertQuery = ""</span><span id="ff82" class="kz la hh kq b fi lf lc l ld le">    for name in range:<br/>        insertQuery = insertQuery + (<br/>            f"('{name}'), "<br/>        )<br/>    insertQuery = insertQuery[0:-2]</span><span id="070f" class="kz la hh kq b fi lf lc l ld le">    return insertQuery</span></pre><p id="1b12" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">我们现在只需要调用<code class="du kn ko kp kq b">insertNames()</code>来执行插入，我们就完成了</p><h1 id="22da" class="lg la hh bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">总结一下:</h1><ol class=""><li id="40f6" class="jz ka hh iw b ix md jb me jf mf jj mg jn mh jr mi kf kg kh bi translated">我们从文本文件中读取数据，并将其存储在一个列表中。</li><li id="3e38" class="jz ka hh iw b ix ki jb kj jf kk jj kl jn km jr mi kf kg kh bi translated">我们开发了一个函数— <code class="du kn ko kp kq b"> buildQuery()</code>来迭代列表，并为某个范围构建插入查询。</li><li id="8d8f" class="jz ka hh iw b ix ki jb kj jf kk jj kl jn km jr mi kf kg kh bi translated">我们计算了小批量传输全部数据所需的总迭代次数，并在每次迭代中调用我们的<code class="du kn ko kp kq b">buildQuery()</code>函数进行插入。</li></ol><p id="4b2a" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated"><strong class="iw hi"> <em class="js">附加提示</em> </strong> <em class="js">:您可以使用Python的</em> <code class="du kn ko kp kq b"><em class="js">time</em></code> <em class="js">模块对代码的每一部分进行剖析，以检查代码的效率，并跟踪每一个进程。</em></p></div><div class="ab cl mj mk go ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="ha hb hc hd he"><p id="77c1" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">感谢您通读。我将非常感谢您的评论和建议。如果你有其他的优化技术，请在评论中告诉我。</p><p id="55fd" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">如果你觉得它有用，请给我一个掌声，并与你的开发伙伴分享。<strong class="iw hi"> <em class="js">不要硬编码，硬编码！</em>T3】</strong></p><h2 id="f107" class="kz la hh bd lh mq mr ms ll mt mu mv lp jf mw mx lt jj my mz lx jn na nb mb nc bi translated"><strong class="ak">苏巴亚恩·戈什</strong></h2><p id="e70d" class="pw-post-body-paragraph iu iv hh iw b ix md iz ja jb me jd je jf nd jh ji jj ne jl jm jn nf jp jq jr ha bi translated"><a class="ae it" href="https://www.linkedin.com/in/realsubhayan/" rel="noopener ugc nofollow" target="_blank">LinkedIn</a>|<a class="ae it" href="https://twitter.com/realsubhayan" rel="noopener ugc nofollow" target="_blank">Twitter</a>|<a class="ae it" href="https://www.instagram.com/realsubhayan/" rel="noopener ugc nofollow" target="_blank">insta gram</a></p></div></div>    
</body>
</html>