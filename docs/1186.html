<html>
<head>
<title>How to create a Choropleth map using Uber H3, Plotly &amp; Python</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何创建一个Choropleth地图使用优步H3，Plotly和Python</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/how-to-create-a-choropleth-map-using-uber-h3-plotly-python-458f51593548?source=collection_archive---------1-----------------------#2021-02-18">https://medium.com/analytics-vidhya/how-to-create-a-choropleth-map-using-uber-h3-plotly-python-458f51593548?source=collection_archive---------1-----------------------#2021-02-18</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/5950820a5f27874c32d1faffe5e707ca.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*C0hiQdV5FwncliI6"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">英国图书馆在<a class="ae iu" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的<a class="ae iu" href="https://unsplash.com/@britishlibrary?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">照片</a></figcaption></figure><p id="13ee" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在本文中，我们将构建一个交互式地图，显示整个<a class="ae iu" href="https://en.wikipedia.org/wiki/Yukon" rel="noopener ugc nofollow" target="_blank">育空地区</a>的火灾分布。</p><h2 id="9594" class="jt ju hi bd jv jw jx jy jz ka kb kc kd jg ke kf kg jk kh ki kj jo kk kl km kn bi translated">关于我们将要使用的数据集，</h2><p id="fd48" class="pw-post-body-paragraph iv iw hi ix b iy ko ja jb jc kp je jf jg kq ji jj jk kr jm jn jo ks jq jr js hb bi translated">您可以使用此<a class="ae iu" href="https://opendata.arcgis.com/datasets/3c30dd2c61644302adde38a3f5750d2c_8" rel="noopener ugc nofollow" target="_blank">链接</a>从<a class="ae iu" href="https://hub.arcgis.com/" rel="noopener ugc nofollow" target="_blank"> ArcGIS Hub </a>下载数据集。数据集是点GIS coverage，由火点位置或火点多边形的质心组成，其中育空地区的火点位置未知，时间跨度为1946年至今。</p><h2 id="ec46" class="jt ju hi bd jv jw jx jy jz ka kb kc kd jg ke kf kg jk kh ki kj jo kk kl km kn bi translated">程序，</h2><ul class=""><li id="e74a" class="kt ku hi ix b iy ko jc kp jg kv jk kw jo kx js ky kz la lb bi translated">数据预处理。</li><li id="1e8b" class="kt ku hi ix b iy lc jc ld jg le jk lf jo lg js ky kz la lb bi translated">计算每个着火位置的H3单元。</li><li id="7f72" class="kt ku hi ix b iy lc jc ld jg le jk lf jo lg js ky kz la lb bi translated">清点位于每个H3牢房的所有着火点。</li><li id="a4aa" class="kt ku hi ix b iy lc jc ld jg le jk lf jo lg js ky kz la lb bi translated">使用Plotly绘制H3六边形。</li></ul><h2 id="2521" class="jt ju hi bd jv jw jx jy jz ka kb kc kd jg ke kf kg jk kh ki kj jo kk kl km kn bi translated">数据预处理</h2><p id="98d9" class="pw-post-body-paragraph iv iw hi ix b iy ko ja jb jc kp je jf jg kq ji jj jk kr jm jn jo ks jq jr js hb bi translated">首先，为我们的分析导入相关的库。在本节中，我将使用Geopandas，Numpy。</p><pre class="lh li lj lk fd ll lm ln lo aw lp bi"><span id="7bd9" class="jt ju hi lm b fi lq lr l ls lt">import geopandas as gpd<br/>import numpy as np</span></pre><p id="d575" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">假设您已经使用这个<a class="ae iu" href="https://opendata.arcgis.com/datasets/3c30dd2c61644302adde38a3f5750d2c_8.zip" rel="noopener ugc nofollow" target="_blank">链接</a>下载了数据集，并将其提取到您的工作目录，让我们导入数据集并快速浏览一下。</p><pre class="lh li lj lk fd ll lm ln lo aw lp bi"><span id="f308" class="jt ju hi lm b fi lq lr l ls lt">fire_ignitions = gpd.read_file('/data/Fire_Ignition_Locations.shp')<br/>fire_ignitions.describe()</span></pre><figure class="lh li lj lk fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lu"><img src="../Images/8ffdc3ce721af180fe9a6863fa2211b4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hFhHcwc3_ZM4phEPD7finQ.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">数据集概述</figcaption></figure><pre class="lh li lj lk fd ll lm ln lo aw lp bi"><span id="afb3" class="jt ju hi lm b fi lq lr l ls lt">numeric_columns = (fire_ignitions<br/>                   .select_dtypes(include=np.number)<br/>                   .columns<br/>                   .to_list())</span><span id="b689" class="jt ju hi lm b fi lv lr l ls lt">fire_ignitions[numeric_columns].head()</span></pre><figure class="lh li lj lk fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lw"><img src="../Images/6350ec96e2ac1bccf1815405fb8b7dbc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qMB5_6Au95YRSVBIATQh2A.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">数字列</figcaption></figure><p id="0b7a" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">让我们从数据集中删除空值。我们不打算在分析中使用所有的列。我们将选择适当的列。</p><pre class="lh li lj lk fd ll lm ln lo aw lp bi"><span id="652d" class="jt ju hi lm b fi lq lr l ls lt">fire_ignitions.dropna(inplace=True)<br/>fire_ignitions = (fire_ignitions<br/>                 [['FIRE_ID','LATITUDE_D','LONGITUDE_']])</span></pre><p id="4974" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">现在，我们的数据集可以进行分析了。进入下一步。</p><h2 id="b209" class="jt ju hi bd jv jw jx jy jz ka kb kc kd jg ke kf kg jk kh ki kj jo kk kl km kn bi translated">计算每个着火位置的H3单元</h2><p id="ecd0" class="pw-post-body-paragraph iv iw hi ix b iy ko ja jb jc kp je jf jg kq ji jj jk kr jm jn jo ks jq jr js hb bi translated">在这一部分，我将使用<a class="ae iu" href="https://h3geo.org/docs" rel="noopener ugc nofollow" target="_blank">优步·H3</a>库来为给定的起火位置分配H3单元。首先，安装H3使用，</p><pre class="lh li lj lk fd ll lm ln lo aw lp bi"><span id="7776" class="jt ju hi lm b fi lq lr l ls lt">pip install h3</span></pre><p id="a50e" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">现在，导入H3并创建一个函数来将着火点映射到H3单元格。在这个分析中，我将H3分辨率设为5。返回一个面积约为253平方公里的H3六边形。下面您可以为您的场景选择合适的分辨率。</p><figure class="lh li lj lk fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lx"><img src="../Images/2863185f927d3f7c4621e048f29b6afa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZcAttLB_RBgqJ-OuYdH_bw.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">图片来源:<strong class="bd jv">h3geo.org</strong></figcaption></figure><pre class="lh li lj lk fd ll lm ln lo aw lp bi"><span id="5135" class="jt ju hi lm b fi lq lr l ls lt">H3_res = 5<br/>def geo_to_h3(row):<br/>  return h3.geo_to_h3(lat=row.lat,lng=row.lng,resolution = H3_res)</span></pre><p id="3e10" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">然后为我们的数据集应用构建的函数，</p><pre class="lh li lj lk fd ll lm ln lo aw lp bi"><span id="098e" class="jt ju hi lm b fi lq lr l ls lt">fire_ignitions['h3_cell'] = fire_ignitions.apply(geo_to_h3,axis=1)</span></pre><p id="0c9b" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">现在我们可以删除除了新创建的“h3_cell”和“ignition_id <strong class="ix hj">”之外的其他列。</strong>现在我们的数据集看起来像这样，</p><figure class="lh li lj lk fd ij er es paragraph-image"><div class="er es ly"><img src="../Images/895d6339619b3fd92cbc78eca7a0ba53.png" data-original-src="https://miro.medium.com/v2/resize:fit:642/format:webp/1*_PE_O_SuQFXvtJ0hXO57Vw.png"/></div></figure><p id="c9a6" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">现在，我们可以进入下一部分了。</p><h2 id="d2ac" class="jt ju hi bd jv jw jx jy jz ka kb kc kd jg ke kf kg jk kh ki kj jo kk kl km kn bi translated">清点每个H3牢房中的所有着火点</h2><p id="26b2" class="pw-post-body-paragraph iv iw hi ix b iy ko ja jb jc kp je jf jg kq ji jj jk kr jm jn jo ks jq jr js hb bi translated">在本节中，我们将计算一个六边形单元格中的所有点。使用Geopandas groupby方法，</p><pre class="lh li lj lk fd ll lm ln lo aw lp bi"><span id="a507" class="jt ju hi lm b fi lq lr l ls lt">fire_ignitions_g = (fire_ignitions<br/>                          .groupby('h3_cell')<br/>                          .ignition_id<br/>                          .agg(list)<br/>                          .to_frame("ids")<br/>                          .reset_index())</span><span id="59b1" class="jt ju hi lm b fi lv lr l ls lt"># Let's count each points inside the hexagon</span><span id="4483" class="jt ju hi lm b fi lv lr l ls lt">fire_ignitions_g['count'] =(fire_ignitions_g['ids']<br/>                      .apply(lambda ignition_ids:len(ignition_ids)))</span></pre><p id="c1a8" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">然后看看我们的数据集，</p><pre class="lh li lj lk fd ll lm ln lo aw lp bi"><span id="22f3" class="jt ju hi lm b fi lq lr l ls lt">fire_ignitions_g.sort_values('count',ascending=False)</span></pre><figure class="lh li lj lk fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lz"><img src="../Images/6d084611482e6ae036bdd530ee811dad.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fEoVhDHolo9lf0-ACKLIDQ.png"/></div></div></figure><p id="bc9a" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">好了，现在我们可以进入分析的最后部分了。</p><h2 id="f822" class="jt ju hi bd jv jw jx jy jz ka kb kc kd jg ke kf kg jk kh ki kj jo kk kl km kn bi translated">使用Plotly绘制H3六边形</h2><p id="21dc" class="pw-post-body-paragraph iv iw hi ix b iy ko ja jb jc kp je jf jg kq ji jj jk kr jm jn jo ks jq jr js hb bi translated">现在我们有了六边形id和相关的点火id及其计数。对于绘图部分，我们需要为每个六边形生成六边形几何图形。我们可以使用下面的函数来实现。为此，我将使用<a class="ae iu" href="https://github.com/Toblerity/Shapely" rel="noopener ugc nofollow" target="_blank">匀称的</a>。不用担心单独安装shapely。它将在Geopandas安装过程中安装。导入就好。</p><pre class="lh li lj lk fd ll lm ln lo aw lp bi"><span id="c2ae" class="jt ju hi lm b fi lq lr l ls lt">from shapely.geometry import Polygon</span><span id="3370" class="jt ju hi lm b fi lv lr l ls lt">def add_geometry(row):<br/>  points = h3.h3_to_geo_boundary(row['h3_cell'], True)<br/>  return Polygon(points)</span><span id="1a94" class="jt ju hi lm b fi lv lr l ls lt">#Apply function into our dataframe</span><span id="1758" class="jt ju hi lm b fi lv lr l ls lt">fire_ignitions_g['geometry'] = (fire_ignitions_g<br/>                                .apply(add_geometry,axis=1))</span></pre><p id="3fdf" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">看着我们的数据框架，</p><figure class="lh li lj lk fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ma"><img src="../Images/3511101f0adbb8eb01c24b59701c87fe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GuaQBYoTtlxxFs2UnyIorQ.png"/></div></div></figure><p id="31bb" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">现在我们可以使用Plotly绘制我们的六边形。开始之前，让我们先来看看我们要用的方法。我们使用Plotly express模块的<a class="ae iu" href="https://plotly.github.io/plotly.py-docs/generated/plotly.express.choropleth.html" rel="noopener ugc nofollow" target="_blank"> choropleth_mapbox </a>方法来构建地图。为此，我们需要传递数据帧、Geojson格式的字典、数据帧的位置列、列名，我们需要为choropleth分配颜色。</p><p id="b1e1" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我们需要做的是使用我们的数据框架创建一个<em class="mb"> GeoJSON格式的字典</em>。为此，我们可以使用下面的函数。</p><figure class="lh li lj lk fd ij"><div class="bz dy l di"><div class="mc md l"/></div></figure><p id="add9" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">正在创建<em class="mb"> GeoJSON </em>对象，</p><pre class="lh li lj lk fd ll lm ln lo aw lp bi"><span id="6503" class="jt ju hi lm b fi lq lr l ls lt">geojson_obj = (hexagons_dataframe_to_geojson<br/>                (fire_ignitions_grouped,<br/>                 hex_id_field='h3_cell',<br/>                 value_field='count',<br/>                 geometry_field='geometry'))</span></pre><p id="ccd7" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">导入Plotly express模块进行绘图，</p><pre class="lh li lj lk fd ll lm ln lo aw lp bi"><span id="1294" class="jt ju hi lm b fi lq lr l ls lt">import plotly.express as px</span></pre><p id="a526" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">为我们的数据集绘制choropleth图，</p><pre class="lh li lj lk fd ll lm ln lo aw lp bi"><span id="5abb" class="jt ju hi lm b fi lq lr l ls lt">fig = (px.choropleth_mapbox(<br/>                    fire_ignitions_g, <br/>                    geojson=geojson_obj, <br/>                    locations='h3_cell', <br/>                    color='count',<br/>                    color_continuous_scale="Viridis",<br/>                    range_color=(0,fire_ignitions_g['count'].mean()           ),                  mapbox_style='carto-positron',<br/>                    zoom=7,<br/>                    center = {"lat": 65.469211, "lon": -136.713865},<br/>                    opacity=0.7,<br/>                    labels={'count':'# of fire ignitions '}))</span><span id="5cd6" class="jt ju hi lm b fi lv lr l ls lt">fig.update_layout(margin={"r":0,"t":0,"l":0,"b":0})<br/>fig.show()</span></pre><figure class="lh li lj lk fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es me"><img src="../Images/a4db7e6a60662513ee140af055950cc3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hJ28metFnVs1rBB9DhobIA.png"/></div></div></figure><p id="c452" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">请发表任何关于这次阅读的评论或问题。谢谢大家！</p><p id="f07a" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj"> <em class="mb">参考文献</em> </strong></p><ul class=""><li id="af09" class="kt ku hi ix b iy iz jc jd jg mf jk mg jo mh js ky kz la lb bi translated"><a class="ae iu" href="https://github.com/uber/h3/tree/master/docs" rel="noopener ugc nofollow" target="_blank">https://github.com/uber/h3/tree/master/docs</a></li><li id="25e5" class="kt ku hi ix b iy lc jc ld jg le jk lf jo lg js ky kz la lb bi translated"><a class="ae iu" href="https://plotly.github.io/plotly.py-docs/generated/plotly.express.choropleth.html" rel="noopener ugc nofollow" target="_blank">https://plotly . github . io/plotly . py-docs/generated/plotly . express . choropleth . html</a></li></ul></div></div>    
</body>
</html>