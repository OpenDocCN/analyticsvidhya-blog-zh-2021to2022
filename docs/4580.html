<html>
<head>
<title>Autoscale on AWS with EC2, Python, Flask, and Nginx Part2</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用EC2、Python、Flask和Nginx Part2在AWS上自动缩放</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/autoscale-on-aws-with-ec2-python-flask-and-nginx-part2-f5640e406105?source=collection_archive---------5-----------------------#2021-11-21">https://medium.com/analytics-vidhya/autoscale-on-aws-with-ec2-python-flask-and-nginx-part2-f5640e406105?source=collection_archive---------5-----------------------#2021-11-21</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><figure class="ev ex if ig ih ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es ie"><img src="../Images/9efc3f7dbfdd610c87d10edb3f5d08c8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*_k-cWwkrFLtiOp9A"/></div></div><figcaption class="ip iq et er es ir is bd b be z dx translated">照片由<a class="ae it" href="https://unsplash.com/@garyhtou" rel="noopener ugc nofollow" target="_blank"> Gary Tou </a>在<a class="ae it" href="https://unsplash.com/photos/ktpymCAIvGc" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>拍摄</figcaption></figure><p id="8278" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">在我们的<a class="ae it" href="https://dlmade.medium.com/autoscale-on-aws-with-ec2-python-flask-and-nginx-part1-240c6bbf5c35" rel="noopener">第一部分</a>中，我们已经建立了一个EC2服务器，并通过Putty访问它。现在，我们要创建一个Flask服务器，Ubuntu服务，并配置一个Nginx服务器。因此，首先让我们创建我们的Flask服务器。</p><h1 id="6cf6" class="js jt hh bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated"><strong class="ak"> Flask服务器</strong></h1><ul class=""><li id="943b" class="kq kr hh iw b ix ks jb kt jf ku jj kv jn kw jr kx ky kz la bi translated">在服务器上安装需求。由于EC2实例只为我们提供python安装，所以我们必须在pip模块的帮助下安装一个额外的python模块。</li></ul><pre class="lb lc ld le fd lf lg lh li aw lj bi"><span id="14e5" class="lk jt hh lg b fi ll lm l ln lo">sudo apt install python3-pip<br/>pip3 install flask<br/>pip3 install waitress</span></pre><ul class=""><li id="b4f0" class="kq kr hh iw b ix iy jb jc jf lp jj lq jn lr jr kx ky kz la bi translated">在服务器中创建项目目录<strong class="iw hi"> autoscale_app </strong>或者任何你喜欢的东西，然后进入那个目录。</li></ul><pre class="lb lc ld le fd lf lg lh li aw lj bi"><span id="50d5" class="lk jt hh lg b fi ll lm l ln lo">mkdir autoscale_app<br/>cd autoscale_app</span></pre><ul class=""><li id="538e" class="kq kr hh iw b ix iy jb jc jf lp jj lq jn lr jr kx ky kz la bi translated">创建一个名为<strong class="iw hi"> app.py </strong>的文件，我们将在其中编写我们的flask服务器代码。在这里，我在5000端口号上创建了一个flask服务器，当我们访问我们的网站时，它会在浏览器上显示“一个简单的flask服务器”文本。</li></ul><figure class="lb lc ld le fd ii"><div class="bz dy l di"><div class="ls lt l"/></div></figure><ul class=""><li id="fddc" class="kq kr hh iw b ix iy jb jc jf lp jj lq jn lr jr kx ky kz la bi translated">我们的Flask应用程序已经准备好，我们可以在浏览器上运行并查看该应用程序，但它目前运行在端口5000上，因此访问web时，我们必须将端口号5000与我们的IP地址包括在内，并且我们必须允许我们的服务器入站中有5000个端口。因此，要在没有端口的IP地址上直接访问应用程序，我们将使用Nginx服务器来管理我们服务器上的流量，并将其路由到我们的应用程序。</li></ul><h1 id="576e" class="js jt hh bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated"><strong class="ak"> Nginx </strong></h1><ul class=""><li id="092d" class="kq kr hh iw b ix ks jb kt jf ku jj kv jn kw jr kx ky kz la bi translated">安装Nginx</li></ul><pre class="lb lc ld le fd lf lg lh li aw lj bi"><span id="c0cc" class="lk jt hh lg b fi ll lm l ln lo">sudo apt install nginx</span></pre><ul class=""><li id="0d20" class="kq kr hh iw b ix iy jb jc jf lp jj lq jn lr jr kx ky kz la bi translated">我们将使用一个<strong class="iw hi"> OpenSSL </strong>来创建一个SSL证书和一个密钥文件，这将允许我们的应用程序在HTTPS服务器上运行我们的网站。</li></ul><pre class="lb lc ld le fd lf lg lh li aw lj bi"><span id="0cb7" class="lk jt hh lg b fi ll lm l ln lo">sudo openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout /etc/ssl/private/nginx-selfsigned.key -out /etc/ssl/certs/nginx-selfsigned.crt</span></pre><ul class=""><li id="31cd" class="kq kr hh iw b ix iy jb jc jf lp jj lq jn lr jr kx ky kz la bi translated">我们将创建一个<strong class="iw hi"> self-signed.conf </strong>文件，在其中写入我们的证书和密钥文件路径。我们将在Nginx配置中提供这个文件。</li></ul><pre class="lb lc ld le fd lf lg lh li aw lj bi"><span id="eea8" class="lk jt hh lg b fi ll lm l ln lo">sudo vi /etc/nginx/snippets/self-signed.conf</span></pre><ul class=""><li id="66a4" class="kq kr hh iw b ix iy jb jc jf lp jj lq jn lr jr kx ky kz la bi translated">将以下内容粘贴到<strong class="iw hi"> self-signed.conf </strong>文件中。</li></ul><pre class="lb lc ld le fd lf lg lh li aw lj bi"><span id="5971" class="lk jt hh lg b fi ll lm l ln lo">ssl_certificate /etc/ssl/certs/nginx-selfsigned.crt;<br/>ssl_certificate_key /etc/ssl/private/nginx-selfsigned.key;</span></pre><ul class=""><li id="c736" class="kq kr hh iw b ix iy jb jc jf lp jj lq jn lr jr kx ky kz la bi translated">下面是一些可以使Nginx服务器更加安全的参数。你可以参考<a class="ae it" href="https://www.digitalocean.com/community/tutorials/how-to-create-a-self-signed-ssl-certificate-for-nginx-in-ubuntu-18-04" rel="noopener ugc nofollow" target="_blank">这里的</a>来深入了解这项服务。</li></ul><pre class="lb lc ld le fd lf lg lh li aw lj bi"><span id="c5b8" class="lk jt hh lg b fi ll lm l ln lo">sudo vi /etc/nginx/snippets/ssl-params.conf</span></pre><ul class=""><li id="7c7d" class="kq kr hh iw b ix iy jb jc jf lp jj lq jn lr jr kx ky kz la bi translated">将以下内容复制到文件中。</li></ul><pre class="lb lc ld le fd lf lg lh li aw lj bi"><span id="83da" class="lk jt hh lg b fi ll lm l ln lo">ssl_protocols TLSv1.2;<br/>ssl_prefer_server_ciphers on;<br/>ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-SHA384;<br/>ssl_ecdh_curve secp384r1; # Requires nginx &gt;= 1.1.0<br/>ssl_session_timeout  10m;<br/>ssl_session_cache shared:SSL:10m;<br/>ssl_session_tickets off; # Requires nginx &gt;= 1.5.9<br/>ssl_stapling on; # Requires nginx &gt;= 1.3.7<br/>ssl_stapling_verify on; # Requires nginx =&gt; 1.3.7<br/>resolver 8.8.8.8 8.8.4.4 valid=300s;<br/>resolver_timeout 5s;<br/># Disable strict transport security for now. You can uncomment the following<br/># line if you understand the implications.<br/># add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload";<br/>add_header X-Frame-Options DENY;<br/>add_header X-Content-Type-Options nosniff;<br/>add_header X-XSS-Protection "1; mode=block";</span></pre><ul class=""><li id="0b6a" class="kq kr hh iw b ix iy jb jc jf lp jj lq jn lr jr kx ky kz la bi translated">现在我们将创建一个Nginx配置文件，我们可以在其中定义路由、服务器名称、HTTP服务器，并给出SSL证书。</li></ul><pre class="lb lc ld le fd lf lg lh li aw lj bi"><span id="5a08" class="lk jt hh lg b fi ll lm l ln lo">sudo vi /etc/nginx/sites-available/default</span></pre><ul class=""><li id="f5d6" class="kq kr hh iw b ix iy jb jc jf lp jj lq jn lr jr kx ky kz la bi translated">下面的内容创建了两个服务器块，一个用于HTTP(端口80)，另一个用于HTTPS(端口443)。也可以合二为一。它将告诉Nginx将服务器上的任何流量路由到localhost 5000端口。</li></ul><pre class="lb lc ld le fd lf lg lh li aw lj bi"><span id="308b" class="lk jt hh lg b fi ll lm l ln lo">server {<br/>        listen 80;<br/>        listen [::]:80;<br/>        location / {<br/>            proxy_pass <a class="ae it" href="http://127.0.0.1:5000" rel="noopener ugc nofollow" target="_blank">http://127.0.0.1:5000</a>;<br/>            proxy_set_header X-Real-IP $remote_addr;<br/>        }<br/>}<br/>server {<br/>    listen 443 ssl;<br/>    listen [::]:443 ssl;<br/>    include snippets/self-signed.conf;<br/>    include snippets/ssl-params.conf;<br/> location / {<br/>            proxy_pass <a class="ae it" href="https://127.0.0.1:5000" rel="noopener ugc nofollow" target="_blank">https://127.0.0.1:5000</a>;<br/>            proxy_set_header X-Real-IP $remote_addr;<br/>        }<br/>}</span></pre><h1 id="24b3" class="js jt hh bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated"><strong class="ak">创建ubuntu服务运行Flask app </strong></h1><ul class=""><li id="cef2" class="kq kr hh iw b ix ks jb kt jf ku jj kv jn kw jr kx ky kz la bi translated">我们已经配置了flask app和Nginx服务器。现在，我们已经准备好启动我们的应用程序，但在此之前，我们必须确保如果我们的服务器重新启动，那么我们的应用程序应该会自动启动，因为我们将创建一个ubuntu服务。这将自动启动我们的应用程序，每当服务器重新启动，所以我们不必做任何手动任务。</li></ul><pre class="lb lc ld le fd lf lg lh li aw lj bi"><span id="961e" class="lk jt hh lg b fi ll lm l ln lo">sudo vi /etc/systemd/system/autoscale.service</span></pre><ul class=""><li id="1f90" class="kq kr hh iw b ix iy jb jc jf lp jj lq jn lr jr kx ky kz la bi translated">下面的内容给出了ubuntu服务器的命令，当服务器重新启动时，这个服务也会自动启动。确保您可以使用项目目录更改工作目录路径。Exec start是服务启动时将由服务触发的命令。我们将使用python3.6启动我们的flask应用程序，所以我给出了python3.6和我们的app.py的绝对路径。</li></ul><pre class="lb lc ld le fd lf lg lh li aw lj bi"><span id="fd32" class="lk jt hh lg b fi ll lm l ln lo">[Unit]<br/>Description=Autoscale Flask project<br/>After=network.target<br/>[Service]<br/>User=ubuntu<br/>Group=www-data<br/>#WorkingDirectory=/home/ubuntu/autoscale_app     ## replace with your project directory path<br/>ExecStart=/usr/bin/python3.6 /home/ubuntu/autoscale_app/app.py</span><span id="591a" class="lk jt hh lg b fi lu lm l ln lo">[Install]<br/>WantedBy=multi-user.target</span></pre><ul class=""><li id="d880" class="kq kr hh iw b ix iy jb jc jf lp jj lq jn lr jr kx ky kz la bi translated">现在，我们将启动并启用该服务。通过启用该服务，我们告诉服务器该服务将在每次重新启动时运行。如果我们的服务被禁用，应用程序将不会运行时，服务器重新启动。</li></ul><pre class="lb lc ld le fd lf lg lh li aw lj bi"><span id="b98a" class="lk jt hh lg b fi ll lm l ln lo">sudo systemctl start autoscale.service<br/>sudo systemctl enable autoscale.service</span></pre><ul class=""><li id="009d" class="kq kr hh iw b ix iy jb jc jf lp jj lq jn lr jr kx ky kz la bi translated">我们还将重启Nginx服务器，因为我们已经更改了Nginx的配置。没有重启，我们的配置想要反映。</li></ul><pre class="lb lc ld le fd lf lg lh li aw lj bi"><span id="bd46" class="lk jt hh lg b fi ll lm l ln lo">sudo systemctl restart nginx</span></pre><ul class=""><li id="6ba2" class="kq kr hh iw b ix iy jb jc jf lp jj lq jn lr jr kx ky kz la bi translated">去你的实例的公共IP地址，你可以看到我们的应用程序正在运行。</li></ul><figure class="lb lc ld le fd ii er es paragraph-image"><div class="er es lv"><img src="../Images/7c382c54104ade3fa809ac74084c82ef.png" data-original-src="https://miro.medium.com/v2/resize:fit:1204/format:webp/1*CodtZ9tG5htD-cJcUWitEQ.png"/></div></figure><p id="7143" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">这就是第2部分的全部内容。下一篇文章我们再相见。</p><p id="8bd6" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">如果你喜欢这篇文章，点击给我买杯咖啡！感谢阅读。</p><figure class="lb lc ld le fd ii er es paragraph-image"><a href="https://www.payumoney.com/paybypayumoney/#/147695053B73CAB82672E715A52F9AA5"><div class="er es lw"><img src="../Images/d1500c2f9e74d7f54553250f9445e8fd.png" data-original-src="https://miro.medium.com/v2/resize:fit:834/format:webp/1*RPDyXqHjKKbesbJgLZ96mQ.png"/></div></a></figure><p id="48f8" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">你的每一个小小的贡献都会鼓励我创造更多这样的内容。</p></div></div>    
</body>
</html>