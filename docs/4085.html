<html>
<head>
<title>Deploy A Flask REST API to Azure App Service using Docker</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Docker将Flask REST API部署到Azure应用服务</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/deploy-a-flask-rest-api-to-azure-app-service-using-docker-8ab68a56c53e?source=collection_archive---------0-----------------------#2021-08-25">https://medium.com/analytics-vidhya/deploy-a-flask-rest-api-to-azure-app-service-using-docker-8ab68a56c53e?source=collection_archive---------0-----------------------#2021-08-25</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/b0f6d00e4d70b53b77917f8b9bca2e62.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*MG7AblvAsfl83J_I.jpg"/></div></div></figure><p id="5d52" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在本教程中，我将讨论使用Docker将Flask应用程序部署到Azure App Service。本博客的先决条件是:</p><ul class=""><li id="ae48" class="jo jp hi is b it iu ix iy jb jq jf jr jj js jn jt ju jv jw bi translated">计算机编程语言</li><li id="b0b7" class="jo jp hi is b it jx ix jy jb jz jf ka jj kb jn jt ju jv jw bi translated">瓶</li><li id="90ad" class="jo jp hi is b it jx ix jy jb jz jf ka jj kb jn jt ju jv jw bi translated">docker(<code class="du kc kd ke kf b"><strong class="is hj">Dockerfile</strong></code>和<code class="du kc kd ke kf b"><strong class="is hj">Docker Compose</strong></code>的概念)</li><li id="b614" class="jo jp hi is b it jx ix jy jb jz jf ka jj kb jn jt ju jv jw bi translated">蓝色资源的一些概念，如<code class="du kc kd ke kf b"><strong class="is hj">Azure App Service, Azure Container Registry, Azure Resource Group</strong></code>等</li></ul><p id="2dde" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">用<code class="du kc kd ke kf b"><strong class="is hj">Dockerfile</strong></code>和<code class="du kc kd ke kf b"><strong class="is hj">docker-compose</strong></code>构建的样品瓶架API可以在<a class="ae kg" href="https://github.com/kartheekgottipati/Docker-compose-flask-redis-deploy" rel="noopener ugc nofollow" target="_blank">这里</a>找到。我将从终端做所有的步骤，因为这将是有益的CICD项目的实施。虽然，我用的是macOS，但我认为Ubuntu(或任何其他Linux)用户可以使用相同的命令。我已经尽力使这个教程非常紧凑。下面是步骤。</p><h1 id="f40e" class="kh ki hi bd kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le bi translated">构建和测试</h1><p id="62ce" class="pw-post-body-paragraph iq ir hi is b it lf iv iw ix lg iz ja jb lh jd je jf li jh ji jj lj jl jm jn hb bi translated">通过构建docker映像并运行它来构建和测试应用程序。导航到您的项目存储库并运行，</p><pre class="lk ll lm ln fd lo kf lp lq aw lr bi"><span id="d704" class="ls ki hi kf b fi lt lu l lv lw">$ docker compose build<br/>$ docker compose up</span></pre><h1 id="d94d" class="kh ki hi bd kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le bi translated">安装Azure CLI</h1><p id="3220" class="pw-post-body-paragraph iq ir hi is b it lf iv iw ix lg iz ja jb lh jd je jf li jh ji jj lj jl jm jn hb bi translated">这个构建的docker映像需要被推送到<code class="du kc kd ke kf b">Azure container registry</code>并且<code class="du kc kd ke kf b">Azure app Service</code>将选择这个映像并作为服务运行。因此，要与azure进行交互，需要安装<code class="du kc kd ke kf b">Azure CLI</code>。</p><pre class="lk ll lm ln fd lo kf lp lq aw lr bi"><span id="aaa6" class="ls ki hi kf b fi lt lu l lv lw">$ <!-- -->brew update &amp;&amp; brew install azure-cli<br/>$ az login</span></pre><h1 id="c469" class="kh ki hi bd kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le bi translated">创建Azure资源组</h1><p id="ac9f" class="pw-post-body-paragraph iq ir hi is b it lf iv iw ix lg iz ja jb lh jd je jf li jh ji jj lj jl jm jn hb bi translated">要在Azure中执行任何操作，都需要一个资源组。<code class="du kc kd ke kf b">Azure App Service, Azure Container Registry, Azure Kubernetes, Azure SQL Database</code>等，都是资源组的组成部分。一个资源组中的组件可以与另一个资源组中的组件通信。对于这个项目，您需要首先创建一个资源组，然后在这个资源组中需要创建<code class="du kc kd ke kf b">Azure Container Registry</code>和<code class="du kc kd ke kf b">Azure App Service</code>。要在Azure中创建资源组，请运行以下命令，</p><pre class="lk ll lm ln fd lo kf lp lq aw lr bi"><span id="eac7" class="ls ki hi kf b fi lt lu l lv lw">$ az group create -l westus -n [ResourceGroupName]</span></pre><p id="57cf" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><code class="du kc kd ke kf b">[ResourceGroupName]</code>将替换为所选的资源组名称。例如，如果选择的资源组是<code class="du kc kd ke kf b">my_azure_group,</code>，那么上面的命令将是，<code class="du kc kd ke kf b">$ az group create -l westus -n my_azure_group.</code></p><h1 id="a6c7" class="kh ki hi bd kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le bi translated">创建Azure容器注册表(ACR)</h1><pre class="lk ll lm ln fd lo kf lp lq aw lr bi"><span id="26b4" class="ls ki hi kf b fi lt lu l lv lw">$ az acr create --resource-group [ResourceGroupName] --name [ACRName] --sku Basic <br/>$ az acr login --name [ACRName]</span></pre><p id="57d9" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">第一行将使用提供的名称创建一个ACR，第二行将要求登录以进行身份验证。</p><h1 id="aa2c" class="kh ki hi bd kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le bi translated">将本地Docker映像推送到ACR</h1><p id="3f11" class="pw-post-body-paragraph iq ir hi is b it lf iv iw ix lg iz ja jb lh jd je jf li jh ji jj lj jl jm jn hb bi translated">要查看当前本地图像列表，请使用docker images命令:<br/> <code class="du kc kd ke kf b">$ docker images</code></p><p id="5cbf" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">上述命令的输出显示了当前本地图像的列表:</p><pre class="lk ll lm ln fd lo kf lp lq aw lr bi"><span id="15c8" class="ls ki hi kf b fi lt lu l lv lw">REPOSITORY    TAG         IMAGE ID           CREATED           SIZE<br/>[AppName]    latest      34e1853337c2      7 minutes ago      1.24GB</span></pre><p id="6e08" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">要在ACR中使用<code class="du kc kd ke kf b">[AppName]</code>容器图像，需要用注册中心的登录服务器地址标记图像。该标签用于将容器图像推送到图像注册中心时的路由。</p><p id="a374" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">要获得登录服务器地址，使用<code class="du kc kd ke kf b">az acr list</code>命令并查询<code class="du kc kd ke kf b">loginServer</code>，如下所示:</p><pre class="lk ll lm ln fd lo kf lp lq aw lr bi"><span id="ee17" class="ls ki hi kf b fi lt lu l lv lw">$ az acr list --resource-group [ResourceGroupName] --query "[].{acrLoginServer:loginServer}" --output table</span></pre><p id="4ceb" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这将给出以下输出:<code class="du kc kd ke kf b">[AppName].azurecr.io.</code>现在，用容器注册中心的acrLoginServer地址<code class="du kc kd ke kf b">[AppName].azurecr.io</code>标记本地<code class="du kc kd ke kf b">[AppName]</code>图像。为了指示图像版本，在图像名称的末尾添加<code class="du kc kd ke kf b">:v1</code>:</p><pre class="lk ll lm ln fd lo kf lp lq aw lr bi"><span id="ed34" class="ls ki hi kf b fi lt lu l lv lw">$ docker tag [AppName]:latest [AppName].azurecr.io/[AppName]:v1</span></pre><p id="91d2" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">要验证标签是否已应用，再次运行<code class="du kc kd ke kf b">docker images</code>。图像被标记上ACR实例地址和版本号。</p><figure class="lk ll lm ln fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lx"><img src="../Images/eb74cd2814a8f77b6a6a6d80016b67e3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_0-4G8KwGGHmgKDHMAMuZQ.png"/></div></div></figure><p id="75ae" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">构建并标记好映像后，将<code class="du kc kd ke kf b">[AppName].azurecr.io/[AppName]</code>映像推送到ACR实例。使用docker push并为映像名称提供acrLoginServer地址，如下所示:</p><pre class="lk ll lm ln fd lo kf lp lq aw lr bi"><span id="a25b" class="ls ki hi kf b fi lt lu l lv lw">$ docker push [AppName].azurecr.io/[AppName]:v1</span></pre><h1 id="3645" class="kh ki hi bd kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le bi translated">创建应用服务</h1><p id="5308" class="pw-post-body-paragraph iq ir hi is b it lf iv iw ix lg iz ja jb lh jd je jf li jh ji jj lj jl jm jn hb bi translated">要创建应用服务，需要创建一个应用服务计划。</p><pre class="lk ll lm ln fd lo kf lp lq aw lr bi"><span id="f5f1" class="ls ki hi kf b fi lt lu l lv lw">$ az appservice plan create --name [PlanName] --resource-group  [ResourceGroupName] --is-linux</span><span id="985e" class="ls ki hi kf b fi ly lu l lv lw">$ az webapp create --resource-group [ResourceGroupName] --plan [PlanName] --name [AppName] --deployment-container-image-name [AppName].azurecr.io/[AppName]:latest</span></pre><h1 id="570d" class="kh ki hi bd kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le bi translated">设置端口</h1><pre class="lk ll lm ln fd lo kf lp lq aw lr bi"><span id="21e3" class="ls ki hi kf b fi lt lu l lv lw">$ az webapp config appsettings set --resource-group [ResourceGroupName] --name [AppName] --settings WEBSITES_PORT=80</span></pre><h1 id="d71a" class="kh ki hi bd kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le bi translated">启用托管身份并检索主体ID</h1><pre class="lk ll lm ln fd lo kf lp lq aw lr bi"><span id="2abb" class="ls ki hi kf b fi lt lu l lv lw">az webapp identity assign --resource-group [ResourceGroupName] --name [AppName] --query principalId --output tsv</span></pre><h1 id="dde5" class="kh ki hi bd kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le bi translated">检索订阅ID</h1><pre class="lk ll lm ln fd lo kf lp lq aw lr bi"><span id="9a1d" class="ls ki hi kf b fi lt lu l lv lw">az account show --query id --output tsv</span></pre><h1 id="d9de" class="kh ki hi bd kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le bi translated">授予web应用程序访问容器注册表的权限</h1><p id="14b0" class="pw-post-body-paragraph iq ir hi is b it lf iv iw ix lg iz ja jb lh jd je jf li jh ji jj lj jl jm jn hb bi translated">将主体ID和订阅ID放在下面的命令中，这是从上面两个命令中检索的。连续部署需要以下命令。</p><pre class="lk ll lm ln fd lo kf lp lq aw lr bi"><span id="4dd6" class="ls ki hi kf b fi lt lu l lv lw">$ az role assignment create --assignee [PrincipalID] --scope  /subscriptions/[SubscriptionID]/resourceGroups/[ResourceGroupName]/providers/Microsoft.ContainerRegistry/registries/[AppName] --role "AcrPull"</span></pre><h1 id="9425" class="kh ki hi bd kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le bi translated">部署容器映像</h1><pre class="lk ll lm ln fd lo kf lp lq aw lr bi"><span id="ea5f" class="ls ki hi kf b fi lt lu l lv lw">$ az webapp config container set --name [AppName] --resource-group [ResourceGroupName] --docker-custom-image-name [AppName].azurecr.io/[AppName]:latest --docker-registry-server-url <a class="ae kg" href="https://secureaiacr.azurecr.io" rel="noopener ugc nofollow" target="_blank">https://[AppName].azurecr.io</a></span></pre><p id="a913" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">部署后，可以从未经验证的URL<code class="du kc kd ke kf b">[AppName].azurewebsites.net</code>访问应用程序。您可以使用<code class="du kc kd ke kf b">Postman</code>来请求这个URL中的API。</p><h1 id="6f2d" class="kh ki hi bd kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le bi translated">剧终</h1><p id="145f" class="pw-post-body-paragraph iq ir hi is b it lf iv iw ix lg iz ja jb lh jd je jf li jh ji jj lj jl jm jn hb bi translated">所以，这是本文的结尾，却是这个系列的开始。请在下面评论任何问题或建议。谢谢你。</p></div></div>    
</body>
</html>