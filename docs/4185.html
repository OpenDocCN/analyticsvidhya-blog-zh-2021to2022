<html>
<head>
<title>From SPSS to R, Rewriting Code for Survey Data Tabulation: MICS Survey Example</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">从SPSS到R，重写调查数据列表的代码:多指标类集调查实例</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/from-spss-to-r-rewriting-code-for-survey-data-tabulation-mics-survey-example-3d72d3c813f7?source=collection_archive---------9-----------------------#2021-09-06">https://medium.com/analytics-vidhya/from-spss-to-r-rewriting-code-for-survey-data-tabulation-mics-survey-example-3d72d3c813f7?source=collection_archive---------9-----------------------#2021-09-06</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="5455" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">住户调查是最复杂的统计数据收集和汇编工作之一。它们是由世界各地的国家统计局、其他政府机构和私人研究组织进行的。</p><p id="e168" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">可以使用各种工具对其中收集的数据进行分析。</p><p id="2bd3" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">对我来说，使用任何调查数据的附加值将是在不同的数据分析平台上运行分析的可能性。这为额外的质量控制检查、将一项调查的部分/模块整合到在不同平台上处理的其他调查中，或在表格旁边添加额外的报告模式(如choropleths或复杂的可视化)提供了可能性</p><p id="5773" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在这项工作中，使用了多指标类集调查中产生的许多表格之一的SPSS语法，并在r中重新编码。多指标类集调查(<a class="ae jc" href="https://mics.unicef.org/" rel="noopener ugc nofollow" target="_blank">多指标类集调查</a>)是关于全世界儿童和妇女的最大的可靠统计和国际可比数据来源。为了在多指标类集调查中收集数据，访问员对15至49岁的妇女和男子、所有5岁以下儿童的母亲或看护人以及随机选择的5至17岁儿童发放家庭问卷和个人问卷。</p><p id="dc19" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">出于本练习的目的，将多指标类集调查标准表格SR.6.1M中使用的一个SPSS语法文件用r重新编码。所有<a class="ae jc" href="https://mics.unicef.org/files?job=W1siZiIsIjIwMjEvMDQvMjAvMDYvMjUvMTcvMTE0LzQyX1N5bnRheF9GaWxlc18yMDA0MjAyMS56aXAiXV0&amp;sha=71bc21b2d7d8bb4a" rel="noopener ugc nofollow" target="_blank">多指标类集调查标准SPSS语法可在多指标类集调查网站上在线</a>获得。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es jd"><img src="../Images/741449f89bd67af621057c535a0a2a38.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cgfWXGGT0SZTf6RrQ6a6YA.jpeg"/></div></div></figure><p id="d84d" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这是多指标类集调查中一个相当简单的表格，它显示了15-49岁男性的识字率。在多指标类集调查中，所有达到小学以上教育水平的男子都被认为是识字的。除了正规教育水平之外，在调查中被采访的任何没有完成小学教育或只受过小学教育的男子(问卷中的问题MWB6)被要求朗读采访者给的卡片上的一句话(问卷中的问题MWB14)。所有这些问题都是针对15-49岁男性个体的<a class="ae jc" href="https://mics.unicef.org/files?job=W1siZiIsIjIwMjAvMDcvMjAvMjAvNTIvMDIvNDU5L01JQ1M2X1F1ZXN0aW9ubmFpcmVfZm9yX0luZGl2aWR1YWxfTWVuXzIwMjAwNjE3LmRvY3giXV0&amp;sha=f322b2b47d0fc9b5" rel="noopener ugc nofollow" target="_blank">问卷的标准问题，该问卷的模板版本也可在网上获得。</a></p><p id="ae92" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">像多指标类集调查和DHS这样的大型国际社会统计调查项目通常使用专门的高级软件进行分析，如SPSS或Stata。原因很简单，比如可以创建自定义表格(SPSS中的“ctables”功能或“collect layout”的Stata组合)，其中包含用于分解指标的所有相关社会经济背景特征，比如按区域(城市/农村)、地区、种族、宗教、财富五分位数以及为每次调查定义的其他特征。</p></div><div class="ab cl jp jq go jr" role="separator"><span class="js bw bk jt ju jv"/><span class="js bw bk jt ju jv"/><span class="js bw bk jt ju"/></div><div class="ha hb hc hd he"><p id="93db" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这篇文章的目标是展示与开源软件相同的功能，如使用“expss”包的R。除了列表和结果与原始结果的比较之外，使用R允许与其他不同的软件包集成，如上所述。</p><p id="df72" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">用于运行SR.6.1M SPSS语法的特定数据集关于<em class="jw">“识字率(男性)<br/>“15-49岁男性最高受教育程度和识字率的百分比分布，以及总识字率”</em></p><p id="30f0" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">来自<a class="ae jc" href="https://tongastats.gov.to/survey/mics-survey/" rel="noopener ugc nofollow" target="_blank">汤加2019年多指标类集调查</a>，其数据集也可从<a class="ae jc" href="https://mics.unicef.org/surveys" rel="noopener ugc nofollow" target="_blank">在线</a>获得。</p><p id="3977" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这张特殊的表格发表在<a class="ae jc" href="https://mics-surveys-prod.s3.amazonaws.com/MICS6/East%20Asia%20and%20the%20Pacific/Tonga/2019/Survey%20findings/Tonga%202019%20MICS%20Survey%20Findings%20Report_English.pdf" rel="noopener ugc nofollow" target="_blank">调查结果报告</a>的第64页。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es jx"><img src="../Images/c554c36f00649145b1b5a33ebfaac914.png" data-original-src="https://miro.medium.com/v2/resize:fit:1120/format:webp/1*EWC_anut25_IZqze1cavLQ.png"/></div></figure><p id="969f" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi">中SPSS </strong>初始段的语法看起来是这样的:</p><pre class="je jf jg jh fd jy jz ka kb aw kc bi"><span id="07d6" class="kd ke hh jz b fi kf kg l kh ki">include "surveyname.sps".</span><span id="7ec0" class="kd ke hh jz b fi kj kg l kh ki">get file = 'mn.sav'.</span><span id="ff76" class="kd ke hh jz b fi kj kg l kh ki">include "CommonVarsMN.sps".</span><span id="a932" class="kd ke hh jz b fi kj kg l kh ki">select if (MWM17 = 1).</span><span id="e956" class="kd ke hh jz b fi kj kg l kh ki">weight by mnweight.</span><span id="a87c" class="kd ke hh jz b fi kj kg l kh ki">compute literate  = 2.<br/>if (MWB6A &gt;= 2 and MWB6A &lt; 8) literate = 1. <br/>if (MWB14 = 3) literate = 1.<br/>variable labels literate " ".<br/>value labels literate 1 "Literate" 2 "Illiterate".</span><span id="5756" class="kd ke hh jz b fi kj kg l kh ki">compute literateP = 0.<br/>if (literate = 1) literateP = 100. <br/>variable labels literateP "Total percentage literate [1]".</span><span id="a9bf" class="kd ke hh jz b fi kj kg l kh ki">compute layer = 0.<br/>variable labels layer " ".<br/>value labels layer 0 "Percent distribution of highest level attended and literacy".</span><span id="e87e" class="kd ke hh jz b fi kj kg l kh ki">* add A to welevel label.<br/> * add value labels mwelevel 3 "Secondary or higher [A]".<br/>* country specicif add A to welevel label.<br/>add value labels mwelevel 3 "Upper secondary or higher [A]".</span><span id="83f4" class="kd ke hh jz b fi kj kg l kh ki">compute numMen = 1.<br/>variable labels numMen "Number of men".<br/>value labels numMen 1 "".</span><span id="592a" class="kd ke hh jz b fi kj kg l kh ki">compute total = 1.<br/>variable labels total "Total".<br/>value labels total 1 " ".</span><span id="c2df" class="kd ke hh jz b fi kj kg l kh ki">compute tot = 100.<br/>variable labels tot "Total".<br/>value labels tot 100 " ".</span></pre><p id="6ee0" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">语法的这一部分(第1-59行)执行以下操作:计算阅读过卡片的回答者的识字率(变量‘识字’)，只考虑那些能够阅读整句话的人，增加男性的调查权重，增加识字率的百分比变量(变量‘识字’)，计算男性总数(变量‘numMen’)和总百分比(变量‘tot’)</p><p id="72b6" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">对于R 中的<strong class="ig hi">相同代码，将需要多几行代码:</strong></p><pre class="je jf jg jh fd jy jz ka kb aw kc bi"><span id="6d26" class="kd ke hh jz b fi kf kg l kh ki">---<br/>title: "SPSS to R - recoding of a Survey Syntax"<br/>author: "Filip Mitrovic"<br/>output:<br/>  word_document: default<br/>  html_document: default<br/>  pdf_document: default<br/>---<br/>## Library needed to reproduce the SPSS syntax household survey table in R are below. Author of the 'expss' package notes that it should be loaded only after the 'heaven' package.<br/>```{r setup, echo=FALSE}</span><span id="cd64" class="kd ke hh jz b fi kj kg l kh ki">library(foreign)<br/>library (haven)<br/>library (expss)<br/>```</span><span id="f009" class="kd ke hh jz b fi kj kg l kh ki">### path to *.sav file with the survey dataset.</span><span id="ddd4" class="kd ke hh jz b fi kj kg l kh ki">```{r, results="hide"}<br/> <br/>path = ''<br/>setwd(path)</span><span id="7d47" class="kd ke hh jz b fi kj kg l kh ki">data = read.spss('mn.sav', to.data.frame = T, use.value.labels = FALSE) ##data set is loaded with numerical values to save keystrokes</span><span id="ccd8" class="kd ke hh jz b fi kj kg l kh ki">data %&gt;% filter(data$MWM17 == 1) # selects only responses from completed interviews with men age 15-49 in the survey</span><span id="2188" class="kd ke hh jz b fi kj kg l kh ki">```</span></pre></div><div class="ab cl jp jq go jr" role="separator"><span class="js bw bk jt ju jv"/><span class="js bw bk jt ju jv"/><span class="js bw bk jt ju"/></div><div class="ha hb hc hd he"><p id="dc25" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">除了定义相同的变量:literate、literateP、tot、numMen之外，该语法还定义了运行spss *所需的库。R环境下的sav文件。</p><p id="769f" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在该段之后，执行与SPSS语法中相同的计算:###如SPSS语法中的计算能力，重写</p><pre class="je jf jg jh fd jy jz ka kb aw kc bi"><span id="11cb" class="kd ke hh jz b fi kf kg l kh ki">```{r pressure, echo=TRUE}</span><span id="5bdd" class="kd ke hh jz b fi kj kg l kh ki">data = compute(data, {<br/>  literate = 2<br/>})</span><span id="9163" class="kd ke hh jz b fi kj kg l kh ki">data$literate&lt;- ifelse((data$MWB6A &gt;=2 &amp; data$MWB6A &lt;8), 1,<br/>                       ifelse(data$MWB14==3,1,2))</span><span id="8c44" class="kd ke hh jz b fi kj kg l kh ki"># making data numeric in R dataframe for calculations<br/>data$literate&lt;-as.numeric(as.character(data$literate))</span><span id="f977" class="kd ke hh jz b fi kj kg l kh ki"># adding value labels in R, comparable to 'value labels' function in SPSS. <br/>val_lab(data$literate) = num_lab("<br/>                                 1 Literate<br/>                                 2 Illiterate<br/>                                 ")<br/># adding variable with overall percent of literate respondents. This is comparable to 'compute' function in SPSS. All variables have identical names as in SPSS syntax for easier reference.  <br/>data = compute(data, {<br/>  literateP = 0<br/>})</span><span id="aff8" class="kd ke hh jz b fi kj kg l kh ki">data$literateP&lt;- ifelse(data$literate ==1,100,0)</span><span id="1bb6" class="kd ke hh jz b fi kj kg l kh ki">#recode(data$mwelevel) = c(0 ~ 0, 1 ~ 1, 2:3 ~ 2, 9 ~ 9, other ~ NA)</span><span id="fa84" class="kd ke hh jz b fi kj kg l kh ki"># adds value labels to the column headings in the table in R. This is not in SPSS syntax as those are already pre-defined in the *sav dataset<br/>data$mwelevel&lt;-as.numeric(as.character(data$mwelevel))<br/>val_lab(data$mwelevel) = num_lab("<br/>1 Up to primary<br/>2 Lower secondary<br/>3 Upper Secondary or higher [A]<br/>9 Don't know/ Missing<br/>                                 ")<br/># computes additional columns as in SPSS syntax, for overall number of cases and a total percentage. 'numMen' and 'tot' are identical variable names as in SPSS syntax<br/>data = compute(data, {<br/>  numMen = 1<br/>})</span><span id="590e" class="kd ke hh jz b fi kj kg l kh ki">data = compute(data, {<br/>  tot = 1<br/>})</span><span id="3dd2" class="kd ke hh jz b fi kj kg l kh ki"># adding variable  labels. Labels added identical as in comparable SPSS syntax. In addition labels also added to the background characteristic variables that are shown in rows. This is not seen in SPSS syntax as they are already in the *.sav file. <br/>data&lt;-apply_labels(data, <br/>                   literateP =  "Total percentage literate [1]",<br/>                   numMen = "Number of men",<br/>                   HH6 = "Area", # up to variable 'mwelevel' all variables are background characteristics. <br/>                   HH7 = "Region",<br/>                   mdisability = "Functional difficulty",<br/>                   religion = "Religion of the household head",<br/>                   ethnicity = "Ethnicity of the household head",<br/>                   windex5 = "Wealth quintile",<br/>                   mwelevel = "Percent Distribution of highest level attended and literacy",<br/>                   tot = "Total",<br/>                   literate ="Literacy rate")</span><span id="19a1" class="kd ke hh jz b fi kj kg l kh ki"># adding value labels as in SPSS. next to syntax specific value labels, that are shown in the comparative document, the labels for background characteristic variables are also added. <br/>val_lab(data$tot) = num_lab("<br/>1 |  " )</span><span id="1aa0" class="kd ke hh jz b fi kj kg l kh ki">val_lab(data$HH6) = num_lab("<br/>1 Urban<br/>2 Rural")</span><span id="3825" class="kd ke hh jz b fi kj kg l kh ki">val_lab(data$mdisability) = num_lab("<br/>1 Has functinal difficulty<br/>2 No funcitonal difficulty")</span><span id="112c" class="kd ke hh jz b fi kj kg l kh ki">val_lab(data$windex5) = num_lab("<br/>1 Poorest<br/>2 Second<br/>3 Middle<br/>4 Fourth<br/>5 Richest")</span><span id="4e82" class="kd ke hh jz b fi kj kg l kh ki">val_lab(data$religion) = num_lab("<br/>1 Free Wesleyan Church<br/>2 Latter Day Saints<br/>3 Roman Catholic<br/>4 Free Church of Tonga<br/>5 Other religion<br/>99 Don't know/missing")</span><span id="1ee4" class="kd ke hh jz b fi kj kg l kh ki">val_lab(data$ethnicity) = num_lab("<br/>1 Tongan<br/>2 Chinese <br/>3 Fijian<br/>4 Other ethnicity <br/>99 Don'tknow/missing")</span><span id="657a" class="kd ke hh jz b fi kj kg l kh ki">val_lab(data$HH7) = num_lab("<br/>1 Tongatapu<br/>2 Vava'u<br/>3 Ha'apai<br/>4 'Eua<br/>5 Ongo Niua")</span></pre><p id="0845" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">但是除了特定于语法的变量之外，还添加了一组变量名称和标签，因为这些是在SPSS的*sav文件中预定义的，但是也必须在R代码中引入。</p><p id="8fa5" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">现在，SPSS 中的<strong class="ig hi">制表语法非常简单明了，使用“ctables”函数绑定该语法中定义的列级变量(“literate”、“literateP”、“tot”、“mwelevel”和“numMen”)，并将其与预先定义的上述背景特征变量制成表格。语法如下所示:</strong></p><pre class="je jf jg jh fd jy jz ka kb aw kc bi"><span id="f60f" class="kd ke hh jz b fi kf kg l kh ki">ctables<br/>  /vlabels variables = layer mwelevel literate display = none<br/>  /table   total[c]<br/>         + hh6 [c]<br/>         + hh7 [c]<br/>         + $mage [c]<br/>         + mdisability [c]<br/>         + ethnicity [c]<br/>         + religion [c]<br/>         + windex5 [c]<br/>   by<br/>           layer [c] &gt; mwelevel [c] &gt; literate [c] [layerrowpct.validn '' f5.1] + tot [s] [mean '' f5.1] +<br/>           literateP [s] [mean '' f5.1]<br/>         + numMen[s][sum '' f5.0]<br/>  /categories variables=all empty=exclude missing=exclude<br/>  /slabels position=column visible = no<br/>  /titles title=<br/>    "Table SR.6.1M: Literacy (men)"<br/>    "Percent distribution of men age 15-49 years by highest level of school attended and literacy, and the total percentage literate, " + surveyname<br/>   caption =<br/>    "[1] MICS indicator SR.2 - Literacy rate (age 15-24 years)"<br/>    "[A] Respondents who have attended upper secondary school or higher are considered literate and are not tested."<br/>  .</span></pre><p id="8acb" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在R中，制表如下:</p><pre class="je jf jg jh fd jy jz ka kb aw kc bi"><span id="7f45" class="kd ke hh jz b fi kf kg l kh ki">```{r}<br/>expss_output_viewer() # function to see the table in the viewer in R studio<br/>data %&gt;%<br/>  tab_total_row_position("none")%&gt;% # suppresses the total values for each row. As SPSS syntax 'ctables' does not show totals, it is disabled in R code as well<br/>  tab_cells(tot, HH6, HH7, mdisability, ethnicity ,religion, windex5) %&gt;% #defines rows for the table<br/>  tab_cols(literate, mwelevel, tot) %&gt;% # defines columns to shoe percentage for with 'tab_stat_rpct'<br/>  tab_weight(weight = mnweight) %&gt;% #adds weights from the dataset<br/>  tab_stat_rpct(total_label = NULL,total_statistic = "w_cases",)%&gt;%<br/>  tab_cols(net(literateP, "Total percentage literate" = greater_or_equal(1), "TO_DELETE" = other))%&gt;% #defines mean for the additional column as a different calculation method, and marks a columnt to be deleted <br/>  tab_stat_rpct(total_label = NULL,total_statistic = "w_cases",)%&gt;%<br/>  tab_cols(total(numMen))%&gt;% # last column and different calculation method only to count total cases <br/>  tab_stat_cases()%&gt;%<br/>  tab_last_round(digits = get_expss_digits())%&gt;%<br/>  tab_pivot(stat_position = "outside_columns")%&gt;%<br/>  where(!grepl("TO_DELETE", row_labels)) %&gt;%<br/>   drop_empty_rows()%&gt;%<br/>  set_caption( "Table SR.6.1M: Literacy (men)<br/>               Percent distribution of men age 15-49 years by highest level of school attended and literacy, and the total percentage literate, " ) #adds caption on the top of the table</span></pre><p id="3e0f" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">R代码的最终输出是这样的html格式。可以对word进行进一步的定制。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es kk"><img src="../Images/cb8dcd0eb8443442ff6b02ccd725e277.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0Wi_y1oBIflP8N5lxS4K_g.jpeg"/></div></div></figure></div><div class="ab cl jp jq go jr" role="separator"><span class="js bw bk jt ju jv"/><span class="js bw bk jt ju jv"/><span class="js bw bk jt ju"/></div><div class="ha hb hc hd he"><p id="23e8" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">本练习的完整编织器文件也可在此处获得:</p><div class="kl km ez fb kn ko"><a href="http://rpubs.com/fmitrovi/805002" rel="noopener  ugc nofollow" target="_blank"><div class="kp ab dw"><div class="kq ab kr cl cj ks"><h2 class="bd hi fi z dy kt ea eb ku ed ef hg bi translated">RPubs</h2><div class="kv l"><h3 class="bd b fi z dy kt ea eb ku ed ef dx translated">SPSS to R——rpubs.com家庭调查语法</h3></div></div></div></a></div></div></div>    
</body>
</html>