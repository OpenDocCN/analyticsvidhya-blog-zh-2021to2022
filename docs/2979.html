<html>
<head>
<title>Data visualization and diagnosis of diabetes using logistic regression</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用逻辑回归的数据可视化和糖尿病诊断</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/data-visualization-and-diagnosis-of-diabetes-using-logistic-regression-1ea3958335a5?source=collection_archive---------4-----------------------#2021-05-28">https://medium.com/analytics-vidhya/data-visualization-and-diagnosis-of-diabetes-using-logistic-regression-1ea3958335a5?source=collection_archive---------4-----------------------#2021-05-28</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="32c0" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">先说数据。数据可以从<a class="ae jc" href="https://www.kaggle.com/uciml/pima-indians-diabetes-database" rel="noopener ugc nofollow" target="_blank"> Kaggle </a>数据库下载，前提是你有Kaggle账号。数据的目标是基于某些诊断方法预测潜在的糖尿病病例。所有被调查的对象都是至少21岁的皮马印第安血统的女性。</p><p id="c995" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">逻辑回归(LR)是分类中最重要的预测模型之一。简单来说，可以用逻辑回归对糖尿病的概率进行建模。逻辑回归的关键概念是logit，比值比的自然对数。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es jd"><img src="../Images/64cbd98ca30a2ca7784754950bcc12c1.png" data-original-src="https://miro.medium.com/v2/resize:fit:566/1*SfhtwKhCONUl0wz6kbVTlw.gif"/></div></figure><p id="720e" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在上式中，Pᵢ是患者I患糖尿病的概率。β是LR模型的系数，而x是数据样本I的特征</p><p id="6d16" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">对于这个二分法分类任务，我将使用R编程来加载数据，将其分为训练和测试数据集，使用训练数据集执行数据可视化和模型训练，并最终使用保留数据集评估模型。</p><p id="3ffc" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">首先，加载重要的库包。</p><pre class="je jf jg jh fd jl jm jn jo aw jp bi"><span id="17e7" class="jq jr hh jm b fi js jt l ju jv">library(cdata)    # data wrangling<br/>library(ggplot2)  # elegant plots<br/>library(knitr)    # display table <br/>library(reshape2) # data wrangling<br/>library(WVPlots)  # ROC plot, double density plot and etc</span></pre><p id="cdf1" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">接下来，将数据加载到工作环境中(记住使用语法<strong class="ig hi"> setwd() </strong>或按下<strong class="ig hi">‘Ctrl+Shift+H’</strong>)将工作目录设置为文件所在的位置)。查看每个特征及其变量类型的统计摘要(例如，连续型、布尔型、分类型)。总共有768个样本(受试者)和9个变量(8个属性和一个目标)。</p><pre class="je jf jg jh fd jl jm jn jo aw jp bi"><span id="de2a" class="jq jr hh jm b fi js jt l ju jv">data=read.csv(‘diabetes.csv’)<br/>summary(data)<br/>str(data)</span></pre><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jx jy di jz bf ka"><div class="er es jw"><img src="../Images/52abc74c21693d5f788f100e5802b285.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*z0T50AsZ8R1YL1hllhTRIg.png"/></div></div><figcaption class="kb kc et er es kd ke bd b be z dx translated">语法summary()和str()的输出。</figcaption></figure><p id="4358" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">从结果中，我们可以大致了解每个变量的分布情况。例如，受试者的年龄范围从21岁到81岁，其中一半是29岁或以下；胰岛素是正偏态的，如其平均值和中位数之间的巨大差异所示。</p><p id="28ab" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">下面的代码片段显示了数据中阳性病例(糖尿病)的数量与阴性病例的数量。该数据包括268个阳性病例，而其余500个为阴性病例。</p><pre class="je jf jg jh fd jl jm jn jo aw jp bi"><span id="cbb7" class="jq jr hh jm b fi js jt l ju jv">data$Outcome=as.factor(data$Outcome)<br/>summary(data$Outcome)</span></pre><p id="1d95" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">接下来，将数据划分为训练集和保留集。训练集用于LR模型的数据可视化和训练，而保留集(测试数据)仅用于评估模型性能。</p><pre class="je jf jg jh fd jl jm jn jo aw jp bi"><span id="cbca" class="jq jr hh jm b fi js jt l ju jv"># for reproducibility<br/>set.seed(123)<br/>randn=runif(nrow(data))<br/>train_idx=randn&lt;=0.8  # Roughly 80% training data, 20% test data<br/>train=data[train_idx,]<br/>test=data[!train_idx,]</span></pre><h1 id="61f6" class="kf jr hh bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb bi translated"><strong class="ak">数据可视化</strong></h1><p id="8291" class="pw-post-body-paragraph ie if hh ig b ih lc ij ik il ld in io ip le ir is it lf iv iw ix lg iz ja jb ha bi translated">数据可视化是以图形格式呈现数据。它不仅直观，而且有助于探索数据结构和检测异常值。值得注意的是，我们应该只在模型评估阶段使用测试数据。</p><pre class="je jf jg jh fd jl jm jn jo aw jp bi"><span id="9c35" class="jq jr hh jm b fi js jt l ju jv">target=’Outcome’<br/>vars=setdiff(colnames(train),target)</span><span id="3b8a" class="jq jr hh jm b fi lh jt l ju jv"># moving data from wide to tall form (be careful with the #indentation<br/>data_long=unpivot_to_blocks(data,nameForNewKeyColumn = “variables”,<br/> nameForNewValueColumn = “values”,columnsToTakeFrom = vars)</span><span id="2a15" class="jq jr hh jm b fi lh jt l ju jv"># plot the histogram<br/>ggplot(data_long,aes(x=values)) + <br/> geom_histogram(bins=10,fill=”gray”) +<br/> facet_wrap(~variables,ncol = 3,scales=”free”)</span></pre><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jx jy di jz bf ka"><div class="er es li"><img src="../Images/b0286de3909b58955cd09092eaa9e1c4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0QNERSP6JLh9y3tgln-w6A.png"/></div></div></figure><p id="eeac" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">分组箱线图是另一个优秀的可视化工具，可以显示每个类的变量分布。</p><pre class="je jf jg jh fd jl jm jn jo aw jp bi"><span id="2e1b" class="jq jr hh jm b fi js jt l ju jv"># boxplot for each variables with regards to group<br/>ggplot(data_long,aes(x=Outcome,y=values)) +<br/> geom_boxplot(color=”blue”,fill=”blue”,alpha=0.2,notch=TRUE,<br/> outlier.color=”red”,outlier.fill = “red”,outlier.size = 2) +<br/> facet_wrap(~variables,ncol = 3,scales = “free”)</span></pre><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jx jy di jz bf ka"><div class="er es li"><img src="../Images/c73813941cfb27960abf72ca898bd3bb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-Z9vy3LYKBUy2mRwAU86MQ.png"/></div></div></figure><p id="ad3a" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">从上面的箱线图可以明显看出，在诊断为糖尿病的患者中，可变“葡萄糖”通常较高，因为两个等级的界限不重叠。然而，重要的是要注意异常值的存在。同样的情况在年龄、怀孕和身体质量指数预测中也很明显。</p><p id="5321" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">相关矩阵也有助于揭示两个变量之间的(线性)关系，如下图所示。年龄与妊娠次数呈正相关，Pearson相关系数为0.57。</p><pre class="je jf jg jh fd jl jm jn jo aw jp bi"><span id="783b" class="jq jr hh jm b fi js jt l ju jv">cormat=cor(train[,vars]) # correlation matrix</span><span id="fe1a" class="jq jr hh jm b fi lh jt l ju jv">cormat[upper.tri(cormat)]=NA <br/>melted_cormat=melt(cormat,na.rm = TRUE)<br/># heat-map<br/>ggplot(data=melted_cormat,aes(Var1,Var2,fill=value)) +<br/> geom_tile(color=’white’) +<br/> scale_fill_gradient2(low = “blue”, high=”red”,mid=”white”,midpoint = 0,<br/> limit=c(-1,1),space = “Lab”,name=”Correlation”) +<br/> theme_minimal()+<br/> theme(axis.text.x = element_text(angle = 45,vjust = 1,size = 12,hjust = 1)) +<br/> coord_fixed() +<br/> geom_text(aes(Var1,Var2,label=round(value,2)),color=”black”,size=3)</span></pre><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jx jy di jz bf ka"><div class="er es li"><img src="../Images/bd5d422d20d7ad7f12d2e18346920c26.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hY-8Cko8FV0k5KqeMZqVRQ.png"/></div></div></figure><pre class="je jf jg jh fd jl jm jn jo aw jp bi"><span id="f763" class="jq jr hh jm b fi js jt l ju jv"># plot grouped scatter plot<br/># Create the plots<br/>pairs(data[,vars], pch=20,cex=0.3,col=data$Outcome, <br/> lower.panel = NULL)</span></pre><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jx jy di jz bf ka"><div class="er es li"><img src="../Images/a336debacb329ed6542209a5eac91702.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FVnX5_BBaZa76upDdKFJ1Q.png"/></div></div></figure><p id="652b" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">上面的组散点图矩阵表明，在每个散点图中没有可辨别的决策边界来区分这两个类别。</p><h1 id="a213" class="kf jr hh bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb bi translated">逻辑回归</h1><p id="1f85" class="pw-post-body-paragraph ie if hh ig b ih lc ij ik il ld in io ip le ir is it lf iv iw ix lg iz ja jb ha bi translated">LR模型的训练可以通过设置自变量用语法glm()实现:<em class="lj"> family=binomial("logit") </em>。逻辑回归假设独立变量和对数优势之间呈线性关系。尽管有这个理论上的限制，参数模型的系数可以提供关于个体属性和阳性结果(糖尿病)的优势/概率之间关系的线索。</p><pre class="je jf jg jh fd jl jm jn jo aw jp bi"><span id="2c08" class="jq jr hh jm b fi js jt l ju jv">model=glm(Outcome~.,data=train,family = binomial(“logit”))<br/>summary(model)</span></pre><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es lk"><img src="../Images/d1e173eb2c933464709f9c48f2acfe72.png" data-original-src="https://miro.medium.com/v2/resize:fit:1386/format:webp/1*mjwzErjVgkRYajpf8TTqnw.png"/></div></figure><p id="0ae7" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">除了“皮肤厚度”和“胰岛素”之外，大多数系数都具有统计学意义。我们如何解释模型的系数？让我们以“身体质量指数”为例。系数估计值0.095表明，如果身体质量指数增加1个单位，对数优势将增加9.5%。那么，如果我们想知道概率呢？假设一个人被诊断为糖尿病的概率为0.25，如果身体质量指数增加1，而其他变量保持不变，那么被诊断为糖尿病的概率会发生什么变化？让我们算一算。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jx jy di jz bf ka"><div class="er es ll"><img src="../Images/8fe2ecae9eef0c69ca1bcf343dabe1dc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uVqNRruogLY-jnBQyCYtoA.png"/></div></div></figure><p id="baa0" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">因此，身体质量指数增加一个会将糖尿病发病的概率从0.25提高到0.2682。同样的计算也适用于其他变量。尽管解释不像线性回归那样直接，但它使我们能够深入了解每个预测因子对反应的贡献。</p><h1 id="5764" class="kf jr hh bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb bi translated"><strong class="ak">车型评测</strong></h1><p id="ae91" class="pw-post-body-paragraph ie if hh ig b ih lc ij ik il ld in io ip le ir is it lf iv iw ix lg iz ja jb ha bi translated">通过准确度、精确度和召回率(灵敏度)来评估先前未见过的数据(保留数据集)上的模型泛化性能。</p><pre class="je jf jg jh fd jl jm jn jo aw jp bi"><span id="4bd7" class="jq jr hh jm b fi js jt l ju jv"># prediction<br/>train$pred=predict(model,newdata = train,type = “response”)<br/>test$pred=predict(model,newdata=test,type=”response”)</span><span id="89c1" class="jq jr hh jm b fi lh jt l ju jv"># confusion matrix<br/>(confmat_test=table(truth=test$Outcome,predict=test$pred&gt;0.5))<br/>(acc_test=sum(diag(confmat_test))/sum(confmat_test))<br/>(precision=confmat_test[2,2]/sum(confmat_test[,2]))<br/>(recall=confmat_test[2,2]/sum(confmat_test[2,]))</span></pre><p id="19f6" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">使用测试数据评估模型的性能:<strong class="ig hi">准确度:0.7355，精确度:0.7083，召回率:0.5574 </strong>。此外，模型性能可以通过接收器工作特性(ROC)曲线和双密度图进行可视化，如下面的代码片段和图形输出所示。</p><pre class="je jf jg jh fd jl jm jn jo aw jp bi"><span id="2f5b" class="jq jr hh jm b fi js jt l ju jv">plt=DoubleDensityPlot(test,xvar = “pred”,truthVar = “Outcome”,<br/> title = “Distribution of scores of LR model in test data”)<br/>plt+geom_vline(xintercept = 0.5, color=”red”,linetype=2)</span></pre><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jx jy di jz bf ka"><div class="er es li"><img src="../Images/c7c75a8a85d1015cde10b94711ad21b1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*iCWKFcyNdHBOH0U_Xs7XQw.png"/></div></div></figure><pre class="je jf jg jh fd jl jm jn jo aw jp bi"><span id="44ab" class="jq jr hh jm b fi js jt l ju jv">test$Outcome_numeric=as.numeric(test$Outcome)-1<br/>ROCPlot(test,xvar=’pred’,truthVar = “Outcome_numeric”,<br/> truthTarget = TRUE,<br/> title = “Logistic regression test performance”)</span></pre><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jx jy di jz bf ka"><div class="er es li"><img src="../Images/ef124efff1900d89fa24e6ddb1d11b85.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zXpnLsQNCQuBt598-xsPEw.png"/></div></div></figure><h1 id="aeee" class="kf jr hh bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb bi translated"><strong class="ak">微调</strong></h1><p id="d007" class="pw-post-body-paragraph ie if hh ig b ih lc ij ik il ld in io ip le ir is it lf iv iw ix lg iz ja jb ha bi translated">必须确定分数(模型输出)的特定阈值，以将结果(糖尿病或非糖尿病)二进制化。虽然缺省值通常设置为0.5，但是可以改变阈值来优化精确度和召回率之间的折衷。显示作为阈值函数的丰富和回忆的图形有助于选择合适的阈值。关于如何选择阈值的更多细节，请参考本<a class="ae jc" href="https://livebook.manning.com/book/practical-data-science-with-r-second-edition/welcome/v-6/" rel="noopener ugc nofollow" target="_blank">电子书</a>。经验观察表明，0.375可以是一个好的阈值。注意，我们应该始终使用训练数据而不是测试数据，以防止<a class="ae jc" href="https://machinelearningmastery.com/data-leakage-machine-learning/" rel="noopener ugc nofollow" target="_blank">数据泄露</a>。</p><pre class="je jf jg jh fd jl jm jn jo aw jp bi"><span id="7f30" class="jq jr hh jm b fi js jt l ju jv">train$Outcome_numeric=as.numeric(train$Outcome)-1<br/>plt=PRTPlot(test,’pred’,’Outcome_numeric’,TRUE,<br/> plotvars = c(‘enrichment’,’recall’),<br/> thresholdrange = c(0,1),<br/> title = ‘Enrichment/recall vs threshold for LR model’)<br/>plt+geom_vline(xintercept = 0.375,color=”red”,linetype=2)</span></pre><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jx jy di jz bf ka"><div class="er es li"><img src="../Images/f71edbca00609c243de473a1a5b315a6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kw9Egewz6rh18n9276PoWw.png"/></div></div></figure><pre class="je jf jg jh fd jl jm jn jo aw jp bi"><span id="26f0" class="jq jr hh jm b fi js jt l ju jv"># Confusion matrix of test data<br/>(confmat_test=table(truth=test$Outcome,predict=test$pred&gt;0.375))<br/>(acc_test=sum(diag(confmat_test))/sum(confmat_test))<br/>(precision=confmat_test[2,2]/sum(confmat_test[,2]))<br/>(recall=confmat_test[2,2]/sum(confmat_test[2,]))</span></pre><p id="991f" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这个新的阈值在准确度和召回率方面给了我们更好的概括性能，但是在准确度方面略有下降:准确度:0.7548，准确度:0.6825，召回率:0.7049。但是，应该注意的是，如果该模型应用于分布与其训练数据非常不同的未来数据，则该模型将表现不佳。</p><p id="1c0b" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">对于二元分类问题，LR模型是一种可解释的、强有力的预测模型。机器学习从业者应该在应用更高级的预测模型之前，始终选择像逻辑回归这样的简单模型。以上代码可以在<a class="ae jc" href="https://github.com/Jacky-lim-data-analyst/programmer.git" rel="noopener ugc nofollow" target="_blank"> Github </a>和<a class="ae jc" href="https://rpubs.com/JQ_programmer_92/775059" rel="noopener ugc nofollow" target="_blank"> RPubs </a>中找到。</p></div></div>    
</body>
</html>