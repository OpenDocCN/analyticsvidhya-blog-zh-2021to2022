<html>
<head>
<title>Well done @ Nginx Unit</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Nginx单位做得好</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/well-done-nginx-unit-a70960de68b7?source=collection_archive---------1-----------------------#2021-05-26">https://medium.com/analytics-vidhya/well-done-nginx-unit-a70960de68b7?source=collection_archive---------1-----------------------#2021-05-26</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/6fa87068be8f78b3fc0a82d8d42bfbba.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*bYH9OtfLUmeh928v"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">泰勒·尼克斯在Unsplash<a class="ae iu" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">拍摄的照片</a></figcaption></figure><p id="725a" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">你好<coders>,</coders></p><p id="1070" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">On my programming journey, I always felt that server configuration for an application was taking more time than expected. Sometimes, I would be entering into a recursive mode of executing a single command and updating the .conf file (when the configuration server goes wrong) 😿,.</p><pre class="jt ju jv jw fd jx jy jz ka aw kb bi"><span id="59b7" class="kc kd hi jy b fi ke kf l kg kh">while server.conf != right:</span><span id="8fe0" class="kc kd hi jy b fi ki kf l kg kh">   vim edit server.conf</span><span id="cf9d" class="kc kd hi jy b fi ki kf l kg kh">   sudo services server_name restart</span></pre><p id="95c5" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">A few days back, I got the chance to explore nginx unit and its features. I felt very excited that the configuration of the webserver can be handled in a <strong class="ix hj">single JSON file</strong>, supporting dynamic web applications elegantly, and <em class="kj">restarting the server not needed</em> 👏👏. Config file added below for quick insights,</p><figure class="jt ju jv jw fd ij"><div class="bz dy l di"><div class="kk kl l"/></div></figure><blockquote class="km kn ko"><p id="03c3" class="iv iw kj ix b iy iz ja jb jc jd je jf kp jh ji jj kq jl jm jn kr jp jq jr js hb bi translated">Nginx unit, is to reduce the operational complexity by providing single middleware to supporting multiple applications and update on fly without dropping connection.</p></blockquote><h2 id="49d3" class="kc kd hi bd ks kt ku kv kw kx ky kz la jg lb lc ld jk le lf lg jo lh li lj lk bi translated">Architecture:</h2><p id="562d" class="pw-post-body-paragraph iv iw hi ix b iy ll ja jb jc lm je jf jg ln ji jj jk lo jm jn jo lp jq jr js hb bi translated">Nginx-unit, architecture broken into three layers,</p><ol class=""><li id="d1cd" class="lq lr hi ix b iy iz jc jd jg ls jk lt jo lu js lv lw lx ly bi translated">Controller process</li><li id="15cd" class="lq lr hi ix b iy lz jc ma jg mb jk mc jo md js lv lw lx ly bi translated">Router Process</li><li id="c78b" class="lq lr hi ix b iy lz jc ma jg mb jk mc jo md js lv lw lx ly bi translated">Application Process</li></ol><figure class="jt ju jv jw fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es me"><img src="../Images/74ac301944608976d782c0994734e4a6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qwxfOjZJwIozRf3dxZ-FKg.png"/></div></div></figure><h2 id="df58" class="kc kd hi bd ks kt ku kv kw kx ky kz la jg lb lc ld jk le lf lg jo lh li lj lk bi translated">Controller process:</h2><ul class=""><li id="4f29" class="lq lr hi ix b iy ll jc lm jg mf jk mg jo mh js mi lw lx ly bi translated">manages the configuration of the application(`config.json`) and router process.</li><li id="a198" class="lq lr hi ix b iy lz jc ma jg mb jk mc jo md js mi lw lx ly bi translated">the process can be interacted/reconfiguration of application and router process via an API interface.</li><li id="94c9" class="lq lr hi ix b iy lz jc ma jg mb jk mc jo md js mi lw lx ly bi translated">reference: <a class="ae iu" href="https://unit.nginx.org/configuration/#configuration-management" rel="noopener ugc nofollow" target="_blank"><strong class="ix hj"><em class="kj">link</em></strong></a></li></ul><pre class="jt ju jv jw fd jx jy jz ka aw kb bi"><span id="f8bc" class="kc kd hi jy b fi ke kf l kg kh">sudo curl --unix-socket /path/to/control.unit.sock <a class="ae iu" href="http://localhost/config/" rel="noopener ugc nofollow" target="_blank">http://localhost/config/</a></span><span id="0907" class="kc kd hi jy b fi ki kf l kg kh">{<br/>        "listeners": {<br/>            "127.0.0.1:8300": {<br/>                "pass": "applications/blogs"<br/>            }<br/>        },<br/><br/>        "applications": {<br/>            "blogs": {<br/>                "type": "php",<br/>                "root": "/www/blogs/scripts/"<br/>            }<br/>        }<br/>    }</span></pre><h2 id="1908" class="kc kd hi bd ks kt ku kv kw kx ky kz la jg lb lc ld jk le lf lg jo lh li lj lk bi translated">Router process:</h2><ul class=""><li id="8e53" class="lq lr hi ix b iy ll jc lm jg mf jk mg jo mh js mi lw lx ly bi translated">router process, will accept the incoming requests from the client, transfer to the application process and send back the application response to the client.</li><li id="f625" class="lq lr hi ix b iy lz jc ma jg mb jk mc jo md js mi lw lx ly bi translated">if the configuration is updated, the router process will start a new worker with the latest configuration and handle new request connection(s).</li><li id="ad25" class="lq lr hi ix b iy lz jc ma jg mb jk mc jo md js mi lw lx ly bi translated">though configuration changed, router worker threads can serve the request without reloading the server.</li></ul><h2 id="5a76" class="kc kd hi bd ks kt ku kv kw kx ky kz la jg lb lc ld jk le lf lg jo lh li lj lk bi translated">Application process:</h2><ul class=""><li id="bb31" class="lq lr hi ix b iy ll jc lm jg mf jk mg jo mh js mi lw lx ly bi translated">each application is served by Unit is run by an isolated process or set of process.</li><li id="f2cc" class="lq lr hi ix b iy lz jc ma jg mb jk mc jo md js mi lw lx ly bi translated">the application process will be started by demand, create a new fork.</li><li id="1be4" class="lq lr hi ix b iy lz jc ma jg mb jk mc jo md js mi lw lx ly bi translated">the router and application process will communicate via socket pairs and shared memory segments.</li></ul><h2 id="04f4" class="kc kd hi bd ks kt ku kv kw kx ky kz la jg lb lc ld jk le lf lg jo lh li lj lk bi translated">Installation:</h2><pre class="jt ju jv jw fd jx jy jz ka aw kb bi"><span id="fea9" class="kc kd hi jy b fi ke kf l kg kh">brew install nginx/unit/unit</span><span id="7c3a" class="kc kd hi jy b fi ki kf l kg kh"># To install the Java, Perl, Python, and Ruby language modules</span><span id="0771" class="kc kd hi jy b fi ki kf l kg kh">brew install unit-java unit-perl unit-python unit-python3 unit-ruby</span></pre><p id="6efc" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">I have provided installation steps for mac environment, for other environments and languages follow the Nginx unit official <a class="ae iu" href="https://unit.nginx.org/installation/" rel="noopener ugc nofollow" target="_blank"><strong class="ix hj"><em class="kj">docs</em></strong></a>.</p><h2 id="b6ff" class="kc kd hi bd ks kt ku kv kw kx ky kz la jg lb lc ld jk le lf lg jo lh li lj lk bi translated">Configuration (<a class="ae iu" href="https://unit.nginx.org/configuration/#matching-conditions" rel="noopener ugc nofollow" target="_blank">link</a>)</h2><p id="8389" class="pw-post-body-paragraph iv iw hi ix b iy ll ja jb jc lm je jf jg ln ji jj jk lo jm jn jo lp jq jr js hb bi translated"><strong class="ix hj">Listener</strong></p><ul class=""><li id="52ef" class="lq lr hi ix b iy iz jc jd jg ls jk lt jo lu js mi lw lx ly bi translated">To start accepting requests, add a listener object in the <code class="du mj mk ml jy b">config/listeners</code> API部分。</li><li id="ece4" class="lq lr hi ix b iy lz jc ma jg mb jk mc jo md js mi lw lx ly bi translated">单元将收到的请求发送到侦听器引用的目的地。</li><li id="52b8" class="lq lr hi ix b iy lz jc ma jg mb jk mc jo md js mi lw lx ly bi translated">监听器的模式将是<code class="du mj mk ml jy b">host_addr:port_no</code>并与应用程序对象映射。</li></ul><pre class="jt ju jv jw fd jx jy jz ka aw kb bi"><span id="9001" class="kc kd hi jy b fi ke kf l kg kh">"listeners": {</span><span id="4530" class="kc kd hi jy b fi ki kf l kg kh">      "*:8080": {</span><span id="3a7e" class="kc kd hi jy b fi ki kf l kg kh">          "pass": "applications/flask"</span><span id="cf29" class="kc kd hi jy b fi ki kf l kg kh">      },<br/>      "*:8090": {</span><span id="3772" class="kc kd hi jy b fi ki kf l kg kh">          "pass": "applications/django"<br/>     },</span><span id="2e88" class="kc kd hi jy b fi ki kf l kg kh">}</span></pre><p id="7fbf" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">路由对象</strong></p><ul class=""><li id="afa5" class="lq lr hi ix b iy iz jc jd jg ls jk lt jo lu js mi lw lx ly bi translated">路由对象用于过滤/处理监听器和应用程序之间的内部请求。</li><li id="c98c" class="lq lr hi ix b iy lz jc ma jg mb jk mc jo md js mi lw lx ly bi translated">路线步骤的数组用作<strong class="ix hj">路线</strong>属性的值，</li></ul><pre class="jt ju jv jw fd jx jy jz ka aw kb bi"><span id="3fa3" class="kc kd hi jy b fi ke kf l kg kh">{<br/>  "listeners": {<br/>    "*:8080": {<br/>      "pass": "<strong class="jy hj">routes</strong>"<br/>    },<br/>    "<strong class="jy hj">routes</strong>": [<br/><em class="kj">      {<br/>        "</em><strong class="jy hj"><em class="kj">match</em></strong><em class="kj">": {<br/>          "uri": [<br/>            "!pattern1",<br/>            "!pattern2",<br/>            "pattern3"<br/>          ]<br/>        },<br/>        "</em><strong class="jy hj"><em class="kj">action</em></strong><em class="kj">": {<br/>          "pass": "..."<br/>        }<br/>      }</em><br/>    ]<br/>  }<br/>}</span></pre><ul class=""><li id="f21a" class="lq lr hi ix b iy iz jc jd jg ls jk lt jo lu js mi lw lx ly bi translated">如果一个请求匹配路由步骤的所有条件，那么监听器中带有<code class="du mj mk ml jy b">pass </code>的动作部分与<code class="du mj mk ml jy b">pass</code>相同。</li></ul><p id="7fe6" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">代理</strong></p><ul class=""><li id="e012" class="lq lr hi ix b iy iz jc jd jg ls jk lt jo lu js mi lw lx ly bi translated">将该单元处理的请求代理给另一个HTTP服务。</li></ul><pre class="jt ju jv jw fd jx jy jz ka aw kb bi"><span id="96b6" class="kc kd hi jy b fi ke kf l kg kh">{<br/>  "routes": [<br/>    {<br/>      "match": {<br/>        "uri": "/ipv4/*"<br/>      },<br/>      "action": {<br/>        "proxy": "<a class="ae iu" href="http://127.0.0.1:8080" rel="noopener ugc nofollow" target="_blank">http://127.0.0.1:5000</a>"<br/>      }<br/>    }<br/>  ]<br/>}</span></pre><p id="19c7" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">静态文件</strong></p><ul class=""><li id="ba44" class="lq lr hi ix b iy iz jc jd jg ls jk lt jo lu js mi lw lx ly bi translated">单元能够作为一个独立的web服务器，从您配置的目录中为静态资产的请求提供服务；要使用该功能，在<a class="ae iu" href="https://unit.nginx.org/configuration/#configuration-routes" rel="noopener ugc nofollow" target="_blank">路线</a>步骤的<code class="du mj mk ml jy b">share</code>选项中提供目录路径。</li></ul><pre class="jt ju jv jw fd jx jy jz ka aw kb bi"><span id="dfd4" class="kc kd hi jy b fi ke kf l kg kh">{<br/>  "listeners": {<br/>    "127.0.0.1:8300": {<br/>      "pass": "routes"<br/>    }<br/>  },<br/>  "routes": [<br/>    {<br/>      "action": {<br/>        "share": "/www/data/static/",<br/>        "fallback": {<br/>          "pass": "/var/app/static/"<br/>        }<br/>      }<br/>    }<br/>  ]<br/>}</span></pre><ul class=""><li id="8b50" class="lq lr hi ix b iy iz jc jd jg ls jk lt jo lu js mi lw lx ly bi translated">单元具有<code class="du mj mk ml jy b">fallback</code>，该属性将有助于从备用位置提供文件(如果在<code class="du mj mk ml jy b">share</code>中提到的位置没有找到静态文件)。</li></ul><p id="aaec" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">提到的配置通常用于所有应用程序，其他配置如限制、用户和组权限请参考本<a class="ae iu" href="https://unit.nginx.org/configuration/#" rel="noopener ugc nofollow" target="_blank">文档</a>。</p><p id="fed4" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">启动和关闭命令</strong></p><pre class="jt ju jv jw fd jx jy jz ka aw kb bi"><span id="3345" class="kc kd hi jy b fi ke kf l kg kh">sudo /etc/init.d/unitd start</span><span id="614e" class="kc kd hi jy b fi ki kf l kg kh">sudo /etc/init.d/unitd stop</span></pre><p id="7a43" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">样本代码</strong></p><p id="2874" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我已经用Nginx单元配置和flask应用程序创建了样例repo。使用apache bench工具，加载<em class="kj"> Nginx单元+flask</em><strong class="ix hj">(VS)</strong><em class="kj">uw SGI+flask</em>应用程序的性能报告。</p><p id="861d" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">链接:<a class="ae iu" href="https://github.com/ibrahimsha23/nginx_performance" rel="noopener ugc nofollow" target="_blank">https://github.com/ibrahimsha23/nginx_performance</a></p><p id="7304" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj"> <em class="kj">感谢阅读！</em> </strong></p><p id="ece5" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">请在评论中分享你的建议。非常感谢大家的反馈和掌声。</p><p id="ffd5" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">要联系我，请在LinkedIn<a class="ae iu" href="https://www.linkedin.com/in/ibrahimshak/" rel="noopener ugc nofollow" target="_blank">上联系我</a>。</p></div></div>    
</body>
</html>