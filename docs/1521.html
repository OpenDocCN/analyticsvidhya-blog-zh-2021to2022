<html>
<head>
<title>Configure Azure Data bricks to send events to Application insights — Simplified</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">配置Azure数据块以向应用洞察发送事件—简化</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/configure-azure-data-bricks-to-send-events-to-application-insights-simplified-c6effbc3ed6a?source=collection_archive---------4-----------------------#2021-03-06">https://medium.com/analytics-vidhya/configure-azure-data-bricks-to-send-events-to-application-insights-simplified-c6effbc3ed6a?source=collection_archive---------4-----------------------#2021-03-06</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><h1 id="868e" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">在Azure数据块中配置日志分析和应用洞察</h1><h1 id="e8a3" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">用例</h1><ul class=""><li id="1d12" class="jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju bi translated">Azure data bricks与Azure monitor进行了本机集成</li><li id="4727" class="jd je hi jf b jg jv ji jw jk jx jm jy jo jz jq jr js jt ju bi translated">但是挑战在于得到运行时错误</li><li id="e70a" class="jd je hi jf b jg jv ji jw jk jx jm jy jo jz jq jr js jt ju bi translated">能够发送自定义日志或事件的应用程序代码</li><li id="30f8" class="jd je hi jf b jg jv ji jw jk jx jm jy jo jz jq jr js jt ju bi translated">记录运行时异常的跟踪日志</li><li id="0bd3" class="jd je hi jf b jg jv ji jw jk jx jm jy jo jz jq jr js jt ju bi translated">帮助解决运行时的用法错误</li></ul><h1 id="95a1" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">先决条件</h1><ul class=""><li id="6563" class="jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju bi translated">Azure帐户</li><li id="4dae" class="jd je hi jf b jg jv ji jw jk jx jm jy jo jz jq jr js jt ju bi translated">Azure数据块</li><li id="3d70" class="jd je hi jf b jg jv ji jw jk jx jm jy jo jz jq jr js jt ju bi translated">Azure应用洞察</li><li id="7101" class="jd je hi jf b jg jv ji jw jk jx jm jy jo jz jq jr js jt ju bi translated">创建日志分析</li><li id="1efa" class="jd je hi jf b jg jv ji jw jk jx jm jy jo jz jq jr js jt ju bi translated">获取工作区ID和密钥</li><li id="47d5" class="jd je hi jf b jg jv ji jw jk jx jm jy jo jz jq jr js jt ju bi translated">获取应用洞察密钥</li><li id="3c3f" class="jd je hi jf b jg jv ji jw jk jx jm jy jo jz jq jr js jt ju bi translated">从这个github Repo中获取内容:<a class="ae ka" href="https://github.com/AnalyticJeremy/Azure-Databricks-Monitoring" rel="noopener ugc nofollow" target="_blank">https://github . com/analytic Jeremy/Azure-data bricks-Monitoring</a></li><li id="36fa" class="jd je hi jf b jg jv ji jw jk jx jm jy jo jz jq jr js jt ju bi translated">我还下载了jar文件和脚本</li><li id="7059" class="jd je hi jf b jg jv ji jw jk jx jm jy jo jz jq jr js jt ju bi translated">文件可在回购中获得</li></ul><h1 id="5d22" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">密码</h1><ul class=""><li id="62b4" class="jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju bi translated">首先用databricks运行时版本7.5创建另一个集群</li><li id="7a0a" class="jd je hi jf b jg jv ji jw jk jx jm jy jo jz jq jr js jt ju bi translated">该集群用于创建shell脚本，而不是使用命令行上传。</li><li id="12db" class="jd je hi jf b jg jv ji jw jk jx jm jy jo jz jq jr js jt ju bi translated">不需要库</li><li id="0c6e" class="jd je hi jf b jg jv ji jw jk jx jm jy jo jz jq jr js jt ju bi translated">创建一个新的scala笔记本来创建app insight init脚本</li><li id="0630" class="jd je hi jf b jg jv ji jw jk jx jm jy jo jz jq jr js jt ju bi translated">检查Stage_dir目录</li><li id="1b85" class="jd je hi jf b jg jv ji jw jk jx jm jy jo jz jq jr js jt ju bi translated">获取工作区ID和密钥</li><li id="3cf4" class="jd je hi jf b jg jv ji jw jk jx jm jy jo jz jq jr js jt ju bi translated">转到日志分析工作区</li><li id="bf8b" class="jd je hi jf b jg jv ji jw jk jx jm jy jo jz jq jr js jt ju bi translated">选择高级设置-&gt;连接的源-&gt;代理管理</li><li id="abfd" class="jd je hi jf b jg jv ji jw jk jx jm jy jo jz jq jr js jt ju bi translated">复制ID和密钥</li><li id="6cb5" class="jd je hi jf b jg jv ji jw jk jx jm jy jo jz jq jr js jt ju bi translated">要获取应用洞察工具密钥，请访问应用洞察资源</li><li id="4cb1" class="jd je hi jf b jg jv ji jw jk jx jm jy jo jz jq jr js jt ju bi translated">向下滚动到属性</li><li id="9a2f" class="jd je hi jf b jg jv ji jw jk jx jm jy jo jz jq jr js jt ju bi translated">复制检测密钥</li><li id="2b77" class="jd je hi jf b jg jv ji jw jk jx jm jy jo jz jq jr js jt ju bi translated">对于scipt，请确保目录和格式匹配</li><li id="cde4" class="jd je hi jf b jg jv ji jw jk jx jm jy jo jz jq jr js jt ju bi translated">语法问题的微小变化可能会导致集群无法启动</li><li id="1881" class="jd je hi jf b jg jv ji jw jk jx jm jy jo jz jq jr js jt ju bi translated">替换脚本下面的密钥和ID</li></ul><pre class="kb kc kd ke fd kf kg kh ki aw kj bi"><span id="b985" class="kk ig hi kg b fi kl km l kn ko">APPINSIGHTS_INSTRUMENTATIONKEY="xxxxxx-xxxxxxx-xxxxxxx" LOG_ANALYTICS_WORKSPACE_ID="xxxxxx-xxxxxxx-xxxxxxx" LOG_ANALYTICS_PRIMARY_KEY="xxxxxx-xxxxxxx-xxxxxxx"</span><span id="6976" class="kk ig hi kg b fi kp km l kn ko">%python<br/>dbutils.fs.put("dbfs:/appinsights/appinsights_logging_init.sh","""<br/>#!/bin/bash<br/><br/>STAGE_DIR="/dbfs/appinsights/"<br/>APPINSIGHTS_INSTRUMENTATIONKEY="xxxxxx-xxxxxxx-xxxxxxx"<br/>LOG_ANALYTICS_WORKSPACE_ID="xxxxxx-xxxxxxx-xxxxxxx"<br/>LOG_ANALYTICS_PRIMARY_KEY="xxxxxx-xxxxxxx-xxxxxxx"<br/><br/>echo "BEGIN: Upload App Insights JARs"<br/>cp -f $STAGE_DIR/applicationinsights-core-*.jar /mnt/driver-daemon/jars || { echo "Error copying AppInsights core library file"; exit 1;}<br/>cp -f $STAGE_DIR/applicationinsights-logging-log4j1_2-*.jar /mnt/driver-daemon/jars || { echo "Error copying AppInsights Log4J library file"; exit 1;}<br/>echo "END: Upload App Insights JARs"<br/><br/>echo "BEGIN: Upload Spark Listener JARs"<br/>cp -f $STAGE_DIR/adbxmonitor_*.jar /mnt/driver-daemon/jars || { echo "Error copying Spark Listener library file"; exit 1;}<br/>echo "END: Upload Spark Listener JARs"<br/><br/>echo "BEGIN: Setting Environment variables"<br/>sudo echo APPINSIGHTS_INSTRUMENTATIONKEY=$APPINSIGHTS_INSTRUMENTATIONKEY &gt;&gt; /etc/environment<br/>echo "END: Setting Environment variables"<br/><br/>echo "BEGIN: Updating Executor log4j properties file"<br/>sed -i 's/log4j.rootCategory=INFO, console/log4j.rootCategory=INFO, console, aiAppender/g' /home/ubuntu/databricks/spark/dbconf/log4j/executor/log4j.properties<br/>echo "log4j.appender.aiAppender=com.microsoft.applicationinsights.log4j.v1_2.ApplicationInsightsAppender" &gt;&gt; /home/ubuntu/databricks/spark/dbconf/log4j/executor/log4j.properties<br/># echo "log4j.appender.aiAppender.DatePattern='.'yyyy-MM-dd" &gt;&gt; /home/ubuntu/databricks/spark/dbconf/log4j/executor/log4j.properties<br/>echo "log4j.appender.aiAppender.layout=org.apache.log4j.PatternLayout" &gt;&gt; /home/ubuntu/databricks/spark/dbconf/log4j/executor/log4j.properties<br/>echo "log4j.appender.aiAppender.layout.ConversionPattern=[%p] %d %c %M - %m%n" &gt;&gt; /home/ubuntu/databricks/spark/dbconf/log4j/executor/log4j.properties<br/>echo "END: Updating Executor log4j properties file"<br/><br/>echo "BEGIN: Updating Driver log4j properties file"<br/>sed -i 's/log4j.rootCategory=INFO, publicFile/log4j.rootCategory=INFO, publicFile, aiAppender/g' /home/ubuntu/databricks/spark/dbconf/log4j/driver/log4j.properties<br/>echo "log4j.appender.aiAppender=com.microsoft.applicationinsights.log4j.v1_2.ApplicationInsightsAppender" &gt;&gt; /home/ubuntu/databricks/spark/dbconf/log4j/driver/log4j.properties<br/># echo "log4j.appender.aiAppender.DatePattern='.'yyyy-MM-dd" &gt;&gt; /home/ubuntu/databricks/spark/dbconf/log4j/driver/log4j.properties<br/>echo "log4j.appender.aiAppender.layout=org.apache.log4j.PatternLayout" &gt;&gt; /home/ubuntu/databricks/spark/dbconf/log4j/driver/log4j.properties<br/>echo "log4j.appender.aiAppender.layout.ConversionPattern=[%p] %d %c %M - %m%n" &gt;&gt; /home/ubuntu/databricks/spark/dbconf/log4j/driver/log4j.properties<br/>echo "END: Updating Driver log4j properties file"<br/><br/>echo "BEGIN: Updating Azure Log Analytics properties file"<br/>sed -i "s/^exit 101$/exit 0/" /usr/sbin/policy-rc.d<br/>wget https://raw.githubusercontent.com/Microsoft/OMS-Agent-for-Linux/master/installer/scripts/onboard_agent.sh &amp;&amp; sh onboard_agent.sh -w $LOG_ANALYTICS_WORKSPACE_ID -s $LOG_ANALYTICS_PRIMARY_KEY<br/>sudo su omsagent -c 'python /opt/microsoft/omsconfig/Scripts/PerformRequiredConfigurationChecks.py'<br/>/opt/microsoft/omsagent/bin/service_control restart $LOG_ANALYTICS_WORKSPACE_ID<br/>echo "END: Updating Azure Log Analytics properties file"<br/><br/>echo "BEGIN: Modify Spark config settings"<br/>cat &lt;&lt; 'EOF' &gt; /databricks/driver/conf/adbxmonitor-spark-driver-defaults.conf<br/>[driver] {<br/>  "spark.extraListeners" = "com.microsoft.adbxmonitor.adbxlistener.AdbxListener"<br/>}<br/>EOF<br/>echo "END: Modify Spark config settings"<br/>""", True)</span><span id="70ef" class="kk ig hi kg b fi kp km l kn ko">%sh cat /dbfs/appinsights/appinsights_logging_init.sh</span></pre><figure class="kb kc kd ke fd kr er es paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="er es kq"><img src="../Images/df99b4f7de44457344a8ee2b96de6532.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*8GWITnOxTZdGzR1n.jpg"/></div></div></figure><h1 id="13bb" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">创建Azure数据块集群</h1><ul class=""><li id="6fd7" class="jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju bi translated">创建新的集群</li><li id="84a2" class="jd je hi jf b jg jv ji jw jk jx jm jy jo jz jq jr js jt ju bi translated">选择databricks运行时为7.5</li><li id="71ca" class="jd je hi jf b jg jv ji jw jk jx jm jy jo jz jq jr js jt ju bi translated">保留所有默认设置</li><li id="b042" class="jd je hi jf b jg jv ji jw jk jx jm jy jo jz jq jr js jt ju bi translated">转到高级设置</li><li id="35a0" class="jd je hi jf b jg jv ji jw jk jx jm jy jo jz jq jr js jt ju bi translated">选择初始化脚本</li><li id="e6af" class="jd je hi jf b jg jv ji jw jk jx jm jy jo jz jq jr js jt ju bi translated">将此添加为位置</li></ul><pre class="kb kc kd ke fd kf kg kh ki aw kj bi"><span id="a610" class="kk ig hi kg b fi kl km l kn ko">dbfs:/appinsights/appinsights_logging_init.sh</span></pre><ul class=""><li id="a91d" class="jd je hi jf b jg ky ji kz jk la jm lb jo lc jq jr js jt ju bi translated">启动集群，并等待它启动</li><li id="e168" class="jd je hi jf b jg jv ji jw jk jx jm jy jo jz jq jr js jt ju bi translated">一旦开始，我们就好了。</li></ul><figure class="kb kc kd ke fd kr er es paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="er es ld"><img src="../Images/ce5c568f105077f5e6e557f7e1b5ac04.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*wlojjw40Cqxp_LQe.jpg"/></div></div></figure><h1 id="07b6" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">要测试的笔记本代码</h1><ul class=""><li id="1592" class="jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju bi translated">一旦集群启动</li><li id="53f6" class="jd je hi jf b jg jv ji jw jk jx jm jy jo jz jq jr js jt ju bi translated">创建一个scala笔记本</li><li id="378a" class="jd je hi jf b jg jv ji jw jk jx jm jy jo jz jq jr js jt ju bi translated">看看仪器钥匙</li></ul><pre class="kb kc kd ke fd kf kg kh ki aw kj bi"><span id="7271" class="kk ig hi kg b fi kl km l kn ko">%sh echo $APPINSIGHTS_INSTRUMENTATIONKEY</span><span id="117c" class="kk ig hi kg b fi kp km l kn ko">import org.apache.log4j.LogManager<br/><br/>val log = LogManager.getRootLogger<br/>// val log = org.apache.log4j.LogManager.getLogger("aiAppender")<br/><br/>log.warn("WARN: Hi from App Insights on Databricks 07")<br/>log.info("INFO: Hi from App Insights on Databricks 07")</span></pre><ul class=""><li id="1b45" class="jd je hi jf b jg ky ji kz jk la jm lb jo lc jq jr js jt ju bi translated">现在转到应用洞察</li><li id="b9cd" class="jd je hi jf b jg jv ji jw jk jx jm jy jo jz jq jr js jt ju bi translated">转到日志</li><li id="423d" class="jd je hi jf b jg jv ji jw jk jx jm jy jo jz jq jr js jt ju bi translated">编写下面的查询</li></ul><pre class="kb kc kd ke fd kf kg kh ki aw kj bi"><span id="205f" class="kk ig hi kg b fi kl km l kn ko">traces <br/>| project <br/>  message,<br/>  severityLevel,<br/>  LoggerName=customDimensions["LoggerName"], <br/>  LoggingLevel=customDimensions["LoggingLevel"],<br/>  SourceType=customDimensions["SourceType"],<br/>  ThreadName=customDimensions["LoggingLevel"],<br/>  SparkTimestamp=customDimensions["TimeStamp"],<br/>  timestamp <br/>| order by timestamp desc</span></pre><figure class="kb kc kd ke fd kr er es paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="er es le"><img src="../Images/a0c6d95bafefb935318943de30cceed8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*tbHEC0knoBAe9ycB.jpg"/></div></div></figure><pre class="kb kc kd ke fd kf kg kh ki aw kj bi"><span id="a5f1" class="kk ig hi kg b fi kl km l kn ko">import com.microsoft.applicationinsights.TelemetryClient<br/>import com.microsoft.applicationinsights.TelemetryConfiguration<br/><br/>val configuration = com.microsoft.applicationinsights.TelemetryConfiguration.createDefault()<br/>configuration.setInstrumentationKey(System.getenv("APPINSIGHTS_INSTRUMENTATIONKEY"))<br/><br/>val telemetryClient = new TelemetryClient(configuration)<br/>telemetryClient.trackEvent("Test App Insights Scala code via App Insights API 08")<br/>telemetryClient.flush()</span></pre><ul class=""><li id="9dbe" class="jd je hi jf b jg ky ji kz jk la jm lb jo lc jq jr js jt ju bi translated">现在转到应用洞察</li><li id="3073" class="jd je hi jf b jg jv ji jw jk jx jm jy jo jz jq jr js jt ju bi translated">转到日志</li><li id="cf66" class="jd je hi jf b jg jv ji jw jk jx jm jy jo jz jq jr js jt ju bi translated">编写下面的查询</li></ul><pre class="kb kc kd ke fd kf kg kh ki aw kj bi"><span id="dc5f" class="kk ig hi kg b fi kl km l kn ko">customEvents</span></pre><figure class="kb kc kd ke fd kr er es paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="er es lf"><img src="../Images/ed7cfaff377ea4e1f04a8df071de0f6d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*7_hQAB8_YZ2jDaj0.jpg"/></div></div></figure></div><div class="ab cl lg lh gp li" role="separator"><span class="lj bw bk lk ll lm"/><span class="lj bw bk lk ll lm"/><span class="lj bw bk lk ll"/></div><div class="hb hc hd he hf"><p id="862b" class="pw-post-body-paragraph ln lo hi jf b jg ky lp lq ji kz lr ls jk lt lu lv jm lw lx ly jo lz ma mb jq hb bi translated"><em class="mc">最初发表于</em><a class="ae ka" href="https://github.com/balakreshnan/Accenture/blob/master/AppInsights/applogadb.md" rel="noopener ugc nofollow" target="_blank">T5【https://github.com】</a><em class="mc">。</em></p></div></div>    
</body>
</html>