<html>
<head>
<title>How to connect to a Postgres database with Python</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何用Python连接到Postgres数据库</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/how-to-setup-a-python-application-with-a-postgres-database-f965e7c1581e?source=collection_archive---------12-----------------------#2021-01-12">https://medium.com/analytics-vidhya/how-to-setup-a-python-application-with-a-postgres-database-f965e7c1581e?source=collection_archive---------12-----------------------#2021-01-12</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><figure class="hh hi ez fb hj hk er es paragraph-image"><div class="er es hg"><img src="../Images/65632f2a494ca1f236c335fad136342e.png" data-original-src="https://miro.medium.com/v2/resize:fit:840/format:webp/1*A0j68iFhkCMz5Rx40h3ZQw.png"/></div></figure><div class=""/><p id="a4e3" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">你好，你好，我的工程师同事们！</p><p id="9c0b" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">这篇文章是对YouTube上如何构建可伸缩Python应用系列第3集和第4集的补充(你可以在这里看到第2集:【https://youtu.be/FMUsVwcBOVY】T4</p><p id="6f9d" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">我们将讨论如何使用Flask和SQLAlchemy为您的Python应用程序设置Postgres数据库连接(在第2集创建)。</p><p id="45c3" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">首先，对于这个项目，我使用Pipenv，你可以使用任何你喜欢的虚拟环境和依赖管理，但我个人更喜欢使用Pipenv。</p><p id="00dd" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">Pipenv的文档在这里:<a class="ae jk" href="https://pipenv.pypa.io/en/latest/" rel="noopener ugc nofollow" target="_blank">https://pipenv.pypa.io/en/latest/</a>。</p><p id="0e2b" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">我很久以前在这里写了一篇关于它的博客:<a class="ae jk" rel="noopener" href="/analytics-vidhya/a-tool-all-python-developers-should-be-using-5d547bfb45b7">https://medium . com/analytics-vid hya/a-tool-all-python-developers-should-be-using-5d 547 bfb 45 b 7</a></p><p id="18d7" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">在Mac上安装Pipenv最简单的方法是使用自制软件:</p><pre class="jl jm jn jo fd jp jq jr js aw jt bi"><span id="3b82" class="ju jv hp jq b fi jw jx l jy jz">brew install pipenv</span></pre><p id="8e78" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">接下来，我们的项目将有以下Pipfile:</p><pre class="jl jm jn jo fd jp jq jr js aw jt bi"><span id="7d4f" class="ju jv hp jq b fi jw jx l jy jz">[[source]]<br/>name = "pypi"<br/>url = "https://pypi.org/simple"<br/>verify_ssl = true<br/><br/>[dev-packages]<br/>pytest="*"<br/>pytest_mock="*"<br/><br/>[packages]<br/>clothes-shop = {editable = true, path = "."}<br/>flask="*"<br/>requests="*"<br/>sqlalchemy="*"<br/>flask-sqlalchemy="*"<br/>pg8000="==1.16.5"<br/><br/>[requires]<br/>python_version = "3.9"</span></pre><p id="0cbf" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">我们将使用flask作为应用程序，SQLAlchemy作为数据库ORM(Objected Related Mapping ), pg 8000作为PostgreSQL引擎。请求将在后面的教程中使用(所以现在忽略)。</p><p id="bc4e" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><em class="ka">文档:</em></p><p id="48ba" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">烧瓶:<a class="ae jk" href="https://flask.palletsprojects.com/en/1.1.x/" rel="noopener ugc nofollow" target="_blank">https://flask.palletsprojects.com/en/1.1.x/</a></p><p id="6684" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">https://docs.sqlalchemy.org/en/13/</p><p id="6a49" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">https://pypi.org/project/pg8000/</p><p id="26a8" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">我们将使用pg8000，它是PostgreSQL数据库引擎的纯Python接口。</p><p id="88f4" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">有趣的事实:它被称为pg8000，因为它被认为是Python的第8000个PostgreSQL接口。</p><p id="2928" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">不幸的是，直到SLQAlchemy 1.4才完全支持pg8000，所以我们不得不将版本固定到1.16.5(参见本主题的更多内容<a class="ae jk" href="https://github.com/sqlalchemy/sqlalchemy/issues/5645" rel="noopener ugc nofollow" target="_blank">https://github.com/sqlalchemy/sqlalchemy/issues/5645</a>)</p><p id="10a0" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">这个pipfile需要和你的项目在同一层，在我们的例子中，我们创建了一个<code class="du kb kc kd jq b">clothes_shop</code>目录来存储我们的<code class="du kb kc kd jq b">application_setup.py</code></p><p id="c979" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">我们的项目结构将如下所示:</p><pre class="jl jm jn jo fd jp jq jr js aw jt bi"><span id="6391" class="ju jv hp jq b fi jw jx l jy jz">ClothesShop/<br/>├── clothes_shop/<br/>│   ├── test/<br/>│   └── application_setup.py<br/>│<br/>├── README.md<br/>├── setup.py<br/>├── Pipfile<br/>└── Pipfile.lock</span></pre><p id="c693" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">在安装我们的依赖项之前，我们还需要创建一个<code class="du kb kc kd jq b">setup.py</code>,您可以创建一个<code class="du kb kc kd jq b">README.md</code>,现在让它为空:</p><pre class="jl jm jn jo fd jp jq jr js aw jt bi"><span id="7bf1" class="ju jv hp jq b fi jw jx l jy jz">"""setup.py"""</span><span id="ca83" class="ju jv hp jq b fi ke jx l jy jz">from setuptools import setup<br/><br/>with open('README.md', encoding="utf-8") as readme_file:<br/>    readme = readme_file.read()<br/><br/>setup(<br/>    name='clothes_shop',<br/>    description='Clothes shop project for YouTube',<br/>    author='Alexander V',<br/>    author_email='alex.v.engineering@gmail.com',<br/>    long_description=readme,<br/>    test_suite='clothes_shop/test/'<br/>)</span></pre><p id="268f" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">如果您想使用pipenv安装这些依赖项:</p><pre class="jl jm jn jo fd jp jq jr js aw jt bi"><span id="03af" class="ju jv hp jq b fi jw jx l jy jz">pipenv install -d</span></pre><p id="98c7" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">-d包括开发包。您会注意到还创建了一个<code class="du kb kc kd jq b">pipfile.lock</code>文件。</p><p id="5816" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">如果你按照上一集的内容设置了Postgres。您可以通过执行以下操作来添加密码:</p><p id="a73c" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">首先，通过在您的终端中键入以下命令来启动psql:</p><pre class="jl jm jn jo fd jp jq jr js aw jt bi"><span id="82e2" class="ju jv hp jq b fi jw jx l jy jz">psql</span></pre><p id="aa57" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">然后更改您的用户:</p><pre class="jl jm jn jo fd jp jq jr js aw jt bi"><span id="c5f2" class="ju jv hp jq b fi jw jx l jy jz">ALTER USER &lt;your username&gt; WITH PASSWORD '&lt;your password&gt;';</span></pre><p id="015d" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">您还需要修改本地配置来请求密码。</p><p id="2f8d" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">通过在psql中输入以下内容找到您的<code class="du kb kc kd jq b">hba_file</code>:</p><pre class="jl jm jn jo fd jp jq jr js aw jt bi"><span id="91a4" class="ju jv hp jq b fi jw jx l jy jz">SHOW hba_file;</span></pre><p id="0e91" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">这应该会返回类似于<code class="du kb kc kd jq b">/usr/local/var/postgres/pg_hba.conf</code>的内容</p><p id="8bc9" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">你可以随意修改。我只是使用VIM:</p><pre class="jl jm jn jo fd jp jq jr js aw jt bi"><span id="6a7b" class="ju jv hp jq b fi jw jx l jy jz">vim  /usr/local/var/postgres/pg_hba.conf</span></pre><p id="ee2a" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">在文件的底部，将配置更改为如下所示:(在VIM中，按<code class="du kb kc kd jq b">a</code>进入，然后修改文本。然后按下<code class="du kb kc kd jq b">esc</code>，然后键入<code class="du kb kc kd jq b">:wq</code>和<code class="du kb kc kd jq b">return</code>保存您的更改并退出)。</p><figure class="jl jm jn jo fd hk er es paragraph-image"><div role="button" tabindex="0" class="kg kh di ki bf kj"><div class="er es kf"><img src="../Images/0751cfbef6e3f61e2cfd5608d39975d4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*spj2sPmx4I0_ZU8Fx4IfmA.png"/></div></div></figure><p id="deed" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">这将要求所有用户输入密码才能登录。</p><p id="87db" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">现在让我们设置我们的应用程序:</p><pre class="jl jm jn jo fd jp jq jr js aw jt bi"><span id="9bcc" class="ju jv hp jq b fi jw jx l jy jz"><em class="ka">"""Application setup"""<br/><br/></em>import os<br/><br/>from flask import Flask<br/>from flask_sqlalchemy import SQLAlchemy<br/><br/><br/>def application_setup():<br/>    <em class="ka">"""creates a flask application and initialises the clothes_shop database"""<br/>    </em>username = os.environ.get("PG_USERNAME", "alex")<br/>    password = os.environ.get("PG_PASSWORD", "test")<br/>    database_name = os.environ.get("DATABASE_NAME", "clothes_shop")<br/><br/>    _app = Flask(__name__)<br/>    _app.config["SQLALCHEMY_DATABASE_URI"] = f"postgresql+pg8000://{username}:{password}@localhost:5432/{database_name}"<br/>    _app.config["SQLALCHEMY_BINDS"] = {f"{database_name}": _app.config["SQLALCHEMY_DATABASE_URI"]}<br/>    _app.config["SQLALCHEMY_TRACK_MODIFICATIONS"] = False<br/><br/>    db = SQLAlchemy(_app)<br/>    db.init_app(_app)<br/><br/>    return _app, db</span></pre><p id="d8ee" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><em class="ka">在此功能中:</em></p><ul class=""><li id="d808" class="kk kl hp io b ip iq it iu ix km jb kn jf ko jj kp kq kr ks bi translated">我们从环境变量中获取Postgres用户名、密码和数据库名。</li><li id="8520" class="kk kl hp io b ip kt it ku ix kv jb kw jf kx jj kp kq kr ks bi translated">我们初始化一个烧瓶应用程序。</li><li id="6c43" class="kk kl hp io b ip kt it ku ix kv jb kw jf kx jj kp kq kr ks bi translated">我们设置数据库配置(URI、绑定和跟踪修改)</li><li id="bb99" class="kk kl hp io b ip kt it ku ix kv jb kw jf kx jj kp kq kr ks bi translated">然后初始化我们的数据库和应用程序。</li><li id="ac75" class="kk kl hp io b ip kt it ku ix kv jb kw jf kx jj kp kq kr ks bi translated">最后，我们返回主程序使用的应用程序和数据库。</li></ul><h2 id="1c3b" class="ju jv hp bd ky kz la lb lc ld le lf lg ix lh li lj jb lk ll lm jf ln lo lp lq bi translated">测试测试测试</h2><p id="3662" class="pw-post-body-paragraph im in hp io b ip lr ir is it ls iv iw ix lt iz ja jb lu jd je jf lv jh ji jj hb bi translated">在本系列中，我们将从软件工程的角度构建应用程序。任何有价值的软件都将被很好地测试(…这个类比不确定)。这个项目也不会有什么不同。</p><p id="9901" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">我喜欢向您展示软件开发中“不太有趣”但却最重要的一面。对你的代码进行严格的测试……当你的QA团队发现bug时，这会节省你很多时间。</p><p id="ae61" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">使用<code class="du kb kc kd jq b">Pytest</code>,我们将测试应用程序与数据库的连接。这就是我们所说的集成测试，因为我们将在系统中测试我们的两个服务交互。</p><p id="93aa" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">在您的测试文件夹中设置一个名为<code class="du kb kc kd jq b">Integration</code>的目录，并在该目录中添加一个名为<code class="du kb kc kd jq b">test_application_setup.py</code>的Python文件，这样您的文件夹结构如下所示:</p><pre class="jl jm jn jo fd jp jq jr js aw jt bi"><span id="ee7e" class="ju jv hp jq b fi jw jx l jy jz">test/<br/>└── integration/<br/>    └── test_application_setup.py</span></pre><p id="2167" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">首先我们将测试<code class="du kb kc kd jq b">test_application_setup.</code>内部的快乐路径添加:</p><pre class="jl jm jn jo fd jp jq jr js aw jt bi"><span id="8b02" class="ju jv hp jq b fi jw jx l jy jz"><em class="ka">"""test_application_setup.py Test the integration on the application setup and interaction with the database"""<br/></em><br/>from clothes_shop import application_setup<br/><br/><br/>def test_application_setup():<br/>    <em class="ka">"""Check the database connection is active with correct details"""<br/>    </em>os.environ["DATABASE_NAME"] = "clothes_shop"<br/>    table_name = "clothes_stock"<br/><br/>    app, db = application_setup.application_setup()<br/><br/>    assert app.config["SQLALCHEMY_DATABASE_URI"] == str(db.session.bind.url)<br/>    assert db.session.execute(f"SELECT * from {table_name}")</span></pre><p id="7a7b" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">我喜欢把我的测试分成三个部分。</p><ul class=""><li id="bc42" class="kk kl hp io b ip iq it iu ix km jb kn jf ko jj kp kq kr ks bi translated">设置(测试变量、环境变量等)。</li><li id="fc9b" class="kk kl hp io b ip kt it ku ix kv jb kw jf kx jj kp kq kr ks bi translated">执行要测试的功能。</li><li id="990d" class="kk kl hp io b ip kt it ku ix kv jb kw jf kx jj kp kq kr ks bi translated">断言</li></ul><p id="9ebc" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">在这个测试中，我们将数据库名称添加到一个环境变量中。使用<code class="du kb kc kd jq b">os</code>我们可以设置我们的环境变量。我们还为我们想要对其执行SQL <code class="du kb kc kd jq b">SELECT</code>的表名设置了一个变量。</p><p id="23c0" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">然后我们运行函数<code class="du kb kc kd jq b">application_setup</code>，它将返回应用程序和数据库。</p><p id="ebbb" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">最后，我们检查从数据库配置返回的绑定是否与应用程序配置相同。然后最重要的是，我们测试我们的连接是否从数据库返回结果。</p><p id="c5e1" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">我们只需从第2集创建的数据库中执行一条SQL <code class="du kb kc kd jq b">SELECT</code>语句就可以做到这一点。如果您还记得，我们向一个名为<code class="du kb kc kd jq b">clothes_stock</code>的表中插入了一些数据。应该返回这些数据。如果没有，将从SQLAlchemy返回一个<code class="du kb kc kd jq b">ProgrammingError</code>。</p><p id="d82f" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">请记住，对于这个测试，我们只关心正在建立的连接。而不是返回的数据内容。</p><p id="8da3" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">现在让我们做一些不愉快的路径！</p><p id="fb71" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">永远不要只测试从系统中返回您想要的结果的路径。软件工程师需要考虑我们不应该期望的结果，以及边缘情况场景。</p><p id="40b5" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">对于这个项目，我们不希望任何不正确的密码能够访问超级用户的特权。我们要做的下一个测试是测试这个:</p><pre class="jl jm jn jo fd jp jq jr js aw jt bi"><span id="b5ae" class="ju jv hp jq b fi jw jx l jy jz"><em class="ka">"""test_application_setup.py Test the integration on the application setup and interaction with the database"""<br/><br/></em>import os<br/><br/>import pytest<br/>from sqlalchemy.exc import ProgrammingError<br/><br/>from clothes_shop import application_setup<br/><br/><br/>def test_application_setup_incorrect_password():<br/>    <em class="ka">"""Check the database connection does not allow incorrect passwords"""<br/>    </em>os.environ["PG_USERNAME"] = "alex"<br/>    os.environ["PG_PASSWORD"] = "incorrect_password"<br/>    os.environ["DATABASE_NAME"] = "clothes_shop"<br/>    table_name = "clothes_stock"<br/><br/>    app, db = application_setup.application_setup()<br/><br/>    assert app.config["SQLALCHEMY_DATABASE_URI"] == str(db.session.bind.url)<br/>    with pytest.raises(ProgrammingError):<br/>        assert db.session.execute(f"SELECT * from {table_name}")</span></pre><p id="98cc" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">在上面的例子中，我们设置了一个错误的密码。然后使用<code class="du kb kc kd jq b">Pytest.raises</code>我们可以发现使用该密码将引发一个<code class="du kb kc kd jq b">ProgrammingError</code></p><p id="ef53" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">最后，我们还想测试无效用户将无法访问我们的数据库:</p><pre class="jl jm jn jo fd jp jq jr js aw jt bi"><span id="b4b6" class="ju jv hp jq b fi jw jx l jy jz"><em class="ka">"""test_application_setup.py Test the integration on the application setup and interaction with the database"""<br/><br/></em>import os<br/><br/>import pytest<br/>from sqlalchemy.exc import ProgrammingError<br/><br/>from clothes_shop import application_setup</span><span id="20fe" class="ju jv hp jq b fi ke jx l jy jz"><br/>def test_application_setup_invalid_user():<br/>    <em class="ka">"""Check the database connection does not allow an invalid username"""<br/>    </em>os.environ["PG_USERNAME"] = "invalid_username"<br/>    app, db = application_setup.application_setup()<br/><br/>    assert app.config["SQLALCHEMY_DATABASE_URI"] == str(db.session.bind.url)<br/>    with pytest.raises(ProgrammingError):<br/>        assert db.session.execute("SELECT * from clothes_stock")</span></pre><p id="3d38" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">在这个例子中，我们设置了一个随机的用户名。我们使用与之前测试相同的技术来捕捉错误，因为这也应该产生一个<code class="du kb kc kd jq b">ProgrammingError</code></p><p id="c4ac" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">完整的测试套件应该如下所示:</p><pre class="jl jm jn jo fd jp jq jr js aw jt bi"><span id="4a36" class="ju jv hp jq b fi jw jx l jy jz"><em class="ka">"""Test the integration on the application setup and interaction with the database"""<br/><br/></em>import os<br/><br/>import pytest<br/>from sqlalchemy.exc import ProgrammingError<br/><br/>from clothes_shop import application_setup<br/><br/><br/>def test_application_setup():<br/>    <em class="ka">"""Check the database connection is active with correct details"""<br/>    </em>os.environ["DATABASE_NAME"] = "clothes_shop"<br/>    table_name = "clothes_stock"<br/><br/>    app, db = application_setup.application_setup()<br/><br/>    assert app.config["SQLALCHEMY_DATABASE_URI"] == str(db.session.bind.url)<br/>    assert db.session.execute(f"SELECT * from {table_name}")<br/><br/><br/>def test_application_setup_incorrect_password():<br/>    <em class="ka">"""Check the database connection does not allow incorrect passwords"""<br/>    </em>os.environ["PG_USERNAME"] = "alex"<br/>    os.environ["PG_PASSWORD"] = "incorrect_password"<br/>    os.environ["DATABASE_NAME"] = "clothes_shop"<br/>    table_name = "clothes_stock"<br/><br/>    app, db = application_setup.application_setup()<br/><br/>    assert app.config["SQLALCHEMY_DATABASE_URI"] == str(db.session.bind.url)<br/>    with pytest.raises(ProgrammingError):<br/>        assert db.session.execute(f"SELECT * from {table_name}")<br/><br/><br/>def test_application_setup_invalid_user():<br/>    <em class="ka">"""Check the database connection does not allow an invalid username"""<br/>    </em>os.environ["PG_USERNAME"] = "invalid_username"<br/>    os.environ["DATABASE_NAME"] = "clothes_shop"<br/>    table_name = "clothes_stock"<br/><br/>    app, db = application_setup.application_setup()<br/><br/>    assert app.config["SQLALCHEMY_DATABASE_URI"] == str(db.session.bind.url)<br/>    with pytest.raises(ProgrammingError):<br/>        assert db.session.execute(f"SELECT * from {table_name}")</span></pre><p id="35f3" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">然后，您可以使用以下命令运行这些测试:</p><pre class="jl jm jn jo fd jp jq jr js aw jt bi"><span id="903d" class="ju jv hp jq b fi jw jx l jy jz">pipenv run pytest</span></pre><p id="400a" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">您应该看到三个通过测试！</p><p id="9383" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">我希望这能对你有所帮助。第3集和第4集的视频很快就会出来。如果您有任何问题，请随意评论，我会在下一个问题上与您联系。</p></div></div>    
</body>
</html>