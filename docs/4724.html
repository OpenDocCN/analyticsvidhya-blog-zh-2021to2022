<html>
<head>
<title>Trigger “specific” ECS Tasks with S3 payloads</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用S3有效负载触发“特定”ECS任务</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/trigger-specific-ecs-tasks-with-s3-payloads-79c9ce6aa57d?source=collection_archive---------1-----------------------#2022-01-23">https://medium.com/analytics-vidhya/trigger-specific-ecs-tasks-with-s3-payloads-79c9ce6aa57d?source=collection_archive---------1-----------------------#2022-01-23</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="6296" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">并将有效负载注入触发的任务</p><p id="d8fe" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">随着AWS Fargate的推出，ECS(弹性容器服务)成为那些想要管理容器编排，但没有必要或专业知识来转换到Kubernetes的组织的更有利可图的产品。</p><p id="e07a" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">作为无服务器函数调用之王，AWS Lambda有一个主要的瓶颈，那就是它在一次调用中最多只能运行15分钟。我们可以选择<a class="ae jc" href="https://lumigo.io/learn/aws-lambda-timeout-best-practices/" rel="noopener ugc nofollow" target="_blank">设计模式</a>来克服这个问题，但是对于长时间的事件驱动工作流，Fargate上的ECS提供了一个很好的替代方案，没有时间限制的约束。</p></div><div class="ab cl jd je go jf" role="separator"><span class="jg bw bk jh ji jj"/><span class="jg bw bk jh ji jj"/><span class="jg bw bk jh ji"/></div><div class="ha hb hc hd he"><p id="36e6" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">让我们看一下问题陈述，以便更加清楚:</p><figure class="jl jm jn jo fd jp er es paragraph-image"><div role="button" tabindex="0" class="jq jr di js bf jt"><div class="er es jk"><img src="../Images/04b3fa6c67e313e9869db3105fea4083.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*K2ajdt-w3nOlGjuL45lrSQ.png"/></div></div><figcaption class="jw jx et er es jy jz bd b be z dx translated">触发相应ECS任务的S3数据转储</figcaption></figure><p id="3125" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在S3存储桶中有多个转储数据的流程，每个流程的数据都需要单独的工作流来处理/转换。在我们的例子中，每种类型的转换都由一个单独的ECS任务处理。</p><p id="d9ba" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">作为设计模式的考虑，如果我们要处理<code class="du ka kb kc kd b">salesforce</code>数据，我们的ECS任务命名为<code class="du ka kb kc kd b">salesforce pipeline</code>。进程转储数据应该转储到S3前缀<code class="du ka kb kc kd b">app_salesforce</code>下。这将任务名称嵌入到S3键中，有助于从本质上将数据映射到其管道。</p><p id="f97c" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">现在，让我们考虑一下，S3已经被设置为当特定前缀上的数据转储发生时发出事件(如何做同样的事情在下面讨论)。将这些多个事件映射到它们正确的任务的桥(下面的实现)是一个lambda函数，它由事件触发并运行正确的ECS任务。</p><ul class=""><li id="2214" class="ke kf hh ig b ih ii il im ip kg it kh ix ki jb kj kk kl km bi translated">S3事件通知→λ→ECS任务触发器</li></ul><figure class="jl jm jn jo fd jp er es paragraph-image"><div role="button" tabindex="0" class="jq jr di js bf jt"><div class="er es kn"><img src="../Images/763159bef64f68deed670d7e6b1d6009.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GCY5ragfEAMl7A5eD4dXZQ.png"/></div></div><figcaption class="jw jx et er es jy jz bd b be z dx translated">Lambda用作指导正确任务调用的中介</figcaption></figure><blockquote class="ko kp kq"><p id="1806" class="ie if kr ig b ih ii ij ik il im in io ks iq ir is kt iu iv iw ku iy iz ja jb ha bi translated">注意:本文假设ECS任务存在并且设置正确。<br/>我们不会深入探讨如何创建lambda函数或S3桶，因为可以在相同的上找到多个引用，此解决方案将处理这些组件之间的集成。</p></blockquote></div><div class="ab cl jd je go jf" role="separator"><span class="jg bw bk jh ji jj"/><span class="jg bw bk jh ji jj"/><span class="jg bw bk jh ji"/></div><div class="ha hb hc hd he"><h1 id="5e8e" class="kv kw hh bd kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls bi translated">1.设置Lambda</h1><p id="1e55" class="pw-post-body-paragraph ie if hh ig b ih lt ij ik il lu in io ip lv ir is it lw iv iw ix lx iz ja jb ha bi translated">我们从lambda设置开始，因为给定一个模拟负载，很容易测试它是否能够触发正确的ECS任务。</p><p id="249e" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">lambda是用python编写的，它从s3键中提取文件夹名，并为它调用相应的ECS任务。关于API调用的细节，附上核心逻辑代码供参考。</p><figure class="jl jm jn jo fd jp"><div class="bz dy l di"><div class="ly lz l"/></div></figure><blockquote class="ko kp kq"><p id="805b" class="ie if kr ig b ih ii ij ik il im in io ks iq ir is kt iu iv iw ku iy iz ja jb ha bi translated"><strong class="ig hi"> run_task函数调用</strong>中的<strong class="ig hi"> containerOverrides </strong>段是解决方案的关键。</p></blockquote><p id="a163" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">然后可以使用模拟S3有效负载来测试这个lambda，以验证它是否可以正确地触发ECS任务，同时将有效负载注入到环境变量中。</p><h1 id="d3b0" class="kv kw hh bd kx ky ma la lb lc mb le lf lg mc li lj lk md lm ln lo me lq lr ls bi translated">2.设置S3来触发拉姆达</h1><p id="da59" class="pw-post-body-paragraph ie if hh ig b ih lt ij ik il lu in io ip lv ir is it lw iv iw ix lx iz ja jb ha bi translated">为lambda添加触发器</p><ol class=""><li id="764d" class="ke kf hh ig b ih ii il im ip kg it kh ix ki jb mf kk kl km bi translated">转到存储桶→属性选项卡→创建事件通知</li><li id="292c" class="ke kf hh ig b ih mg il mh ip mi it mj ix mk jb mf kk kl km bi translated">添加事件名称并保留前缀“<strong class="ig hi">app”</strong></li></ol><figure class="jl jm jn jo fd jp er es paragraph-image"><div role="button" tabindex="0" class="jq jr di js bf jt"><div class="er es ml"><img src="../Images/4464f032552585d8b0b0b81886dd72b5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8eXPSlhFmxsCZy-FJ0NHdA.png"/></div></div><figcaption class="jw jx et er es jy jz bd b be z dx translated">在S3创建活动</figcaption></figure><p id="b67f" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">3.事件类型:<strong class="ig hi">所有对象创建事件</strong></p><p id="11ad" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">4.添加我们在上面创建的Lambda函数。保持您设置的名称。</p><figure class="jl jm jn jo fd jp er es paragraph-image"><div class="er es mm"><img src="../Images/e0fd5a927664992c15eb24e118f290d2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1278/format:webp/1*o_fF3bjMl8Rp3Iun-wBfiw.png"/></div><figcaption class="jw jx et er es jy jz bd b be z dx translated">添加lambda函数</figcaption></figure><h1 id="0693" class="kv kw hh bd kx ky ma la lb lc mb le lf lg mc li lj lk md lm ln lo me lq lr ls bi translated">3.将这一切结合在一起</h1><p id="8cd3" class="pw-post-body-paragraph ie if hh ig b ih lt ij ik il lu in io ip lv ir is it lw iv iw ix lx iz ja jb ha bi translated">现在，当数据被任何来源转储到S3时，我们可以检查相应的任务是否已经执行，并验证S3桶和密钥是否作为要使用的环境变量被注入。</p></div><div class="ab cl jd je go jf" role="separator"><span class="jg bw bk jh ji jj"/><span class="jg bw bk jh ji jj"/><span class="jg bw bk jh ji"/></div><div class="ha hb hc hd he"><p id="deca" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">最后，我想告诉您，还有另一种方法可以使用Cloudtrail + EventBridge规则实现上述功能，我很乐意在评论中讨论这方面的可伸缩性问题。</p><p id="2c17" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">希望您喜欢阅读这篇文章，如果您喜欢更深入地研究其他AWS细微差别和架构讨论，请告诉我。</p></div></div>    
</body>
</html>