<html>
<head>
<title>Load Change Data Capture data from PostgreSQL to Amazon Redshift</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">从PostgreSQL到Amazon Redshift的负载变化数据捕获数据</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/load-change-data-capture-data-from-postgresql-to-amazon-redshift-56fa6b6cf3f3?source=collection_archive---------14-----------------------#2021-04-08">https://medium.com/analytics-vidhya/load-change-data-capture-data-from-postgresql-to-amazon-redshift-56fa6b6cf3f3?source=collection_archive---------14-----------------------#2021-04-08</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="93f8" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">变更数据捕获对于向云迁移变得至关重要。在这篇博客中，我概述了使用StreamSets Data Collector、<a class="ae jc" href="https://streamsets.com/products/dataops-platform/data-collector/" rel="noopener ugc nofollow" target="_blank">快速数据摄取引擎</a>将变更数据捕获(CDC)数据从PostgreSQL加载到Amazon Redshift的详细说明和步骤。</p><p id="8eec" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><a class="ae jc" href="https://streamsets.com/learn/data-pipelines/" rel="noopener ugc nofollow" target="_blank">数据管道</a>首先将PostgreSQL CDC数据写入亚马逊S3，然后执行一组查询来对亚马逊红移执行upsert操作。执行的查询集包括亚马逊S3复制命令，该命令利用亚马逊红移的大规模并行处理(MPP)架构，从存储在亚马逊S3桶中的文件并行读取和加载数据。</p><h1 id="48d3" class="jd je hh bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">什么是upsert操作？</h1><p id="e2b7" class="pw-post-body-paragraph ie if hh ig b ih kb ij ik il kc in io ip kd ir is it ke iv iw ix kf iz ja jb ha bi translated">upsert操作使您能够在同一事务中插入新记录或更新现有记录。为了确定记录是否已经存在，这组查询依赖于传入记录的主键。</p><h1 id="03df" class="jd je hh bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">先决条件</h1><ul class=""><li id="fb05" class="kg kh hh ig b ih kb il kc ip ki it kj ix kk jb kl km kn ko bi translated">访问<a class="ae jc" href="https://streamsets.com/getting-started/download-install-data-collector/" rel="noopener ugc nofollow" target="_blank">流集数据收集器</a> (SDC)的实例</li><li id="1ea9" class="kg kh hh ig b ih kp il kq ip kr it ks ix kt jb kl km kn ko bi translated">同时下载<a class="ae jc" href="https://jdbc.postgresql.org/download.html" rel="noopener ugc nofollow" target="_blank"> PostgreSQL </a>和<a class="ae jc" href="https://docs.aws.amazon.com/redshift/latest/mgmt/configuring-connections.html#connecting-drivers" rel="noopener ugc nofollow" target="_blank">红移</a>的JDBC驱动。(我用了<em class="ku"> postgresql-42.2.5.jar </em>和<em class="ku">redshiftjdbc 42-no-AWS SDK-1 . 2 . 41 . 1065 . jar</em>)</li><li id="ba4c" class="kg kh hh ig b ih kp il kq ip kr it ks ix kt jb kl km kn ko bi translated">一旦你有了驱动程序，使用<a class="ae jc" href="https://streamsets.com/documentation/datacollector/latest/help/datacollector/UserGuide/Configuration/ExternalLibs.html#task_jng_dkt_bz" rel="noopener ugc nofollow" target="_blank">软件包管理器</a>在SDC安装它们。</li><li id="b957" class="kg kh hh ig b ih kp il kq ip kr it ks ix kt jb kl km kn ko bi translated">访问一个<a class="ae jc" href="https://aws.amazon.com/redshift/" rel="noopener ugc nofollow" target="_blank">亚马逊红移</a>集群</li><li id="8556" class="kg kh hh ig b ih kp il kq ip kr it ks ix kt jb kl km kn ko bi translated">访问亚马逊RDS for PostgreSQL 。(我用的是11.6版本)</li></ul><h1 id="e284" class="jd je hh bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">在AWS RDS上为PostgreSQL启用CDC</h1><ul class=""><li id="3de2" class="kg kh hh ig b ih kb il kc ip ki it kj ix kk jb kl km kn ko bi translated"><strong class="ig hi"> <em class="ku">注意</em> </strong>:连接到数据库的用户必须拥有<em class="ku">复制</em>或<em class="ku">超级用户</em>角色。</li><li id="2ce8" class="kg kh hh ig b ih kp il kq ip kr it ks ix kt jb kl km kn ko bi translated">在Amazon RDS for PostgreSQL实例上，确保在相关的参数组<strong class="ig hi"><em class="ku">RDS . logical _ replication</em></strong>中启用(即设置为1)</li><li id="3a7b" class="kg kh hh ig b ih kp il kq ip kr it ks ix kt jb kl km kn ko bi translated">如果您没有权限编辑现有的参数组，您可以<a class="ae jc" href="https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/USER_WorkingWithParamGroups.html#USER_WorkingWithParamGroups.Creating" rel="noopener ugc nofollow" target="_blank">创建一个新的参数组</a>，然后将<strong class="ig hi"><em class="ku">RDS . logical _ replication</em></strong>参数设置为1，将其他值保留为默认值，并将这个新组添加到Amazon RDS实例中。</li><li id="a86a" class="kg kh hh ig b ih kp il kq ip kr it ks ix kt jb kl km kn ko bi translated">在PSQL中，执行以下操作:</li><li id="befc" class="kg kh hh ig b ih kp il kq ip kr it ks ix kt jb kl km kn ko bi translated">创建复制插槽。</li><li id="025c" class="kg kh hh ig b ih kp il kq ip kr it ks ix kt jb kl km kn ko bi translated"><em class="ku">SELECT pg _ create _ logical _ replication _ slot('</em><strong class="ig hi"><em class="ku">your _ replication _ slot _ name _ goes _ here</em></strong><em class="ku">'，' wal 2 JSON ')；</em></li><li id="eb2f" class="kg kh hh ig b ih kp il kq ip kr it ks ix kt jb kl km kn ko bi translated">创建一个具有replication属性的角色供PostgreSQLReader使用，并授予它对包含要读取的表的模式的select权限。</li><li id="6c2c" class="kg kh hh ig b ih kp il kq ip kr it ks ix kt jb kl km kn ko bi translated"><em class="ku">创建角色</em><strong class="ig hi"><em class="ku">your _ ROLE _ name _ goes _ here</em></strong><em class="ku">用登录密码</em><strong class="ig hi"><em class="ku">‘your _ PASSWORD _ goes _ here’</em></strong><em class="ku">；</em></li><li id="eb19" class="kg kh hh ig b ih kp il kq ip kr it ks ix kt jb kl km kn ko bi translated"><em class="ku">将rds_replication授予</em><strong class="ig hi"><em class="ku">your _ role _ name _ goes _ here</em></strong><em class="ku">；</em></li><li id="ea69" class="kg kh hh ig b ih kp il kq ip kr it ks ix kt jb kl km kn ko bi translated"><em class="ku"> GRANT SELECT对模式</em><strong class="ig hi"><em class="ku">your _ SCHEMA _ name _ goes _ here</em></strong><em class="ku">到</em><strong class="ig hi"><em class="ku">your _ role _ name _ goes _ here</em></strong><em class="ku">；</em></li></ul><p id="a8ae" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi"/></p><p id="c6fa" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">如果您想继续学习，下面是我在这个例子中使用的PostgreSQL和Amazon红移表的结构和模式:</p><pre class="kv kw kx ky fd kz la lb lc aw ld bi"><span id="8b27" class="le je hh la b fi lf lg l lh li">#### PostgreSQL </span><span id="aa57" class="le je hh la b fi lj lg l lh li">CREATE TABLE "companies" ( "id" int4 NOT NULL DEFAULT nextval('companies_id_seq'::regclass), "name" bpchar(60), "type" bpchar(60), "funding" numeric(12,5), PRIMARY KEY ("id") ); </span><span id="55bc" class="le je hh la b fi lj lg l lh li">#### Amazon Redshift </span><span id="6e54" class="le je hh la b fi lj lg l lh li">CREATE TABLE companies( id bigint NOT NULL, name varchar(60), type varchar(60), funding decimal(12,5), PRIMARY KEY(id) );</span></pre><h1 id="6ba9" class="jd je hh bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">数据管道概述</h1><figure class="kv kw kx ky fd ll er es paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="er es lk"><img src="../Images/e22234007f9ad4d7ab1a3c5a6f64d87d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*eGRLdBVwmFRasYmj.png"/></div></div></figure><h1 id="ccb5" class="jd je hh bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">PostgreSQL CDC客户端</h1><ul class=""><li id="198e" class="kg kh hh ig b ih kb il kc ip ki it kj ix kk jb kl km kn ko bi translated">读取数据管道中预写日志(WAL)记录的来源是<a class="ae jc" href="https://streamsets.com/documentation/datacollector/latest/help/datacollector/UserGuide/Origins/PostgreSQL.html#concept_cfs_4m4_n2b" rel="noopener ugc nofollow" target="_blank"> PostgreSQL CDC客户端</a>。该源为每笔交易生成一条记录。因为每个事务可以包含多个CRUD操作，所以它也可以包含一个记录上的多个操作。</li><li id="1d9e" class="kg kh hh ig b ih kp il kq ip kr it ks ix kt jb kl km kn ko bi translated">一些重要的配置属性包括:</li><li id="3244" class="kg kh hh ig b ih kp il kq ip kr it ks ix kt jb kl km kn ko bi translated">模式、表名模式(匹配一组表的表名或模式)、初始更改(从哪里开始读取记录)、操作(要捕获的CRUD操作；在我们的例子中是插入和更新)、复制插槽、JDBC连接字符串(格式为<em class="ku">JDBC:PostgreSQL://&lt;host&gt;:&lt;port&gt;/&lt;dbname&gt;</em>)和凭证(用于连接数据库。)</li></ul><h1 id="c7ef" class="jd je hh bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">Jython评估器</h1><ul class=""><li id="e269" class="kg kh hh ig b ih kb il kc ip ki it kj ix kk jb kl km kn ko bi translated">在<a class="ae jc" href="https://streamsets.com/documentation/datacollector/latest/help/datacollector/UserGuide/Processors/Jython.html#concept_a1h_lkf_lr" rel="noopener ugc nofollow" target="_blank"> Jython Evaluator </a>处理器中，在GitHub 上添加这个<a class="ae jc" href="https://github.com/iamontheinet/StreamSets/blob/master/Misc/wal2json_to_sdc_record.py" rel="noopener ugc nofollow" target="_blank"> Jython代码，它将重新格式化WAL记录，以便于下游处理。</a></li></ul><h1 id="4011" class="jd je hh bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">表达式评估器</h1><ul class=""><li id="5f65" class="kg kh hh ig b ih kb il kc ip ki it kj ix kk jb kl km kn ko bi translated">使用<a class="ae jc" href="https://streamsets.com/documentation/datacollector/latest/help/datacollector/UserGuide/Processors/Expression.html#concept_zm2_pp3_wq" rel="noopener ugc nofollow" target="_blank">表达式评估器</a>处理器，我们将用一个简单的表达式将新记录从List转换为ListMap，其中<strong class="ig hi">输出字段</strong>被设置为<em class="ku"> '/' </em>，它评估为记录根，而<strong class="ig hi">字段表达式</strong>被设置为<em class="ku">$ { record:value '/')}</em>，它表示整个记录。</li></ul><h1 id="3cfc" class="jd je hh bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">亚马逊S3</h1><ul class=""><li id="a44e" class="kg kh hh ig b ih kb il kc ip ki it kj ix kk jb kl km kn ko bi translated"><a class="ae jc" href="https://streamsets.com/documentation/datacollector/latest/help/datacollector/UserGuide/Origins/AmazonS3.html#concept_kvs_3hh_ht" rel="noopener ugc nofollow" target="_blank">亚马逊S3 </a>是管道的关键组件之一，不仅因为它是写入转换后的CDC数据的地方，还因为写入S3使我们能够使用<a class="ae jc" href="https://docs.aws.amazon.com/redshift/latest/dg/t_Loading-data-from-S3.html" rel="noopener ugc nofollow" target="_blank">亚马逊<em class="ku">复制</em> </a>命令以大规模并行处理(MPP)的方式将PostgreSQL CDC数据从亚马逊S3加载到Redshift。<em class="ku"> ( </em> <strong class="ig hi"> <em class="ku">关于这一点更多的在下面的JDBC查询部分。</em> </strong> <em class="ku"> ) </em></li><li id="a9dc" class="kg kh hh ig b ih kp il kq ip kr it ks ix kt jb kl km kn ko bi translated">一些重要的配置属性包括:</li><li id="9d94" class="kg kh hh ig b ih kp il kq ip kr it ks ix kt jb kl km kn ko bi translated">产生事件:启用此选项将导致目的地<a class="ae jc" href="https://streamsets.com/documentation/datacollector/latest/help/datacollector/UserGuide/Destinations/AmazonS3.html#concept_aqq_tt2_px" rel="noopener ugc nofollow" target="_blank">产生事件</a>，我们最感兴趣的是<strong class="ig hi"> S3对象写入</strong>，它是在一组/一批CDC记录被写入S3时产生的。当这个事件生成时，JDBC查询执行器将对Amazon Redshift上的那些记录执行一个upsert操作。(见下文。)</li><li id="8144" class="kg kh hh ig b ih kp il kq ip kr it ks ix kt jb kl km kn ko bi translated">数据格式(在我们的例子中设置为json)、JSON内容(在我们的例子中设置为多个JSON对象)、Bucket、身份验证方法和对象名称后缀(在我们的例子中设置为JSON)。有关其他配置属性的更多详细信息，<a class="ae jc" href="https://streamsets.com/documentation/datacollector/latest/help/datacollector/UserGuide/Origins/AmazonS3.html#concept_kvs_3hh_ht" rel="noopener ugc nofollow" target="_blank">点击此处</a>。</li></ul><h1 id="b68a" class="jd je hh bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">JDBC查询</h1><ul class=""><li id="bc14" class="kg kh hh ig b ih kb il kc ip ki it kj ix kk jb kl km kn ko bi translated"><a class="ae jc" href="https://streamsets.com/documentation/datacollector/latest/help/datacollector/UserGuide/Executors/JDBCQuery.html#concept_j3r_gcv_sx" rel="noopener ugc nofollow" target="_blank"> JDBC查询执行器</a>是<a class="ae jc" href="https://streamsets.com/learn/data-pipelines/" rel="noopener ugc nofollow" target="_blank">数据管道</a>封装的地方！</li><li id="5794" class="kg kh hh ig b ih kp il kq ip kr it ks ix kt jb kl km kn ko bi translated">一些重要的配置属性包括:</li><li id="892a" class="kg kh hh ig b ih kp il kq ip kr it ks ix kt jb kl km kn ko bi translated">JDBC连接字符串(格式为<em class="ku">JDBC:Redshift://&lt;hostname&gt;:&lt;port&gt;/&lt;dbname&gt;</em>)和连接到Amazon Redshift集群的凭证。</li><li id="2512" class="kg kh hh ig b ih kp il kq ip kr it ks ix kt jb kl km kn ko bi translated">前置条件设置为<em class="ku"> ${record:eventType() == "S3对象已写入" } </em></li><li id="c33d" class="kg kh hh ig b ih kp il kq ip kr it ks ix kt jb kl km kn ko bi translated">将PostgreSQL CDC数据从亚马逊S3加载(特别是插入和更新)到Redshift的SQL查询作为一个upsert操作，包括首先从亚马逊S3加载数据的亚马逊复制命令。</li></ul><pre class="kv kw kx ky fd kz la lb lc aw ld bi"><span id="7763" class="le je hh la b fi lf lg l lh li">BEGIN transaction;<br/><br/>CREATE TABLE ${REDSHIFT_SCHEMA}.t_staging (LIKE ${REDSHIFT_SCHEMA}.${REDSHIFT_TABLE});<br/><br/>COPY ${REDSHIFT_SCHEMA}.t_staging <br/>FROM '${AWS_BUCKET}'<br/>CREDENTIALS 'aws_access_key_id=${AWS_KEY};aws_secret_access_key=${AWS_SECRET}' <br/>FORMAT AS JSON 'auto';<br/><br/>UPDATE ${REDSHIFT_SCHEMA}.${REDSHIFT_TABLE}<br/>SET name = s.name, type = s.type, funding = s.funding<br/>FROM ${REDSHIFT_SCHEMA}.t_staging s<br/>WHERE ${REDSHIFT_TABLE}.id = s.id;<br/><br/>INSERT INTO ${REDSHIFT_SCHEMA}.${REDSHIFT_TABLE}<br/>SELECT s.* FROM ${REDSHIFT_SCHEMA}.t_staging s LEFT JOIN ${REDSHIFT_SCHEMA}.${REDSHIFT_TABLE}<br/>ON s.id = ${REDSHIFT_SCHEMA}.${REDSHIFT_TABLE}.id<br/>WHERE ${REDSHIFT_SCHEMA}.${REDSHIFT_TABLE}.id IS NULL;<br/><br/>DROP TABLE ${REDSHIFT_SCHEMA}.t_staging;<br/><br/>END transaction;</span></pre><p id="c8e8" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">下面是上面一组SQL查询中发生的情况:</p><ul class=""><li id="d9a5" class="kg kh hh ig b ih ii il im ip ls it lt ix lu jb kl km kn ko bi translated">开始事务—作为一个整体提交的单个逻辑工作单元</li><li id="cf4b" class="kg kh hh ig b ih kp il kq ip kr it ks ix kt jb kl km kn ko bi translated">在Redshift中创建临时(" ")表，其模式与标识为${ <em class="ku"> REDSHIFT_TABLE} </em>的主表相同</li><li id="408a" class="kg kh hh ig b ih kp il kq ip kr it ks ix kt jb kl km kn ko bi translated">使用命令将亚马逊S3上以JSON格式存储的PostgreSQL CDC数据加载到Redshift中的临时表(" ")中</li><li id="75cf" class="kg kh hh ig b ih kp il kq ip kr it ks ix kt jb kl km kn ko bi translated">执行查询以更新临时(“t_staging”)表和标识为${ <em class="ku"> REDSHIFT_TABLE} </em>的主表之间主键匹配的所有记录</li><li id="97a7" class="kg kh hh ig b ih kp il kq ip kr it ks ix kt jb kl km kn ko bi translated">如果临时(“t_staging”)表中的记录主键在标识为${ <em class="ku"> REDSHIFT_TABLE} </em>的主表中不存在，则执行查询以在主表中插入新记录</li><li id="4fb6" class="kg kh hh ig b ih kp il kq ip kr it ks ix kt jb kl km kn ko bi translated">删除临时(" t_staging ")表</li><li id="f985" class="kg kh hh ig b ih kp il kq ip kr it ks ix kt jb kl km kn ko bi translated">结束事务—提交当前事务</li></ul><p id="68bc" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi"> <em class="ku">注</em> </strong> : <em class="ku">上述SQL查询中引用的REDSHIFT_SCHEMA、REDSHIFT_TABLE、AWS_BUCKET、AWS_KEY和AWS_SECRET </em>被定义为管道参数，<a class="ae jc" href="https://streamsets.com/blog/13-data-engineering-best-practices-at-dnb/" rel="noopener ugc nofollow" target="_blank">13个数据工程最佳实践</a>之一，以便使管道可重用(例如，通过<a class="ae jc" href="https://streamsets.com/documentation/controlhub/latest/help/controlhub/UserGuide/Jobs/JobTemplates.html#concept_bkh_nzb_4fb" rel="noopener ugc nofollow" target="_blank">作业模板</a>用于其他模式和表)，并尽可能保持SQL查询集的动态性。</p><h1 id="67ce" class="jd je hh bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">摘要</h1><p id="36f7" class="pw-post-body-paragraph ie if hh ig b ih kb ij ik il kc in io ip kd ir is it ke iv iw ix kf iz ja jb ha bi translated">在这篇文章中，我回顾了通过利用和集成像<a class="ae jc" href="https://streamsets.com/products/dataops-platform/data-collector/" rel="noopener ugc nofollow" target="_blank"> StreamSets Data Collector </a>和Amazon Web Services这样的技术所实现的价值。</p><p id="fe64" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">了解更多关于<a class="ae jc" href="https://streamsets.com/getting-started/building-data-pipelines/" rel="noopener ugc nofollow" target="_blank">用流集</a>构建数据管道、<a class="ae jc" href="https://streamsets.com/blog/oracle-19c-bulk-ingest-and-change-data-capture-into-databricks-delta-lake/" rel="noopener ugc nofollow" target="_blank">如何处理来自Oracle 19c数据库的CDC信息</a>以及<a class="ae jc" href="https://streamsets.com/solutions/streamsets-for-aws/" rel="noopener ugc nofollow" target="_blank">亚马逊Web服务的流集</a>的信息。</p><p id="3d06" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">如果你喜欢这个话题，并希望继续围绕数据工程展开类似的对话，请通过<a class="ae jc" href="https://www.linkedin.com/in/dash-desai/" rel="noopener ugc nofollow" target="_blank"> LinkedIn </a>和<a class="ae jc" href="https://twitter.com/iamontheinet" rel="noopener ugc nofollow" target="_blank"> Twitter </a>与我联系。</p></div><div class="ab cl lv lw go lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="ha hb hc hd he"><p id="03b0" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><em class="ku">原载于2021年4月8日https://streamsets.com</em><a class="ae jc" href="https://streamsets.com/blog/load-change-data-capture-data-from-postgresql-to-amazon-redshift-using-streamsets/" rel="noopener ugc nofollow" target="_blank"><em class="ku"/></a><em class="ku">。</em></p></div></div>    
</body>
</html>