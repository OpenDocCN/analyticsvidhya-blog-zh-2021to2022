<html>
<head>
<title>Convert Doc or Docx to pdf using AWS Lambda</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用AWS Lambda将Doc或Docx转换为pdf</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/convert-word-to-pdf-using-aws-lambda-cb111be0d685?source=collection_archive---------0-----------------------#2021-11-30">https://medium.com/analytics-vidhya/convert-word-to-pdf-using-aws-lambda-cb111be0d685?source=collection_archive---------0-----------------------#2021-11-30</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="32c9" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">word —&gt;零管理pdf！</h2></div><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es ix"><img src="../Images/3293098a2fcb678392f5f19659cd51c7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*tX_ivaBDJT-DjarT.png"/></div></div></figure><h2 id="631d" class="jj jk hi bd jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg bi translated">目录:</h2><p id="fb7b" class="pw-post-body-paragraph kh ki hi kj b kk kl ij km kn ko im kp ju kq kr ks jy kt ku kv kc kw kx ky kz hb bi translated">∘ <a class="ae la" href="#fb4d" rel="noopener ugc nofollow">简介</a> <br/> ∘ <a class="ae la" href="#13af" rel="noopener ugc nofollow">创意</a> <br/> ∘ <a class="ae la" href="#c7c9" rel="noopener ugc nofollow">预建图层</a><br/>∘<a class="ae la" href="#49ab" rel="noopener ugc nofollow">brotlipy</a><br/>∘<a class="ae la" href="#7bac" rel="noopener ugc nofollow">最后一步</a> <br/> ∘ <a class="ae la" href="#674c" rel="noopener ugc nofollow">快速预排</a></p><h2 id="fb4d" class="jj jk hi bd jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg bi translated">介绍</h2><p id="1105" class="pw-post-body-paragraph kh ki hi kj b kk kl ij km kn ko im kp ju kq kr ks jy kt ku kv kc kw kx ky kz hb bi translated">我们都在本地将doc转换为pdf，但问题是如何使用运行在Amazon Linux上的AWS无服务器计算引擎AWS Lambda进行转换。与有<code class="du lb lc ld le b">win32com</code>的windows不同，没有办法为API安装Microsoft office工具！</p><p id="70ea" class="pw-post-body-paragraph kh ki hi kj b kk lf ij km kn lg im kp ju lh kr ks jy li ku kv kc lj kx ky kz hb bi translated">我在网上搜索了很多其他的图书馆，它们在后台使用微软office，然后转换成pdf格式。此外，Microsoft office附带许可证费用。</p><p id="843b" class="pw-post-body-paragraph kh ki hi kj b kk lf ij km kn lg im kp ju lh kr ks jy li ku kv kc lj kx ky kz hb bi translated">谢天谢地，有一个开源工具LibreOffice，但是如何在一个无服务器的系统上安装它呢？为了不再浪费时间，我按照<a class="ae la" href="https://github.com/vladgolubev/serverless-libreoffice" rel="noopener ugc nofollow" target="_blank">这里</a>的步骤创建了我自己的LibreOffice层。它生成了一个brotli包<code class="du lb lc ld le b">lo.tar.br</code>文件，该文件是<a class="ae la" href="https://github.com/vladgolubev/serverless-libreoffice/releases/tag/v6.4.0.1" rel="noopener ugc nofollow" target="_blank"> LibreOffice v6.4.0.1 </a>。您也可以选择创建一个gzip。</p><p id="bdab" class="pw-post-body-paragraph kh ki hi kj b kk lf ij km kn lg im kp ju lh kr ks jy li ku kv kc lj kx ky kz hb bi translated">此外，还有一个与LibreOffice相关的命令工具，可用于转换为pdf。</p><pre class="iy iz ja jb fd lk le ll lm aw ln bi"><span id="cc06" class="jj jk hi le b fi lo lp l lq lr"><strong class="le hj">libreoffice</strong> [<strong class="le hj">--accept=</strong><em class="ls">accept-string</em>] [<strong class="le hj">--base</strong>] [<strong class="le hj">--calc</strong>] [<strong class="le hj">--convert-to</strong> output_file_extension[:output_filter_name] [--outdir output_dir] <em class="ls">file</em>]... [<strong class="le hj">--display </strong><em class="ls">display</em>] [<strong class="le hj">--draw</strong>] [<strong class="le hj">--global</strong>] [<strong class="le hj">--headless</strong>] [<strong class="le hj">--help</strong>|<strong class="le hj">-h</strong>|<strong class="le hj">-?</strong>] [<strong class="le hj">--impress</strong>] [<strong class="le hj">--invisible</strong>] [<strong class="le hj">--infilter="&lt;filter&gt;"</strong>] [<strong class="le hj">--math</strong>] [<strong class="le hj">--minimized</strong>] [<strong class="le hj">-n </strong><em class="ls">file</em>]... [<strong class="le hj">--nodefault</strong>] [<strong class="le hj">--nolockcheck</strong>] [<strong class="le hj">--nologo</strong>] [<strong class="le hj">--norestore</strong>] [<strong class="le hj">-o </strong><em class="ls">file</em>]... [<strong class="le hj">-p </strong><em class="ls">file</em>...] [<strong class="le hj">--print-to-file [--printer-name printer_name] [--outdir output_dir] file]... [--pt </strong><em class="ls">printername</em> <em class="ls">file</em>...] [<strong class="le hj">--show </strong><em class="ls">Impress file</em>]... [<strong class="le hj">--unaccept=</strong><em class="ls">accept-string</em>] [<strong class="le hj">--terminate_after_init</strong>] [<strong class="le hj">--view </strong><em class="ls">file</em>]... [<strong class="le hj">--web</strong>] [<strong class="le hj">--writer</strong>] [<em class="ls">file</em>...]</span></pre><p id="a637" class="pw-post-body-paragraph kh ki hi kj b kk lf ij km kn lg im kp ju lh kr ks jy li ku kv kc lj kx ky kz hb bi translated">对于docker用户:将文件<code class="du lb lc ld le b">lo.tar.br</code>放在/opt目录下。其余的事情将由代码在处理时负责。</p><pre class="iy iz ja jb fd lk le ll lm aw ln bi"><span id="a6bc" class="jj jk hi le b fi lo lp l lq lr"># Required for LibreOffice<br/>COPY ./path/lo.tar.br   /opt/</span></pre><h2 id="13af" class="jj jk hi bd jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg bi translated">想法</h2><p id="9377" class="pw-post-body-paragraph kh ki hi kj b kk kl ij km kn ko im kp ju kq kr ks jy kt ku kv kc kw kx ky kz hb bi translated">现在的想法是做以下事情(<em class="ls">大致是</em>):</p><ol class=""><li id="fa9e" class="lt lu hi kj b kk lf kn lg ju lv jy lw kc lx kz ly lz ma mb bi translated">这一层只是将<code class="du lb lc ld le b">/opt/lo.tar.br</code>或<code class="du lb lc ld le b">/opt/lo.tar.gz</code>文件添加到你的Lambda运行时中。</li><li id="6768" class="lt lu hi kj b kk mc kn md ju me jy mf kc mg kz ly lz ma mb bi translated">将Lambda执行期间的<code class="du lb lc ld le b">/opt/lo.tar.br</code>或<code class="du lb lc ld le b">/opt/lo.tar.gz</code>文件解压到<code class="du lb lc ld le b">/tmp</code>文件夹，该文件夹有512 MB的可用空间。</li><li id="6377" class="lt lu hi kj b kk mc kn md ju me jy mf kc mg kz ly lz ma mb bi translated">LibreOffice二进制文件将在<code class="du lb lc ld le b">/opt/instdir/program/soffice.bin</code>发布</li></ol><p id="6c9b" class="pw-post-body-paragraph kh ki hi kj b kk lf ij km kn lg im kp ju lh kr ks jy li ku kv kc lj kx ky kz hb bi translated">此外，如果您没有时间构建图层，可以使用一些预构建的arns。</p><h2 id="c7c9" class="jj jk hi bd jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg bi translated">预建层</h2><p id="3551" class="pw-post-body-paragraph kh ki hi kj b kk kl ij km kn ko im kp ju kq kr ks jy kt ku kv kc kw kx ky kz hb bi translated">AWS区域玩家ARN (brotli)美东-1 <code class="du lb lc ld le b">arn:aws:lambda:us-east-1:764866452798:layer:libreoffice-brotli:1</code>或<br/>T1】欧盟-西-1 <code class="du lb lc ld le b">arn:aws:lambda:eu-west-1:764866452798:layer:libreoffice-brotli:1</code>或<br/>T3】欧盟-中央-1 <code class="du lb lc ld le b">arn:aws:lambda:eu-central-1:764866452798:layer:libreoffice-brotli:1</code>或<br/>T5】美西-2 <code class="du lb lc ld le b">arn:aws:lambda:us-west-2:764866452798:layer:libreoffice-brotli:1</code>或<br/>T7】美东-2 <code class="du lb lc ld le b">arn:aws:lambda:us-east-2:764866452798:layer:libreoffice-brotli:1</code>或<br/>T9】AP-东南-2 <code class="du lb lc ld le b">arn:aws:lambda:ap-southeast-2:764866452798:layer:libreoffice-brotli:1</code>或<br/>T11】欧盟-西-2 <code class="du lb lc ld le b">arn:aws:lambda:eu-west-2:764866452798:layer:libreoffice-brotli:1</code>或<br/><code class="du lb lc ld le b">arn:aws:lambda:eu-west-2:764866452798:layer:libreoffice-gzip:1</code>AP-东南-1<code class="du lb lc ld le b">arn:aws:lambda:ap-southeast-2:764866452798:layer:libreoffice-gzip:1</code></p><h2 id="49ab" class="jj jk hi bd jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg bi translated">布罗特利比</h2><p id="bed7" class="pw-post-body-paragraph kh ki hi kj b kk kl ij km kn ko im kp ju kq kr ks jy kt ku kv kc kw kx ky kz hb bi translated">该库包含参考Brotli编码器/解码器的Python绑定，<a class="ae la" href="https://github.com/google/brotli" rel="noopener ugc nofollow" target="_blank">可从这里</a>获得。这允许Python软件直接从Python代码中使用Brotli压缩算法。</p><p id="312b" class="pw-post-body-paragraph kh ki hi kj b kk lf ij km kn lg im kp ju lh kr ks jy li ku kv kc lj kx ky kz hb bi translated">下一步是为brotlipy构建一个层。我为自己创建了一个并保存在这里以备再次使用—</p><div class="mh mi ez fb mj mk"><a href="https://github.com/kuharan/Lambda-Layers" rel="noopener  ugc nofollow" target="_blank"><div class="ml ab dw"><div class="mm ab mn cl cj mo"><h2 class="bd hj fi z dy mp ea eb mq ed ef hh bi translated">GitHub-kuharan/Lambda-Layers:python的AWS lambda层集合。</h2><div class="mr l"><h3 class="bd b fi z dy mp ea eb mq ed ef dx translated">python的AWS lambda图层集合。寻找开发者和开源贡献者来为…构建层</h3></div><div class="ms l"><p class="bd b fp z dy mp ea eb mq ed ef dx translated">github.com</p></div></div><div class="mt l"><div class="mu l mv mw mx mt my jh mk"/></div></div></a></div><p id="d788" class="pw-post-body-paragraph kh ki hi kj b kk lf ij km kn lg im kp ju lh kr ks jy li ku kv kc lj kx ky kz hb bi translated">将这个也添加到图层中。所以我们有两层功能。</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es mz"><img src="../Images/3a1bcf287d22867d1202671739f791f0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*iHpIGbPHtcyO8MFu23SgPw.png"/></div></div></figure><h2 id="7bac" class="jj jk hi bd jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg bi translated">最后一步</h2><p id="ef51" class="pw-post-body-paragraph kh ki hi kj b kk kl ij km kn ko im kp ju kq kr ks jy kt ku kv kc kw kx ky kz hb bi translated">下面是python 3.8中用于转换的快速代码。</p><pre class="iy iz ja jb fd lk le ll lm aw ln bi"><span id="8fd1" class="jj jk hi le b fi lo lp l lq lr">import os<br/>from io import BytesIO<br/>import tarfile<br/>import boto3<br/>import subprocess<br/>import brotli</span><span id="31a0" class="jj jk hi le b fi na lp l lq lr">libre_office_install_dir = '/tmp/instdir'</span><span id="03f2" class="jj jk hi le b fi na lp l lq lr">def load_libre_office():<br/>    if os.path.exists(libre_office_install_dir) and os.path.isdir(libre_office_install_dir):<br/>        print('We have a cached copy of LibreOffice, skipping extraction')<br/>    else:<br/>        print('No cached copy of LibreOffice, extracting tar stream from Brotli file.')<br/>        buffer = BytesIO()<br/>        with open('/opt/lo.tar.br', 'rb') as brotli_file:<br/>            d = brotli.Decompressor()<br/>            while True:<br/>                chunk = brotli_file.read(1024)<br/>                buffer.write(d.decompress(chunk))<br/>                if len(chunk) &lt; 1024:<br/>                    break<br/>            buffer.seek(0)</span><span id="5605" class="jj jk hi le b fi na lp l lq lr">print('Extracting tar stream to /tmp for caching.')<br/>        with tarfile.open(fileobj=buffer) as tar:<br/>            tar.extractall('/tmp')<br/>        print('Done caching LibreOffice!')</span><span id="c006" class="jj jk hi le b fi na lp l lq lr">return f'{libre_office_install_dir}/program/soffice.bin'</span><span id="d6d4" class="jj jk hi le b fi na lp l lq lr">def download_from_s3(bucket, key, download_path):<br/>    s3 = boto3.client("s3")<br/>    s3.download_file(bucket, key, download_path)</span><span id="525f" class="jj jk hi le b fi na lp l lq lr">def upload_to_s3(file_path, bucket, key):<br/>    s3 = boto3.client("s3")<br/>    s3.upload_file(file_path, bucket, key)</span><span id="de42" class="jj jk hi le b fi na lp l lq lr">def convert_word_to_pdf(soffice_path, word_file_path, output_dir):<br/>    conv_cmd = f"{soffice_path} --headless --norestore --invisible --nodefault --nofirststartwizard --nolockcheck --nologo --convert-to pdf:writer_pdf_Export --outdir {output_dir} {word_file_path}"<br/>    response = subprocess.run(conv_cmd.split(), stdout=subprocess.PIPE, stderr=subprocess.PIPE)<br/>    if response.returncode != 0:<br/>        response = subprocess.run(conv_cmd.split(), stdout=subprocess.PIPE, stderr=subprocess.PIPE)<br/>        if response.returncode != 0:<br/>            return False<br/>    return True</span><span id="98a4" class="jj jk hi le b fi na lp l lq lr">def lambda_handler(event, context):<br/>    bucket = "xxxx"<br/>    key = "xxxx/xxxx/xxxx/xxxx/SampleDoc.docx"<br/>    key_prefix, base_name = os.path.split(key)<br/>    download_path = f"/tmp/{base_name}"<br/>    output_dir = "/tmp"</span><span id="1be9" class="jj jk hi le b fi na lp l lq lr">download_from_s3(bucket, key, download_path)</span><span id="f1f2" class="jj jk hi le b fi na lp l lq lr">soffice_path = load_libre_office()<br/>    <br/>    is_converted = convert_word_to_pdf(soffice_path, download_path, output_dir)<br/>    if is_converted:<br/>        file_name, _ = os.path.splitext(base_name)<br/>        upload_to_s3(f"{output_dir}/{file_name}.pdf", bucket, f"{key_prefix}/{file_name}.pdf")<br/>        return {"response": "file converted to PDF and available at same S3 location of input key"}<br/>    else:<br/>        return {"response": "cannot convert this document to PDF"}</span></pre><h2 id="674c" class="jj jk hi bd jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg bi translated">快速演练</h2><p id="cab7" class="pw-post-body-paragraph kh ki hi kj b kk kl ij km kn ko im kp ju kq kr ks jy kt ku kv kc kw kx ky kz hb bi translated"><strong class="kj hj"> load_libre_office </strong>会通过在tmp中解压libre office来安装libre office，如果不存在的话，每次都会重复使用，直到功能热起来。</p><p id="559b" class="pw-post-body-paragraph kh ki hi kj b kk lf ij km kn lg im kp ju lh kr ks jy li ku kv kc lj kx ky kz hb bi translated">函数<strong class="kj hj"> download_from_s3 </strong>会将word文件下载到tmp中，<strong class="kj hj"> convert_word_to_pdf </strong>会将其转换，<strong class="kj hj"> upload_to_s3 </strong>会将其上传到s3中。</p><p id="21b7" class="pw-post-body-paragraph kh ki hi kj b kk lf ij km kn lg im kp ju lh kr ks jy li ku kv kc lj kx ky kz hb bi translated"><strong class="kj hj"> convert_word_to_pdf </strong>使用子流程运行转换命令。</p><p id="7b9e" class="pw-post-body-paragraph kh ki hi kj b kk lf ij km kn lg im kp ju lh kr ks jy li ku kv kc lj kx ky kz hb bi translated">目前，这个东西把pdf放在同一个位置，但你可以随时修改它，把它放在其他位置。</p><blockquote class="nb nc nd"><p id="ceef" class="kh ki ls kj b kk lf ij km kn lg im kp ne lh kr ks nf li ku kv ng lj kx ky kz hb bi translated">重要的是整个包的大小仍然是1.1 KB。</p></blockquote><p id="ffb6" class="pw-post-body-paragraph kh ki hi kj b kk lf ij km kn lg im kp ju lh kr ks jy li ku kv kc lj kx ky kz hb bi translated">希望这有助于解决大混乱。感谢您的阅读。喜欢就给它鼓掌。如果有问题，请在下面的评论中告诉我。我很乐意帮忙。下次见。再见！</p></div></div>    
</body>
</html>