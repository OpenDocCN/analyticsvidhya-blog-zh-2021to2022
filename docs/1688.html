<html>
<head>
<title>How to speed up detection in Detectron2</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何加快检测器2的检测速度</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/how-to-speed-up-detection-in-detectron2-263e9e1472e4?source=collection_archive---------1-----------------------#2021-03-13">https://medium.com/analytics-vidhya/how-to-speed-up-detection-in-detectron2-263e9e1472e4?source=collection_archive---------1-----------------------#2021-03-13</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="9ebe" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">无需定制训练模型，提高FPS的简单提示和技巧。</p><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="ji jj di jk bf jl"><div class="er es jc"><img src="../Images/1e0a9369593810a7a7692c034e44c1f4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*DajooaFzv-r1qYfA"/></div></div><figcaption class="jo jp et er es jq jr bd b be z dx translated">马修·布罗德在<a class="ae js" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</figcaption></figure><h1 id="b9cf" class="jt ju hh bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated"><strong class="ak">什么是探测器2？</strong></h1><p id="58ce" class="pw-post-body-paragraph ie if hh ig b ih kr ij ik il ks in io ip kt ir is it ku iv iw ix kv iz ja jb ha bi translated">Detectron2是由脸书人工智能研究所开发的用于目标检测的下一代软件系统。</p><p id="54f4" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">目标检测是指识别、定位和预测图像中目标的属性。</p><p id="f36f" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><em class="kw">你可以在这里找到</em><strong class="ig hi"><em class="kw"/></strong><a class="ae js" href="https://github.com/facebookresearch/detectron2" rel="noopener ugc nofollow" target="_blank"><strong class="ig hi"><em class="kw"/></strong></a><em class="kw">。</em></p><p id="9c12" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">Detectron2是一个存储库，可用于实例分割、包围盒检测、人物关键点检测和语义分割等检测任务。</p><p id="3cdb" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">使用的数据集是COCO(上下文中的公共对象)，LVIS(大词汇实例分割)，CityScapes，PascalVOC。</p><p id="1022" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">探测器2已经很快了，推理时间更少。这可以进一步减少。</p><p id="f6c1" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi"> </strong> <a class="ae js" href="https://github.com/facebookresearch/detectron2/blob/master/MODEL_ZOO.md" rel="noopener ugc nofollow" target="_blank"> <strong class="ig hi">模型动物园</strong> </a> <strong class="ig hi"> </strong>中提到的推断时间是相对于为各自的配置文件指定的图像尺寸而言的。</p><h1 id="24b3" class="jt ju hh bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated"><strong class="ak">如何加快检测速度？</strong></h1><p id="3b00" class="pw-post-body-paragraph ie if hh ig b ih kr ij ik il ks in io ip kt ir is it ku iv iw ix kv iz ja jb ha bi translated">提高FPS的一种方法是通过<strong class="ig hi">降低</strong> <strong class="ig hi">你的图像分辨率</strong>。图像分辨率越低，每幅图像的推断速度越快。</p><p id="c37a" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">图像分辨率低于模型动物园中提到的分辨率将有助于加快进程，特别是如果你用它来视频，几毫秒的区别。</p></div><div class="ab cl kx ky go kz" role="separator"><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc"/></div><div class="ha hb hc hd he"><p id="9a43" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">另一种方法是通过<strong class="ig hi">跳过帧</strong>当使用视频输入并且视频中没有快速移动时，跳过几帧不会造成伤害，因为不会丢失主要信息。</p></div><div class="ab cl kx ky go kz" role="separator"><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc"/></div><div class="ha hb hc hd he"><p id="e8b5" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">除了跳过帧，在读取帧时应用<strong class="ig hi">线程</strong>。确保只处理最新的帧。在predictor.py中进行预测之前，您可能需要在这方面做一些更改。</p><p id="0ae9" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">如果你想加速可视化过程，Detctron2提供了并行处理。</p><p id="627b" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在predictor.py中:<br/>更改<strong class="ig hi"> parallel=True </strong>以在不同的进程中运行模型。</p><p id="c0be" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">你也可以在预测的时候改变颜色模式。Detectron2为<strong class="ig hi">实例可视化</strong>提供了3种模式。</p><ol class=""><li id="43bf" class="le lf hh ig b ih ii il im ip lg it lh ix li jb lj lk ll lm bi translated"><strong class="ig hi"> IMAGE = 0 </strong> <em class="kw">为每个实例随机选取一种颜色，用低不透明度叠加分割。</em></li><li id="163b" class="le lf hh ig b ih ln il lo ip lp it lq ix lr jb lj lk ll lm bi translated"><strong class="ig hi"> SEGMENTATION = 1 </strong> <em class="kw">让同一类别的实例有相似的颜色(来自metadata.thing_colors)，用<br/>高不透明度叠加。这提供了对分割质量的更多关注。</em></li><li id="2739" class="le lf hh ig b ih ln il lo ip lp it lq ix lr jb lj lk ll lm bi translated"><strong class="ig hi"> IMAGE_BW = 2 </strong>仅可用于绘制每个实例的遮罩预测。</li></ol></div><div class="ab cl kx ky go kz" role="separator"><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc"/></div><div class="ha hb hc hd he"><p id="9017" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">Detectron2涵盖了大部分类别。可能的情况是，您只想从该帧中检测几个类。</p><p id="4c9a" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">为了对这几个类使用现有的代码，我们首先需要获得类的列表和它们对应的类id。</p><p id="1d1c" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">要获取类别列表，您可以点击<a class="ae js" href="https://detectron2.readthedocs.io/tutorials/datasets.html" rel="noopener ugc nofollow" target="_blank">此链接，</a>并用您正在使用的数据集替换您的数据集。一般我们用coco 2017数据集。</p><pre class="jd je jf jg fd ls lt lu lv aw lw bi"><span id="aad8" class="lx ju hh lt b fi ly lz l ma mb">from detectron2.data import MetadataCatalog<br/>MetadataCatalog.get("coco_2017_val").thing_classes = ["person", "car"]</span></pre><p id="7866" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">或者你也可以直接在数据集中寻找类</p><p id="185e" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">对我来说，我使用detectron2进行全景分割，我需要知道用于定制的类id。</p><p id="c9c4" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在语义类的COCO数据集中，我们有两个部分</p><p id="e30e" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">对于像汽车或人这样具有明确形状的类，我们有<strong class="ig hi">事物类</strong> <br/>，对于无定形的背景区域、天空、道路或草地，我们有<strong class="ig hi">填充类</strong>。</p><p id="4bf9" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在COCO- <strong class="ig hi"> Stuff </strong>数据集中，除了COCO中的80个<strong class="ig hi"> thing </strong>类，我们还有91个Stuff类。</p><p id="d3ea" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">附加的东西注释使得能够研究复杂COCO图像中的东西之间的交互。</p><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="ji jj di jk bf jl"><div class="er es mc"><img src="../Images/8ee9969007424fdb753cf8a2b80ca09b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nlIGmJFJ58eTltA_DZvyyA.png"/></div></div></figure><p id="1dd1" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">如果你想知道更多关于如何以及为什么考虑东西类会更好地理解场景，你可以参考<a class="ae js" href="https://arxiv.org/abs/1612.03716" rel="noopener ugc nofollow" target="_blank"> <strong class="ig hi">论文</strong> </a> <strong class="ig hi"> </strong>。</p><p id="24ae" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">现在，为了获得类id、名称及其颜色的列表，我们可以参考<strong class="ig hi"> builtin_meta.py </strong>，你可以在datasets文件夹中找到它。</p><figure class="jd je jf jg fd jh er es paragraph-image"><div class="er es md"><img src="../Images/6fb01cb79d795ad0224799bdf3da34b8.png" data-original-src="https://miro.medium.com/v2/resize:fit:988/format:webp/1*eChxsWyVEuaYDURBkfHoGA.png"/></div><figcaption class="jo jp et er es jq jr bd b be z dx translated">东西类和东西类</figcaption></figure><p id="bdb8" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">一旦你有了自己的“<strong class="ig hi"> category_id </strong>”，你就可以开始定制了。</p><p id="881f" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">为此，您可以在<strong class="ig hi"> video_visualizer.py </strong>或<strong class="ig hi"> visualizer.py </strong>中进行更改</p><pre class="jd je jf jg fd ls lt lu lv aw lw bi"><span id="17bf" class="lx ju hh lt b fi ly lz l ma mb">for mask, sinfo in pred.semantic_masks():<br/>    category = sinfo["category_id"]<br/>    if category == 3:<br/>        category_idx = sinfo["category_id"]</span></pre><p id="c3c8" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我在做材料类的工作，因此对我来说是=0。并且category_id=9表示花。</p><p id="722e" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">你也可以根据需要改变你的班级的颜色。</p><p id="8a95" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在同一个帧中使用以上所有内容，我能够在RTX 2060上实现10 的<strong class="ig hi"> FPS，用于检测2个类别，此时COCO全景FPN的全景分割基线为<strong class="ig hi"> 3 FPS </strong>(所有类别)<strong class="ig hi">。</strong></strong></p></div><div class="ab cl kx ky go kz" role="separator"><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc"/></div><div class="ha hb hc hd he"><blockquote class="me mf mg"><p id="17f4" class="ie if kw ig b ih ii ij ik il im in io mh iq ir is mi iu iv iw mj iy iz ja jb ha bi translated">我是一名电子和电信工程师。我发现数据科学很迷人，这就是为什么我决定学习机器学习和大数据分析，目前担任人工智能工程师。希望能为这个不断成长的数据科学社会做点贡献。你可以在<a class="ae js" href="https://www.linkedin.com/in/anuja-ihare-a5b622b7" rel="noopener ugc nofollow" target="_blank"> <strong class="ig hi"> LinkedIn </strong> </a>上联系我。</p></blockquote></div></div>    
</body>
</html>