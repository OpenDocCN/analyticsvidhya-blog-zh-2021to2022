<html>
<head>
<title>Bulk data ingestion from S3 into DynamoDB via AWS Lambda</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">通过AWS Lambda将大量数据从S3接收到DynamoDB</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/bulk-data-ingestion-from-s3-into-dynamodb-via-aws-lambda-b5bdc30bd5cd?source=collection_archive---------1-----------------------#2021-05-18">https://medium.com/analytics-vidhya/bulk-data-ingestion-from-s3-into-dynamodb-via-aws-lambda-b5bdc30bd5cd?source=collection_archive---------1-----------------------#2021-05-18</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="44e8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">假设我们有一个excel或CSV格式的大型数据库，我们希望通过将它加载到DynamoDB中来激活它。本文通过利用AWS Lambda服务提出了一种解决这个问题的简化方法。</p><div class="jd je jf jg fd ab cb"><figure class="jh ji jj jk jl jm jn paragraph-image"><img src="../Images/14b0a8dd04be4483bb4f731e2c965a46.png" data-original-src="https://miro.medium.com/v2/resize:fit:666/format:webp/1*XJddQMTNf9cEF_Yz53C3-g.png"/></figure><figure class="jh ji jq jk jl jm jn paragraph-image"><div role="button" tabindex="0" class="jr js di jt bf ju"><img src="../Images/0bf72677e98601f1e875dd4c0d8b3c6d.png" data-original-src="https://miro.medium.com/v2/resize:fit:648/format:webp/1*sVS-h4yLW3Nj-4rVeMrRxA.png"/></div></figure><figure class="jh ji jj jk jl jm jn paragraph-image"><div role="button" tabindex="0" class="jr js di jt bf ju"><img src="../Images/3ff170aacf98d3c473298aa0ac4246d0.png" data-original-src="https://miro.medium.com/v2/resize:fit:678/format:webp/1*odf6L9hzW0fp9q2EH7zD8g.png"/></div></figure></div><p id="4d4f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">本文的其余部分详细解释了这些步骤:</p><ol class=""><li id="1f3b" class="jv jw hi ih b ii ij im in iq jx iu jy iy jz jc ka kb kc kd bi translated">创建一个存储桶并上传您的数据</li></ol><p id="0faf" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">2.创建具有所需权限的IAM角色</p><p id="79a7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">3.配置Lambda函数。</p><p id="ed25" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">4.将代码添加到Lambda函数中</p></div><div class="ab cl ke kf gp kg" role="separator"><span class="kh bw bk ki kj kk"/><span class="kh bw bk ki kj kk"/><span class="kh bw bk ki kj"/></div><div class="hb hc hd he hf"><h1 id="2477" class="kl km hi bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">将您的数据上传到S3</h1><p id="249d" class="pw-post-body-paragraph if ig hi ih b ii lj ik il im lk io ip iq ll is it iu lm iw ix iy ln ja jb jc hb bi translated">首先，将您的CSV数据放入S3存储桶。您可以通过编程或通过AWS帐户控制台来实现这一点。出于安全目的，您可以阻止对您的存储桶的所有公共访问。Lambda函数将通过适当的IAM策略以编程方式访问您的bucket内容。我们将在下面的章节中讨论这一点。</p><figure class="jd je jf jg fd ji er es paragraph-image"><div role="button" tabindex="0" class="jr js di jt bf ju"><div class="er es lo"><img src="../Images/d47a65cf6fb6727e523ef2e2027f0dd3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*23jTzjH31i18H3W9S3Zaag.png"/></div></div><figcaption class="lp lq et er es lr ls bd b be z dx translated"><strong class="bd kn">图一。创建存储桶和CSV文件</strong></figcaption></figure><figure class="jd je jf jg fd ji er es paragraph-image"><div role="button" tabindex="0" class="jr js di jt bf ju"><div class="er es lt"><img src="../Images/acd05f24c76516301140d0c22117abdd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DTECbMCmA5zhVeUmkfM1wA.png"/></div></div><figcaption class="lp lq et er es lr ls bd b be z dx translated"><strong class="bd kn">图二。阻止您的存储桶上的所有公共访问</strong></figcaption></figure><h1 id="a1dc" class="kl km hi bd kn ko lu kq kr ks lv ku kv kw lw ky kz la lx lc ld le ly lg lh li bi translated">具有S3和DynamoDB访问权限的IAM策略</h1><p id="00ae" class="pw-post-body-paragraph if ig hi ih b ii lj ik il im lk io ip iq ll is it iu lm iw ix iy ln ja jb jc hb bi translated">下一步是创建一个IAM角色，该角色具有访问S3存储桶和DynamoDB表所需的权限。出于我们的目的，亚马逊管理的两个策略是:</p><ol class=""><li id="e008" class="jv jw hi ih b ii ij im in iq jx iu jy iy jz jc ka kb kc kd bi translated">亚马逊3ReadOnlyAccess</li><li id="f9cf" class="jv jw hi ih b ii lz im ma iq mb iu mc iy md jc ka kb kc kd bi translated">AmazonDynamoDBFullAccess</li></ol><p id="f8b4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">因为我们只会读取S3桶的内容，所以我添加了AmazonS3ReadOnlyAccess。因为我们将创建它并将其插入DynamoDB表中，所以我添加了AmazonDynamoDBFullAccess策略并创建了一个IAM角色。</p><figure class="jd je jf jg fd ji er es paragraph-image"><div role="button" tabindex="0" class="jr js di jt bf ju"><div class="er es me"><img src="../Images/8f6400164c4d7bdb608dee376c5541d7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*AnYNuBY9e0_AjRZgHh_fFg.png"/></div></div><figcaption class="lp lq et er es lr ls bd b be z dx translated"><strong class="bd kn">图3。创建一个IAM角色</strong></figcaption></figure><h1 id="de22" class="kl km hi bd kn ko lu kq kr ks lv ku kv kw lw ky kz la lx lc ld le ly lg lh li bi translated">创建Lambda函数</h1><p id="380d" class="pw-post-body-paragraph if ig hi ih b ii lj ik il im lk io ip iq ll is it iu lm iw ix iy ln ja jb jc hb bi translated">既然我们的数据和权限已经准备好了，我们现在可以创建一个Lambda函数，它将执行从S3读取数据并将其接收到DynamoDB表中的任务。这里的关键步骤是将我们在上一步中创建的IAM角色附加到permission部分中的Lambda函数。这将允许我们的lambda函数代码以编程方式访问S3和DynamoDB。</p><figure class="jd je jf jg fd ji er es paragraph-image"><div role="button" tabindex="0" class="jr js di jt bf ju"><div class="er es mf"><img src="../Images/b4e34549c4cf96e47c5e13f1067cf161.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SGAmJbfAEUv53iZ6WTBHig.png"/></div></div><figcaption class="lp lq et er es lr ls bd b be z dx translated"><strong class="bd kn">图4。λ函数创建</strong></figcaption></figure></div><div class="ab cl ke kf gp kg" role="separator"><span class="kh bw bk ki kj kk"/><span class="kh bw bk ki kj kk"/><span class="kh bw bk ki kj"/></div><div class="hb hc hd he hf"><p id="ca61" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">大部分配置工作已经完成。现在让我们进入这项任务的代码部分。这个活动的代码可以在我的<a class="ae mg" href="https://github.com/sathviksathu/S3_To_DynamoDB" rel="noopener ugc nofollow" target="_blank"><strong class="ih hj">Github Repo:S3 _ To _ dynamo db</strong></a><strong class="ih hj">中找到。</strong>我已经将下图所示的代码作为dockerized图像添加到Lambda中。</p><p id="d738" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">首先，我们需要创建一个boto3会话，并使用它来启动一个S3客户端。这可以通过以下方式完成:</p><figure class="jd je jf jg fd ji"><div class="bz dy l di"><div class="mh mi l"/></div><figcaption class="lp lq et er es lr ls bd b be z dx translated"><a class="ae mg" href="https://gist.github.com/c22471ca280e9a5d3eada211336cabcc.git" rel="noopener ugc nofollow" target="_blank">创建S3客户端</a></figcaption></figure><p id="5eb3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">接下来，我们可以添加从我们的S3桶中读取CSV文件并返回从中创建的pandas数据帧的功能。不幸的是，Lambda的默认python运行时环境没有随Pandas提供。查看我的另一篇进口熊猫的文章。</p><figure class="jd je jf jg fd ji"><div class="bz dy l di"><div class="mh mi l"/></div><figcaption class="lp lq et er es lr ls bd b be z dx translated"><a class="ae mg" href="https://gist.github.com/ed7582946f65e293005edc4b1d2f3861.git" rel="noopener ugc nofollow" target="_blank">将CSV加载到pandas数据帧中</a></figcaption></figure><p id="1e56" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们使用我们的S3客户端来<code class="du mj mk ml mm b"><strong class="ih hj">get_object</strong></code> <strong class="ih hj"> </strong>并传递Bucket的名称和CSV文件名作为参数。CSV文件内容将被提取到响应的<code class="du mj mk ml mm b"><strong class="ih hj">Body</strong></code> <strong class="ih hj"> </strong>字段，随后被读入数据帧。</p><p id="faf7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">下一步，我们可以开始创建DynamoDB表，我们将在其中接收数据。我们再次开始创建DynamoDB资源，如下所示:</p><figure class="jd je jf jg fd ji"><div class="bz dy l di"><div class="mh mi l"/></div><figcaption class="lp lq et er es lr ls bd b be z dx translated"><a class="ae mg" href="https://gist.github.com/231c663e4af8689be1bfbee23d6c84f4.git" rel="noopener ugc nofollow" target="_blank">创建DynamoDB资源</a></figcaption></figure><p id="d6dc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后，我们使用上面的资源创建一个DynamoDB表。在<a class="ae mg" href="https://boto3.amazonaws.com/v1/documentation/api/latest/guide/dynamodb.html" rel="noopener ugc nofollow" target="_blank">创建DynamoDB表</a>时，必须提及<code class="du mj mk ml mm b"><strong class="ih hj">TableName</strong></code>和<code class="du mj mk ml mm b"><strong class="ih hj">KeySchema </strong></code>细节。确保属性名称与CSV文件中的列标题名称匹配。</p><figure class="jd je jf jg fd ji"><div class="bz dy l di"><div class="mh mi l"/></div><figcaption class="lp lq et er es lr ls bd b be z dx translated"><a class="ae mg" href="https://gist.github.com/cfd530e2c2a1b42584343ca7a1eebb7a.git" rel="noopener ugc nofollow" target="_blank">创建一个DynamoDB表</a></figcaption></figure><p id="74c8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">既然我们已经初始化并配置了S3和DynamoDB客户端，在下一步中，我们将尝试逐行读取数据帧并将其写入表中。</p><figure class="jd je jf jg fd ji"><div class="bz dy l di"><div class="mh mi l"/></div><figcaption class="lp lq et er es lr ls bd b be z dx translated"><a class="ae mg" href="https://gist.github.com/14ef5fa002740d16c3a600eb1c44af25.git" rel="noopener ugc nofollow" target="_blank">将数据帧行摄取到表中</a></figcaption></figure><p id="8507" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们在表上初始化一个<code class="du mj mk ml mm b"><strong class="ih hj">batch_writer()</strong></code>,并将每个数据帧行作为一个条目放入表中。</p><p id="1097" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果您正在将大量数据读入表格，<a class="ae mg" href="https://boto3.amazonaws.com/v1/documentation/api/latest/guide/dynamodb.html" rel="noopener ugc nofollow" target="_blank"> Boto3文档</a>建议使用<code class="du mj mk ml mm b"><strong class="ih hj">batch_writer().</strong></code></p><blockquote class="mn mo mp"><p id="4c0f" class="if ig mq ih b ii ij ik il im in io ip mr ir is it ms iv iw ix mt iz ja jb jc hb bi translated">如果一次加载大量数据，可以利用<a class="ae mg" href="https://boto3.amazonaws.com/v1/documentation/api/latest/reference/services/dynamodb.html#DynamoDB.Table.batch_writer" rel="noopener ugc nofollow" target="_blank"> DynamoDB。Table.batch_writer() </a>这样既可以加快处理速度，又可以减少对服务的写请求数量。</p></blockquote><p id="27f1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在测试超时为10分钟的Lambda函数时，它成功地将7096条记录吸收到表中。速度取决于调配的读/写容量单位。我们需要对它们进行配置，以允许更高的数据摄取率。</p><figure class="jd je jf jg fd ji er es paragraph-image"><div role="button" tabindex="0" class="jr js di jt bf ju"><div class="er es mu"><img src="../Images/790d187ae1cb783ec128b4aaaf430730.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*x02YWy1FpYqdZgEYrjXwcQ.png"/></div></div><figcaption class="lp lq et er es lr ls bd b be z dx translated"><strong class="bd kn">图五。项目计数显示记录的数量</strong></figcaption></figure><p id="7a4c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> <em class="mq">感谢阅读。我希望你今天学到了新东西。</em> </strong></p></div></div>    
</body>
</html>