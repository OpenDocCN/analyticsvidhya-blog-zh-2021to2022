<html>
<head>
<title>Using AWS Lambda environment variables from local .env file (Python 3.7)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">从本地使用AWS Lambda环境变量。环境文件(Python 3.7)</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/using-aws-lambda-environment-variables-from-local-env-file-python-3-7-f3edacdea015?source=collection_archive---------3-----------------------#2021-01-19">https://medium.com/analytics-vidhya/using-aws-lambda-environment-variables-from-local-env-file-python-3-7-f3edacdea015?source=collection_archive---------3-----------------------#2021-01-19</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/6f0b45dd241b9ae04a2c8bad15fdb5f7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cFShMXtZ_4Ee1g5_N9bdRw.jpeg"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">由<a class="ae iu" href="https://unsplash.com/s/photos/lock?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的<a class="ae iu" href="https://unsplash.com/@imattsmart?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> iMattSmart </a>拍摄的照片</figcaption></figure><p id="7b0b" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">说到打造MVP，现在的创业公司更喜欢<a class="ae iu" href="https://aws.amazon.com/lambda/serverless-architectures-learn-more/" rel="noopener ugc nofollow" target="_blank">无服务器</a>。优点是:</p><ul class=""><li id="c032" class="jt ju hi ix b iy iz jc jd jg jv jk jw jo jx js jy jz ka kb bi translated">没有要管理的服务器。你只需要写函数。</li><li id="4e13" class="jt ju hi ix b iy kc jc kd jg ke jk kf jo kg js jy jz ka kb bi translated">持续扩展和任何规模下的一致性能。</li><li id="c339" class="jt ju hi ix b iy kc jc kd jg ke jk kf jo kg js jy jz ka kb bi translated">成本优化。您只需为消耗的计算时间付费。</li></ul><p id="d63f" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">对于任何架构来说，安全的编码实践总是很重要的。在今天的博客中，我将讨论这样一种实践——使用<strong class="ix hj">环境变量</strong>来存储<em class="kh">安全密钥</em>和<em class="kh">数据库凭证</em>,而不是将它们硬编码在您的代码中。</p><p id="190a" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这是我的第一个科技博客，所以请原谅我的任何技术或语法错误。评论将受到高度赞赏。所以事不宜迟，让我们深入AWS和它的美妙之处吧！</p><p id="2c3c" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">从2016年11月18日开始，为AWS Lambda添加了<a class="ae iu" href="https://aws.amazon.com/about-aws/whats-new/2016/11/aws-lambda-supports-environment-variables/" rel="noopener ugc nofollow" target="_blank">对环境变量的支持。根据AWS文件，</a></p><blockquote class="ki kj kk"><p id="3521" class="iv iw kh ix b iy iz ja jb jc jd je jf kl jh ji jj km jl jm jn kn jp jq jr js hb bi translated">这允许您在不修改或重新部署代码的情况下实现配置更改，并且应该使您的无服务器应用程序开发更加高效。每个环境变量都是一个键/值对。使用<a class="ae iu" href="https://aws.amazon.com/kms/" rel="noopener ugc nofollow" target="_blank"> AWS密钥管理服务(KMS) </a>对密钥和值进行加密，并根据需要进行解密。对于每个函数，环境变量的数量没有限制，但总大小不能超过4 kb。”</p></blockquote><p id="8053" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">有一种方法可以从您的<em class="kh"> AWS控制台</em>使用<em class="kh"> GUI工具</em>向您的lambda函数添加环境变量，但是我将向您展示如何使用Lambda API以编程方式完成此操作。</p><p id="78af" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我们有一个这样的lambda函数，其中我们的数据库凭证是硬编码的。这是不安全的，因为如果有人访问了您的源代码，那么您的安全性就会受到威胁。</p><figure class="kp kq kr ks fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ko"><img src="../Images/e4d5fd36fa2fc8d5a0479290fa67a2ea.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*aK39NxQhLP-oUlCZpneZRg.png"/></div></div></figure><p id="8036" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">相反，我们可以创建一个. env文件来本地存储DB凭证或任何其他安全密钥<strong class="ix hj"/>，然后在提交更改并将其推送到我们的远程存储库之前忽略该文件。</p><p id="9464" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><code class="du kt ku kv kw b">.env</code>文件以<strong class="ix hj">键-值</strong>对的形式包含凭证，值需要是字符串。<em class="kh">注意:稍后我们需要将端口转换为int，否则在连接到DB时将无法访问。</em></p><figure class="kp kq kr ks fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es kx"><img src="../Images/a5a948f7319c18045ef6f667bc3fe9af.png" data-original-src="https://miro.medium.com/v2/resize:fit:1116/format:webp/1*F_3fpcdTgr1By61velrIyQ.png"/></div></div></figure><p id="5d7e" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我们现在可以从我们的<em class="kh"> lambdaFunction.py </em>文件中删除硬编码的安全配置，因为我们现在有一个. env文件来处理它们。为了将本地环境变量导入我们的函数代码，我们需要导入<code class="du kt ku kv kw b"><a class="ae iu" href="https://docs.python.org/3/library/os.html" rel="noopener ugc nofollow" target="_blank">os</a></code>模块和<code class="du kt ku kv kw b"><a class="ae iu" href="https://pypi.org/project/python-dotenv/" rel="noopener ugc nofollow" target="_blank">python-dotenv</a></code>模块。<code class="du kt ku kv kw b">load_dotenv()</code>方法将从本地加载环境变量键。env文件和<code class="du kt ku kv kw b">os.environ.get(‘key’)</code>方法将返回环境变量的值或者不返回(如果键不存在)。一旦我们得到了这些值，我们就可以像这样在lambda函数中使用它们。</p><figure class="kp kq kr ks fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ky"><img src="../Images/be488924554cad9f2e2fd2177c70392c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7ZHvrYOHxiId8lD78vySSQ.png"/></div></div></figure><p id="8bbb" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">一旦这些步骤完成，我们将能够从本地机器连接到我们的远程MySQL服务器。我们仍然没有配置我们的代码从AWS Lambda运行，这将在下面的步骤中完成。<a class="ae iu" href="https://docs.aws.amazon.com/lambda/latest/dg/python-package.html" rel="noopener ugc nofollow" target="_blank">这里的</a>是把你的函数和依赖关系上传到AWS lambda的指令。</p><p id="94cd" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">假设您的函数已经在运行，我们现在需要配置一些东西。正如我前面提到的，环境变量是本地的，Lambda函数不能远程访问它。我们需要为每个lambda函数分别创建AWS Lambda环境变量(考虑到我们有不止一个Lambda函数)。幸运的是，我们可以通过使用Python的<code class="du kt ku kv kw b"><a class="ae iu" href="https://docs.python.org/3/library/subprocess.html" rel="noopener ugc nofollow" target="_blank"><strong class="ix hj">subprocess</strong></a> </code>模块和<strong class="ix hj"> Lambda API的脚本来自动完成这项任务。</strong></p><figure class="kp kq kr ks fd ij er es paragraph-image"><div class="er es kz"><img src="../Images/5af34cb2dea153109dfa7bfb5a853740.png" data-original-src="https://miro.medium.com/v2/resize:fit:1330/format:webp/1*d1znu7iZvB3nj_DaXgWpqA.png"/></div></figure><p id="62de" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在进行必要的导入并加载本地环境变量之后，我们需要从AWS获取lambda函数的列表。这可以通过两种方式实现:</p><p id="93be" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">通过在aws-cli中编写以下命令——</p><pre class="kp kq kr ks fd la kw lb lc aw ld bi"><span id="31b2" class="le lf hi kw b fi lg lh l li lj">$ aws lambda list-functions</span></pre><p id="c749" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">或者，通过使用<code class="du kt ku kv kw b"><a class="ae iu" href="https://docs.python.org/3/library/subprocess.html#subprocess.Popen.communicate" rel="noopener ugc nofollow" target="_blank">Popen.communicate()</a></code>方法创建<code class="du kt ku kv kw b"><a class="ae iu" href="https://docs.python.org/3/library/subprocess.html#subprocess.PIPE" rel="noopener ugc nofollow" target="_blank">PIPE</a></code> <strong class="ix hj"> </strong>和<strong class="ix hj"> </strong>读取输出，使用<code class="du kt ku kv kw b"><a class="ae iu" href="https://docs.python.org/3/library/subprocess.html#popen-constructor" rel="noopener ugc nofollow" target="_blank">subprocess.Popen()</a></code> <strong class="ix hj"> </strong>构造函数在新进程中执行子程序。<code class="du kt ku kv kw b">communicate()</code>返回一个元组<code class="du kt ku kv kw b">(stdout_data, stderr_data)</code>。如果流是以文本模式打开的，则数据将是字符串；否则，字节。我们只对元组的<code class="du kt ku kv kw b">[0]</code>索引感兴趣，我们将使用<code class="du kt ku kv kw b">json.loads()</code>将它映射到一个字典中。</p><p id="6998" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我们将采用第二种方法，因为我们需要lambda函数的名称作为字符串。</p><figure class="kp kq kr ks fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lk"><img src="../Images/c530685f466d43ca3a4471a1e28fdabc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nKPptSdxUNkSN6evCjqtyA.png"/></div></div></figure><p id="cc71" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><code class="du kt ku kv kw b">function_dict[‘Functions’]</code>将返回一个包含函数名和每个lambda函数的许多其他参数的dict列表。我们将遍历该列表，并使用另一个aws-cli命令更新每个lambda函数的环境变量:</p><p id="1ca5" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><code class="du kt ku kv kw b">$ aws lambda update-function-configuration — function-name my-function --environment "Variables={BUCKET=my-bucket,KEY=file.txt”</code></p><figure class="kp kq kr ks fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ll"><img src="../Images/2cad16333542e4c9a006a28be16ab981.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lffh7hM5z1Na_nz32QS5Hw.png"/></div></div></figure><p id="de26" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><code class="du kt ku kv kw b">subprocess.run(args)</code>方法运行由<em class="kh">参数</em>描述的命令。等待命令完成，然后返回一个<code class="du kt ku kv kw b"><a class="ae iu" href="https://docs.python.org/3/library/subprocess.html#subprocess.CompletedProcess" rel="noopener ugc nofollow" target="_blank">CompletedProcess</a></code>实例。<code class="du kt ku kv kw b">subprocess.Popen()</code>和<code class="du kt ku kv kw b">subprocess.run() </code>都接受字符串数组形式的参数。我们只需要<code class="du kt ku kv kw b">[FunctionName]</code>键的值，因为我们只对函数名感兴趣。<em class="kh">现在，我们的lambda函数中的数据库凭证由环境变量保护。</em></p><h2 id="e9f8" class="le lf hi bd lm ln lo lp lq lr ls lt lu jg lv lw lx jk ly lz ma jo mb mc md me bi translated">总结一下:</h2><ol class=""><li id="8b98" class="jt ju hi ix b iy mf jc mg jg mh jk mi jo mj js mk jz ka kb bi translated">我们创建了一个本地。env文件将我们的安全凭证存储在环境变量中，并使用python-dotenv模块在我们的lambda函数中访问这些凭证。</li><li id="37f7" class="jt ju hi ix b iy kc jc kd jg ke jk kf jo kg js mk jz ka kb bi translated">我们开发了一个脚本来获取我们所有的lambda函数名，并为它们创建环境变量。</li></ol></div><div class="ab cl ml mm gp mn" role="separator"><span class="mo bw bk mp mq mr"/><span class="mo bw bk mp mq mr"/><span class="mo bw bk mp mq"/></div><div class="hb hc hd he hf"><p id="aceb" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">感谢您通读。这是我的第一个博客，我将非常感谢你的评论和建议。如果你觉得它有用，请给我一个掌声，并与你的开发伙伴分享。<strong class="ix hj">不要硬编码，硬编码！</strong></p><p id="4faa" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">苏巴亚恩·戈什哈</strong></p><p id="0765" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><a class="ae iu" href="https://www.linkedin.com/in/realsubhayan/" rel="noopener ugc nofollow" target="_blank">LinkedIn</a>|<a class="ae iu" href="https://twitter.com/realsubhayan" rel="noopener ugc nofollow" target="_blank">Twitter</a>|<a class="ae iu" href="https://www.instagram.com/realsubhayan/?hl=en" rel="noopener ugc nofollow" target="_blank">insta gram</a></p></div></div>    
</body>
</html>