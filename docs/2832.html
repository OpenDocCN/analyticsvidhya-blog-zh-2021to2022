<html>
<head>
<title>How to Use PEM Certificates With Apache Kafka</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在Apache Kafka中使用PEM证书</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/how-to-use-pem-certificates-with-apache-kafka-f3b444a00816?source=collection_archive---------6-----------------------#2021-05-19">https://medium.com/analytics-vidhya/how-to-use-pem-certificates-with-apache-kafka-f3b444a00816?source=collection_archive---------6-----------------------#2021-05-19</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/1b180b49ad714e5a0326d2c7b56d6343.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LgkykgejnyPRx9TxdsVOwg.jpeg"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">照片由<a class="ae iu" href="https://unsplash.com/@flyd2069?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">飞:D </a>在<a class="ae iu" href="https://unsplash.com/@flyd2069?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a></figcaption></figure><p id="5cb7" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这是一个漫长的等待，但它终于来了:从Apache Kafka 2.7开始，现在可以在代理和java客户端使用PEM格式的TLS证书。</p><p id="5fcc" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">你可能想知道——这有什么关系？</p><p id="ef33" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">PEM是一种将x509证书和私钥编码为Base64 ASCII字符串的方案。这使得处理您的证书更加容易。您可以简单地将密钥和证书作为字符串参数提供给应用程序(例如，通过环境变量)。如果您的应用程序在容器中运行，这一点尤其有用，因为将文件装载到容器会使部署管道变得更加复杂。在这篇文章中，我想向你展示在Kafka中使用PEM证书的两种方法。</p><h1 id="fd2b" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">以字符串形式提供证书</h1><h2 id="60a8" class="kr ju hi bd jv ks kt ku jz kv kw kx kd jg ky kz kh jk la lb kl jo lc ld kp le bi translated">代理和CLI工具</h2><p id="a907" class="pw-post-body-paragraph iv iw hi ix b iy lf ja jb jc lg je jf jg lh ji jj jk li jm jn jo lj jq jr js hb bi translated">您可以将证书直接添加到客户端或代理的配置文件中。如果您以单行字符串的形式提供它们，则必须通过在每行的末尾添加换行符(\n)将原始的多行格式转换为单行。属性文件的SSL部分应该是这样的:</p><pre class="lk ll lm ln fd lo lp lq lr aw ls bi"><span id="0535" class="kr ju hi lp b fi lt lu l lv lw">security.protocol=SSL<br/>ssl.keystore.type=PEM<br/>ssl.keystore.certificate.chain=-----BEGIN CERTIFICATE-----\n...\n-----END CERTIFICATE-----<br/>ssl.keystore.key=-----BEGIN ENCRYPTED PRIVATE KEY-----\n...\n-----END ENCRYPTED PRIVATE KEY-----<br/>ssl.key.password=&lt;private_key_password&gt;<br/>ssl.truststore.type=PEM<br/>ssl.truststore.certificates=-----BEGIN CERTIFICATE-----\n...\n-----END CERTIFICATE-----</span></pre><p id="1b72" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">注意<strong class="ix hj">SSL . keystore . certificate . chain</strong>需要包含您的签名证书以及所有的中间CA证书。有关这方面的更多详细信息，请参见下面的<strong class="ix hj"> <em class="lx">常见问题</em> </strong>部分。</p><p id="923f" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">您的私钥进入<strong class="ix hj"> ssl.keystore.key </strong>字段，而私钥的密码(如果您使用的话)进入<strong class="ix hj"> ssl.key.password </strong>字段。</p><h2 id="eabf" class="kr ju hi bd jv ks kt ku jz kv kw kx kd jg ky kz kh jk la lb kl jo lc ld kp le bi translated">Java客户端</h2><p id="0d46" class="pw-post-body-paragraph iv iw hi ix b iy lf ja jb jc lg je jf jg lh ji jj jk li jm jn jo lj jq jr js hb bi translated">Java客户端使用完全相同的属性，但是常量有助于提高可读性:</p><pre class="lk ll lm ln fd lo lp lq lr aw ls bi"><span id="7480" class="kr ju hi lp b fi lt lu l lv lw">Properties properties = new Properties();<br/>properties.put(ProducerConfig.BOOTSTRAP_SERVERS_CONFIG, "localhost:9092");</span><span id="31c7" class="kr ju hi lp b fi ly lu l lv lw">...omitted other producer configs...</span><span id="2fd8" class="kr ju hi lp b fi ly lu l lv lw">//SSL configs<br/>properties.put(CommonClientConfigs.SECURITY_PROTOCOL_CONFIG, "SSL");<br/>properties.put(SslConfigs.SSL_KEYSTORE_TYPE_CONFIG, "PEM");<br/>properties.put(SslConfigs.SSL_KEYSTORE_CERTIFICATE_CHAIN_CONFIG, "&lt;certificate_chain_string&gt;");<br/>properties.put(SslConfigs.SSL_KEYSTORE_KEY_CONFIG, "&lt;private_key_string&gt;");<br/>// key password is needed if the private key is encrypted<br/>properties.put(SslConfigs.SSL_KEY_PASSWORD_CONFIG, "&lt;private_key_password&gt;");<br/>properties.put(SslConfigs.SSL_TRUSTSTORE_TYPE_CONFIG, "PEM");<br/>properties.put(SslConfigs.SSL_TRUSTSTORE_CERTIFICATES_CONFIG, "&lt;trusted_certificate&gt;");<br/><br/>producer = new KafkaProducer&lt;&gt;(properties);</span></pre><h1 id="c8ad" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">以文件形式提供证书</h1><p id="ac9b" class="pw-post-body-paragraph iv iw hi ix b iy lf ja jb jc lg je jf jg lh ji jj jk li jm jn jo lj jq jr js hb bi translated">如果您已经对Kafka使用了mTLS身份验证，那么过渡到PEM证书的最简单的方法就是将它们作为文件使用，取代您现在使用的java密钥库和信任库。这种方法使得从PKCS12文件转换到PEM文件变得很容易。</p><h2 id="e2f2" class="kr ju hi bd jv ks kt ku jz kv kw kx kd jg ky kz kh jk la lb kl jo lc ld kp le bi translated">代理和CLI工具</h2><p id="4df1" class="pw-post-body-paragraph iv iw hi ix b iy lf ja jb jc lg je jf jg lh ji jj jk li jm jn jo lj jq jr js hb bi translated">属性文件的SSL部分应该是这样的:</p><pre class="lk ll lm ln fd lo lp lq lr aw ls bi"><span id="2651" class="kr ju hi lp b fi lt lu l lv lw">ssl.keystore.type=PEM<br/>ssl.keystore.location=/path/to/file/containing/certificate/chain<br/>ssl.key.password=&lt;private_key_password&gt;<br/>ssl.truststore.type=PEM<br/>ssl.truststore.location=/path/to/truststore/certificate</span></pre><p id="0fef" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj"> ssl.keystore.type </strong>和<strong class="ix hj"> ssl.truststore.type </strong>属性告诉Kafka我们以何种格式提供证书和信任库。</p><p id="4e97" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">接下来，<strong class="ix hj"> ssl.keystore.location </strong>指向一个应该包含以下内容的文件:</p><ul class=""><li id="810e" class="lz ma hi ix b iy iz jc jd jg mb jk mc jo md js me mf mg mh bi translated">你的私人钥匙</li><li id="e5f8" class="lz ma hi ix b iy mi jc mj jg mk jk ml jo mm js me mf mg mh bi translated">您的签名证书</li><li id="685a" class="lz ma hi ix b iy mi jc mj jg mk jk ml jo mm js me mf mg mh bi translated">以及任何中间CA证书</li></ul><p id="8ee9" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">有关证书链的更多详细信息，请参见下面的<strong class="ix hj"> <em class="lx">常见问题</em> </strong>部分。</p><p id="aa28" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">如果您的私钥被加密(我希望是这样)，您将需要设置ssl.key.password 。确保不要提供<strong class="ix hj"> ssl.keystore.password </strong>，否则会出现错误。</p><h2 id="594a" class="kr ju hi bd jv ks kt ku jz kv kw kx kd jg ky kz kh jk la lb kl jo lc ld kp le bi translated">Java客户端</h2><p id="bb63" class="pw-post-body-paragraph iv iw hi ix b iy lf ja jb jc lg je jf jg lh ji jj jk li jm jn jo lj jq jr js hb bi translated">Java客户端也使用相同的属性，但是这里我们使用Kafka客户端库提供的常量:</p><pre class="lk ll lm ln fd lo lp lq lr aw ls bi"><span id="2f4c" class="kr ju hi lp b fi lt lu l lv lw">Properties properties = new Properties();<br/>properties.put(ProducerConfig.BOOTSTRAP_SERVERS_CONFIG, "localhost:9092");</span><span id="b42d" class="kr ju hi lp b fi ly lu l lv lw">...omitted other producer configs...</span><span id="3099" class="kr ju hi lp b fi ly lu l lv lw">//SSL configs<br/>properties.put(CommonClientConfigs.SECURITY_PROTOCOL_CONFIG, "SSL");<br/>properties.put(SslConfigs.SSL_KEYSTORE_TYPE_CONFIG, "PEM");<br/>properties.put(SslConfigs.SSL_KEYSTORE_LOCATION_CONFIG, "/path/to/file/containing/certificate/chain");<br/>// key password is needed if the private key is encrypted<br/>properties.put(SslConfigs.SSL_KEY_PASSWORD_CONFIG, "&lt;private_key_password&gt;");<br/>properties.put(SslConfigs.SSL_TRUSTSTORE_TYPE_CONFIG, "PEM");<br/>properties.put(SslConfigs.SSL_TRUSTSTORE_LOCATION_CONFIG, "/path/to/truststore/certificate");<br/><br/>producer = new KafkaProducer&lt;&gt;(properties);</span></pre><h1 id="4463" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">设置证书链时的常见问题</h1><ol class=""><li id="0269" class="lz ma hi ix b iy lf jc lg jg mn jk mo jo mp js mq mf mg mh bi translated">如果您的私钥是加密的(它应该总是加密的)，您需要将它从PKCS#1格式转换为PKCS#8格式，以便java/kafka能够正确地读取它</li><li id="e633" class="lz ma hi ix b iy mi jc mj jg mk jk ml jo mm js mq mf mg mh bi translated">如果您想以单行字符串的形式提供PEM证书，请确保在每行的末尾添加换行符(\n)。否则，证书将被视为无效。</li><li id="91d0" class="lz ma hi ix b iy mi jc mj jg mk jk ml jo mm js mq mf mg mh bi translated">证书链必须包括您的证书以及签署它的所有中间CA证书，按此顺序。例如，如果您的证书由证书A签名，而证书A由证书B签名，证书B由根证书签名，那么您的证书链必须依次包括:您的证书、证书A和证书B。请注意，根证书不应该在链中。</li><li id="a12d" class="lz ma hi ix b iy mi jc mj jg mk jk ml jo mm js mq mf mg mh bi translated">证书链中的证书顺序很重要(参见第3点)</li></ol><h1 id="a15b" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">带有PEM证书的Kafka SSL设置示例</h1><p id="e426" class="pw-post-body-paragraph iv iw hi ix b iy lf ja jb jc lg je jf jg lh ji jj jk li jm jn jo lj jq jr js hb bi translated">测试客户机的SSL设置并不简单，因为设置带有SSL身份验证的Kafka集群并不是一个简单的过程。这就是为什么我用一个zookeeper和broker创建了一个<a class="ae iu" href="https://github.com/codingharbour/kafka-docker-compose/tree/master/kafka-ssl" rel="noopener ugc nofollow" target="_blank"> docker-compose项目</a>，并启用了SSL认证。这个项目使用了许多来自Confluent优秀的<a class="ae iu" href="https://github.com/confluentinc/cp-demo" rel="noopener ugc nofollow" target="_blank"> cp-demo项目</a>的想法。</p><p id="bffa" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">要使用该项目，克隆<a class="ae iu" href="https://github.com/codingharbour/kafka-docker-compose" rel="noopener ugc nofollow" target="_blank"> docker-compose存储库</a>，并导航到<strong class="ix hj"> kafka-ssl </strong>文件夹。</p><pre class="lk ll lm ln fd lo lp lq lr aw ls bi"><span id="0d30" class="kr ju hi lp b fi lt lu l lv lw">git clone https://github.com/codingharbour/kafka-docker-compose.git cd kafka-ssl</span></pre><p id="4a3b" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">运行<strong class="ix hj"> start-cluster.sh </strong>脚本将生成自签名根证书。该脚本将使用它来签署所有其他证书。它还将为经纪人和动物园管理员生成和签署证书，并为一个生产者和消费者生成和签署证书。此后，脚本将使用docker-compose启动集群。</p><blockquote class="mr ms mt"><p id="902c" class="iv iw lx ix b iy iz ja jb jc jd je jf mu jh ji jj mv jl jm jn mw jp jq jr js hb bi translated">没有docker-compose？查看:<a class="ae iu" href="https://docs.docker.com/compose/install/" rel="noopener ugc nofollow" target="_blank">如何安装docker-compose </a></p></blockquote><p id="cd97" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">此外，启动脚本将生成<strong class="ix hj"> producer.properties </strong>和<strong class="ix hj"> consumer.properties </strong>文件，您可以使用<strong class="ix hj"> kafka-console-* </strong>工具。</p><p id="6d46" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">consumer.properties文件是如何将PEM证书用作字符串的示例。另一方面，producer.properties使用存储在PEM文件中的证书。通过这种方式，您可以看到并测试这篇博文中描述的两种方法。</p><h1 id="b800" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">你想更多地了解卡夫卡吗？</h1><p id="ce4f" class="pw-post-body-paragraph iv iw hi ix b iy lf ja jb jc lg je jf jg lh ji jj jk li jm jn jo lj jq jr js hb bi translated">我创建了一个卡夫卡迷你课程，你可以完全免费获得。<a class="ae iu" href="https://codingharbour.com/kafka-mini-course/" rel="noopener ugc nofollow" target="_blank">在编码港</a>报名。</p></div><div class="ab cl mx my gp mz" role="separator"><span class="na bw bk nb nc nd"/><span class="na bw bk nb nc nd"/><span class="na bw bk nb nc"/></div><div class="hb hc hd he hf"><p id="f598" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">【https://codingharbour.com】最初发表于<a class="ae iu" href="https://codingharbour.com/apache-kafka/using-pem-certificates-with-apache-kafka/" rel="noopener ugc nofollow" target="_blank"><em class="lx"/></a><em class="lx">。</em></p></div></div>    
</body>
</html>