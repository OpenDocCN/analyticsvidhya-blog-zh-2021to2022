<html>
<head>
<title>“What did you think of the match last night?”</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">"你认为昨晚的比赛怎么样？"</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/what-did-you-think-of-the-match-last-night-b1380f070e51?source=collection_archive---------15-----------------------#2021-07-09">https://medium.com/analytics-vidhya/what-did-you-think-of-the-match-last-night-b1380f070e51?source=collection_archive---------15-----------------------#2021-07-09</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><h1 id="b833" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated">使用谷歌云平台、Python、Tweepy &amp; Tableau进行英格兰对克罗地亚比赛期间的Twitter实体和情感分析</h1><p id="e13d" class="pw-post-body-paragraph jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ha bi translated">随着欧洲锦标赛于2021年6月11日拉开帷幕，小组赛是国家队参赛的第一步。在一系列的友谊赛之后，他们有希望微调他们的战术并最终确定他们的首发阵容，小组赛是球迷开始做梦并开始看到无疑确保成功的辉煌迹象，或令人沮丧的疲软迹象。作为与此同时的一个练习，我想看看在一个特定的游戏中对玩家的情绪是如何变化的，并在一个时间线上将其可视化，以便对这一运动进行一些分析。</p><p id="a380" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">为了这篇文章的目的，我想集中在英格兰的第一场比赛(我的球队！)6月13日对阵克罗地亚。为了做到这一点，我利用谷歌云平台(GCP)的后端活动和可视化的Tableau。</p><p id="7c3b" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">我的目标是保持这篇文章相当高的水平，但源代码可以在下面的GitHub gists中找到。该解决方案将作为一个轻触式的一次性项目来展示这些工具是如何连接在一起的，而不是一个工业级的解决方案，因此准备好看到大量的改进空间。</p><p id="ab2e" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">让我们开始吧！</p><figure class="kg kh ki kj fd kk er es paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="er es kf"><img src="../Images/5b434a59925f984a4608face374bc2eb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tiJAZKKou1QgitCg1ack9A.jpeg"/></div></div><figcaption class="kr ks et er es kt ku bd b be z dx translated">托马斯·塞勒在<a class="ae kv" href="https://unsplash.com/s/photos/football?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</figcaption></figure><h1 id="2715" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated">方法</h1><p id="8561" class="pw-post-body-paragraph jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ha bi translated">该设计相对简单(如下所示):</p><figure class="kg kh ki kj fd kk er es paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="er es kw"><img src="../Images/0614e546e8a4af7e78fe78caafb7c4ef.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PCDZu-matsS3a1yL16eefw.jpeg"/></div></div></figure><p id="1268" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">我们需要采取5个关键步骤:</p><ol class=""><li id="b661" class="kx ky hh je b jf ka jj kb jn kz jr la jv lb jz lc ld le lf bi translated">获得对Twitter API的访问权，并传输到Python。这将是我们的原始数据源</li><li id="8ee0" class="kx ky hh je b jf lg jj lh jn li jr lj jv lk jz lc ld le lf bi translated">将这些推文过滤到我们感兴趣的推文中。)并通过调用谷歌的自然语言API来识别推文中的实体和情感</li><li id="299c" class="kx ky hh je b jf lg jj lh jn li jr lj jv lk jz lc ld le lf bi translated">将结构展平成表格形式，为分析做准备</li><li id="fb0c" class="kx ky hh je b jf lg jj lh jn li jr lj jv lk jz lc ld le lf bi translated">将这些增强的消息流入PubSub，并使用数据流管道将消息写入BigQuery表</li><li id="1b74" class="kx ky hh je b jf lg jj lh jn li jr lj jv lk jz lc ld le lf bi translated">将Tableau Public连接到BigQuery并可视化结果</li></ol><p id="df06" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated"><strong class="je hi">推特API </strong></p><p id="d13b" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">与Twitter的连接是通过Tweepy Python包中的API调用实现的。这里我不会对Tweepy或API进行全面的概述，但是有几篇关于这方面的好文章。(我特别喜欢YouTube上来自CodingEntrepenuers的视频<a class="ae kv" href="https://youtu.be/dvAurfBB6Jk" rel="noopener ugc nofollow" target="_blank">https://youtu.be/dvAurfBB6Jk</a>)，其中包含了对构建过程的深入了解，以及讲师使用的相关Git库的链接。)</p><p id="ca4f" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">以下要点显示了所需的一些关键元素以及Python脚本的外观(请注意，脚本需要更新才能用于其他用户/项目):</p><figure class="kg kh ki kj fd kk"><div class="bz dy l di"><div class="ll lm l"/></div></figure><p id="3bc8" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated"><strong class="je hi">过滤器</strong></p><p id="bef9" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">一旦我们有了Twitter的应用程序凭证，并且脚本被设置为开始传输tweets，那么就有几个步骤需要考虑。我们将通过谷歌自然语言API的输出来丰富信息流，这是一种已计算成本的资源，每月可免费使用多达5000次调用，因此我们希望确保调用尽可能有效，以避免巨额超支。我们的做法有两个方面:</p><p id="bd87" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">1 —首先，我们将Tweepy调用限制在我们已经定义的流标签(#ENGCRO等。)这是一个保存在lst_hashtags变量中的列表。</p><p id="af45" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">2 —其次，我们在write_to_pubsub函数中进行过滤，专门包含英格兰球员的姓名。这是一个保存在lst_teams变量中的列表。</p><p id="3957" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">我们的假设是，在这场特定比赛的正确背景下，我们将会看到一系列提及我们感兴趣的球员的推文。</p><p id="8bf9" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated"><strong class="je hi">分析&amp;展平</strong></p><p id="f3c3" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">在这个阶段，我们现在应该有一个标准化的tweets管道，准备用Google自然语言API的输出来丰富它。</p><p id="f408" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">Google自然语言API向开发者提供自然语言理解技术，包括情感分析、实体分析、实体情感分析、内容分类、语法分析。这对于像这样的项目特别有用，因为它消除了构建和训练特定模型的需要，从而节省了时间。</p><p id="d0dc" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">由于这个项目正在分析的tweets可能包含多个具有不同情绪的实体，我选择使用实体情绪调用这个API，因为这将区分实体并对每个实体应用情绪分析。进一步说，想象一下这条推文:</p><p id="b7f3" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated"><strong class="je hi">《凯恩好》</strong></p><p id="5955" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">情感分析将表明对实体的非常积极的情感，在这种情况下是‘Kane’。然而，想象一下第二条推文:</p><p id="9c7e" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated"><strong class="je hi">《凯恩好，匹克福德坏》</strong></p><p id="bb10" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">我们需要能够分离出实体(在这种情况下是‘凯恩’和‘皮克福德’)，并为每个实体分配适当的情感(和量级)。</p><p id="b858" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">为了便于下游存储和分析，我们只分析了tweet中的前三个实体。下面的脚本展示了如何处理tweet。它对推文进行一些重新格式化，处理时间戳，过滤掉非英语语言的推文，并在调用API之前应用团队过滤器。一旦API返回，它就拉平实体/情绪/幅度响应以保持前三个。</p><figure class="kg kh ki kj fd kk"><div class="bz dy l di"><div class="ll lm l"/></div></figure><p id="b388" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated"><strong class="je hi">在BigQuery中创建我们的目标表</strong></p><p id="3ace" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">在BigQuery中创建一个表非常简单。登录到您的GCP项目，选择BigQuery快捷方式&gt;创建数据集&gt;创建表，并输入您需要的字段。出于这个项目的目的，这些字段应该与写入消息队列的字段的名称和类型相匹配。为了更深入地了解这一点，我在Qwiklabs上找到了一堆非常有用的实验室，从<a class="ae kv" href="https://www.qwiklabs.com/catalog_lab/685" rel="noopener ugc nofollow" target="_blank">https://www.qwiklabs.com/catalog_lab/685</a>开始(*Qwiklabs是一个付费产品，但当我注册时，我收到了几个邀请，可以享受30天的免费访问，这对于完成几个实验室来说是足够的时间)</p><p id="b38a" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated"><strong class="je hi">将增强的推文流式传输到BigQuery </strong></p><p id="9d52" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">因此，到目前为止，我们已经获得了我们的tweet流，过滤出我们感兴趣的tweet，将每个tweet传递给NL API，接收响应，并将实体限制为3个。我们现在可以存储这些数据，为分析做准备。我们这样做的方式是将丰富的tweets流(发布)到Google PubSub主题，并使用数据流管道订阅该主题，检索消息并将它们写入BigQuery表。</p><p id="1fe1" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">Google PubSub用于流分析和数据集成管道，以接收和分发数据，这使其成为管理管道将处理的推文流量和数量的理想选择。实际上，下面的代码从重新格式化的tweet中提取BigQuery需要的字段，并将这些字段作为消息写入(发布)到PubSub队列(topic):</p><figure class="kg kh ki kj fd kk"><div class="bz dy l di"><div class="ll lm l"/></div></figure><p id="ea34" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">在这个阶段，我们有一个PubSub主题，它很好地填充了增强的tweets，但是我们如何将它放入数据库呢？现在，这就是使用谷歌管道真正有用的地方。我们需要创建一个作业，从队列中提取消息，确认消息(删除它)并将消息以表格格式写出。这可能需要一些时间来设置，但幸运的是，在PubSub主题屏幕上，我们可以看到有两个模板作业已经设置好可以使用:“导出到BigQuery”和“导出到云存储”。</p><figure class="kg kh ki kj fd kk er es paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="er es ln"><img src="../Images/03b9fe5a977e5bef744d6577f3435264.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*o7akeiU8PzKpwBJ7BXbunw.png"/></div></div><figcaption class="kr ks et er es kt ku bd b be z dx translated">发布/子主题详细信息屏幕</figcaption></figure><p id="0b1d" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">单击导出到BigQuery，输入您的主题的详细信息和我们在几段前创建的BigQuery表，GCP会自动设置计算实例和数据流作业，如果您的流脚本已经在运行，您会看到BigQuery表中出现行，可以立即进行分析，但值得注意的是，只要流和数据流作业正在运行，它就会继续写入行。</p><p id="37ea" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated"><strong class="je hi">分析</strong></p><p id="6930" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">GCP有自己的分析套件，包括Data Studio，但为了提高速度，我使用了Tableau，因为我对它很熟悉，它有一个现成的BigQuery连接。Tableau是一个数据可视化工具，有一个有用的免费产品叫做Tableau Public，允许用户在线发布他们的可视化图。(我不会在这里详细介绍Tableau的构建，但是请放心，这里有很多在线资源和一个蓬勃发展的社区供想要开始使用的用户使用。)</p><p id="c0b3" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">Tableau可以很容易地连接到BigQuery，一旦数据进入仪表板，用户就可以创建多个vizzes，然后将这些vizzes与其他项目(如文本和/或图像框)一起放在仪表板上。图像也可以成为交互中不可或缺的一部分，比如在这种情况下，我允许球员的图像作为下面档案图表的悬停过滤器。</p><figure class="kg kh ki kj fd kk er es paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="er es lo"><img src="../Images/1317537288ff581d5201c8975986661d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lyv6sxuVBgc3gUIsF_Lizw.png"/></div></div><figcaption class="kr ks et er es kt ku bd b be z dx translated">Tableau公共仪表板的屏幕截图</figcaption></figure><p id="cdd9" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">仪表盘的链接在这里<a class="ae kv" href="https://public.tableau.com/views/PlayerSentimentAnalysis/Main?:language=en-GB&amp;:display_count=n&amp;:origin=viz_share_link" rel="noopener ugc nofollow" target="_blank">https://public . tableau . com/views/PlayerSentimentAnalysis/Main？:language = en-GB&amp;:display _ count = n&amp;:origin = viz _ share _ link</a></p><p id="7af3" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated"><strong class="je hi">笔记&amp;思绪</strong></p><p id="0039" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">虽然这个练习更多的是关于GCP管道建设的演示，但是从分析中可以得出一些结论，尽管不是惊天动地的:</p><ul class=""><li id="b1f1" class="kx ky hh je b jf ka jj kb jn kz jr la jv lb jz lp ld le lf bi translated">尽管团队遵循大致相似的模式，但情绪始终在变化</li><li id="ce94" class="kx ky hh je b jf lg jj lh jn li jr lj jv lk jz lp ld le lf bi translated">当进球时，情绪会改善，如果进球者在进球前情绪消极，情绪会逆转</li><li id="a042" class="kx ky hh je b jf lg jj lh jn li jr lj jv lk jz lp ld le lf bi translated">对于大玩家和经理来说，推文量更不稳定</li></ul><p id="7074" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi lq translated"><span class="l lr ls lt bm lu lv lw lx ly di">那么</span>你知道了，我希望这是有用的或者有趣的。正如我在开始时提到的，这对我来说是一个非常有用的学习练习，我已经记下了一些关于我如何改进或可能帮助未来开发人员在此基础上构建的笔记。</p><figure class="kg kh ki kj fd kk er es paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="er es lz"><img src="../Images/817327d964bde37f2b898f56bceae67c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*FyGe2kkaOFLLlYXZ"/></div></div><figcaption class="kr ks et er es kt ku bd b be z dx translated">Habib Ayoade 在<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure></div><div class="ab cl ma mb go mc" role="separator"><span class="md bw bk me mf mg"/><span class="md bw bk me mf mg"/><span class="md bw bk me mf"/></div><div class="ha hb hc hd he"><p id="97d9" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated"><strong class="je hi">流程说明</strong>。我最初是在笔记本电脑上的Jupyter笔记本上开发代码的。(我发现如果我把代码分成几块，调试起来会更容易)。然而，为了执行，我将代码保存为单个。py脚本并发布到GitHub。然后，我在GCP上设置了一个虚拟机(e2-medium 2vCPU 4GB)，安装了我的先决条件，克隆了我的repo，并通过SSH的命令行运行代码。这增加了流程的弹性和保持在线的需要。</p><p id="9e82" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated"><strong class="je hi">关于代码的注释。虽然它可以工作，但如果我有时间，我会重新访问代码并重写，因为我现在对Python的信心更高了，而且它在某些方面看起来很冗长。</strong></p><p id="adb3" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated"><strong class="je hi">关于下一步探索领域的说明。</strong>在这个项目中，我们使用Tweepy来阅读推文，但我们可以继续使用Tweepy来写推文，并将情感分析反馈到twitter。我们可以将输出输入到预先训练的语言模型(如GPT-3)中，以便在游戏等过程中进行交互并对消息做出响应。</p><p id="3214" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">我应该覆盖一个比赛评论来显示当时在比赛中客观发生的事情，以洞察情绪的变化。(此后，我测试了一个脚本，该脚本与情感分析一起运行，抓取BBC评论，并将输出存储在Python字典中)</p><p id="26ea" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated"><strong class="je hi">关于费用的说明。</strong>这可以通过使用GCP 300美元的入门优惠免费复制，但由于对我来说已经过期，我支付了几个虚拟机(Python执行和数据流运行)。API调用的数量高于我的预期，大约为14.5k。因此总成本大约为14，所以不算太高。</p></div></div>    
</body>
</html>