<html>
<head>
<title>Azure Synapse Spark with Azure Event Hubs</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Azure Synapse Spark与Azure事件中心</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/azure-synapse-spark-with-azure-event-hubs-afb7670b2b37?source=collection_archive---------4-----------------------#2021-05-14">https://medium.com/analytics-vidhya/azure-synapse-spark-with-azure-event-hubs-afb7670b2b37?source=collection_archive---------4-----------------------#2021-05-14</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><h1 id="7fdb" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">使用事件中心将流或事件驱动的数据处理到Azure Synapse分析工作区中</h1><h1 id="e892" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">先决条件</h1><h1 id="822f" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">步伐</h1><ul class=""><li id="4b2d" class="jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju bi translated">在Azure Synapse workspace中创建新的火花池</li><li id="8d2c" class="jd je hi jf b jg jv ji jw jk jx jm jy jo jz jq jr js jt ju bi translated">转到Azure事件中心创建一个名为synapseincoming的新事件中心</li><li id="a2ac" class="jd je hi jf b jg jv ji jw jk jx jm jy jo jz jq jr js jt ju bi translated">将分区设置为1，因为这是为了测试</li><li id="21ee" class="jd je hi jf b jg jv ji jw jk jx jm jy jo jz jq jr js jt ju bi translated">转到共享访问策略并创建一个密钥来写入和复制连接字符串</li><li id="4273" class="jd je hi jf b jg jv ji jw jk jx jm jy jo jz jq jr js jt ju bi translated">转到Azure Keyvault并存储密钥</li><li id="dff3" class="jd je hi jf b jg jv ji jw jk jx jm jy jo jz jq jr js jt ju bi translated">转到Eventhub名称空间并复制连接字符串</li><li id="09d4" class="jd je hi jf b jg jv ji jw jk jx jm jy jo jz jq jr js jt ju bi translated">复制事件中心名称</li><li id="4ab1" class="jd je hi jf b jg jv ji jw jk jx jm jy jo jz jq jr js jt ju bi translated">以上信息用于数据生成器</li><li id="b034" class="jd je hi jf b jg jv ji jw jk jx jm jy jo jz jq jr js jt ju bi translated">现在让我们编写代码</li><li id="3afc" class="jd je hi jf b jg jv ji jw jk jx jm jy jo jz jq jr js jt ju bi translated">转到Azure Synapse分析工作区</li><li id="0eb8" class="jd je hi jf b jg jv ji jw jk jx jm jy jo jz jq jr js jt ju bi translated">转到管理和凭据</li><li id="5ef3" class="jd je hi jf b jg jv ji jw jk jx jm jy jo jz jq jr js jt ju bi translated">将新的eventhub synapseincoming连接字符串添加到凭据</li><li id="3641" class="jd je hi jf b jg jv ji jw jk jx jm jy jo jz jq jr js jt ju bi translated">我们正在从上面储存的密钥库中获取密钥</li></ul><figure class="kb kc kd ke fd kf er es paragraph-image"><div role="button" tabindex="0" class="kg kh di ki bf kj"><div class="er es ka"><img src="../Images/074b8e93fe190a5a25e33ae2ba3050c8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*zfhZtEGQ9oC0Jhiz.jpg"/></div></div></figure><ul class=""><li id="18ce" class="jd je hi jf b jg km ji kn jk ko jm kp jo kq jq jr js jt ju bi translated">现在让我们创建代码，从事件中心读取事件/消息，并写入无服务器sql表</li><li id="6477" class="jd je hi jf b jg jv ji jw jk jx jm jy jo jz jq jr js jt ju bi translated">目标是无服务器sql表</li><li id="355e" class="jd je hi jf b jg jv ji jw jk jx jm jy jo jz jq jr js jt ju bi translated">从凭据中安全地获取连接字符串</li><li id="9087" class="jd je hi jf b jg jv ji jw jk jx jm jy jo jz jq jr js jt ju bi translated">创建一个新笔记本，并选择pyspark作为语言</li></ul><h1 id="6552" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">密码</h1><pre class="kb kc kd ke fd kr ks kt ku aw kv bi"><span id="8ed8" class="kw ig hi ks b fi kx ky l kz la">keyVaultName = "keyvaultname"; <br/>secretName = "synapseeventhub";</span><span id="1cd3" class="kw ig hi ks b fi lb ky l kz la">secret = mssparkutils.credentials.getSecret(keyVaultName, secretName)</span><span id="179f" class="kw ig hi ks b fi lb ky l kz la">connectionString = secret<br/>ehConf = {<br/>  'eventhubs.connectionString' : sc._jvm.org.apache.spark.eventhubs.EventHubsUtils.encrypt(connectionString)<br/>}</span><span id="b422" class="kw ig hi ks b fi lb ky l kz la">def write2table(df2, epoch_id):<br/>    df2.write.mode("append").saveAsTable("default.eventhubdata")</span><span id="3229" class="kw ig hi ks b fi lb ky l kz la">df = spark \<br/>    .readStream \<br/>    .format("eventhubs") \<br/>    .options(**ehConf) \<br/>  .load()</span><span id="e168" class="kw ig hi ks b fi lb ky l kz la">df1 = df.withColumn("body", df["body"].cast("string"))</span><span id="3031" class="kw ig hi ks b fi lb ky l kz la">df1.writeStream \<br/>    .outputMode("update") \<br/>    .trigger(processingTime='5 seconds') \<br/>    .option("checkpointLocation","abfss://eventhubdata@accsynapsestorage.dfs.core.windows.net/evetcheckpoint/") \<br/>    .foreachBatch(write2table) \<br/>    .start() \<br/>    .awaitTermination()</span></pre><ul class=""><li id="78bc" class="jd je hi jf b jg km ji kn jk ko jm kp jo kq jq jr js jt ju bi translated">执行每个单元格</li><li id="07c9" class="jd je hi jf b jg jv ji jw jk jx jm jy jo jz jq jr js jt ju bi translated">一旦运行了写流，现在我们就可以发送数据了</li></ul><h1 id="3ef2" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">事件中心数据生成器</h1><figure class="kb kc kd ke fd kf er es paragraph-image"><div role="button" tabindex="0" class="kg kh di ki bf kj"><div class="er es lc"><img src="../Images/4066a4dfced74d3a6e2d42734162c88e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*Wt0RhBPf0H6HEqCL.jpg"/></div></div></figure><h1 id="b89e" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">Azure Synapse无服务器SQL</h1><ul class=""><li id="823b" class="jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju bi translated">转到无服务器SQL</li><li id="83f0" class="jd je hi jf b jg jv ji jw jk jx jm jy jo jz jq jr js jt ju bi translated">创建新查询</li><li id="57ff" class="jd je hi jf b jg jv ji jw jk jx jm jy jo jz jq jr js jt ju bi translated">让我们数一数</li></ul><pre class="kb kc kd ke fd kr ks kt ku aw kv bi"><span id="b38e" class="kw ig hi ks b fi kx ky l kz la">SELECT count(*) FROM [default].[dbo].[eventhubdata]</span><span id="5e96" class="kw ig hi ks b fi lb ky l kz la">Select top 300 * from dbo.eventhubdata order by enqueuedTime DESC;</span></pre><figure class="kb kc kd ke fd kf er es paragraph-image"><div role="button" tabindex="0" class="kg kh di ki bf kj"><div class="er es ld"><img src="../Images/d360fb3f21caa11771eb0653d2d04f47.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*xA0AhvovelyC5oXs.jpg"/></div></div></figure></div><div class="ab cl le lf gp lg" role="separator"><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj"/></div><div class="hb hc hd he hf"><p id="c61b" class="pw-post-body-paragraph ll lm hi jf b jg km ln lo ji kn lp lq jk lr ls lt jm lu lv lw jo lx ly lz jq hb bi translated"><em class="ma">最初发表于</em><a class="ae mb" href="https://github.com/balakreshnan/Samples2021/blob/main/EventHub/evtsynapsespark.md" rel="noopener ugc nofollow" target="_blank"><em class="ma">【https://github.com】</em></a><em class="ma">。</em></p></div></div>    
</body>
</html>