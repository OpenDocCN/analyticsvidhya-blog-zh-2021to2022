<html>
<head>
<title>Interfacing between SQL and R</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">SQL和R之间的接口</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/interfacing-between-sql-and-r-177f7a28d998?source=collection_archive---------10-----------------------#2021-03-14">https://medium.com/analytics-vidhya/interfacing-between-sql-and-r-177f7a28d998?source=collection_archive---------10-----------------------#2021-03-14</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/ef138849d08c09c0ae6bf9b287dfe2cf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*vRjbynuNDTnldtJ-"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">伊利亚·巴甫洛夫在<a class="ae iu" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</figcaption></figure><p id="e0ca" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">一定会有数据集太大而不适合csv或txt文件的时候。例如，在零售业，你可能要处理大量的客户记录和销售信息。</p><p id="5075" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这些类型的数据存储和维护在数据库中。简而言之，数据库以有组织和结构化的方式存储信息，以保持其可访问性、安全性和完整性。数据库中的信息由数据库管理系统(DBMS)维护和控制。要访问该系统，需要使用特定的语言，即结构化查询语言(SQL) (Oracle.com)。</p><p id="2658" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">使用SQL，您可以在数据库中导航，例如读取、争论和更新数据。最流行的工具是PostgreSQL、SQLite、GraphQL等。几个月前我开始学习查询数据库，我意识到我可以用r做类似的事情。</p><p id="5f01" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">作为一个一贯的R用户，我发现通过R查询开源数据库更容易。我喜欢学习SQL，但我意识到我需要将其与其他软件相结合，以进行分析和可视化。此外，如果您已经知道R中的dplyr包，那么您可以完全使用dplyr语法在数据库中导航。</p><p id="6ce1" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在本文中，我将分享如何首先在由SQL控制的开源数据库和R之间建立连接。在示例问题的指导下，我将展示从R导航SQL的两种方式:1)使用SQL查询，2)使用dplyr语法。我还将演示如何从SQL中收集数据，并将其存储为R中的数据帧，以便您可以进行分析、建模和可视化。</p><h2 id="6966" class="jt ju hi bd jv jw jx jy jz ka kb kc kd jg ke kf kg jk kh ki kj jo kk kl km kn bi translated">从R创建到数据库的连接</h2><p id="845b" class="pw-post-body-paragraph iv iw hi ix b iy ko ja jb jc kp je jf jg kq ji jj jk kr jm jn jo ks jq jr js hb bi translated">要访问和检索数据库中的数据，必须首先在数据库和r之间建立一个连接。该连接存储在对象<em class="kt">出租</em>中。</p><figure class="ku kv kw kx fd ij"><div class="bz dy l di"><div class="ky kz l"/></div></figure><p id="2348" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">要使用dplyr语法在数据库中导航，我应该将dplyr与dbplyr结合使用。dbplyr包接口dplyr语法和SQL语法。因此，当我们使用dplyr语法从SQL数据库中检索一些数据时，dbplyr将成为“翻译器”,以便SQL可以理解dplyr语法想要什么。</p><p id="bf53" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">DBI包定义了R和关系数据库管理系统之间通信的接口。函数dbConnect包含在DBI包中，用于通过适当的身份验证过程建立连接。</p><p id="a75a" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">odbc包和函数允许我指定驱动程序管理器，我用它来连接R和开源数据库。我将驱动程序指定为PostgreSQL版本12。</p><p id="9a56" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">您可以使用下面的代码odbc::odbcListDrivers()检查R支持的驱动程序管理器。大多数常见的开源数据库已经在R中安装了它们的驱动程序，比如SQLite、Amazon Redshift、Microsoft Access Driver等。您也可以按照RStudio帮助页面中的说明安装驱动程序:</p><p id="b5e6" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><a class="ae iu" href="https://db.rstudio.com/best-practices/drivers/" rel="noopener ugc nofollow" target="_blank">设置ODBC驱动程序(rstudio.com)</a></p><p id="2200" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">由于PostgreSQL通常要求身份验证(用户ID和密码)，我必须在我的连接中设置身份验证过程。我指定了端口、主机(本地主机，意味着它由我的本地计算机托管)、用户ID和密码。</p><p id="cde3" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">如果你正在访问一个开源数据库，默认情况下用户ID由PostgreSQL给出。这些信息可以在数据库管理工具中找到，例如pgAdmin for PostgreSQL。你可以去你的pgAdmin → servers → PostgreSQL →你的数据库名→属性查看用户ID。对于其他驱动程序管理器，您可以查看他们的帮助页面以获得有关用户ID的信息。</p><p id="1c40" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">密码本身是您在第一次设置驱动程序管理器时给出的。已经为PostgreSQL定义了端口，对于本地主机，通常是5433。</p><p id="e838" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">但是，对于那些已经使用过SQL并且需要一些身份验证过程来访问数据库的人来说，这个过程是很熟悉的。如果数据库不需要任何身份验证过程，您可以跳过整个过程，使用以下代码建立连接</p><figure class="ku kv kw kx fd ij"><div class="bz dy l di"><div class="ky kz l"/></div></figure><p id="3940" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">要使用这段代码，您需要安装相关的SQL包。对于SQLite，可以安装r SQLite，对于PostgreSQL可以安装r PostgreSQL等。在本例中，我安装了RPostgreSQL来建立与我的数据库dvdrental的连接。您可以在RStudio帮助页面中查看与您选择的数据库驱动程序接口的可用软件包列表。</p><p id="2112" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">【rstudio.com T2】使用R(T3)的数据库</p><p id="2e15" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">连接成功建立后，您将在RStudio右上面板的environment选项卡上看到您的数据库。它与PostgreSQL类一起列出</p><figure class="ku kv kw kx fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es la"><img src="../Images/941e6dda1fd349d9062fac5a6e9ca83a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GpbJEoec69PIWPGYo31_Eg.png"/></div></div></figure><p id="c4e0" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">该数据库也可以在同一个面板的connection选项卡中找到。</p><figure class="ku kv kw kx fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lb"><img src="../Images/33cc2a8ac248d3ddd935a0e937077cf2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vD2HRzT95sbprp0HXrvQcw.png"/></div></div></figure></div><div class="ab cl lc ld gp le" role="separator"><span class="lf bw bk lg lh li"/><span class="lf bw bk lg lh li"/><span class="lf bw bk lg lh"/></div><div class="hb hc hd he hf"><h2 id="7932" class="jt ju hi bd jv jw jx jy jz ka kb kc kd jg ke kf kg jk kh ki kj jo kk kl km kn bi translated">检查数据库中包含的表</h2><p id="e191" class="pw-post-body-paragraph iv iw hi ix b iy ko ja jb jc kp je jf jg kq ji jj jk kr jm jn jo ks jq jr js hb bi translated">建立连接后，您可能想知道数据库中有什么。一个数据库可以由许多表组成。每个表都包含可变列和观察行。一个表中的列可以与另一个表中的列相关。所以，当你想知道你的数据库里面有什么，这意味着你想知道有多少个表，它们是什么。</p><p id="30f0" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在connection选项卡中，您可以立即看到数据库中包含的表。在这种情况下，我可以通过单击public schema中的下拉箭头来查看包含在我的dvdrental数据库中的表。要检查某个表的观察值和变量，我只需单击表右侧的白纸图标。</p><p id="c3bc" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">如果你喜欢编码，你可以用下面的代码列出dvdrental数据库的表</p><figure class="ku kv kw kx fd ij"><div class="bz dy l di"><div class="ky kz l"/></div></figure><p id="d51a" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">函数src_dbi()告诉你包含在dvdrental数据库中的表。结果可以在tbls行中看到。</p></div><div class="ab cl lc ld gp le" role="separator"><span class="lf bw bk lg lh li"/><span class="lf bw bk lg lh li"/><span class="lf bw bk lg lh"/></div><div class="hb hc hd he hf"><h2 id="16e6" class="jt ju hi bd jv jw jx jy jz ka kb kc kd jg ke kf kg jk kh ki kj jo kk kl km kn bi translated">在R中使用SQL和dplyr语法编写简单的查询</h2><p id="24b6" class="pw-post-body-paragraph iv iw hi ix b iy ko ja jb jc kp je jf jg kq ji jj jk kr jm jn jo ks jq jr js hb bi translated">如果您已经知道如何构造SQL语法，您可以直接在R脚本中传递它。dplyr中的函数tbl()允许R将SQL语法发送到数据库。</p><p id="57a7" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">使用SQL语法查询</strong></p><p id="9789" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">从dvdrental数据库中包含的<em class="kt">电影</em>表中选择所有内容</p><figure class="ku kv kw kx fd ij"><div class="bz dy l di"><div class="ky kz l"/></div></figure><figure class="ku kv kw kx fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lj"><img src="../Images/1a94608043581e8341bf2935fe88b990.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Fnm-J8p5VnhlTV-byX2rjg.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">缩放{SELECT * FROM film}的结果</figcaption></figure><p id="0e98" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">从<em class="kt">电影</em>表中的变量<strong class="ix hj">等级</strong>中识别不同的(唯一的)值</p><figure class="ku kv kw kx fd ij"><div class="bz dy l di"><div class="ky kz l"/></div></figure><figure class="ku kv kw kx fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lk"><img src="../Images/ae6e64147659c6d4dd16b047e6512ced.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VMpYXKyp8SWANiYFZriCHA.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">调用{从电影中选择不同(分级)}的结果</figcaption></figure></div><div class="ab cl lc ld gp le" role="separator"><span class="lf bw bk lg lh li"/><span class="lf bw bk lg lh li"/><span class="lf bw bk lg lh"/></div><div class="hb hc hd he hf"><p id="3fa2" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">用dplyr的语法查询</strong></p><p id="bf5e" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">除了传递SQL查询，您还可以使用dplyr语法导航数据库。例如，要从<em class="kt"> film </em>表中选择所有内容，我只需要将<em class="kt"> film </em>表中的所有内容存储到一个名为film_table的R对象中。调用film_table对象将为您提供<em class="kt"> film </em>表中变量的前10行的快照。</p><figure class="ku kv kw kx fd ij"><div class="bz dy l di"><div class="ky kz l"/></div></figure><figure class="ku kv kw kx fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ll"><img src="../Images/b347184dba5bc2a1321b9595a3f7ef05.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bZubZDh70Hb1SYa_izvEAg.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">使用dplyr语法将返回与使用SQL语法相同的结果</figcaption></figure><p id="7336" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">如果想选择某些变量，可以使用dplyr中的select()函数</p><figure class="ku kv kw kx fd ij"><div class="bz dy l di"><div class="ky kz l"/></div></figure><figure class="ku kv kw kx fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lm"><img src="../Images/76d9a2d28039a97b1b827560c00c9de1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*q-EmJx4oYAnKGmcE5aoruw.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">r中select()函数的结果。它返回的结果与我们在SQL中使用{SELECT film_id，title，rental_rate，replacement_cost，rating FROM film}查询时返回的结果相同</figcaption></figure><p id="2615" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">作为在SQL中选择DISTINCT语法的替代方法，您还可以使用dplyr语法执行以下操作。</p><figure class="ku kv kw kx fd ij"><div class="bz dy l di"><div class="ky kz l"/></div></figure><figure class="ku kv kw kx fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ln"><img src="../Images/75375ee558d0646ce82ddf16b5579041.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZbPI1rpEjPrW_miJZSgurQ.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">使用distinct函数的dplyr语法的结果</figcaption></figure><p id="ee83" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">使用dplyr，您可以通过在每个任务后传递“%&gt;%”符号来告诉R使用几个函数执行几个任务。它使得任务管道的构造更加容易，可读性更好。</p><p id="2679" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">例如，如果我们想在R中重新创建这个SQL WHERE过滤语法，我们可以使用filter、select和order函数执行后续任务。</p><p id="2d9b" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">用于过滤的SQL语法</strong></p><p id="773d" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">如果我们想从<em class="kt"> film </em>表中获取变量<strong class="ix hj"> title、length、replacement_cost、rental_rate、</strong>和<strong class="ix hj"> rating </strong>，只针对分级为PG-13或PG的片头。</p><figure class="ku kv kw kx fd ij"><div class="bz dy l di"><div class="ky kz l"/></div></figure><figure class="ku kv kw kx fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lk"><img src="../Images/ae55ab8b5846a1dc66da488611de6e59.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QzUYTrI_WzqQNXXBiCXzdA.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">过滤只有PG-13或PG分级的电影标题的结果。</figcaption></figure><p id="2667" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">用于过滤的dplyr语法</strong></p><p id="2acd" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">解决相同问题的程序:</p><p id="0517" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">首先，我们要求R基于某些值进行过滤，在这种情况下，我希望过滤分级= PG-13或分级= PG的电影标题。使用“%&gt;%”符号，我让R继续选择变量的任务，然后根据列租赁价格以升序对结果进行排序。该语法将返回与SQL语法相同的结果。</p><figure class="ku kv kw kx fd ij"><div class="bz dy l di"><div class="ky kz l"/></div></figure><figure class="ku kv kw kx fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lo"><img src="../Images/1565aba40bbffc5572d243c1af1c7d25.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9GpXDEFaU6c0dK6h9fYtJQ.png"/></div></div></figure><h2 id="9daf" class="jt ju hi bd jv jw jx jy jz ka kb kc kd jg ke kf kg jk kh ki kj jo kk kl km kn bi translated">dplyr语法的懒惰</h2><p id="1da0" class="pw-post-body-paragraph iv iw hi ix b iy ko ja jb jc kp je jf jg kq ji jj jk kr jm jn jo ks jq jr js hb bi translated">在前面的例子中，R所做的仅仅是向SQL发送命令，以便R可以提取数据库的快照。如果您注意上面的filter select语法的调用，您可能会注意到在调用的第一行有“Source:”字样。它说“懒惰查询”没有行和5列的信息[？？x 5]。这就是我们通过r导航数据库时发生的情况。</p><p id="7da1" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">正如我所说的，R只是发送命令，给你一个数据库内容的快照。它不会从数据库中检索任何内容，除非您明确要求它这样做。为了从数据库中检索数据，我们可以在dplyr语法的最后添加collect()函数。</p><figure class="ku kv kw kx fd ij"><div class="bz dy l di"><div class="ky kz l"/></div></figure><p id="2812" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这种在末尾不传递collect()函数的语法会将<em class="kt"> NA 5 </em>返回到语法dim(subset_film_0)。这是因为R只发送命令并给你一个数据库的快照。对象subset_film_0的类将是“tbl_lazy”(以及其他名称)，表明R在检索数据时是“懒惰的”。</p><p id="ebfd" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">现在我们来看看通过collect()函数后，新对象subset_film在维度和类上的区别。</p><figure class="ku kv kw kx fd ij"><div class="bz dy l di"><div class="ky kz l"/></div></figure><p id="d084" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">Collect()允许R从数据库中检索数据。然后，数据被存储为数据帧，而不再是tbl_lazy。现在，如果我们检查维度，我们将获得数据框的行和列的总数。subset_film数据帧包含417个观测值和5个变量。</p><p id="c4dc" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">将数据存储为数据框后，您可以使用它进行其他分析。你可以做EDA，可视化，建模等。一切尽在不言中。高效且省事！</p></div><div class="ab cl lc ld gp le" role="separator"><span class="lf bw bk lg lh li"/><span class="lf bw bk lg lh li"/><span class="lf bw bk lg lh"/></div><div class="hb hc hd he hf"><h2 id="bde8" class="jt ju hi bd jv jw jx jy jz ka kb kc kd jg ke kf kg jk kh ki kj jo kk kl km kn bi translated">R中的复杂查询</h2><p id="5833" class="pw-post-body-paragraph iv iw hi ix b iy ko ja jb jc kp je jf jg kq ji jj jk kr jm jn jo ks jq jr js hb bi translated">我们还可以在R中进行复杂的查询。在R和SQL中，语法管道背后的直觉必须是相同的，即使语法的结构不同。</p><p id="7015" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">例如，我想从dvdrental数据库中找到租借次数最多的电影。我需要租得最多的电影的片名。</p><p id="31df" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">为此，我需要检查每部电影出租了多少次。这些信息可以在<em class="kt">租赁</em>表中找到。电影片名信息存储在<em class="kt">电影</em>表中。自然，我们可以用相同的标识符连接<em class="kt">出租</em>表和<em class="kt">电影</em>表。因此，首先检查这些表中有什么。</p><p id="b218" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">中的<em class="kt">胶片</em>表</strong></p><figure class="ku kv kw kx fd ij"><div class="bz dy l di"><div class="ky kz l"/></div></figure><figure class="ku kv kw kx fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lo"><img src="../Images/efed4e1b41d6530f85e25ff08c00934e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZhsSElPQoomJnxT4NcA-bw.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated"><em class="lp">胶片表中包含的变量。请注意，在此图所示的内容之外还有另外3个变量</em></figcaption></figure><p id="a5da" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">中的<em class="kt">租金</em>表</strong></p><figure class="ku kv kw kx fd ij"><div class="bz dy l di"><div class="ky kz l"/></div></figure><figure class="ku kv kw kx fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lq"><img src="../Images/5e50bab2b4b347917baa0ec9069a4617.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7t-kNAy-wU-9AwsUfa4ynQ.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">租赁表中包含的变量。</figcaption></figure><p id="6e05" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">原来我们在<em class="kt">租赁</em>和<em class="kt">电影</em>表之间找不到相同的标识符。</p><p id="2e26" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">所以，<em class="kt">出租</em>和<em class="kt">电影</em>表之间没有相似的标识符。但是<em class="kt">租赁</em>表中有inventory_id，在<em class="kt">库存</em>表中也可以找到。当我们检查<em class="kt">库存</em>表时，发现有film_id，这是在<em class="kt">电影</em>表中查找电影标题的标识符。</p><p id="7a7c" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">在<em class="kt">库存</em>表</strong></p><figure class="ku kv kw kx fd ij"><div class="bz dy l di"><div class="ky kz l"/></div></figure><figure class="ku kv kw kx fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lm"><img src="../Images/cf7ee2eab6c6a0d24412514e7a6d10e2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3wmEsCltnmpkZrgpupwzpQ.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">库存表中包含的变量。还有film_id，这是一个相同的标识符，也可以在film表中找到。还有inventory_id，这是一个相同的标识符，可以在rental中找到</figcaption></figure><p id="f3c3" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在某种程度上，<em class="kt">库存</em>表可以作为<em class="kt">租金</em>和<em class="kt">电影</em>表之间的桥梁，以找到每个电影名称的总租金。</p><p id="cb40" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">使用dplyr语法编写复杂查询</strong></p><p id="bb7b" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我现在需要做的是通过inventory_id内部连接<em class="kt">租赁</em>和<em class="kt">库存</em>表。我将首先使用dplyr语法。</p><figure class="ku kv kw kx fd ij"><div class="bz dy l di"><div class="ky kz l"/></div></figure><figure class="ku kv kw kx fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lr"><img src="../Images/8f4b41c415a4305163b5be02a0bbf47a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xl879HBrQhq0gKhpqgc6hQ.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">join_tbl中包含的变量。租赁表和库存表之间内部联接的结果。</figcaption></figure><p id="a6bf" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">然后，为了获得电影的总租借次数，我通过film_id计算总租借次数。film_id在join_tbl中出现了多次。一次租赁是针对一个film_id进行的，所以我可以只统计film_id的多次出现。</p><p id="c872" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在加入<em class="kt">租赁</em>和<em class="kt">库存</em>表(存储在join_tbl中)后，我对film_id进行分组，然后计算join_tbl中出现了多少个不同的film_id。(存储在<strong class="ix hj">计数</strong>变量中)。为了得到电影标题，我用<em class="kt">电影</em>表加入结果。</p><p id="b21c" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">为了找到租得最多的电影，我根据<strong class="ix hj"> count </strong>变量按降序排列结果。最后，我从film_db中只选择了变量<strong class="ix hj">标题、计数、替换成本和评级</strong>。然后，我必须通过在语法末尾传递collect()函数，将它存储在我的R环境中。</p><figure class="ku kv kw kx fd ij"><div class="bz dy l di"><div class="ky kz l"/></div></figure><figure class="ku kv kw kx fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lo"><img src="../Images/7d9493e68d7703d86ec43e7aa1fb0426.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CBmoc7FfuO1mVe2FUH9jZw.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">被多次租借的电影的名称，从最大租借计数到最小租借计数排序。</figcaption></figure><p id="5d02" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">每部电影的总租金存储在<strong class="ix hj">计数</strong>变量中。这个结果已经从最大租赁到最小租赁进行了排序。我想得到前五名，所以我这样做:</p><figure class="ku kv kw kx fd ij"><div class="bz dy l di"><div class="ky kz l"/></div></figure><figure class="ku kv kw kx fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ls"><img src="../Images/34cd32ca432676434b0b27fca49a5760.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*76ng7SV88S8W-7CSEYGsdA.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">出租最多的五部电影的名字。</figcaption></figure><p id="2dc4" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这就对了，现在你得到了最受欢迎的五部电影的名字！</p><p id="ef60" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">使用SQL语法编写复杂查询</strong></p><p id="1027" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">同样的管道可以应用于编写一个SQL语法来获得最常租借的电影。在SQL中，我会写:</p><figure class="ku kv kw kx fd ij"><div class="bz dy l di"><div class="ky kz l"/></div></figure><figure class="ku kv kw kx fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ln"><img src="../Images/c77d8678fcdf9306fb6841e856cd8d6a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zim-jHvbb8thaqk8RyovOg.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">SQL查询的结果是前五名最常租借的电影。</figcaption></figure><p id="56df" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">语法的管道基本上是相同的。所以我创建了嵌套内部连接。首先在库存id上的<em class="kt">租赁</em>和<em class="kt">库存</em>表之间，库存id是在两个表中都存在的标识符。其次是在先前与电影id上的<em class="kt">电影</em>表的连接结果之间，电影id是出现在<em class="kt">电影</em>和<em class="kt">库存</em>表中的标识符。</p><p id="bc44" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我对按film_id分组的film_id的多次出现进行计数，并将结果存储在<strong class="ix hj"> count </strong>变量中。然后我对结果进行降序排序，只返回前五行。</p><h2 id="7a8e" class="jt ju hi bd jv jw jx jy jz ka kb kc kd jg ke kf kg jk kh ki kj jo kk kl km kn bi translated">一些优点和缺点</h2><p id="c5af" class="pw-post-body-paragraph iv iw hi ix b iy ko ja jb jc kp je jf jg kq ji jj jk kr jm jn jo ks jq jr js hb bi translated">在R中使用dplyr尝试了一些SQL语法之后，我发现了使用R查询数据库的利弊。</p><p id="b8df" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">使用R的优点</strong></p><ul class=""><li id="8e30" class="lt lu hi ix b iy iz jc jd jg lv jk lw jo lx js ly lz ma mb bi translated">在R中，你可以做任何事情，而不必在软件之间转换</li></ul><p id="059a" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我对SQL的理解是，我必须提取查询结果，并在另一个软件(如Excel、Tableau、PowerBI)中使用它们进行可视化。</p><p id="d42c" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我也有查询结果，并在另一个软件(如Excel，Tableau，PowerBI)中使用它们进行可视化。</p><p id="cc3a" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">软件之间的转换是需要时间的，有时候SQL文件在某个软件打不开还得处理一些调试。因此，能够在一个软件中完成所有这些事情真的非常高效，节省了我的时间。然而，如果您在SQL中查询，提取结果，并导入到R中，可能不会有太多问题。</p><ul class=""><li id="0e85" class="lt lu hi ix b iy iz jc jd jg lv jk lw jo lx js ly lz ma mb bi translated">如果您已经知道如何在R中建立与数据库的连接，那么您可能根本不需要学习SQL</li></ul><p id="ca8b" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">正如我之前向您展示的那样，建立一个连接并使用dplyr语法找到自己的路，就足以在数据库系统中导航。如果你的工作主要是收集见解，你可以用dplyr中的知识做更多的事情。</p><p id="13c8" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">仅使用R的缺点</strong></p><ul class=""><li id="4bd2" class="lt lu hi ix b iy iz jc jd jg lv jk lw jo lx js ly lz ma mb bi translated">你可以收集见解，但你不能维护一个数据库</li></ul><p id="1041" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这是因为R中没有相关的包(据我所知)允许你在SQL数据库中添加、更新或删除条目。一些认证也可能拒绝你这样做。</p><p id="f77a" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">至少使用dplyr语法，您不能直接在数据库中添加、更新或删除条目。您可以将数据库作为数据框进行查询和采集，并进行本地更改，但不能在数据库中进行更改。这就是数据库保护其数据完整性的方式。</p><p id="ad1e" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">如果你的工作涉及数据库管理，你需要学习SQL才能有效。</p><ul class=""><li id="b7d0" class="lt lu hi ix b iy iz jc jd jg lv jk lw jo lx js ly lz ma mb bi translated">对连接的身份验证可能会被拒绝或出错</li></ul><p id="ebba" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">同样，这是驱动程序管理器保护数据库完整性的一种方式。如果您不能创建连接，您只需要在SQL中查询并提取结果，以便在另一个软件中进一步分析。</p><p id="3356" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">不管利弊如何，学习一门新语言总是好的。它丰富了你的知识，你可以在两者之间建立一个独特的工作管道。</p><h2 id="6690" class="jt ju hi bd jv jw jx jy jz ka kb kc kd jg ke kf kg jk kh ki kj jo kk kl km kn bi translated">参考</h2><ul class=""><li id="328a" class="lt lu hi ix b iy ko jc kp jg mc jk md jo me js ly lz ma mb bi translated">数据库系统:<a class="ae iu" href="https://www.oracle.com/database/what-is-database/" rel="noopener ugc nofollow" target="_blank">什么是数据库| Oracle </a></li><li id="97ea" class="lt lu hi ix b iy mf jc mg jg mh jk mi jo mj js ly lz ma mb bi translated">dplyr cheat sheet:【rstudio.com T2】数据-争论-cheat sheet</li><li id="77b1" class="lt lu hi ix b iy mf jc mg jg mh jk mi jo mj js ly lz ma mb bi translated">来自一位R用户的体验:<a class="ae iu" href="https://rstudio.com/resources/rstudioglobal-2021/the-dynamic-duo-sql-and-r/" rel="noopener ugc nofollow" target="_blank">动态二人组:SQL &amp; R — RStudio </a></li></ul></div></div>    
</body>
</html>