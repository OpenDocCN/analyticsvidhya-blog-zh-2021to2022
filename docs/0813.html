<html>
<head>
<title>Azure Data Factory — mlflow with Azure data bricks</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Azure数据工厂—使用Azure数据块的mlflow</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/azure-data-factory-mlflow-with-azure-data-bricks-d247bc0bc14a?source=collection_archive---------14-----------------------#2021-02-01">https://medium.com/analytics-vidhya/azure-data-factory-mlflow-with-azure-data-bricks-d247bc0bc14a?source=collection_archive---------14-----------------------#2021-02-01</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><h1 id="b4aa" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">使用mlflow运行机器学习的培训，并使用Azure data factory实现自动化</h1><h1 id="c888" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">先决条件</h1><ul class=""><li id="10aa" class="jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju bi translated">Azure帐户</li><li id="56f9" class="jd je hi jf b jg jv ji jw jk jx jm jy jo jz jq jr js jt ju bi translated">创建资源组</li><li id="4975" class="jd je hi jf b jg jv ji jw jk jx jm jy jo jz jq jr js jt ju bi translated">创建Azure databricks工作区</li><li id="b632" class="jd je hi jf b jg jv ji jw jk jx jm jy jo jz jq jr js jt ju bi translated">使用databricks runtime 7.5创建一个集群，并将ML作为选项</li><li id="a5b7" class="jd je hi jf b jg jv ji jw jk jx jm jy jo jz jq jr js jt ju bi translated">等待群集启动</li><li id="6d53" class="jd je hi jf b jg jv ji jw jk jx jm jy jo jz jq jr js jt ju bi translated">将ml . combuste . mleap:mleap-spark _ 2.11:0.13 . 0安装为maven</li><li id="38f4" class="jd je hi jf b jg jv ji jw jk jx jm jy jo jz jq jr js jt ju bi translated">创建Azure数据工厂</li></ul><h1 id="db49" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">为示例培训编写代码</h1><ul class=""><li id="a388" class="jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju bi translated">创建新笔记本</li><li id="a210" class="jd je hi jf b jg jv ji jw jk jx jm jy jo jz jq jr js jt ju bi translated">选择python作为首选语言</li><li id="0e13" class="jd je hi jf b jg jv ji jw jk jx jm jy jo jz jq jr js jt ju bi translated">加载训练数据</li></ul><pre class="ka kb kc kd fd ke kf kg kh aw ki bi"><span id="4eaf" class="kj ig hi kf b fi kk kl l km kn">df = spark.read.parquet("/databricks-datasets/news20.binary/data-001/training").select("text", "topic")<br/>df.cache()<br/>display(df)</span></pre><ul class=""><li id="ff42" class="jd je hi jf b jg ko ji kp jk kq jm kr jo ks jq jr js jt ju bi translated">导入ML库</li></ul><pre class="ka kb kc kd fd ke kf kg kh aw ki bi"><span id="d124" class="kj ig hi kf b fi kk kl l km kn">from pyspark.ml import Pipeline<br/>from pyspark.ml.classification import DecisionTreeClassifier<br/>from pyspark.ml.feature import StringIndexer, Tokenizer, HashingTF<br/>from pyspark.ml.evaluation import MulticlassClassificationEvaluator<br/>from pyspark.ml.tuning import CrossValidator, ParamGridBuilder</span></pre><ul class=""><li id="0891" class="jd je hi jf b jg ko ji kp jk kq jm kr jo ks jq jr js jt ju bi translated">定义管道组件</li></ul><pre class="ka kb kc kd fd ke kf kg kh aw ki bi"><span id="44cf" class="kj ig hi kf b fi kk kl l km kn"># Define pipeline components<br/>labelIndexer = StringIndexer(inputCol="topic", outputCol="label", handleInvalid="keep")<br/>tokenizer = Tokenizer(inputCol="text", outputCol="words")<br/>hashingTF = HashingTF(inputCol="words", outputCol="features")<br/>dt = DecisionTreeClassifier()</span><span id="6860" class="kj ig hi kf b fi kt kl l km kn"># Construct a Pipeline object using the defined components<br/>pipeline = Pipeline(stages=[labelIndexer, tokenizer, hashingTF, dt])</span></pre><ul class=""><li id="cd5c" class="jd je hi jf b jg ko ji kp jk kq jm kr jo ks jq jr js jt ju bi translated">编写代码来训练模型</li><li id="1775" class="jd je hi jf b jg jv ji jw jk jx jm jy jo jz jq jr js jt ju bi translated">使用ml流来跟踪它</li><li id="6677" class="jd je hi jf b jg jv ji jw jk jx jm jy jo jz jq jr js jt ju bi translated">确保在set_experiment中指定了实验名称，以便笔记本能够正确运行。</li></ul><pre class="ka kb kc kd fd ke kf kg kh aw ki bi"><span id="e473" class="kj ig hi kf b fi kk kl l km kn">import mlflow<br/>import mlflow.mleap<br/><br/>def fit_model():<br/>  # Start a new MLflow run<br/>  exp_id = mlflow.set_experiment('/Users/user@company.com/sample1')<br/>  with mlflow.start_run(experiment_id=exp_id, run_name="online") as run:<br/>    # Fit the model, performing cross validation to improve accuracy<br/>    paramGrid = ParamGridBuilder().addGrid(hashingTF.numFeatures, [1000, 2000]).build()<br/>    cv = CrossValidator(estimator=pipeline, evaluator=MulticlassClassificationEvaluator(), estimatorParamMaps=paramGrid)<br/>    cvModel = cv.fit(df)<br/>    model = cvModel.bestModel<br/>  <br/>    # Log the model within the MLflow run<br/>    mlflow.mleap.log_model(spark_model=model, sample_input=df, artifact_path="model")</span></pre><ul class=""><li id="a698" class="jd je hi jf b jg ko ji kp jk kq jm kr jo ks jq jr js jt ju bi translated">运行模型</li></ul><pre class="ka kb kc kd fd ke kf kg kh aw ki bi"><span id="b76a" class="kj ig hi kf b fi kk kl l km kn">fit_model()</span></pre><ul class=""><li id="35ef" class="jd je hi jf b jg ko ji kp jk kq jm kr jo ks jq jr js jt ju bi translated">我还为设置创建了样本笔记本</li><li id="2e32" class="jd je hi jf b jg jv ji jw jk jx jm jy jo jz jq jr js jt ju bi translated">设置笔记本只是创建必要的blob连接和其他预清理设置</li><li id="eabe" class="jd je hi jf b jg jv ji jw jk jx jm jy jo jz jq jr js jt ju bi translated">然后，我使用Spark SQL创建了一个用于ETL的样例笔记本</li><li id="22e9" class="jd je hi jf b jg jv ji jw jk jx jm jy jo jz jq jr js jt ju bi translated">这里的想法是首先创建ETL/ELT或数据工程，然后运行培训</li></ul><h1 id="e3ab" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">Azure Data Factory将所有3台笔记本协调为一个连续的流程</h1><h1 id="9059" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">整体数据工厂编排</h1><figure class="ka kb kc kd fd kv er es paragraph-image"><div role="button" tabindex="0" class="kw kx di ky bf kz"><div class="er es ku"><img src="../Images/56e0ac797291e8e5338b095b3bf8f6a2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*rZvdQNoxPzhUypw3.jpg"/></div></div></figure><ul class=""><li id="ccd8" class="jd je hi jf b jg ko ji kp jk kq jm kr jo ks jq jr js jt ju bi translated">让我们创建一个新的管道</li><li id="f657" class="jd je hi jf b jg jv ji jw jk jx jm jy jo jz jq jr js jt ju bi translated">给管道命名</li><li id="ebfc" class="jd je hi jf b jg jv ji jw jk jx jm jy jo jz jq jr js jt ju bi translated">在画布上拖放数据块笔记本</li><li id="abff" class="jd je hi jf b jg jv ji jw jk jx jm jy jo jz jq jr js jt ju bi translated">创建新数据集并为azure databricks工作区创建链接服务</li><li id="0d48" class="jd je hi jf b jg jv ji jw jk jx jm jy jo jz jq jr js jt ju bi translated">使用托管身份连接上述数据块工作区</li><li id="0b6e" class="jd je hi jf b jg jv ji jw jk jx jm jy jo jz jq jr js jt ju bi translated">选择设置笔记本</li></ul><figure class="ka kb kc kd fd kv er es paragraph-image"><div role="button" tabindex="0" class="kw kx di ky bf kz"><div class="er es lc"><img src="../Images/833034150bdbe9ba7fc7be014a7e6891.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*9oOtGpqGywclMUn5.jpg"/></div></div></figure><ul class=""><li id="be58" class="jd je hi jf b jg ko ji kp jk kq jm kr jo ks jq jr js jt ju bi translated">在画布上拖放数据块笔记本</li><li id="ec56" class="jd je hi jf b jg jv ji jw jk jx jm jy jo jz jq jr js jt ju bi translated">创建新数据集并为azure databricks工作区创建链接服务</li><li id="c232" class="jd je hi jf b jg jv ji jw jk jx jm jy jo jz jq jr js jt ju bi translated">使用托管身份连接上述数据块工作区</li><li id="9476" class="jd je hi jf b jg jv ji jw jk jx jm jy jo jz jq jr js jt ju bi translated">选择ETL笔记本</li></ul><figure class="ka kb kc kd fd kv er es paragraph-image"><div role="button" tabindex="0" class="kw kx di ky bf kz"><div class="er es ld"><img src="../Images/df638a2e6f388a69be26d16df61e66d0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*Y6cMBrQ3Zh21s8q2.jpg"/></div></div></figure><ul class=""><li id="5a8a" class="jd je hi jf b jg ko ji kp jk kq jm kr jo ks jq jr js jt ju bi translated">在画布上拖放数据块笔记本</li><li id="7f59" class="jd je hi jf b jg jv ji jw jk jx jm jy jo jz jq jr js jt ju bi translated">创建新数据集并为azure databricks工作区创建链接服务</li><li id="99a6" class="jd je hi jf b jg jv ji jw jk jx jm jy jo jz jq jr js jt ju bi translated">将databricks运行时用作基于ML的运行时。我用的是7.5毫升</li></ul><figure class="ka kb kc kd fd kv er es paragraph-image"><div role="button" tabindex="0" class="kw kx di ky bf kz"><div class="er es le"><img src="../Images/1389365ac1fc93940fc10e60e71e9a34.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*eVYCJL0dPvreLh_z.jpg"/></div></div></figure><ul class=""><li id="c38b" class="jd je hi jf b jg ko ji kp jk kq jm kr jo ks jq jr js jt ju bi translated">使用托管身份连接上述数据块工作区</li><li id="1a8d" class="jd je hi jf b jg jv ji jw jk jx jm jy jo jz jq jr js jt ju bi translated">选择mlflow笔记本</li></ul><figure class="ka kb kc kd fd kv er es paragraph-image"><div role="button" tabindex="0" class="kw kx di ky bf kz"><div class="er es lf"><img src="../Images/e075ae9d2efefc33c3beac9d26760137.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*MDVWT12vuNZNayL9.jpg"/></div></div></figure><ul class=""><li id="5046" class="jd je hi jf b jg ko ji kp jk kq jm kr jo ks jq jr js jt ju bi translated">保存并发布</li><li id="1ace" class="jd je hi jf b jg jv ji jw jk jx jm jy jo jz jq jr js jt ju bi translated">单击立即触发并运行管道。</li><li id="3ad4" class="jd je hi jf b jg jv ji jw jk jx jm jy jo jz jq jr js jt ju bi translated">转到监视器并查看状态</li></ul><figure class="ka kb kc kd fd kv er es paragraph-image"><div role="button" tabindex="0" class="kw kx di ky bf kz"><div class="er es lg"><img src="../Images/1dad9c7f4f9e1d30b22ba35a512c11d3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*V8NVUjd10_iLiPDG.jpg"/></div></div></figure><ul class=""><li id="dafd" class="jd je hi jf b jg ko ji kp jk kq jm kr jo ks jq jr js jt ju bi translated">状态是绿色的，那么我们是好的</li><li id="aea4" class="jd je hi jf b jg jv ji jw jk jx jm jy jo jz jq jr js jt ju bi translated">因此，现在我们可以编排和管理运行时间表</li></ul></div><div class="ab cl lh li gp lj" role="separator"><span class="lk bw bk ll lm ln"/><span class="lk bw bk ll lm ln"/><span class="lk bw bk ll lm"/></div><div class="hb hc hd he hf"><p id="d33d" class="pw-post-body-paragraph lo lp hi jf b jg ko lq lr ji kp ls lt jk lu lv lw jm lx ly lz jo ma mb mc jq hb bi translated"><em class="md">最初发表于</em><a class="ae me" href="https://github.com/balakreshnan/Accenture/blob/master/mlflow/adfmlflow.md" rel="noopener ugc nofollow" target="_blank"><em class="md">【https://github.com】</em></a><em class="md">。</em></p></div></div>    
</body>
</html>