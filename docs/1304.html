<html>
<head>
<title>How to convert grayscale DICOM file to RGB DICOM file with Python</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何用Python将灰度DICOM文件转换成RGB DICOM文件</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/how-to-convert-grayscale-dicom-file-to-rgb-dicom-file-with-python-df86ac055bd?source=collection_archive---------7-----------------------#2021-02-23">https://medium.com/analytics-vidhya/how-to-convert-grayscale-dicom-file-to-rgb-dicom-file-with-python-df86ac055bd?source=collection_archive---------7-----------------------#2021-02-23</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="b25c" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">KiTS19挑战中肾脏CT数据的使用案例</h2></div><h1 id="5d05" class="ix iy hi bd iz ja jb jc jd je jf jg jh io ji ip jj ir jk is jl iu jm iv jn jo bi translated">TL；速度三角形定位法(dead reckoning)</h1><ul class=""><li id="bde7" class="jp jq hi jr b js jt ju jv jw jx jy jz ka kb kc kd ke kf kg bi translated">要将DICOM文件从灰度转换为RGB，您应该修改几个DICOM标签，而不仅仅是像素数据。</li><li id="acd0" class="jp jq hi jr b js kh ju ki jw kj jy kk ka kl kc kd ke kf kg bi translated"><a class="ae km" href="#7761" rel="noopener ugc nofollow">完整的源代码</a>在这篇文章的末尾。</li></ul><h1 id="dfd0" class="ix iy hi bd iz ja jb jc jd je jf jg jh io ji ip jj ir jk is jl iu jm iv jn jo bi translated">介绍</h1><p id="5ba4" class="pw-post-body-paragraph kn ko hi jr b js jt ij kp ju jv im kq jw kr ks kt jy ku kv kw ka kx ky kz kc hb bi translated"><a class="ae km" href="https://www.dicomstandard.org/" rel="noopener ugc nofollow" target="_blank"> DICOM </a>(医学中的数字成像和通信)是存储和传输医学图像的国际标准，在医院中DICOM文件大多使用PACS(图像存档和通信系统)来查看。</p><p id="3b1b" class="pw-post-body-paragraph kn ko hi jr b js la ij kp ju lb im kq jw lc ks kt jy ld kv kw ka le ky kz kc hb bi translated">虽然X射线、CT和MR等放射图像是灰度图像，但您可能希望编辑RGB图像，例如用于注释或图像处理。编辑后的图像应以DICOM格式提供，以便医生在临床实践中进行解释。</p><p id="4e4c" class="pw-post-body-paragraph kn ko hi jr b js la ij kp ju lb im kq jw lc ks kt jy ld kv kw ka le ky kz kc hb bi translated">这篇文章旨在提供如何用Python将灰度DICOM文件转换成RGB DICOM文件，主要使用<a class="ae km" href="https://pydicom.github.io/" rel="noopener ugc nofollow" target="_blank"> Pydicom </a>包。</p><blockquote class="lf lg lh"><p id="eb19" class="kn ko li jr b js la ij kp ju lb im kq lj lc ks kt lk ld kv kw ll le ky kz kc hb bi translated">请注意:这篇文章不包括处理DICOM数据的基本方法。对于那些不熟悉的，请查看<a class="ae km" href="https://pydicom.github.io/pydicom/stable/auto_examples/index.html" rel="noopener ugc nofollow" target="_blank"> Pydicom文档</a>。</p></blockquote><p id="1960" class="pw-post-body-paragraph kn ko hi jr b js la ij kp ju lb im kq jw lc ks kt jy ld kv kw ka le ky kz kc hb bi translated">这里我们用的是<a class="ae km" href="https://kits19.grand-challenge.org/" rel="noopener ugc nofollow" target="_blank"> KiTS19 </a> (2019肾肿瘤分割挑战赛)的公开CT数据，可以在这里下载<a class="ae km" href="https://github.com/neheller/kits19" rel="noopener ugc nofollow" target="_blank">。</a></p><p id="0536" class="pw-post-body-paragraph kn ko hi jr b js la ij kp ju lb im kq jw lc ks kt jy ld kv kw ka le ky kz kc hb bi translated">假设你开发了一个在腹部CT上发现肾癌的模型。我们将在肿瘤周围绘制一个<strong class="jr hj"> <em class="li">红色</em> </strong>包围框，并将图像保存为DICOM格式。</p><h1 id="d336" class="ix iy hi bd iz ja jb jc jd je jf jg jh io ji ip jj ir jk is jl iu jm iv jn jo bi translated">加载DICOM文件并处理像素数据</h1><p id="6446" class="pw-post-body-paragraph kn ko hi jr b js jt ij kp ju jv im kq jw kr ks kt jy ku kv kw ka kx ky kz kc hb bi translated">首先用<code class="du lm ln lo lp b">pydicom</code>加载DICOM文件，可以得到用<a class="ae km" href="https://radiopaedia.org/articles/hounsfield-unit" rel="noopener ugc nofollow" target="_blank"> Hounsfield单位</a> (HU)表示的像素数据如下:</p><pre class="lq lr ls lt fd lu lp lv lw aw lx bi"><span id="e682" class="ly iy hi lp b fi lz ma l mb mc">import pydicom</span><span id="cadd" class="ly iy hi lp b fi md ma l mb mc">ds = pydicom.dcmread(INPUT_DICOM_PATH)<br/>img = ds.pixel_array # dtype = uint16<br/>img = img.astype(float)<br/>img = img*ds.RescaleSlope + ds.RescaleIntercept</span></pre><p id="d5f3" class="pw-post-body-paragraph kn ko hi jr b js la ij kp ju lb im kq jw lc ks kt jy ld kv kw ka le ky kz kc hb bi translated">由于Hounsfield单位的范围从大约-1000到超过2000，所以可以使用适当的CT窗口(例如，对于腹部CT，宽度:400，水平:50)来调整图像的对比度和亮度。</p><pre class="lq lr ls lt fd lu lp lv lw aw lx bi"><span id="b4e7" class="ly iy hi lp b fi lz ma l mb mc">def apply_ct_window(img, window):<br/>    # window = (window width, window level)<br/>    R = (img-window[1]+0.5*window[0])/window[0]<br/>    R[R&lt;0] = 0<br/>    R[R&gt;1] = 1<br/>    return R</span><span id="40a3" class="ly iy hi lp b fi md ma l mb mc">display_img = apply_ct_window(img, [400,50])</span></pre><figure class="lq lr ls lt fd mf er es paragraph-image"><div class="er es me"><img src="../Images/f0e5d34ac44261dbc9d65f07cb43b56e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1024/format:webp/1*wUIaL_zTt7pvqLgbAR3bZg.png"/></div><figcaption class="mi mj et er es mk ml bd b be z dx translated">案例26，来自KiTS19数据集的图像174</figcaption></figure><p id="90ab" class="pw-post-body-paragraph kn ko hi jr b js la ij kp ju lb im kq jw lc ks kt jy ld kv kw ka le ky kz kc hb bi translated">让我们在肿瘤周围画一个红色的边框。在这里，我使用了<code class="du lm ln lo lp b">PIL </code>库来这样做，但是你可以做任何你想做的事情。只要确保在任何改变之前将图像从灰度转换为RGB，并在编辑后获得一个<code class="du lm ln lo lp b">ndarray</code>(不是枕头图像)。</p><pre class="lq lr ls lt fd lu lp lv lw aw lx bi"><span id="e333" class="ly iy hi lp b fi lz ma l mb mc">import numpy as np</span><span id="fde3" class="ly iy hi lp b fi md ma l mb mc"># for this particular example<br/>top, left, bottom, right = [211,99,291,158]<br/>thickness = 4</span><span id="c770" class="ly iy hi lp b fi md ma l mb mc">img_bbox = Image.fromarray((255*display_img).astype('uint8'))<br/>img_bbox = img_bbox.convert('RGB')</span><span id="0730" class="ly iy hi lp b fi md ma l mb mc">draw = ImageDraw.Draw(img_bbox)<br/>for i in range(thickness):<br/>    draw.rectangle(<br/>        [left + i, top + i, right - i, bottom - i],<br/>        outline=(255,0,0)<br/>    )<br/>del draw</span><span id="31e7" class="ly iy hi lp b fi md ma l mb mc">img_bbox = np.asarray(img_bbox)</span></pre><figure class="lq lr ls lt fd mf er es paragraph-image"><div class="er es me"><img src="../Images/e87deac66a45ac2c33b551002c081f64.png" data-original-src="https://miro.medium.com/v2/resize:fit:1024/format:webp/1*2Q4a7zzQeA3zqakrjr-Kfw.png"/></div><figcaption class="mi mj et er es mk ml bd b be z dx translated">CT图像转换为RGB，肿瘤上有红色边框</figcaption></figure><p id="15f7" class="pw-post-body-paragraph kn ko hi jr b js la ij kp ju lb im kq jw lc ks kt jy ld kv kw ka le ky kz kc hb bi translated">我们现在有一个处理过的图像。我们用DICOM格式保存吧。</p><h1 id="0f09" class="ix iy hi bd iz ja jb jc jd je jf jg jh io ji ip jj ir jk is jl iu jm iv jn jo bi translated">保存新的像素数据</h1><p id="cd12" class="pw-post-body-paragraph kn ko hi jr b js jt ij kp ju jv im kq jw kr ks kt jy ku kv kw ka kx ky kz kc hb bi translated">要覆盖像素数据，我们只需将新图像从数组转换为字节。但就这样吗？让我们保存文件并在DICOM查看器上检查(这里我们使用了<a class="ae km" href="https://www.radiantviewer.com/" rel="noopener ugc nofollow" target="_blank"> RadiAnt DICOM查看器</a>)。</p><pre class="lq lr ls lt fd lu lp lv lw aw lx bi"><span id="1493" class="ly iy hi lp b fi lz ma l mb mc">ds.PixelData = img_bbox.tobytes()<br/>ds.save_as(OUTPUT_DICOM_PATH)</span></pre><figure class="lq lr ls lt fd mf er es paragraph-image"><div class="er es me"><img src="../Images/3c4163bb3e86b904849e9274d9c15d8d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1024/format:webp/1*eFiXK1gNC1AaJ2Oeu9CI4w.png"/></div><figcaption class="mi mj et er es mk ml bd b be z dx translated">哦不…</figcaption></figure><p id="1f69" class="pw-post-body-paragraph kn ko hi jr b js la ij kp ju lb im kq jw lc ks kt jy ld kv kw ka le ky kz kc hb bi translated">出事了。我们做什么呢</p><h1 id="6241" class="ix iy hi bd iz ja jb jc jd je jf jg jh io ji ip jj ir jk is jl iu jm iv jn jo bi translated">不仅仅是像素数据，还有DICOM标签</h1><p id="3c62" class="pw-post-body-paragraph kn ko hi jr b js jt ij kp ju jv im kq jw kr ks kt jy ku kv kw ka kx ky kz kc hb bi translated">灰度和RGB图像不仅具有不同的原始像素数据，还具有包括通道数量在内的多种不同属性。因此，除了像素数据之外的DICOM元数据也应该被适当地修改。</p><h2 id="de5e" class="ly iy hi bd iz mm mn mo jd mp mq mr jh jw ms mt jj jy mu mv jl ka mw mx jn my bi translated">灰度到RGB</h2><p id="c353" class="pw-post-body-paragraph kn ko hi jr b js jt ij kp ju jv im kq jw kr ks kt jy ku kv kw ka kx ky kz kc hb bi translated">让我们来看看原始DICOM文件中与灰度/RGB格式相关的一些DICOM标签。</p><pre class="lq lr ls lt fd lu lp lv lw aw lx bi"><span id="51f1" class="ly iy hi lp b fi lz ma l mb mc">(0028, 0004) Photometric Interpretation          CS: 'MONOCHROME2'<br/>(0028, 0002) Samples per Pixel                   US: 1<br/>(0028, 0100) Bits Allocated                      US: 16<br/>(0028, 0101) Bits Stored                         US: 12<br/>(0028, 0102) High Bit                            US: 11</span></pre><p id="0273" class="pw-post-body-paragraph kn ko hi jr b js la ij kp ju lb im kq jw lc ks kt jy ld kv kw ka le ky kz kc hb bi translated">CT数据最初是2字节无符号整数(uint16 ),具有1个通道。因此，我们必须根据RGB格式更改DICOM标签，增加一个标签'<a class="ae km" href="https://dicom.innolitics.com/ciods/mr-image/image-pixel/00280006" rel="noopener ugc nofollow" target="_blank">平面配置</a>，这在“每像素样本数”&gt; 1时是必需的。</p><pre class="lq lr ls lt fd lu lp lv lw aw lx bi"><span id="7327" class="ly iy hi lp b fi lz ma l mb mc">ds.PhotometricInterpretation = 'RGB'<br/>ds.SamplesPerPixel = 3<br/>ds.BitsAllocated = 8<br/>ds.BitsStored = 8<br/>ds.HighBit = 7<br/>ds.add_new(0x00280006, 'US', 0)</span></pre><p id="69f1" class="pw-post-body-paragraph kn ko hi jr b js la ij kp ju lb im kq jw lc ks kt jy ld kv kw ka le ky kz kc hb bi translated">现在，让我们再次保存文件并在DICOM查看器上检查。</p><figure class="lq lr ls lt fd mf er es paragraph-image"><div class="er es me"><img src="../Images/914175fa69af2948cc287ee58da076ba.png" data-original-src="https://miro.medium.com/v2/resize:fit:1024/format:webp/1*Ln0NAk4K2EdXrGaCvpHEuw.png"/></div><figcaption class="mi mj et er es mk ml bd b be z dx translated">哒哒！</figcaption></figure><h2 id="ccf5" class="ly iy hi bd iz mm mn mo jd mp mq mr jh jw ms mt jj jy mu mv jl ka mw mx jn my bi translated">还有什么可能出错？</h2><p id="a524" class="pw-post-body-paragraph kn ko hi jr b js jt ij kp ju jv im kq jw kr ks kt jy ku kv kw ka kx ky kz kc hb bi translated">幸运的是，对DICOM标签的相当直观的修改(如果你考虑灰度和RGB图像的结构)对我们的例子有效。然而，关于<a class="ae km" href="https://www.dicomlibrary.com/dicom/transfer-syntax/" rel="noopener ugc nofollow" target="_blank"> <em class="li">传输语法</em> </a> <em class="li">，可能需要额外的修改(在我看来，很难想到)。</em></p><pre class="lq lr ls lt fd lu lp lv lw aw lx bi"><span id="4e1b" class="ly iy hi lp b fi lz ma l mb mc">ds.file_meta</span><span id="4572" class="ly iy hi lp b fi md ma l mb mc">...<br/>(0002, 0010) Transfer Syntax UID    UI: Explicit VR Little Endian<br/>...</span></pre><p id="c623" class="pw-post-body-paragraph kn ko hi jr b js la ij kp ju lb im kq jw lc ks kt jy ld kv kw ka le ky kz kc hb bi translated">如果我们的文件是用Big Endian编码的，它在DICOM viewer上会是这样的。</p><figure class="lq lr ls lt fd mf er es paragraph-image"><div class="er es me"><img src="../Images/264b75a0e84071f920786f4f83b4a67e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1024/format:webp/1*ZhzsBCiGuSJTONiSrj0X-g.png"/></div><figcaption class="mi mj et er es mk ml bd b be z dx translated">红线变成了RGB条纹</figcaption></figure><p id="69c1" class="pw-post-body-paragraph kn ko hi jr b js la ij kp ju lb im kq jw lc ks kt jy ld kv kw ka le ky kz kc hb bi translated">相邻像素之间的RGB值似乎混淆了(可能与字节排序有关，但不确定具体原因)。因此，我们必须保持小端的传输语法。(显式/隐式在转换为RGB时无关紧要)</p><pre class="lq lr ls lt fd lu lp lv lw aw lx bi"><span id="0350" class="ly iy hi lp b fi lz ma l mb mc">ds.is_little_endian = True<br/>ds.fix_meta_info()</span></pre><h1 id="7761" class="ix iy hi bd iz ja jb jc jd je jf jg jh io ji ip jj ir jk is jl iu jm iv jn jo bi translated">完整源代码</h1><figure class="lq lr ls lt fd mf"><div class="bz dy l di"><div class="mz na l"/></div><figcaption class="mi mj et er es mk ml bd b be z dx translated">完整源代码</figcaption></figure><h1 id="b102" class="ix iy hi bd iz ja jb jc jd je jf jg jh io ji ip jj ir jk is jl iu jm iv jn jo bi translated">结论</h1><p id="2225" class="pw-post-body-paragraph kn ko hi jr b js jt ij kp ju jv im kq jw kr ks kt jy ku kv kw ka kx ky kz kc hb bi translated">有时需要将灰度DICOM文件转换为RGB DICOM文件，以提供可在医院实际使用的经过处理的医学图像。为此，您必须修改DICOM元数据(包括光度解释、每像素采样数和位数)以及像素数据。</p></div></div>    
</body>
</html>