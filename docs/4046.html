<html>
<head>
<title>When music is your passion…</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">当音乐是你的激情时…</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/when-music-is-your-passion-9837aea155ea?source=collection_archive---------8-----------------------#2021-08-20">https://medium.com/analytics-vidhya/when-music-is-your-passion-9837aea155ea?source=collection_archive---------8-----------------------#2021-08-20</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><figure class="ev ex if ig ih ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es ie"><img src="../Images/d5dcf6ff04c7458c3ba84d8f6f6b1270.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ckVdfqqEdBn-57VE5Yyt4Q.jpeg"/></div></div><figcaption class="ip iq et er es ir is bd b be z dx translated">使用Spark ML进行客户流失预测</figcaption></figure><h1 id="3b9d" class="it iu hh bd iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq bi translated"><strong class="ak">项目概述</strong></h1><p id="d3a8" class="pw-post-body-paragraph jr js hh jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ha bi translated">我们都至少曾经通过流媒体应用程序听音乐，我们享受着快速找到我们最喜欢的歌手并想听多久就听多久的可能性。</p><p id="6b8d" class="pw-post-body-paragraph jr js hh jt b ju kp jw jx jy kq ka kb kc kr ke kf kg ks ki kj kk kt km kn ko ha bi translated">至于每一个应用程序，只有当你决定支付一定的金额并成为高级会员时，才可以使用一些高级功能。</p><p id="de4d" class="pw-post-body-paragraph jr js hh jt b ju kp jw jx jy kq ka kb kc kr ke kf kg ks ki kj kk kt km kn ko ha bi translated">只要你对该应用程序提供的功能感到满意，你就会继续付费以保留你的优质功能，但可能会发生这样的情况，一段时间后，出于某种原因，你决定停止付费，或者更糟的是，你决定取消订阅。</p><p id="b565" class="pw-post-body-paragraph jr js hh jt b ju kp jw jx jy kq ka kb kc kr ke kf kg ks ki kj kk kt km kn ko ha bi translated"><strong class="jt hi">如果我们可以利用机器学习来预测用户是否会退订，会怎么样？</strong></p><p id="a4a6" class="pw-post-body-paragraph jr js hh jt b ju kp jw jx jy kq ka kb kc kr ke kf kg ks ki kj kk kt km kn ko ha bi translated">在下面的段落中，我将展示我是如何处理这个提到的问题的，这是一个常见的业务问题，称为“流失预测”。我将展示如何处理可用数据，以及如何实现基于监督机器学习技术的机器学习管道。</p><p id="76fa" class="pw-post-body-paragraph jr js hh jt b ju kp jw jx jy kq ka kb kc kr ke kf kg ks ki kj kk kt km kn ko ha bi translated">使用机器学习模型和管道来预测用户的流失是一个很好的方法，因为我们可以实现一个模型来预测单个用户基于之前的行为会做什么。统计方法和测试可以给出有用的结果，但不像机器学习模型那样细致和详细。</p><p id="96d2" class="pw-post-body-paragraph jr js hh jt b ju kp jw jx jy kq ka kb kc kr ke kf kg ks ki kj kk kt km kn ko ha bi translated">最终目标是产生一个模型，可以用来对用户进行分类，并预测他们是否会流失。</p><h1 id="e306" class="it iu hh bd iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq bi translated">数据探索和可视化</h1><p id="21f4" class="pw-post-body-paragraph jr js hh jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ha bi translated">该项目中使用的数据集包含与注册到Sparkify(一个虚构的音乐流媒体应用程序)的用户相关的数据子集。</p><p id="cdbe" class="pw-post-body-paragraph jr js hh jt b ju kp jw jx jy kq ka kb kc kr ke kf kg ks ki kj kk kt km kn ko ha bi translated">数据被加载到火花数据帧中进行分析。如下所示，该模式包含每个用户和会话的ID，以及关于用户本身的信息(性别、位置……)和完成的操作(访问的页面……)，按时间戳排序。</p><figure class="kv kw kx ky fd ii er es paragraph-image"><div class="er es ku"><img src="../Images/58ec6a3bdd8768cf070a869c7ccbe5c7.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*cfZlZoAVk5aMW5QYlhwBzA.jpeg"/></div><figcaption class="ip iq et er es ir is bd b be z dx translated">数据框架模式</figcaption></figure><p id="78c3" class="pw-post-body-paragraph jr js hh jt b ju kp jw jx jy kq ka kb kc kr ke kf kg ks ki kj kk kt km kn ko ha bi translated">为了开始我们的分析，我们使用了EDA来更好地理解数据集的内容。</p><p id="fe83" class="pw-post-body-paragraph jr js hh jt b ju kp jw jx jy kq ka kb kc kr ke kf kg ks ki kj kk kt km kn ko ha bi translated">数据集包含<strong class="jt hi"> 278154行</strong>和<strong class="jt hi"> 225个不同的用户。</strong>特征工程前可用的<strong class="jt hi">特征</strong>为<strong class="jt hi"> 17 </strong>，不包括userId列。</p><p id="4166" class="pw-post-body-paragraph jr js hh jt b ju kp jw jx jy kq ka kb kc kr ke kf kg ks ki kj kk kt km kn ko ha bi translated">以下是一些探索的结果(更多信息可在相关的<a class="ae kz" href="https://github.com/AleGuarnieri/Sparkify-Capstone" rel="noopener ugc nofollow" target="_blank"> Jupyter笔记本</a>中找到):</p><figure class="kv kw kx ky fd ii er es paragraph-image"><div class="er es la"><img src="../Images/5c3fb207dc128dc5d30c01536e2623cf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1338/format:webp/1*6vMjYVr1Tqs2-sTyN4eYtg.jpeg"/></div><figcaption class="ip iq et er es ir is bd b be z dx translated">数据框架中某些列的详细信息</figcaption></figure><figure class="kv kw kx ky fd ii er es paragraph-image"><div class="er es lb"><img src="../Images/621206fb11ad368771055d989c814c90.png" data-original-src="https://miro.medium.com/v2/resize:fit:1064/format:webp/1*rNyP6aE2eC14p_WamNZUJA.jpeg"/></div></figure><figure class="kv kw kx ky fd ii er es paragraph-image"><div class="er es lc"><img src="../Images/81dadfb2a7d3ad718281ba8fde47c5fc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1142/format:webp/1*SbVD6XFHXHNh5T2ZuYMMbw.jpeg"/></div></figure><p id="a7bb" class="pw-post-body-paragraph jr js hh jt b ju kp jw jx jy kq ka kb kc kr ke kf kg ks ki kj kk kt km kn ko ha bi translated">在此阶段完成的最重要的数据清理是删除用户Id为空的行。此外，有趣的是，注意到某些列有一些空值，因为用户的操作与歌曲无关，所以对于这些行，歌曲的作者、名称和持续时间没有被填充。</p><h1 id="0f7e" class="it iu hh bd iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq bi translated">数据预处理和实现</h1><h2 id="35e6" class="ld iu hh bd iv le lf lg iz lh li lj jd kc lk ll jh kg lm ln jl kk lo lp jp lq bi translated">标签定义</h2><p id="6074" class="pw-post-body-paragraph jr js hh jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ha bi translated">我们分析的目标是预测用户何时会流失，所以我们添加了一个列，标签，定义用户是否决定取消订阅。</p><figure class="kv kw kx ky fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es lr"><img src="../Images/5c9f25f37418840f00388b806f9675f1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*umgtL0FFxEZqDNALaMF1_Q.jpeg"/></div></div><figcaption class="ip iq et er es ir is bd b be z dx translated">pySpark代码定义标签列“Churn”</figcaption></figure><p id="a513" class="pw-post-body-paragraph jr js hh jt b ju kp jw jx jy kq ka kb kc kr ke kf kg ks ki kj kk kt km kn ko ha bi translated">列“Churn”将用作我们模型的目标列，以便我们可以将它与特征列一起用于训练，然后测试机器学习模型。</p><h2 id="21bf" class="ld iu hh bd iv le lf lg iz lh li lj jd kc lk ll jh kg lm ln jl kk lo lp jp lq bi translated">特征工程</h2><p id="91e3" class="pw-post-body-paragraph jr js hh jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ha bi translated">需要对数据集中可用的特征进行操作，以便在机器学习模型中使用。</p><p id="d8e5" class="pw-post-body-paragraph jr js hh jt b ju kp jw jx jy kq ka kb kc kr ke kf kg ks ki kj kk kt km kn ko ha bi translated"><strong class="jt hi">分类特征</strong></p><p id="a8dd" class="pw-post-body-paragraph jr js hh jt b ju kp jw jx jy kq ka kb kc kr ke kf kg ks ki kj kk kt km kn ko ha bi translated">“性别”是唯一使用的分类特征。在这种情况下，有必要使用一键编码技术将特征从分类转换为数字。</p><p id="73f2" class="pw-post-body-paragraph jr js hh jt b ju kp jw jx jy kq ka kb kc kr ke kf kg ks ki kj kk kt km kn ko ha bi translated"><strong class="jt hi">数字特征</strong></p><p id="63ff" class="pw-post-body-paragraph jr js hh jt b ju kp jw jx jy kq ka kb kc kr ke kf kg ks ki kj kk kt km kn ko ha bi translated">“page”列用于构建一些数字特性，为每个用户创建页面操作计数。除此之外，还添加了一些其他数字特征，如:“每个用户的会话数”、“每个用户听的歌曲数”、“每个用户每个会话听的歌曲平均数”</p><p id="d59f" class="pw-post-body-paragraph jr js hh jt b ju kp jw jx jy kq ka kb kc kr ke kf kg ks ki kj kk kt km kn ko ha bi translated"><strong class="jt hi">关于数据泄露的说明</strong></p><p id="bf57" class="pw-post-body-paragraph jr js hh jt b ju kp jw jx jy kq ka kb kc kr ke kf kg ks ki kj kk kt km kn ko ha bi translated">在执行特征工程时，考虑数据泄漏是很重要的，例如，在特征中不包括“取消确认”或“取消”以避免过度拟合是必要的。</p><h1 id="645d" class="it iu hh bd iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq bi translated">模型评估和验证</h1><p id="0a41" class="pw-post-body-paragraph jr js hh jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ha bi translated">在这个项目中使用的ML模型是逻辑回归和随机森林。这种选择是考虑到问题的性质，这是一个分类问题，以及类别不平衡的事实。</p><p id="fb8e" class="pw-post-body-paragraph jr js hh jt b ju kp jw jx jy kq ka kb kc kr ke kf kg ks ki kj kk kt km kn ko ha bi translated">对80%的数据进行训练，而剩下的20%专门用于验证。</p><h2 id="3f95" class="ld iu hh bd iv le lf lg iz lh li lj jd kc lk ll jh kg lm ln jl kk lo lp jp lq bi translated">超参数调谐</h2><p id="53f3" class="pw-post-body-paragraph jr js hh jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ha bi translated">在训练集上执行交叉验证，以便我们可以调整模型的超参数并选择最佳参数。</p><figure class="kv kw kx ky fd ii er es paragraph-image"><div class="er es ls"><img src="../Images/1ecb3313b53b8b7188ef202df3911a4a.png" data-original-src="https://miro.medium.com/v2/resize:fit:880/format:webp/1*HxL7oULcbhV2dau9wqjX3A.jpeg"/></div><figcaption class="ip iq et er es ir is bd b be z dx translated">定义管道、超参数和评估器后，定义交叉验证</figcaption></figure><p id="84dc" class="pw-post-body-paragraph jr js hh jt b ju kp jw jx jy kq ka kb kc kr ke kf kg ks ki kj kk kt km kn ko ha bi translated">以下是超参数调整后的最佳参数值</p><p id="a833" class="pw-post-body-paragraph jr js hh jt b ju kp jw jx jy kq ka kb kc kr ke kf kg ks ki kj kk kt km kn ko ha bi translated"><strong class="jt hi">逻辑回归:</strong></p><ul class=""><li id="0b66" class="lt lu hh jt b ju kp jy kq kc lv kg lw kk lx ko ly lz ma mb bi translated">regParam: 0.1</li><li id="3ccb" class="lt lu hh jt b ju mc jy md kc me kg mf kk mg ko ly lz ma mb bi translated">弹性参数:0.0</li></ul><p id="c0c8" class="pw-post-body-paragraph jr js hh jt b ju kp jw jx jy kq ka kb kc kr ke kf kg ks ki kj kk kt km kn ko ha bi translated"><strong class="jt hi">随机森林:</strong></p><ul class=""><li id="2419" class="lt lu hh jt b ju kp jy kq kc lv kg lw kk lx ko ly lz ma mb bi translated">数量:50</li><li id="6db1" class="lt lu hh jt b ju mc jy md kc me kg mf kk mg ko ly lz ma mb bi translated">最大深度:15</li></ul><h2 id="a506" class="ld iu hh bd iv le lf lg iz lh li lj jd kc lk ll jh kg lm ln jl kk lo lp jp lq bi translated"><strong class="ak">指标</strong></h2><p id="b321" class="pw-post-body-paragraph jr js hh jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ha bi translated">交叉验证过程中使用的指标是f1-score和AreaUnderPR，因为这些类别是不平衡的，预测良好的积极的一个更重要。</p><p id="6b77" class="pw-post-body-paragraph jr js hh jt b ju kp jw jx jy kq ka kb kc kr ke kf kg ks ki kj kk kt km kn ko ha bi translated">在最佳模型上，还计算了正类的其他指标，如下所示:</p><figure class="kv kw kx ky fd ii er es paragraph-image"><div class="er es mh"><img src="../Images/ce43d78d151049fbc2be6ded4646d648.png" data-original-src="https://miro.medium.com/v2/resize:fit:1180/format:webp/1*_7aasV4-sZrJPBH2_TayIQ.jpeg"/></div><figcaption class="ip iq et er es ir is bd b be z dx translated">训练后测试数据集的指标(评估指标:f1-得分)</figcaption></figure><p id="c616" class="pw-post-body-paragraph jr js hh jt b ju kp jw jx jy kq ka kb kc kr ke kf kg ks ki kj kk kt km kn ko ha bi translated">经过训练的随机森林模型也用于预测训练集的标签，如下所示，训练集的度量值较高，因此模型可能过度拟合:</p><figure class="kv kw kx ky fd ii er es paragraph-image"><div class="er es mi"><img src="../Images/f6e885e4cd79db2ac854b608fded4128.png" data-original-src="https://miro.medium.com/v2/resize:fit:1144/format:webp/1*OzPP0-hxDNlITiUwqfxs6A.jpeg"/></div></figure><h2 id="8899" class="ld iu hh bd iv le lf lg iz lh li lj jd kc lk ll jh kg lm ln jl kk lo lp jp lq bi translated">关于评估的补充说明</h2><p id="485f" class="pw-post-body-paragraph jr js hh jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ha bi translated"><strong class="jt hi">造成过拟合的参数</strong></p><p id="49c0" class="pw-post-body-paragraph jr js hh jt b ju kp jw jx jy kq ka kb kc kr ke kf kg ks ki kj kk kt km kn ko ha bi translated">有趣的是，我们注意到在随机森林模型上调整的两个参数中，对过度拟合影响最大的是maxDepth。正确地调整它是非常重要的，因为这需要进行不同的实验。</p><p id="6d2d" class="pw-post-body-paragraph jr js hh jt b ju kp jw jx jy kq ka kb kc kr ke kf kg ks ki kj kk kt km kn ko ha bi translated"><strong class="jt hi">F1-py spark中的分数:挑战</strong></p><p id="be0f" class="pw-post-body-paragraph jr js hh jt b ju kp jw jx jy kq ka kb kc kr ke kf kg ks ki kj kk kt km kn ko ha bi translated">F1得分指标用作评估指标，并用于模型的微调。Spark类MulticlassClassificationMetrics对类的f1分数进行平均，因此逻辑回归的f1分数为0.58，随机森林的f1分数为0.66。</p><p id="0682" class="pw-post-body-paragraph jr js hh jt b ju kp jw jx jy kq ka kb kc kr ke kf kg ks ki kj kk kt km kn ko ha bi translated">尽管如此，如果我们查看阳性类别的f1得分(如上所示)，我们会看到逻辑回归的f1得分为0。这对交叉验证过程和我们对逻辑回归模型的认知都有影响，逻辑回归模型看起来可能比实际要好。</p><p id="8ba4" class="pw-post-body-paragraph jr js hh jt b ju kp jw jx jy kq ka kb kc kr ke kf kg ks ki kj kk kt km kn ko ha bi translated"><strong class="jt hi">验证</strong></p><p id="aace" class="pw-post-body-paragraph jr js hh jt b ju kp jw jx jy kq ka kb kc kr ke kf kg ks ki kj kk kt km kn ko ha bi translated">在交叉验证期间使用<em class="mj">集合子模型</em>，可以保留每个折叠的模型，然后对它们进行评估，以测试最佳模型的稳健性。所选的模型似乎不够健壮，并且有点过于依赖所选的数据集。这个问题可能是由于阶级不平衡，也可以解决使用更多的数据。</p><h1 id="f492" class="it iu hh bd iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq bi translated">最后的反思和改进</h1><p id="0b2f" class="pw-post-body-paragraph jr js hh jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ha bi translated">解决我们的流失预测问题的选择模型是随机森林模型，因为如上所示，根据使用的评估指标，它优于逻辑回归模型。超参数调整后，模型的F1得分为0.66，特别是正a类的F1得分为0.28。在所有使用的特征中，预测客户流失的最重要的特征是“拇指向下”和“拇指向上”。</p><p id="3a13" class="pw-post-body-paragraph jr js hh jt b ju kp jw jx jy kq ka kb kc kr ke kf kg ks ki kj kk kt km kn ko ha bi translated">整个过程中最重要的部分是超参数调整:重要的是理解与要解决的业务问题相关的指标的意义，重要的是不仅要检查总体F1分数，还要检查积极类的分数。</p><p id="3e11" class="pw-post-body-paragraph jr js hh jt b ju kp jw jx jy kq ka kb kc kr ke kf kg ks ki kj kk kt km kn ko ha bi translated">我们终于准备好帮助Sparkify预测他们的用户是否会流失了吗？</p><p id="e388" class="pw-post-body-paragraph jr js hh jt b ju kp jw jx jy kq ka kb kc kr ke kf kg ks ki kj kk kt km kn ko ha bi translated">好了，已经完成了一大步，但是还可以有许多其他步骤来改进预处理和模型调整。</p><p id="3451" class="pw-post-body-paragraph jr js hh jt b ju kp jw jx jy kq ka kb kc kr ke kf kg ks ki kj kk kt km kn ko ha bi translated">例如，将这段代码运行到一个分布式集群中，以利用Spark的能力，看看是否能获得更好的性能。</p><p id="50ee" class="pw-post-body-paragraph jr js hh jt b ju kp jw jx jy kq ka kb kc kr ke kf kg ks ki kj kk kt km kn ko ha bi translated">纠正类别不平衡或添加附加特征也是令人感兴趣的，例如，分类特征，如每个用户可用的最后状态(免费或付费)或其他数字特征。</p><p id="6143" class="pw-post-body-paragraph jr js hh jt b ju kp jw jx jy kq ka kb kc kr ke kf kg ks ki kj kk kt km kn ko ha bi translated">最后，使用不同的模型或创建模型集合也是有用的。</p><p id="d922" class="pw-post-body-paragraph jr js hh jt b ju kp jw jx jy kq ka kb kc kr ke kf kg ks ki kj kk kt km kn ko ha bi translated"><a class="ae kz" href="https://github.com/AleGuarnieri/Sparkify-Capstone" rel="noopener ugc nofollow" target="_blank">你可以在这里找到完整的Jupyter笔记本</a></p></div></div>    
</body>
</html>