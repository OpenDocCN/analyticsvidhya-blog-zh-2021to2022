<html>
<head>
<title>Video Chat using OpenCV and Socket</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用OpenCV和Socket进行视频聊天</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/video-chat-using-opencv-and-socket-5ca864a54696?source=collection_archive---------4-----------------------#2021-06-06">https://medium.com/analytics-vidhya/video-chat-using-opencv-and-socket-5ca864a54696?source=collection_archive---------4-----------------------#2021-06-06</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/ecfea42f817ef5602d70c336931442e3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*4mXa343FqYRBsnf4"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated"><a class="ae iu" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上<a class="ae iu" href="https://unsplash.com/@visuals?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">视觉</a>的照片</figcaption></figure><p id="62a7" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi jt translated"><span class="l ju jv jw bm jx jy jz ka kb di">在</span>这个博客中，我们将使用<strong class="ix hj"> <em class="kc"> OpenCV </em> </strong>和<strong class="ix hj"> <em class="kc"> Sockets </em> </strong>在<strong class="ix hj"> <em class="kc"> Python </em> </strong>中构建<strong class="ix hj"> <em class="kc">无语音视频聊天频道</em> </strong>。</p><h2 id="040e" class="kd ke hi bd kf kg kh ki kj kk kl km kn jg ko kp kq jk kr ks kt jo ku kv kw kx bi translated">让我们从一个计划开始:</h2><ul class=""><li id="30bd" class="ky kz hi ix b iy la jc lb jg lc jk ld jo le js lf lg lh li bi translated">为一对一通信创建TCP套接字。</li><li id="f59e" class="ky kz hi ix b iy lj jc lk jg ll jk lm jo ln js lf lg lh li bi translated">从摄像机中获取实时流。</li><li id="c321" class="ky kz hi ix b iy lj jc lk jg ll jk lm jo ln js lf lg lh li bi translated">对双工通道使用多线程。</li></ul></div><div class="ab cl lo lp gp lq" role="separator"><span class="lr bw bk ls lt lu"/><span class="lr bw bk ls lt lu"/><span class="lr bw bk ls lt"/></div><div class="hb hc hd he hf"><p id="b719" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj"> <em class="kc"> OpenCV </em> </strong>是使用Python进行图像和视频处理的库。我们可以使用它做任何与图像和视频相关的事情。我们裁剪、编辑、创建图像和制作视频。</p><p id="97f1" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj"> <em class="kc"> Socket </em> </strong>是底层的网络接口，用来连接网络上的两个节点进行相互通信。</p><p id="2c04" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj"> <em class="kc">线程</em> </strong>是python中用来创建多线程程序的库。</p><h2 id="a045" class="kd ke hi bd kf kg kh ki kj kk kl km kn jg ko kp kq jk kr ks kt jo ku kv kw kx bi translated">让我们开始实施计划:</h2><p id="0f6c" class="pw-post-body-paragraph iv iw hi ix b iy la ja jb jc lb je jf jg lv ji jj jk lw jm jn jo lx jq jr js hb bi translated">首先我们将使用下面的代码使用<strong class="ix hj"> <em class="kc">套接字库</em> </strong>创建<strong class="ix hj"> <em class="kc"> TCP套接字</em> </strong>:</p><ul class=""><li id="7fe7" class="ky kz hi ix b iy iz jc jd jg ly jk lz jo ma js lf lg lh li bi translated">将协议设置为TCP，将地址族设置为IPv4地址族。</li></ul><pre class="mb mc md me fd mf mg mh mi aw mj bi"><span id="97f3" class="kd ke hi mg b fi mk ml l mm mn">#<em class="kc"> tcp and ipv4 address family</em></span><span id="34da" class="kd ke hi mg b fi mo ml l mm mn">tcp = socket.SOCK_STREAM</span><span id="e5ba" class="kd ke hi mg b fi mo ml l mm mn">afm = socket.AF_INET</span></pre><ul class=""><li id="97dc" class="ky kz hi ix b iy iz jc jd jg ly jk lz jo ma js lf lg lh li bi translated">使用TCP和AFM变量创建套接字。</li></ul><pre class="mb mc md me fd mf mg mh mi aw mj bi"><span id="ad55" class="kd ke hi mg b fi mk ml l mm mn">#<em class="kc"> creating socket</em></span><span id="10ad" class="kd ke hi mg b fi mo ml l mm mn">sa = socket.socket(afm,tcp)</span><span id="78d4" class="kd ke hi mg b fi mo ml l mm mn">sb = socket.socket(afm,tcp)</span></pre><p id="0c58" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj"> <em class="kc"> sa </em> </strong>和<strong class="ix hj"> <em class="kc"> sb </em> </strong>是为两个节点之间的通信而创建的套接字。我们也可以使用单个插座实现同样的功能。</p><ul class=""><li id="1dc2" class="ky kz hi ix b iy iz jc jd jg ly jk lz jo ma js lf lg lh li bi translated">将<strong class="ix hj"> <em class="kc"> IP地址与端口号绑定。</em>T53】</strong></li></ul><pre class="mb mc md me fd mf mg mh mi aw mj bi"><span id="d9ab" class="kd ke hi mg b fi mk ml l mm mn">sa.bind((usera_ip,usera_port))</span></pre><ul class=""><li id="68d7" class="ky kz hi ix b iy iz jc jd jg ly jk lz jo ma js lf lg lh li bi translated">开始监听插座。</li></ul><pre class="mb mc md me fd mf mg mh mi aw mj bi"><span id="101b" class="kd ke hi mg b fi mk ml l mm mn">sa.listen()</span></pre><ul class=""><li id="4a46" class="ky kz hi ix b iy iz jc jd jg ly jk lz jo ma js lf lg lh li bi translated">开始接受来自节点的连接。</li></ul><pre class="mb mc md me fd mf mg mh mi aw mj bi"><span id="b571" class="kd ke hi mg b fi mk ml l mm mn">session, addr = sa.accept()</span></pre><p id="a52c" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj"> <em class="kc"> sa.accept() </em> </strong>用于接受来自其他节点的连接请求。<strong class="ix hj"> <em class="kc"> session </em> </strong>存储会话数据并使用它来发送和接收请求，而<strong class="ix hj"> <em class="kc"> addr </em> </strong>用于存储接收者节点的地址。</p><ul class=""><li id="8be2" class="ky kz hi ix b iy iz jc jd jg ly jk lz jo ma js lf lg lh li bi translated">将这个节点连接到另一个节点。</li></ul><pre class="mb mc md me fd mf mg mh mi aw mj bi"><span id="a073" class="kd ke hi mg b fi mk ml l mm mn">sb.connect((usera_ip,2001))</span></pre><p id="c29e" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">然后，我们需要设计精巧的<strong class="ix hj"> <em class="kc">接收</em> </strong>和<strong class="ix hj"> <em class="kc">发送</em> </strong>来接收和发送视频。</p><figure class="mb mc md me fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mp"><img src="../Images/f88f04c24ea85137fa78bfceb1b37321.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dH0-Dc_FTTyOTfW1R_DToA.png"/></div></div></figure><p id="ad86" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj"> <em class="kc"> receive() </em> </strong>函数包括使用下面的代码块接收视频帧的无限循环。</p><p id="3a9e" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj"><em class="kc">【session . recv(buff _ size)</em></strong>用于从节点接收字节数组。然后，<strong class="ix hj"> <em class="kc"> np.frombuffer() </em> </strong>用于将字节存储回数据类型为<strong class="ix hj"> <em class="kc"> np.uint8 </em> </strong>的numpy数组中，该数组存储的值在0到255的范围内。然后，<strong class="ix hj"><em class="kc">cv2 . im decode(image _ arr，cv2。IMREAD_COLOR) </em> </strong>用于将图像解码回带有<strong class="ix hj"> <em class="kc"> cv2的彩色图像。IMREAD_COLOR </em> </strong>参数。</p><p id="2b4d" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">如果<strong class="ix hj"> <em class="kc">图像</em> </strong>为空，数据类型为<strong class="ix hj"> <em class="kc"> Nonetype </em> </strong>，程序将通过，否则使用<strong class="ix hj"> <em class="kc"> cv2.imshow(image_name，image) </em> </strong>和<em class="kc">【cv2 . waitKey(10) </em> 连续显示帧，如果关键字输入为<strong class="ix hj"> <em class="kc">则使用wait key(10)</em></strong>使帧等待10毫秒并退出</p><p id="8aee" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj"><em class="kc">cv2 . destroyallwindows()</em></strong>用于完全破坏图像窗口，并使用<strong class="ix hj"> <em class="kc"> os退出线程。</em>_退出(0)</strong>。</p><p id="a2ef" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj"><em class="kc">【send()</em></strong>函数包括使用下面的代码块发送视频帧的无限循环。</p><figure class="mb mc md me fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mq"><img src="../Images/eaa67fa13dd896aa8f7824d91a605ca0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VebakYkTxj1MAyrUPWpAMg.png"/></div></div></figure><p id="d962" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">cv2<em class="kc">。VideoCapture(0) </em> </strong>用于访问摄像机，并且可以使用作为参数传递的数字来更改摄像机。<strong class="ix hj"> <em class="kc">捕捉</em> </strong>存储摄像机的访问方法就像<strong class="ix hj"> <em class="kc">读取()</em> </strong>从摄像机输入或者<strong class="ix hj"> <em class="kc">释放()</em> </strong>就是摄像机。</p><p id="097a" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj"><em class="kc">capture . read()</em></strong>返回两个变量，第一个作为bool值，表示照片是否拍摄，第二个作为照片。</p><p id="3ec3" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">然后，如果<strong class="ix hj"> <em class="kc"> ret </em> </strong>为<strong class="ix hj"> <em class="kc"> True </em> </strong>使用<strong class="ix hj"> <em class="kc"> imencode对图像进行编码('。jpg '，photo) </em> </strong>并返回两个变量，第二个变量作为<strong class="ix hj"> <em class="kc">编码数组</em> </strong>并使用<strong class="ix hj"> <em class="kc">转换成字节。tobytes </em> </strong>可以通过套接字发送。</p><p id="689c" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj"><em class="kc">sendall(byte _ encoded _ array)</em></strong>通过socket发送所有数据，数据发送到目的节点，直到所有数据成功发送到目的节点。</p><figure class="mb mc md me fd ij er es paragraph-image"><div class="er es mr"><img src="../Images/ea4c1752d907a51956324a72633b013b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1374/format:webp/1*K6T165RQUJ6cLzS219ZEgg.png"/></div></figure><p id="de76" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我们需要使用<strong class="ix hj"> <em class="kc">线程创建线程来同时接收和发送视频。Thread(target=func) </em> </strong>以目标为<strong class="ix hj"> <em class="kc"> send() </em> </strong>和<strong class="ix hj"> <em class="kc"> receive() </em> </strong>将函数赋予单独的线程。</p><figure class="mb mc md me fd ij er es paragraph-image"><div class="er es ms"><img src="../Images/236396256ffa18b7061c37f16db7a844.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/1*6XTUePx45kbUOwm6oOD6Xg.gif"/></div></figure><p id="1426" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">然后，我们应该在两个节点上运行程序。这里，我使用了相同的IP地址和不同的端口。</p><p id="0dce" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">哇哦。！我们一起做的。成功创建并执行了视频聊天程序。您可以使用下面的Github链接查看代码。</p><div class="mt mu ez fb mv mw"><a href="https://github.com/Launchpad5682/summer_training_21/tree/main/task_3" rel="noopener  ugc nofollow" target="_blank"><div class="mx ab dw"><div class="my ab mz cl cj na"><h2 class="bd hj fi z dy nb ea eb nc ed ef hh bi translated">启动平台5682/summer_training_21</h2><div class="nd l"><h3 class="bd b fi z dy nb ea eb nc ed ef dx translated">在GitHub上创建一个帐户，为launch pad 5682/summer _ training _ 21开发做贡献。</h3></div><div class="ne l"><p class="bd b fp z dy nb ea eb nc ed ef dx translated">github.com</p></div></div><div class="nf l"><div class="ng l nh ni nj nf nk io mw"/></div></div></a></div><p id="6f76" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">如果你觉得这很有趣，给一个👏。感谢阅读。</p></div></div>    
</body>
</html>