<html>
<head>
<title>Training Julia ML model in GCP</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在GCP培训Julia ML模型</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/training-julia-ml-model-in-gcp-1bc0d91228a0?source=collection_archive---------21-----------------------#2021-01-25">https://medium.com/analytics-vidhya/training-julia-ml-model-in-gcp-1bc0d91228a0?source=collection_archive---------21-----------------------#2021-01-25</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="d563" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">尽管Google Cloud AI平台应该运行Python模块中的ML模块，但我使用了一个技巧，通过将Julia ML模块打包在Docker映像中，在GCP AI平台上运行Julia训练模块。这</p><ol class=""><li id="99de" class="jc jd hh ig b ih ii il im ip je it jf ix jg jb jh ji jj jk bi translated">创建<a class="ae jl" href="https://github.com/iwasnothing/JuliaConvGRU/blob/main/Dockerfile" rel="noopener ugc nofollow" target="_blank"> <em class="jm"> Dockerfile </em> </a></li></ol><pre class="jn jo jp jq fd jr js jt ju aw jv bi"><span id="d7b5" class="jw jx hh js b fi jy jz l ka kb">FROM julia<br/>WORKDIR /app<br/>COPY *.jl /app/<br/>COPY OsRSIConv/ /app/OsRSIConv/<br/>RUN julia installPkg.jl</span><span id="e4f6" class="jw jx hh js b fi kc jz l ka kb">ENTRYPOINT ["julia", "run.jl"]</span></pre><p id="6341" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">2.构建docker映像并将其推送到GCP映像库。</p><pre class="jn jo jp jq fd jr js jt ju aw jv bi"><span id="5115" class="jw jx hh js b fi jy jz l ka kb">docker build -t gar.io/&lt;project&gt;/osrsi .<br/>docker push gcr.io/&lt;project&gt;/osrsi</span></pre><p id="97d4" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">3.参照参数:<em class="jm"> master-image-uri中的图片，将docker图片作为训练作业提交给GCP AI平台。</em></p><pre class="jn jo jp jq fd jr js jt ju aw jv bi"><span id="b85d" class="jw jx hh js b fi jy jz l ka kb">gcloud ai-platform jobs submit training $job_id \<br/>    --region "us-central1" \<br/>    --master-image-uri=gcr.io/$PROJECT_ID/osrsi:latest</span></pre><p id="8a16" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">没有必要创建任何渴望虚拟机，GCP只收取你的工作所使用的CPU信用。</p><p id="0e7d" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">包括模型文件、csv输出在内的任何输出都可以存储在GCP存储器中。虽然Julia 有第三方<a class="ae jl" href="https://juliacloud.github.io/GoogleCloud.jl/latest/" rel="noopener ugc nofollow" target="_blank"> GCP存储API，但是使用<code class="du kd ke kf js b">run</code>函数运行shell命令<code class="du kd ke kf js b">gsutil</code>要容易得多。</a></p><pre class="jn jo jp jq fd jr js jt ju aw jv bi"><span id="5f7a" class="jw jx hh js b fi jy jz l ka kb">run(`google-cloud-sdk/bin/gsutil cp file.csv gs://bucket/file.csv`)</span></pre><p id="6d15" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">为了在shell中运行google-cloud-sdk，应该为sdk和python安装修改上面的order文件。这是要添加的一行。</p><pre class="jn jo jp jq fd jr js jt ju aw jv bi"><span id="4839" class="jw jx hh js b fi jy jz l ka kb">RUN apt-get update &amp;&amp; apt-get install -y curl &amp;&amp; apt-get install wget -y<br/>RUN curl -O <a class="ae jl" href="https://dl.google.com/dl/cloudsdk/channels/rapid/downloads/google-cloud-sdk-324.0.0-linux-x86_64.tar.gz" rel="noopener ugc nofollow" target="_blank">https://dl.google.com/dl/cloudsdk/channels/rapid/downloads/google-cloud-sdk-324.0.0-linux-x86_64.tar.gz</a><br/>RUN gzip -cd google-cloud-sdk-324.0.0-linux-x86_64.tar.gz|tar -xvf -<br/>RUN wget <a class="ae jl" href="https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh" rel="noopener ugc nofollow" target="_blank">https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh</a><br/>RUN bash Miniconda3-latest-Linux-x86_64.sh -b -p /app/miniconda<br/>ENV PATH $PATH:/app/google-cloud-sdk/bin:/app/miniconda/bin</span></pre><h1 id="3d38" class="kg jx hh bd kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc bi translated">CI/CD管道</h1><p id="98f0" class="pw-post-body-paragraph ie if hh ig b ih ld ij ik il le in io ip lf ir is it lg iv iw ix lh iz ja jb ha bi translated">使用GCP云构建来构建自动化docker构建和培训管道。</p><ol class=""><li id="722b" class="jc jd hh ig b ih ii il im ip je it jf ix jg jb jh ji jj jk bi translated">为GitHub repo创建构建触发器。</li><li id="43d8" class="jc jd hh ig b ih li il lj ip lk it ll ix lm jb jh ji jj jk bi translated">触发器将引用自定义的clouldbuild.yaml来构建docker映像并提交培训作业。</li></ol><p id="d66f" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><a class="ae jl" href="https://github.com/iwasnothing/JuliaConvGRU/blob/main/cloudbuild.yaml" rel="noopener ugc nofollow" target="_blank"><em class="jm">cloud build . YAML</em></a></p><pre class="jn jo jp jq fd jr js jt ju aw jv bi"><span id="77ed" class="jw jx hh js b fi jy jz l ka kb">steps:</span><span id="c89c" class="jw jx hh js b fi kc jz l ka kb">- name: 'gcr.io/cloud-builders/docker'<br/>  args: ['build','-t','gcr.io/$PROJECT_ID/osrsi','.']<br/>  timeout: 3600s<br/>- name: 'gcr.io/cloud-builders/docker'<br/>  args: [ 'push', 'gcr.io/$PROJECT_ID/osrsi' ]<br/>  timeout: 3600s<br/>- name: 'gcr.io/cloud-builders/gcloud'<br/>  entrypoint: 'bash'<br/>  args:<br/>    - '-eEuo'<br/>    - 'pipefail'<br/>    - '-c'<br/>    - |-<br/>    ts=`date +%Y%m%d%H%M`<br/>    job_id="julia_osrsi_stock_training_$ts"<br/>    gcloud ai-platform jobs submit training $job_id \<br/>    --region "us-central1" \<br/>    --master-image-uri=gcr.io/$PROJECT_ID/osrsi:latest</span><span id="c492" class="jw jx hh js b fi kc jz l ka kb">timeout: 3600s</span></pre><p id="ac61" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">3.对主分支的任何推送都将触发构建，并在AI平台上自动运行作业。</p><p id="0786" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">4.(可选)通过使用以下trigger REST API，使用Cloud scheduler定期运行云构建触发器，比如每天运行一次:</p><pre class="jn jo jp jq fd jr js jt ju aw jv bi"><span id="e562" class="jw jx hh js b fi jy jz l ka kb"><a class="ae jl" href="https://cloudbuild.googleapis.com/v1/projects/iwasnothing-self-learning/triggers/61e9fa72-030d-4a12-b4ed-f346dc874e70:run" rel="noopener ugc nofollow" target="_blank">https://cloudbuild.googleapis.com/v1/projects/&lt;project&gt;/triggers/&lt;trigger-id&gt;:run</a></span></pre></div></div>    
</body>
</html>