<html>
<head>
<title>Digit Recognition of digital meters using TensorFlow 2 Object Detection API</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用TensorFlow 2对象检测API进行数字仪表的数字识别</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/digit-recognition-of-digital-meters-using-tensorflow-2-object-detection-api-48364cd678a9?source=collection_archive---------6-----------------------#2021-01-12">https://medium.com/analytics-vidhya/digit-recognition-of-digital-meters-using-tensorflow-2-object-detection-api-48364cd678a9?source=collection_archive---------6-----------------------#2021-01-12</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><div class="ev ex ie if ig ab cb"><figure class="ih ii ij ik il im in paragraph-image"><div role="button" tabindex="0" class="io ip di iq bf ir"><img src="../Images/f8bfd8bd2ca2970355e7986438f54522.png" data-original-src="https://miro.medium.com/v2/resize:fit:1088/format:webp/1*VEQndVatI1tvtHEuoZFFOA.png"/></div></figure><figure class="ih ii iu ik il im in paragraph-image"><div role="button" tabindex="0" class="io ip di iq bf ir"><img src="../Images/37a6b1fb046140efe066ba4a65c71286.png" data-original-src="https://miro.medium.com/v2/resize:fit:914/format:webp/1*MkA803ZJfU5ibz5CNynZIQ.png"/></div><figcaption class="iv iw et er es ix iy bd b be z dx iz di ja jb translated">公用数字仪表的数字检测与识别</figcaption></figure></div><p id="f213" class="pw-post-body-paragraph jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ha bi translated">公用事业和能源领域的一个非常具有挑战性的用例是监控设施内不同位置和用户端的公用事业电表。</p><p id="3b91" class="pw-post-body-paragraph jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ha bi translated">传统上，训练有素的工作人员在现场记录仪表读数，然后在电子表格中手动编辑读数。这种现有过程的潜在缺点首先是数据收集成本的增加，其次是由于人为错误导致的不准确和低效。</p><p id="9437" class="pw-post-body-paragraph jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ha bi translated">本文讨论如何利用计算机视觉中的新技术来检测数字电表上的数字，尤其是安装在家庭中的电表。模型训练中不考虑模拟仪表。</p><p id="b741" class="pw-post-body-paragraph jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ha bi translated">Google Colab在本文中用于模型训练。你可以从这个<a class="ae ka" href="https://colab.research.google.com/notebooks/intro.ipynb" rel="noopener ugc nofollow" target="_blank">链接</a>了解更多关于Google Colab的信息。</p><h1 id="06ea" class="kb kc hh bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky bi translated">步骤1:准备数据集并做注释</h1><p id="2541" class="pw-post-body-paragraph jc jd hh je b jf kz jh ji jj la jl jm jn lb jp jq jr lc jt ju jv ld jx jy jz ha bi translated">第一步是从互联网上收集数字仪表的图像。</p><p id="e262" class="pw-post-body-paragraph jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ha bi translated">下载所有图像，并将它们存储在单独的测试和训练文件夹中(80%测试数据和20%训练数据)</p><p id="d766" class="pw-post-body-paragraph jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ha bi translated">下一步是使用LabelImg注释每个图像上的数字，并为测试和训练目录中的所有图像生成带注释的XML文件。你可以从<a class="ae ka" href="https://github.com/tzutalin/labelImg" rel="noopener ugc nofollow" target="_blank">这里</a>获得更多关于LabelImg的细节。</p><p id="f238" class="pw-post-body-paragraph jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ha bi translated">或者，您可以使用我用于训练的测试和训练数据。请参考<a class="ae ka" href="https://github.com/CodinjaoftheWorld/Digit-Recognition-TensorFlow2-Object-Detection-API" rel="noopener ugc nofollow" target="_blank"> Github库</a>访问带有注释文件的测试和训练目录。</p><h1 id="9131" class="kb kc hh bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky bi translated"><strong class="ak">第二步:创建标签图</strong></h1><p id="96f0" class="pw-post-body-paragraph jc jd hh je b jf kz jh ji jj la jl jm jn lb jp jq jr lc jt ju jv ld jx jy jz ha bi translated">标签映射文件的扩展名为. Pb txt。tensor flow需要一个标签映射，它将每个标签映射到一个整数值。</p><p id="a6b5" class="pw-post-body-paragraph jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ha bi translated">下面是我们数据集的label_map.pbtxt文件。</p><pre class="le lf lg lh fd li lj lk ll aw lm bi"><span id="cac6" class="ln kc hh lj b fi lo lp l lq lr">item {</span><span id="1749" class="ln kc hh lj b fi ls lp l lq lr">id: 1</span><span id="0434" class="ln kc hh lj b fi ls lp l lq lr">name: '1'</span><span id="f599" class="ln kc hh lj b fi ls lp l lq lr">}</span><span id="c45d" class="ln kc hh lj b fi ls lp l lq lr">item {</span><span id="e3f7" class="ln kc hh lj b fi ls lp l lq lr">id: 2</span><span id="8d16" class="ln kc hh lj b fi ls lp l lq lr">name: '2'</span><span id="c911" class="ln kc hh lj b fi ls lp l lq lr">}</span><span id="c729" class="ln kc hh lj b fi ls lp l lq lr">item {</span><span id="979e" class="ln kc hh lj b fi ls lp l lq lr">id: 3</span><span id="0040" class="ln kc hh lj b fi ls lp l lq lr">name: '3'</span><span id="c223" class="ln kc hh lj b fi ls lp l lq lr">}</span><span id="4dd2" class="ln kc hh lj b fi ls lp l lq lr">item {</span><span id="0eb2" class="ln kc hh lj b fi ls lp l lq lr">id: 4</span><span id="99f5" class="ln kc hh lj b fi ls lp l lq lr">name: '4'</span><span id="8946" class="ln kc hh lj b fi ls lp l lq lr">}</span><span id="c260" class="ln kc hh lj b fi ls lp l lq lr">item {</span><span id="4d0f" class="ln kc hh lj b fi ls lp l lq lr">id: 5</span><span id="37e8" class="ln kc hh lj b fi ls lp l lq lr">name: '5'</span><span id="fbb0" class="ln kc hh lj b fi ls lp l lq lr">}</span><span id="97da" class="ln kc hh lj b fi ls lp l lq lr">item {</span><span id="2bfa" class="ln kc hh lj b fi ls lp l lq lr">id: 6</span><span id="b05d" class="ln kc hh lj b fi ls lp l lq lr">name: '6'</span><span id="5904" class="ln kc hh lj b fi ls lp l lq lr">}</span><span id="8162" class="ln kc hh lj b fi ls lp l lq lr">item {</span><span id="5490" class="ln kc hh lj b fi ls lp l lq lr">id: 7</span><span id="64bf" class="ln kc hh lj b fi ls lp l lq lr">name: '7'</span><span id="9966" class="ln kc hh lj b fi ls lp l lq lr">}</span><span id="3cf4" class="ln kc hh lj b fi ls lp l lq lr">item {</span><span id="c878" class="ln kc hh lj b fi ls lp l lq lr">id: 8</span><span id="b2b6" class="ln kc hh lj b fi ls lp l lq lr">name: '8'</span><span id="5138" class="ln kc hh lj b fi ls lp l lq lr">}</span><span id="eb2f" class="ln kc hh lj b fi ls lp l lq lr">item {</span><span id="69f4" class="ln kc hh lj b fi ls lp l lq lr">id: 9</span><span id="423f" class="ln kc hh lj b fi ls lp l lq lr">name: '9'</span><span id="d241" class="ln kc hh lj b fi ls lp l lq lr">}</span><span id="1a1d" class="ln kc hh lj b fi ls lp l lq lr">item {</span><span id="2577" class="ln kc hh lj b fi ls lp l lq lr">id: 10</span><span id="d879" class="ln kc hh lj b fi ls lp l lq lr">name: 'zero'</span><span id="bfea" class="ln kc hh lj b fi ls lp l lq lr">}</span></pre><p id="991f" class="pw-post-body-paragraph jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ha bi translated"><em class="lt">注意:标签“0”的分配id不是0。但它是10，原因是TensorFlow在内部将数字0用于另一个赋值，因此如果您将0作为id分配给任何标签，将会遇到错误。</em></p><h1 id="08b9" class="kb kc hh bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky bi translated"><strong class="ak">步骤3:下载迁移学习的预训练模型</strong></h1><p id="bf21" class="pw-post-body-paragraph jc jd hh je b jf kz jh ji jj la jl jm jn lb jp jq jr lc jt ju jv ld jx jy jz ha bi translated">从TensorFlow 2检测模型动物园下载预训练模型进行训练。</p><p id="8cfd" class="pw-post-body-paragraph jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ha bi translated">使用此<a class="ae ka" href="https://github.com/tensorflow/models/blob/master/research/object_detection/g3doc/tf2_detection_zoo.md" rel="noopener ugc nofollow" target="_blank">链接</a>下载您选择的型号。</p><p id="ddbb" class="pw-post-body-paragraph jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ha bi translated"><em class="lt">注:对于本教程，我使用的是</em><a class="ae ka" href="http://download.tensorflow.org/models/object_detection/tf2/20200711/ssd_mobilenet_v1_fpn_640x640_coco17_tpu-8.tar.gz" rel="noopener ugc nofollow" target="_blank"><em class="lt">SSD MobileNet V1 FPN 640 x640</em></a><em class="lt">进行模型训练。</em></p><h1 id="af94" class="kb kc hh bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky bi translated"><strong class="ak">第四步:下载generate_tfrecords.py脚本</strong></h1><p id="d0e3" class="pw-post-body-paragraph jc jd hh je b jf kz jh ji jj la jl jm jn lb jp jq jr lc jt ju jv ld jx jy jz ha bi translated">这个脚本将遍历所有。XML文件，并生成test.record和train.record文件。</p><p id="4179" class="pw-post-body-paragraph jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ha bi translated">从这个<a class="ae ka" href="https://github.com/sglvladi/TensorFlowObjectDetectionTutorial/tree/master/docs/source/scripts" rel="noopener ugc nofollow" target="_blank">链接</a>下载脚本。</p><h1 id="c009" class="kb kc hh bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky bi translated"><strong class="ak">第五步:设置目录结构</strong></h1><p id="a96b" class="pw-post-body-paragraph jc jd hh je b jf kz jh ji jj la jl jm jn lb jp jq jr lc jt ju jv ld jx jy jz ha bi translated">在google drive中创建目录结构，如下图所示。你也可以在你的本地机器上制作这个结构，然后上传到google drive。</p><figure class="le lf lg lh fd ii er es paragraph-image"><div role="button" tabindex="0" class="io ip di iq bf ir"><div class="er es lu"><img src="../Images/1dc643baf1669a6fa3edfe670029e69c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SESRDCYlTZ0fT9lCJMP4bQ.png"/></div></div><figcaption class="iv iw et er es ix iy bd b be z dx translated">模型训练的目录结构</figcaption></figure><p id="947b" class="pw-post-body-paragraph jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ha bi translated">按照下面的说明将相关文件放在各自的目录中。</p><ul class=""><li id="a6c8" class="lv lw hh je b jf jg jj jk jn lx jr ly jv lz jz ma mb mc md bi translated">将步骤4的<strong class="je hi"> generate_tfrecord.py </strong>脚本添加到“tensor flow/scripts/preprocessing/”目录中。</li><li id="520e" class="lv lw hh je b jf me jj mf jn mg jr mh jv mi jz ma mb mc md bi translated">将步骤2的<strong class="je hi"> label_map.pdtxt </strong>文件添加到“/workspace/training _ demo/annotations”目录中。</li><li id="eaec" class="lv lw hh je b jf me jj mf jn mg jr mh jv mi jz ma mb mc md bi translated">将带有各自XML文件的训练和测试图像(步骤1)分别添加到“/workspace/training _ demo/images/train”和“training_demo/images/test”目录中。</li><li id="ae05" class="lv lw hh je b jf me jj mf jn mg jr mh jv mi jz ma mb mc md bi translated">转到“/workspace/training _ demo/models”并创建一个新目录“my_ssd_mobilenet_v1_fpn”(根据步骤3中下载的预训练模型选择名称)。从“/workspace/training _ demo/pre-training-models/SSD _ mobilenet _ v1 _ fpn _ 640 x640 _ coco 17 _ TPU-8”中复制<strong class="je hi"> pipeline.config </strong>文件，粘贴到新创建的“my_ssd_mobilenet_v1_fpn”目录中。</li></ul><p id="1d3b" class="pw-post-body-paragraph jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ha bi translated">上传完各个目录中的所有文件后，目录结构看起来类似于下图。</p><figure class="le lf lg lh fd ii er es paragraph-image"><div role="button" tabindex="0" class="io ip di iq bf ir"><div class="er es mj"><img src="../Images/9c18cae7fce6af27c0e3ba80207e6b5e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*aOkORb5CGWGoA4asgu7FmA.png"/></div></div><figcaption class="iv iw et er es ix iy bd b be z dx translated">模型训练的目录结构</figcaption></figure><p id="6f03" class="pw-post-body-paragraph jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ha bi translated">至此，我们已经完成了所有的手动步骤，剩下的步骤将在google colab笔记本上执行。<a class="ae ka" href="https://github.com/CodinjaoftheWorld/Digit-Recognition-TensorFlow2-Object-Detection-API/blob/main/digit_recognition.ipynb" rel="noopener ugc nofollow" target="_blank">木星笔记本</a>请参考<a class="ae ka" href="https://github.com/CodinjaoftheWorld/Digit-Recognition-TensorFlow2-Object-Detection-API" rel="noopener ugc nofollow" target="_blank"> GitHub资源库</a>。</p><h1 id="f851" class="kb kc hh bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky bi translated"><strong class="ak">第六步:安装Google Drive，在笔记本设置中选择硬件加速器为GPU</strong></h1><p id="9237" class="pw-post-body-paragraph jc jd hh je b jf kz jh ji jj la jl jm jn lb jp jq jr lc jt ju jv ld jx jy jz ha bi translated">在colab笔记本上，转到编辑选项并单击“笔记本设置”。</p><p id="d31b" class="pw-post-body-paragraph jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ha bi translated">选择硬件加速器为“GPU ”,然后单击保存按钮。</p><p id="e744" class="pw-post-body-paragraph jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ha bi translated">运行下面的代码来安装google drive并验证以完成安装。</p><pre class="le lf lg lh fd li lj lk ll aw lm bi"><span id="774c" class="ln kc hh lj b fi lo lp l lq lr">from google.colab import drive<br/>drive.mount('/content/gdrive')</span></pre><h1 id="bef0" class="kb kc hh bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky bi translated"><strong class="ak">第七步:下载Tensorflow模型</strong></h1><p id="43f4" class="pw-post-body-paragraph jc jd hh je b jf kz jh ji jj la jl jm jn lb jp jq jr lc jt ju jv ld jx jy jz ha bi translated">执行以下命令下载张量流模型。</p><pre class="le lf lg lh fd li lj lk ll aw lm bi"><span id="d3b6" class="ln kc hh lj b fi lo lp l lq lr"># cd to the TensorFlow directory<br/>%cd '/content/gdrive/MyDrive/TensorFlow'</span><span id="91fe" class="ln kc hh lj b fi ls lp l lq lr"># clone the TensorFlow Model Garden repository<br/>!git clone https://github.com/tensorflow/models.git</span></pre><p id="ef1e" class="pw-post-body-paragraph jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ha bi translated">运行上述代码后，将在“TensorFlow”目录中创建一个“model”目录。</p><h1 id="5e06" class="kb kc hh bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky bi translated"><strong class="ak">第8步:安装所需的库</strong></h1><pre class="le lf lg lh fd li lj lk ll aw lm bi"><span id="d963" class="ln kc hh lj b fi lo lp l lq lr">!apt-get install protobuf-compiler python-lxml python-pil<br/>!pip install Cython pandas tf-slim<br/>!pip install lvis</span></pre><h1 id="46e1" class="kb kc hh bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky bi translated"><strong class="ak">第9步:编译Protobuf库</strong></h1><p id="f181" class="pw-post-body-paragraph jc jd hh je b jf kz jh ji jj la jl jm jn lb jp jq jr lc jt ju jv ld jx jy jz ha bi translated">导航到“TensorFlow/models/research”目录并运行以下命令。</p><pre class="le lf lg lh fd li lj lk ll aw lm bi"><span id="90c0" class="ln kc hh lj b fi lo lp l lq lr">%cd '/content/gdrive/MyDrive/TensorFlow/models/research/'<br/>!protoc object_detection/protos/*.proto --python_out=.</span></pre><h1 id="3837" class="kb kc hh bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky bi translated"><strong class="ak">第十步:设置环境</strong></h1><pre class="le lf lg lh fd li lj lk ll aw lm bi"><span id="81a9" class="ln kc hh lj b fi lo lp l lq lr">import os<br/>import sys<br/>os.environ['PYTHONPATH']+=":/content/gdrive/MyDrive/TensorFlow/models"<br/>sys.path.append("/content/gdrive/MyDrive/TensorFlow/models/research")</span></pre><h1 id="ec22" class="kb kc hh bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky bi translated"><strong class="ak">第11步:构建并安装setup.py </strong></h1><pre class="le lf lg lh fd li lj lk ll aw lm bi"><span id="61b8" class="ln kc hh lj b fi lo lp l lq lr">!python setup.py build<br/>!python setup.py install</span></pre><h1 id="45f7" class="kb kc hh bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky bi translated"><strong class="ak">步骤12:测试安装</strong></h1><p id="f4b1" class="pw-post-body-paragraph jc jd hh je b jf kz jh ji jj la jl jm jn lb jp jq jr lc jt ju jv ld jx jy jz ha bi translated">转到“tensor flow/models/research/object _ detection/builders/”目录，运行以下命令来测试安装。</p><pre class="le lf lg lh fd li lj lk ll aw lm bi"><span id="2841" class="ln kc hh lj b fi lo lp l lq lr">%cd '/content/gdrive/MyDrive/TensorFlow/models/research/object_detection/builders/'</span><span id="6cae" class="ln kc hh lj b fi ls lp l lq lr">!python model_builder_tf2_test.py<br/>from object_detection.utils import label_map_util<br/>from object_detection.utils import visualization_utils as viz_utils<br/>print('Success')</span></pre><p id="d680" class="pw-post-body-paragraph jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ha bi translated">如果一切顺利，那么“成功”消息将输出。</p><h1 id="9bb7" class="kb kc hh bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky bi translated"><strong class="ak">步骤13:生成Tfrecords </strong></h1><p id="3186" class="pw-post-body-paragraph jc jd hh je b jf kz jh ji jj la jl jm jn lb jp jq jr lc jt ju jv ld jx jy jz ha bi translated">导航到“/tensor flow/scripts/preprocessing”目录，并执行以下命令来生成tfrecords。</p><pre class="le lf lg lh fd li lj lk ll aw lm bi"><span id="f99a" class="ln kc hh lj b fi lo lp l lq lr">%cd '/content/gdrive/MyDrive/TensorFlow/scripts/preprocessing'</span><span id="5417" class="ln kc hh lj b fi ls lp l lq lr"># execute the below command to generate test.record and train.record<br/>!python generate_tfrecord.py -x '/content/gdrive/MyDrive/TensorFlow/workspace/training_demo/images/train' -l '/content/gdrive/MyDrive/TensorFlow/workspace/training_demo/annotations/label_map.pbtxt' -o '/content/gdrive/MyDrive/TensorFlow/workspace/training_demo/annotations/train.record'</span><span id="f65d" class="ln kc hh lj b fi ls lp l lq lr">!python generate_tfrecord.py -x '/content/gdrive/MyDrive/TensorFlow/workspace/training_demo/images/test' -l '/content/gdrive/MyDrive/TensorFlow/workspace/training_demo/annotations/label_map.pbtxt' -o '/content/gdrive/MyDrive/TensorFlow/workspace/training_demo/annotations/test.record'</span></pre><p id="1dd4" class="pw-post-body-paragraph jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ha bi translated">在此步骤之后，将在“注释”目录中生成“训练.记录”和“测试.记录”文件。</p><h1 id="fd2c" class="kb kc hh bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky bi translated"><strong class="ak">步骤14:整理模型训练和模型导出的文件</strong></h1><p id="2726" class="pw-post-body-paragraph jc jd hh je b jf kz jh ji jj la jl jm jn lb jp jq jr lc jt ju jv ld jx jy jz ha bi translated">从' tensor flow \ models \ research \ object _ detection '中复制<strong class="je hi"> model_main_tf2.py </strong>文件并粘贴到training_demo目录中。模型训练需要此文件。</p><p id="3d51" class="pw-post-body-paragraph jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ha bi translated">从' tensor flow \ models \ research \ object _ detection '中复制<strong class="je hi"> exporter_main_v2.py </strong>文件，粘贴到training_demo目录中。模型导出需要此文件。</p><h1 id="263c" class="kb kc hh bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky bi translated">步骤15:配置pipeline.config <strong class="ak"> </strong>文件</h1><p id="6d75" class="pw-post-body-paragraph jc jd hh je b jf kz jh ji jj la jl jm jn lb jp jq jr lc jt ju jv ld jx jy jz ha bi translated">导航到'<a class="ae ka" href="https://colab.research.google.com/drive/1DuEv5RYM7GbtKK5fhYJQeKiZz6dBpBkU?authuser=1#" rel="noopener ugc nofollow" target="_blank">/tensor flow/workspace/training _ demo/models/my _ SSD _ mobilenet _ v1 _ fpn</a>，在google colab中打开<strong class="je hi"> pipeline.config </strong>文件。</p><p id="98c0" class="pw-post-body-paragraph jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ha bi translated">在<strong class="je hi"> pipeline.config </strong>文件中进行以下更改。</p><ul class=""><li id="d8ca" class="lv lw hh je b jf jg jj jk jn lx jr ly jv lz jz ma mb mc md bi translated">第3行—数量_类别:10</li><li id="80bc" class="lv lw hh je b jf me jj mf jn mg jr mh jv mi jz ma mb mc md bi translated">第131行—批量大小:16</li><li id="cb10" class="lv lw hh je b jf me jj mf jn mg jr mh jv mi jz ma mb mc md bi translated">第161行— fine_tune_checkpoint:"预训练模型<a class="ae ka" href="https://colab.research.google.com/drive/1DuEv5RYM7GbtKK5fhYJQeKiZz6dBpBkU?authuser=1#" rel="noopener ugc nofollow" target="_blank">/SSD _ mobilenet _ v1 _ fpn _ 640 x640 _ coco 17 _ TPU-8/check point/ckpt-0</a>"</li><li id="f446" class="lv lw hh je b jf me jj mf jn mg jr mh jv mi jz ma mb mc md bi translated">第162行—步数:250000</li><li id="fb4f" class="lv lw hh je b jf me jj mf jn mg jr mh jv mi jz ma mb mc md bi translated">第167行—微调检查点类型:“检测”</li><li id="aa41" class="lv lw hh je b jf me jj mf jn mg jr mh jv mi jz ma mb mc md bi translated">第172行—输入路径:“注释/训练记录”</li><li id="684d" class="lv lw hh je b jf me jj mf jn mg jr mh jv mi jz ma mb mc md bi translated">第185行—输入路径:“注释/测试.记录”</li></ul><h1 id="26ed" class="kb kc hh bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky bi translated"><strong class="ak">第十六步:启动张量板</strong></h1><p id="3078" class="pw-post-body-paragraph jc jd hh je b jf kz jh ji jj la jl jm jn lb jp jq jr lc jt ju jv ld jx jy jz ha bi translated">导航到“training_demo”目录，运行以下命令启动TensorBaord。</p><figure class="le lf lg lh fd ii er es paragraph-image"><div role="button" tabindex="0" class="io ip di iq bf ir"><div class="er es mk"><img src="../Images/40ca5995f031e7f9742e340223b265fe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ijtNo6AQkxjSmCS24FRRHg.png"/></div></div><figcaption class="iv iw et er es ix iy bd b be z dx translated">google colab中的TensorBoard</figcaption></figure><h1 id="7fdc" class="kb kc hh bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky bi translated">第十七步:训练<strong class="ak">模型</strong></h1><p id="ce35" class="pw-post-body-paragraph jc jd hh je b jf kz jh ji jj la jl jm jn lb jp jq jr lc jt ju jv ld jx jy jz ha bi translated">执行以下代码开始培训</p><pre class="le lf lg lh fd li lj lk ll aw lm bi"><span id="d40e" class="ln kc hh lj b fi lo lp l lq lr">!python model_main_tf2.py --model_dir=models/my_ssd_mobilenet_v1_fpn --pipeline_config_path=models/my_ssd_mobilenet_v1_fpn/pipeline.config</span></pre><p id="cbbf" class="pw-post-body-paragraph jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ha bi translated">模型训练的开始由类似于下面截图的输出显示。默认情况下，每100步显示一次输出日志。</p><figure class="le lf lg lh fd ii er es paragraph-image"><div role="button" tabindex="0" class="io ip di iq bf ir"><div class="er es ml"><img src="../Images/95af6ba2e81741aa9c42fd460cc8cb0e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*AThBLsdDuGecmsltwldWlg.png"/></div></div><figcaption class="iv iw et er es ix iy bd b be z dx translated">模特培训</figcaption></figure><p id="8a35" class="pw-post-body-paragraph jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ha bi translated">应该训练该模型，直到损失持续保持在0.3以下。</p><p id="0eed" class="pw-post-body-paragraph jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ha bi translated">检查点文件将每1000步保存一次。如果训练已经在google colab中停止，那么可以通过再次运行上述步骤来恢复训练。最新的检查点将自动恢复，训练将从该检查点开始。</p><p id="70e5" class="pw-post-body-paragraph jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ha bi translated">在训练过程中，使用tensorboard监控损失和学习率。</p><h1 id="1e5a" class="kb kc hh bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky bi translated"><strong class="ak">步骤18:导出训练好的模型</strong></h1><p id="6c90" class="pw-post-body-paragraph jc jd hh je b jf kz jh ji jj la jl jm jn lb jp jq jr lc jt ju jv ld jx jy jz ha bi translated">运行以下命令以导出训练好的推理图，这些推理图将用于执行对象检测。</p><pre class="le lf lg lh fd li lj lk ll aw lm bi"><span id="d543" class="ln kc hh lj b fi lo lp l lq lr">!python exporter_main_v2.py --input_type image_tensor --pipeline_config_path ./models/my_ssd_mobilenet_v1_fpn/pipeline.config --trained_checkpoint_dir ./models/my_ssd_mobilenet_v1_fpn/ --output_directory ./exported-models/my_model</span></pre><h1 id="7396" class="kb kc hh bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky bi translated">步骤19:加载训练好的模型</h1><p id="2c61" class="pw-post-body-paragraph jc jd hh je b jf kz jh ji jj la jl jm jn lb jp jq jr lc jt ju jv ld jx jy jz ha bi translated">执行以下命令，在“/tensor flow/workspace/training _ demo/exported-models/my _ model/saved _ model”处加载训练好的模型。</p><pre class="le lf lg lh fd li lj lk ll aw lm bi"><span id="4884" class="ln kc hh lj b fi lo lp l lq lr">import tensorflow as tf<br/>import time<br/>from object_detection.utils import label_map_util<br/>from object_detection.utils import visualization_utils as viz_utils</span><span id="d156" class="ln kc hh lj b fi ls lp l lq lr">PATH_TO_SAVED_MODEL="/content/gdrive/MyDrive/TensorFlow/workspace/training_demo/exported-models/my_model/saved_model"</span><span id="7d05" class="ln kc hh lj b fi ls lp l lq lr">print('Loading model...', end='')</span><span id="0df3" class="ln kc hh lj b fi ls lp l lq lr"># load the saved model and build the detection function<br/>detect_function=tf.saved_model.load(PATH_TO_SAVED_MODEL)<br/>print('Model Loaded!')</span></pre><h1 id="a688" class="kb kc hh bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky bi translated"><strong class="ak">步骤20:加载label_map </strong></h1><p id="b19c" class="pw-post-body-paragraph jc jd hh je b jf kz jh ji jj la jl jm jn lb jp jq jr lc jt ju jv ld jx jy jz ha bi translated">运行以下命令加载label_map。</p><pre class="le lf lg lh fd li lj lk ll aw lm bi"><span id="fd6a" class="ln kc hh lj b fi lo lp l lq lr">category_index=label_map_util.create_category_index_from_labelmap("/content/gdrive/MyDrive/TensorFlow/workspace/training_demo/annotations/label_map.pbtxt",use_display_name=True)</span></pre><h1 id="e762" class="kb kc hh bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky bi translated">步骤21:加载测试<strong class="ak">训练好的模型的图像</strong></h1><p id="3925" class="pw-post-body-paragraph jc jd hh je b jf kz jh ji jj la jl jm jn lb jp jq jr lc jt ju jv ld jx jy jz ha bi translated">参考GitHub库并下载<a class="ae ka" href="https://github.com/CodinjaoftheWorld/Digit-Recognition-TensorFlow2-Object-Detection-API/tree/main/testing_images" rel="noopener ugc nofollow" target="_blank">测试图片</a>。将这些测试图像放在“/tensor flow/workspace/training _ demo”目录中，并运行以下命令来加载图像。</p><pre class="le lf lg lh fd li lj lk ll aw lm bi"><span id="a873" class="ln kc hh lj b fi lo lp l lq lr">img=['/content/gdrive/MyDrive/TensorFlow/workspace/training_demo/1.jpeg', '/content/gdrive/MyDrive/TensorFlow/workspace/training_demo/2.jpeg', '/content/gdrive/MyDrive/TensorFlow/workspace/training_demo/3.jpeg', '/content/gdrive/MyDrive/TensorFlow/workspace/training_demo/4.jpg']</span><span id="7598" class="ln kc hh lj b fi ls lp l lq lr">print(img)</span></pre><h1 id="083a" class="kb kc hh bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky bi translated">步骤22 <strong class="ak">:可视化检测</strong></h1><p id="d0e6" class="pw-post-body-paragraph jc jd hh je b jf kz jh ji jj la jl jm jn lb jp jq jr lc jt ju jv ld jx jy jz ha bi translated">运行下面的代码来可视化谷歌colab笔记本中的检测。</p><pre class="le lf lg lh fd li lj lk ll aw lm bi"><span id="7e61" class="ln kc hh lj b fi lo lp l lq lr">import numpy as np<br/>from PIL import Image<br/>import matplotlib.pyplot as plt<br/>import warnings<br/>warnings.filterwarnings('ignore')</span><span id="df66" class="ln kc hh lj b fi ls lp l lq lr">def load_image_into_numpy_array(path):<br/>    return np.array(Image.open(path))</span><span id="50ff" class="ln kc hh lj b fi ls lp l lq lr">for image_path in img:<br/>    print('Running inference for {}... '.format(image_path), end='')<br/>    image_np=load_image_into_numpy_array(image_path)<br/>    input_tensor=tf.convert_to_tensor(image_np)<br/>    input_tensor=input_tensor[tf.newaxis, ...]<br/>    detections=detect_function(input_tensor)<br/>    num_detections=int(detections.pop('num_detections'))<br/>    detections={key:value[0,:num_detections].numpy() for key,value in detections.items()}<br/>    detections['num_detections']=num_detections<br/>    detections['detection_classes'] = detections['detection_classes'].astype(np.int64)<br/>    image_np_with_detections=image_np.copy()<br/>    viz_utils.visualize_boxes_and_labels_on_image_array(<br/>        image_np_with_detections,<br/>        detections['detection_boxes'],<br/>        detections['detection_classes'],<br/>        detections['detection_scores'],<br/>        category_index,<br/>        use_normalized_coordinates=True,<br/>        max_boxes_to_draw=100,<br/>        min_score_thresh=.8,<br/>        agnostic_mode=False)</span><span id="ef86" class="ln kc hh lj b fi ls lp l lq lr">%matplotlib inline<br/>plt.figure(figsize=(20, 10))<br/>plt.imshow(image_np_with_detections)<br/>print('Done')<br/>plt.show()</span></pre><p id="a7fc" class="pw-post-body-paragraph jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ha bi translated">如果一切顺利，那么应该可以看到以下检测。</p><div class="le lf lg lh fd ab cb"><figure class="ih ii mm ik il im in paragraph-image"><div role="button" tabindex="0" class="io ip di iq bf ir"><img src="../Images/a7a8cfb1898c106eb312822b6d7e427f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1280/format:webp/1*VEQndVatI1tvtHEuoZFFOA.png"/></div></figure><figure class="ih ii mn ik il im in paragraph-image"><div role="button" tabindex="0" class="io ip di iq bf ir"><img src="../Images/838385d4639032ad58c5d5fa77f36f72.png" data-original-src="https://miro.medium.com/v2/resize:fit:722/format:webp/1*Hn3N0th26Q1iV2xPalo45w.png"/></div></figure></div><div class="ab cb"><figure class="ih ii mo ik il im in paragraph-image"><div role="button" tabindex="0" class="io ip di iq bf ir"><img src="../Images/10674a791fb22e8e6f71085f5481b002.png" data-original-src="https://miro.medium.com/v2/resize:fit:1058/format:webp/1*MkA803ZJfU5ibz5CNynZIQ.png"/></div></figure><figure class="ih ii mp ik il im in paragraph-image"><div role="button" tabindex="0" class="io ip di iq bf ir"><img src="../Images/aeec3ce644180a1b3bb5d0c23e17e7b1.png" data-original-src="https://miro.medium.com/v2/resize:fit:944/format:webp/1*t9qEMSfbsiMOk0QEpbRF4g.png"/></div><figcaption class="iv iw et er es ix iy bd b be z dx mq di mr jb translated">数字仪表上数字的抽样检测</figcaption></figure></div><h2 id="7c9c" class="ln kc hh bd kd ms mt mu kh mv mw mx kl jn my mz kp jr na nb kt jv nc nd kx ne bi translated"><strong class="ak">参考</strong>:</h2><p id="5159" class="pw-post-body-paragraph jc jd hh je b jf kz jh ji jj la jl jm jn lb jp jq jr lc jt ju jv ld jx jy jz ha bi translated">tensor flow-Object-Detection-api-tutorial |<a class="ae ka" href="https://tensorflow-object-detection-api-tutorial.readthedocs.io/en/latest/index.html#" rel="noopener ugc nofollow" target="_blank">tensor flow 2物体检测API教程</a>由柳德米尔<code class="du nf ng nh lj b">725f2221</code>修订</p><p id="e2c4" class="pw-post-body-paragraph jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ha bi translated">GitHub资源库链接:<a class="ae ka" href="https://github.com/CodinjaoftheWorld/Digit-Recognition-TensorFlow2-Object-Detection-API" rel="noopener ugc nofollow" target="_blank">https://GitHub . com/CodinjaoftheWorld/Digit-Recognition-tensor flow 2-Object-Detection-API</a></p></div></div>    
</body>
</html>