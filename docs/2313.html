<html>
<head>
<title>Indexing JsonField in Django and PostgreSQL</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Django和PostgreSQL中索引JsonField</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/indexing-jsonfield-in-django-and-postgresql-89b7571df830?source=collection_archive---------7-----------------------#2021-04-18">https://medium.com/analytics-vidhya/indexing-jsonfield-in-django-and-postgresql-89b7571df830?source=collection_archive---------7-----------------------#2021-04-18</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="adb4" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">几天前，我们接到了市场部的一个任务，为了执行这个任务，我们需要存储一些特定的数据，因为这些数据没有任何方案，除了一个端点之外，我们没有对其进行查询，所以我们决定使用django的JsonField。但是对于技术团队来说，在JsonField上查询大量数据的性能是有疑问的，所以我们在django中创建了一个样本项目来测试查询Jsonfield。</p><p id="fce1" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><em class="jc">该项目的全部代码可在</em> <a class="ae jd" href="https://github.com/abtinmo/django_jsonfield_index" rel="noopener ugc nofollow" target="_blank"> <em class="jc"> github </em> </a> <em class="jc">上获得。</em></p><p id="8015" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">要阅读本文，您需要对django和命令行环境有一个基本的了解。</p><p id="75d9" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">首先我们要安装django和postgres适配器</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="5ce8" class="jn jo hh jj b fi jp jq l jr js">pip install django psycopg2-binary</span></pre><p id="c3d5" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">然后创建一个django项目，名为jstest(智能名称:)</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="bb03" class="jn jo hh jj b fi jp jq l jr js">django-admin startproject jstest<br/>cd jstest <br/>python3 manage.py migrate</span></pre><p id="e2cc" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">为了创建端点，我们将启动一个新的django应用程序</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="77f5" class="jn jo hh jj b fi jp jq l jr js">python3 manage.py startapp testapp</span></pre><p id="43bc" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">现在让我们去改变代码。<br/>在<strong class="ig hi"> jstest/settings.py </strong>中，我们将新的应用程序添加到INSTALLED_APPS中，并将数据库更改为postgres</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="d1b9" class="jn jo hh jj b fi jp jq l jr js">INSTALLED_APPS = [<br/> …<br/> ‘testapp’,<br/> ]<br/> <br/> <br/> DATABASES = {<br/> ‘default’: {<br/> ‘ENGINE’: ‘django.db.backends.postgresql_psycopg2’,<br/> ‘NAME’: ‘YOUR_DB_NAME’,<br/> ‘USER’: ‘YOUR_DB_USER’,<br/> ‘PASSWORD’: ‘YOUR_DB_PASSWORD’,<br/> ‘HOST’: ‘localhost’,<br/> ‘PORT’: ‘’,<br/> }<br/>}</span></pre><p id="7e2d" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在<strong class="ig hi"> testapp/models.py </strong>中，我们添加了以下模型:</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="dce2" class="jn jo hh jj b fi jp jq l jr js">from django.db import models<br/>from django.utils import timezone<br/> <br/> <br/>class Product(models.Model):<br/>    name = models.CharField(max_length=20)<br/>    attributes = models.JSONField()<br/>    create_date = models.DateTimeField(default=timezone.now)</span></pre><p id="e131" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">最后迁移变更:</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="4707" class="jn jo hh jj b fi jp jq l jr js">python3 manage.py makemigrations<br/>python3 manage.py migrate</span></pre><p id="8321" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">现在，为了测试查询速度，我们需要向product表中添加虚拟数据，出于测试目的，我们向表中写入了2百万行。<br/>如果您正在使用我的代码，您可以运行以下命令:</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="4a83" class="jn jo hh jj b fi jp jq l jr js">python3 manage.py create_sample_data</span></pre><p id="ddc7" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">如果没有，这个函数会为您创建一个样本数据</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="a0f6" class="jn jo hh jj b fi jp jq l jr js">from itertools import islice<br/>from testapp.models import Product<br/> <br/> batch_size = 5000<br/> objs = (<br/>     Product(<br/>         name=’product No.%s’ % i,<br/>         attributes={“name”: i, “values”: [i, i + 1]},<br/>     ) for i in range(2_000_000)<br/> )<br/> while True:<br/>     batch = list(islice(objs, batch_size))<br/>     if not batch:<br/>         break<br/>     Product.objects.bulk_create(batch, batch_size)</span></pre><p id="e2bf" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">属性字段中存储的数据如下:</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="8f29" class="jn jo hh jj b fi jp jq l jr js">{<br/> “name”: 1,<br/> “values”: [1,2]<br/> }</span></pre><p id="71f8" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">现在让我们实现查询速度的端点…<br/>添加以下代码到<strong class="ig hi"> testapp/views.py </strong>，我稍后会解释</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="4d7c" class="jn jo hh jj b fi jp jq l jr js">from .models import Product<br/>from django.db import connection<br/>from django.http import HttpResponse<br/>from random import randrange<br/> <br/> <br/>def product_view(request):<br/>    rand_num = randrange(0, 2_000_000)<br/>    _ = Product.objects.get(attributes__name=rand_num)<br/>    dict_lookup_time = connection.queries[-1][“time”]<br/>    _ = Product.objects.get(<br/>    attributes__values__contains=[rand_num, rand_num + 1],<br/>    )<br/>    list_lookup_time = connection.queries[-1][“time”]<br/>    return HttpResponse(<br/>        f”dict lookup time: {dict_lookup_time} “<br/>        f”list lookup time: {list_lookup_time}”<br/>    )</span></pre><p id="b8f3" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我们想要基于“名称”和“值”键查询JsonField，首先我们生成一个随机数，然后用这个随机数进行查询。</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="4b83" class="jn jo hh jj b fi jp jq l jr js">rand_num = randrange(0, 2_000_000)</span><span id="510b" class="jn jo hh jj b fi jt jq l jr js">Product.objects.get(attributes__name=rand_num)<br/># search value of “name”<br/>Product.objects.get(attributes__values__contains=[rand_num, rand_num + 1])<br/>#search in value of “values”</span></pre><p id="d5bb" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">通过这段代码，我们可以知道最后一次查询花费了多少时间。</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="449c" class="jn jo hh jj b fi jp jq l jr js">connection.queries[-1][“time”]</span></pre><p id="a5cd" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">将下面的代码添加到<strong class="ig hi"> jstest/urls.py </strong>中，我们就完成了django。</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="e43d" class="jn jo hh jj b fi jp jq l jr js">from django.contrib import admin<br/>from django.urls import path<br/>from testapp.views import product_view<br/> <br/>urlpatterns = [<br/>    path(‘admin/’, admin.site.urls),<br/>    path(‘’, product_view),<br/>]</span></pre><p id="61df" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">使用以下命令启动项目，并在浏览器中打开<a class="ae jd" href="http://localhost:8000" rel="noopener ugc nofollow" target="_blank"> localhost:8000 </a>。</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="c3cf" class="jn jo hh jj b fi jp jq l jr js">python3 manage.py runserver</span></pre><p id="fa9d" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">现在，您可能会看到类似这样的内容:</p><figure class="je jf jg jh fd jv er es paragraph-image"><div class="er es ju"><img src="../Images/e914d7705d39919a1a5889c638ff0449.png" data-original-src="https://miro.medium.com/v2/resize:fit:976/format:webp/1*QLJUjW725e3VLwGMsip2jw.png"/></div></figure><figure class="je jf jg jh fd jv er es paragraph-image"><div class="er es jy"><img src="../Images/cc53e6d1757d0398b15f6227f10e8a3c.png" data-original-src="https://miro.medium.com/v2/resize:fit:992/format:webp/1*Wkc_ZM756NEtsG0unr7y9A.png"/></div></figure><p id="468d" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">对于一个没有负载的项目来说，1秒是不可接受的时间，所以让我们来修正它。<br/>为了减少查询时间，我们给属性字段添加了一个索引:</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="bd63" class="jn jo hh jj b fi jp jq l jr js">CREATE INDEX JsonFieldIndex ON testapp_product USING GIN(attributes jsonb_path_ops);</span></pre><p id="620b" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">现在让我们刷新网页，看看是否有什么不同</p><figure class="je jf jg jh fd jv er es paragraph-image"><div class="er es jz"><img src="../Images/871f83b76e96779f2202785f62d4f3dd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1204/format:webp/1*hKghNGKcTmsGmT67WpjDkA.png"/></div></figure><figure class="je jf jg jh fd jv er es paragraph-image"><div class="er es jz"><img src="../Images/83a4f1e0639867205ec688844d1a6535.png" data-original-src="https://miro.medium.com/v2/resize:fit:1204/format:webp/1*XP1h--g5XIeh9IlMPdH9pg.png"/></div></figure><p id="78e2" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">不错，这是以前时间的一半，但对于一个没有负载的项目来说还是太长了。</p><p id="ea83" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">现在我们为“name”和“values”创建两个独立的索引，因为我们知道一个是数组，另一个是整数。</p><p id="b7ce" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">第一次删除前一个索引</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="8d57" class="jn jo hh jj b fi jp jq l jr js">drop index JsonFieldIndex;</span></pre><p id="8d7b" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">然后创建新的索引</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="c2eb" class="jn jo hh jj b fi jp jq l jr js">CREATE INDEX JsonFieldIndexList ON testapp_product USING GIN((attributes-&gt;’values’) jsonb_path_ops);</span><span id="5f0b" class="jn jo hh jj b fi jt jq l jr js">CREATE INDEX JsonFieldIndex ON testapp_product USING HASH((attributes -&gt; ‘name’));</span></pre><p id="a608" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">现在，如果我们刷新网页，我们会看到这个结果。</p><figure class="je jf jg jh fd jv er es paragraph-image"><div class="er es ka"><img src="../Images/becae8194921e6bfc400b4380da1e980.png" data-original-src="https://miro.medium.com/v2/resize:fit:1026/format:webp/1*OaABRvazVLhADoHH8qEpEg.png"/></div></figure><figure class="je jf jg jh fd jv er es paragraph-image"><div class="er es ka"><img src="../Images/bc08aae71d796c6af7e2cb77bfe017d2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1026/format:webp/1*lxYMurYla9FfftX2srPlAA.png"/></div></figure><p id="f28a" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">区别很明显，对吧？:)</p><p id="8d4d" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">为什么我们使用GIN和HASH进行索引？</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="9b5a" class="jn jo hh jj b fi jp jq l jr js">CREATE INDEX JsonFieldIndexList ON testapp_product USING <strong class="jj hi">GIN</strong>((attributes-&gt;’values’) <strong class="jj hi">jsonb_path_ops</strong>);</span></pre><p id="7ed7" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在第一个示例中，我们的数据如下所示:</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="4d1d" class="jn jo hh jj b fi jp jq l jr js">"values": [1, 2]</span></pre><p id="f016" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">根据postgres文件:</p><blockquote class="kb kc kd"><p id="6f3a" class="ie if jc ig b ih ii ij ik il im in io ke iq ir is kf iu iv iw kg iy iz ja jb ha bi translated">GIN索引是“倒排索引”，适用于包含多个组件值的数据值，如数组</p></blockquote><p id="c233" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">对于我们的目的来说，GIN是最好的索引类型，我们也不需要索引键，所以我们只需要索引值(在我们的例子[1，2]中)，基于此，我们需要使用GIN和<code class="du kh ki kj jj b">jsonb_path_ops</code>操作符类。</p></div><div class="ab cl kk kl go km" role="separator"><span class="kn bw bk ko kp kq"/><span class="kn bw bk ko kp kq"/><span class="kn bw bk ko kp"/></div><div class="ha hb hc hd he"><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="a2fb" class="jn jo hh jj b fi jp jq l jr js">CREATE INDEX JsonFieldIndex ON testapp_product USING <strong class="jj hi">HASH</strong>((attributes -&gt; ‘name’));</span></pre><p id="e651" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在第二个示例中，我们的数据如下所示:</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="ad1f" class="jn jo hh jj b fi jp jq l jr js">"name": 1</span></pre><p id="9302" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">根据postgres文件:</p><blockquote class="kb kc kd"><p id="c8e8" class="ie if jc ig b ih ii ij ik il im in io ke iq ir is kf iu iv iw kg iy iz ja jb ha bi translated">哈希索引只能处理简单的相等比较。每当使用<code class="du kh ki kj jj b">=</code>操作符进行比较时涉及到一个索引列，查询规划器就会考虑使用散列索引。</p></blockquote><p id="00aa" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">与其他索引类型相比，HASH使用的空间更少，在我们的查询中，我们使用just = operator，基于这一点，最适合我们的索引类型是HASH。</p></div><div class="ab cl kk kl go km" role="separator"><span class="kn bw bk ko kp kq"/><span class="kn bw bk ko kp kq"/><span class="kn bw bk ko kp"/></div><div class="ha hb hc hd he"><p id="766b" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">如果您想了解postgres JSON域中的不同索引，请阅读这篇文章。</p><p id="bea9" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><a class="ae jd" href="https://dev.to/scalegrid/using-jsonb-in-postgresql-how-to-effectively-store-index-json-data-in-postgresql-5d7e" rel="noopener ugc nofollow" target="_blank">https://dev . to/scale grid/using-jsonb-in-PostgreSQL-how-to-effectively-store-index-JSON-data-in-PostgreSQL-5d 7 e</a></p><p id="e4e2" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">如果你想了解更多关于postgres索引类型的信息，这是一篇你想读的文章。</p><p id="73c5" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">【https://www.postgresql.org/docs/12/indexes-types.html T4】</p></div></div>    
</body>
</html>