<html>
<head>
<title>MySQL HA InnoDB Cluster with MySQLRouter and KeepAlived</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">带有MySQLRouter和KeepAlived的MySQL HA InnoDB集群</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/mysql-ha-innodb-cluster-with-mysqlrouter-and-keepalived-760ec01cabe?source=collection_archive---------8-----------------------#2021-05-07">https://medium.com/analytics-vidhya/mysql-ha-innodb-cluster-with-mysqlrouter-and-keepalived-760ec01cabe?source=collection_archive---------8-----------------------#2021-05-07</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="10d1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">大家好，</p><p id="1b91" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我今天在这里有一个新的话题:)。</p><p id="5f80" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我要写的是HA MySQL InnoDB集群。开始吧！</p><p id="7a62" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">首先，我有6台服务器，其中3台用于MySQL实例，2台用于mysqlrouter，最后一台用于集群管理和监控(我们使用MySQL Enterprise Monitor进行监控)。</p><p id="402b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">以下是主机名:</p><p id="12f0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">MySQL实例:</p><p id="921c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> inno1 <br/> inno2 <br/> inno3 </strong></p><p id="a619" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">mysqlrouter服务器:</p><p id="1068" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">MySQL router 1<br/>MySQL router 2</strong></p><p id="42e8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">集群管理和监控服务器:</p><p id="9067" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> inno-server-mon </strong></p><p id="5b30" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为了配置innodb集群，我们需要对我们的服务器进行一些更改。</p><ol class=""><li id="029f" class="jd je hi ih b ii ij im in iq jf iu jg iy jh jc ji jj jk jl bi translated">禁用selinux</li></ol><p id="42e5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为了做到这一点:</p><blockquote class="jm jn jo"><p id="d1c7" class="if ig jp ih b ii ij ik il im in io ip jq ir is it jr iv iw ix js iz ja jb jc hb bi translated"><strong class="ih hj"> vi /etc/selinux/config </strong></p></blockquote><p id="8cdd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我注释掉了由“#SELINUX=enforcing”参数组成的行，并添加了以下参数:</p><blockquote class="jm jn jo"><p id="e9e8" class="if ig jp ih b ii ij ik il im in io ip jq ir is it jr iv iw ix js iz ja jb jc hb bi translated"><strong class="ih hj">SELINUX =禁用</strong></p></blockquote><p id="63ed" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">2禁用防火墙(如果您有IP表配置您的设置)</p><p id="904a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">要禁用防火墙:</p><blockquote class="jm jn jo"><p id="631b" class="if ig jp ih b ii ij ik il im in io ip jq ir is it jr iv iw ix js iz ja jb jc hb bi translated"><strong class="ih hj">系统ctl停止防火墙d </strong></p></blockquote><p id="2337" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我跳过了在每个数据库服务器上安装MySQL服务器，因为这不是我们的主题。</p><p id="90d4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">对了，我们用的MySQL版本是8.0.23。</p><p id="975f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">安装MySQL服务器后，我们创建一个用户来管理所有数据库实例:</p><blockquote class="jm jn jo"><p id="56b6" class="if ig jp ih b ii ij ik il im in io ip jq ir is it jr iv iw ix js iz ja jb jc hb bi translated"><strong class="ih hj">创建由“your_password”标识的用户“root”@“%”；<br/>授予*的所有权限。* TO 'root'@'% '带有GRANT选项；<br/>同花顺特权；</strong></p></blockquote><p id="aef4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们将部署一个托管的InnoDB集群，因此我们需要安装mysqlsh。在我的<strong class="ih hj"> inno-server-mon </strong>服务器上:</p><p id="f328" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果您没有MySQL yum存储库，您应该按照以下步骤操作:</p><div class="jt ju ez fb jv jw"><a href="https://dev.mysql.com/doc/mysql-yum-repo-quick-guide/en/#repo-qg-yum-repo-setup" rel="noopener  ugc nofollow" target="_blank"><div class="jx ab dw"><div class="jy ab jz cl cj ka"><h2 class="bd hj fi z dy kb ea eb kc ed ef hh bi translated">使用MySQL Yum存储库的快速指南</h2><div class="kd l"><h3 class="bd b fi z dy kb ea eb kc ed ef dx translated">首先，将MySQL Yum存储库添加到系统的存储库列表中。按照以下步骤操作:转到下载页面…</h3></div><div class="ke l"><p class="bd b fp z dy kb ea eb kc ed ef dx translated">dev.mysql.com</p></div></div></div></a></div><p id="a860" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">sudo yum更新</p><p id="9fdf" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">sudo yum安装mysql-shell</p><p id="d7b5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">成功安装mysql-shell后，在inno-server-mon上</p><blockquote class="jm jn jo"><p id="d27d" class="if ig jp ih b ii ij ik il im in io ip jq ir is it jr iv iw ix js iz ja jb jc hb bi translated"><strong class="ih hj">mysqlsh—uri root @ inno 1:3306—用户root </strong></p></blockquote><p id="61f3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，我们可以检查我们的MySQL服务器实例是否适合InnoDB集群。</p><blockquote class="jm jn jo"><p id="d232" class="if ig jp ih b ii ij ik il im in io ip jq ir is it jr iv iw ix js iz ja jb jc hb bi translated"><strong class="ih hj">DBA . check instance configuration(' root @ inno 1:3306 ')<br/>DBA . check instance configuration(' root @ inno 2:3306 ')<br/>DBA . check instance configuration(' root @ inno 3:3306 ')</strong></p></blockquote><p id="bcfd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果实例的配置不符合要求，您可以使用以下命令配置实例:</p><blockquote class="jm jn jo"><p id="9c56" class="if ig jp ih b ii ij ik il im in io ip jq ir is it jr iv iw ix js iz ja jb jc hb bi translated"><strong class="ih hj">DBA . configure instance(' root @ inno 1:3306 ')<br/>DBA . configure instance(' root @ inno 2:3306 ')<br/>DBA . configure instance(' root @ inno 3:3306 ')</strong></p></blockquote><p id="c383" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后，您可以使用以下命令再次检查配置:</p><blockquote class="jm jn jo"><p id="755d" class="if ig jp ih b ii ij ik il im in io ip jq ir is it jr iv iw ix js iz ja jb jc hb bi translated"><strong class="ih hj">DBA . check instance configuration(' root @ inno 1:3306 ')<br/>DBA . check instance configuration(' root @ inno 2:3306 ')<br/>DBA . check instance configuration(' root @ inno 3:3306 ')</strong></p></blockquote><p id="7976" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">示例输出:</p><blockquote class="jm jn jo"><p id="e5d4" class="if ig jp ih b ii ij ik il im in io ip jq ir is it jr iv iw ix js iz ja jb jc hb bi translated"><strong class="ih hj">验证inno1:3306上的MySQL实例，以便在InnoDB集群中使用… </strong></p><p id="50e2" class="if ig jp ih b ii ij ik il im in io ip jq ir is it jr iv iw ix js iz ja jb jc hb bi translated"><strong class="ih hj">该实例报告其自己的地址，因为inno1:3306 <br/>默认情况下，客户端和其他集群成员将通过该地址与其通信。如果不正确，应该更改report_host MySQL系统变量。</strong></p><p id="7385" class="if ig jp ih b ii ij ik il im in io ip jq ir is it jr iv iw ix js iz ja jb jc hb bi translated"><strong class="ih hj">检查现有表是否符合组复制要求……<br/>未检测到不兼容的表</strong></p><p id="42e9" class="if ig jp ih b ii ij ik il im in io ip jq ir is it jr iv iw ix js iz ja jb jc hb bi translated"><strong class="ih hj">检查实例配置… <br/>实例配置与InnoDB集群兼容</strong></p><p id="b141" class="if ig jp ih b ii ij ik il im in io ip jq ir is it jr iv iw ix js iz ja jb jc hb bi translated">实例“inno1:3306”可以在InnoDB集群中使用。</p><p id="2ce9" class="if ig jp ih b ii ij ik il im in io ip jq ir is it jr iv iw ix js iz ja jb jc hb bi translated"><strong class="ih hj"> { <br/>“状态”:“正常”<br/> } </strong></p></blockquote><p id="5430" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，我们可以创建一个集群:</p><blockquote class="jm jn jo"><p id="caab" class="if ig jp ih b ii ij ik il im in io ip jq ir is it jr iv iw ix js iz ja jb jc hb bi translated"><strong class="ih hj">var cluster = DBA . create cluster(' myinno cluster ')<br/>验证root@inno1:3306… <br/>此实例报告其自己的地址，因为ic-1 <br/>实例配置是合适的。<br/>在“root@inno1:3306”上创建InnoDB集群“test Cluster”…<br/>添加种子实例… <br/>集群已成功创建。使用Cluster.addInstance()添加MySQL实例。<br/>集群至少需要3个实例才能承受一个服务器故障。</strong></p></blockquote><p id="aed6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">要添加新实例:</p><blockquote class="jm jn jo"><p id="d50b" class="if ig jp ih b ii ij ik il im in io ip jq ir is it jr iv iw ix js iz ja jb jc hb bi translated"><strong class="ih hj">cluster . add instance(' root @ inno 2:3306 ')<br/>cluster . add instance(' root @ inno 3:3306 ')</strong></p></blockquote><p id="ec82" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">由于前面提到的MySQL版本(8.0.23 ),我得到了类似于2号实例(inno2)的输出:</p><blockquote class="jm jn jo"><p id="9ef0" class="if ig jp ih b ii ij ik il im in io ip jq ir is it jr iv iw ix js iz ja jb jc hb bi translated"><strong class="ih hj">验证inno2:3306处的实例… <br/>该实例报告其自己的地址，因为inno2:3306 <br/>实例配置是合适的。<br/>一个新实例将被添加到InnoDB集群中。根据集群上的<br/>数据量，这可能需要几秒到几个小时。<br/>将实例添加到集群… <br/>监视新集群成员的恢复过程。按下^C停止监测，让它继续在后台。<br/>基于克隆的状态恢复正在进行中。<br/>注意:服务器重启是克隆过程的一部分。如果<br/>服务器不支持重启命令或者在<br/>一段时间后没有恢复，您可能需要手动重启。<br/> *等待克隆完成… <br/>注:inno2:3306正在从inno1:3306克隆<br/>* * Stage DROP DATA:Completed<br/>* *克隆传输<br/>文件复制########### # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # 100%完成<br/>页面复制# # # # # # # # # # # 正在等待克隆完成… <br/> **阶段重新启动:已完成<br/> *克隆过程已完成:在38秒内传输了1.2 GB(30.26 MB/s)<br/>已完成“inno2:3306”的状态恢复<br/>实例“inno2:3306”已成功添加到群集</strong></p></blockquote><p id="c9f5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为了检查集群的状态，我们使用cluster.status()</p><blockquote class="jm jn jo"><p id="99de" class="if ig jp ih b ii ij ik il im in io ip jq ir is it jr iv iw ix js iz ja jb jc hb bi translated"><strong class="ih hj">JS&gt;Cluster . status()<br/>{<br/>" Cluster name ":" myinnocluster "，<br/>" defaultReplicaSet ":{<br/>" name ":" default "，<br/> "primary": "inno1:3306 "，<br/> "ssl": "REQUIRED "，<br/> "status": "OK "，<br/> "statusText ":"集群在线，最多可以容忍一个故障。"、<br/>"拓扑":{ <br/> "inno1:3306": { <br/>"地址":" inno1:3306 "、<br/>"模式":" R/W "、<br/> "readReplicas": {}、<br/> "replicationLag": null、<br/> "role": "HA "、<br/> "status": "ONLINE "，<br/> "version": "8.0.23" <br/> }、"</strong></p></blockquote><p id="085f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们可以设置一个新的主实例:</p><blockquote class="jm jn jo"><p id="c3c9" class="if ig jp ih b ii ij ik il im in io ip jq ir is it jr iv iw ix js iz ja jb jc hb bi translated"><strong class="ih hj">JS&gt;cluster . setprimaryinstance(" inno2 ")<br/>将实例' inno 2 '设置为集群' myinnocluster '的主实例……</strong></p><p id="cd8a" class="if ig jp ih b ii ij ik il im in io ip jq ir is it jr iv iw ix js iz ja jb jc hb bi translated"><strong class="ih hj">实例‘inno 3:3306’仍然是次要的。<br/>实例‘inno 1:3306’已从主实例切换到辅助实例。<br/>实例‘inno 2:3306’已从辅助节点切换到主节点。</strong></p><p id="21ab" class="if ig jp ih b ii ij ik il im in io ip jq ir is it jr iv iw ix js iz ja jb jc hb bi translated"><strong class="ih hj">警告:集群内部会话不再是主要成员。对于集群管理操作，请使用dba.getCluster()获取新的集群句柄。</strong></p><p id="770d" class="if ig jp ih b ii ij ik il im in io ip jq ir is it jr iv iw ix js iz ja jb jc hb bi translated"><strong class="ih hj">实例“inno2”成功当选为主实例。</strong></p></blockquote><p id="7b4b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">再次检查状态:</p><blockquote class="jm jn jo"><p id="bdbc" class="if ig jp ih b ii ij ik il im in io ip jq ir is it jr iv iw ix js iz ja jb jc hb bi translated"><strong class="ih hj">JS&gt;Cluster . status()<br/>{<br/>" Cluster name ":" myinnocluster "，<br/>" defaultReplicaSet ":{<br/>" name ":" default "，<br/> "primary": "inno2:3306 "，<br/> "ssl": "REQUIRED "，<br/> "status": "OK "，<br/> "statusText ":"集群在线，最多可以容忍一个故障、<br/>"拓扑":{ <br/> "inno1:3306": { <br/>"地址":" inno1:3306 "、<br/>"模式":" R/O "、<br/> "readReplicas": {}、<br/> "replicationLag": null、<br/> "role": "HA "、<br/> "status": "ONLINE "，<br/> "version": "8.0。</strong></p></blockquote><p id="d188" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们可以为每个数据库实例设置memberweight参数，以指示发生故障转移时应该如何进行主要选择。</p><blockquote class="jm jn jo"><p id="7cca" class="if ig jp ih b ii ij ik il im in io ip jq ir is it jr iv iw ix js iz ja jb jc hb bi translated"><strong class="ih hj">cluster . setinstanceoption(" inno 1:3306 "，" memberWeight "，100)<br/>cluster . setinstanceoption(" inno 2:3306 "，" memberWeight "，50)<br/>cluster . setinstanceoption(" inno 3:3306 "，" memberWeight "，25) </strong></p></blockquote><p id="7bbe" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为了查看当我在inno2数据库服务器上重新启动mysqld服务时，集群是否能够成功进行故障转移:</p><blockquote class="jm jn jo"><p id="6fa3" class="if ig jp ih b ii ij ik il im in io ip jq ir is it jr iv iw ix js iz ja jb jc hb bi translated"><strong class="ih hj">JS&gt;Cluster . status()<br/>{<br/>" Cluster name ":" myinnocluster "，<br/>" defaultReplicaSet ":{<br/>" name ":" default "，<br/> "primary": "inno1:3306 "，<br/> "ssl": "REQUIRED "，<br/> "status": "OK "，<br/> "statusText ":"集群在线，最多可以容忍一个故障。1个成员不活动。、<br/>"拓扑":{ <br/> "inno1:3306": { <br/>"地址":" inno1:3306 "、<br/>"模式":" R/W "、<br/> "readReplicas": {}、<br/> "replicationLag": null、<br/> "role": "HA "、<br/> "status": "ONLINE "、<br/> "version": "8.0.23" <br/> }、<br/></strong></p></blockquote><p id="4a2b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们可以看到，由于优先级inno1被选为我们新的主实例。</p><p id="1c6f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">群集完成恢复过程后:</p><blockquote class="jm jn jo"><p id="c631" class="if ig jp ih b ii ij ik il im in io ip jq ir is it jr iv iw ix js iz ja jb jc hb bi translated"><strong class="ih hj">JS&gt;Cluster . status()<br/>{<br/>" Cluster name ":" myinnocluster "，<br/>" defaultReplicaSet ":{<br/>" name ":" default "，<br/> "primary": "inno1:3306 "，<br/> "ssl": "REQUIRED "，<br/> "status": "OK "，<br/> "statusText ":"集群在线，最多可以容忍一个故障。1个成员不活动。、<br/>"拓扑":{ <br/> "inno1:3306": { <br/>"地址":" inno1:3306 "、<br/>"模式":" R/W "、<br/> "readReplicas": {}、<br/> "replicationLag": null、<br/> "role": "HA "、<br/> "status": "ONLINE "、<br/> "version": "8.0.23 "【中</strong></p></blockquote><p id="2f4e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">下一部分是配置MySQL路由器。我说路由器是因为我们的设置与MySQL推荐的不同。MySQL建议最好在应用服务器上设置mysqlrouter，以便使用套接字连接。<br/>但是在企业环境中，我们无法访问我们的应用服务器，也无权管理应用服务器。</p><p id="5cab" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这就是为什么我们通过虚拟IP配置2个mysqlrouter来加强我们高可用性架构。</p><p id="c608" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们需要安装keepalive，以便在两台mysqlrouter服务器上配置虚拟IP:</p><blockquote class="jm jn jo"><p id="6ee9" class="if ig jp ih b ii ij ik il im in io ip jq ir is it jr iv iw ix js iz ja jb jc hb bi translated"><strong class="ih hj">百胜安装keepalived </strong></p></blockquote><p id="4db1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">安装后，我们可以将第一个节点配置为主节点:</p><p id="4d09" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我得到了原始keepalived配置文件的副本:</p><blockquote class="jm jn jo"><p id="f6d1" class="if ig jp ih b ii ij ik il im in io ip jq ir is it jr iv iw ix js iz ja jb jc hb bi translated"><strong class="ih hj">CD/etc/keepalived/<br/>CP keepalived . conf keepalived . conf _ bck<br/>&gt;keepalived . conf<br/>VI keepalived . conf</strong></p></blockquote><p id="0449" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我在文件中添加了以下配置:</p><blockquote class="jm jn jo"><p id="8a5a" class="if ig jp ih b ii ij ik il im in io ip jq ir is it jr iv iw ix js iz ja jb jc hb bi translated"><strong class="ih hj">！保持激活的配置文件</strong></p><p id="b528" class="if ig jp ih b ii ij ik il im in io ip jq ir is it jr iv iw ix js iz ja jb jc hb bi translated"><strong class="ih hj">global _ defs {<br/>notification _ email {<br/></strong><a class="ae kf" href="mailto:root@mydomain.com" rel="noopener ugc nofollow" target="_blank"><strong class="ih hj">root@mydomain.com</strong></a><strong class="ih hj"><br/>}<br/>notification _ email _ from</strong><a class="ae kf" href="mailto:svr1@mydomain.com" rel="noopener ugc nofollow" target="_blank"><strong class="ih hj">svr1@mydomain.com</strong></a><strong class="ih hj"><br/>SMTP _ server localhost<br/>SMTP _ connect _ time out 30<br/>}</strong></p><p id="c726" class="if ig jp ih b ii ij ik il im in io ip jq ir is it jr iv iw ix js iz ja jb jc hb bi translated"><strong class="ih hj"> vrrp_instance VI_1 { <br/>状态主<br/>接口ens 192<br/>virtual _ router _ id 41<br/>优先级200 <br/> advert_int 1 <br/>认证{<br/>auth _ type PASS<br/>auth _ PASS 1066<br/>}<br/>virtual _ IP address {<br/>your _ virtual _ IP _ address<br/>}<br/>}</strong></p></blockquote><p id="5f99" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后，我对第二个实例做了一些更改，因为第二个实例将是备份实例:</p><p id="39f1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">global _ defs {<br/>notification _ email {<br/></strong><a class="ae kf" href="mailto:root@mydomain.com" rel="noopener ugc nofollow" target="_blank"><strong class="ih hj">root@mydomain.com</strong></a><strong class="ih hj"><br/>}<br/>notification _ email _ from</strong><a class="ae kf" href="mailto:svr2@mydomain.com" rel="noopener ugc nofollow" target="_blank"><strong class="ih hj">svr2@mydomain.com</strong></a><strong class="ih hj"><br/>SMTP _ server localhost<br/>SMTP _ connect _ time out 30<br/>}</strong></p><p id="e727" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> vrrp_instance VRRP1 { <br/>状态备份<br/> #指定分配了虚拟地址的网络接口<br/>接口ens 192<br/>virtual _ router _ id 41<br/>#将备份服务器上的优先级值设置为低于主服务器上的优先级值<br/>优先级100 <br/> advert_int 1 <br/>身份验证{<br/>auth _ type PASS<br/>auth _ auth</strong></p><p id="6f64" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们检查keepalived服务！</p><p id="9fb2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在mysqlrouter1上:</p><blockquote class="jm jn jo"><p id="3fed" class="if ig jp ih b ii ij ik il im in io ip jq ir is it jr iv iw ix js iz ja jb jc hb bi translated"><strong class="ih hj"> systemctl状态keepalived<br/>●keepalived . service—LVS和VRRP高可用性监视器<br/>Loaded:Loaded(/usr/lib/systemd/system/keepalived . service；已启用；厂商预置:禁用)<br/>活跃:活跃(运行中)自周四2021–05–06 12:09:23+03；12s前<br/>进程:10535 execstart =/usr/sbin/keepalived $ keepalived _ options(code = exited，status=0/SUCCESS) <br/>主PID: 10538 (keepalived) <br/>任务:2<br/>c group:/system . slice/keepalived . service<br/>├─10538/usr/sbin/keepalived-d<br/>└─10539/usr/sbin/keepalived-d</strong></p><p id="8e61" class="if ig jp ih b ii ij ik il im in io ip jq ir is it jr iv iw ix js iz ja jb jc hb bi translated"><strong class="ih hj">5月06日12:09:26 MySQL router 1 Keepalived _ vrrp[10539]:在ens192上为your_virtual_ip_address发送免费ARP<br/>5月06日12:09:26 MySQL router 1 Keepalived _ vrrp[10539]:在ens192上为your_virtual_ip_address发送免费ARP<br/>5月06日12:09:26 MySQL router 1 Keepalived _ 26 在ens192上为your_virtual_ip_address发送/排队免费ARP<br/>May 06 12:09:31 MySQL router 1 Keepalived _ vrrp【10539】:在ens192上为your_virtual_ip_address发送免费ARP<br/>May 06 12:09:31 MySQL router 1 Keepalived _ vrrp【10539】:在ens192上为your_virtual_ip_address发送免费ARP【T19</strong></p></blockquote><p id="7bc1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在mysqlrouter2上:</p><blockquote class="jm jn jo"><p id="40c8" class="if ig jp ih b ii ij ik il im in io ip jq ir is it jr iv iw ix js iz ja jb jc hb bi translated"><strong class="ih hj"> systemctl状态keepalived<br/>●keepalived . service—LVS和VRRP高可用性监视器<br/>Loaded:Loaded(/usr/lib/systemd/system/keepalived . service；已启用；厂商预置:禁用)<br/>活跃:活跃(运行中)自周二2021–04–27 15:26:07+03；1周1天前<br/>主PID: 763 (keepalived) <br/>任务:2(限制:12438) <br/>内存:6.8m<br/>c group:/system . slice/keepalived . service<br/>├─763/usr/sbin/keepalived-d<br/>└─764/usr/sbin/keepalived-d</strong></p><p id="bde4" class="if ig jp ih b ii ij ik il im in io ip jq ir is it jr iv iw ix js iz ja jb jc hb bi translated">4月27日19:16:13 MySQL router 2 Keepalived _ vrrp[764]:在ens192上为your_virtual_ip_address发送免费ARP<br/>:4月27日19:16:18 MySQL router 2 Keepalived _ vrrp[764]:在ens192上为your_virtual_ip_address发送免费ARP<br/> 在ens192上为your_virtual_ip_address发送/排队免费ARP<br/>4月27日19:16:18 MySQL router 2 Keepalived _ vrrp【764】:在ens192上为your_virtual_ip_address发送免费ARP<br/>4月27日19:16:18 MySQL router 2 Keepalived _ vrrp【764】:在ens192上为your_virtual_ip_address发送免费ARP<br/>4月27日19: </p></blockquote><p id="a7d1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一切就绪，我们可以配置MySQL路由器了:</p><blockquote class="jm jn jo"><p id="a00b" class="if ig jp ih b ii ij ik il im in io ip jq ir is it jr iv iw ix js iz ja jb jc hb bi translated"><strong class="ih hj">MySQL router—bootstrap root @ MySQL _ cluster _ rw _ node:3306—directory/var/lib/my router—conf-bind-address 0 . 0 . 0 . 0—conf-base-port 3307-u = MySQL router</strong></p></blockquote><p id="da69" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们讨论一下用于引导mysqlrouter的参数。</p><p id="533a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用“-u mysqlrouter”参数，我们表示用户mysqlrouter启动服务。</p><p id="369f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用“--conf-bind-address 0 . 0 . 0 . 0”参数，我们的服务将监听这台机器上的每个网络接口。我们可以设置我们的虚拟IP，但是有一个问题。<br/>因为，在备份节点上mysqlrouter服务不起作用。虚拟IP一次只能在一台路由器服务器上处于活动状态。因此，对于备份服务器(如果两个mysqlrouter服务器上的keepalived服务<br/>都成功运行),它没有要监听的虚拟IP，因此不会启动mysqlrouter服务。这就是为什么我们使用“0.0.0.0”</p><p id="b9e7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用“--directory/var/lib/my router”参数，我们的意思是mysqlrouter将存储它的配置文件。</p><p id="1ed2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">稍后我们将讨论“— conf-base-port 3307”参数。</p><p id="e011" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">输出:</p><blockquote class="jm jn jo"><p id="63a6" class="if ig jp ih b ii ij ik il im in io ip jq ir is it jr iv iw ix js iz ja jb jc hb bi translated"><strong class="ih hj">请为dba输入MySQL密码:<br/> #在“/var/lib/my Router”…</strong>重新配置MySQL路由器实例</p><p id="95cf" class="if ig jp ih b ii ij ik il im in io ip jq ir is it jr iv iw ix js iz ja jb jc hb bi translated"><strong class="ih hj"> -从密匙环<br/>中获取当前帐户(mysql_router22_bi1dzf4jbgp2)的密码执行语句失败:“执行mysql查询时出错”插入MySQL _ innodb _ Cluster _ metadata . v2 _ routers(address，product_name，router_name)值(' mysqlrouter1 '，' ')”):MySQL服务器正在使用-super-read-only选项运行，因此它无法执行此语句(1290)' (1290) 如果有)<br/> -使用“/var/lib/myrouter/data”目录中的现有证书<br/> -验证帐户(使用它来运行将由路由器运行的SQL查询)<br/> -将帐户存储在密匙环中<br/> -调整所生成文件的权限<br/> -创建配置/var/lib/my Router/MySQL Router . conf</strong></p><p id="d6ca" class="if ig jp ih b ii ij ik il im in io ip jq ir is it jr iv iw ix js iz ja jb jc hb bi translated"><strong class="ih hj"> #为InnoDB集群“myinnocluster”配置的MySQL路由器</strong></p><p id="23dc" class="if ig jp ih b ii ij ik il im in io ip jq ir is it jr iv iw ix js iz ja jb jc hb bi translated"><strong class="ih hj">使用生成的配置启动MySQL路由器后</strong></p><p id="15b3" class="if ig jp ih b ii ij ik il im in io ip jq ir is it jr iv iw ix js iz ja jb jc hb bi translated"><strong class="ih hj">$ MySQL router-c/var/lib/my router/MySQL router . conf</strong></p><p id="935c" class="if ig jp ih b ii ij ik il im in io ip jq ir is it jr iv iw ix js iz ja jb jc hb bi translated"><strong class="ih hj">集群“myinnocluster”可以通过连接到:</strong>来访问</p><p id="ba20" class="if ig jp ih b ii ij ik il im in io ip jq ir is it jr iv iw ix js iz ja jb jc hb bi translated"><strong class="ih hj"> ## MySQL经典协议</strong></p><p id="1733" class="if ig jp ih b ii ij ik il im in io ip jq ir is it jr iv iw ix js iz ja jb jc hb bi translated"><strong class="ih hj"> -读/写连接:本地主机:3307 <br/> -只读连接:本地主机:3308 </strong></p><p id="64bb" class="if ig jp ih b ii ij ik il im in io ip jq ir is it jr iv iw ix js iz ja jb jc hb bi translated"><strong class="ih hj"> ## MySQL X协议</strong></p><p id="f569" class="if ig jp ih b ii ij ik il im in io ip jq ir is it jr iv iw ix js iz ja jb jc hb bi translated"><strong class="ih hj"> -读/写连接:本地主机:3309 <br/> -只读连接:本地主机:3310 </strong></p></blockquote><p id="a90d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在使用命令“<strong class="ih hj"> mysqlrouter — bootstrap … </strong>”配置mysqlrouter实例之后，我们使用/var/lib/myrouter/start.sh启动mysqlrouter。</p><blockquote class="jm jn jo"><p id="0361" class="if ig jp ih b ii ij ik il im in io ip jq ir is it jr iv iw ix js iz ja jb jc hb bi translated"><strong class="ih hj">/var/lib/my router/start . sh</strong><br/><strong class="ih hj">日志记录工具初始化，将日志记录切换到配置</strong>中指定的记录器</p></blockquote><p id="c530" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，我们可以将我们的VIP用作主机名，将3307用作读/写连接的端口<br/>，将我们的VIP用作主机名，将3308用作只读连接的端口。</p><p id="9796" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这没问题，但是mysqlrouter不是服务。因此，在mysqlrouter服务器重启后，它不会自动运行(至少在我们提供的配置下)。</p><p id="74ed" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们还需要配置mysqlroute服务。在两台mysqlrouter服务器上:</p><blockquote class="jm jn jo"><p id="fc7d" class="if ig jp ih b ii ij ik il im in io ip jq ir is it jr iv iw ix js iz ja jb jc hb bi translated"><strong class="ih hj">VI/etc/systemd/system/MySQL router . service</strong></p></blockquote><p id="a116" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">将线放在下面:</p><blockquote class="jm jn jo"><p id="7250" class="if ig jp ih b ii ij ik il im in io ip jq ir is it jr iv iw ix js iz ja jb jc hb bi translated"><strong class="ih hj">描述=MySQL路由器<br/>After = network . target<br/>After = syslog . target</strong></p><p id="cfca" class="if ig jp ih b ii ij ik il im in io ip jq ir is it jr iv iw ix js iz ja jb jc hb bi translated"><strong class="ih hj">【服务】<br/>类型=通知<br/>用户=mysqlrouter <br/>组=mysqlrouter </strong></p><p id="9f26" class="if ig jp ih b ii ij ik il im in io ip jq ir is it jr iv iw ix js iz ja jb jc hb bi translated"><strong class="ih hj"> #启动主服务<br/>ExecStart =/usr/bin/MySQL router-c/var/lib/my router/MySQL router . conf</strong></p><p id="ac6e" class="if ig jp ih b ii ij ik il im in io ip jq ir is it jr iv iw ix js iz ja jb jc hb bi translated"><strong class="ih hj"> #设置打开文件限制<br/>限制文件= 10000 </strong></p><p id="5a38" class="if ig jp ih b ii ij ik il im in io ip jq ir is it jr iv iw ix js iz ja jb jc hb bi translated"><strong class="ih hj">重启=开-故障</strong></p><p id="ca4a" class="if ig jp ih b ii ij ik il im in io ip jq ir is it jr iv iw ix js iz ja jb jc hb bi translated"><strong class="ih hj">【安装】<br/>wanted by =多用户.目标</strong></p></blockquote><p id="e9f1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后，</p><blockquote class="jm jn jo"><p id="5bbb" class="if ig jp ih b ii ij ik il im in io ip jq ir is it jr iv iw ix js iz ja jb jc hb bi translated"><strong class="ih hj"> systemctl守护进程-重载<br/>system CTL enable MySQL router . service<br/>system CTL start MySQL router . service</strong></p><p id="7901" class="if ig jp ih b ii ij ik il im in io ip jq ir is it jr iv iw ix js iz ja jb jc hb bi translated"><strong class="ih hj">苏— mysqlrouter </strong></p><p id="000b" class="if ig jp ih b ii ij ik il im in io ip jq ir is it jr iv iw ix js iz ja jb jc hb bi translated"><strong class="ih hj"> systemctl状态MySQL router . service<br/>●MySQL router . service<br/>Loaded:Loaded(/etc/systemd/system/MySQL router . service；已启用；厂商预置:禁用)<br/>活动:活动(运行)自周四2021–05–06 13:31:18+03；9s前<br/>主PID: 12768 (mysqlrouter) <br/>任务:25<br/>c group:/system . slice/MySQL router . service<br/>└─12768/usr/bin/MySQL router-c/tmp/my router/MySQL router . conf</strong></p></blockquote><p id="b7cd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果您想以root或任何其他用户的身份启动mysqlrouter服务，除了mysqlrouter，您需要做一些小的更改。<br/>我们必须注释掉用户和组参数，如:</p><blockquote class="jm jn jo"><p id="330e" class="if ig jp ih b ii ij ik il im in io ip jq ir is it jr iv iw ix js iz ja jb jc hb bi translated"><strong class="ih hj">【服务】<br/>Type =通知<br/># User = MySQL router<br/># Group = MySQL router</strong></p></blockquote><p id="3994" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，我们也可以以root用户身份启动mysqlrouter服务。</p><p id="68dd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">感谢阅读:)。</p></div></div>    
</body>
</html>