<html>
<head>
<title>MLOps-Calculate Memory Consumption of Python Code</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">计算Python代码的内存消耗</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/calculate-memory-consumption-of-python-code-2a38c274dab4?source=collection_archive---------0-----------------------#2021-12-15">https://medium.com/analytics-vidhya/calculate-memory-consumption-of-python-code-2a38c274dab4?source=collection_archive---------0-----------------------#2021-12-15</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="4ed6" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">Python开发人员应该意识到他们正在编写的代码的内存消耗。这将在多个方面有所帮助。无论是决定硬件还是决定优化的需求或者查找内存泄漏等等。</p><p id="54ea" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我们将讨论一个非常简单但非常有用的python库memory_profiler。</p><pre class="jc jd je jf fd jg jh ji jj aw jk bi"><span id="0d47" class="jl jm hh jh b fi jn jo l jp jq">pip install memory_profiler#Load its magic function<br/>%load_ext memory_profiler<br/>from memory_profiler import profile</span></pre><p id="ae15" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我们可以想象以下列方式使用内存分析器:<br/> 1。求一行的内存消耗<br/> 2。求一个函数的内存消耗<br/> 3。逐行查找一个函数的内存消耗<br/> 4。查找完整python脚本的内存消耗</p><p id="6729" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">现在，让我们讨论所有这些场景</p><ol class=""><li id="1dd1" class="jr js hh ig b ih ii il im ip jt it ju ix jv jb jw jx jy jz bi translated">找出一行的内存消耗</li></ol><p id="aaed" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">只需在行首添加神奇函数%memit</p><pre class="jc jd je jf fd jg jh ji jj aw jk bi"><span id="4444" class="jl jm hh jh b fi jn jo l jp jq">%memit x = 10+5<br/>#Output<br/>peak memory: 54.01 MiB, increment: 0.27 MiB</span></pre><p id="e566" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这里，峰值内存是运行这段代码的进程消耗的内存。增量只不过是由于添加这行代码而需要/消耗的内存。同样的逻辑也适用于以下选项。</p><p id="cd33" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">2.查找函数的内存消耗</p><p id="52c9" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在调用函数的行首添加神奇函数。</p><pre class="jc jd je jf fd jg jh ji jj aw jk bi"><span id="b96f" class="jl jm hh jh b fi jn jo l jp jq">def addition():<br/>    a = [1] * (10 ** 1)<br/>    b = [2] * (3 * 10 ** 2)<br/>    sum = a+b<br/>    return sum%memit addition()<br/>#Output<br/>peak memory: 36.36 MiB, increment: 0.01 MiB</span></pre><p id="7706" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">3.逐行查找函数的内存消耗</p><p id="aade" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">对于内存使用的逐行描述，我们可以使用@profile装饰器。不幸的是，这只适用于单独模块中定义的函数，而不适用于笔记本本身，所以我们将从使用% %文件魔术创建一个名为demo.py的简单模块开始，该模块包含我们的函数</p><pre class="jc jd je jf fd jg jh ji jj aw jk bi"><span id="22d1" class="jl jm hh jh b fi jn jo l jp jq">%%file demo.py<br/>from memory_profiler import profile<br/><a class="ae ka" href="http://twitter.com/profile" rel="noopener ugc nofollow" target="_blank">@profile</a><br/>def addition():<br/>    a = [1] * (10 ** 1)<br/>    b = [2] * (3 * 10 ** 2)<br/>    sum = a+b<br/>    return sum</span></pre><p id="62a0" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">现在，调用与选项2中相同的函数。</p><pre class="jc jd je jf fd jg jh ji jj aw jk bi"><span id="32be" class="jl jm hh jh b fi jn jo l jp jq">from demo import addition<br/>%memit addition()#Output<br/></span><span id="d949" class="jl jm hh jh b fi kb jo l jp jq">Line #    Mem usage    Increment   Line Contents<br/>================================================<br/>     2     36.4 MiB     36.4 MiB   @profile<br/>     3                             def addition():<br/>     4     36.4 MiB      0.0 MiB       a = [1] * (10 ** 1)<br/>     5   3851.1 MiB   3814.7 MiB       b = [2] * (3 * 10 ** 2)<br/>     6   7665.9 MiB   3814.8 MiB       sum = a+b<br/>     7   7665.9 MiB      0.0 MiB       return sum<br/></span><span id="99e8" class="jl jm hh jh b fi kb jo l jp jq">peak memory: 7665.88 MiB, increment: 7629.52 MiB</span></pre><p id="8dcc" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">4.查找完整python脚本的内存消耗</p><p id="c8ed" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这个选项不能在笔记本上尝试。我们必须创建一个python脚本，并通过命令行运行它。</p><pre class="jc jd je jf fd jg jh ji jj aw jk bi"><span id="4fe2" class="jl jm hh jh b fi jn jo l jp jq">#create script.py<br/>import time<a class="ae ka" href="http://twitter.com/profile" rel="noopener ugc nofollow" target="_blank">@profile</a><br/>def function1():<br/>    n = 100000<br/>    a = [1] * n<br/>    time.sleep(1)<br/>    return a<a class="ae ka" href="http://twitter.com/profile" rel="noopener ugc nofollow" target="_blank">@profile</a><br/>def function2():<br/>    n = 200000<br/>    b = [1] * n<br/>    time.sleep(1)<br/>    return bif __name__ == "__main__":<br/>    function1()<br/>    function2()</span></pre><p id="a6d8" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">之后运行脚本，看看情节</p><pre class="jc jd je jf fd jg jh ji jj aw jk bi"><span id="ad48" class="jl jm hh jh b fi jn jo l jp jq">#On command line<br/>mprof run script.py<br/>#To generate plot <br/>mprof plot</span></pre><p id="fa8d" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我们可以看到内存消耗与时间的关系图</p><figure class="jc jd je jf fd kd er es paragraph-image"><div role="button" tabindex="0" class="ke kf di kg bf kh"><div class="er es kc"><img src="../Images/767bd60815967b9f298cda5fc2b1fec4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*l3-8RzdLkdQwOHNE.png"/></div></div></figure><p id="7624" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">时间与记忆</p><p id="fe7d" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">请注意，没有必要将@profile decorator放在函数之上，如果我们不保留它，我们不会看到函数级的内存消耗，但是我们会看到整个脚本的消耗</p><figure class="jc jd je jf fd kd er es paragraph-image"><div role="button" tabindex="0" class="ke kf di kg bf kh"><div class="er es kc"><img src="../Images/dd42bc921b431dd917aa3938ef8e9f63.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*GTGvm4QeDqWcXW0A.png"/></div></div></figure></div><div class="ab cl kk kl go km" role="separator"><span class="kn bw bk ko kp kq"/><span class="kn bw bk ko kp kq"/><span class="kn bw bk ko kp"/></div><div class="ha hb hc hd he"><p id="11ce" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">完整的代码可以在<a class="ae ka" href="https://github.com/sarang0909/Memory-Profiler" rel="noopener ugc nofollow" target="_blank"> git-hub </a>获得</p><p id="8a44" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">如果你喜欢这篇文章或有任何建议/意见，请在下面分享！</p><p id="ce42" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在<a class="ae ka" href="https://www.linkedin.com/in/sarang-mete-6797065a/" rel="noopener ugc nofollow" target="_blank"> LinkedIn </a>上联系讨论吧</p></div></div>    
</body>
</html>