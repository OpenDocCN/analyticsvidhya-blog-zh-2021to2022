<html>
<head>
<title>Getting started with Airflow</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">气流入门</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/getting-started-with-airflow-b0042cae3ebf?source=collection_archive---------0-----------------------#2021-09-19">https://medium.com/analytics-vidhya/getting-started-with-airflow-b0042cae3ebf?source=collection_archive---------0-----------------------#2021-09-19</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="dd87" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">如何使用BashOperator、PythonOperator和MySqlOperator在Linux机器上设置气流并创建基本工作流</h2></div><figure class="jg jh ji jj fd jk er es paragraph-image"><div role="button" tabindex="0" class="jl jm di jn bf jo"><div class="er es jf"><img src="../Images/3ca30cddd169c030c3a8d575b9eb5598.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*w7Au4jryam2w_-cP"/></div></div><figcaption class="jr js et er es jt ju bd b be z dx translated">由<a class="ae jv" href="https://unsplash.com/@alvarordesign?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">阿尔瓦罗·雷耶斯</a>在<a class="ae jv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><div class="jw jx ez fb jy jz"><a href="https://airflow.apache.org/" rel="noopener  ugc nofollow" target="_blank"><div class="ka ab dw"><div class="kb ab kc cl cj kd"><h2 class="bd hj fi z dy ke ea eb kf ed ef hh bi translated">主页</h2><div class="kg l"><h3 class="bd b fi z dy ke ea eb kf ed ef dx translated">没有更多的命令行或XML魔术！使用标准Python功能创建工作流，包括日期时间…</h3></div><div class="kh l"><p class="bd b fp z dy ke ea eb kf ed ef dx translated">airflow.apache.org</p></div></div><div class="ki l"><div class="kj l kk kl km ki kn jp jz"/></div></div></a></div><blockquote class="ko kp kq"><p id="e433" class="kr ks kt ku b kv kw ij kx ky kz im la lb lc ld le lf lg lh li lj lk ll lm ln hb bi translated">Airflow是一个由社区创建的平台，用于以编程方式创作、安排和监控工作流。</p></blockquote><p id="9a53" class="pw-post-body-paragraph kr ks hi ku b kv kw ij kx ky kz im la lo lc ld le lp lg lh li lq lk ll lm ln hb bi translated">在部署和监控工作流时，Airflow是一个强大的工具。它使用标准的Python特性来创建工作流，包括用于调度的日期时间格式和用于动态生成任务的循环。这使得在构建工作流时很容易保持充分的灵活性。</p><p id="795a" class="pw-post-body-paragraph kr ks hi ku b kv kw ij kx ky kz im la lo lc ld le lp lg lh li lq lk ll lm ln hb bi translated">它还附带了一个非常易于使用的UI，并提供了许多即插即用的操作器，可以随时在SQL Servers、GCP、AWS和许多其他第三方服务上执行任务。</p></div><div class="ab cl lr ls gp lt" role="separator"><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw"/></div><div class="hb hc hd he hf"><p id="ed45" class="pw-post-body-paragraph kr ks hi ku b kv kw ij kx ky kz im la lo lc ld le lp lg lh li lq lk ll lm ln hb bi translated">下面的文章将给出一个在Linux机器上安装和使用气流的演练。我在一台Windows 10笔记本电脑上通过WSL使用了<strong class="ku hj"> Ubuntu 20.04 </strong>，尽管这些步骤可以在任何基于Linux的机器上运行。<strong class="ku hj">气流2.1.3 </strong>和<strong class="ku hj"> Python 3.8.10 </strong>已用于此设置。</p></div><div class="ab cl lr ls gp lt" role="separator"><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw"/></div><div class="hb hc hd he hf"><h1 id="08e1" class="ly lz hi bd ma mb mc md me mf mg mh mi io mj ip mk ir ml is mm iu mn iv mo mp bi translated">检查Python安装</h1><p id="fcd3" class="pw-post-body-paragraph kr ks hi ku b kv mq ij kx ky mr im la lo ms ld le lp mt lh li lq mu ll lm ln hb bi translated">确保您已经在机器上安装了Python。运行下面的命令查看Python的版本。</p><pre class="jg jh ji jj fd mv mw mx my aw mz bi"><span id="6a9b" class="na lz hi mw b fi nb nc l nd ne">python3 --version</span></pre><figure class="jg jh ji jj fd jk er es paragraph-image"><div class="er es nf"><img src="../Images/3edb3914f54b7a5346c0361b8ab4686a.png" data-original-src="https://miro.medium.com/v2/resize:fit:718/format:webp/1*TwsJFvnV4RDPiAYCb-PCyg.png"/></div><figcaption class="jr js et er es jt ju bd b be z dx translated">检查Python安装</figcaption></figure><p id="9de9" class="pw-post-body-paragraph kr ks hi ku b kv kw ij kx ky kz im la lo lc ld le lp lg lh li lq lk ll lm ln hb bi translated">你可以参考这里的文档来安装Python-<a class="ae jv" href="https://docs.python-guide.org/starting/install3/linux/" rel="noopener ugc nofollow" target="_blank">https://docs.python-guide.org/starting/install3/linux/</a></p><h2 id="2725" class="na lz hi bd ma ng nh ni me nj nk nl mi lo nm nn mk lp no np mm lq nq nr mo ns bi translated">安装pip</h2><p id="c9b9" class="pw-post-body-paragraph kr ks hi ku b kv mq ij kx ky mr im la lo ms ld le lp mt lh li lq mu ll lm ln hb bi translated">通过运行以下命令检查是否安装了pip:</p><pre class="jg jh ji jj fd mv mw mx my aw mz bi"><span id="28c7" class="na lz hi mw b fi nb nc l nd ne">pip --version</span></pre><p id="4182" class="pw-post-body-paragraph kr ks hi ku b kv kw ij kx ky kz im la lo lc ld le lp lg lh li lq lk ll lm ln hb bi translated">如果尚未安装，请使用以下方法安装:</p><pre class="jg jh ji jj fd mv mw mx my aw mz bi"><span id="c53d" class="na lz hi mw b fi nb nc l nd ne">sudo apt install python3-pip</span></pre><h1 id="a0fd" class="ly lz hi bd ma mb nt md me mf nu mh mi io nv ip mk ir nw is mm iu nx iv mo mp bi translated">安装气流</h1><p id="422c" class="pw-post-body-paragraph kr ks hi ku b kv mq ij kx ky mr im la lo ms ld le lp mt lh li lq mu ll lm ln hb bi translated">对于这个设置，我们将使用Airflow版本2.1.3。对1.10版的支持将于2021年6月结束，因此建议使用2版。</p><p id="6af4" class="pw-post-body-paragraph kr ks hi ku b kv kw ij kx ky kz im la lo lc ld le lp lg lh li lq lk ll lm ln hb bi translated"><strong class="ku hj">注意</strong>:本指南将气流直接安装到Python的基础环境中。如果您想将其安装在虚拟环境中，请使用<a class="ae jv" href="https://mothergeo-py.readthedocs.io/en/latest/development/how-to/venv.html" rel="noopener ugc nofollow" target="_blank"> venv </a>创建适当的环境，并在运行以下命令之前切换到该环境。</p><h2 id="ac53" class="na lz hi bd ma ng nh ni me nj nk nl mi lo nm nn mk lp no np mm lq nq nr mo ns bi translated">安装气流</h2><p id="f7ea" class="pw-post-body-paragraph kr ks hi ku b kv mq ij kx ky mr im la lo ms ld le lp mt lh li lq mu ll lm ln hb bi translated">Airflow需要一个主目录，默认为<em class="kt"> ~/airflow </em>，但是您可以将其设置为您选择的任何目录。您也可以在<em class="kt">中添加下面一行。bashrc </em>文件，所以它会在你每次打开终端时被设置。</p><pre class="jg jh ji jj fd mv mw mx my aw mz bi"><span id="8d79" class="na lz hi mw b fi nb nc l nd ne">export AIRFLOW_HOME=~/airflow</span></pre><p id="3d38" class="pw-post-body-paragraph kr ks hi ku b kv kw ij kx ky kz im la lo lc ld le lp lg lh li lq lk ll lm ln hb bi translated">为气流和Python版本设置变量。然后在<em class="kt"> pip </em>命令中使用它们来确保正确安装所有相应的依赖项。如果你直接运行<em class="kt">pip install Apache-air flow = = 2 . 1 . 3</em>可能会导致一些包版本的问题，比如SQLAlchemy。</p><pre class="jg jh ji jj fd mv mw mx my aw mz bi"><span id="a61f" class="na lz hi mw b fi nb nc l nd ne">AIRFLOW_VERSION=2.1.3</span><span id="f447" class="na lz hi mw b fi ny nc l nd ne">PYTHON_VERSION="$(python3 --version | cut -d " " -f 2 | cut -d "." -f 1-2)"</span><span id="4206" class="na lz hi mw b fi ny nc l nd ne">CONSTRAINT_URL="https://raw.githubusercontent.com/apache/airflow/constraints-${AIRFLOW_VERSION}/constraints-${PYTHON_VERSION}.txt"</span></pre><p id="f3c0" class="pw-post-body-paragraph kr ks hi ku b kv kw ij kx ky kz im la lo lc ld le lp lg lh li lq lk ll lm ln hb bi translated">对于我们的例子，变量<em class="kt"> PYTHON_VERSION </em>将被设置为3.8。</p><p id="3901" class="pw-post-body-paragraph kr ks hi ku b kv kw ij kx ky kz im la lo lc ld le lp lg lh li lq lk ll lm ln hb bi translated">现在，运行安装命令，该命令将使用上面设置的变量来使用我们的Python 3.8获得Airflow 2.1.3。</p><pre class="jg jh ji jj fd mv mw mx my aw mz bi"><span id="a30c" class="na lz hi mw b fi nb nc l nd ne">pip install "apache-airflow==${AIRFLOW_VERSION}" --constraint "${CONSTRAINT_URL}"</span></pre><h2 id="b480" class="na lz hi bd ma ng nh ni me nj nk nl mi lo nm nn mk lp no np mm lq nq nr mo ns bi translated">初始化气流数据库</h2><pre class="jg jh ji jj fd mv mw mx my aw mz bi"><span id="4b51" class="na lz hi mw b fi nb nc l nd ne">airflow db init</span></pre><h2 id="3dc6" class="na lz hi bd ma ng nh ni me nj nk nl mi lo nm nn mk lp no np mm lq nq nr mo ns bi translated">创建用户</h2><p id="1555" class="pw-post-body-paragraph kr ks hi ku b kv mq ij kx ky mr im la lo ms ld le lp mt lh li lq mu ll lm ln hb bi translated">使用以下命令创建登录Airflow WebUI的用户密码。如果希望多人使用，您可以添加多个用户，并赋予不同的用户权限。</p><p id="3f1b" class="pw-post-body-paragraph kr ks hi ku b kv kw ij kx ky kz im la lo lc ld le lp lg lh li lq lk ll lm ln hb bi translated"><strong class="ku hj">管理员</strong></p><p id="b8ba" class="pw-post-body-paragraph kr ks hi ku b kv kw ij kx ky kz im la lo lc ld le lp lg lh li lq lk ll lm ln hb bi translated">出现提示时，运行以下命令并设置密码。</p><pre class="jg jh ji jj fd mv mw mx my aw mz bi"><span id="420e" class="na lz hi mw b fi nb nc l nd ne">airflow users create \<br/>    --username admin \<br/>    --firstname Sherlock \<br/>    --lastname Holmes \<br/>    --role Admin \<br/>    --email sherlock@221-b-bakerstreet.org</span></pre><p id="8d5d" class="pw-post-body-paragraph kr ks hi ku b kv kw ij kx ky kz im la lo lc ld le lp lg lh li lq lk ll lm ln hb bi translated"><strong class="ku hj">用户</strong></p><pre class="jg jh ji jj fd mv mw mx my aw mz bi"><span id="4053" class="na lz hi mw b fi nb nc l nd ne">airflow users create \<br/>    --username jw \<br/>    --firstname James \<br/>    --lastname Watson \<br/>    --role User \<br/>    --email watson@221-b-bakerstreet.org</span></pre><blockquote class="ko kp kq"><p id="8e0e" class="kr ks kt ku b kv kw ij kx ky kz im la lb lc ld le lf lg lh li lj lk ll lm ln hb bi translated">N <strong class="ku hj">注意</strong>:具有“用户”角色的用户将对某些气流功能具有有限的访问权限。请以“管理员”的身份执行以下步骤。</p></blockquote><h2 id="9b60" class="na lz hi bd ma ng nh ni me nj nk nl mi lo nm nn mk lp no np mm lq nq nr mo ns bi translated">启动服务器</h2><p id="0856" class="pw-post-body-paragraph kr ks hi ku b kv mq ij kx ky mr im la lo ms ld le lp mt lh li lq mu ll lm ln hb bi translated">在终端中使用以下命令启动web服务器。根据需要更新端口值。</p><pre class="jg jh ji jj fd mv mw mx my aw mz bi"><span id="b573" class="na lz hi mw b fi nb nc l nd ne">airflow webserver --port 8080</span></pre><p id="0c67" class="pw-post-body-paragraph kr ks hi ku b kv kw ij kx ky kz im la lo lc ld le lp lg lh li lq lk ll lm ln hb bi translated">该终端必须保持开启，以便web服务器继续运行。</p><figure class="jg jh ji jj fd jk er es paragraph-image"><div role="button" tabindex="0" class="jl jm di jn bf jo"><div class="er es nz"><img src="../Images/6255ecc971e50b2aaa302846676efea2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JoeoNcHR9wtdFfqLhRXSvQ.png"/></div></div><figcaption class="jr js et er es jt ju bd b be z dx translated">正在启动web服务器</figcaption></figure><p id="587a" class="pw-post-body-paragraph kr ks hi ku b kv kw ij kx ky kz im la lo lc ld le lp lg lh li lq lk ll lm ln hb bi translated">导航到<em class="kt"> localhost:8080 </em>以访问WebUI。使用我们之前创建的用户名-密码登录。</p><figure class="jg jh ji jj fd jk er es paragraph-image"><div role="button" tabindex="0" class="jl jm di jn bf jo"><div class="er es oa"><img src="../Images/3d11394550ac2f957e47908d431689ea.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rnOlUdTa9y7i5_eLtsXt7w.png"/></div></div><figcaption class="jr js et er es jt ju bd b be z dx translated">WebUI登录页面</figcaption></figure><p id="63a4" class="pw-post-body-paragraph kr ks hi ku b kv kw ij kx ky kz im la lo lc ld le lp lg lh li lq lk ll lm ln hb bi translated">您将得到以下警告:</p><figure class="jg jh ji jj fd jk er es paragraph-image"><div role="button" tabindex="0" class="jl jm di jn bf jo"><div class="er es ob"><img src="../Images/40f3956761993f685f5b5e83e67e8f51.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qB-ixLruezu9gIf4jSUXFQ.png"/></div></div><figcaption class="jr js et er es jt ju bd b be z dx translated">调度程序警告</figcaption></figure><p id="99cb" class="pw-post-body-paragraph kr ks hi ku b kv kw ij kx ky kz im la lo lc ld le lp lg lh li lq lk ll lm ln hb bi translated"><strong class="ku hj">启动调度程序</strong></p><p id="ea72" class="pw-post-body-paragraph kr ks hi ku b kv kw ij kx ky kz im la lo lc ld le lp lg lh li lq lk ll lm ln hb bi translated">我们还必须在一个单独的终端中启动一个气流调度程序作业，该作业将跟踪DAG调度并按时运行它们。</p><pre class="jg jh ji jj fd mv mw mx my aw mz bi"><span id="d67f" class="na lz hi mw b fi nb nc l nd ne">airflow scheduler</span></pre><figure class="jg jh ji jj fd jk er es paragraph-image"><div role="button" tabindex="0" class="jl jm di jn bf jo"><div class="er es oc"><img src="../Images/636cbebe2102edc7950602be91e10d3f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*u5cIeAX3A4W3mtJO0VElew.png"/></div></div><figcaption class="jr js et er es jt ju bd b be z dx translated">气流调度程序</figcaption></figure></div><div class="ab cl lr ls gp lt" role="separator"><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw"/></div><div class="hb hc hd he hf"><h1 id="14c1" class="ly lz hi bd ma mb mc md me mf mg mh mi io mj ip mk ir ml is mm iu mn iv mo mp bi translated">更新配置</h1><p id="6f41" class="pw-post-body-paragraph kr ks hi ku b kv mq ij kx ky mr im la lo ms ld le lp mt lh li lq mu ll lm ln hb bi translated">气流配置保存在气流主目录下的airflow.cfg文件中。其中一些配置可以更新，使一些事情变得更容易。</p><p id="c0dd" class="pw-post-body-paragraph kr ks hi ku b kv kw ij kx ky kz im la lo lc ld le lp lg lh li lq lk ll lm ln hb bi translated">导航到airflow主目录:</p><pre class="jg jh ji jj fd mv mw mx my aw mz bi"><span id="d551" class="na lz hi mw b fi nb nc l nd ne">cd $AIRFLOW_HOME<br/>vim airflow.cfg</span></pre><h2 id="b75e" class="na lz hi bd ma ng nh ni me nj nk nl mi lo nm nn mk lp no np mm lq nq nr mo ns bi translated"><strong class="ak"> dag_dir_list_interval </strong></h2><pre class="jg jh ji jj fd mv mw mx my aw mz bi"><span id="04f0" class="na lz hi mw b fi nb nc l nd ne"># How often (in seconds) to scan the DAGs directory for new files. Default to 5 minutes.<br/>dag_dir_list_interval = 300</span></pre><p id="0e61" class="pw-post-body-paragraph kr ks hi ku b kv kw ij kx ky kz im la lo lc ld le lp lg lh li lq lk ll lm ln hb bi translated">配置中的该值决定了在WebUI上扫描和更新新添加的DAG文件的频率。默认值设置为5分钟，这意味着添加新的DAG后，您可能需要等待5分钟才能让它显示在WebUI上。如果需要，可以将其设置为较低的值。</p><h2 id="6254" class="na lz hi bd ma ng nh ni me nj nk nl mi lo nm nn mk lp no np mm lq nq nr mo ns bi translated"><strong class="ak">最小文件进程间隔</strong></h2><pre class="jg jh ji jj fd mv mw mx my aw mz bi"><span id="d21a" class="na lz hi mw b fi nb nc l nd ne"># Number of seconds after which a DAG file is parsed. The DAG file is parsed every<br/># ``min_file_process_interval`` number of seconds. Updates to DAGs are reflected after<br/># this interval. Keeping this number low will increase CPU usage.<br/>min_file_process_interval = 30</span></pre><p id="0179" class="pw-post-body-paragraph kr ks hi ku b kv kw ij kx ky kz im la lo lc ld le lp lg lh li lq lk ll lm ln hb bi translated">配置中的该值决定了在WebUI上扫描和更新现有DAG文件的频率。默认值设置为30秒，这意味着在更新DAG代码后，您可能需要等待30秒，以使更改显示在WebUI上。如果需要，可以将其设置为较低的值。</p><h1 id="1f39" class="ly lz hi bd ma mb nt md me mf nu mh mi io nv ip mk ir nw is mm iu nx iv mo mp bi translated">创建Dag</h1><h2 id="74c1" class="na lz hi bd ma ng nh ni me nj nk nl mi lo nm nn mk lp no np mm lq nq nr mo ns bi translated">示例Dag</h2><p id="8b2e" class="pw-post-body-paragraph kr ks hi ku b kv mq ij kx ky mr im la lo ms ld le lp mt lh li lq mu ll lm ln hb bi translated">Airflow附带了各种示例Dag，您可以在登录时在WebUI上看到它们。这些可以作为通过气流创建和编排不同类型任务的参考。</p><p id="4a41" class="pw-post-body-paragraph kr ks hi ku b kv kw ij kx ky kz im la lo lc ld le lp lg lh li lq lk ll lm ln hb bi translated">通过单击DAG名称左侧的单选按钮来启用它，从而取消暂停DAG。单击DAG名称，查看当前选项卡上的各种详细信息。</p><figure class="jg jh ji jj fd jk er es paragraph-image"><div class="er es od"><img src="../Images/7e90b93090511bc2e0ee49cf52f8a679.png" data-original-src="https://miro.medium.com/v2/resize:fit:728/format:webp/1*4_LCiYJb7EM1RIGpwfordw.png"/></div><figcaption class="jr js et er es jt ju bd b be z dx translated">打开DAG</figcaption></figure><figure class="jg jh ji jj fd jk er es paragraph-image"><div role="button" tabindex="0" class="jl jm di jn bf jo"><div class="er es oe"><img src="../Images/21f3fa3d2efd4ba1d677b47a523b1922.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6_qAhV71wREhgWpbhwQd2g.png"/></div></div><figcaption class="jr js et er es jt ju bd b be z dx translated">DAG详细信息-图表视图</figcaption></figure><blockquote class="ko kp kq"><p id="1d8b" class="kr ks kt ku b kv kw ij kx ky kz im la lb lc ld le lf lg lh li lj lk ll lm ln hb bi translated">注意:如果示例Dag未暂停，有时气流调度程序会抛出一些错误。如果您遇到任何问题，请暂停它们。</p></blockquote><h2 id="d71c" class="na lz hi bd ma ng nh ni me nj nk nl mi lo nm nn mk lp no np mm lq nq nr mo ns bi translated">达格袋</h2><p id="0a86" class="pw-post-body-paragraph kr ks hi ku b kv mq ij kx ky mr im la lo ms ld le lp mt lh li lq mu ll lm ln hb bi translated">我们可以通过创建定义DAG的python脚本来创建自己的DAG，并将它们保存在<em class="kt"> $AIRFLOW_HOME/dags </em>目录中。该目录的位置设置在<em class="kt"> dags_folder </em>下的airflow.cfg配置文件中，如果需要可以更新。</p><pre class="jg jh ji jj fd mv mw mx my aw mz bi"><span id="a750" class="na lz hi mw b fi nb nc l nd ne">mkdir $AIRFLOW_HOME/dags<br/>cd $AIRFLOW_HOME/dags</span></pre><h2 id="4359" class="na lz hi bd ma ng nh ni me nj nk nl mi lo nm nn mk lp no np mm lq nq nr mo ns bi translated">经营者</h2><p id="1a7e" class="pw-post-body-paragraph kr ks hi ku b kv mq ij kx ky mr im la lo ms ld le lp mt lh li lq mu ll lm ln hb bi translated">我们将介绍以下3个运算符，并创建一个使用它们的DAG:</p><ol class=""><li id="918e" class="of og hi ku b kv kw ky kz lo oh lp oi lq oj ln ok ol om on bi translated">bash运算符</li><li id="7df5" class="of og hi ku b kv oo ky op lo oq lp or lq os ln ok ol om on bi translated">python运算符</li><li id="2a4c" class="of og hi ku b kv oo ky op lo oq lp or lq os ln ok ol om on bi translated">MySqlOperator</li></ol><p id="d304" class="pw-post-body-paragraph kr ks hi ku b kv kw ij kx ky kz im la lo lc ld le lp lg lh li lq lk ll lm ln hb bi translated"><strong class="ku hj"> BashOperator </strong></p><p id="66a2" class="pw-post-body-paragraph kr ks hi ku b kv kw ij kx ky kz im la lo lc ld le lp lg lh li lq lk ll lm ln hb bi translated">这个操作符在Bash shell上执行命令。下面是语法的一个例子。</p><pre class="jg jh ji jj fd mv mw mx my aw mz bi"><span id="890d" class="na lz hi mw b fi nb nc l nd ne">bash1 = BashOperator(<br/>    task_id='bash1',<br/>    bash_command='echo "BashOperator on Airflow" &gt; bash1_op.txt'<br/>)</span></pre><p id="b350" class="pw-post-body-paragraph kr ks hi ku b kv kw ij kx ky kz im la lo lc ld le lp lg lh li lq lk ll lm ln hb bi translated">我们还可以通过调用. sh文件来执行shell脚本。</p><pre class="jg jh ji jj fd mv mw mx my aw mz bi"><span id="79f6" class="na lz hi mw b fi nb nc l nd ne">bash2 = BashOperator(<br/>    task_id='bash2',<br/>    bash_command='/home/vijayp/test.sh'<br/>)</span></pre><p id="bf3f" class="pw-post-body-paragraph kr ks hi ku b kv kw ij kx ky kz im la lo lc ld le lp lg lh li lq lk ll lm ln hb bi translated">这也可以用来执行python文件。</p><pre class="jg jh ji jj fd mv mw mx my aw mz bi"><span id="4cb6" class="na lz hi mw b fi nb nc l nd ne">bash_python = BashOperator(<br/>    task_id='bash_python',<br/>    bash_command='python3 /home/vijayp/test.py'<br/>)</span></pre><p id="2c26" class="pw-post-body-paragraph kr ks hi ku b kv kw ij kx ky kz im la lo lc ld le lp lg lh li lq lk ll lm ln hb bi translated"><strong class="ku hj">python运算符</strong></p><p id="5563" class="pw-post-body-paragraph kr ks hi ku b kv kw ij kx ky kz im la lo lc ld le lp lg lh li lq lk ll lm ln hb bi translated">此运算符可用于调用在DAG文件或另一个python脚本中定义的python函数。</p><pre class="jg jh ji jj fd mv mw mx my aw mz bi"><span id="a356" class="na lz hi mw b fi nb nc l nd ne">def hello_world():<br/>    print('Hello World')<br/>    return 'This gets printed in the logs'<br/><br/>python1= PythonOperator(<br/>    task_id='python1',<br/>    python_callable=hello_world<br/>)</span></pre><p id="f81e" class="pw-post-body-paragraph kr ks hi ku b kv kw ij kx ky kz im la lo lc ld le lp lg lh li lq lk ll lm ln hb bi translated">如果您在另一个脚本中定义了函数，请将其导入DAG文件，然后将其传递给PythonOperator。</p><pre class="jg jh ji jj fd mv mw mx my aw mz bi"><span id="4143" class="na lz hi mw b fi nb nc l nd ne">from my_script import my_func</span><span id="85a0" class="na lz hi mw b fi ny nc l nd ne">python2= PythonOperator(<br/>    task_id='python2',<br/>    python_callable=my_func<br/>)</span></pre><p id="c9d5" class="pw-post-body-paragraph kr ks hi ku b kv kw ij kx ky kz im la lo lc ld le lp lg lh li lq lk ll lm ln hb bi translated"><strong class="ku hj"> MySqlOperator </strong></p><p id="815b" class="pw-post-body-paragraph kr ks hi ku b kv kw ij kx ky kz im la lo lc ld le lp lg lh li lq lk ll lm ln hb bi translated">要通过Airflow连接到MySQL数据库并使用这个操作符，我们需要安装下面的包。安装后重新启动气流。</p><pre class="jg jh ji jj fd mv mw mx my aw mz bi"><span id="005e" class="na lz hi mw b fi nb nc l nd ne">sudo apt install libmysqlclient-dev</span><span id="da08" class="na lz hi mw b fi ny nc l nd ne">pip install apache-airflow-providers-mysql</span></pre><p id="968e" class="pw-post-body-paragraph kr ks hi ku b kv kw ij kx ky kz im la lo lc ld le lp lg lh li lq lk ll lm ln hb bi translated">我们还需要运行一个MySQL服务器来连接它。我已经使用<a class="ae jv" href="https://www.freesqldatabase.com/account/" rel="noopener ugc nofollow" target="_blank">https://www.freesqldatabase.com/</a>快速创建了一个免费的数据库，并在Airflow中使用了连接细节。</p><p id="409e" class="pw-post-body-paragraph kr ks hi ku b kv kw ij kx ky kz im la lo lc ld le lp lg lh li lq lk ll lm ln hb bi translated"><strong class="ku hj">向气流添加SQL连接</strong></p><p id="6c28" class="pw-post-body-paragraph kr ks hi ku b kv kw ij kx ky kz im la lo lc ld le lp lg lh li lq lk ll lm ln hb bi translated">安装上述软件包后，我们需要在Airflow中保存MySQL服务器的连接细节。</p><p id="286d" class="pw-post-body-paragraph kr ks hi ku b kv kw ij kx ky kz im la lo lc ld le lp lg lh li lq lk ll lm ln hb bi translated">在WebUI上，转到<em class="kt">管理&gt;连接</em></p><figure class="jg jh ji jj fd jk er es paragraph-image"><div class="er es ot"><img src="../Images/43b2a85ab06783b8d5fe707b2ea8f707.png" data-original-src="https://miro.medium.com/v2/resize:fit:296/format:webp/1*MK6Is6PUXfqMmQd6u2YtMg.png"/></div><figcaption class="jr js et er es jt ju bd b be z dx translated">添加连接</figcaption></figure><p id="39ea" class="pw-post-body-paragraph kr ks hi ku b kv kw ij kx ky kz im la lo lc ld le lp lg lh li lq lk ll lm ln hb bi translated">使用以下设置添加新连接。填写您的数据库凭据。</p><figure class="jg jh ji jj fd jk er es paragraph-image"><div role="button" tabindex="0" class="jl jm di jn bf jo"><div class="er es ou"><img src="../Images/ea7cd36d2be8bf3ebe7a9bafc7e6e08a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*55JvhtgDhUwabQq16jIdzA.png"/></div></div><figcaption class="jr js et er es jt ju bd b be z dx translated">mySQL连接</figcaption></figure></div><div class="ab cl lr ls gp lt" role="separator"><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw"/></div><div class="hb hc hd he hf"><h2 id="cce7" class="na lz hi bd ma ng nh ni me nj nk nl mi lo nm nn mk lp no np mm lq nq nr mo ns bi translated">DAG文件</h2><p id="692b" class="pw-post-body-paragraph kr ks hi ku b kv mq ij kx ky mr im la lo ms ld le lp mt lh li lq mu ll lm ln hb bi translated">我们现在将创建一个使用上述三个运算符的DAG，并计划它每小时运行一次。我们需要在代码中添加以下内容:</p><p id="4cd4" class="pw-post-body-paragraph kr ks hi ku b kv kw ij kx ky kz im la lo lc ld le lp lg lh li lq lk ll lm ln hb bi translated"><strong class="ku hj">所需进口</strong></p><p id="0885" class="pw-post-body-paragraph kr ks hi ku b kv kw ij kx ky kz im la lo lc ld le lp lg lh li lq lk ll lm ln hb bi translated">我们将导入上面看到的所有3个操作符。</p><pre class="jg jh ji jj fd mv mw mx my aw mz bi"><span id="32b0" class="na lz hi mw b fi nb nc l nd ne"># importing the required libraries<br/>from datetime import timedelta, datetime<br/>from airflow import DAG<br/>from airflow.operators.python_operator import PythonOperator<br/>from airflow.operators.bash_operator import BashOperator<br/>from airflow.providers.mysql.operators.mysql import MySqlOperator</span></pre><p id="c7b9" class="pw-post-body-paragraph kr ks hi ku b kv kw ij kx ky kz im la lo lc ld le lp lg lh li lq lk ll lm ln hb bi translated"><strong class="ku hj">定义DAG属性</strong></p><pre class="jg jh ji jj fd mv mw mx my aw mz bi"><span id="f310" class="na lz hi mw b fi nb nc l nd ne">default_args = {<br/>    'owner': 'sherlock',<br/>    'depends_on_past': False,<br/>    'start_date': datetime(2021,9,1),<br/>    'email': ['<a class="ae jv" href="mailto:sherlock@221-b-bakerstreet.org" rel="noopener ugc nofollow" target="_blank">sherlock@221-b-bakerstreet.org</a>'],<br/>    'email_on_failure': False,<br/>    'email_on_retry': False,<br/>    'retries': 1,<br/>    'retry_delay': timedelta(minutes=1)<br/>}</span><span id="5360" class="na lz hi mw b fi ny nc l nd ne"># define the DAG<br/>dag = DAG(<br/>    'airflow_get_started',<br/>    default_args=default_args,<br/>    description='Getting Started with Airflow',<br/>    schedule_interval=timedelta(hours=1), # run every hour<br/>    catchup=False # do not perform a backfill of missing runs<br/>)</span></pre><p id="9cca" class="pw-post-body-paragraph kr ks hi ku b kv kw ij kx ky kz im la lo lc ld le lp lg lh li lq lk ll lm ln hb bi translated"><strong class="ku hj">Python operator的Python函数</strong></p><pre class="jg jh ji jj fd mv mw mx my aw mz bi"><span id="8624" class="na lz hi mw b fi nb nc l nd ne">def hello_world():<br/>    print('Hello World')<br/>    return 'This gets printed in the logs'</span></pre><p id="c5f7" class="pw-post-body-paragraph kr ks hi ku b kv kw ij kx ky kz im la lo lc ld le lp lg lh li lq lk ll lm ln hb bi translated"><strong class="ku hj">定义步骤</strong></p><pre class="jg jh ji jj fd mv mw mx my aw mz bi"><span id="689a" class="na lz hi mw b fi nb nc l nd ne"># define steps<br/>python1= PythonOperator(<br/>    task_id='python1',<br/>    python_callable=hello_world,<br/>    dag=dag<br/>)</span><span id="86f2" class="na lz hi mw b fi ny nc l nd ne">bash1 = BashOperator(<br/>    task_id='bash1',<br/>    bash_command='echo "BashOperator on Airflow" &gt; bash1_op.txt',<br/>    dag=dag<br/>)</span><span id="a4d7" class="na lz hi mw b fi ny nc l nd ne">mysql1 = MySqlOperator(<br/>    task_id='mysql1',<br/>    mysql_conn_id='mysql_conn', # name of the connection we defined in Admin &gt; Connections<br/>    sql="""INSERT INTO sql4438199.airflow_tb values (5);""", # sql command; can also be path to a sql script<br/>    dag=dag<br/>)</span></pre><p id="dfed" class="pw-post-body-paragraph kr ks hi ku b kv kw ij kx ky kz im la lo lc ld le lp lg lh li lq lk ll lm ln hb bi translated"><strong class="ku hj">创建流程图的步骤</strong></p><pre class="jg jh ji jj fd mv mw mx my aw mz bi"><span id="3eb3" class="na lz hi mw b fi nb nc l nd ne">python1 &gt;&gt; bash1 &gt;&gt; mysql1</span></pre><p id="33d6" class="pw-post-body-paragraph kr ks hi ku b kv kw ij kx ky kz im la lo lc ld le lp lg lh li lq lk ll lm ln hb bi translated"><strong class="ku hj">添加DAG </strong></p><p id="515b" class="pw-post-body-paragraph kr ks hi ku b kv kw ij kx ky kz im la lo lc ld le lp lg lh li lq lk ll lm ln hb bi translated">将以上所有片段保存到一个位于<em class="kt"> $AIRFLOW_HOME/dags </em>目录下的. py文件中</p><figure class="jg jh ji jj fd jk er es paragraph-image"><div class="er es ov"><img src="../Images/4bbca55f74deebaa887aab2c8ed22422.png" data-original-src="https://miro.medium.com/v2/resize:fit:1132/format:webp/1*qhyAmkicztlWMMZ6vI1bVw.png"/></div><figcaption class="jr js et er es jt ju bd b be z dx translated">添加DAG文件</figcaption></figure><p id="48bb" class="pw-post-body-paragraph kr ks hi ku b kv kw ij kx ky kz im la lo lc ld le lp lg lh li lq lk ll lm ln hb bi translated">这将在WebUI上显示一段时间，具体取决于airflow.cfg中设置的时间。单击单选按钮以取消暂停DAG。</p><figure class="jg jh ji jj fd jk er es paragraph-image"><div role="button" tabindex="0" class="jl jm di jn bf jo"><div class="er es ow"><img src="../Images/965d9d8c26c611e072ab77efe16f4887.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gc45F9is4HkAFZPMu_fp-A.png"/></div></div><figcaption class="jr js et er es jt ju bd b be z dx translated">取消暂停DAG</figcaption></figure><p id="8e9f" class="pw-post-body-paragraph kr ks hi ku b kv kw ij kx ky kz im la lo lc ld le lp lg lh li lq lk ll lm ln hb bi translated">它应该立即开始第一次运行，然后每小时运行一次。</p><figure class="jg jh ji jj fd jk er es paragraph-image"><div role="button" tabindex="0" class="jl jm di jn bf jo"><div class="er es ox"><img src="../Images/cd636cbe8a828b83415a9d115f80e410.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*E2lSRKBd2Xx0nno3J0M3ww.png"/></div></div><figcaption class="jr js et er es jt ju bd b be z dx translated">首轮放映</figcaption></figure><p id="c764" class="pw-post-body-paragraph kr ks hi ku b kv kw ij kx ky kz im la lo lc ld le lp lg lh li lq lk ll lm ln hb bi translated">您可以浏览不同的视图，以获得有关DAG及其运行的详细信息。点击任意步骤并点击<em class="kt">日志</em>查看日志。</p><figure class="jg jh ji jj fd jk er es paragraph-image"><div class="er es oy"><img src="../Images/79f65ca233192c186af11ebf22a535e4.png" data-original-src="https://miro.medium.com/v2/resize:fit:988/format:webp/1*SmXJ_ETmOHH8JEFh-lDciw.png"/></div></figure></div><div class="ab cl lr ls gp lt" role="separator"><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw"/></div><div class="hb hc hd he hf"><p id="6e6d" class="pw-post-body-paragraph kr ks hi ku b kv kw ij kx ky kz im la lo lc ld le lp lg lh li lq lk ll lm ln hb bi translated"><strong class="ku hj">输出</strong></p><p id="8ce6" class="pw-post-body-paragraph kr ks hi ku b kv kw ij kx ky kz im la lo lc ld le lp lg lh li lq lk ll lm ln hb bi translated">BashOperator创建了bash_op1.txt文件。</p><figure class="jg jh ji jj fd jk er es paragraph-image"><div class="er es oz"><img src="../Images/9eba882c77af964797c53d4d9dd517a6.png" data-original-src="https://miro.medium.com/v2/resize:fit:860/format:webp/1*1ehWbtHqgKhd9S-yUs2W6A.png"/></div></figure><p id="382e" class="pw-post-body-paragraph kr ks hi ku b kv kw ij kx ky kz im la lo lc ld le lp lg lh li lq lk ll lm ln hb bi translated">PythonOperator的输出可以在日志中看到。</p><figure class="jg jh ji jj fd jk er es paragraph-image"><div role="button" tabindex="0" class="jl jm di jn bf jo"><div class="er es pa"><img src="../Images/3081b722ce5881fdd5e23e4c5cc14242.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IgD-kEB-mpaOVZaBk_mHXg.png"/></div></div></figure><p id="aa10" class="pw-post-body-paragraph kr ks hi ku b kv kw ij kx ky kz im la lo lc ld le lp lg lh li lq lk ll lm ln hb bi translated">MySQLOperator将行插入到表<em class="kt"> airflow_tb中。</em></p><figure class="jg jh ji jj fd jk er es paragraph-image"><div class="er es pb"><img src="../Images/8934d2191f65f1cb76f8bbbf162aed70.png" data-original-src="https://miro.medium.com/v2/resize:fit:834/format:webp/1*levj5n-ujArR3l52B16Fdw.png"/></div></figure><p id="0fe6" class="pw-post-body-paragraph kr ks hi ku b kv kw ij kx ky kz im la lo lc ld le lp lg lh li lq lk ll lm ln hb bi translated">此处提供DAG代码文件以供参考:</p><figure class="jg jh ji jj fd jk"><div class="bz dy l di"><div class="pc pd l"/></div></figure></div><div class="ab cl lr ls gp lt" role="separator"><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw"/></div><div class="hb hc hd he hf"><p id="0eb0" class="pw-post-body-paragraph kr ks hi ku b kv kw ij kx ky kz im la lo lc ld le lp lg lh li lq lk ll lm ln hb bi translated">感谢您阅读这篇文章。如果您有任何问题或任何意见，请通过评论联系我。</p><p id="f830" class="pw-post-body-paragraph kr ks hi ku b kv kw ij kx ky kz im la lo lc ld le lp lg lh li lq lk ll lm ln hb bi translated">你可以在<a class="ae jv" href="https://github.com/patilvijay23/MLinPython" rel="noopener ugc nofollow" target="_blank">我的git repo这里</a>找到python/pyspark相关参考资料。</p></div></div>    
</body>
</html>