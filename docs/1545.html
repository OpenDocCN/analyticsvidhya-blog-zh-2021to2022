<html>
<head>
<title>Writing Custom Management Commands in Django</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用Django编写定制管理命令</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/writing-custom-management-commands-in-django-d66044c37433?source=collection_archive---------9-----------------------#2021-03-07">https://medium.com/analytics-vidhya/writing-custom-management-commands-in-django-d66044c37433?source=collection_archive---------9-----------------------#2021-03-07</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><figure class="ev ex if ig ih ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es ie"><img src="../Images/e1fc3cec07358d15465d843bda3e4279.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*4bWZeYUVLSN-S54N.jpeg"/></div></div><figcaption class="ip iq et er es ir is bd b be z dx translated">图片来源:<a class="ae it" href="https://miro.medium.com/max/1838/1*_jaOKxXn1e7ho6mhT4U7Ow.jpeg" rel="noopener">此处</a></figcaption></figure><p id="f195" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">有时我们需要执行一次性任务。例如:自动更改数据库中的某些内容，发送报告或通知，安排一些任务，等等。如果您想随时调用这些命令，那么管理命令是最佳选择。你甚至可以使用管理命令作为生产中的<strong class="iw hi">工人</strong>。Django本身有几个命令比如<strong class="iw hi"> <em class="js"> migrate、makemigrations、runserver </em> </strong>等等。现在，我将向您展示如何编写自己的管理命令。我们开始吧！</p><h1 id="77f1" class="jt ju hh bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">项目结构</h1><p id="849b" class="pw-post-body-paragraph iu iv hh iw b ix kr iz ja jb ks jd je jf kt jh ji jj ku jl jm jn kv jp jq jr ha bi translated">我假设你已经有一个名为<strong class="iw hi">“我的项目”</strong>的Django项目和一个名为<strong class="iw hi">“我的应用”</strong>的应用。进入该应用程序，创建父目录<strong class="iw hi">“管理”</strong>和子目录<strong class="iw hi">命令。</strong>现在你的项目结构应该是这样的:</p><figure class="kx ky kz la fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es kw"><img src="../Images/01134c2ca6bb9e523c58d31436a7e45b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1196/format:webp/1*4RVlhzLdZ0G1F8miPIK4TA.png"/></div></div><figcaption class="ip iq et er es ir is bd b be z dx translated">忽略<strong class="bd jv"> __pycache__ </strong>目录</figcaption></figure><h1 id="d373" class="jt ju hh bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated"><strong class="ak">命令</strong></h1><p id="d8b1" class="pw-post-body-paragraph iu iv hh iw b ix kr iz ja jb ks jd je jf kt jh ji jj ku jl jm jn kv jp jq jr ha bi translated">在命令目录下创建一个名为<strong class="iw hi">“my _ command . py”</strong>的python文件:</p><figure class="kx ky kz la fd ii er es paragraph-image"><div class="er es lb"><img src="../Images/43b581c1cb976893a6b925dccf1ff121.png" data-original-src="https://miro.medium.com/v2/resize:fit:1190/format:webp/1*kDxCllVz1aiXGGZj_DCY6A.png"/></div></figure><p id="492f" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">让我们打开<strong class="iw hi"> my_command.py </strong>并创建一个简单的命令来检查该命令是否有效。要编写命令，我们必须定义一个继承自<strong class="iw hi"> BaseCommand </strong>类的<strong class="iw hi"> Command </strong>类。为此，让我们导入<strong class="iw hi"> BaseCommand </strong>和<strong class="iw hi"> CommandError </strong>类来处理错误。</p><pre class="kx ky kz la fd lc ld le lf aw lg bi"><span id="8539" class="lh ju hh ld b fi li lj l lk ll">from django.core.management.base import BaseCommand, CommandError</span><span id="7feb" class="lh ju hh ld b fi lm lj l lk ll">class Command(BaseCommand):<br/>    help = "Command to print a text"</span><span id="4c62" class="lh ju hh ld b fi lm lj l lk ll">def handle(self, *args, **options):<br/>        try:<br/>            print('Command is executed')<br/>        except Exception as e:<br/>            raise CommandError(e)</span></pre><p id="86db" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">你可以定义一个变量<strong class="iw hi">帮助</strong>解释这个命令的目的是什么。函数<strong class="iw hi">句柄</strong>将执行我们的命令。命令完成了，让我们检查一下。打开终端，用以下命令调用它:</p><pre class="kx ky kz la fd lc ld le lf aw lg bi"><span id="f60a" class="lh ju hh ld b fi li lj l lk ll">py manage.py my_command</span></pre><p id="192a" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">你会看到输出:<strong class="iw hi"> <em class="js">命令被执行</em> </strong></p><p id="111b" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">我们学习了如何编写简单的命令，现在我们可以执行更高级的命令，如发送报告、电子邮件等。让我们开始吧:</p><h2 id="037b" class="lh ju hh bd jv ln lo lp jz lq lr ls kd jf lt lu kh jj lv lw kl jn lx ly kp lz bi translated">1.创建报表模型:</h2><p id="f7ef" class="pw-post-body-paragraph iu iv hh iw b ix kr iz ja jb ks jd je jf kt jh ji jj ku jl jm jn kv jp jq jr ha bi translated">转到<strong class="iw hi"> my_app.models </strong>并创建一个模型:</p><pre class="kx ky kz la fd lc ld le lf aw lg bi"><span id="8131" class="lh ju hh ld b fi li lj l lk ll"><em class="js">from</em> django.db <em class="js">import</em> models</span><span id="0718" class="lh ju hh ld b fi lm lj l lk ll">class Report(models.Model):<br/>    receiver = models.EmailField()<br/>    content  = models.TextField(max_length=500)<br/>    sent = models.BooleanField(default=False)<br/>    created_date = models.DateField(auto_now_add=True)<br/>    <br/>    def __str__(self):<br/>        return self.receiver</span></pre><p id="8ad6" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated"><strong class="iw hi"> 2。写一个命令:</strong></p><p id="ad25" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">回到<strong class="iw hi"> my_command.py </strong>并这样修改:</p><pre class="kx ky kz la fd lc ld le lf aw lg bi"><span id="f02f" class="lh ju hh ld b fi li lj l lk ll">from django.core.management.base import BaseCommand, CommandError<br/>from django.core.mail import EmailMessage<br/>from my_app.models import Report</span><span id="5d76" class="lh ju hh ld b fi lm lj l lk ll">class Command(BaseCommand):<br/>    help = "Execute to send all unsent reports"</span><span id="0f3c" class="lh ju hh ld b fi lm lj l lk ll">    def handle(self, *args, **options):<br/>            try:<br/>                reports = Report.objects.filter(sent=False)<br/>                if reports.exists():<br/>                     for report in reports:<br/>                         subject = 'Report'<br/>                         receiver = report.receiver<br/>                         content = report.content<br/>                         new_email = EmailMessage(<br/>                         subject, content,<br/>                        'youremailaddress', [receiver])</span><span id="5c26" class="lh ju hh ld b fi lm lj l lk ll">                         new_email.send(fail_silently=False)<br/>                         report.sent = True<br/>                         report.save()<br/> <br/>             except Exception as e:<br/>                raise CommandError(e)</span></pre><p id="5cf2" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">在这个例子中，我们获取所有未发送的报告并发送它们。</p><p id="6d6a" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">在某些情况下，您可能希望发送特定的报告。为此，我们将把<strong class="iw hi"><em class="js">add _ arguments</em></strong>函数添加到命令类中。现在这个类应该是这样的:</p><pre class="kx ky kz la fd lc ld le lf aw lg bi"><span id="a2e3" class="lh ju hh ld b fi li lj l lk ll">from django.core.management.base import BaseCommand, CommandError<br/>from django.core.mail import EmailMessage<br/>from my_app.models import Report</span><span id="7c0e" class="lh ju hh ld b fi lm lj l lk ll">class Command(BaseCommand):<br/>     help = "Execute to send all unsent reports"</span><span id="3b6d" class="lh ju hh ld b fi lm lj l lk ll">     def add_arguments(self, parser):<br/>        parser.add_argument('report_ids', nargs='+', type=int)</span><span id="6576" class="lh ju hh ld b fi lm lj l lk ll">     def handle(self, *args, **options):<br/>           for id in options['report_ids']:<br/>                try:<br/>                   report = Report.objects.get(id=id)<br/>   <br/>                except Report.DoesnNotExist:<br/>                   raise CommandError('Report doesn not exist')<br/>  <br/>                subject = 'Report'<br/>                receiver = report.receiver<br/>                content = report.content<br/>                new_email = EmailMessage(<br/>                    subject, content,<br/>                   'youremailaddress', [receiver])<br/>                 new_email.send(fail_silently=False)<br/>                 report.sent = True<br/>                 report.save()</span></pre><p id="96fe" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated"><strong class="iw hi"> <em class="js"> add_aruments </em> </strong>中的第一个属性向我们展示了如何访问<strong class="iw hi"> <em class="js">句柄</em> </strong>函数中的id。</p><p id="9002" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">使用特定id调用此命令:</p><pre class="kx ky kz la fd lc ld le lf aw lg bi"><span id="e6a0" class="lh ju hh ld b fi li lj l lk ll">py manage.py my_command &lt;report_ids&gt;</span></pre><p id="fa25" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">您可以发送一个id，甚至是一个id列表</p><h1 id="a74c" class="jt ju hh bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">结论</h1><p id="7c02" class="pw-post-body-paragraph iu iv hh iw b ix kr iz ja jb ks jd je jf kt jh ji jj ku jl jm jn kv jp jq jr ha bi translated">在本教程的最后，我们学习了如何以不同的方式定制管理命令并执行它们。如果您有任何问题，请写在下面</p><blockquote class="ma"><p id="abd7" class="mb mc hh bd md me mf mg mh mi mj jr dx translated">感谢阅读。请继续关注更多✌</p></blockquote></div></div>    
</body>
</html>