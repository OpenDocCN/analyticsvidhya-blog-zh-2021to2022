<html>
<head>
<title>Running Go code from Python</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">从Python运行Go代码</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/running-go-code-from-python-a65b3ae34a2d?source=collection_archive---------0-----------------------#2021-04-15">https://medium.com/analytics-vidhya/running-go-code-from-python-a65b3ae34a2d?source=collection_archive---------0-----------------------#2021-04-15</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="35d8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Python是一种伟大的语言，可以被新开发人员轻松掌握，并在很短的时间内变得富有成效，它的设计是干净的代码，它有一百万个可用的库，可悲的是，所有这些好处都是以所谓的“速度”为代价的，python很慢，非常慢；pypy或stackless有时有助于提高性能，但有时它们会破坏其他不兼容的库，或者在我们的特定用例中没有任何改进。</p><p id="1385" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您总是可以选择用C语言构建一个库并导入它，但是对于某些人来说，C语言最终可能会成为一种非常复杂的语言，或者用C语言构建某些东西所需的时间可能会抵消移植代码的好处。</p><p id="35e9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">幸运的是，有一个中间地带我们可以使用:Go，比C更容易(如果你做并行的话会更好)但比Python更快，它也有很多可用的库，这些库将为我们提供很多C中可能没有的特性。</p><p id="4722" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">GO有一个名为CGO(<a class="ae jd" href="https://golang.org/cmd/cgo/" rel="noopener ugc nofollow" target="_blank">https://golang.org/cmd/cgo/</a>)的包，它允许我们连接Go和C语言，反之亦然，因为Python可以导入C语言的库，我们可以导出某些Go函数供Python使用，就好像它们是C语言的库一样。</p><p id="37d2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们首先创建一个<em class="je">库. go </em>文件，并添加以下内容:</p><pre class="jf jg jh ji fd jj jk jl jm aw jn bi"><span id="5ad3" class="jo jp hi jk b fi jq jr l js jt">package main<br/><br/>import (<br/>   "C"<br/>   "log"<br/>)<br/><br/>//<strong class="jk hj"><em class="je">export </em></strong>helloWorld<br/>func helloWorld(){<br/>   log.Println("Hello World")<br/>}<br/><br/>func main(){<br/><br/>}</span></pre><p id="14e2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">CGO添加了“C”导入，这将为我们提供某些实用函数，它将使编译器将某些注释视为特殊操作，第一个是“导出”注释，它将告诉编译器哪些函数将被导出以从Python调用，然后我们像往常一样创建我们的函数，然后为了能够编译，我们将在最后添加一个空的main函数。</p><p id="ce79" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">给<strong class="ih hj">额外的</strong>注意<em class="je">导出</em>就在注释的旁边，如果你在中间添加一个空格，它不会被认为是一个导出的符号，python也不会找到它。</p><p id="5a79" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在CLI上，我们现在将通过运行以下命令来执行编译:</p><pre class="jf jg jh ji fd jj jk jl jm aw jn bi"><span id="57d3" class="jo jp hi jk b fi jq jr l js jt">go build -buildmode=c-shared -o library.so library.go</span></pre><p id="830c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这里要注意的关键是构建模式，我们将指定它是一个C共享对象，然后输出扩展将是一个库。so =我的共享对象，因为我正在使用Linux)，一旦我们编译了库，我们将继续用python构建客户端，为此我创建了一个“app.py ”,如下所示:</p><pre class="jf jg jh ji fd jj jk jl jm aw jn bi"><span id="6e1c" class="jo jp hi jk b fi jq jr l js jt">import ctypes<br/>library = ctypes.cdll.LoadLibrary('./library.so')<br/>hello_world = library.helloWorld<br/>hello_world()</span></pre><p id="519b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们导入<em class="je"> ctypes </em>模块，然后在我们编译的库上执行<em class="je"> LoadLibrary </em>，第三行将有一个<em class="je"> hello_world </em>，它是python对象，将引用库的<em class="je"> helloWorld </em>函数，在这种情况下，命名约定将提示我们哪个是Go版本，哪个是Python的，最后在第4行，我们将调用该函数并接收类似于以下的输出:</p><figure class="jf jg jh ji fd jv er es paragraph-image"><div class="er es ju"><img src="../Images/66c3eafbeddfe908b8a1e0ca985d3f6e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1210/format:webp/1*IgXuJ0ADd38jUuUe9S2PCg.png"/></div><figcaption class="jy jz et er es ka kb bd b be z dx translated">Go的日志格式用来打招呼</figcaption></figure><p id="6bda" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果我们想从Python发送一个参数，我们需要做一些调整，为此我们将在library.go文件上创建一个新函数:</p><pre class="jf jg jh ji fd jj jk jl jm aw jn bi"><span id="b8ec" class="jo jp hi jk b fi jq jr l js jt">//<strong class="jk hj"><em class="je">export </em></strong>hello<br/>func hello(namePtr *C.char){<br/>   name := C.GoString(namePtr)<br/>   log.Println("Hello", name)<br/>}</span></pre><p id="0fe1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">你会注意到的第一件事是参数，这是一个指向C字符的指针，这意味着我们将接收一个“字符串”作为参数，因为C处理字符串(字符数组)的方式，我们需要做一个微小的调整，然后才能在我们期望的时候使用它，因为我们有一个方便的方法叫C.GoString，它将接收指向C.char的指针并返回字符串的值。</p><p id="732d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一旦我们有了这些，我们将切换到python并为此函数创建一个新的符号:</p><pre class="jf jg jh ji fd jj jk jl jm aw jn bi"><span id="4037" class="jo jp hi jk b fi jq jr l js jt">hello = library.hello<br/>hello.argtypes = [ctypes.c_char_p]<br/>hello("everyone".encode('utf-8'))</span></pre><p id="8d77" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">第一行将只是对Go函数的引用，然后我们将指定我们将发送的“参数”的类型，在本例中:c字符指针的列表，最后我们将发送一个编码为utf-8的字符串，以便类型匹配。</p><figure class="jf jg jh ji fd jv er es paragraph-image"><div class="er es kc"><img src="../Images/aa8346a6632a198bf339cc80e625adfc.png" data-original-src="https://miro.medium.com/v2/resize:fit:912/format:webp/1*1OGG5_Rse3m01O8HQOEnaQ.png"/></div></figure><p id="69ef" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">到目前为止，我们可以从Python进行调用并从Python发送数据，我们还需要一件额外的事情，那就是将数据从Go发送回Python。</p><p id="777c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为此，我们将创建一个新的Go函数:</p><pre class="jf jg jh ji fd jj jk jl jm aw jn bi"><span id="da77" class="jo jp hi jk b fi jq jr l js jt">//<strong class="jk hj"><em class="je">export </em></strong>farewell<br/>func farewell() *C.char{<br/>   return C.CString("Bye!")<br/>}</span></pre><p id="3d39" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这次我们将返回一个指向C.char的指针，字符串需要通过C包从string转换成CString。</p><p id="43d9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">从python的角度看:</p><pre class="jf jg jh ji fd jj jk jl jm aw jn bi"><span id="9e70" class="jo jp hi jk b fi jq jr l js jt">farewell = library.farewell<br/>farewell.restype = ctypes.c_void_p<br/><br/># this is a pointer to our string<br/>farewell_output = farewell()<br/><br/># we dereference the pointer to a byte array<br/>farewell_bytes = ctypes.string_at(farewell_output)<br/><br/># convert our byte array to a string<br/>farewell_string = farewell_bytes.decode('utf-8')  <br/><br/>print(farewell_output, farewell_bytes, farewell_string)</span></pre><p id="8d2f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这将给我们带来这样的东西:</p><figure class="jf jg jh ji fd jv er es paragraph-image"><div class="er es kd"><img src="../Images/1a7cff18ffe56ee3d76c188cb88dda38.png" data-original-src="https://miro.medium.com/v2/resize:fit:790/format:webp/1*4dYQndUBAlINyMJZAz_2qA.png"/></div><figcaption class="jy jz et er es ka kb bd b be z dx translated">前两行是通过Go，最后一行是通过Python</figcaption></figure><p id="16ee" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后我们可以扩展到更复杂的东西，使用JSON作为我们在两个世界之间发送数据的方式，在library.go上我们添加了另一个函数:</p><pre class="jf jg jh ji fd jj jk jl jm aw jn bi"><span id="c7d7" class="jo jp hi jk b fi jq jr l js jt">//<strong class="jk hj"><em class="je">export </em></strong>fromJSON<br/>func fromJSON(documentPtr *C.char){<br/>   documentString := C.GoString(documentPtr)<br/>   var jsonDocument map[string]interface{}<br/>   err := json.Unmarshal([]byte(documentString), &amp;jsonDocument)<br/>   if err != nil{<br/>      log.Fatal(err)<br/>   }<br/>   log.Println(jsonDocument)<br/>}</span></pre><p id="1afa" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这一个将以和以前一样的方式接收一个字符串，但是我们将把它当作一个JSON字符串，并把它加载到一个string-interface的映射中(实际上可以是任何东西……)。</p><p id="73c5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后在python上:</p><pre class="jf jg jh ji fd jj jk jl jm aw jn bi"><span id="6acc" class="jo jp hi jk b fi jq jr l js jt">import json<br/>from_json = library.fromJSON<br/>from_json.argtypes = [ctypes.c_char_p]<br/>document = {<br/>    "name": "john",<br/>    "last_name": "smith"<br/>}<br/>from_json(json.dumps(document).encode('utf-8'))</span></pre><p id="7aa4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们将一个字典转储到一个JSON字符串，并将其发送给我们的新函数，其输出将是:</p><figure class="jf jg jh ji fd jv er es paragraph-image"><div class="er es ke"><img src="../Images/e88e99d06d57cc38f2cee567b46e468c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1078/format:webp/1*A5fXJ66thuFBruZpqF6j3A.png"/></div></figure><p id="de2c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，您可以开始从Python移植您的缓慢/瓶颈代码，以获得两个世界的最佳效果，并获得Pythonical Gopherista的称号。</p><p id="4ba1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果在复制/粘贴示例的过程中丢失了一些东西，完整的library.go文件:</p><pre class="jf jg jh ji fd jj jk jl jm aw jn bi"><span id="61c9" class="jo jp hi jk b fi jq jr l js jt">package main<br/><br/>import (<br/>   "C"<br/>   "encoding/json"<br/>   "log"<br/>)<br/><br/>//<strong class="jk hj"><em class="je">export </em></strong>helloWorld<br/>func helloWorld(){<br/>   log.Println("Hello World")<br/>}<br/><br/>//<strong class="jk hj"><em class="je">export </em></strong>hello<br/>func hello(namePtr *C.char){<br/>   name := C.GoString(namePtr)<br/>   log.Println("Hello", name)<br/>}<br/><br/>//<strong class="jk hj"><em class="je">export </em></strong>farewell<br/>func farewell() *C.char{<br/>   return C.CString("Bye!")<br/>}<br/><br/>//<strong class="jk hj"><em class="je">export </em></strong>fromJSON<br/>func fromJSON(documentPtr *C.char){<br/>   documentString := C.GoString(documentPtr)<br/>   var jsonDocument map[string]interface{}<br/>   err := json.Unmarshal([]byte(documentString), &amp;jsonDocument)<br/>   if err != nil{<br/>      log.Fatal(err)<br/>   }<br/>   log.Println(jsonDocument)<br/>}<br/><br/>func main(){<br/><br/>}</span></pre><p id="27de" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">app.py文件:</p><pre class="jf jg jh ji fd jj jk jl jm aw jn bi"><span id="a8bb" class="jo jp hi jk b fi jq jr l js jt">import ctypes<br/>library = ctypes.cdll.LoadLibrary('./library.so')<br/>hello_world = library.helloWorld<br/>hello_world()<br/><br/>hello = library.hello<br/>hello.argtypes = [ctypes.c_char_p]<br/>hello("everyone".encode('utf-8'))<br/><br/>farewell = library.farewell<br/>farewell.restype = ctypes.c_void_p<br/><br/># this is a pointer to our string<br/>farewell_output = farewell()<br/><br/># we dereference the pointer to a byte array<br/>farewell_bytes = ctypes.string_at(farewell_output)<br/><br/># convert our byte array to a string<br/>farewell_string = farewell_bytes.decode('utf-8')<br/>print(farewell_output, farewell_bytes, farewell_string)<br/><br/><br/>import json<br/>from_json = library.fromJSON<br/>from_json.argtypes = [ctypes.c_char_p]<br/>document = {<br/>    "name": "john",<br/>    "last_name": "smith"<br/>}<br/>from_json(json.dumps(document).encode('utf-8'))</span></pre><p id="c0c7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">和我的Makefile:</p><pre class="jf jg jh ji fd jj jk jl jm aw jn bi"><span id="8b75" class="jo jp hi jk b fi jq jr l js jt">build:<br/>   go build -buildmode=c-shared -o library.so library.go</span></pre><p id="7aaf" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi">🐸</p></div></div>    
</body>
</html>