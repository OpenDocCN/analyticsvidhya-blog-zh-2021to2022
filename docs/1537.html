<html>
<head>
<title>Retry decorator in Python</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Python中的重试装饰器</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/retry-decorator-in-python-55d0729755c7?source=collection_archive---------1-----------------------#2021-03-07">https://medium.com/analytics-vidhya/retry-decorator-in-python-55d0729755c7?source=collection_archive---------1-----------------------#2021-03-07</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/0d8c9440e902b6ec5f6dc1adee7107e2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6Gw36XaOpijKzf9TK6fqMA.jpeg"/></div></div></figure><p id="6451" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在本帖中，我们将讨论重试装饰器以及如何在python中使用它。</p><p id="aca6" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">一般来说，我们可能遇到过很多这样的情况，我们希望执行一段代码，直到得到预期的结果，或者我们可能需要等待某个操作完成后再继续。</p></div><div class="ab cl jo jp gp jq" role="separator"><span class="jr bw bk js jt ju"/><span class="jr bw bk js jt ju"/><span class="jr bw bk js jt"/></div><div class="hb hc hd he hf"><p id="7c14" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在直接进入实现之前，我将解释一个简单的用例，其中我必须使用重试装饰器。</p><p id="f01b" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">使用案例是，有一个API具有以下端点:-</p><pre class="jv jw jx jy fd jz ka kb kc aw kd bi"><span id="db6e" class="ke kf hi ka b fi kg kh l ki kj">1.api/getData<br/>2.api/status<br/>3.api/data</span></pre><p id="4d7c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">api/getData，返回“<strong class="is hj"> id </strong>”，而不是直接为每个请求返回数据(有一些输入参数)。</p><p id="4c68" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">api/status，取api/getData返回的参数“id”，检查那个<strong class="is hj"> id </strong>的状态是否为<strong class="is hj">成功</strong>(返回<strong class="is hj">真/假</strong>)。</p><p id="a992" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在api/status返回true之前，我们无法请求api/data，因为数据尚未解析。因此，api/status指示我们是否可以向api/data发出请求，以获取接受“<strong class="is hj"> id </strong>”作为参数的数据。</p><p id="cc4f" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">因此，在这种情况下，我们向api/status端点发出连续请求，以检查状态。</strong></p><p id="0fda" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">让我们看看如何使用和不使用retry decorator来实现这一点。</p></div><div class="ab cl jo jp gp jq" role="separator"><span class="jr bw bk js jt ju"/><span class="jr bw bk js jt ju"/><span class="jr bw bk js jt"/></div><div class="hb hc hd he hf"><p id="6e01" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">无重试装饰器</strong></p><pre class="jv jw jx jy fd jz ka kb kc aw kd bi"><span id="7be7" class="ke kf hi ka b fi kg kh l ki kj">def check_status(id):<br/>     status = requests.get(status_url)<br/>     if status == True:<br/>          return True<br/>     else:<br/>         return False</span><span id="d0fd" class="ke kf hi ka b fi kk kh l ki kj">def get_data(id):<br/>     <br/>     status = None<br/>     while status is None or status == False:<br/>           time.sleep(5)<br/>           status = check_status(id)</span><span id="fba4" class="ke kf hi ka b fi kk kh l ki kj">     response = requests.get(url)<br/>     return response;</span></pre><p id="4203" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在上面的伪代码中，我在while循环中调用“check_status”方法，对于每个请求，我都将其延迟5秒钟，它必须等到status为“True”，只有这样我们才能使用“API/data”<br/>端点获取数据。</p><p id="a282" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">因此，这是一种重试模式，我们通过延迟5秒钟来重复检查id的状态。</p><p id="a2d2" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">同样可以使用“重试装饰器”来实现。</p></div><div class="ab cl jo jp gp jq" role="separator"><span class="jr bw bk js jt ju"/><span class="jr bw bk js jt ju"/><span class="jr bw bk js jt"/></div><div class="hb hc hd he hf"><p id="5df2" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">带重试装饰器</strong></p><p id="a55a" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">要安装重试装饰器，请使用以下命令。</p><pre class="jv jw jx jy fd jz ka kb kc aw kd bi"><span id="59cd" class="ke kf hi ka b fi kg kh l ki kj">pip install retry</span></pre><p id="aa85" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">若要在代码中使用它，请在代码中包含以下语句。</p><pre class="jv jw jx jy fd jz ka kb kc aw kd bi"><span id="8b35" class="ke kf hi ka b fi kg kh l ki kj">from retry import retry</span></pre><p id="70cc" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">要使任何函数成为重试逻辑，只需在函数定义上方添加@retry()语句，如下所示。</p><pre class="jv jw jx jy fd jz ka kb kc aw kd bi"><span id="2a76" class="ke kf hi ka b fi kg kh l ki kj">@retry()<br/>def check_status:</span></pre><p id="ea92" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">重试装饰器接受一些参数，</p><pre class="jv jw jx jy fd jz ka kb kc aw kd bi"><span id="b63c" class="ke kf hi ka b fi kg kh l ki kj"><strong class="ka hj">exceptions </strong>- you can specify your custom exception class , which indicates that you are expecting the function to retry when specified exception occurs.</span><span id="00e3" class="ke kf hi ka b fi kk kh l ki kj"><strong class="ka hj">tries </strong>- specifies the maximum number of times function can be retried. Default value is "-1".</span><span id="61c7" class="ke kf hi ka b fi kk kh l ki kj"><strong class="ka hj">delay </strong>- specifies the amount of time the function waits before next retry , similar to time.sleep() we have used above. Default value is "0".</span></pre><p id="b940" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">以上是retry decorator接受的一些参数，更多信息请参考<a class="ae kl" href="https://pypi.org/project/retry/" rel="noopener ugc nofollow" target="_blank">文档</a>。</p><p id="75bb" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">实施:</strong></p><figure class="jv jw jx jy fd ij"><div class="bz dy l di"><div class="km kn l"/></div></figure><p id="d1b6" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我没有使用time.sleep(5)，而是使用了上面声明的retry decorator "<strong class="is hj">wait _ for _ success _ status</strong>"函数，该函数带有3个参数<strong class="is hj">异常类型</strong>，它指示在特定类型的异常上函数必须重试，<strong class="is hj">delay</strong>5秒，这将函数执行延迟5秒，<strong class="is hj">用值6尝试</strong>，这指示函数最多可以重试6次。</p><p id="4add" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们也可以添加多个异常类型。</p><pre class="jv jw jx jy fd jz ka kb kc aw kd bi"><span id="e2bc" class="ke kf hi ka b fi kg kh l ki kj">@retry((ValueError,TypeError,InvalidStatus), delay=5, tries=6)</span></pre><p id="d32f" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在这种情况下，如果出现任何一种异常，将会重试该功能。</p></div></div>    
</body>
</html>