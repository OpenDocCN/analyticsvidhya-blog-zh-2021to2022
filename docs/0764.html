<html>
<head>
<title>Publish a python package to Conda</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">将python包发布到Conda</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/publish-a-python-package-to-conda-b352eb0bcb2e?source=collection_archive---------7-----------------------#2021-01-30">https://medium.com/analytics-vidhya/publish-a-python-package-to-conda-b352eb0bcb2e?source=collection_archive---------7-----------------------#2021-01-30</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div class="er es if"><img src="../Images/b7ba50805db4368a0eb0a1c916a49de4.png" data-original-src="https://miro.medium.com/v2/resize:fit:800/format:webp/1*A1sjBfEsqVhllKqtvPB1_Q.png"/></div><figcaption class="im in et er es io ip bd b be z dx translated"><a class="ae iq" href="https://github.com/conda/conda" rel="noopener ugc nofollow" target="_blank">https://github.com/conda/conda</a></figcaption></figure><p id="08d3" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated"><a class="ae iq" href="https://conda.io/en/latest/" rel="noopener ugc nofollow" target="_blank"> Conda </a>是类似于<a class="ae iq" href="https://pypi.org/project/pip/" rel="noopener ugc nofollow" target="_blank"> pip </a>的python包管理器。如果你正在构建一个python库，那么很有可能你也会把它发布给Conda。否则，Conda用户不会从你的库受益，这对你和你的用户都是不利的。Conda文档一步一步地介绍了<a class="ae iq" href="https://docs.conda.io/projects/conda-build/en/latest/user-guide/tutorials/build-pkgs.html" rel="noopener ugc nofollow" target="_blank">如何从头开始将python包发布到Conda</a>。但是如果你以前没有康达出版的经验，那么你将会面临很多麻烦，官方文档对你没有太大的帮助。在这里，我将详细解释每一个步骤，这将有助于澄清你所有的问题。</p><h1 id="10b1" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">你需要什么？</h1><p id="2818" class="pw-post-body-paragraph ir is hi it b iu kn iw ix iy ko ja jb jc kp je jf jg kq ji jj jk kr jm jn jo hb bi translated">您需要在您的构建环境中安装这些工具。</p><ol class=""><li id="743a" class="ks kt hi it b iu iv iy iz jc ku jg kv jk kw jo kx ky kz la bi translated"><a class="ae iq" href="https://docs.conda.io/en/latest/miniconda.html#miniconda" rel="noopener ugc nofollow" target="_blank">迷你康达</a></li><li id="3b70" class="ks kt hi it b iu lb iy lc jc ld jg le jk lf jo kx ky kz la bi translated"><a class="ae iq" href="https://docs.conda.io/projects/conda-build/en/latest/install-conda-build.html" rel="noopener ugc nofollow" target="_blank">康达制造</a></li><li id="f2a8" class="ks kt hi it b iu lb iy lc jc ld jg le jk lf jo kx ky kz la bi translated"><a class="ae iq" href="https://docs.anaconda.com/anacondaorg/user-guide/getting-started/#building-and-uploading-packages" rel="noopener ugc nofollow" target="_blank">蟒蛇客户端</a></li></ol><h1 id="7143" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">开始吧！</h1><p id="56a7" class="pw-post-body-paragraph ir is hi it b iu kn iw ix iy ko ja jb jc kp je jf jg kq ji jj jk kr jm jn jo hb bi translated">假设我要将名为<code class="du lg lh li lj b">my-py-lib</code>的库发布给Conda。</p><p id="5d9a" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">最重要的任务是为python库准备<code class="du lg lh li lj b">meta.yaml</code>文件。这是除<code class="du lg lh li lj b"><a class="ae iq" href="https://docs.python.org/3/distutils/setupscript.html" rel="noopener ugc nofollow" target="_blank">setup.py</a></code>文件外，康达出版唯一需要的文件。是的，文档上说<code class="du lg lh li lj b">build.sh</code>和<code class="du lg lh li lj b">build.bat</code>也是必需的，但是相信我这不是！您可以使用用于pip的相同的<code class="du lg lh li lj b">setup.py</code>文件来发布到Conda。您可以将<code class="du lg lh li lj b">meta.yaml</code>文件放在任何您想要的地方。但是在项目的根目录下创建一个名为conda(或者您喜欢的任何其他名称)的新目录并将<code class="du lg lh li lj b">meta.yaml</code>放在其中总是一个好主意。这是我的项目结构。</p><pre class="lk ll lm ln fd lo lj lp lq aw lr bi"><span id="584d" class="ls jq hi lj b fi lt lu l lv lw">.<br/>|-conda<br/>| |-meta.yaml<br/>|-setup.py</span></pre><p id="1a84" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">下面是将Python包发布到Conda所需的最少的<code class="du lg lh li lj b">meta.yaml</code>文件。</p><h2 id="aa64" class="ls jq hi bd jr lx ly lz jv ma mb mc jz jc md me kd jg mf mg kh jk mh mi kl mj bi translated">meta.yaml</h2><pre class="lk ll lm ln fd lo lj lp lq aw lr bi"><span id="4a5c" class="ls jq hi lj b fi lt lu l lv lw">package:<br/>  name: "my-py-lib"<br/>  version: "0.1.0"</span><span id="3f6f" class="ls jq hi lj b fi mk lu l lv lw">about:<br/>  summary: "This is an awesome Python library"</span><span id="21f7" class="ls jq hi lj b fi mk lu l lv lw">source:<br/>  path: ..</span><span id="ec99" class="ls jq hi lj b fi mk lu l lv lw">build:<br/>  script: python setup.py install</span></pre><p id="8914" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">要点:</p><ul class=""><li id="22a8" class="ks kt hi it b iu iv iy iz jc ku jg kv jk kw jo ml ky kz la bi translated"><code class="du lg lh li lj b">source.path</code> -应该是你的<code class="du lg lh li lj b">meta.yaml</code>到<code class="du lg lh li lj b">setup.py</code>文件<em class="mm">的相对路径。</em></li><li id="3d0e" class="ks kt hi it b iu lb iy lc jc ld jg le jk lf jo ml ky kz la bi translated"><code class="du lg lh li lj b">build.script</code>——是构建python发行版的命令。这可以根据您的项目而变化。</li></ul><p id="efa7" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">现在，您已经准备好将您的包发布到conda。执行此命令从项目根目录构建发行版。</p><pre class="lk ll lm ln fd lo lj lp lq aw lr bi"><span id="a855" class="ls jq hi lj b fi lt lu l lv lw">conda build --output-folder ./conda-out/ ./conda/</span></pre><p id="be1f" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated"><code class="du lg lh li lj b">conda build</code>的输入参数应该是你的<code class="du lg lh li lj b">meta.yaml</code>文件所在的目录。</p><p id="5b3f" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">如果您在构建环境中启用了anaconda upload，这将在成功构建包之后将它上传到anaconda。如果您禁用了anaconda upload，那么您可能需要运行下面的命令来将发行版上传到anaconda(根据需要更新tar.bz2包的路径。如果你以前没有从你的命令行登录过anaconda，那么你必须首先按照这里的<a class="ae iq" href="https://docs.anaconda.com/anacondaorg/user-guide/getting-started/#building-and-uploading-packages" rel="noopener ugc nofollow" target="_blank">所描述的</a>来设置它。</p><pre class="lk ll lm ln fd lo lj lp lq aw lr bi"><span id="f43a" class="ls jq hi lj b fi lt lu l lv lw">anaconda upload ./conda-out/osx-64/my-py-lib-0.1.0-0.tar.bz2</span></pre><p id="d225" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">恭喜你！您的包现在应该可以在Anaconda中找到了。让我们深入了解一些高级配置选项，在将您的包发布到conda时，您可能需要这些选项。</p><h1 id="918b" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">为多个python版本构建</h1><p id="f955" class="pw-post-body-paragraph ir is hi it b iu kn iw ix iy ko ja jb jc kp je jf jg kq ji jj jk kr jm jn jo hb bi translated">您的库可能有一些特殊的需求，您需要在运行时使用与构建时相同的python版本。让我们假设你使用的是python 3.8，你需要安装一个你的库的变体，这个库是用同一个python版本3.8构建的。这可以通过<a class="ae iq" href="https://docs.conda.io/projects/conda-build/en/latest/resources/variants.html#general-pinning-examples" rel="noopener ugc nofollow" target="_blank">版本锁定</a>来实现。文件<code class="du lg lh li lj b">conda_build_config.yaml</code>将让你轻松做到这一点。</p><h2 id="57b5" class="ls jq hi bd jr lx ly lz jv ma mb mc jz jc md me kd jg mf mg kh jk mh mi kl mj bi translated">conda _ build _配置. yaml</h2><p id="e081" class="pw-post-body-paragraph ir is hi it b iu kn iw ix iy ko ja jb jc kp je jf jg kq ji jj jk kr jm jn jo hb bi translated">在<code class="du lg lh li lj b">meta.yaml</code>文件所在的目录下创建一个名为<code class="du lg lh li lj b">conda_build_config.yaml</code>的文件。当除了<code class="du lg lh li lj b">meta.yaml</code>之外还有更多文件时，为conda特定文件创建一个单独的目录(在我的例子中是<code class="du lg lh li lj b">conda</code>目录)会很方便。这是我的<code class="du lg lh li lj b">conda_build_config.yaml</code></p><pre class="lk ll lm ln fd lo lj lp lq aw lr bi"><span id="de97" class="ls jq hi lj b fi lt lu l lv lw">python_version:<br/>  - 3.7<br/>  - 3.8<br/>  - 3.9</span></pre><p id="f9cc" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">我希望我的库分别为python 3.7、3.8和3.9版本构建。然后你必须在你的<code class="du lg lh li lj b">meta.yaml</code>中引用这些python版本。下面是我更新的<code class="du lg lh li lj b">meta.yaml</code>。</p><pre class="lk ll lm ln fd lo lj lp lq aw lr bi"><span id="e823" class="ls jq hi lj b fi lt lu l lv lw">package:<br/>  name: "my-py-lib"<br/>  version: "0.1.0"</span><span id="9674" class="ls jq hi lj b fi mk lu l lv lw">about:<br/>  summary: "This is an awesome Python library"<br/>  <br/>requirements:<br/>  build:<br/>    - python={{ python_version }}</span><span id="80e1" class="ls jq hi lj b fi mk lu l lv lw">  run:<br/>    - python={{ python_version }}</span><span id="e36f" class="ls jq hi lj b fi mk lu l lv lw">source:<br/>  path: ..</span><span id="3173" class="ls jq hi lj b fi mk lu l lv lw">build:<br/>  script: python setup.py install<br/>  string: py{{ python_version | replace(".", "") }}</span></pre><p id="0403" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">如果您还想固定其他依赖项的版本，那么您也可以将它们包含在<code class="du lg lh li lj b">meta.yaml</code>和<code class="du lg lh li lj b">conda_build_config.yaml</code>中。现在，如果您运行<code class="du lg lh li lj b">conda build</code>命令，您将在输出目录中看到多个构建变体。如果你愿意，你可以通过改变<code class="du lg lh li lj b">meta.yaml</code>中的<code class="du lg lh li lj b">build.string</code>来修改构建变体的命名模式。</p><h1 id="079d" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">为多个平台构建</h1><p id="bcee" class="pw-post-body-paragraph ir is hi it b iu kn iw ix iy ko ja jb jc kp je jf jg kq ji jj jk kr jm jn jo hb bi translated">您可能已经注意到，当您在上一节中执行<code class="du lg lh li lj b">conda build</code>时，您的构建工件应该已经创建在一个子目录中，该子目录具有您的构建环境的平台名称(即<code class="du lg lh li lj b">osx-64</code>、<code class="du lg lh li lj b">linux-64</code>)。这意味着在您将这个构建推送到anaconda之后，它只能由同一个平台下载。因此，如果你想支持多个平台，那么你必须将这个构建产品转换为其他平台，并再次上传到anaconda。您可以使用下面的命令轻松做到这一点。我在这里将为<code class="du lg lh li lj b">osx-64</code>建造的人工制品转换为<code class="du lg lh li lj b">linux-64</code>。</p><pre class="lk ll lm ln fd lo lj lp lq aw lr bi"><span id="a8c5" class="ls jq hi lj b fi lt lu l lv lw">conda convert --platform linux-64 ./conda-out/osx-64/my-py-lib-0.1.0-0.tar.bz2  -o ./conda-out</span></pre><p id="0394" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">那你得重新上传这个。</p><pre class="lk ll lm ln fd lo lj lp lq aw lr bi"><span id="7a3f" class="ls jq hi lj b fi lt lu l lv lw">anaconda upload ./conda-out/linux-64/my-py-lib-0.1.0-0.tar.bz2</span></pre><p id="dfd9" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">你可以在这里找到所有支持的平台<a class="ae iq" href="https://docs.conda.io/projects/conda-build/en/latest/resources/commands/conda-convert.html" rel="noopener ugc nofollow" target="_blank"/>。但是，当且仅当您的库是平台相关的时，您必须这样做。如果不是，你可以通过如下更新你的<code class="du lg lh li lj b">meta.yaml</code>的<code class="du lg lh li lj b">build</code>部分，把它构建成一个<a class="ae iq" href="https://docs.conda.io/projects/conda-build/en/latest/resources/define-metadata.html#architecture-independent-packages" rel="noopener ugc nofollow" target="_blank">架构独立的包</a>。查看<a class="ae iq" href="https://docs.conda.io/projects/conda-build/en/latest/resources/define-metadata.html#architecture-independent-packages" rel="noopener ugc nofollow" target="_blank">文档</a>了解更多选项。</p><pre class="lk ll lm ln fd lo lj lp lq aw lr bi"><span id="9199" class="ls jq hi lj b fi lt lu l lv lw"><strong class="lj hj">build</strong>:<br/>  <strong class="lj hj">noarch</strong>: python</span></pre><h1 id="833d" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">在meta.yaml中使用变量</h1><p id="a23b" class="pw-post-body-paragraph ir is hi it b iu kn iw ix iy ko ja jb jc kp je jf jg kq ji jj jk kr jm jn jo hb bi translated">在定义您的<code class="du lg lh li lj b">meta.yaml</code>时，可能有很多情况需要定义变量和读取环境变量。感谢<code class="du lg lh li lj b">meta.yaml</code>中<a class="ae iq" href="https://jinja.palletsprojects.com/en/2.11.x/" rel="noopener ugc nofollow" target="_blank"> Jinja2 </a>的支持，这才有可能。</p><h2 id="53ec" class="ls jq hi bd jr lx ly lz jv ma mb mc jz jc md me kd jg mf mg kh jk mh mi kl mj bi translated">使用环境变量</h2><pre class="lk ll lm ln fd lo lj lp lq aw lr bi"><span id="14e7" class="ls jq hi lj b fi lt lu l lv lw">package:<br/>  name: "my-py-lib"<br/>  version: "{{ VERSION }}"</span></pre><p id="a74f" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated"><code class="du lg lh li lj b">conda build</code>将在构建环境中寻找<code class="du lg lh li lj b">VERSION</code>环境变量作为版本值。</p><h2 id="a6f8" class="ls jq hi bd jr lx ly lz jv ma mb mc jz jc md me kd jg mf mg kh jk mh mi kl mj bi translated">阅读<code class="du lg lh li lj b">setup.py</code>参数。</h2><pre class="lk ll lm ln fd lo lj lp lq aw lr bi"><span id="5100" class="ls jq hi lj b fi lt lu l lv lw">{% set data = load_setup_py_data() %}<br/><br/>package:<br/>  name: "my-py-lib"<br/>  version: {{ data.get('version') }}</span></pre><p id="a598" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated"><code class="du lg lh li lj b">conda build</code>将提取<code class="du lg lh li lj b">setup.py</code>的<code class="du lg lh li lj b">version</code>字段的值作为版本值。</p><h1 id="b648" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">支持复杂的构建脚本</h1><p id="6368" class="pw-post-body-paragraph ir is hi it b iu kn iw ix iy ko ja jb jc kp je jf jg kq ji jj jk kr jm jn jo hb bi translated">如果您有一个复杂的构建脚本，您可以从<code class="du lg lh li lj b">meta.yaml</code>中删除<code class="du lg lh li lj b">build.script</code>部分，并创建一个单独的<code class="du lg lh li lj b">build.sh</code>文件。</p><h2 id="100f" class="ls jq hi bd jr lx ly lz jv ma mb mc jz jc md me kd jg mf mg kh jk mh mi kl mj bi translated">build.sh</h2><p id="0ae4" class="pw-post-body-paragraph ir is hi it b iu kn iw ix iy ko ja jb jc kp je jf jg kq ji jj jk kr jm jn jo hb bi translated">在<code class="du lg lh li lj b">meta.yaml</code>文件所在的目录下创建一个<code class="du lg lh li lj b">build.sh</code>文件。在这个文件中编写您的构建步骤。<code class="du lg lh li lj b">build.sh</code>仅适用于类似Unix的构建环境。如果您在Windows环境下构建，那么您必须创建一个符合Windows shell标准的<code class="du lg lh li lj b">build.bat</code>文件。查看Conda <a class="ae iq" href="https://docs.conda.io/projects/conda-build/en/latest/user-guide/tutorials/build-pkgs.html#writing-the-build-script-files-build-sh-and-bld-bat" rel="noopener ugc nofollow" target="_blank">文档</a>了解更多信息。</p><pre class="lk ll lm ln fd lo lj lp lq aw lr bi"><span id="11ae" class="ls jq hi lj b fi lt lu l lv lw">#!/usr/bin/env bash<strong class="lj hj"><br/></strong>$PYTHON setup.py install</span></pre><h1 id="0366" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">额外注释</h1><ul class=""><li id="bf68" class="ks kt hi it b iu kn iy ko jc mn jg mo jk mp jo ml ky kz la bi translated">有关<code class="du lg lh li lj b">meta.yaml</code> - <a class="ae iq" href="https://docs.conda.io/projects/conda-build/en/latest/resources/define-metadata.html#" rel="noopener ugc nofollow" target="_blank">定义元数据</a>的完整语法参考</li><li id="0fa1" class="ks kt hi it b iu lb iy lc jc ld jg le jk lf jo ml ky kz la bi translated">关于<code class="du lg lh li lj b">conda_build_config.yaml</code> - <a class="ae iq" href="https://docs.conda.io/projects/conda-build/exn/latest/resources/variants.html" rel="noopener ugc nofollow" target="_blank">构建变体的更多详细信息</a></li><li id="1e86" class="ks kt hi it b iu lb iy lc jc ld jg le jk lf jo ml ky kz la bi translated">如果你正在使用Github动作，有许多<a class="ae iq" href="https://github.com/marketplace?type=actions&amp;query=publish+conda" rel="noopener ugc nofollow" target="_blank">预建动作</a>。</li></ul></div></div>    
</body>
</html>