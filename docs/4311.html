<html>
<head>
<title>The Learning Rate Finder</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">学习率查找器</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/the-learning-rate-finder-9203fdc67c92?source=collection_archive---------5-----------------------#2021-09-21">https://medium.com/analytics-vidhya/the-learning-rate-finder-9203fdc67c92?source=collection_archive---------5-----------------------#2021-09-21</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="a245" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">使用学习率查找器改进我们的深度学习模型</h2></div><figure class="iy iz ja jb fd jc er es paragraph-image"><div class="er es ix"><img src="../Images/a39050597b05416b0cb07677a7cd009d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1242/format:webp/1*mO7YTrbH3Ss2CHefXllOYA.png"/></div><figcaption class="jf jg et er es jh ji bd b be z dx translated">该图是使用《Fastai &amp; PyTorch程序员深度学习》一书中提供的代码创建的</figcaption></figure><p id="1daf" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi kf translated"><span class="l kg kh ki bm kj kk kl km kn di"> L </span>收益率是一个非常重要的超参数，因为它控制着模型学习的速率或速度。我们如何找到一个不太高也不太低的完美学习率？Lesile Smith (2015)提出了一个想法，叫做学习率搜索器。他的想法是从一个非常非常小的学习率开始，然后逐渐提高。学习率永远不会变得太高而难以处理。自1950年以来，神经网络一直在开发中，但学习率搜索器直到2015年才出现。在此之前，找到一个好的学习率是深度学习从业者最重要的任务。</p><p id="e430" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">我们将通过编写一个对宠物品种进行分类的例子来执行这个想法。就在几年前，这种分类问题被认为是一项具有挑战性的任务。然而，今天它变得太容易了！感谢fastai和其他类似的库。完整代码请访问GitHub链接:<a class="ae ko" href="https://github.com/Adeelzafar/My-Version-of-Fastai-Course/blob/main/PET_Breed_Prediction.ipynb" rel="noopener ugc nofollow" target="_blank">https://GitHub . com/Adeelzafar/My-Version-of-Fastai-Course/blob/main/PET _ Breed _ prediction . ipynb</a></p></div><div class="ab cl kp kq gp kr" role="separator"><span class="ks bw bk kt ku kv"/><span class="ks bw bk kt ku kv"/><span class="ks bw bk kt ku"/></div><div class="hb hc hd he hf"><h1 id="d893" class="kw kx hi bd ky kz la lb lc ld le lf lg io lh ip li ir lj is lk iu ll iv lm ln bi translated">导入必要的库</h1><pre class="iy iz ja jb fd lo lp lq lr aw ls bi"><span id="3045" class="lt kx hi lp b fi lu lv l lw lx">from fastbook import *<br/>from fastai.vision.all import *</span></pre><h1 id="6897" class="kw kx hi bd ky kz ly lb lc ld lz lf lg io ma ip li ir mb is lk iu mc iv lm ln bi translated">加载和解包PETS数据集</h1><p id="b353" class="pw-post-body-paragraph jj jk hi jl b jm md ij jo jp me im jr js mf ju jv jw mg jy jz ka mh kc kd ke hb bi translated">fastai库提供了Pets数据集。让我们打开它并检查文件的路径。</p><pre class="iy iz ja jb fd lo lp lq lr aw ls bi"><span id="528a" class="lt kx hi lp b fi lu lv l lw lx">path = untar_data(URLs.PETS)</span><span id="7382" class="lt kx hi lp b fi mi lv l lw lx">path.ls()</span></pre><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="er es mj"><img src="../Images/b7dd53f02800aaf2cf10fd1692c4bc73.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IrTGEcj8rgDBzmZpxe2fng.png"/></div></div></figure><pre class="iy iz ja jb fd lo lp lq lr aw ls bi"><span id="b3d3" class="lt kx hi lp b fi lu lv l lw lx">(path/'images').ls()</span></pre><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="er es mo"><img src="../Images/3235575336ac1b3068986c9e114dd25b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7d78uHOqj6xaboOvnyubow.png"/></div></div></figure><pre class="iy iz ja jb fd lo lp lq lr aw ls bi"><span id="67da" class="lt kx hi lp b fi lu lv l lw lx">fname = (path/'images').ls()[0]<br/>fname</span></pre><figure class="iy iz ja jb fd jc er es paragraph-image"><div class="er es mp"><img src="../Images/fb31a2822a532294f45c10f4d45351cd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1318/format:webp/1*nnRED6z8wVXcJZl9lwIlbA.png"/></div></figure><h1 id="d5de" class="kw kx hi bd ky kz ly lb lc ld lz lf lg io ma ip li ir mb is lk iu mc iv lm ln bi translated">创建数据块</h1><p id="3ae0" class="pw-post-body-paragraph jj jk hi jl b jm md ij jo jp me im jr js mf ju jv jw mg jy jz ka mh kc kd ke hb bi translated">首先，我们将创建一个正则表达式。这个表达式提取出所有导致最后一个下划线的字符。后续字符是数字，然后是JPEG扩展名。<em class="mq"> RegexLabeller </em>类用于标记正则表达式。</p><pre class="iy iz ja jb fd lo lp lq lr aw ls bi"><span id="1dbb" class="lt kx hi lp b fi lu lv l lw lx">re.findall(r'(.+)_\d+.jpg$', fname.name)</span></pre><figure class="iy iz ja jb fd jc er es paragraph-image"><div class="er es mr"><img src="../Images/0dd217ecba27849bd0c5ee3bb26524c4.png" data-original-src="https://miro.medium.com/v2/resize:fit:230/format:webp/1*N-8Hw1M7ac3URZTJEEncEg.png"/></div></figure><pre class="iy iz ja jb fd lo lp lq lr aw ls bi"><span id="9101" class="lt kx hi lp b fi lu lv l lw lx">pets = DataBlock(blocks= (ImageBlock, CategoryBlock),<br/>                 get_items= get_image_files,<br/>                 splitter = RandomSplitter(seed= 42),<br/>                 get_y=using_attr(RegexLabeller(r'(.+)_\d+.jpg$'), 'name'),</span></pre></div><div class="ab cl kp kq gp kr" role="separator"><span class="ks bw bk kt ku kv"/><span class="ks bw bk kt ku kv"/><span class="ks bw bk kt ku"/></div><div class="hb hc hd he hf"><pre class="lo lp lq lr aw ls bi"><span id="f33b" class="lt kx hi lp b fi ms mt mu mv mw lv l lw lx">dls = pets.dataloaders(path/'images')</span></pre></div><div class="ab cl kp kq gp kr" role="separator"><span class="ks bw bk kt ku kv"/><span class="ks bw bk kt ku kv"/><span class="ks bw bk kt ku"/></div><div class="hb hc hd he hf"><pre class="lo lp lq lr aw ls bi"><span id="8220" class="lt kx hi lp b fi ms mt mu mv mw lv l lw lx">dls.show_batch(nrows = 1, ncols= 3)</span></pre><figure class="iy iz ja jb fd jc er es paragraph-image"><div class="er es mx"><img src="../Images/0d4092f3faa0fbbd665993dfcfa2355b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1348/format:webp/1*xVJ8zT91upnD3TXL-3tSKg.png"/></div></figure><h1 id="a949" class="kw kx hi bd ky kz ly lb lc ld lz lf lg io ma ip li ir mb is lk iu mc iv lm ln bi translated">微调我们的Resnet模型</h1><p id="4df2" class="pw-post-body-paragraph jj jk hi jl b jm md ij jo jp me im jr js mf ju jv jw mg jy jz ka mh kc kd ke hb bi translated">对于我们的初始测试，我们将执行一个简单的resnet模型，然后我们将使用不同的学习率来微调我们的模型。</p><pre class="iy iz ja jb fd lo lp lq lr aw ls bi"><span id="e527" class="lt kx hi lp b fi lu lv l lw lx">learn = cnn_learner(dls, resnet34, metrics= error_rate)<br/>learn.fine_tune(2)</span></pre><figure class="iy iz ja jb fd jc er es paragraph-image"><div class="er es my"><img src="../Images/c753faf1d0042d7ab080b42fdf503503.png" data-original-src="https://miro.medium.com/v2/resize:fit:860/format:webp/1*ToyZnyliZLr0mfzowxOHsw.png"/></div></figure><h1 id="4efb" class="kw kx hi bd ky kz ly lb lc ld lz lf lg io ma ip li ir mb is lk iu mc iv lm ln bi translated">评估和改进我们的模型</h1><p id="fef3" class="pw-post-body-paragraph jj jk hi jl b jm md ij jo jp me im jr js mf ju jv jw mg jy jz ka mh kc kd ke hb bi translated">模型解释是非常重要的一步。让我们可视化一个混淆矩阵来研究错误分类的例子。我们还将通过我们的模型看到最混乱的分类示例。</p><pre class="iy iz ja jb fd lo lp lq lr aw ls bi"><span id="7a9e" class="lt kx hi lp b fi lu lv l lw lx">interp = ClassificationInterpretation.from_learner(learn)<br/>interp.plot_confusion_matrix(figsize=(12, 12))</span></pre><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="er es mz"><img src="../Images/c1927ca5e3865de3bea39e73e5d64257.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wdbMk4TWBxsNedu69aJLMw.png"/></div></div></figure><pre class="iy iz ja jb fd lo lp lq lr aw ls bi"><span id="a048" class="lt kx hi lp b fi lu lv l lw lx">interp.plot_top_losses(2, nrows=2)</span></pre><figure class="iy iz ja jb fd jc er es paragraph-image"><div class="er es na"><img src="../Images/80ceebe08f394698397c8c437389ad17.png" data-original-src="https://miro.medium.com/v2/resize:fit:844/format:webp/1*0FKJtpJBJjiAPx5_S1uo1A.png"/></div></figure><pre class="iy iz ja jb fd lo lp lq lr aw ls bi"><span id="eea0" class="lt kx hi lp b fi lu lv l lw lx">interp.most_confused(min_val=5)</span></pre><figure class="iy iz ja jb fd jc er es paragraph-image"><div class="er es nb"><img src="../Images/947cbadee30176fc85ab774bd6f1cfc3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1380/format:webp/1*L22J28QieIbOstNVcfXmuw.png"/></div></figure><h1 id="da9e" class="kw kx hi bd ky kz ly lb lc ld lz lf lg io ma ip li ir mb is lk iu mc iv lm ln bi translated">学习率查找器</h1><p id="0e55" class="pw-post-body-paragraph jj jk hi jl b jm md ij jo jp me im jr js mf ju jv jw mg jy jz ka mh kc kd ke hb bi translated">因此，让我们深入到问题最重要的部分:<strong class="jl hj"> <em class="mq">找到一个合适的学习率</em> </strong>。如果学习率太低，模型需要许多代才能收敛。另一方面，如果学习率太高，模型最终会波动。让我们使用默认(高)学习率来训练我们的模型。</p><pre class="iy iz ja jb fd lo lp lq lr aw ls bi"><span id="4cce" class="lt kx hi lp b fi lu lv l lw lx">learn = cnn_learner(dls, resnet34, metrics=error_rate)<br/>learn.fine_tune(1, base_lr=0.1)</span></pre><figure class="iy iz ja jb fd jc er es paragraph-image"><div class="er es nc"><img src="../Images/cc1b66642bcaa1d3f9f218d1c8a61bcb.png" data-original-src="https://miro.medium.com/v2/resize:fit:834/format:webp/1*hyHAOvum7_iT3fJe5kbVlA.png"/></div></figure><p id="f70b" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">我们的模型性能下降，优化器超过了最小损失。我们的学习率搜索器来帮忙了。学习率探测器计算最小、陡峭、滑动和山谷。这给了我们一个确定最佳学习率的好主意。</p><pre class="iy iz ja jb fd lo lp lq lr aw ls bi"><span id="cd59" class="lt kx hi lp b fi lu lv l lw lx">learn = cnn_learner(dls, resnet34, metrics=error_rate)<br/>lr_min, lr_steep, lr_slide, lr_valley = learn.lr_find(suggest_funcs=(minimum, steep, slide, valley))</span></pre><figure class="iy iz ja jb fd jc er es paragraph-image"><div class="er es nd"><img src="../Images/b64ac82193a3b898bd024a50c092d31f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1008/format:webp/1*QFZ-0d7sZl-Jb64XwLC_RA.png"/></div></figure><p id="b2f4" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">从学习率查找器中，我们选择最陡点作为基本学习率。我们没有选择最小值，因为此时模型不再学习。</p><pre class="iy iz ja jb fd lo lp lq lr aw ls bi"><span id="085b" class="lt kx hi lp b fi lu lv l lw lx">learn = cnn_learner(dls, resnet34, metrics=error_rate)<br/>learn.fine_tune(2, base_lr=3e-3)</span></pre><figure class="iy iz ja jb fd jc er es paragraph-image"><div class="er es ne"><img src="../Images/2d3e11dab5623b7e3cc2e25aa2cfb548.png" data-original-src="https://miro.medium.com/v2/resize:fit:838/format:webp/1*hDoPcJ48EcVrccgspnLzzw.png"/></div></figure><p id="5d0f" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">我们可以清楚地看到错误率下降了。这改进了我们的模型，但我们还可以进一步改进。我们也可以使用<em class="mq">区别学习率</em>。<em class="mq">区别学习率</em>为我们预训练模型的深层和最后一层设置不同的学习率。在我们接下来的工作中，我们将讨论<em class="mq">区别学习率。</em>下次见……快乐编码</p><h1 id="11d2" class="kw kx hi bd ky kz ly lb lc ld lz lf lg io ma ip li ir mb is lk iu mc iv lm ln bi translated">信用</h1><p id="38ed" class="pw-post-body-paragraph jj jk hi jl b jm md ij jo jp me im jr js mf ju jv jw mg jy jz ka mh kc kd ke hb bi translated">本文内容的灵感来自于杰瑞米·霍华德和西尔万·古格的《fastai &amp; PyTorch程序员深度学习》。</p></div></div>    
</body>
</html>