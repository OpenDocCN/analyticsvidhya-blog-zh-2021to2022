<html>
<head>
<title>Spark Classification model to predict titanic survivors</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">预测泰坦尼克号幸存者的火花分类模型</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/spark-classification-model-to-predict-titanic-survivors-e91ab1685f2e?source=collection_archive---------7-----------------------#2021-07-09">https://medium.com/analytics-vidhya/spark-classification-model-to-predict-titanic-survivors-e91ab1685f2e?source=collection_archive---------7-----------------------#2021-07-09</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><h1 id="90d2" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated">Spark码预测分类实用数据集——泰坦尼克号幸存者数据集</h1><h1 id="50d1" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated">用例</h1><ul class=""><li id="55a6" class="jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt bi translated">使用泰坦尼克号数据集</li><li id="3808" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">数据集位于名为Titanic.csv的文件夹中</li><li id="c74d" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">将数据集上传到Azure存储</li></ul><h1 id="9170" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated">先决条件</h1><ul class=""><li id="3e23" class="jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt bi translated">Azure帐户</li><li id="322b" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">Azure存储帐户</li><li id="fdf5" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">创建一个名为titanic的容器，并将Titanic.csv文件上传到容器</li><li id="3074" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">创建Azure数据块资源</li><li id="0472" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">创建azure密钥库</li><li id="1826" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">将主键存储到秘密中</li><li id="e4d4" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">将密钥库配置为azure数据块</li></ul><h1 id="3e3b" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated">密码</h1><ul class=""><li id="9867" class="jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt bi translated">首先让我们包括库</li></ul><pre class="jz ka kb kc fd kd ke kf kg aw kh bi"><span id="004d" class="ki if hh ke b fi kj kk l kl km">from pyspark.ml import Pipeline<br/>from pyspark.ml.classification import RandomForestClassifier<br/>from pyspark.ml.feature import IndexToString, StringIndexer, VectorIndexer<br/>from pyspark.ml.evaluation import MulticlassClassificationEvaluator<br/>from pyspark.sql import functions as f</span></pre><ul class=""><li id="74bf" class="jc jd hh je b jf kn jh ko jj kp jl kq jn kr jp jq jr js jt bi translated">从keyvault加载机密</li></ul><pre class="jz ka kb kc fd kd ke kf kg aw kh bi"><span id="67e6" class="ki if hh ke b fi kj kk l kl km">storagekey = dbutils.secrets.get(scope = "allsecrects", key = "storagekey")</span></pre><ul class=""><li id="73c6" class="jc jd hh je b jf kn jh ko jj kp jl kq jn kr jp jq jr js jt bi translated">现在配置存储帐户</li></ul><pre class="jz ka kb kc fd kd ke kf kg aw kh bi"><span id="261e" class="ki if hh ke b fi kj kk l kl km">spark.conf.set(<br/>  "fs.azure.account.key.storageaccountname.blob.core.windows.net",<br/>  storagekey)</span></pre><ul class=""><li id="9cc6" class="jc jd hh je b jf kn jh ko jj kp jl kq jn kr jp jq jr js jt bi translated">现在加载数据</li></ul><pre class="jz ka kb kc fd kd ke kf kg aw kh bi"><span id="fcea" class="ki if hh ke b fi kj kk l kl km">titanicds = spark.read.option("header","true").option("inferSchema", "true").csv("wasbs://titanic@storageacctname.blob.core.windows.net/Titanic.csv")</span></pre><ul class=""><li id="7b98" class="jc jd hh je b jf kn jh ko jj kp jl kq jn kr jp jq jr js jt bi translated">显示数据集</li></ul><pre class="jz ka kb kc fd kd ke kf kg aw kh bi"><span id="626e" class="ki if hh ke b fi kj kk l kl km">display(titanicds)</span></pre><figure class="jz ka kb kc fd kt er es paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="er es ks"><img src="../Images/1a53620a6d9921c17d7cabffac96a334.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZFpyHS0DIAfUGFLr4jIu1Q.jpeg"/></div></div></figure><ul class=""><li id="3699" class="jc jd hh je b jf kn jh ko jj kp jl kq jn kr jp jq jr js jt bi translated">显示数据集的架构</li></ul><pre class="jz ka kb kc fd kd ke kf kg aw kh bi"><span id="f697" class="ki if hh ke b fi kj kk l kl km">display(titanicds.printSchema())</span></pre><ul class=""><li id="779f" class="jc jd hh je b jf kn jh ko jj kp jl kq jn kr jp jq jr js jt bi translated">只有5列应为字符串，其余所有列应为数字</li><li id="8dac" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">为空值填充0</li></ul><pre class="jz ka kb kc fd kd ke kf kg aw kh bi"><span id="7b4c" class="ki if hh ke b fi kj kk l kl km">titanicds1 = titanicds.na.fill(0)<br/>display(titanicds1)</span></pre><figure class="jz ka kb kc fd kt er es paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="er es la"><img src="../Images/d298a858c8dc3ae7654dea754c39d742.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*o-YB5J5eJCHVQ-G7qv27Gg.jpeg"/></div></div></figure><ul class=""><li id="b291" class="jc jd hh je b jf kn jh ko jj kp jl kq jn kr jp jq jr js jt bi translated">将所有分类列转换为字符串索引</li></ul><pre class="jz ka kb kc fd kd ke kf kg aw kh bi"><span id="749a" class="ki if hh ke b fi kj kk l kl km">categoricalColumns = [item[0] for item in titanicds1.dtypes if item[1].startswith('string') ]</span></pre><ul class=""><li id="88eb" class="jc jd hh je b jf kn jh ko jj kp jl kq jn kr jp jq jr js jt bi translated">用所有其他数字列创建一个列名</li></ul><pre class="jz ka kb kc fd kd ke kf kg aw kh bi"><span id="aa8f" class="ki if hh ke b fi kj kk l kl km">featurescol = ["PassengerId", "Survived", "Pclass", "Age", "SibSp", "Parch", "Fare"]</span></pre><ul class=""><li id="cd26" class="jc jd hh je b jf kn jh ko jj kp jl kq jn kr jp jq jr js jt bi translated">创建阶段</li><li id="03a1" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">我们将组合字符串索引器和数字列来形成组合特征</li></ul><pre class="jz ka kb kc fd kd ke kf kg aw kh bi"><span id="80d6" class="ki if hh ke b fi kj kk l kl km">stages = []<br/>#iterate through all categorical values<br/>for categoricalCol in categoricalColumns:<br/>    #create a string indexer for those categorical values and assign a new name including the word 'Index'<br/>    stringIndexer = StringIndexer(inputCol = categoricalCol, outputCol = categoricalCol + 'Index')<br/><br/>    #append the string Indexer to our list of stages<br/>    stages += [stringIndexer]</span></pre><figure class="jz ka kb kc fd kt er es paragraph-image"><div class="er es lb"><img src="../Images/ddbc0585d5d46f9fe833c4a9590eed61.png" data-original-src="https://miro.medium.com/v2/resize:fit:1372/format:webp/1*ClEeblzG1S1AOW_M5vI0wg.jpeg"/></div></figure><ul class=""><li id="96bc" class="jc jd hh je b jf kn jh ko jj kp jl kq jn kr jp jq jr js jt bi translated">现在创建标签索引器</li><li id="5eb3" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">为数字数据创建向量汇编程序。</li><li id="d17e" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">将所有这些添加到阶段</li><li id="5bc9" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">训练模型</li><li id="7e9e" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">用测试数据预测模型</li><li id="f5d5" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">打印精确度</li></ul><pre class="jz ka kb kc fd kd ke kf kg aw kh bi"><span id="4528" class="ki if hh ke b fi kj kk l kl km">labelIndexer = StringIndexer(inputCol="Survived", outputCol="indexedLabel").fit(titanicds1)<br/><br/>#assembler = VectorAssembler(inputCols=featurescol, outputCol="features")<br/>assembler = VectorAssembler(inputCols=featurescol, outputCol="features")<br/><br/>#featureIndexer = VectorIndexer(inputCol="features", outputCol="indexedFeatures", maxCategories=4).fit(titanicds1)<br/><br/><br/>(trainingData, testData) = titanicds1.randomSplit([0.7, 0.3])<br/><br/># Train a RandomForest model.<br/>rf = RandomForestClassifier(labelCol="indexedLabel", featuresCol="features", numTrees=10)<br/><br/># Convert indexed labels back to original labels.<br/>labelConverter = IndexToString(inputCol="prediction", outputCol="predictedLabel",<br/>                               labels=labelIndexer.labels)<br/><br/><br/># Chain indexers and forest in a Pipeline<br/>#pipeline = Pipeline(stages=[labelIndexer, assembler, rf, labelConverter])<br/>stages += [labelIndexer]<br/>stages += [assembler]<br/>stages += [rf]<br/>stages += [labelConverter]<br/><br/>pipeline = Pipeline(stages=stages)<br/><br/># Train model.  This also runs the indexers.<br/>model = pipeline.fit(trainingData)<br/><br/># Make predictions.<br/>predictions = model.transform(testData)<br/><br/># Select example rows to display.<br/>predictions.select("predictedLabel", "Survived", "features").show(5)<br/><br/># Select (prediction, true label) and compute test error<br/>evaluator = MulticlassClassificationEvaluator(<br/>    labelCol="indexedLabel", predictionCol="prediction", metricName="accuracy")<br/>accuracy = evaluator.evaluate(predictions)<br/>print("Accuracy = ", accuracy)<br/>print("Test Error = %g" % (1.0 - accuracy))<br/><br/>rfModel = model.stages[2]<br/>print(rfModel)  # summary only</span></pre><ul class=""><li id="aa71" class="jc jd hh je b jf kn jh ko jj kp jl kq jn kr jp jq jr js jt bi translated">输出</li></ul><figure class="jz ka kb kc fd kt er es paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="er es lc"><img src="../Images/95fa1230607e2b355cf0f94a60004b9c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TEpk_5CdZoNf3_i8iC93kw.jpeg"/></div></div></figure><p id="ccc9" class="pw-post-body-paragraph ld le hh je b jf kn lf lg jh ko lh li jj lj lk ll jl lm ln lo jn lp lq lr jp ha bi translated">原文<a class="ae ls" href="https://github.com/balakreshnan/Samples2021/blob/main/SparkML/titanicsample.md" rel="noopener ugc nofollow" target="_blank">samples 2021/titanic sample . MD at main balakreshnan/samples 2021(github.com)</a></p></div></div>    
</body>
</html>