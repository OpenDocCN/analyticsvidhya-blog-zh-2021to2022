<html>
<head>
<title>Creating a Google Data Studio community connector from scratch</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">从头开始创建Google Data Studio社区连接器</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/creating-a-google-data-studio-community-connector-from-scratch-6e6c32624469?source=collection_archive---------0-----------------------#2021-09-28">https://medium.com/analytics-vidhya/creating-a-google-data-studio-community-connector-from-scratch-6e6c32624469?source=collection_archive---------0-----------------------#2021-09-28</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><div class=""><h2 id="1481" class="pw-subtitle-paragraph ie hg hh bd b if ig ih ii ij ik il im in io ip iq ir is it iu iv dx translated">本文向您展示了如何编写自己的<strong class="ak">data studio community connector，然后创建一个datasource </strong>，它将调用一个带有基本身份验证的自定义<strong class="ak">API</strong>来为Google DataStudio报告检索数据。</h2></div><figure class="ix iy iz ja fd jb er es paragraph-image"><div role="button" tabindex="0" class="jc jd di je bf jf"><div class="er es iw"><img src="../Images/aace6c76dd2beab8164ec21c584da2bc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qUe_NpXEQkA8a7nIiUKpMQ.png"/></div></div><figcaption class="ji jj et er es jk jl bd b be z dx translated">作者的照片——没有比非洲子集更好的了，发现山地自行车手；-)</figcaption></figure><p id="c9c1" class="pw-post-body-paragraph jm jn hh jo b jp jq ii jr js jt il ju jv jw jx jy jz ka kb kc kd ke kf kg kh ha bi translated">DataStudio是一个很好的平台，可以可视化机器学习的结果及其免费的<strong class="jo hi"/>。BigQuery和其他营销类型的数据集有很好的连接器。</p><blockquote class="ki kj kk"><p id="1dff" class="jm jn kl jo b jp jq ii jr js jt il ju km jw jx jy kn ka kb kc ko ke kf kg kh ha bi translated">但是如果你想连接到你自己的网络服务呢？</p></blockquote><p id="8803" class="pw-post-body-paragraph jm jn hh jo b jp jq ii jr js jt il ju jv jw jx jy jz ka kb kc kd ke kf kg kh ha bi translated">除了一些非常基本的例子之外，我到处寻找关于定制连接器的好文章。我希望这篇文章能帮助你一步一步地完成整个过程。</p></div><div class="ab cl kp kq go kr" role="separator"><span class="ks bw bk kt ku kv"/><span class="ks bw bk kt ku kv"/><span class="ks bw bk kt ku"/></div><div class="ha hb hc hd he"><p id="33fe" class="pw-post-body-paragraph jm jn hh jo b jp jq ii jr js jt il ju jv jw jx jy jz ka kb kc kd ke kf kg kh ha bi translated">本文将涵盖以下主题:</p><ol class=""><li id="e5f4" class="kw kx hh jo b jp jq js jt jv ky jz kz kd la kh lb lc ld le bi translated">调查要调用的web服务</li><li id="7c84" class="kw kx hh jo b jp lf js lg jv lh jz li kd lj kh lb lc ld le bi translated">设置应用程序脚本连接器<br/>2 . a getConfig<br/>2 . b get schema<br/>2 . c getAuthType<br/>2 . d get data<br/>2 . e将所有这些放在一起</li><li id="7fd8" class="kw kx hh jo b jp lf js lg jv lh jz li kd lj kh lb lc ld le bi translated">设置清单文件</li><li id="9ca6" class="kw kx hh jo b jp lf js lg jv lh jz li kd lj kh lb lc ld le bi translated">展开连接器</li><li id="c0a2" class="kw kx hh jo b jp lf js lg jv lh jz li kd lj kh lb lc ld le bi translated">创建新的数据源</li><li id="3ac1" class="kw kx hh jo b jp lf js lg jv lh jz li kd lj kh lb lc ld le bi translated">创建新报告</li><li id="8826" class="kw kx hh jo b jp lf js lg jv lh jz li kd lj kh lb lc ld le bi translated">怎么调试？</li></ol><h1 id="a20b" class="lk ll hh bd lm ln lo lp lq lr ls lt lu in lv io lw iq lx ir ly it lz iu ma mb bi translated">1.调查要调用的web服务</h1><p id="4af0" class="pw-post-body-paragraph jm jn hh jo b jp mc ii jr js md il ju jv me jx jy jz mf kb kc kd mg kf kg kh ha bi translated">正如您从下面的邮递员调用中看到的，我们正在调用一个具有基本身份验证的web服务。注意我们得到的JSON结构。</p><p id="8bf8" class="pw-post-body-paragraph jm jn hh jo b jp jq ii jr js jt il ju jv jw jx jy jz ka kb kc kd ke kf kg kh ha bi translated">我们的目标是创建一个社区连接器，然后创建一个data studio数据源，调用下面的web服务。</p><blockquote class="ki kj kk"><p id="a4b5" class="jm jn kl jo b jp jq ii jr js jt il ju km jw jx jy kn ka kb kc ko ke kf kg kh ha bi translated">如您所见，我们的web服务需要一个<strong class="jo hi"> supplierID </strong>作为参数。</p></blockquote><figure class="ix iy iz ja fd jb er es paragraph-image"><div role="button" tabindex="0" class="jc jd di je bf jf"><div class="er es mh"><img src="../Images/56f10f2a6202339474d46789e07fecb9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WgBSyDs73MYtwMjaQV0-sA.png"/></div></div></figure><h1 id="1f3e" class="lk ll hh bd lm ln lo lp lq lr ls lt lu in lv io lw iq lx ir ly it lz iu ma mb bi translated">2.设置应用程序脚本连接器</h1><p id="8c1c" class="pw-post-body-paragraph jm jn hh jo b jp mc ii jr js md il ju jv me jx jy jz mf kb kc kd mg kf kg kh ha bi translated">这一部分将被分成几个小节。我们将在<a class="ae mi" href="https://script.google.com/" rel="noopener ugc nofollow" target="_blank">https://script.google.com/</a>创建一个新的脚本，并创建一个新的项目。</p><figure class="ix iy iz ja fd jb er es paragraph-image"><div role="button" tabindex="0" class="jc jd di je bf jf"><div class="er es mj"><img src="../Images/5000053eb707ab52d9ee36e21818cd79.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ATrFZV9X_MuAxVD4csng_g.png"/></div></div></figure><p id="4679" class="pw-post-body-paragraph jm jn hh jo b jp jq ii jr js jt il ju jv jw jx jy jz ka kb kc kd ke kf kg kh ha bi translated">现在您已经创建了第一个脚本项目，所以让我们继续添加DataStudio数据源需要的函数。</p><p id="ff1f" class="pw-post-body-paragraph jm jn hh jo b jp jq ii jr js jt il ju jv jw jx jy jz ka kb kc kd ke kf kg kh ha bi translated">下面是我们需要编写的几个函数</p><ul class=""><li id="9873" class="kw kx hh jo b jp jq js jt jv ky jz kz kd la kh mk lc ld le bi translated">getConfig() —设置数据源的配置</li><li id="6967" class="kw kx hh jo b jp lf js lg jv lh jz li kd lj kh mk lc ld le bi translated">get schema()-设置字段名称和类型</li><li id="6d3f" class="kw kx hh jo b jp lf js lg jv lh jz li kd lj kh mk lc ld le bi translated">getAuthType() —身份验证的类型</li><li id="bf8c" class="kw kx hh jo b jp lf js lg jv lh jz li kd lj kh mk lc ld le bi translated">getData() —将调用我们的web服务来获取我们的数据</li></ul><p id="1131" class="pw-post-body-paragraph jm jn hh jo b jp jq ii jr js jt il ju jv jw jx jy jz ka kb kc kd ke kf kg kh ha bi translated">编辑Code.js，删除其内容并继续下面的操作。</p><h2 id="f51b" class="ml ll hh bd lm mm mn mo lq mp mq mr lu jv ms mt lw jz mu mv ly kd mw mx ma my bi translated">2 .一个getConfig()</h2><p id="2c8d" class="pw-post-body-paragraph jm jn hh jo b jp mc ii jr js md il ju jv me jx jy jz mf kb kc kd mg kf kg kh ha bi translated">使用这个函数来设置我们的配置，因为我们需要数据源包含一个supplierID参数，所以我们现在就设置它。web服务将在其SQL查询中使用该参数。</p><pre class="ix iy iz ja fd mz na nb nc aw nd bi"><span id="effa" class="ml ll hh na b fi ne nf l ng nh">function getConfig() {<br/>  var config = cc.getConfig();</span><span id="b556" class="ml ll hh na b fi ni nf l ng nh">  config<br/>      .newTextInput()<br/>      .setId("supplierID")<br/>      .setName("supplierID")<br/>      .setAllowOverride(true);</span><span id="1885" class="ml ll hh na b fi ni nf l ng nh">  return config.build();<br/>}</span></pre><h2 id="b602" class="ml ll hh bd lm mm mn mo lq mp mq mr lu jv ms mt lw jz mu mv ly kd mw mx ma my bi translated">2.b getSchema()</h2><p id="cf83" class="pw-post-body-paragraph jm jn hh jo b jp mc ii jr js md il ju jv me jx jy jz mf kb kc kd mg kf kg kh ha bi translated">使用此函数定义模式。注意，我们创建了一个getFields函数来设置我们的字段，以及它们相应的类型。当创建数据源来设置字段时，会调用这个函数。</p><blockquote class="ki kj kk"><p id="a3de" class="jm jn kl jo b jp jq ii jr js jt il ju km jw jx jy kn ka kb kc ko ke kf kg kh ha bi translated">将上面的邮递员截图与下面创建的字段进行比较</p></blockquote><pre class="ix iy iz ja fd mz na nb nc aw nd bi"><span id="09a7" class="ml ll hh na b fi ne nf l ng nh">function getFields() {<br/>  var fields = cc.getFields();<br/>  var types = cc.FieldType;<br/>  var aggregations = cc.AggregationType;</span><span id="e56d" class="ml ll hh na b fi ni nf l ng nh">fields<br/>    .newDimension()<br/>    .setId('AccountID')<br/>    .setName('AccountID')<br/>    .setType(types.TEXT);</span><span id="b133" class="ml ll hh na b fi ni nf l ng nh">fields<br/>    .newDimension()<br/>    .setId('BranchID')<br/>    .setName('BranchID')<br/>    .setType(types.TEXT);</span><span id="4cd7" class="ml ll hh na b fi ni nf l ng nh">fields<br/>    .newDimension()<br/>    .setId('Name')<br/>    .setName('Name')<br/>    .setType(types.TEXT);</span><span id="f6f5" class="ml ll hh na b fi ni nf l ng nh">fields<br/>    .newDimension()<br/>    .setId('UserField01')<br/>    .setName('UserField01')<br/>    .setType(types.TEXT);</span><span id="a6e9" class="ml ll hh na b fi ni nf l ng nh">fields<br/>    .newDimension()<br/>    .setId('Province')<br/>    .setName('Province')<br/>    .setType(types.TEXT);</span><span id="8bb3" class="ml ll hh na b fi ni nf l ng nh">fields<br/>    .newDimension()<br/>    .setId('Latitude')<br/>    .setName('Latitude')<br/>    .setType(types.NUMBER);</span><span id="2f13" class="ml ll hh na b fi ni nf l ng nh">fields<br/>    .newDimension()<br/>    .setId('Longitude')<br/>    .setName('Longitude')<br/>    .setType(types.NUMBER);</span><span id="224f" class="ml ll hh na b fi ni nf l ng nh">fields<br/>    .newDimension()<br/>    .setId('location')<br/>    .setName('location')<br/>    .setType(types.LATITUDE_LONGITUDE);</span><span id="093a" class="ml ll hh na b fi ni nf l ng nh">fields<br/>    .newMetric()<br/>    .setId('RepID')<br/>    .setName('RepID')<br/>    .setType(types.NUMBER)</span><span id="c3c9" class="ml ll hh na b fi ni nf l ng nh">fields<br/>    .newMetric()<br/>    .setId('RepID1')<br/>    .setName('RepID1')<br/>    .setType(types.NUMBER)</span><span id="8d01" class="ml ll hh na b fi ni nf l ng nh">fields<br/>    .newMetric()<br/>    .setId('cluster1')<br/>    .setName('cluster1')<br/>    .setType(types.NUMBER)</span><span id="c097" class="ml ll hh na b fi ni nf l ng nh">fields<br/>    .newMetric()<br/>    .setId('cluster2')<br/>    .setName('cluster2')<br/>    .setType(types.NUMBER)</span><span id="dcf3" class="ml ll hh na b fi ni nf l ng nh">fields<br/>    .newMetric()<br/>    .setId('RepID2')<br/>    .setName('RepID2')<br/>    .setType(types.NUMBER)</span><span id="0299" class="ml ll hh na b fi ni nf l ng nh">fields<br/>    .newMetric()<br/>    .setId('outlier')<br/>    .setName('outlier')<br/>    .setType(types.TEXT)<br/>  <br/>  fields<br/>    .newMetric()<br/>    .setId('cluster3')<br/>    .setName('cluster3')<br/>    .setType(types.NUMBER)</span><span id="1743" class="ml ll hh na b fi ni nf l ng nh">fields<br/>    .newMetric()<br/>    .setId('RepID3')<br/>    .setName('RepID3')<br/>    .setType(types.NUMBER)</span><span id="5fb6" class="ml ll hh na b fi ni nf l ng nh">return fields;<br/>}<br/> <br/>function getSchema(request) {<br/>  return {schema: getFields().build()};<br/>}</span></pre><h2 id="5a21" class="ml ll hh bd lm mm mn mo lq mp mq mr lu jv ms mt lw jz mu mv ly kd mw mx ma my bi translated">2.c授权功能</h2><p id="c092" class="pw-post-body-paragraph jm jn hh jo b jp mc ii jr js md il ju jv me jx jy jz mf kb kc kd mg kf kg kh ha bi translated">我们需要几个函数来处理授权，让我们总结一下:</p><ul class=""><li id="268e" class="kw kx hh jo b jp jq js jt jv ky jz kz kd la kh mk lc ld le bi translated"><strong class="jo hi"> getAuthType </strong> —设置我们将需要用于基本认证的用户/密码用于基本认证。</li><li id="71fa" class="kw kx hh jo b jp lf js lg jv lh jz li kd lj kh mk lc ld le bi translated"><strong class="jo hi"> resetAuth </strong> —如果我们需要在DataStudio的数据源中重新输入凭证，重置数据源上的授权。</li><li id="ab10" class="kw kx hh jo b jp lf js lg jv lh jz li kd lj kh mk lc ld le bi translated"><strong class="jo hi"> isAuthValid </strong> —从设置中获取用户/密码，并通过调用validateCredentials函数来确认凭证是否正确。</li></ul><pre class="ix iy iz ja fd mz na nb nc aw nd bi"><span id="5a90" class="ml ll hh na b fi ne nf l ng nh">/**<br/> * Called when datasource is setup, we set to user/password<br/> */<br/>function getAuthType() {<br/>  console.log("message")<br/>  var AuthTypes = cc.AuthType;<br/>  return cc<br/>    .newAuthTypeResponse()<br/>    .setAuthType(AuthTypes.USER_PASS)<br/>    .build();<br/>}</span><span id="e9f0" class="ml ll hh na b fi ni nf l ng nh">/**<br/> * Resets the auth service.<br/> */<br/>function resetAuth() {<br/>  var userProperties = PropertiesService.getUserProperties();<br/>  userProperties.deleteProperty('dscc.username');<br/>  userProperties.deleteProperty('dscc.password');<br/>}</span><span id="0154" class="ml ll hh na b fi ni nf l ng nh">/**<br/> * Returns true if the auth service has access.<br/> */<br/>function isAuthValid() {<br/>  const usernameAndPassword = loadCurrentUsernameAndPassword();<br/>  return usernameAndPassword.username &amp;&amp; usernameAndPassword.password &amp;&amp; validateCredentials(usernameAndPassword.username, usernameAndPassword.password)<br/>};</span><span id="0c60" class="ml ll hh na b fi ni nf l ng nh">/**<br/> * Loads user/password from properties<br/> */<br/>function loadCurrentUsernameAndPassword() {<br/>  const properties = PropertiesService.getUserProperties();<br/>  return {<br/>    username: properties.getProperty('dscc.username'),<br/>    password: properties.getProperty('dscc.password')<br/>  }<br/>};</span><span id="3589" class="ml ll hh na b fi ni nf l ng nh">/**<br/> * Sets the credentials in properties and checks if valid.<br/> */<br/>function setCredentials(request) {<br/>  var creds = request.userPass;<br/>  var username = creds.username;<br/>  var password = creds.password;</span><span id="0e97" class="ml ll hh na b fi ni nf l ng nh">// Optional<br/>  // Check if the provided username and password are valid through a<br/>  // call to your service. You would have to have a `checkForValidCreds`<br/>  // function defined for this to work.<br/>  var validCreds = checkForValidCreds(username, password);<br/>  if (!validCreds) {<br/>    return {<br/>      errorCode: 'INVALID_CREDENTIALS'<br/>    };<br/>  }<br/>  var userProperties = PropertiesService.getUserProperties();<br/>  userProperties.setProperty('dscc.username', username);<br/>  userProperties.setProperty('dscc.password', password);<br/>  return {<br/>    errorCode: 'NONE'<br/>  };<br/>}</span><span id="2965" class="ml ll hh na b fi ni nf l ng nh">/**<br/> * Saves username/password to properties<br/> */<br/>function storeUsernameAndPassword(username, password) {<br/>  PropertiesService<br/>    .getUserProperties()<br/>    .setProperty('dscc.username', username)<br/>    .setProperty('dscc.password', password);<br/>};</span><span id="a237" class="ml ll hh na b fi ni nf l ng nh">// Not used<br/>function checkForValidCreds(username, password) {<br/>  return true;<br/>}</span><span id="d279" class="ml ll hh na b fi ni nf l ng nh">/**<br/> * Call our web service to check if credentials are valid<br/> */<br/>function validateCredentials(username, password) {<br/>  var rawResponse = UrlFetchApp.fetch('<a class="ae mi" href="http://citric-optics-107909.appspot.com/user/get'" rel="noopener ugc nofollow" target="_blank">http://zzzzz.appspot.com/user/get'</a>, {<br/>    method: 'GET',<br/>    headers: {<br/>      'Authorization': 'Basic ' + Utilities.base64Encode(username + ':' + password)<br/>    },<br/>    muteHttpExceptions: true<br/>  });</span><span id="04c0" class="ml ll hh na b fi ni nf l ng nh">return rawResponse.getResponseCode() &lt; 205;<br/>}</span></pre><h2 id="a553" class="ml ll hh bd lm mm mn mo lq mp mq mr lu jv ms mt lw jz mu mv ly kd mw mx ma my bi translated">2d。getData()</h2><p id="c6c8" class="pw-post-body-paragraph jm jn hh jo b jp mc ii jr js md il ju jv me jx jy jz mf kb kc kd mg kf kg kh ha bi translated">我们现在需要3个函数来获取数据。如果您愿意，我们可以在一个函数中完成所有这些操作。</p><ul class=""><li id="0a6c" class="kw kx hh jo b jp jq js jt jv ky jz kz kd la kh mk lc ld le bi translated"><strong class="jo hi"> getData() </strong> —被调用以从我们的web服务获取数据</li><li id="cd98" class="kw kx hh jo b jp lf js lg jv lh jz li kd lj kh mk lc ld le bi translated"><strong class="jo hi"> fetchDataFromAPI() </strong> —调用实际的web服务</li><li id="a16c" class="kw kx hh jo b jp lf js lg jv lh jz li kd lj kh mk lc ld le bi translated"><strong class="jo hi"> getFormattedData() </strong> —查找DataStudio报告要求的请求字段，并仅返回这些字段。<em class="kl">例如，报告可能只需要10个字段中的2个。</em></li></ul><pre class="ix iy iz ja fd mz na nb nc aw nd bi"><span id="3b20" class="ml ll hh na b fi ne nf l ng nh">function getData(request) {  <br/>  try {<br/>    // get list of fields in report<br/>    var requestedFields = request.fields.map(function(row){<br/>      return row.name;<br/>    })</span><span id="2f72" class="ml ll hh na b fi ni nf l ng nh">// Prepare the schema for the fields requested.<br/>    var dataSchema = [];<br/>    var fixedSchema = getSchema().schema;<br/>    request.fields.forEach(function(field) {<br/>      for (var i = 0; i &lt; fixedSchema.length; i++) {<br/>        if (fixedSchema[i].name == field.name) {<br/>          dataSchema.push(fixedSchema[i]);<br/>          break;<br/>        }<br/>      }<br/>    });</span><span id="0f04" class="ml ll hh na b fi ni nf l ng nh">// fetch and prepare data<br/>    var apiResponse = fetchDataFromApi(request);<br/>    var data = getFormattedData(JSON.parse(apiResponse), requestedFields);</span><span id="1113" class="ml ll hh na b fi ni nf l ng nh">// build result<br/>    var result = {<br/>      schema: dataSchema,<br/>      rows: data<br/>    };<br/>    // throw(JSON.stringify(result))<br/>    return result;<br/>  } catch (e) {<br/>    cc.newUserError()<br/>      .setDebugText('Error fetching data from API. Exception details: ' + e)<br/>      .setText(<br/>        'The connector has encountered an unrecoverable error. Please try again later, or file an issue if this error persists.'<br/>      )<br/>      .throwException();<br/>  }<br/>}</span><span id="8a9e" class="ml ll hh na b fi ni nf l ng nh">function fetchDataFromApi(request) {<br/>  // get credentials<br/>  var userProperties = PropertiesService.getUserProperties();<br/>  var username = userProperties.getProperty('dscc.username');<br/>  var password = userProperties.getProperty('dscc.password');<br/>  <br/>  var url = [<br/>    '<a class="ae mi" href="https://citric-optics-107909.appspot.com/query/run?name=CaboodleSpreadResults&amp;format=json&amp;SupplierID='" rel="noopener ugc nofollow" target="_blank">https://zzzzzzz.appspot.com/query/run?name=CaboodleSpreadResults&amp;format=json&amp;SupplierID='</a>,<br/>    request.configParams.supplierID<br/>  ].join('');</span><span id="7263" class="ml ll hh na b fi ni nf l ng nh">var response = UrlFetchApp.fetch(url, {<br/>    method: 'GET',<br/>    headers: {<br/>      'Authorization': 'Basic ' + Utilities.base64Encode(username + ':' + password)<br/>    },<br/>    muteHttpExceptions: true<br/>  });<br/>  return response;<br/>}</span><span id="461c" class="ml ll hh na b fi ni nf l ng nh">function getFormattedData(response, requestedFields) {<br/>  var data = [];<br/>  <br/>  //loop through to pick up requested fields<br/>  response.forEach(function(row) {<br/>    var values = [];<br/>    requestedFields.forEach(function(field) {<br/>      values.push(row[field])<br/>    });<br/>    data.push({<br/>      values: values<br/>    });<br/>  });<br/>  return data;<br/>}</span></pre><h1 id="c65f" class="lk ll hh bd lm ln lo lp lq lr ls lt lu in lv io lw iq lx ir ly it lz iu ma mb bi translated">2e。把所有的放在一起</h1><p id="da15" class="pw-post-body-paragraph jm jn hh jo b jp mc ii jr js md il ju jv me jx jy jz mf kb kc kd mg kf kg kh ha bi translated">以下是供您剪切和粘贴的全套代码:</p><pre class="ix iy iz ja fd mz na nb nc aw nd bi"><span id="09bf" class="ml ll hh na b fi ne nf l ng nh">var cc = DataStudioApp.createCommunityConnector();</span><span id="1b5e" class="ml ll hh na b fi ni nf l ng nh">function getAuthType() {<br/>  console.log("message")<br/>  var AuthTypes = cc.AuthType;<br/>  return cc<br/>    .newAuthTypeResponse()<br/>    .setAuthType(AuthTypes.USER_PASS)<br/>    .build();<br/>}</span><span id="5c84" class="ml ll hh na b fi ni nf l ng nh">/**<br/> * Resets the auth service.<br/> */<br/>function resetAuth() {<br/>  var userProperties = PropertiesService.getUserProperties();<br/>  userProperties.deleteProperty('dscc.username');<br/>  userProperties.deleteProperty('dscc.password');<br/>}</span><span id="0650" class="ml ll hh na b fi ni nf l ng nh">/**<br/> * Returns true if the auth service has access.<br/> */<br/>function isAuthValid() {<br/>  const usernameAndPassword = loadCurrentUsernameAndPassword();<br/>  return usernameAndPassword.username &amp;&amp; usernameAndPassword.password &amp;&amp; validateCredentials(usernameAndPassword.username, usernameAndPassword.password)<br/>};</span><span id="956e" class="ml ll hh na b fi ni nf l ng nh">function loadCurrentUsernameAndPassword() {<br/>  const properties = PropertiesService.getUserProperties();<br/>  return {<br/>    username: properties.getProperty('dscc.username'),<br/>    password: properties.getProperty('dscc.password')<br/>  }<br/>};</span><span id="e7bb" class="ml ll hh na b fi ni nf l ng nh">/**<br/> * Sets the credentials.<br/> */<br/>function setCredentials(request) {<br/>  var creds = request.userPass;<br/>  var username = creds.username;<br/>  var password = creds.password;</span><span id="e1b1" class="ml ll hh na b fi ni nf l ng nh">// Optional<br/>  // Check if the provided username and password are valid through a<br/>  // call to your service. You would have to have a `checkForValidCreds`<br/>  // function defined for this to work.<br/>  var validCreds = checkForValidCreds(username, password);<br/>  if (!validCreds) {<br/>    return {<br/>      errorCode: 'INVALID_CREDENTIALS'<br/>    };<br/>  }<br/>  var userProperties = PropertiesService.getUserProperties();<br/>  userProperties.setProperty('dscc.username', username);<br/>  userProperties.setProperty('dscc.password', password);<br/>  return {<br/>    errorCode: 'NONE'<br/>  };<br/>}</span><span id="7867" class="ml ll hh na b fi ni nf l ng nh">function storeUsernameAndPassword(username, password) {<br/>  PropertiesService<br/>    .getUserProperties()<br/>    .setProperty('dscc.username', username)<br/>    .setProperty('dscc.password', password);<br/>};</span><span id="492e" class="ml ll hh na b fi ni nf l ng nh">// not used<br/>function checkForValidCreds(username, password) {<br/>  return true;<br/>}</span><span id="e275" class="ml ll hh na b fi ni nf l ng nh">function validateCredentials(username, password) {<br/>  var rawResponse = UrlFetchApp.fetch('<a class="ae mi" href="http://citric-optics-107909.appspot.com/user/get'" rel="noopener ugc nofollow" target="_blank">http://zzzzz.appspot.com/user/get'</a>, {<br/>    method: 'GET',<br/>    headers: {<br/>      'Authorization': 'Basic ' + Utilities.base64Encode(username + ':' + password)<br/>    },<br/>    muteHttpExceptions: true<br/>  });</span><span id="9cd9" class="ml ll hh na b fi ni nf l ng nh">return rawResponse.getResponseCode() &lt; 205;<br/>}</span><span id="01f3" class="ml ll hh na b fi ni nf l ng nh">function getConfig() {<br/>  var config = cc.getConfig();</span><span id="5578" class="ml ll hh na b fi ni nf l ng nh">config<br/>      .newTextInput()<br/>      .setId("supplierID")<br/>      .setName("supplierID")<br/>      .setAllowOverride(true);</span><span id="6493" class="ml ll hh na b fi ni nf l ng nh">return config.build();<br/>}</span><span id="d431" class="ml ll hh na b fi ni nf l ng nh">function getFields() {<br/>  var fields = cc.getFields();<br/>  var types = cc.FieldType;<br/>  var aggregations = cc.AggregationType;</span><span id="e0df" class="ml ll hh na b fi ni nf l ng nh">fields<br/>    .newDimension()<br/>    .setId('AccountID')<br/>    .setName('AccountID')<br/>    .setType(types.TEXT);</span><span id="682a" class="ml ll hh na b fi ni nf l ng nh">fields<br/>    .newDimension()<br/>    .setId('BranchID')<br/>    .setName('BranchID')<br/>    .setType(types.TEXT);</span><span id="25ca" class="ml ll hh na b fi ni nf l ng nh">fields<br/>    .newDimension()<br/>    .setId('Name')<br/>    .setName('Name')<br/>    .setType(types.TEXT);</span><span id="986a" class="ml ll hh na b fi ni nf l ng nh">fields<br/>    .newDimension()<br/>    .setId('UserField01')<br/>    .setName('UserField01')<br/>    .setType(types.TEXT);</span><span id="f741" class="ml ll hh na b fi ni nf l ng nh">fields<br/>    .newDimension()<br/>    .setId('Province')<br/>    .setName('Province')<br/>    .setType(types.TEXT);</span><span id="33b3" class="ml ll hh na b fi ni nf l ng nh">fields<br/>    .newDimension()<br/>    .setId('Latitude')<br/>    .setName('Latitude')<br/>    .setType(types.NUMBER);</span><span id="ed29" class="ml ll hh na b fi ni nf l ng nh">fields<br/>    .newDimension()<br/>    .setId('Longitude')<br/>    .setName('Longitude')<br/>    .setType(types.NUMBER);</span><span id="11e7" class="ml ll hh na b fi ni nf l ng nh">fields<br/>    .newDimension()<br/>    .setId('location')<br/>    .setName('location')<br/>    .setType(types.LATITUDE_LONGITUDE);</span><span id="e6a3" class="ml ll hh na b fi ni nf l ng nh">fields<br/>    .newMetric()<br/>    .setId('RepID')<br/>    .setName('RepID')<br/>    .setType(types.NUMBER)</span><span id="7938" class="ml ll hh na b fi ni nf l ng nh">fields<br/>    .newMetric()<br/>    .setId('RepID1')<br/>    .setName('RepID1')<br/>    .setType(types.NUMBER)</span><span id="8f34" class="ml ll hh na b fi ni nf l ng nh">fields<br/>    .newMetric()<br/>    .setId('cluster1')<br/>    .setName('cluster1')<br/>    .setType(types.NUMBER)</span><span id="0338" class="ml ll hh na b fi ni nf l ng nh">fields<br/>    .newMetric()<br/>    .setId('cluster2')<br/>    .setName('cluster2')<br/>    .setType(types.NUMBER)</span><span id="8233" class="ml ll hh na b fi ni nf l ng nh">fields<br/>    .newMetric()<br/>    .setId('RepID2')<br/>    .setName('RepID2')<br/>    .setType(types.NUMBER)</span><span id="0d60" class="ml ll hh na b fi ni nf l ng nh">fields<br/>    .newMetric()<br/>    .setId('outlier')<br/>    .setName('outlier')<br/>    .setType(types.TEXT)<br/>  <br/>  fields<br/>    .newMetric()<br/>    .setId('cluster3')<br/>    .setName('cluster3')<br/>    .setType(types.NUMBER)</span><span id="5ab3" class="ml ll hh na b fi ni nf l ng nh">fields<br/>    .newMetric()<br/>    .setId('RepID3')<br/>    .setName('RepID3')<br/>    .setType(types.NUMBER)</span><span id="11eb" class="ml ll hh na b fi ni nf l ng nh">return fields;<br/>}<br/> <br/>function getSchema(request) {<br/>  return {schema: getFields().build()};<br/>}</span><span id="077b" class="ml ll hh na b fi ni nf l ng nh">function getData(request) {<br/>  //request.configParams = validateConfig(request.configParams);<br/>  <br/>  try {<br/>    // get list of fields in report<br/>    var requestedFields = request.fields.map(function(row){<br/>      return row.name;<br/>    })</span><span id="f303" class="ml ll hh na b fi ni nf l ng nh">// Prepare the schema for the fields requested.<br/>    var dataSchema = [];<br/>    var fixedSchema = getSchema().schema;<br/>    request.fields.forEach(function(field) {<br/>      for (var i = 0; i &lt; fixedSchema.length; i++) {<br/>        if (fixedSchema[i].name == field.name) {<br/>          dataSchema.push(fixedSchema[i]);<br/>          break;<br/>        }<br/>      }<br/>    });</span><span id="2201" class="ml ll hh na b fi ni nf l ng nh">// fetch and prepare data<br/>    var apiResponse = fetchDataFromApi(request);<br/>    var data = getFormattedData(JSON.parse(apiResponse), requestedFields);</span><span id="5004" class="ml ll hh na b fi ni nf l ng nh">// build result<br/>    var result = {<br/>      schema: dataSchema,<br/>      rows: data<br/>    };<br/>    // throw(JSON.stringify(result))<br/>    return result;<br/>  } catch (e) {<br/>    cc.newUserError()<br/>      .setDebugText('Error fetching data from API. Exception details: ' + e)<br/>      .setText(<br/>        'The connector has encountered an unrecoverable error. Please try again later, or file an issue if this error persists.'<br/>      )<br/>      .throwException();<br/>  }<br/>}</span><span id="ef4b" class="ml ll hh na b fi ni nf l ng nh">function fetchDataFromApi(request) {<br/>  // get credentials<br/>  var userProperties = PropertiesService.getUserProperties();<br/>  var username = userProperties.getProperty('dscc.username');<br/>  var password = userProperties.getProperty('dscc.password');<br/>  <br/>  var url = [<br/>    '<a class="ae mi" href="https://citric-optics-107909.appspot.com/query/run?name=CaboodleSpreadResults&amp;format=json&amp;SupplierID='" rel="noopener ugc nofollow" target="_blank">https://zz.zzzzz.com/query/run?name=CaboodleSpreadResults&amp;format=json&amp;SupplierID='</a>,<br/>    request.configParams.supplierID<br/>  ].join('');<br/>  var response = UrlFetchApp.fetch(url, {<br/>    method: 'GET',<br/>    headers: {<br/>      'Authorization': 'Basic ' + Utilities.base64Encode(username + ':' + password)<br/>    },<br/>    muteHttpExceptions: true<br/>  });<br/>  return response;<br/>}</span><span id="6517" class="ml ll hh na b fi ni nf l ng nh">function getFormattedData(response, requestedFields) {<br/>  var data = [];<br/>  <br/>  console.log(response)<br/>  response.forEach(function(row) {<br/>    var values = [];<br/>    requestedFields.forEach(function(field) {<br/>      values.push(row[field])<br/>    });<br/>    data.push({<br/>      values: values<br/>    });<br/>  });<br/>  return data;<br/>}</span><span id="353d" class="ml ll hh na b fi ni nf l ng nh">function isAdminUser() {<br/>  return true;<br/>}</span></pre><h1 id="6b27" class="lk ll hh bd lm ln lo lp lq lr ls lt lu in lv io lw iq lx ir ly it lz iu ma mb bi translated">3.设置清单文件</h1><p id="dc90" class="pw-post-body-paragraph jm jn hh jo b jp mc ii jr js md il ju jv me jx jy jz mf kb kc kd mg kf kg kh ha bi translated">在部署之前，我们需要设置一个清单文件。为此，请转到“设置”并在编辑器中显示清单。</p><figure class="ix iy iz ja fd jb er es paragraph-image"><div role="button" tabindex="0" class="jc jd di je bf jf"><div class="er es nj"><img src="../Images/38bd775bb176684173f6b00712a01d9f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Pdtu8cefKNX1tKTP4DIQQQ.png"/></div></div></figure><p id="fe0d" class="pw-post-body-paragraph jm jn hh jo b jp jq ii jr js jt il ju jv jw jx jy jz ka kb kc kd ke kf kg kh ha bi translated">现在，您将能够查看和编辑appscript.json清单文件</p><figure class="ix iy iz ja fd jb er es paragraph-image"><div role="button" tabindex="0" class="jc jd di je bf jf"><div class="er es nk"><img src="../Images/2296141b09aaa54eaf977d77464ddaec.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ff0vNCYp1NdeyD--U4ZECw.png"/></div></div></figure><p id="92e3" class="pw-post-body-paragraph jm jn hh jo b jp jq ii jr js jt il ju jv jw jx jy jz ka kb kc kd ke kf kg kh ha bi translated">你可以在JSON下面剪切粘贴，只需改变<strong class="jo hi">你的连接器</strong>，<strong class="jo hi">你的公司</strong> &amp; <strong class="jo hi">你的描述</strong>。</p><blockquote class="ki kj kk"><p id="2675" class="jm jn kl jo b jp jq ii jr js jt il ju km jw jx jy kn ka kb kc ko ke kf kg kh ha bi translated">一个很好的选择是通过将YourDefaultTemplate更改为使用该数据源的默认报表的ID来添加默认模板。</p></blockquote><pre class="ix iy iz ja fd mz na nb nc aw nd bi"><span id="d291" class="ml ll hh na b fi ne nf l ng nh">{<br/>"dataStudio": {<br/>"name": "YourConnector",<br/>"logoUrl": "https://raw.githubusercontent.com/npm/logos/master/npm%20square/n-64.png",<br/>"company": "YourCompany",<br/>"companyUrl": "https://caboodledata.com",<br/>"addonUrl": "https://github.com/googledatastudio/community-connectors/tree/master/npm-downloads#readme",<br/>"supportUrl": "https://github.com/googledatastudio/community-connectors/issues",<br/>"description": "Your description",<br/>"sources": ["npm"],<br/>"templates": {<br/>"default1": "YourDefaultTemplate"<br/>}<br/>},<br/>"oauthScopes": [<br/>"https://www.googleapis.com/auth/script.external_request"<br/>]<br/>}</span></pre><h1 id="1f04" class="lk ll hh bd lm ln lo lp lq lr ls lt lu in lv io lw iq lx ir ly it lz iu ma mb bi translated">4.展开连接器</h1><p id="16e5" class="pw-post-body-paragraph jm jn hh jo b jp mc ii jr js md il ju jv me jx jy jz mf kb kc kd mg kf kg kh ha bi translated">这有点奇怪，因为我还没有发现如何在新的编辑器中发布manifest。一旦我做到了，我会改变这一部分。所以现在，点击“使用传统编辑器”按钮。</p><blockquote class="ki kj kk"><p id="2aec" class="jm jn kl jo b jp jq ii jr js jt il ju km jw jx jy kn ka kb kc ko ke kf kg kh ha bi translated">不要担心，您现在只需要这样做来部署，然后您可以切换回新的编辑器</p></blockquote><figure class="ix iy iz ja fd jb er es paragraph-image"><div role="button" tabindex="0" class="jc jd di je bf jf"><div class="er es nl"><img src="../Images/85200eb71603044fd89f5f8e84a44207.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XU1sM4MJ78B-CxmTmqssvA.png"/></div></div></figure><p id="fc61" class="pw-post-body-paragraph jm jn hh jo b jp jq ii jr js jt il ju jv jw jx jy jz ka kb kc kd ke kf kg kh ha bi translated">您现在可以从publish菜单进行部署，如下所示。</p><figure class="ix iy iz ja fd jb er es paragraph-image"><div role="button" tabindex="0" class="jc jd di je bf jf"><div class="er es nm"><img src="../Images/9696aac6f55c258c36c2db86edf6c657.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nQByNQvYQTyX9uKoLHjL0Q.png"/></div></div></figure><p id="8d44" class="pw-post-body-paragraph jm jn hh jo b jp jq ii jr js jt il ju jv jw jx jy jz ka kb kc kd ke kf kg kh ha bi translated">现在，您将看到一个弹出窗口，您可以复制该链接。</p><blockquote class="ki kj kk"><p id="1154" class="jm jn kl jo b jp jq ii jr js jt il ju km jw jx jy kn ka kb kc ko ke kf kg kh ha bi translated">NB。通过使用此链接，您将创建一个新的数据源。所以每次使用它时，都会创建一个新的数据源。</p></blockquote><figure class="ix iy iz ja fd jb er es paragraph-image"><div role="button" tabindex="0" class="jc jd di je bf jf"><div class="er es nn"><img src="../Images/055d1c5fe64274a1df8124098d12c894.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uvhcfuzwz6SQfIW0yTSkBA.png"/></div></div></figure><h1 id="08f6" class="lk ll hh bd lm ln lo lp lq lr ls lt lu in lv io lw iq lx ir ly it lz iu ma mb bi translated">5.创建新的数据源</h1><p id="3bc6" class="pw-post-body-paragraph jm jn hh jo b jp mc ii jr js md il ju jv me jx jy jz mf kb kc kd mg kf kg kh ha bi translated">将上一步中的URL粘贴到您的浏览器中，现在您将开始创建新数据源的过程。</p><ol class=""><li id="f0d0" class="kw kx hh jo b jp jq js jt jv ky jz kz kd la kh lb lc ld le bi translated">输入supplierID，在我们的例子中，它来自getConfig()函数。</li><li id="560f" class="kw kx hh jo b jp lf js lg jv lh jz li kd lj kh lb lc ld le bi translated">请记下报告模板以备后用，您现在可以取消单击它。</li><li id="0d34" class="kw kx hh jo b jp lf js lg jv lh jz li kd lj kh lb lc ld le bi translated">按连接按钮。</li></ol><blockquote class="ki kj kk"><p id="bf3e" class="jm jn kl jo b jp jq ii jr js jt il ju km jw jx jy kn ka kb kc ko ke kf kg kh ha bi translated">NB。您还会被要求输入数据源用户名和密码。这将用于验证使用基本身份验证调用的web服务。</p><p id="8f4b" class="jm jn kl jo b jp jq ii jr js jt il ju km jw jx jy kn ka kb kc ko ke kf kg kh ha bi translated">NBB。所有使用此数据源的用户将共享这些凭证，因此请确保只与您信任的人共享数据源。</p></blockquote><p id="03f9" class="pw-post-body-paragraph jm jn hh jo b jp jq ii jr js jt il ju jv jw jx jy jz ka kb kc kd ke kf kg kh ha bi translated">输入供应商ID并点击连接。</p><figure class="ix iy iz ja fd jb er es paragraph-image"><div role="button" tabindex="0" class="jc jd di je bf jf"><div class="er es no"><img src="../Images/ee786e1a734619702a8520ba96cefdbb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UV19AKC83KO645GhSLmAHg.png"/></div></div></figure><p id="3eb4" class="pw-post-body-paragraph jm jn hh jo b jp jq ii jr js jt il ju jv jw jx jy jz ka kb kc kd ke kf kg kh ha bi translated">现在，您可以输入您的数据源名称并进行任何其他更改，单击add a report即可开始。</p><figure class="ix iy iz ja fd jb er es paragraph-image"><div role="button" tabindex="0" class="jc jd di je bf jf"><div class="er es np"><img src="../Images/479877e422cc8b8fd5c370c2f28f3fa1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Fa_l_mNhmKxLQp5XvswBYQ.png"/></div></div></figure><h1 id="a714" class="lk ll hh bd lm ln lo lp lq lr ls lt lu in lv io lw iq lx ir ly it lz iu ma mb bi translated">6.创建新报告</h1><p id="f77b" class="pw-post-body-paragraph jm jn hh jo b jp mc ii jr js md il ju jv me jx jy jz mf kb kc kd mg kf kg kh ha bi translated">现在，您可以开始创建您的报告，如下所示:</p><figure class="ix iy iz ja fd jb er es paragraph-image"><div role="button" tabindex="0" class="jc jd di je bf jf"><div class="er es nq"><img src="../Images/d03a3940ceac1d025c8c07c08912084a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VZW0Kp6Vx7BQtRn10Tat1w.png"/></div></div></figure><h1 id="1597" class="lk ll hh bd lm ln lo lp lq lr ls lt lu in lv io lw iq lx ir ly it lz iu ma mb bi translated">7.怎么调试？</h1><p id="df02" class="pw-post-body-paragraph jm jn hh jo b jp mc ii jr js md il ju jv me jx jy jz mf kb kc kd mg kf kg kh ha bi translated">因此，调试存在一些问题。第一个是确保将isAdmin设置为true，以便在生成错误时，可以在DataStudio中看到它们。</p><pre class="ix iy iz ja fd mz na nb nc aw nd bi"><span id="3f81" class="ml ll hh na b fi ne nf l ng nh">function isAdminUser() {<br/>  return true;<br/>}</span></pre><p id="ffb1" class="pw-post-body-paragraph jm jn hh jo b jp jq ii jr js jt il ju jv jw jx jy jz ka kb kc kd ke kf kg kh ha bi translated">现在，一定要处理好你的错误。所以回到getData()并注意抛出异常的try/catch。然后，这个异常会在DataStudio中显示给管理员用户，因此您可以跟踪错误。下面是一个抛出错误的例子。</p><pre class="ix iy iz ja fd mz na nb nc aw nd bi"><span id="7dc3" class="ml ll hh na b fi ne nf l ng nh">try {</span><span id="ea30" class="ml ll hh na b fi ni nf l ng nh">........</span><span id="4f29" class="ml ll hh na b fi ni nf l ng nh">} catch (e) {<br/>cc.newUserError()<br/>  .setDebugText('Error fetching data from API. Exception details: ' + e)</span><span id="4b63" class="ml ll hh na b fi ni nf l ng nh">  .setText('The connector has encountered an unrecoverable error. Please try again later, or file an issue if this error persists.')</span><span id="88f5" class="ml ll hh na b fi ni nf l ng nh">  .throwException();<br/>}</span></pre><blockquote class="ki kj kk"><p id="f7a8" class="jm jn kl jo b jp jq ii jr js jt il ju km jw jx jy kn ka kb kc ko ke kf kg kh ha bi translated">因此，正确的错误处理是你的最佳方法</p></blockquote><p id="7276" class="pw-post-body-paragraph jm jn hh jo b jp jq ii jr js jt il ju jv jw jx jy jz ka kb kc kd ke kf kg kh ha bi translated">您也可以按如下方式检查日志。如果您没有让它停留太久，那么您将会看到抛出的完整错误消息。</p><figure class="ix iy iz ja fd jb er es paragraph-image"><div role="button" tabindex="0" class="jc jd di je bf jf"><div class="er es nr"><img src="../Images/ccce548295367914067830d6fce8dd6d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0Dfb2qY0bFHEjaO6KxraBw.png"/></div></div></figure><h1 id="67c7" class="lk ll hh bd lm ln lo lp lq lr ls lt lu in lv io lw iq lx ir ly it lz iu ma mb bi translated">来源</h1><p id="9c34" class="pw-post-body-paragraph jm jn hh jo b jp mc ii jr js md il ju jv me jx jy jz mf kb kc kd mg kf kg kh ha bi translated">在构建我的连接器时，我发现这些非常有用:</p><ul class=""><li id="aff4" class="kw kx hh jo b jp jq js jt jv ky jz kz kd la kh mk lc ld le bi translated">【https://developers.google.com/datastudio/connector/build? T2】hl=en </li><li id="dc80" class="kw kx hh jo b jp lf js lg jv lh jz li kd lj kh mk lc ld le bi translated"><a class="ae mi" href="https://kidakaka.com/blog/2020/04/29/building-your-custom-connector-on-google-data-studio/" rel="noopener ugc nofollow" target="_blank">在谷歌数据工作室(kidakaka.com)上构建您的定制连接器</a></li></ul></div></div>    
</body>
</html>