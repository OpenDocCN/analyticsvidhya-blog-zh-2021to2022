<html>
<head>
<title>Parse Azure ADLS Gen2 Audit logs using Spark</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Spark解析Azure ADLS Gen2审计日志</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/parse-azure-adls-gen2-audit-logs-using-spark-8fcf61c45f3a?source=collection_archive---------13-----------------------#2021-01-01">https://medium.com/analytics-vidhya/parse-azure-adls-gen2-audit-logs-using-spark-8fcf61c45f3a?source=collection_archive---------13-----------------------#2021-01-01</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="930a" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">Azure Data Lake gen2存储的挑战之一是记录审计日志的能力。对于大多数Azure服务，我们有发送到日志分析的选项。由于这是存储，我们没有该选项，但我们可以将详细信息记录在同一存储中的$logs文件夹中。</p><p id="11f2" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">接下来是我们如何解析日志并进行分析或故障排除。本文更倾向于向您展示我们如何查看日志并进行简单的聚合。</p><p id="41c6" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">使用案例:</p><ul class=""><li id="f2a2" class="jc jd hh ig b ih ii il im ip je it jf ix jg jb jh ji jj jk bi translated">对于审计和法规遵从性，我们需要查看审计日志。</li><li id="451b" class="jc jd hh ig b ih jl il jm ip jn it jo ix jp jb jh ji jj jk bi translated">Azure ADLS gen2不发送到日志分析</li><li id="5f6c" class="jc jd hh ig b ih jl il jm ip jn it jo ix jp jb jh ji jj jk bi translated">ADLS gen2改为写入名为logs的容器</li><li id="e9fd" class="jc jd hh ig b ih jl il jm ip jn it jo ix jp jb jh ji jj jk bi translated">想要查看日志并对日志进行分析</li></ul><h1 id="bba5" class="jq jr hh bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">先决条件</h1><ul class=""><li id="d2b0" class="jc jd hh ig b ih ko il kp ip kq it kr ix ks jb jh ji jj jk bi translated">Azure帐户</li><li id="c37f" class="jc jd hh ig b ih jl il jm ip jn it jo ix jp jb jh ji jj jk bi translated">创造蔚蓝ADLS第二代</li><li id="78e7" class="jc jd hh ig b ih jl il jm ip jn it jo ix jp jb jh ji jj jk bi translated">创建Azure数据块</li><li id="38fd" class="jc jd hh ig b ih jl il jm ip jn it jo ix jp jb jh ji jj jk bi translated">创建Azure密钥库</li><li id="4f13" class="jc jd hh ig b ih jl il jm ip jn it jo ix jp jb jh ji jj jk bi translated">为运行时创建具有最新版本的集群</li><li id="a5c2" class="jc jd hh ig b ih jl il jm ip jn it jo ix jp jb jh ji jj jk bi translated">将Azure数据块连接到范围的密钥库</li><li id="a8a1" class="jc jd hh ig b ih jl il jm ip jn it jo ix jp jb jh ji jj jk bi translated">现在是创建笔记本的时候了</li></ul><h1 id="a330" class="jq jr hh bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">代码步骤</h1><p id="e4e8" class="pw-post-body-paragraph ie if hh ig b ih ko ij ik il kp in io ip kt ir is it ku iv iw ix kv iz ja jb ha bi translated">让我们从Azure Keyvault获取存储秘密</p><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="e406" class="lf jr hh lb b fi lg lh l li lj">val accbbstorekey = dbutils.secrets.get(scope = "scopename", key = "storagekey")</span></pre><ul class=""><li id="b160" class="jc jd hh ig b ih ii il im ip je it jf ix jg jb jh ji jj jk bi translated">现在配置存储规范</li></ul><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="7cc5" class="lf jr hh lb b fi lg lh l li lj">spark.conf.set(<br/>  "fs.azure.account.key.storageaccountname.blob.core.windows.net",<br/>  accbbstorekey)</span></pre><ul class=""><li id="ad0d" class="jc jd hh ig b ih ii il im ip je it jf ix jg jb jh ji jj jk bi translated">现在让我们读取日志文件</li></ul><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="d4d3" class="lf jr hh lb b fi lg lh l li lj">val logs = spark.read.format("csv")<br/>  .option("header", "false")<br/>  .option("delimiter", ";")<br/> .load("wasbs://$logs@storageaccountname.blob.core.windows.net/blob/2020/12/*/*/*.log")</span></pre><ul class=""><li id="e055" class="jc jd hh ig b ih ii il im ip je it jf ix jg jb jh ji jj jk bi translated">显示日志</li></ul><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="5aef" class="lf jr hh lb b fi lg lh l li lj">display(logs)</span></pre><figure class="kw kx ky kz fd ll er es paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="er es lk"><img src="../Images/5c482ff0151d03c693e5c71038d38ea4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*At_venetJHA6cqIYZkJmDQ.jpeg"/></div></div></figure><ul class=""><li id="81d0" class="jc jd hh ig b ih ii il im ip je it jf ix jg jb jh ji jj jk bi translated">显示模式</li></ul><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="7960" class="lf jr hh lb b fi lg lh l li lj">logs.schema</span></pre><ul class=""><li id="343e" class="jc jd hh ig b ih ii il im ip je it jf ix jg jb jh ji jj jk bi translated">现在让我们做一些汇总</li><li id="073a" class="jc jd hh ig b ih jl il jm ip jn it jo ix jp jb jh ji jj jk bi translated">下面我根据对特定文件的操作进行分组，并做一个统计，看看对哪些文件的哪些操作用得很多。</li></ul><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="a5b7" class="lf jr hh lb b fi lg lh l li lj">display(logs.select("_c2", "_c12").groupBy("_c2","_c12").count())</span></pre><figure class="kw kx ky kz fd ll er es paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="er es ls"><img src="../Images/b0285368e8c2f981b5abee0eb2bd1af9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DT4g6ZYI7tBn3bNRLVhKpg.jpeg"/></div></div></figure><p id="98f1" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">从这一点来看，想象力是你的极限。我们可以研究每一列的含义和谁各种分析，以找到使用，登录和其他更多的细节。</p><p id="54dd" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">更多详情请点击</p><div class="lt lu ez fb lv lw"><a href="https://docs.microsoft.com/en-us/azure/storage/common/storage-analytics-logging?toc=%2Fazure%2Fstorage%2Fblobs%2Ftoc.json&amp;tabs=dotnet" rel="noopener  ugc nofollow" target="_blank"><div class="lx ab dw"><div class="ly ab lz cl cj ma"><h2 class="bd hi fi z dy mb ea eb mc ed ef hg bi translated">Azure存储分析日志记录</h2><div class="md l"><h3 class="bd b fi z dy mb ea eb mc ed ef dx translated">Storage Analytics记录有关对存储服务的成功和失败请求的详细信息。此信息…</h3></div><div class="me l"><p class="bd b fp z dy mb ea eb mc ed ef dx translated">docs.microsoft.com</p></div></div><div class="mf l"><div class="mg l mh mi mj mf mk lq lw"/></div></div></a></div><p id="e028" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">原文可以在这里找到<a class="ae ml" href="https://github.com/balakreshnan/Accenture/blob/master/cap/SparkADLSlogview.md" rel="noopener ugc nofollow" target="_blank"/></p></div></div>    
</body>
</html>