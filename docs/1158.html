<html>
<head>
<title>Analysis of Stock Price Predictions using LSTM models</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用LSTM模型分析股票价格预测</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/analysis-of-stock-price-predictions-using-lstm-models-f993faa524c4?source=collection_archive---------0-----------------------#2021-02-17">https://medium.com/analytics-vidhya/analysis-of-stock-price-predictions-using-lstm-models-f993faa524c4?source=collection_archive---------0-----------------------#2021-02-17</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="d3c1" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">通过深度学习可以确定合适的交易策略吗？</h2></div><figure class="iy iz ja jb fd jc er es paragraph-image"><div class="er es ix"><img src="../Images/b4f1918eaf19d49fe01c59505b6f6466.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/format:webp/1*7POT2wmIddxWOYvsjfRgww.jpeg"/></div></figure><p id="4ac4" class="pw-post-body-paragraph jf jg hi jh b ji jj ij jk jl jm im jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated"><strong class="jh hj">简介</strong></p><p id="dfc7" class="pw-post-body-paragraph jf jg hi jh b ji jj ij jk jl jm im jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">股票交易是一种利用上市公司股价波动获利的方法。具体来说，在新冠肺炎疫情期间，许多人被困在家里，这已经成为许多人的一种方便的投资形式，有可能获得巨额回报，仅今年股票期权交易就增加了50 %[ 1]。</p><p id="d6f5" class="pw-post-body-paragraph jf jg hi jh b ji jj ij jk jl jm im jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">因此，毫无疑问，许多公司都在不断寻找获得优势和预测市场趋势的方法。然而，由于信息的巨大复杂性和难以预测的突然变化，这仍然是一项可能非常艰巨的任务。</p><p id="47e9" class="pw-post-body-paragraph jf jg hi jh b ji jj ij jk jl jm im jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">因此，我想了解一个训练有素的模型能否为我们提供准确的价格预测，以及在上涨/下跌发生之前预测上涨/下跌的最佳方式是什么。</p><p id="ab5e" class="pw-post-body-paragraph jf jg hi jh b ji jj ij jk jl jm im jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">具体来说，如果我在我的模型上投资10000美元，根据预测的百分比变化，我的进场/出场能让我赚钱吗？</p><p id="b7c1" class="pw-post-body-paragraph jf jg hi jh b ji jj ij jk jl jm im jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated"><strong class="jh hj">文献综述</strong></p><p id="db0c" class="pw-post-body-paragraph jf jg hi jh b ji jj ij jk jl jm im jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">已经有大量的文章探讨了这一领域[2][3][4]，并且对我的文章的形成是非常宝贵的。然而，我注意到对这些条款有一些评论:</p><p id="df6b" class="pw-post-body-paragraph jf jg hi jh b ji jj ij jk jl jm im jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">(1)组合测试/训练数据的标准化或将测试数据泄露到训练输入中</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div class="er es kb"><img src="../Images/cbc4eda5f040bc9130e366b9cf7af3e3.png" data-original-src="https://miro.medium.com/v2/resize:fit:498/format:webp/1*Inic1FED8XebN0_jKYX0_A.png"/></div><figcaption class="kc kd et er es ke kf bd b be z dx translated">来源:<a class="ae kg" href="https://corporatefinanceinstitute.com/resources/knowledge/finance/look-ahead-bias/" rel="noopener ugc nofollow" target="_blank">https://corporatefinanciinstitute . com/resources/knowledge/finance/look-ahead-bias/</a></figcaption></figure><p id="34f9" class="pw-post-body-paragraph jf jg hi jh b ji jj ij jk jl jm im jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">当模型依赖于当前不可用的信息时，会发生这种情况，由于模型已经拥有未来的信息，因此会给出比预期更好的结果。</p><p id="2e6f" class="pw-post-body-paragraph jf jg hi jh b ji jj ij jk jl jm im jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">(2)难以预测第二天的价格</p><p id="608f" class="pw-post-body-paragraph jf jg hi jh b ji jj ij jk jl jm im jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">有许多文章声称他们有某种通过机器/深度学习赚钱的方法，但问题是他们很难获得普遍利润，因为第二天的预测价格只是基于今天的价格调整的。Schmalz在他的文章[5]中解释得非常清楚。</p><p id="c2a6" class="pw-post-body-paragraph jf jg hi jh b ji jj ij jk jl jm im jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">因此，本文的目的不是声称一种据称具有突破性的预测价格的方法，而是通过机器/深度学习管道来了解模型是如何改进的，以慢慢消除提到的问题，同时尝试看看来自我的模型的见解是否有助于合理的交易策略。</p><p id="fce6" class="pw-post-body-paragraph jf jg hi jh b ji jj ij jk jl jm im jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">在我们深入研究之前，我们需要确定为什么我们要对时间序列数据进行分析，因为价格波动似乎是任意的。从本质上讲，技术分析的理论基础是:</p><p id="425f" class="pw-post-body-paragraph jf jg hi jh b ji jj ij jk jl jm im jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">(I)价格反映了所有相关信息。</p><p id="19f4" class="pw-post-body-paragraph jf jg hi jh b ji jj ij jk jl jm im jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">(二)价格变动不是完全随机的，历史会在一定程度上重演。</p><p id="b389" class="pw-post-body-paragraph jf jg hi jh b ji jj ij jk jl jm im jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">请随意参考我在<a class="ae kg" href="https://github.com/yuhaoleeyh/stock-project" rel="noopener ugc nofollow" target="_blank">https://github.com/yuhaoleeyh/stock-project</a>的github回购协议获取我的代码:)</p><p id="b938" class="pw-post-body-paragraph jf jg hi jh b ji jj ij jk jl jm im jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">我们开始吧！</p><p id="f26e" class="pw-post-body-paragraph jf jg hi jh b ji jj ij jk jl jm im jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated"><strong class="jh hj">探索性数据分析</strong></p><p id="1b4a" class="pw-post-body-paragraph jf jg hi jh b ji jj ij jk jl jm im jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">我首先选择放大雅虎财经API中10年间(从2010年8月31日到2020年9月1日)的谷歌股票数据。</p><p id="53ed" class="pw-post-body-paragraph jf jg hi jh b ji jj ij jk jl jm im jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">在我们开始生成模型之前，了解数据需要什么以及识别对我们来说重要的特征是至关重要的:</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div class="er es ix"><img src="../Images/887ab0743a2d13ffe3447953ee99c24b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/format:webp/1*CiW1YDgy0j2pjG45f8CuEw.png"/></div><figcaption class="kc kd et er es ke kf bd b be z dx translated">谷歌股票数据的前5行</figcaption></figure><figure class="iy iz ja jb fd jc er es paragraph-image"><div class="er es kh"><img src="../Images/0c316ca09a6bfaf71e45a0511fd2e368.png" data-original-src="https://miro.medium.com/v2/resize:fit:1386/format:webp/1*B1oCKtYTeCiSuAnwDMXihA.png"/></div><figcaption class="kc kd et er es ke kf bd b be z dx translated">谷歌股票数据的统计</figcaption></figure><p id="bba8" class="pw-post-body-paragraph jf jg hi jh b ji jj ij jk jl jm im jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">我们注意到出现的特征数量非常少(只有6列)。换句话说，这些专栏本身可能不会给我们提供很好的训练结果。以下是GOOGL过去10年的调整后收盘价:</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="kj kk di kl bf km"><div class="er es ki"><img src="../Images/434599e64b51158dfe3e70d0a52aef5b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hbp08lqwybX6lPjp3qaKCA.jpeg"/></div></div></figure><p id="0f43" class="pw-post-body-paragraph jf jg hi jh b ji jj ij jk jl jm im jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">为什么我们关注调整后的收盘？这个价格考虑了股息、股票分割和任何配股，以及闭市后发生的任何因素。因此，这是我们试图预测的特征，因为它比易受非市场力量影响的其他指标更可靠。</p><p id="fe7e" class="pw-post-body-paragraph jf jg hi jh b ji jj ij jk jl jm im jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">在图表中，我们看到调整后的收盘价总体呈上升趋势。为了查看可能对此有贡献的可能特征，我们检查了各种特征之间的关系。我们意识到交易量与调整后的收盘价成负相关。因此，体积似乎会成为我们模型中使用的一个重要特征。</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="kj kk di kl bf km"><div class="er es kn"><img src="../Images/b33e39bd58932bc0937a2f74a84908f5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*i89iWBu4s-SPgd9hC6gDyw.jpeg"/></div></div></figure><p id="281a" class="pw-post-body-paragraph jf jg hi jh b ji jj ij jk jl jm im jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">因此，我将首先使用调整后的收盘价和成交量作为我的预测模型的参数。然而，这些功能本身是不够的。</p><p id="f7c8" class="pw-post-body-paragraph jf jg hi jh b ji jj ij jk jl jm im jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated"><strong class="jh hj">特色工程</strong></p><p id="19ee" class="pw-post-body-paragraph jf jg hi jh b ji jj ij jk jl jm im jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">可以说，机器/深度学习的一个不太受重视但却很关键的部分是适当特征的工程设计。模型本身非常强大，但是如果没有合适的特征，模型可能会发现很难从数据中得出准确的推论。</p><p id="cdac" class="pw-post-body-paragraph jf jg hi jh b ji jj ij jk jl jm im jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">在我们开始任何模型训练之前，我尝试加入一些额外的特征:</p><p id="8b70" class="pw-post-body-paragraph jf jg hi jh b ji jj ij jk jl jm im jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">(1)关于平衡量</p><p id="057b" class="pw-post-body-paragraph jf jg hi jh b ji jj ij jk jl jm im jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">此指标是一个动量技术指标，使用交易量的变化作为股价变化的指标。当当天的收盘价高于昨天时，我们增加交易量，当当天的收盘价低于昨天时，我们减去交易量。随着需求激增，正的数量压力将导致价格上涨，同样，负的数量压力将最终导致价格下跌。</p><p id="ec70" class="pw-post-body-paragraph jf jg hi jh b ji jj ij jk jl jm im jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">接下来，我使用了finta库，它有差不多76个技术指标可供使用。(<a class="ae kg" href="https://pypi.org/project/finta/" rel="noopener ugc nofollow" target="_blank">https://pypi.org/project/finta/</a>)我特别关注了几个领先指标，这些指标可能会赋予模型对股票变化做出快速反应的能力:</p><p id="2066" class="pw-post-body-paragraph jf jg hi jh b ji jj ij jk jl jm im jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">(2)指数移动平均线</p><p id="d910" class="pw-post-body-paragraph jf jg hi jh b ji jj ij jk jl jm im jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">均线是一条移动平均线，它比远离当前时间段的价格更重视最近的价格。这有助于减少滞后量，并允许对价格变化做出更快的反应。</p><p id="f91f" class="pw-post-body-paragraph jf jg hi jh b ji jj ij jk jl jm im jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">(3)布林线</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div class="er es ko"><img src="../Images/4357c8a1740aa08ac3be45f03e3c4183.png" data-original-src="https://miro.medium.com/v2/resize:fit:542/format:webp/1*TlFwJwp49KSIyTHhvImhOQ.jpeg"/></div><figcaption class="kc kd et er es ke kf bd b be z dx translated">来源:<a class="ae kg" href="https://www.dailyfx.com/education/bollinger-bands/forex-trading.html" rel="noopener ugc nofollow" target="_blank">https://www . daily FX . com/education/bollinger-bands/forex-trading . html</a></figcaption></figure><p id="d638" class="pw-post-body-paragraph jf jg hi jh b ji jj ij jk jl jm im jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">布林线定义了2条线，距离时间序列的简单移动平均线有2个偏差。它限制了第二天价格的可能性，因为大多数价格行为都发生在这个区域内。波段越近，价格波动越大，因此当前趋势结束甚至逆转的可能性越大。</p><p id="9af2" class="pw-post-body-paragraph jf jg hi jh b ji jj ij jk jl jm im jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated"><strong class="jh hj">数据处理</strong></p><p id="19bc" class="pw-post-body-paragraph jf jg hi jh b ji jj ij jk jl jm im jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">一旦我们添加了特性，就该准备我们的数据作为模型的输入了！</p><p id="3a15" class="pw-post-body-paragraph jf jg hi jh b ji jj ij jk jl jm im jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">数据集被分成70%训练集和30%测试集。重要的是，这种训练-测试分离必须在两种条件下进行:( 1)训练集必须总是在测试集周期之前，因为这是一个时间序列预测;( 2)这种分离必须在任何标准化/缩放之前进行，以避免前瞻偏差。</p><p id="764d" class="pw-post-body-paragraph jf jg hi jh b ji jj ij jk jl jm im jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">请注意，对于大多数数据，进行K倍交叉验证会更理想，因为我们可以通过使用各种折叠作为验证集来评估模型。虽然这种方法更准确，并且也导致更高的数据使用效率，但问题是使用K-Fold违反了时间序列数据的时间过程，因为验证数据集在训练数据点的时间帧之前。因此，我将简单地使用keras的validation_split来提取训练集的最后10%作为我的验证集。</p><p id="600e" class="pw-post-body-paragraph jf jg hi jh b ji jj ij jk jl jm im jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">我们接下来执行归一化，当列的幅度不同时，这是重要的，因此一个列的变化的影响比另一个更显著。在标准化过程中，我们对训练数据进行拟合变换，以确保所有训练数据都在0和1之间。</p><pre class="iy iz ja jb fd kp kq kr ks aw kt bi"><span id="2267" class="ku kv hi kq b fi kw kx l ky kz">normaliser = preprocessing.MinMaxScaler()<br/>train_normalised_data = normaliser.fit_transform(train_data)</span><span id="233d" class="ku kv hi kq b fi la kx l ky kz">test_normalised_data = normaliser.transform(test_data)</span></pre><p id="bde3" class="pw-post-body-paragraph jf jg hi jh b ji jj ij jk jl jm im jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">接下来，我开始为训练集和测试集构建输入和输出特性。对于输入，它由前21天的特征组成。我选择21天，因为这是一个月的平均交易日数，这将为模型提供足够的学习功能。产量是调整后收盘价的第22天。</p><pre class="iy iz ja jb fd kp kq kr ks aw kt bi"><span id="8eb8" class="ku kv hi kq b fi kw kx l ky kz">history_points = 21</span><span id="f68a" class="ku kv hi kq b fi la kx l ky kz">X_train = np.array([train_normalised_data[i : i + history_points].copy() for i in range(len(train_normalised_data) - history_points)])</span><span id="9814" class="ku kv hi kq b fi la kx l ky kz">y_train = np.array([train_normalised_data[:,0][i + history_points].copy() for i in range(len(train_normalised_data) - history_points)])</span><span id="3eaf" class="ku kv hi kq b fi la kx l ky kz">X_test = np.array([test_normalised_data[i : i + history_points].copy() for i in range(len(test_normalised_data) - history_points)])</span><span id="2d1a" class="ku kv hi kq b fi la kx l ky kz">y_test = np.array([test_data['Adj Close'][i + history_points].copy() for i in range(len(test_normalised_data) - history_points)])</span></pre><p id="7f27" class="pw-post-body-paragraph jf jg hi jh b ji jj ij jk jl jm im jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated"><strong class="jh hj">长短期记忆(LSTM模型)</strong></p><p id="4ef0" class="pw-post-body-paragraph jf jg hi jh b ji jj ij jk jl jm im jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">现在是有趣的时候了！！深度学习！</p><p id="cec8" class="pw-post-body-paragraph jf jg hi jh b ji jj ij jk jl jm im jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">我将尝试使用长短期记忆(LSTM)模型，这是一种常用的深度学习递归神经网络(RNN)，常用于预测时间序列数据。</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="kj kk di kl bf km"><div class="er es lb"><img src="../Images/3d77ca1a213836b24938ec5a7f19fb79.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CbgNr-kF5CA0ABPOpSkUfw.jpeg"/></div></div><figcaption class="kc kd et er es ke kf bd b be z dx translated">鸣谢:<a class="ae kg" href="https://blog.floydhub.com/long-short-term-memory-from-zero-to-hero-with-pytorch/" rel="noopener ugc nofollow" target="_blank">https://blog . floydhub . com/long-short-memory-from-zero-to-hero-with-py torch/</a></figcaption></figure><p id="9286" class="pw-post-body-paragraph jf jg hi jh b ji jj ij jk jl jm im jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">LSTM有逻辑门(输入、输出和遗忘门),这些逻辑门赋予它保留更相关信息和放弃不必要信息的内在能力。这使得LSTM成为长期解释模式的一个很好的模型。</p><p id="5b30" class="pw-post-body-paragraph jf jg hi jh b ji jj ij jk jl jm im jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">关于LSTM，需要注意的重要一点是输入，它需要以3D矢量的形式出现(样本、时间步长、特征)。因此，必须对输入进行整形以适应这种情况。</p><p id="0715" class="pw-post-body-paragraph jf jg hi jh b ji jj ij jk jl jm im jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">我们首先导入所有必需的keras和tensorflow库。请注意，我们还必须设置一个随机种子，以确保结果是可复制的:</p><pre class="iy iz ja jb fd kp kq kr ks aw kt bi"><span id="da3b" class="ku kv hi kq b fi kw kx l ky kz">import tensorflow as tf<br/>import keras<br/>from keras import optimizers<br/>from keras.callbacks import History<br/>from keras.models import Model<br/>from keras.layers import Dense, Dropout, LSTM, Input, Activation, concatenate<br/>import numpy as np<br/>tf.random.set_seed(20)<br/>np.random.seed(10)</span></pre><p id="be0a" class="pw-post-body-paragraph jf jg hi jh b ji jj ij jk jl jm im jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">接下来，我们从最简单的LSTM图层开始，将密集图层作为输出。我们用30个时期和0.1的validation_split来运行它，以了解模型学习的总体情况。</p><p id="bf00" class="pw-post-body-paragraph jf jg hi jh b ji jj ij jk jl jm im jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">请注意，仅对train_data而不是验证数据进行混洗，并且验证_split是从提供的最后x和y数据中获得的，这确保了为训练保持数据的时间顺序。</p><pre class="iy iz ja jb fd kp kq kr ks aw kt bi"><span id="285a" class="ku kv hi kq b fi kw kx l ky kz">lstm_input = Input(shape=(history_points, 6), name='lstm_input')<br/>inputs = LSTM(21, name='first_layer')(lstm_input)<br/>inputs = Dense(1, name='dense_layer')(inputs)</span><span id="9d16" class="ku kv hi kq b fi la kx l ky kz">output = Activation('linear', name='output')(inputs)<br/>model = Model(inputs=lstm_input, outputs=output)</span><span id="9d83" class="ku kv hi kq b fi la kx l ky kz">adam = optimizers.Adam()</span><span id="cbac" class="ku kv hi kq b fi la kx l ky kz">model.compile(optimizer=adam, loss='mse')</span><span id="dc2a" class="ku kv hi kq b fi la kx l ky kz">model.fit(x=X_train, y=y_train, batch_size=15, epochs=30, shuffle=True, validation_split = 0.1)</span></pre><p id="b9e1" class="pw-post-body-paragraph jf jg hi jh b ji jj ij jk jl jm im jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">我们绘制了验证测试集的结果，其合理的RMSE为12.698:</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div class="er es lc"><img src="../Images/41e1ab05022d472093e30485a99f9eda.png" data-original-src="https://miro.medium.com/v2/resize:fit:1304/format:webp/1*34WG2JJvyIeceW0zsN-GBw.jpeg"/></div></figure><p id="23b4" class="pw-post-body-paragraph jf jg hi jh b ji jj ij jk jl jm im jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">完成后，我们对x_test进行预测，并根据下面的实际结果绘制结果:</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="kj kk di kl bf km"><div class="er es ld"><img src="../Images/728f3653f592c38162480fc3b319eea8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uddJ7uJes0CgQUZw_jHy_g.jpeg"/></div></div></figure><p id="d7ce" class="pw-post-body-paragraph jf jg hi jh b ji jj ij jk jl jm im jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">体面！大方向是存在的，似乎LSTM模型能够学习谷歌股票的趋势。然而，RMSE相当高(76.976)，因此它可能不是一个好的预测模型。仅仅添加合适的特征不足以使模型获得最佳结果。</p><p id="d353" class="pw-post-body-paragraph jf jg hi jh b ji jj ij jk jl jm im jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated"><strong class="jh hj">超参数/图层调整</strong></p><p id="c6a6" class="pw-post-body-paragraph jf jg hi jh b ji jj ij jk jl jm im jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">大多数机器/深度学习模型都有内部参数，通常需要改变这些参数才能实现更准确的预测。</p><p id="d54a" class="pw-post-body-paragraph jf jg hi jh b ji jj ij jk jl jm im jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">调整时期的数量是一个重要的因素。时期数量的增加将减少误差，但是太多的时期将导致模型学习训练数据的噪声。我们需要注意验证损失，当它在最低点时停止，因为超过最低点，我们过度拟合我们的特征只是为了增加我们的精度。我运行了超过1000个时期的模型，并绘制了相对于时期数的训练和验证损失:</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="kj kk di kl bf km"><div class="er es le"><img src="../Images/a8ecfab98d08baaf84ad86f3ac8abab9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nNU8bEWoc84kGKZ61OgCnw.jpeg"/></div></div></figure><p id="66b2" class="pw-post-body-paragraph jf jg hi jh b ji jj ij jk jl jm im jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">因此，我运行了提前停止的模型，在这种情况下，一旦验证精度在连续20个时期内没有提高，模型就不会运行，并选择时期= 170，此时验证损失最低。</p><p id="66a8" class="pw-post-body-paragraph jf jg hi jh b ji jj ij jk jl jm im jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">接下来，我对进行了系统的网格搜索，以获得最佳结果。运行超过100个模型，我试验了增加密集层、增加密集层中的神经元、神经网络的学习速率、增加漏层和LSTM堆叠。模型的学习率如下图所示:</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="kj kk di kl bf km"><div class="er es lf"><img src="../Images/98a0975b88fcf01d6a7840ec4a8be046.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*An4tZEyQAYgPAZl396JzWg.png"/></div></div><figcaption class="kc kd et er es ke kf bd b be z dx translated">演职员表:【https://www.jeremyjordan.me/nn-learning-rate/ T2】</figcaption></figure><p id="2162" class="pw-post-body-paragraph jf jg hi jh b ji jj ij jk jl jm im jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">必须选择最佳学习速率，以避免不可靠的训练结果/无法训练模型。同样，LSTM层的垂直叠加会增加模型的复杂性，因此有望提高结果的准确性。</p><p id="b3ef" class="pw-post-body-paragraph jf jg hi jh b ji jj ij jk jl jm im jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">经过大量测试后，我根据从网格搜索中获得的最佳超参数对模型进行了调整，网格搜索的图层如下:</p><pre class="iy iz ja jb fd kp kq kr ks aw kt bi"><span id="4800" class="ku kv hi kq b fi kw kx l ky kz">lstm_input = Input(shape=(history_points, 6), name='lstm_input')</span><span id="c603" class="ku kv hi kq b fi la kx l ky kz">inputs = LSTM(21, name='first_layer')(lstm_input)</span><span id="6ee9" class="ku kv hi kq b fi la kx l ky kz">inputs = Dense(16, name='first_dense_layer')(inputs)</span><span id="9272" class="ku kv hi kq b fi la kx l ky kz">inputs = Dense(1, name='second_dense_layer')(inputs)</span><span id="8cdc" class="ku kv hi kq b fi la kx l ky kz">output = Activation('linear', name='output')(inputs)</span><span id="4e08" class="ku kv hi kq b fi la kx l ky kz">model = Model(inputs=lstm_input, outputs=output)</span><span id="3325" class="ku kv hi kq b fi la kx l ky kz">adam = optimizers.Adam(lr = 0.0008)</span><span id="436a" class="ku kv hi kq b fi la kx l ky kz">model.compile(optimizer=adam, loss='mse')</span><span id="3799" class="ku kv hi kq b fi la kx l ky kz">model.fit(x=X_train, y=y_train, batch_size=15, epochs=170, shuffle=True, validation_split = 0.1)</span></pre><p id="1366" class="pw-post-body-paragraph jf jg hi jh b ji jj ij jk jl jm im jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">这设法在测试集上获得了48.997的合理RMSE。它能够相对较好地模拟价格上涨/下跌。</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="kj kk di kl bf km"><div class="er es lg"><img src="../Images/d71cc91dfbf1cf6293cf596b2b9e5bdf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LY5fildq5bQsXWT1vBm47w.jpeg"/></div></div></figure><p id="4cf0" class="pw-post-body-paragraph jf jg hi jh b ji jj ij jk jl jm im jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated"><strong class="jh hj">第一个模型的局限性</strong></p><p id="a3d9" class="pw-post-body-paragraph jf jg hi jh b ji jj ij jk jl jm im jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">模特看起来还过得去！是时候开始挣钱了吗？把钱投到我的模型里可能很诱人(请不要！)，我决定测试一下。</p><p id="9fab" class="pw-post-body-paragraph jf jg hi jh b ji jj ij jk jl jm im jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">以10000美元作为基础资金，我做了一个算法，当第二天的价格变动超过预测的0.15%时，买入尽可能多的股票，当第二天的价格变动超过预测的0.15%时，卖出尽可能多的股票。</p><p id="fcfd" class="pw-post-body-paragraph jf jg hi jh b ji jj ij jk jl jm im jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">然而，在这种模式下，我们实际上得到8424美元！上面的图显示了模型在实际测试集上的买入(绿色箭头)/卖出(红色箭头)，而下面的图显示了同一时间段内(第二天预测的)百分比变化:</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="kj kk di kl bf km"><div class="er es lh"><img src="../Images/d6ca40b1313c0b2dcf2e23e81ad53886.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dsMp4l_8QybQfbD1h2xNtQ.jpeg"/></div></div></figure><p id="ad5a" class="pw-post-body-paragraph jf jg hi jh b ji jj ij jk jl jm im jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">换句话说，我们最好不要投资任何钱！为什么会这样呢？这是由于领先/滞后模型的概念。</p><p id="390d" class="pw-post-body-paragraph jf jg hi jh b ji jj ij jk jl jm im jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">领先模型:在价格发生之前提供指导价格变化的能力。</p><p id="0257" class="pw-post-body-paragraph jf jg hi jh b ji jj ij jk jl jm im jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">滞后模型:只在价格变化发生后才做出反应的模型。</p><p id="34cc" class="pw-post-body-paragraph jf jg hi jh b ji jj ij jk jl jm im jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">在股票分析中，<strong class="jh hj"> </strong>我们需要集中精力识别能够准确预测价格位置的领先模型。这通常通过季节性培训来实现:</p><p id="7492" class="pw-post-body-paragraph jf jg hi jh b ji jj ij jk jl jm im jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated"><strong class="jh hj">季节性模型</strong></p><p id="c6b2" class="pw-post-body-paragraph jf jg hi jh b ji jj ij jk jl jm im jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">平稳性的概念在时间序列数据中至关重要。本质上，时间序列数据将具有趋势、季节性和噪声:</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="kj kk di kl bf km"><div class="er es li"><img src="../Images/cb97fdf229923c854b1fc0d432ab4dc5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8LpbmwSr5ZloERjTFYneCQ.png"/></div></div><figcaption class="kc kd et er es ke kf bd b be z dx translated">来源:<a class="ae kg" href="https://anomaly.io/seasonal-trend-decomposition-in-r/index.html" rel="noopener ugc nofollow" target="_blank">https://anomaly . io/seasonary-trend-decomposition-in-r/index . html</a></figcaption></figure><p id="4032" class="pw-post-body-paragraph jf jg hi jh b ji jj ij jk jl jm im jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">我们应该明白，当LSTM模型能够更好地训练持续的季节性，而不是试图学习当前的趋势时，这样的模型效果最好。</p><p id="6e79" class="pw-post-body-paragraph jf jg hi jh b ji jj ij jk jl jm im jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">为了尝试让模型学习数据的季节性，这主要是由于股票价格在波动超过平均值后最终恢复到稳定点造成的，我尝试使用差异(P(t +1) -P(t))作为唯一的输入特征。这将有望产生一个领先的模型。同时，这防止了模型参考昨天的价格，这有望避免滞后模型的问题。谈一石二鸟:)</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="kj kk di kl bf km"><div class="er es lj"><img src="../Images/bd2af354a6c4dbbf02a4a6027d97c5e8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*E5GWIW4LWKdVSyFWmfbg_w.png"/></div></div><figcaption class="kc kd et er es ke kf bd b be z dx translated">数据的季节性一旦我取P(t) — P(t — 1)</figcaption></figure><p id="4b38" class="pw-post-body-paragraph jf jg hi jh b ji jj ij jk jl jm im jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">之后，我在LSTM模型上训练数据。具体来说，我决定雇用更多的LSTM层。LSTM层的垂直叠加会增加模型的复杂性，因此有望提高结果的准确性。注意，我只使用了25个历元，因为超过这一点，验证损失会急剧增加。</p><p id="8316" class="pw-post-body-paragraph jf jg hi jh b ji jj ij jk jl jm im jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">在做了进一步的网格搜索后，我设法使用下面的层在验证集上获得了一个RMSE为45.273的不错的性能模型:</p><pre class="iy iz ja jb fd kp kq kr ks aw kt bi"><span id="6bf2" class="ku kv hi kq b fi kw kx l ky kz">lstm_input = Input(shape=(data_set_points, 1), name='lstm_input')<br/>inputs = LSTM(21, name='first_layer', return_sequences = True)(lstm_input)<br/>inputs = Dropout(0.1, name='first_dropout_layer')(inputs)<br/>inputs = LSTM(64, name='lstm_1')(inputs)<br/>inputs = Dropout(0.05, name='lstm_dropout_1')(inputs)<br/>inputs = Dense(32, name='first_dense_layer')(inputs)<br/>inputs = Dense(1, name='dense_layer')(inputs)<br/>output = Activation('linear', name='output')(inputs)</span><span id="268d" class="ku kv hi kq b fi la kx l ky kz">model = Model(inputs=lstm_input, outputs=output)<br/>adam = optimizers.Adam(lr = 0.002)</span><span id="e3dc" class="ku kv hi kq b fi la kx l ky kz">model.compile(optimizer=adam, loss='mse')<br/>model.fit(x=X_train, y=y_train, batch_size=15, epochs=25, shuffle=True, validation_split = 0.1)</span></pre><p id="6267" class="pw-post-body-paragraph jf jg hi jh b ji jj ij jk jl jm im jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">有两件重要的事情需要注意。首先，应该为多个LSTM层设置return_sequences = True，以便输出可以提供给下一层。第二，为了提高精确度，我一直在每个LSTM层之后添加漏失层，这将有助于减少过度拟合，这是神经网络非常容易发生的事情。</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="kj kk di kl bf km"><div class="er es lk"><img src="../Images/0c43337ea9de2f72d3050cc82054c490.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*H8P9es6MsP9uhZWrYYUGOA.jpeg"/></div></div></figure><p id="aeee" class="pw-post-body-paragraph jf jg hi jh b ji jj ij jk jl jm im jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">测试集预测乍看起来不太好，但首先，即使测试集中的趋势急剧增加，第二个模型也设法简单地从训练集中的差异(不参考价格)来正确预测价格方向。</p><p id="c12c" class="pw-post-body-paragraph jf jg hi jh b ji jj ij jk jl jm im jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">第二，这个模型似乎能够学习一些主要特征。在t = 20时，预测价格会下降，这反映在t = 25时的价格下降上，此后，从t = 30到t = 40，预测价格也会上升，反映在实际的蓝色图表中。t = 550时的预测下降也反映在t = 600时。这一结果表明，趋势的去除可能降低了准确性，但可能提供了进入/退出股票市场的最佳时机的见解。</p><p id="28bc" class="pw-post-body-paragraph jf jg hi jh b ji jj ij jk jl jm im jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">下面，我尝试使用同样的10000美元算法，看看我是否能从我的模型中赚钱。你可以看到，在这个例子中，我的算法在根据我的预测低买高卖方面做得很好。</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="kj kk di kl bf km"><div class="er es ll"><img src="../Images/e5fc67a3e7260b0fc10bedaff5d0b1c7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jEup-DSC-Q7fAg8CpY9utQ.jpeg"/></div></div></figure><p id="c044" class="pw-post-body-paragraph jf jg hi jh b ji jj ij jk jl jm im jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">从这个预测中，我总共赚了7683美元，与买入并持有策略相比，我赚了6558美元，相当于赚了1135美元！厉害！换句话说，虽然它没有很好地模拟数量，但它设法提供了价格变化的领先指标，这使我的算法获得了收益。</p><p id="1d41" class="pw-post-body-paragraph jf jg hi jh b ji jj ij jk jl jm im jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">这可能看起来像是巧合，因此我决定使用差异，并将其合并到实际价格中。对于时间t时的每个实际价格，我使用获得的预测差异来获得t + 1时的价格，我们获得了以下结果:</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="kj kk di kl bf km"><div class="er es lm"><img src="../Images/9f5a7dcdcf23f7204909fbf5a21cf583.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WQAGlApr9V00REiR-yjhZA.jpeg"/></div></div></figure><p id="2403" class="pw-post-body-paragraph jf jg hi jh b ji jj ij jk jl jm im jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">了不起！我比RMSE提高了24.014分！这表明，由于季节性不变，该模型通常能够相当准确地预测正确的方向。它证明了基于差异而非幅度的训练实际上导致了更高的准确性和更好的生成潜在领先模型的能力。</p><p id="34d8" class="pw-post-body-paragraph jf jg hi jh b ji jj ij jk jl jm im jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">然而，我要重申的是，只在一只股票上训练一个模型并不意味着这可以推广到所有股票或其他时间段。然而，这一结果为预测进入/退出市场的方法提供了巨大的机会，并为基于恒定平稳性的更好调整/特征工程提供了潜力，以生成可持续的模型。</p><p id="c22b" class="pw-post-body-paragraph jf jg hi jh b ji jj ij jk jl jm im jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated"><strong class="jh hj">结论和要点</strong></p><p id="fa62" class="pw-post-body-paragraph jf jg hi jh b ji jj ij jk jl jm im jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">总的来说，看起来我的LSTM模型能够通过特征工程和超调整成功地预测股票价格。然而，去除趋势并让模型仅训练季节性成分似乎赋予了模型拥有领先指标的能力，并给予了预测更好的准确性。有很大的潜力来预测进入/退出市场的基础上，一个适当的阈值，以实现最佳的结果。</p><p id="5897" class="pw-post-body-paragraph jf jg hi jh b ji jj ij jk jl jm im jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated"><strong class="jh hj">演职员表</strong></p><p id="d5cb" class="pw-post-body-paragraph jf jg hi jh b ji jj ij jk jl jm im jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">我想真诚地感谢https://heicodersacademy.com严敏和黑码学院(<a class="ae kg" href="https://heicodersacademy.com/" rel="noopener ugc nofollow" target="_blank">)</a>，他们投入了大量的时间来指导、建议我，并在这篇文章的撰写过程中给了我很多帮助。</p><p id="9dff" class="pw-post-body-paragraph jf jg hi jh b ji jj ij jk jl jm im jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated"><strong class="jh hj">重要免责声明</strong></p><p id="2e36" class="pw-post-body-paragraph jf jg hi jh b ji jj ij jk jl jm im jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">这个项目纯粹是从教育和研究的角度出发，不应该被天真地用作金融投资的指南或基准。任何股票交易都包含巨大的风险，因为此类投资组合的估值会波动，因此应该谨慎从事。本文绝不作为股票投资指南，使用的任何信息风险自担。</p><p id="5d24" class="pw-post-body-paragraph jf jg hi jh b ji jj ij jk jl jm im jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">这是我第一篇关于媒体的文章，所以我欢迎任何关于改进我的模型/未来方向的反馈:)</p><p id="b2ce" class="pw-post-body-paragraph jf jg hi jh b ji jj ij jk jl jm im jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated"><strong class="jh hj">参考文献</strong></p><p id="58e4" class="pw-post-body-paragraph jf jg hi jh b ji jj ij jk jl jm im jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">[1]<a class="ae kg" href="https://www.cnbc.com/2020/12/04/pandemic-induced-options-trading-craze-shows-no-signs-of-slowing-down.html" rel="noopener ugc nofollow" target="_blank">https://www . CNBC . com/2020/12/04/疫情-induced-options-trading-craze-shows-no-signs-of-downing . html</a></p><p id="cb9b" class="pw-post-body-paragraph jf jg hi jh b ji jj ij jk jl jm im jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">[2]<a class="ae kg" href="https://towardsdatascience.com/getting-rich-quick-with-machine-learning-and-stock-market-predictions-696802da94fe" rel="noopener" target="_blank">https://towards data science . com/get-rich-quick-with-machine-learning-and-stock-market-predictions-696802 da 94 Fe</a></p><p id="a07f" class="pw-post-body-paragraph jf jg hi jh b ji jj ij jk jl jm im jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">[3]<a class="ae kg" href="https://towardsdatascience.com/aifortrading-2edd6fac689d" rel="noopener" target="_blank">https://towardsdatascience.com/aifortrading-2edd6fac689d</a></p><p id="f6ec" class="pw-post-body-paragraph jf jg hi jh b ji jj ij jk jl jm im jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">[4]<a class="ae kg" href="https://towardsdatascience.com/stock-price-prediction-based-on-deep-learning-3842ef697da0" rel="noopener" target="_blank">https://towards data science . com/stock-price-prediction-based-on-deep-learning-3842 ef 697 da 0</a></p><p id="ebe3" class="pw-post-body-paragraph jf jg hi jh b ji jj ij jk jl jm im jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">[5]<a class="ae kg" href="https://towardsdatascience.com/using-neural-networks-to-predict-stock-prices-dont-be-fooled-c43a4e26ae4e" rel="noopener" target="_blank">https://towards data science . com/using-neural-networks-to-predict-stop-be-focked-c 43 a4 e 26 AE 4e</a></p><p id="f683" class="pw-post-body-paragraph jf jg hi jh b ji jj ij jk jl jm im jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">[6]<a class="ae kg" rel="noopener" href="/@Currie32/predicting-the-stock-market-with-the-news-and-deep-learning-7fc8f5f639bc">https://medium . com/@ Currie 32/predicting-the-news-and-deep-learning-7 fc 8 f 5 f 639 BC</a></p><p id="259d" class="pw-post-body-paragraph jf jg hi jh b ji jj ij jk jl jm im jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">[7]<a class="ae kg" href="https://towardsdatascience.com/pandemics-impact-financial-markets-9a4feb6951f5" rel="noopener" target="_blank">https://towards data science . com/pandemics-impact-financial-markets-9 a4 feb 6951 F5</a></p></div></div>    
</body>
</html>