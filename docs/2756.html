<html>
<head>
<title>Atlantis on AWS EKS Fargate</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">AWS上的亚特兰蒂斯EKS法盖特</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/atlantis-on-aws-eks-fargate-666ed21d09f4?source=collection_archive---------1-----------------------#2021-05-16">https://medium.com/analytics-vidhya/atlantis-on-aws-eks-fargate-666ed21d09f4?source=collection_archive---------1-----------------------#2021-05-16</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="7eb1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Terraform拉式请求自动化</p><p id="8f4a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae jd" href="https://www.terraform.io/" rel="noopener ugc nofollow" target="_blank"> Terraform </a>是应用最广泛的Iaac工具之一。这是HashiCorp提供的免费开源工具。使用Terraform，你可以在AWS、GCP和Azure等多个云平台上提供基础设施。</p><p id="c9e4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">每个组织都在版本控制系统(VCS)上维护代码，如GitHub、Bitbucket等。每当开发人员在IaaC中进行更改时，他们会提出一个拉请求，然后经过<strong class="ih hj">【N】</strong>次审查和评论后，该请求被接受，在此期间，开发人员将从本地系统或自动化工作站多次运行terraform命令。这就是亚特兰蒂斯出现的原因。</p><p id="42fb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae jd" href="https://www.runatlantis.io/" rel="noopener ugc nofollow" target="_blank"> Atlantis </a>是一个工具，它允许你直接从在拉请求上创建的注释中运行terraform命令，Atlantis将通过输出对拉请求进行评论，团队中的每个成员都将知道什么将被创建或销毁，以及谁在做什么。你可以在<a class="ae jd" href="https://www.runatlantis.io/guide/#why-would-you-run-atlantis" rel="noopener ugc nofollow" target="_blank">https://www . run Atlantis . io/guide/# why-you-run-Atlantis</a>上了解更多信息</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es je"><img src="../Images/66576cef5d8bb2f4956914f773deb39f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*n65Xc5zm1m4NwZKLTmIGYA.png"/></div></div><figcaption class="jq jr et er es js jt bd b be z dx translated">亚特兰蒂斯流</figcaption></figure><p id="a01e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在这篇博文中，我将告诉你如何在<a class="ae jd" href="https://docs.aws.amazon.com/eks/latest/userguide/fargate.html" rel="noopener ugc nofollow" target="_blank"> AWS EKS法盖特</a>上配置Atlantis</p><h1 id="635f" class="ju jv hi bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">我们开始吧</h1><p id="e585" class="pw-post-body-paragraph if ig hi ih b ii ks ik il im kt io ip iq ku is it iu kv iw ix iy kw ja jb jc hb bi translated">在这篇文章中，我使用<strong class="ih hj"> BitBucket </strong>作为VCS，但是无论你使用哪个VCS，实现都是一样的。</p><h2 id="8f49" class="kx jv hi bd jw ky kz la ka lb lc ld ke iq le lf ki iu lg lh km iy li lj kq lk bi translated">先决条件</h2><ul class=""><li id="1586" class="ll lm hi ih b ii ks im kt iq ln iu lo iy lp jc lq lr ls lt bi translated">VPC</li><li id="d4b9" class="ll lm hi ih b ii lu im lv iq lw iu lx iy ly jc lq lr ls lt bi translated">VPC的子网应该有以下标记</li></ul><p id="4007" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一、公共子网:—kubernetes.io/role/elb = 1</p><p id="4156" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">二。专用子网:—kubernetes.io/role/internal-elb = 1</p><ul class=""><li id="5466" class="ll lm hi ih b ii ij im in iq lz iu ma iy mb jc lq lr ls lt bi translated">具有活动Fargate轮廓的EKS群集</li><li id="4853" class="ll lm hi ih b ii lu im lv iq lw iu lx iy ly jc lq lr ls lt bi translated">库贝特尔</li><li id="6325" class="ll lm hi ih b ii lu im lv iq lw iu lx iy ly jc lq lr ls lt bi translated">使用链接<a class="ae jd" href="https://www.runatlantis.io/docs/access-credentials.html" rel="noopener ugc nofollow" target="_blank">https://www.runatlantis.io/docs/access-credentials.html</a>根据您的VCS配置VCS的访问凭证</li><li id="6d79" class="ll lm hi ih b ii lu im lv iq lw iu lx iy ly jc lq lr ls lt bi translated">Web-hook Secret——使用链接<a class="ae jd" href="https://www.runatlantis.io/docs/webhook-secrets.html" rel="noopener ugc nofollow" target="_blank">https://www.runatlantis.io/docs/webhook-secrets.html</a>创建web-hook Secret(对于BitBucket，这不是必需的，因为不应该这样做)</li></ul><p id="f359" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我已经在<strong class="ih hj"> Kubernetes版本1.19 </strong>上进行了配置，所有K8s相关资源都在<strong class="ih hj">默认名称空间</strong>和<strong class="ih hj"> kube-system名称空间</strong>中</p><h2 id="c304" class="kx jv hi bd jw ky kz la ka lb lc ld ke iq le lf ki iu lg lh km iy li lj kq lk bi translated">亚特兰蒂斯运行时间</h2><p id="9fe9" class="pw-post-body-paragraph if ig hi ih b ii ks ik il im kt io ip iq ku is it iu kv iw ix iy kw ja jb jc hb bi translated">亚特兰蒂斯是一个简单的<a class="ae jd" href="https://golang.org/" rel="noopener ugc nofollow" target="_blank">去</a>应用程序。它从您的Git主机接收webhooks，并在本地执行Terraform命令。有亚特兰蒂斯官方<a class="ae jd" href="https://hub.docker.com/r/runatlantis/atlantis/" rel="noopener ugc nofollow" target="_blank"> Docker形象</a>。我们将使用<strong class="ih hj"> v0.17.0 </strong></p><h2 id="9c40" class="kx jv hi bd jw ky kz la ka lb lc ld ke iq le lf ki iu lg lh km iy li lj kq lk bi translated">亚特兰蒂斯数据</h2><p id="ea26" class="pw-post-body-paragraph if ig hi ih b ii ks ik il im kt io ip iq ku is it iu kv iw ix iy kw ja jb jc hb bi translated">亚特兰蒂斯没有外部数据库。Atlantis在磁盘上存储Terraform计划文件。如果亚特兰蒂斯在<code class="du mc md me mf b">plan</code>和<code class="du mc md me mf b">apply</code>周期之间丢失了数据，那么用户将不得不重新运行<code class="du mc md me mf b">plan</code>。因此，我们将为亚特兰蒂斯使用永久磁盘。</p><h2 id="42d4" class="kx jv hi bd jw ky kz la ka lb lc ld ke iq le lf ki iu lg lh km iy li lj kq lk bi translated">亚特兰蒂斯仓库</h2><p id="acab" class="pw-post-body-paragraph if ig hi ih b ii ks ik il im kt io ip iq ku is it iu kv iw ix iy kw ja jb jc hb bi translated">我们将使用<strong class="ih hj"> AWS弹性文件系统</strong>来存储我们所有的Atlantis数据，因为AWS Fargate不支持EBS卷，所以唯一的选择是使用AWS EFS作为持久存储。</p><h2 id="b3bd" class="kx jv hi bd jw ky kz la ka lb lc ld ke iq le lf ki iu lg lh km iy li lj kq lk bi translated">创建AWS弹性文件系统</h2><ul class=""><li id="0354" class="ll lm hi ih b ii ks im kt iq ln iu lo iy lp jc lq lr ls lt bi translated">转到EFS控制台，单击“创建文件系统”</li><li id="2a4b" class="ll lm hi ih b ii lu im lv iq lw iu lx iy ly jc lq lr ls lt bi translated">给你的文件系统命名</li><li id="5d29" class="ll lm hi ih b ii lu im lv iq lw iu lx iy ly jc lq lr ls lt bi translated">为您的文件系统选择VPC</li><li id="6118" class="ll lm hi ih b ii lu im lv iq lw iu lx iy ly jc lq lr ls lt bi translated">点击创建</li></ul><h2 id="cc07" class="kx jv hi bd jw ky kz la ka lb lc ld ke iq le lf ki iu lg lh km iy li lj kq lk bi translated">创建文件系统访问点</h2><p id="0632" class="pw-post-body-paragraph if ig hi ih b ii ks ik il im kt io ip iq ku is it iu kv iw ix iy kw ja jb jc hb bi translated">亚马逊EFS <em class="mg">访问点</em>是进入EFS文件系统的特定于应用程序的入口点，这使得管理应用程序对共享数据集的访问变得更加容易。对于通过接入点发出的所有文件系统请求，接入点可以强制实施用户身份，包括用户的POSIX组。访问点还可以对文件系统强制使用不同的根目录，以便客户端只能访问指定目录或其子目录中的数据。</p><p id="6bb5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们将使用<strong class="ih hj"> "/atlantis" </strong>(将由k8s自动挂载)作为我们在EFS的挂载点，所有的数据都将存储在这个目录下。Atlantis创建的文件将使用<strong class="ih hj">“Atlantis:Atlantis”</strong>作为用户和组。我们将使用此路径以及用户和组来限制我们的接入点。</p><ul class=""><li id="d26e" class="ll lm hi ih b ii ij im in iq lz iu ma iy mb jc lq lr ls lt bi translated">选择您的文件系统并选择<strong class="ih hj">访问点</strong>选项卡</li><li id="0f42" class="ll lm hi ih b ii lu im lv iq lw iu lx iy ly jc lq lr ls lt bi translated">点击创建接入点</li></ul><p id="02f0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">a.系统会自动选择您的文件系统ID，如果没有，请选择您的文件系统</p><p id="0ff4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">b.输入接入点的名称</p><p id="1f57" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">c.在根目录路径中写下<strong class="ih hj"> "/atlantis" </strong></p><p id="c016" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">d.在POSIX用户中写下以下内容</p><p id="dd02" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一、用户ID — <strong class="ih hj"> 100 </strong>(亚特兰蒂斯用户ID)</p><p id="8ea0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">二。组ID — <strong class="ih hj"> 1000 </strong>(亚特兰蒂斯组ID)</p><p id="c6cc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">e.在根目录创建权限中写入以下内容</p><p id="dab5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一、业主用户ID — <strong class="ih hj"> 100 </strong></p><p id="dcd8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">二。所有者群组ID — <strong class="ih hj"> 1000 </strong></p><p id="5b46" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">三。权限— <strong class="ih hj"> 777 </strong></p><p id="eec4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">f.点击创建接入点</p><p id="3226" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">重要提示:</strong></p><ol class=""><li id="306d" class="ll lm hi ih b ii ij im in iq lz iu ma iy mb jc mh lr ls lt bi translated">记下<strong class="ih hj"> AWS EFS ID </strong>和<strong class="ih hj">接入点ID </strong>。</li><li id="4974" class="ll lm hi ih b ii lu im lv iq lw iu lx iy ly jc mh lr ls lt bi translated">您需要更新EFS Sg以允许来自EKS集群的流量。您可以将EKS集群Sg ID添加到具有所有流量和所有端口的EFS Sg的入站规则中。</li></ol><h2 id="c371" class="kx jv hi bd jw ky kz la ka lb lc ld ke iq le lf ki iu lg lh km iy li lj kq lk bi translated">AWS负载平衡器控制器</h2><p id="0f6b" class="pw-post-body-paragraph if ig hi ih b ii ks ik il im kt io ip iq ku is it iu kv iw ix iy kw ja jb jc hb bi translated">AWS负载平衡器控制器为Kubernetes集群管理AWS弹性负载平衡器。当您创建Kubernetes <code class="du mc md me mf b">Ingress</code>时，控制器会提供一个AWS应用程序负载平衡器(ALB)</p><p id="4a93" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">使用AWS管理控制台为您的集群创建OIDC提供者</strong></p><ul class=""><li id="6d61" class="ll lm hi ih b ii ij im in iq lz iu ma iy mb jc lq lr ls lt bi translated">查看您的群集的OIDC提供程序URL</li></ul><pre class="jf jg jh ji fd mi mf mj mk aw ml bi"><span id="b189" class="kx jv hi mf b fi mm mn l mo mp">aws eks describe-cluster --name &lt;cluster_name&gt; --query "cluster.identity.oidc.issuer" --output text</span></pre><ul class=""><li id="f1d6" class="ll lm hi ih b ii ij im in iq lz iu ma iy mb jc lq lr ls lt bi translated">打开IAM控制台</li><li id="ef5e" class="ll lm hi ih b ii lu im lv iq lw iu lx iy ly jc lq lr ls lt bi translated">在导航面板中，选择身份提供者。如果列出了与您的群集的URL匹配的提供程序，那么您的群集已经有了一个提供程序。如果没有列出与您的群集的URL匹配的提供程序，则您必须创建一个。</li><li id="665d" class="ll lm hi ih b ii lu im lv iq lw iu lx iy ly jc lq lr ls lt bi translated">要创建提供商，选择<strong class="ih hj">添加提供商</strong></li><li id="a0a5" class="ll lm hi ih b ii lu im lv iq lw iu lx iy ly jc lq lr ls lt bi translated">对于<strong class="ih hj">提供者类型</strong>，选择<strong class="ih hj"> OpenID连接</strong></li><li id="bd50" class="ll lm hi ih b ii lu im lv iq lw iu lx iy ly jc lq lr ls lt bi translated">对于<strong class="ih hj">提供者URL </strong>，粘贴您的集群的OIDC发行者URL，然后选择<strong class="ih hj">获取指纹</strong></li><li id="2134" class="ll lm hi ih b ii lu im lv iq lw iu lx iy ly jc lq lr ls lt bi translated">对于<strong class="ih hj">受众</strong>，输入<code class="du mc md me mf b">sts.amazonaws.com</code>并选择<strong class="ih hj">添加提供商</strong></li></ul><p id="51fd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">创建IAM策略</strong></p><ul class=""><li id="dafd" class="ll lm hi ih b ii ij im in iq lz iu ma iy mb jc lq lr ls lt bi translated">下载AWS负载平衡器控制器的IAM策略，允许它代表您调用AWS APIs。可以在GitHub上查看<a class="ae jd" href="https://raw.githubusercontent.com/kubernetes-sigs/aws-load-balancer-controller/v2_ga/docs/install/iam_policy.json" rel="noopener ugc nofollow" target="_blank">政策文件</a>。</li></ul><pre class="jf jg jh ji fd mi mf mj mk aw ml bi"><span id="598a" class="kx jv hi mf b fi mm mn l mo mp">curl -o iam_policy.json <a class="ae jd" href="https://raw.githubusercontent.com/kubernetes-sigs/aws-load-balancer-controller/v2.1.3/docs/install/iam_policy.json" rel="noopener ugc nofollow" target="_blank">https://raw.githubusercontent.com/kubernetes-sigs/aws-load-balancer-controller/v2.1.3/docs/install/iam_policy.json</a></span></pre><ul class=""><li id="7c5c" class="ll lm hi ih b ii ij im in iq lz iu ma iy mb jc lq lr ls lt bi translated">使用上一步中下载的策略创建IAM策略</li></ul><pre class="jf jg jh ji fd mi mf mj mk aw ml bi"><span id="9ecf" class="kx jv hi mf b fi mm mn l mo mp">aws iam create-policy \<br/>    --policy-name <strong class="mf hj">AWSLoadBalancerControllerIAMPolicy</strong> \<br/>    --policy-document file://iam_policy.json</span></pre><p id="0fda" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">创建IAM角色和K8s服务账户</strong></p><p id="795a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们将创建一个IAM角色，并使用AWS管理控制台和<code class="du mc md me mf b">kubectl</code>为AWS负载平衡器控制器在<code class="du mc md me mf b">kube-system</code>名称空间中标注名为<code class="du mc md me mf b">aws-load-balancer-controller</code>的Kubernetes服务帐户</p><ul class=""><li id="2b23" class="ll lm hi ih b ii ij im in iq lz iu ma iy mb jc lq lr ls lt bi translated">打开IAM控制台</li><li id="9c55" class="ll lm hi ih b ii lu im lv iq lw iu lx iy ly jc lq lr ls lt bi translated">在导航面板中，选择<strong class="ih hj">角色</strong>，<strong class="ih hj">创建角色</strong></li><li id="8df9" class="ll lm hi ih b ii lu im lv iq lw iu lx iy ly jc lq lr ls lt bi translated">在<strong class="ih hj">选择可信实体类型</strong>部分，选择<strong class="ih hj"> Web身份</strong></li><li id="445c" class="ll lm hi ih b ii lu im lv iq lw iu lx iy ly jc lq lr ls lt bi translated">在<strong class="ih hj">选择web身份提供者</strong>部分</li></ul><p id="7821" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">I .对于<strong class="ih hj">身份提供者</strong>，选择您的集群的URL</p><p id="d148" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">二。对于<strong class="ih hj">观众</strong>，选择<code class="du mc md me mf b">sts.amazonaws.com</code></p><ul class=""><li id="0693" class="ll lm hi ih b ii ij im in iq lz iu ma iy mb jc lq lr ls lt bi translated">选择<strong class="ih hj">下一步:权限</strong></li><li id="8f20" class="ll lm hi ih b ii lu im lv iq lw iu lx iy ly jc lq lr ls lt bi translated">在<strong class="ih hj">附加策略</strong>部分，选择您之前创建的用于您的服务帐户的<code class="du mc md me mf b"><em class="mg">AWSLoadBalancerControllerIAMPolicy</em></code>策略</li><li id="fe28" class="ll lm hi ih b ii lu im lv iq lw iu lx iy ly jc lq lr ls lt bi translated">选择<strong class="ih hj">下一步:标签</strong></li><li id="230d" class="ll lm hi ih b ii lu im lv iq lw iu lx iy ly jc lq lr ls lt bi translated">在<strong class="ih hj">添加标签(可选)</strong>屏幕上，您可以为帐户添加标签。选择<strong class="ih hj">下一步:查看</strong></li><li id="ca9a" class="ll lm hi ih b ii lu im lv iq lw iu lx iy ly jc lq lr ls lt bi translated">对于<strong class="ih hj">角色名称</strong>，输入您的角色名称，如<code class="du mc md me mf b"><em class="mg">AmazonEKSLoadBalancerControllerRole</em></code>，然后选择<strong class="ih hj">创建角色</strong></li><li id="654b" class="ll lm hi ih b ii lu im lv iq lw iu lx iy ly jc lq lr ls lt bi translated">创建角色后，在控制台中选择角色以打开它进行编辑</li><li id="628e" class="ll lm hi ih b ii lu im lv iq lw iu lx iy ly jc lq lr ls lt bi translated">选择<strong class="ih hj">信任关系</strong>选项卡，然后选择<strong class="ih hj">编辑信任关系</strong></li></ul><p id="2f50" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">找到类似如下的行:</p><pre class="jf jg jh ji fd mi mf mj mk aw ml bi"><span id="03a0" class="kx jv hi mf b fi mm mn l mo mp">"oidc.eks.&lt;<em class="mg">region-code</em>&gt;.amazonaws.com/id/EXAMPLED539D4633E53DE1B716D3041E:aud": "sts.amazonaws.com"</span></pre><p id="89d0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">将该行更改为如下所示。将<code class="du mc md me mf b"><em class="mg">&lt;EXAMPLED539D4633E53DE1B716D3041E&gt;</em></code>(包括<code class="du mc md me mf b"><em class="mg">&lt;&gt;</em></code>)替换为您的集群的OIDC提供商ID，将<code class="du mc md me mf b"><em class="mg">&lt;region-code&gt;</em></code>替换为您的集群所在的地区代码</p><pre class="jf jg jh ji fd mi mf mj mk aw ml bi"><span id="b9d8" class="kx jv hi mf b fi mm mn l mo mp">"oidc.eks.<em class="mg">&lt;region-code&gt;</em>.amazonaws.com/id/<em class="mg">&lt;EXAMPLED539D4633E53DE1B716D3041E&gt;</em>:sub": "system:serviceaccount:kube-system:aws-load-balancer-controller"</span></pre><ul class=""><li id="b545" class="ll lm hi ih b ii ij im in iq lz iu ma iy mb jc lq lr ls lt bi translated">选择<strong class="ih hj">更新信任策略</strong>结束</li><li id="9f4c" class="ll lm hi ih b ii lu im lv iq lw iu lx iy ly jc lq lr ls lt bi translated">记下角色的ARN，以便在后面的步骤中使用</li><li id="6374" class="ll lm hi ih b ii lu im lv iq lw iu lx iy ly jc lq lr ls lt bi translated">将以下内容保存到名为<code class="du mc md me mf b"><em class="mg">aws-load-balancer-controller-service-account.yaml</em></code>的文件中</li></ul><pre class="jf jg jh ji fd mi mf mj mk aw ml bi"><span id="8037" class="kx jv hi mf b fi mm mn l mo mp">apiVersion: v1<br/>kind: ServiceAccount<br/>metadata:<br/>  labels:<br/>    app.kubernetes.io/component: controller<br/>    app.kubernetes.io/name: aws-load-balancer-controller<br/>  name: aws-load-balancer-controller<br/>  namespace: kube-system<br/>  annotations:<br/>      eks.amazonaws.com/role-arn: arn:aws:iam::&lt;AWS_ACCOUNT_ID&gt;:role/&lt;YOUR_ROLE_NAME&gt;</span></pre><p id="a5e0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">重要提示:</strong>不要更改服务帐户名，因为我们已经在IAM角色的信任策略中配置了该名称</p><ul class=""><li id="fb17" class="ll lm hi ih b ii ij im in iq lz iu ma iy mb jc lq lr ls lt bi translated">在群集上创建服务帐户</li></ul><pre class="jf jg jh ji fd mi mf mj mk aw ml bi"><span id="5380" class="kx jv hi mf b fi mm mn l mo mp">kubectl apply -f aws-load-balancer-controller-service-account.yaml</span></pre><p id="e6ad" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">使用Helm V3 </strong>安装AWS负载平衡器控制器</p><p id="2edf" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">重要提示</strong>:最好将<strong class="ih hj"> Helm与Fargate </strong>一起使用，而不是使用cert-manager，后者是Jetstack的一个Kubernetes插件。证书管理器对Fargate有一些问题。</p><ul class=""><li id="1185" class="ll lm hi ih b ii ij im in iq lz iu ma iy mb jc lq lr ls lt bi translated">将亚马逊EKS图表repo添加到Helm，运行以下命令</li></ul><pre class="jf jg jh ji fd mi mf mj mk aw ml bi"><span id="5cca" class="kx jv hi mf b fi mm mn l mo mp">helm repo add eks https://aws.github.io/eks-charts</span></pre><ul class=""><li id="302b" class="ll lm hi ih b ii ij im in iq lz iu ma iy mb jc lq lr ls lt bi translated">安装<strong class="ih hj"> TargetGroupBinding </strong>自定义资源定义(CRDs)，运行以下命令</li></ul><pre class="jf jg jh ji fd mi mf mj mk aw ml bi"><span id="6f0a" class="kx jv hi mf b fi mm mn l mo mp">kubectl apply -k "github.com/aws/eks-charts/stable/aws-load-balancer-controller//crds?ref=master"</span></pre><ul class=""><li id="2c47" class="ll lm hi ih b ii ij im in iq lz iu ma iy mb jc lq lr ls lt bi translated">安装舵图，运行以下命令</li></ul><pre class="jf jg jh ji fd mi mf mj mk aw ml bi"><span id="ffdb" class="kx jv hi mf b fi mm mn l mo mp">helm install aws-load-balancer-controller eks/aws-load-balancer-controller \<br/>    --set clusterName=YOUR_CLUSTER_NAME \<br/>    --set serviceAccount.create=false \<br/>    --set region=&lt;REGION_CODE&gt; \<br/>    --set vpcId=&lt;VPC_ID&gt; \<br/>    --set serviceAccount.name=aws-load-balancer-controller \<br/>    -n kube-system</span></pre><ul class=""><li id="bbf1" class="ll lm hi ih b ii ij im in iq lz iu ma iy mb jc lq lr ls lt bi translated">验证控制器是否已安装</li></ul><pre class="jf jg jh ji fd mi mf mj mk aw ml bi"><span id="2372" class="kx jv hi mf b fi mm mn l mo mp">kubectl get deployment -n kube-system aws-load-balancer-controller</span></pre><p id="356f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">恭喜🥳，您已经成功安装了AWS负载平衡器控制器。你可以在这里找到更多细节<a class="ae jd" href="https://aws.amazon.com/premiumsupport/knowledge-center/eks-alb-ingress-controller-fargate/" rel="noopener ugc nofollow" target="_blank">，在这里</a>找到<a class="ae jd" href="https://docs.aws.amazon.com/eks/latest/userguide/aws-load-balancer-controller.html" rel="noopener ugc nofollow" target="_blank">。</a></p><h2 id="22a1" class="kx jv hi bd jw ky kz la ka lb lc ld ke iq le lf ki iu lg lh km iy li lj kq lk bi translated">AWS EFS CSI驱动程序</h2><p id="4ff1" class="pw-post-body-paragraph if ig hi ih b ii ks ik il im kt io ip iq ku is it iu kv iw ix iy kw ja jb jc hb bi translated">我们不能在EKS的Fargate模式下使用动态预配置。我们必须使用静态配置。带有Fargate模式的AWS EKS已经带有EFS CSI驱动程序，您可以通过运行以下命令进行验证</p><pre class="jf jg jh ji fd mi mf mj mk aw ml bi"><span id="ccf0" class="kx jv hi mf b fi mm mn l mo mp">kubectl get csidriver</span></pre><p id="3fbb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您将看到类似这样的输出</p><pre class="jf jg jh ji fd mi mf mj mk aw ml bi"><span id="308a" class="kx jv hi mf b fi mm mn l mo mp">NAME              ATTACHREQUIRED   PODINFOONMOUNT   MODES        AGE<br/>efs.csi.aws.com   false            false            Persistent   1d</span></pre><p id="295f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们已经完成了设置亚特兰蒂斯所需的所有资源，现在我们将创建与亚特兰蒂斯设置相关的资源。</p></div><div class="ab cl mq mr gp ms" role="separator"><span class="mt bw bk mu mv mw"/><span class="mt bw bk mu mv mw"/><span class="mt bw bk mu mv"/></div><div class="hb hc hd he hf"><h1 id="a6d9" class="ju jv hi bd jw jx mx jz ka kb my kd ke kf mz kh ki kj na kl km kn nb kp kq kr bi translated">亚特兰蒂斯设置</h1><h2 id="d84f" class="kx jv hi bd jw ky kz la ka lb lc ld ke iq le lf ki iu lg lh km iy li lj kq lk bi translated">存储类</h2><p id="25af" class="pw-post-body-paragraph if ig hi ih b ii ks ik il im kt io ip iq ku is it iu kv iw ix iy kw ja jb jc hb bi translated">创建一个名为<code class="du mc md me mf b">atlantis-storage-class.yml</code>的文件，在你最喜欢的文本编辑器中打开它，添加以下几行</p><pre class="jf jg jh ji fd mi mf mj mk aw ml bi"><span id="d16d" class="kx jv hi mf b fi mm mn l mo mp">kind: StorageClass<br/>apiVersion: storage.k8s.io/v1<br/>metadata:<br/>  name: atlantis-sc<br/>provisioner: efs.csi.aws.com</span></pre><p id="941d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">创建存储类</p><pre class="jf jg jh ji fd mi mf mj mk aw ml bi"><span id="7de7" class="kx jv hi mf b fi mm mn l mo mp">kubectl create -f atlantis-storage-class.yml</span></pre><p id="3097" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">验证存储类是否已成功创建</p><pre class="jf jg jh ji fd mi mf mj mk aw ml bi"><span id="fc9d" class="kx jv hi mf b fi mm mn l mo mp">kubectl get sc atlantis-sc</span><span id="df5d" class="kx jv hi mf b fi nc mn l mo mp">#Output</span><span id="6f49" class="kx jv hi mf b fi nc mn l mo mp">NAME          PROVISIONER       RECLAIMPOLICY   VOLUMEBINDINGMODE   ALLOWVOLUMEEXPANSION   AGE<br/>atlantis-sc   efs.csi.aws.com   Delete          Immediate           false                  10s</span></pre><h2 id="632e" class="kx jv hi bd jw ky kz la ka lb lc ld ke iq le lf ki iu lg lh km iy li lj kq lk bi translated">持久卷</h2><p id="7019" class="pw-post-body-paragraph if ig hi ih b ii ks ik il im kt io ip iq ku is it iu kv iw ix iy kw ja jb jc hb bi translated">如前所述，Atlantis将所有数据存储在本地文件磁盘上，我们将创建持久卷来存储数据</p><p id="506f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">创建一个名为<code class="du mc md me mf b">atlantis-pv.yml</code>的文件，并添加以下内容</p><pre class="jf jg jh ji fd mi mf mj mk aw ml bi"><span id="f766" class="kx jv hi mf b fi mm mn l mo mp">apiVersion: v1<br/>kind: PersistentVolume<br/>metadata:<br/>  name: atlantis-pv<br/>spec:<br/>  capacity:<br/>    storage: 5Gi<br/>  volumeMode: Filesystem<br/>  accessModes:<br/>    - ReadWriteMany<br/>  persistentVolumeReclaimPolicy: Retain<br/>  storageClassName: atlantis-sc<br/>  csi:<br/>    driver: efs.csi.aws.com<br/>    volumeHandle: <strong class="mf hj">&lt;YOUR_FILE_SYSTEM_ID&gt;::&lt;YOUR_FS_ACCESS_POINT_ID&gt;</strong></span></pre><p id="1758" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我已经在PV中给了5Gi的储备，这对于亚特兰蒂斯是足够的。如果需要，您可以添加更多存储空间。当您创建拉式请求时，Atlantis将从回购中降级代码，一旦PR被合并，Atlantis将从本地系统中删除代码。</p><p id="f05f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">创建永久卷</p><pre class="jf jg jh ji fd mi mf mj mk aw ml bi"><span id="df6f" class="kx jv hi mf b fi mm mn l mo mp">kubectl create -f <!-- -->atlantis-pv.yml</span></pre><p id="8714" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">验证是否创建了永久卷</p><pre class="jf jg jh ji fd mi mf mj mk aw ml bi"><span id="3183" class="kx jv hi mf b fi mm mn l mo mp">kubectl get pv atlantis-pv</span></pre><p id="c4ba" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您将看到持久卷处于可用状态。</p><p id="b15b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">重要:</strong></p><ol class=""><li id="e60e" class="ll lm hi ih b ii ij im in iq lz iu ma iy mb jc mh lr ls lt bi translated">确保写入正确的文件系统ID和文件系统访问点</li><li id="e5eb" class="ll lm hi ih b ii lu im lv iq lw iu lx iy ly jc mh lr ls lt bi translated">不要更改存储类名称，因为我们在上一步创建存储类时已经使用了该名称</li></ol><h2 id="42fa" class="kx jv hi bd jw ky kz la ka lb lc ld ke iq le lf ki iu lg lh km iy li lj kq lk bi translated">持续量索赔</h2><p id="117e" class="pw-post-body-paragraph if ig hi ih b ii ks ik il im kt io ip iq ku is it iu kv iw ix iy kw ja jb jc hb bi translated">如果您熟悉K8s概念，那么在创建Statefulset或Pod或部署时，每个PV只能使用PVC进行安装</p><p id="1653" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">创建一个名为<code class="du mc md me mf b">atlantis-pvc.yml</code>的文件，并添加以下几行</p><pre class="jf jg jh ji fd mi mf mj mk aw ml bi"><span id="ef43" class="kx jv hi mf b fi mm mn l mo mp">apiVersion: v1<br/>kind: PersistentVolumeClaim<br/>metadata:<br/>  name: atlantis-claim<br/>spec:<br/>  accessModes:<br/>    - ReadWriteMany<br/>  storageClassName: atlantis-sc<br/>  resources:<br/>    requests:<br/>      storage: 5Gi</span></pre><p id="9fd5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">创建永久卷索赔</p><pre class="jf jg jh ji fd mi mf mj mk aw ml bi"><span id="4361" class="kx jv hi mf b fi mm mn l mo mp">kubectl create -f <!-- -->atlantis-pvc.yml</span></pre><p id="1fc0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">验证是否创建了永久卷声明</p><pre class="jf jg jh ji fd mi mf mj mk aw ml bi"><span id="74a1" class="kx jv hi mf b fi mm mn l mo mp">kubectl get pvc atlantis-claim</span><span id="c6ef" class="kx jv hi mf b fi nc mn l mo mp">#Output</span><span id="fada" class="kx jv hi mf b fi nc mn l mo mp">NAME             STATUS   VOLUME        CAPACITY   ACCESS MODES   STORAGECLASS   AGE<br/>atlantis-claim   Bound    atlantis-pv   5Gi        RWX            atlantis-sc    5s</span></pre><p id="7dc3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">重要提示:</strong></p><ol class=""><li id="4cbc" class="ll lm hi ih b ii ij im in iq lz iu ma iy mb jc mh lr ls lt bi translated">不要更改存储类名和存储值，这些值应该与PV的配置相匹配</li><li id="a6e1" class="ll lm hi ih b ii lu im lv iq lw iu lx iy ly jc mh lr ls lt bi translated">确保PVC的<strong class="ih hj">状态</strong>为<strong class="ih hj">绑定</strong></li></ol><h2 id="7549" class="kx jv hi bd jw ky kz la ka lb lc ld ke iq le lf ki iu lg lh km iy li lj kq lk bi translated">秘密</h2><p id="7ec7" class="pw-post-body-paragraph if ig hi ih b ii ks ik il im kt io ip iq ku is it iu kv iw ix iy kw ja jb jc hb bi translated">我们将在kubernetes秘密中存储我们的应用程序密码和Web-hook令牌(BitBucket不需要),然后我们将这个秘密注入statefulset，这样Atlantis就可以从repo中克隆我们的代码</p><p id="bc3b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果您正在使用BitBucket</p><pre class="jf jg jh ji fd mi mf mj mk aw ml bi"><span id="9d46" class="kx jv hi mf b fi mm mn l mo mp"># Write your token in file</span><span id="87ab" class="kx jv hi mf b fi nc mn l mo mp">echo -n "yourtoken" &gt; token</span><span id="3cac" class="kx jv hi mf b fi nc mn l mo mp"># Create secret</span><span id="69e3" class="kx jv hi mf b fi nc mn l mo mp">kubectl create secret generic atlantis-vcs --from-file=token</span></pre><p id="0155" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果您使用的是其他VCS</p><pre class="jf jg jh ji fd mi mf mj mk aw ml bi"><span id="7fc6" class="kx jv hi mf b fi mm mn l mo mp"># Write your token and webhook secret in file</span><span id="f0c7" class="kx jv hi mf b fi nc mn l mo mp">echo -n "yourtoken" &gt; token<br/>echo -n "yoursecret" &gt; webhook-secret</span><span id="5e6d" class="kx jv hi mf b fi nc mn l mo mp"># Create Secret</span><span id="562c" class="kx jv hi mf b fi nc mn l mo mp">kubectl create secret generic atlantis-vcs --from-file=token --from-file=webhook-secret</span></pre><p id="e231" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">验证机密是否已成功创建</p><pre class="jf jg jh ji fd mi mf mj mk aw ml bi"><span id="0186" class="kx jv hi mf b fi mm mn l mo mp">kubectl get secret <!-- -->atlantis-vcs</span></pre><h2 id="43a0" class="kx jv hi bd jw ky kz la ka lb lc ld ke iq le lf ki iu lg lh km iy li lj kq lk bi translated">Atlantis服务器端配置</h2><p id="b034" class="pw-post-body-paragraph if ig hi ih b ii ks ik il im kt io ip iq ku is it iu kv iw ix iy kw ja jb jc hb bi translated">服务器端回购配置文件用于控制每次回购的行为。例如，如果您想要求所有(或特定)回购必须在Atlantis允许运行<code class="du mc md me mf b">apply.</code>之前获得批准</p><p id="a688" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们将创建一个K8s ConfigMap对象来存储Atlantis的服务器端配置，并且我们将在Atlantis中使用这个配置</p><p id="52b3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">注意:</strong>你可以在这里阅读更多关于Atlantis服务器端配置<a class="ae jd" href="https://www.runatlantis.io/docs/server-side-repo-config.html" rel="noopener ugc nofollow" target="_blank">的内容。</a></p><p id="db87" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">创建一个名为<code class="du mc md me mf b">atlantis-repo-config-configmap.yml</code>的文件</p><pre class="jf jg jh ji fd mi mf mj mk aw ml bi"><span id="0066" class="kx jv hi mf b fi mm mn l mo mp">apiVersion: v1<br/>kind: ConfigMap<br/>metadata:<br/>  name: atlantis-repo-config<br/>data:<br/>  repos.yaml: |<br/>    repos:<br/>      # id can either be an exact repo ID or a regex.<br/>      # If using a regex, it must start and end with a slash.<br/>      # Repo ID's are of the form {VCS hostname}/{org}/{repo name}<br/>      # ex. github.com/runatlantis/atlantis.<br/>      - id: <!-- -->{VCS hostname}/{org}/{repo name}<br/>        apply_requirements: [<!-- -->approved<!-- -->]<br/>        allowed_overrides: [workflow]<br/>        allow_custom_workflows: true</span></pre><p id="cb3a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">根据您的回购URL替换<code class="du mc md me mf b">{VCS hostname}/{org}/{repo name}</code></p><p id="5612" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在这个repo配置中，Atlantis将只允许在拉动请求被批准时运行<code class="du mc md me mf b">apply</code>命令。您可以根据自己的需求进行配置</p><p id="a441" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用以下命令创建配置映射</p><pre class="jf jg jh ji fd mi mf mj mk aw ml bi"><span id="72d3" class="kx jv hi mf b fi mm mn l mo mp">kubectl create -f <!-- -->atlantis-repo-config-configmap.yml</span></pre><p id="9d37" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">验证配置映射是否已成功创建</p><pre class="jf jg jh ji fd mi mf mj mk aw ml bi"><span id="d2ea" class="kx jv hi mf b fi mm mn l mo mp">kubectl get cm atlantis-repo-config</span><span id="78e2" class="kx jv hi mf b fi nc mn l mo mp"># Output</span><span id="5603" class="kx jv hi mf b fi nc mn l mo mp">NAME                   DATA   AGE<br/>atlantis-repo-config   1      10s</span></pre><h2 id="9151" class="kx jv hi bd jw ky kz la ka lb lc ld ke iq le lf ki iu lg lh km iy li lj kq lk bi translated">亚特兰蒂斯的服务帐户</h2><p id="0d28" class="pw-post-body-paragraph if ig hi ih b ii ks ik il im kt io ip iq ku is it iu kv iw ix iy kw ja jb jc hb bi translated">我们知道Atlantis将运行Terraform命令，它将创建、更新或销毁资源，但是为了完成所有这些事情，我们的Atlantis容器应该具有适当的IAM权限来在AWS中创建任何资源，因此我们将为服务帐户(IRSA)创建IAM角色</p><p id="99da" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">你必须知道，每个Faragte配置文件都有Faragte Pod执行角色，它可以授予调用AWS API的权限。由于Terraform将拥有执行所有操作的管理员权限，因此不建议在Pod执行角色中授予管理员权限，因为这样做会将不必要的管理员权限授予其他Pod。因此，我们使用IRSA来控制POD级别的权限。</p><p id="e3fc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在部署AWS负载平衡器控制器时，我们已经为集群创建了一个OIDC提供者。</p><p id="6fb1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这包括两个部分，第一部分是我们创建具有必要权限的IAM角色，第二部分是我们创建服务帐户并将该SA附加到K8s中的POD</p><p id="3cb8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">创建IAM角色</strong></p><ul class=""><li id="d0e5" class="ll lm hi ih b ii ij im in iq lz iu ma iy mb jc lq lr ls lt bi translated">打开IAM控制台</li><li id="1881" class="ll lm hi ih b ii lu im lv iq lw iu lx iy ly jc lq lr ls lt bi translated">在导航面板中，选择<strong class="ih hj">角色</strong>，<strong class="ih hj">创建角色</strong></li><li id="2ce7" class="ll lm hi ih b ii lu im lv iq lw iu lx iy ly jc lq lr ls lt bi translated">在<strong class="ih hj">选择可信实体类型</strong>部分，选择<strong class="ih hj"> Web身份</strong></li><li id="2c31" class="ll lm hi ih b ii lu im lv iq lw iu lx iy ly jc lq lr ls lt bi translated">在<strong class="ih hj">选择网络身份提供商</strong>部分</li></ul><p id="d10d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">I .对于<strong class="ih hj">身份提供者</strong>，选择您的集群的URL</p><p id="5eaf" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">二。对于<strong class="ih hj">观众</strong>，选择<code class="du mc md me mf b">sts.amazonaws.com</code></p><ul class=""><li id="b4c9" class="ll lm hi ih b ii ij im in iq lz iu ma iy mb jc lq lr ls lt bi translated">选择<strong class="ih hj">下一步:权限</strong></li><li id="1cb7" class="ll lm hi ih b ii lu im lv iq lw iu lx iy ly jc lq lr ls lt bi translated">在<strong class="ih hj">附加策略</strong>部分，选择<code class="du mc md me mf b">AdministratorAccess</code>策略</li><li id="3ad7" class="ll lm hi ih b ii lu im lv iq lw iu lx iy ly jc lq lr ls lt bi translated">选择<strong class="ih hj">下一步:标签</strong></li><li id="d0a4" class="ll lm hi ih b ii lu im lv iq lw iu lx iy ly jc lq lr ls lt bi translated">在<strong class="ih hj">添加标签(可选)</strong>屏幕上，您可以为帐户添加标签。选择<strong class="ih hj">下一步:复习</strong></li><li id="d394" class="ll lm hi ih b ii lu im lv iq lw iu lx iy ly jc lq lr ls lt bi translated">对于<strong class="ih hj">角色名称</strong>，输入您的角色名称，如<code class="du mc md me mf b"><em class="mg">Atlantis-Admin-Role</em></code>，然后选择<strong class="ih hj">创建角色</strong></li><li id="3d02" class="ll lm hi ih b ii lu im lv iq lw iu lx iy ly jc lq lr ls lt bi translated">创建角色后，在控制台中选择角色以打开它进行编辑</li><li id="02c1" class="ll lm hi ih b ii lu im lv iq lw iu lx iy ly jc lq lr ls lt bi translated">选择<strong class="ih hj">信任关系</strong>选项卡，然后选择<strong class="ih hj">编辑信任关系</strong></li></ul><p id="2cf0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">找到类似如下的行:</p><pre class="jf jg jh ji fd mi mf mj mk aw ml bi"><span id="5448" class="kx jv hi mf b fi mm mn l mo mp">"oidc.eks.&lt;<em class="mg">region-code</em>&gt;.amazonaws.com/id/EXAMPLED539D4633E53DE1B716D3041E:aud": "sts.amazonaws.com"</span></pre><p id="f07d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">将该行更改为如下所示。将<code class="du mc md me mf b"><em class="mg">&lt;EXAMPLED539D4633E53DE1B716D3041E&gt;</em></code>(包括<code class="du mc md me mf b"><em class="mg">&lt;&gt;</em></code>)替换为您的集群的OIDC提供商ID，将<code class="du mc md me mf b"><em class="mg">&lt;region-code&gt;</em></code>替换为您的集群所在的地区代码</p><pre class="jf jg jh ji fd mi mf mj mk aw ml bi"><span id="f45f" class="kx jv hi mf b fi mm mn l mo mp">"oidc.eks.<em class="mg">&lt;region-code&gt;</em>.amazonaws.com/id/<em class="mg">&lt;EXAMPLED539D4633E53DE1B716D3041E&gt;</em>:sub": "system:serviceaccount:default:atlantis-sa"</span></pre><ul class=""><li id="3911" class="ll lm hi ih b ii ij im in iq lz iu ma iy mb jc lq lr ls lt bi translated">选择<strong class="ih hj">更新信任策略</strong>完成</li><li id="a0c7" class="ll lm hi ih b ii lu im lv iq lw iu lx iy ly jc lq lr ls lt bi translated">记下角色的ARN，以便在后面的步骤中使用</li></ul><p id="6d9d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">创建服务账户</strong></p><p id="7451" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">将以下内容保存到名为<code class="du mc md me mf b"><em class="mg">atlantis-service-account.yml</em></code>的文件中</p><pre class="jf jg jh ji fd mi mf mj mk aw ml bi"><span id="4a11" class="kx jv hi mf b fi mm mn l mo mp">apiVersion: v1<br/>kind: ServiceAccount<br/>metadata:<br/>  name: atlantis-sa<br/>  annotations:<br/>      eks.amazonaws.com/role-arn: arn:aws:iam::&lt;AWS_ACCOUNT_ID&gt;:role/&lt;YOUR_IAM_ROLE_NAME&gt;</span></pre><p id="0e3d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">重要提示:</strong>不要更改服务帐户名称，因为我们已经在IAM角色的信任策略中配置了该名称</p><h2 id="7b3e" class="kx jv hi bd jw ky kz la ka lb lc ld ke iq le lf ki iu lg lh km iy li lj kq lk bi translated">有状态集合</h2><p id="d21f" class="pw-post-body-paragraph if ig hi ih b ii ks ik il im kt io ip iq ku is it iu kv iw ix iy kw ja jb jc hb bi translated">我们已经拥有了所有需要的K8s资源，现在我们准备创建有状态的Set，它将在AWS EKS Faragte集群中运行Atlantis服务器</p><p id="c0ec" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">创建一个名为<code class="du mc md me mf b">atlantis-stateful-set.yml</code>的文件，如下所示:</p><p id="22db" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">注意:</strong>我使用BitBucket作为我的VCS，所以下面的文件有基于BitBucket VCS的环境变量。</p><p id="7ce2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果您使用的是VCS而不是位存储桶，则替换<strong class="ih hj"> ###位存储桶配置# # #</strong>…………<strong class="ih hj"># # # End bit bucket Config # # #</strong>您可以将此<a class="ae jd" href="https://www.runatlantis.io/docs/deployment.html#deployment-2" rel="noopener ugc nofollow" target="_blank">链接</a>用于您的VCS特定环境变量。</p><pre class="jf jg jh ji fd mi mf mj mk aw ml bi"><span id="a0e3" class="kx jv hi mf b fi mm mn l mo mp">apiVersion: apps/v1<br/>kind: StatefulSet<br/>metadata:<br/>  name: atlantis<br/>spec:<br/>  serviceName: atlantis<br/>  replicas: 1<br/>  updateStrategy:<br/>    type: RollingUpdate<br/>    rollingUpdate:<br/>      partition: 0<br/>  selector:<br/>    matchLabels:<br/>      app: atlantis<br/>  template:<br/>    metadata:<br/>      labels:<br/>        app: atlantis<br/>    spec:<br/>      serviceAccountName: atlantis-sa<br/>      securityContext:<br/>        fsGroup: 1000 # Atlantis group (1000) read/write access to volumes.<br/>      volumes:<br/>        - name: repo-config<br/>          configMap:<br/>            name: atlantis-repo-config<br/>        - name: atlantis-data<br/>          persistentVolumeClaim:<br/>            claimName: atlantis-claim<br/>      containers:<br/>      - name: atlantis<br/>        image: runatlantis/atlantis:v0.17.0 # 1. Replace &lt;VERSION&gt; with the most recent release.<br/>        env:<br/>        - name: ATLANTIS_REPO_ALLOWLIST<br/>          value: <strong class="mf hj">{VCS hostname}/{org}/{repo name}</strong> # 2. Replace this with your own repo allowlist.</span><span id="0102" class="kx jv hi mf b fi nc mn l mo mp">        - name: ATLANTIS_DEFAULT_TF_VERSION<br/>          value: <strong class="mf hj">&lt;YOUR_TF_VERSION&gt;</strong></span><span id="c777" class="kx jv hi mf b fi nc mn l mo mp">        ### Bitbucket Config ###<br/>        - name: ATLANTIS_BITBUCKET_USER<br/>          value: <strong class="mf hj">&lt;YOUR_BITBUCKET_USER&gt;</strong> # 5i. If you're using Bitbucket replace &lt;YOUR_BITBUCKET_USER&gt; with the username of your Atlantis Bitbucket user without the `@`.<br/>        - name: ATLANTIS_BITBUCKET_TOKEN<br/>          valueFrom:<br/>            secretKeyRef:<br/>              name: atlantis-vcs<br/>              key: token<br/>        ### End Bitbucket Config ###</span><span id="c3c8" class="kx jv hi mf b fi nc mn l mo mp">        - name: ATLANTIS_DATA_DIR<br/>          value: /atlantis<br/>        - name: ATLANTIS_PORT<br/>          value: "4141" # Kubernetes sets an ATLANTIS_PORT variable so we need to override.<br/>        - name: ATLANTIS_REPO_CONFIG<br/>          value: /atlantis/repos.yaml<br/>        volumeMounts:<br/>        - name: atlantis-data<br/>          mountPath: /atlantis<br/>        - name: repo-config<br/>          mountPath: /atlantis/repos.yaml<br/>          subPath: repos.yaml<br/>          readOnly: true<br/>        ports:<br/>        - name: atlantis<br/>          containerPort: 4141<br/>        resources:<br/>          requests:<br/>            memory: 256Mi<br/>            cpu: 100m<br/>          limits:<br/>            memory: 256Mi<br/>            cpu: 100m<br/>        livenessProbe:<br/>          # We only need to check every 60s since Atlantis is not a<br/>          # high-throughput service.<br/>          periodSeconds: 60<br/>          httpGet:<br/>            path: /healthz<br/>            port: 4141<br/>            # If using https, change this to HTTPS<br/>            scheme: HTTP<br/>        readinessProbe:<br/>          periodSeconds: 60<br/>          httpGet:<br/>            path: /healthz<br/>            port: 4141<br/>            # If using https, change this to HTTPS<br/>            scheme: HTTP</span></pre><p id="485b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">需要注意的要点:</p><ol class=""><li id="c4f2" class="ll lm hi ih b ii ij im in iq lz iu ma iy mb jc mh lr ls lt bi translated">我们正在使用<code class="du mc md me mf b">/atlantis</code>作为数据目录来存储所有亚特兰蒂斯相关的数据，我们已经在EFS接入点配置了相同的路径</li><li id="6262" class="ll lm hi ih b ii lu im lv iq lw iu lx iy ly jc mh lr ls lt bi translated">亚特兰蒂斯将监听端口<code class="du mc md me mf b">4141</code></li><li id="edf7" class="ll lm hi ih b ii lu im lv iq lw iu lx iy ly jc mh lr ls lt bi translated">我们使用<code class="du mc md me mf b">Service Account</code>来授予调用AWS API调用的权限</li><li id="790a" class="ll lm hi ih b ii lu im lv iq lw iu lx iy ly jc mh lr ls lt bi translated">我们已经安装了<code class="du mc md me mf b">PersistentVolumeClaim</code>，它将把我们的数据存储在AWS弹性文件系统中</li><li id="f9c9" class="ll lm hi ih b ii lu im lv iq lw iu lx iy ly jc mh lr ls lt bi translated">我们用的是亚特兰蒂斯版本<code class="du mc md me mf b">v0.17.0</code></li><li id="c200" class="ll lm hi ih b ii lu im lv iq lw iu lx iy ly jc mh lr ls lt bi translated">带有<code class="du mc md me mf b">v0.17.0</code>的Atlantis映像带有默认的Terraform版本<code class="du mc md me mf b">0.15.1</code>，因此如果您使用的是除此之外的Terraform版本，那么您需要设置<code class="du mc md me mf b">ATLANTIS_DEFAULT_TF_VERSION</code> Env变量。</li><li id="0815" class="ll lm hi ih b ii lu im lv iq lw iu lx iy ly jc mh lr ls lt bi translated">我们已经从ConfigMap挂载了我们的服务器端repo配置</li></ol><p id="beb9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Atlantis提供了多个服务器参数，你可以在这里参考支持的参数<a class="ae jd" href="https://www.runatlantis.io/docs/server-configuration.html" rel="noopener ugc nofollow" target="_blank">。每个服务器参数都可以在我们的容器中设置为环境变量。设置环境变量的格式可以在</a><a class="ae jd" href="https://www.runatlantis.io/docs/server-configuration.html#environment-variables" rel="noopener ugc nofollow" target="_blank">这里</a>找到。我们有状态设置文件中的每个环境变量都使用相同的语法。</p><p id="ed16" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用以下命令创建有状态集</p><pre class="jf jg jh ji fd mi mf mj mk aw ml bi"><span id="7ddd" class="kx jv hi mf b fi mm mn l mo mp">kubectl create -f <!-- -->atlantis-stateful-set.yml</span></pre><p id="bed2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">验证有状态集正在运行您的容器</p><pre class="jf jg jh ji fd mi mf mj mk aw ml bi"><span id="4da4" class="kx jv hi mf b fi mm mn l mo mp">kubectl get sts atlantis</span><span id="dfe9" class="kx jv hi mf b fi nc mn l mo mp">NAME       READY   AGE<br/>atlantis   1/1     200s</span></pre><p id="a6af" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">验证pod正在运行</p><pre class="jf jg jh ji fd mi mf mj mk aw ml bi"><span id="e672" class="kx jv hi mf b fi mm mn l mo mp">kubectl get po</span><span id="3e05" class="kx jv hi mf b fi nc mn l mo mp">NAME         READY   STATUS    RESTARTS   AGE<br/>atlantis-0   1/1     Running   0          300s</span></pre><p id="c7b2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">查看亚特兰蒂斯号的日志</p><pre class="jf jg jh ji fd mi mf mj mk aw ml bi"><span id="1ef1" class="kx jv hi mf b fi mm mn l mo mp">kubectl logs atlantis-0 --tail=100</span></pre><p id="ba00" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">要调试该问题，您可以检查日志或描述pod</p><pre class="jf jg jh ji fd mi mf mj mk aw ml bi"><span id="1bab" class="kx jv hi mf b fi mm mn l mo mp">kubectl describe po atlantis-0</span></pre><p id="798a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">恭喜你，🥳，你已经成功运行了亚特兰蒂斯服务器</p><h2 id="2c85" class="kx jv hi bd jw ky kz la ka lb lc ld ke iq le lf ki iu lg lh km iy li lj kq lk bi translated"><strong class="ak">公开有状态集合</strong></h2><p id="ff7f" class="pw-post-body-paragraph if ig hi ih b ii ks ik il im kt io ip iq ku is it iu kv iw ix iy kw ja jb jc hb bi translated">我们已经成功配置了我们的Atlantis服务器，现在我们将创建一个NodePort和Ingress资源类型的服务来公开我们的Atlantis服务器。</p><p id="6dc1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">创建服务</strong></p><p id="9219" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">创建名为<code class="du mc md me mf b">atlantis-service.yml</code>的文件，并添加以下行</p><pre class="jf jg jh ji fd mi mf mj mk aw ml bi"><span id="44ae" class="kx jv hi mf b fi mm mn l mo mp">apiVersion: v1<br/>kind: Service<br/>metadata:<br/>  name: atlantis<br/>spec:<br/>  type: NodePort<br/>  ports:<br/>  - name: atlantis<br/>    port: 80<br/>    targetPort: 4141<br/>  selector:<br/>    app: atlantis</span></pre><p id="860a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">重要提示:</strong></p><ol class=""><li id="a896" class="ll lm hi ih b ii ij im in iq lz iu ma iy mb jc mh lr ls lt bi translated">不要更改服务名，因为我们已经在有状态集中使用了这个名称</li><li id="9632" class="ll lm hi ih b ii lu im lv iq lw iu lx iy ly jc mh lr ls lt bi translated">它建议不要选择任何特定的节点端口，让K8s为我们决定端口，因为我们将使用入口来控制流量的路由</li></ol><p id="d7d6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">创建入口</strong></p><p id="7eda" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，我们将创建入口，将流量路由到我们的服务。它将创建应用程序负载平衡器(ALB ),因为我们已经部署了ALB入口控制器。我还配置了注释来设置来自ACM的SSL证书，并将HTTP重定向到HTTPS</p><p id="bbe0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">创建一个名为<code class="du mc md me mf b">atlantis-ing.yml</code>的文件，并添加以下几行</p><pre class="jf jg jh ji fd mi mf mj mk aw ml bi"><span id="108f" class="kx jv hi mf b fi mm mn l mo mp">apiVersion: extensions/v1beta1<br/>kind: Ingress<br/>metadata:<br/>  name: atlantis-ingress<br/>  annotations:<br/>    kubernetes.io/ingress.class: alb<br/>    alb.ingress.kubernetes.io/scheme: internet-facing<br/>    alb.ingress.kubernetes.io/target-type: ip<br/>    alb.ingress.kubernetes.io/certificate-arn: &lt;YOUR_ACM_ARN&gt;<br/>    alb.ingress.kubernetes.io/listen-ports: '[{"HTTP": 80}, {"HTTPS":443}]'<br/>    alb.ingress.kubernetes.io/actions.ssl-redirect: '{"Type": "redirect", "RedirectConfig": { "Protocol": "HTTPS", "Port": "443", "StatusCode": "HTTP_301"}}'<br/>spec:<br/>  rules:<br/>    - http:<br/>        paths:<br/>          - path: /*<br/>            backend:<br/>              serviceName: ssl-redirect<br/>              servicePort: use-annotation<br/>          - path: /*<br/>            backend:<br/>              serviceName: atlantis<br/>              servicePort: 80</span></pre><p id="750e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果您没有域名或不想使用SSL和证书，请使用以下入口配置</p><pre class="jf jg jh ji fd mi mf mj mk aw ml bi"><span id="d45b" class="kx jv hi mf b fi mm mn l mo mp">apiVersion: extensions/v1beta1<br/>kind: Ingress<br/>metadata:<br/>  name: ingress-resource<br/>  annotations:<br/>    kubernetes.io/ingress.class: alb<br/>    alb.ingress.kubernetes.io/scheme: internet-facing<br/>    alb.ingress.kubernetes.io/target-type: ip<br/>    alb.ingress.kubernetes.io/listen-ports: '[{"HTTP": 80}]'<br/>spec:<br/>  rules:<br/>    - http:<br/>        paths:<br/>          - path: /*<br/>            backend:<br/>              serviceName: atlantis<br/>              servicePort: 80</span></pre><p id="71f1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">重要提示:</strong></p><ol class=""><li id="8a78" class="ll lm hi ih b ii ij im in iq lz iu ma iy mb jc mh lr ls lt bi translated">对于EKS法盖特发射类型，<code class="du mc md me mf b">target-type</code>必须是ip</li></ol><p id="06ff" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">你可以在这里阅读更多关于ALB入口控制器支持的注释。</p><p id="c676" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用以下命令创建入口</p><pre class="jf jg jh ji fd mi mf mj mk aw ml bi"><span id="de5f" class="kx jv hi mf b fi mm mn l mo mp">kubectl create -f <!-- -->atlantis-ing.yml</span></pre><p id="6222" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">验证入口是否已创建</p><pre class="jf jg jh ji fd mi mf mj mk aw ml bi"><span id="fcb4" class="kx jv hi mf b fi mm mn l mo mp">kubectl get ing ingress-resource</span><span id="e2e1" class="kx jv hi mf b fi nc mn l mo mp">Warning: extensions/v1beta1 Ingress is deprecated in v1.14+, unavailable in v1.22+; use networking.k8s.io/v1 Ingress<br/>NAME               CLASS    HOSTS   ADDRESS                                                                   PORTS   AGE<br/>atlantis-ingress   &lt;none&gt;   *       k8s-default-xxxxxxx-xxxxxxxxx-xxxxxxxxx.&lt;your_region&gt;.elb.amazonaws.com   80      10s</span></pre><p id="ce9c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">注意:</strong>如果几分钟后仍未创建入口，请运行以下命令查看负载平衡器控制器日志。这些日志可能包含有助于您诊断部署问题的错误消息。</p><pre class="jf jg jh ji fd mi mf mj mk aw ml bi"><span id="5de6" class="kx jv hi mf b fi mm mn l mo mp">kubectl logs -n kube-system deployment.apps/aws-load-balancer-controller</span></pre><h2 id="a616" class="kx jv hi bd jw ky kz la ka lb lc ld ke iq le lf ki iu lg lh km iy li lj kq lk bi translated">在Route53中创建别名</h2><p id="5363" class="pw-post-body-paragraph if ig hi ih b ii ks ik il im kt io ip iq ku is it iu kv iw ix iy kw ja jb jc hb bi translated">一旦使用SSL证书创建了入口，您就可以通过在路由53中创建<strong class="ih hj">别名记录集</strong>来将ALB的URL映射到路由53</p><h2 id="e89f" class="kx jv hi bd jw ky kz la ka lb lc ld ke iq le lf ki iu lg lh km iy li lj kq lk bi translated">配置Webhooks</h2><p id="8fd8" class="pw-post-body-paragraph if ig hi ih b ii ks ik il im kt io ip iq ku is it iu kv iw ix iy kw ja jb jc hb bi translated">Atlantis需要从您的Git主机接收Webhooks，以便它能够响应pull请求事件</p><p id="e645" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您可以使用链接<a class="ae jd" href="https://www.runatlantis.io/docs/configuring-webhooks.html" rel="noopener ugc nofollow" target="_blank">https://www.runatlantis.io/docs/configuring-webhooks.html</a>根据您的VCS配置Webhooks</p><p id="b437" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">重要:</strong></p><ol class=""><li id="d131" class="ll lm hi ih b ii ij im in iq lz iu ma iy mb jc mh lr ls lt bi translated">写入URL时，请确保写入Route 53记录名称或K8s入口资源地址。</li></ol><h1 id="eaec" class="ju jv hi bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">恭喜你！</h1><p id="8175" class="pw-post-body-paragraph if ig hi ih b ii ks ik il im kt io ip iq ku is it iu kv iw ix iy kw ja jb jc hb bi translated">您已经成功地完成了配置Atlantis服务器的所有步骤，现在您可以测试它了。</p><p id="8f14" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在您的repo中创建一个分支，进行一些代码更改，将您的代码推送到Repo中，而不是从本地或自动化服务器运行Terraform，创建一个pull请求，一旦您创建了它，Atlantis将开始对它进行操作，它将使用<code class="du mc md me mf b">plan</code>对您的PR进行评论。Atlantis需要一些时间对您的PR进行评论，因为它将在内部运行命令，一旦完成，它将对PR进行评论</p><p id="9d4b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您可以从容器中查看日志来调试任何问题。它对我来说也是新的，但是如果你有任何问题或者你面临任何问题，你可以联系我。</p><p id="db64" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> <em class="mg">谢谢！</em> </strong></p><h1 id="b086" class="ju jv hi bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">参考</h1><ul class=""><li id="24d8" class="ll lm hi ih b ii ks im kt iq ln iu lo iy lp jc lq lr ls lt bi translated"><a class="ae jd" href="https://aws.amazon.com/premiumsupport/knowledge-center/eks-alb-ingress-controller-fargate/" rel="noopener ugc nofollow" target="_blank">https://AWS . Amazon . com/premium support/knowledge-center/eks-ALB-ingress-controller-fargate/</a></li><li id="4501" class="ll lm hi ih b ii lu im lv iq lw iu lx iy ly jc lq lr ls lt bi translated"><a class="ae jd" href="https://docs.aws.amazon.com/eks/latest/userguide/aws-load-balancer-controller.html" rel="noopener ugc nofollow" target="_blank">https://docs . AWS . Amazon . com/eks/latest/user guide/AWS-load-balancer-controller . html</a></li><li id="ac8f" class="ll lm hi ih b ii lu im lv iq lw iu lx iy ly jc lq lr ls lt bi translated"><a class="ae jd" href="https://docs.aws.amazon.com/eks/latest/userguide/alb-ingress.html" rel="noopener ugc nofollow" target="_blank">https://docs . AWS . Amazon . com/eks/latest/user guide/al b-ingress . html</a></li><li id="c3c9" class="ll lm hi ih b ii lu im lv iq lw iu lx iy ly jc lq lr ls lt bi translated"><a class="ae jd" href="https://docs.aws.amazon.com/eks/latest/userguide/iam-roles-for-service-accounts.html" rel="noopener ugc nofollow" target="_blank">https://docs . AWS . Amazon . com/eks/latest/user guide/iam-roles-for-service-accounts . html</a></li><li id="e37b" class="ll lm hi ih b ii lu im lv iq lw iu lx iy ly jc lq lr ls lt bi translated"><a class="ae jd" href="https://kubernetes-sigs.github.io/aws-load-balancer-controller/v2.2/guide/ingress/annotations/" rel="noopener ugc nofollow" target="_blank">https://kubernetes-sigs . github . io/AWS-load-balancer-controller/v 2.2/guide/ingress/annotations/</a></li><li id="6cf7" class="ll lm hi ih b ii lu im lv iq lw iu lx iy ly jc lq lr ls lt bi translated"><a class="ae jd" href="https://kubernetes-sigs.github.io/aws-load-balancer-controller/v2.2/guide/tasks/ssl_redirect/" rel="noopener ugc nofollow" target="_blank">https://kubernetes-sigs . github . io/AWS-load-balancer-controller/v 2.2/guide/tasks/SSL _ redirect/</a></li><li id="ad9b" class="ll lm hi ih b ii lu im lv iq lw iu lx iy ly jc lq lr ls lt bi translated"><a class="ae jd" href="https://aws.amazon.com/blogs/containers/running-stateful-workloads-with-amazon-eks-on-aws-fargate-using-amazon-efs/" rel="noopener ugc nofollow" target="_blank">https://AWS . Amazon . com/blogs/containers/running-stateful-workloads-with-Amazon-eks-on-AWS-fargate-using-Amazon-EFS/</a></li><li id="85de" class="ll lm hi ih b ii lu im lv iq lw iu lx iy ly jc lq lr ls lt bi translated"><a class="ae jd" href="https://dev.to/k8sdev/deploying-statefulset-on-private-eks-on-fargate-cluster-with-efs-4gph" rel="noopener ugc nofollow" target="_blank">https://dev . to/k8s dev/deploying-stateful set-on-private-eks-on-fargate-cluster-with-EFS-4gph</a></li><li id="eb9a" class="ll lm hi ih b ii lu im lv iq lw iu lx iy ly jc lq lr ls lt bi translated">【https://www.runatlantis.io/docs/server-configuration.html T4】</li><li id="6019" class="ll lm hi ih b ii lu im lv iq lw iu lx iy ly jc lq lr ls lt bi translated"><a class="ae jd" href="https://www.runatlantis.io/docs/deployment.html#deployment-2" rel="noopener ugc nofollow" target="_blank">https://www . run Atlantis . io/docs/deployment . html # deployment-2</a></li><li id="e29b" class="ll lm hi ih b ii lu im lv iq lw iu lx iy ly jc lq lr ls lt bi translated"><a class="ae jd" href="https://www.runatlantis.io/docs/server-side-repo-config.html#do-i-need-a-server-side-repo-config-file" rel="noopener ugc nofollow" target="_blank">https://www . run Atlantis . io/docs/server-side-repo-config . html # do-I-need-a-server-side-repo-config-file</a></li><li id="f106" class="ll lm hi ih b ii lu im lv iq lw iu lx iy ly jc lq lr ls lt bi translated"><a class="ae jd" href="https://www.runatlantis.io/docs/apply-requirements.html" rel="noopener ugc nofollow" target="_blank">https://www.runatlantis.io/docs/apply-requirements.html</a></li><li id="583e" class="ll lm hi ih b ii lu im lv iq lw iu lx iy ly jc lq lr ls lt bi translated"><a class="ae jd" href="https://www.runatlantis.io/docs/custom-workflows.html#use-cases" rel="noopener ugc nofollow" target="_blank">https://www . run Atlantis . io/docs/custom-workflows . html #用例</a></li><li id="c29f" class="ll lm hi ih b ii lu im lv iq lw iu lx iy ly jc lq lr ls lt bi translated"><a class="ae jd" href="https://www.runatlantis.io/docs/repo-level-atlantis-yaml.html" rel="noopener ugc nofollow" target="_blank">https://www . run Atlantis . io/docs/repo-level-Atlantis-YAML . html</a></li><li id="f3ce" class="ll lm hi ih b ii lu im lv iq lw iu lx iy ly jc lq lr ls lt bi translated"><a class="ae jd" href="https://github.com/runatlantis/helm-charts/blob/main/charts/atlantis/templates/statefulset.yaml" rel="noopener ugc nofollow" target="_blank">https://github . com/run Atlantis/helm-charts/blob/main/charts/Atlantis/templates/stateful set . YAML</a></li><li id="36f1" class="ll lm hi ih b ii lu im lv iq lw iu lx iy ly jc lq lr ls lt bi translated"><a class="ae jd" href="https://github.com/runatlantis/atlantis/issues/910" rel="noopener ugc nofollow" target="_blank">https://github.com/runatlantis/atlantis/issues/910</a></li><li id="b3ee" class="ll lm hi ih b ii lu im lv iq lw iu lx iy ly jc lq lr ls lt bi translated"><a class="ae jd" href="https://github.com/runatlantis/atlantis/issues/982" rel="noopener ugc nofollow" target="_blank">https://github.com/runatlantis/atlantis/issues/982</a></li><li id="c43e" class="ll lm hi ih b ii lu im lv iq lw iu lx iy ly jc lq lr ls lt bi translated"><a class="ae jd" href="https://github.com/runatlantis/atlantis/issues/794" rel="noopener ugc nofollow" target="_blank">https://github.com/runatlantis/atlantis/issues/794</a></li></ul></div></div>    
</body>
</html>