<html>
<head>
<title>Automated ML training using Azure DevOps — CI/CD</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Azure DevOps的自动化ML培训— CI/CD</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/automated-ml-training-using-azure-devops-ci-cd-7dfa232f8991?source=collection_archive---------16-----------------------#2021-06-26">https://medium.com/analytics-vidhya/automated-ml-training-using-azure-devops-ci-cd-7dfa232f8991?source=collection_archive---------16-----------------------#2021-06-26</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><h1 id="2322" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated">使用Azure DevOps创建CI/CD代码，通过使用sdk的自动化ML来训练模型</h1><h1 id="bef5" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated">步伐</h1><ul class=""><li id="f27f" class="jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt bi translated">导入库</li></ul><pre class="ju jv jw jx fd jy jz ka kb aw kc bi"><span id="63e8" class="kd if hh jz b fi ke kf l kg kh">import logging<br/><br/># from matplotlib import pyplot as plt<br/>import pandas as pd<br/>import os<br/><br/>import azureml.core<br/>from azureml.core.experiment import Experiment<br/>from azureml.core.workspace import Workspace<br/>from azureml.core.dataset import Dataset<br/>from azureml.train.automl import AutoMLConfig<br/>from azureml.core.compute import ComputeTarget, AmlCompute<br/>from azureml.core.compute_target import ComputeTargetException<br/># from azureml.widgets import RunDetails<br/>from sklearn.metrics import confusion_matrix<br/><br/>from azureml.core.authentication import ServicePrincipalAuthentication<br/><br/>import numpy as np<br/>import itertools<br/><br/>import argparse <br/>import json<br/>import os</span></pre><ul class=""><li id="9373" class="jc jd hh je b jf ki jh kj jj kk jl kl jn km jp jq jr js jt bi translated">打印AML版本</li></ul><pre class="ju jv jw jx fd jy jz ka kb aw kc bi"><span id="24ff" class="kd if hh jz b fi ke kf l kg kh">print("This notebook was created using version 1.29.0 of the Azure ML SDK")<br/>print("You are currently using version", azureml.core.VERSION, "of the Azure ML SDK")</span></pre><ul class=""><li id="aa07" class="jc jd hh je b jf ki jh kj jj kk jl kl jn km jp jq jr js jt bi translated">获取命令行中传递的参数</li></ul><pre class="ju jv jw jx fd jy jz ka kb aw kc bi"><span id="3bf3" class="kd if hh jz b fi ke kf l kg kh">parse = argparse.ArgumentParser()<br/>parse.add_argument("--tenantid")<br/>parse.add_argument("--acclientid")<br/>parse.add_argument("--accsecret")<br/>    <br/>args = parse.parse_args()</span></pre><ul class=""><li id="c7c6" class="jc jd hh je b jf ki jh kj jj kk jl kl jn km jp jq jr js jt bi translated">使用服务主体进行身份验证</li><li id="5d57" class="jc jd hh je b jf kn jh ko jj kp jl kq jn kr jp jq jr js jt bi translated">所有要验证的信息都作为命令行参数传递</li><li id="7535" class="jc jd hh je b jf kn jh ko jj kp jl kq jn kr jp jq jr js jt bi translated">在azure DevOps中配置</li></ul><pre class="ju jv jw jx fd jy jz ka kb aw kc bi"><span id="9cf7" class="kd if hh jz b fi ke kf l kg kh">sp = ServicePrincipalAuthentication(tenant_id=args.tenantid, # tenantID<br/>                                    service_principal_id=args.acclientid, # clientId<br/>                                    service_principal_password=args.accsecret) # clientSecret</span></pre><ul class=""><li id="8dab" class="jc jd hh je b jf ki jh kj jj kk jl kl jn km jp jq jr js jt bi translated">获取工作区信息</li></ul><pre class="ju jv jw jx fd jy jz ka kb aw kc bi"><span id="c3a5" class="kd if hh jz b fi ke kf l kg kh">ws = Workspace.get(name="mlopsdev",<br/>                   auth=sp,<br/>                   subscription_id="c46a9435-c957-4e6c-a0f4-b9a597984773", resource_group="mlops"</span></pre><ul class=""><li id="aa42" class="jc jd hh je b jf ki jh kj jj kk jl kl jn km jp jq jr js jt bi translated">现在创建一个实验名称</li></ul><pre class="ju jv jw jx fd jy jz ka kb aw kc bi"><span id="8677" class="kd if hh jz b fi ke kf l kg kh"># choose a name for experiment<br/>experiment_name = 'automl-classification-ccard-remote'<br/><br/>experiment=Experiment(ws, experiment_name)<br/><br/>output = {}<br/>output['Subscription ID'] = ws.subscription_id<br/>output['Workspace'] = ws.name<br/>output['Resource Group'] = ws.resource_group<br/>output['Location'] = ws.location<br/>output['Experiment Name'] = experiment.name<br/>pd.set_option('display.max_colwidth', -1)<br/>outputDf = pd.DataFrame(data = output, index = [''])<br/>outputDf.T<br/><br/>ws.get_details()</span></pre><ul class=""><li id="65a8" class="jc jd hh je b jf ki jh kj jj kk jl kl jn km jp jq jr js jt bi translated">设置计算集群</li></ul><pre class="ju jv jw jx fd jy jz ka kb aw kc bi"><span id="42dc" class="kd if hh jz b fi ke kf l kg kh"># Choose a name for your CPU cluster<br/>cpu_cluster_name = "cpu-cluster"<br/><br/># Verify that cluster does not exist already<br/>try:<br/>    compute_target = ComputeTarget(workspace=ws, name=cpu_cluster_name)<br/>    print('Found existing cluster, use it.')<br/>except ComputeTargetException:<br/>    compute_config = AmlCompute.provisioning_configuration(vm_size='STANDARD_DS12_V2',<br/>                                                           max_nodes=6)<br/>    compute_target = ComputeTarget.create(ws, cpu_cluster_name, compute_config)<br/><br/>compute_target.wait_for_completion(show_output=True)</span></pre><ul class=""><li id="c806" class="jc jd hh je b jf ki jh kj jj kk jl kl jn km jp jq jr js jt bi translated">下载所需的数据集</li></ul><pre class="ju jv jw jx fd jy jz ka kb aw kc bi"><span id="2189" class="kd if hh jz b fi ke kf l kg kh">data = "https://automlsamplenotebookdata.blob.core.windows.net/automl-sample-notebook-data/creditcard.csv"<br/>dataset = Dataset.Tabular.from_delimited_files(data)<br/>training_data, validation_data = dataset.random_split(percentage=0.8, seed=223)<br/>label_column_name = 'Class'</span></pre><ul class=""><li id="25dd" class="jc jd hh je b jf ki jh kj jj kk jl kl jn km jp jq jr js jt bi translated">设置自动配置</li></ul><pre class="ju jv jw jx fd jy jz ka kb aw kc bi"><span id="88b4" class="kd if hh jz b fi ke kf l kg kh">automl_settings = {<br/>    "n_cross_validations": 3,<br/>    "primary_metric": 'average_precision_score_weighted',<br/>    "enable_early_stopping": True,<br/>    "max_concurrent_iterations": 2, # This is a limit for testing purpose, please increase it as per cluster size<br/>    "experiment_timeout_hours": 0.25, # This is a time limit for testing purposes, remove it for real use cases, this will drastically limit ablity to find the best model possible<br/>    "verbosity": logging.INFO,<br/>}<br/><br/>automl_config = AutoMLConfig(task = 'classification',<br/>                             debug_log = 'automl_errors.log',<br/>                             compute_target = compute_target,<br/>                             training_data = training_data,<br/>                             label_column_name = label_column_name,<br/>                             **automl_settings<br/>                            )</span></pre><ul class=""><li id="e45d" class="jc jd hh je b jf ki jh kj jj kk jl kl jn km jp jq jr js jt bi translated">提交实验</li></ul><pre class="ju jv jw jx fd jy jz ka kb aw kc bi"><span id="7a05" class="kd if hh jz b fi ke kf l kg kh">remote_run = experiment.submit(automl_config, show_output = False)<br/><br/>remote_run.wait_for_completion(show_output=True)</span></pre><ul class=""><li id="c5ef" class="jc jd hh je b jf ki jh kj jj kk jl kl jn km jp jq jr js jt bi translated">等待实验完成</li><li id="0cbc" class="jc jd hh je b jf kn jh ko jj kp jl kq jn kr jp jq jr js jt bi translated">验证模型</li></ul><pre class="ju jv jw jx fd jy jz ka kb aw kc bi"><span id="d137" class="kd if hh jz b fi ke kf l kg kh">best_run, fitted_model = remote_run.get_output()<br/>fitted_model<br/><br/># convert the test data to dataframe<br/>X_test_df = validation_data.drop_columns(columns=[label_column_name]).to_pandas_dataframe()<br/>y_test_df = validation_data.keep_columns(columns=[label_column_name], validate=True).to_pandas_dataframe()<br/><br/># call the predict functions on the model<br/>y_pred = fitted_model.predict(X_test_df)<br/>y_pred</span></pre><h1 id="030b" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated">Azure DevOps</h1><ul class=""><li id="2d7f" class="jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt bi translated">创建一个名为AMLOps的项目</li><li id="78c4" class="jc jd hh je b jf kn jh ko jj kp jl kq jn kr jp jq jr js jt bi translated">为构建创建管道</li><li id="ccb8" class="jc jd hh je b jf kn jh ko jj kp jl kq jn kr jp jq jr js jt bi translated">名字是AutoMLOps</li><li id="4407" class="jc jd hh je b jf kn jh ko jj kp jl kq jn kr jp jq jr js jt bi translated">连接到您的github</li><li id="b41f" class="jc jd hh je b jf kn jh ko jj kp jl kq jn kr jp jq jr js jt bi translated">代码在<a class="ae ks" href="https://github.com/balakreshnan/AMLcode/tree/main/AutomatedML" rel="noopener ugc nofollow" target="_blank">https://github . com/balakreshnan/AML code/tree/main/automated ml</a>中</li></ul><figure class="ju jv jw jx fd ku er es paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="er es kt"><img src="../Images/1e4f9b1012f3bb7d4ad562aa0b0aa50e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*uPhHn3LJ9j2Y3PjQ.jpg"/></div></div></figure><figure class="ju jv jw jx fd ku er es paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="er es lb"><img src="../Images/5d29ffec72850ef0ca1d2e8d56effbf4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*Wsk6bhTT0xGxUEzh.jpg"/></div></div></figure><figure class="ju jv jw jx fd ku er es paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="er es lc"><img src="../Images/4dbdde3d3a05415197051c7413c09b03.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*Ks3_29C48e3uybDV.jpg"/></div></div></figure><ul class=""><li id="f90e" class="jc jd hh je b jf ki jh kj jj kk jl kl jn km jp jq jr js jt bi translated">将版本设置为3.6</li><li id="a368" class="jc jd hh je b jf kn jh ko jj kp jl kq jn kr jp jq jr js jt bi translated">配置agend依赖项</li><li id="9a90" class="jc jd hh je b jf kn jh ko jj kp jl kq jn kr jp jq jr js jt bi translated">安装运行实验所需的所有库</li><li id="5314" class="jc jd hh je b jf kn jh ko jj kp jl kq jn kr jp jq jr js jt bi translated">path—automated ml/agent _ dependcy . sh</li></ul><figure class="ju jv jw jx fd ku er es paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="er es ld"><img src="../Images/9c96da7b99356af3ece2d9e7aa13cb4f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*HjlNBjWHYgGY7iOz.jpg"/></div></div></figure><ul class=""><li id="34bc" class="jc jd hh je b jf ki jh kj jj kk jl kl jn km jp jq jr js jt bi translated">将数据复制到构建目录</li><li id="9c6f" class="jc jd hh je b jf kn jh ko jj kp jl kq jn kr jp jq jr js jt bi translated">目标:$(构建。SourcesDirectory)</li></ul><figure class="ju jv jw jx fd ku er es paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="er es le"><img src="../Images/9bb21bf46081e6d7c81cff94425e7e1d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*fZS1m7ptLiwl0nHj.jpg"/></div></div></figure><figure class="ju jv jw jx fd ku er es paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="er es lf"><img src="../Images/89860c96204ae95f0e2ae69dc817f9ca.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*W1BbcCilAxQS_qJt.jpg"/></div></div></figure><ul class=""><li id="5954" class="jc jd hh je b jf ki jh kj jj kk jl kl jn km jp jq jr js jt bi translated">脚本路径:AutomatedML/automlpipeline.py</li><li id="2a1c" class="jc jd hh je b jf kn jh ko jj kp jl kq jn kr jp jq jr js jt bi translated">参数:—tenantid $(tenatid)-acclientid $(acclientid)-accsecret $(accsecret)</li><li id="e600" class="jc jd hh je b jf kn jh ko jj kp jl kq jn kr jp jq jr js jt bi translated">一旦一切就绪</li><li id="5f0f" class="jc jd hh je b jf kn jh ko jj kp jl kq jn kr jp jq jr js jt bi translated">单击保存并排队</li><li id="d28b" class="jc jd hh je b jf kn jh ko jj kp jl kq jn kr jp jq jr js jt bi translated">等待实验运行完成</li></ul><figure class="ju jv jw jx fd ku er es paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="er es lg"><img src="../Images/9b4b182b1ca73ba582baf8a233ac2780.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*ZMEYLsdfYrAThWtu.jpg"/></div></div></figure><figure class="ju jv jw jx fd ku er es paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="er es lh"><img src="../Images/1d88bda0401de9b68c5295deb7b2758d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*fbMkcUequ7Krm1-s.jpg"/></div></div></figure></div><div class="ab cl li lj go lk" role="separator"><span class="ll bw bk lm ln lo"/><span class="ll bw bk lm ln lo"/><span class="ll bw bk lm ln"/></div><div class="ha hb hc hd he"><p id="0d1b" class="pw-post-body-paragraph lp lq hh je b jf ki lr ls jh kj lt lu jj lv lw lx jl ly lz ma jn mb mc md jp ha bi translated"><em class="me">最初发表于</em><a class="ae ks" href="https://github.com/balakreshnan/Samples2021/blob/main/AutoML/trainaml.md" rel="noopener ugc nofollow" target="_blank">T5【https://github.com】</a><em class="me">。</em></p></div></div>    
</body>
</html>