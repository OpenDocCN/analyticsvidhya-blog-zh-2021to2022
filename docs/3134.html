<html>
<head>
<title>Use AWS Services in a local environment</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在本地环境中使用AWS服务</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/use-aws-services-in-a-local-environment-cb3c5afa7b43?source=collection_archive---------3-----------------------#2021-06-10">https://medium.com/analytics-vidhya/use-aws-services-in-a-local-environment-cb3c5afa7b43?source=collection_archive---------3-----------------------#2021-06-10</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="6028" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">问:</strong>我们是否可以使用AWS服务，无需订阅，无需支付服务费用，完全离线模式？<br/> <strong class="ih hj">答:</strong>是的，我们可以通过使用<a class="ae jd" href="https://github.com/localstack/localstack" rel="noopener ugc nofollow" target="_blank"> localstack </a>来做到这一点。我们可以使用几乎所有的AWS服务，而无需支付和完全离线模式，这听起来很疯狂，对吗？让我们详细了解一下如何设置和使用服务。</p><p id="afbb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">关键词:</strong> Localstack，AWS，SNS，SQS，Lambda，AWS CLI，免费AWS服务</p><p id="0691" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">简介:</strong>开发完成后，我们在AWS或任何其他云服务中部署应用程序，如Azure、GCP、阿里巴巴等。我们通常订阅并使用所需的服务，直到免费层完成，之后我们按使用付费，如果我们仔细观察这个管道，我们真的没有在部署到实际的AWS云之前测试AWS云服务的机制。如果我们在部署之前没有进行测试，那么我们可能会出现错误，需要在支付这些服务费用的同时解决这些错误。我们最终为AWS云中的管道的构建、测试和实验支付了巨额资金。为了避免这种情况，我们可以利用<a class="ae jd" href="https://github.com/localstack/localstack" rel="noopener ugc nofollow" target="_blank"> Localstack </a>，它将允许我们在本地和离线模式下设置AWS服务，我们可以构建管道，我们可以测试管道，并在部署到实际的AWS云之前试验服务。</p><p id="03bd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> Localstack设置:</strong> LocalStack是一个基于Python的dockerized应用程序，设计为在监听特定端口时作为HTTP请求处理器运行。<strong class="ih hj">由于这是一个dockerized应用程序，任何没有python知识的人都可以安装和使用该应用程序。</strong></p><p id="633d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">有两种方法可以使用该应用程序:</p><p id="fd33" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">1.将localstack作为python包安装<br/> 2。使用docker-compose</p><p id="21cb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> 1。将localstack作为python包安装:</strong>创建一个虚拟环境，因为如果可能的话，建议为每个项目创建一个虚拟环境。我们可以通过使用<a class="ae jd" href="https://uoa-eresearch.github.io/eresearch-cookbook/recipe/2014/11/20/conda/" rel="noopener ugc nofollow" target="_blank">蟒蛇</a>或者<a class="ae jd" href="https://packaging.python.org/guides/installing-using-pip-and-virtual-environments/" rel="noopener ugc nofollow" target="_blank"> pip </a>来创建一个虚拟环境。使用下面的命令安装本地堆栈包。</p><p id="2868" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">pip安装本地堆栈</p><p id="6178" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后，我们用如下所示的“start”命令启动localstack。这将在Docker容器中启动LocalStack。</p><p id="c1cb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">本地堆栈开始</p><p id="bb42" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> 2。使用docker-compose: </strong>使用下面的链接从Localstack存储库中下载docker-compose文件，并使用命令“docker-compose up”运行</p><div class="je jf ez fb jg jh"><a href="https://github.com/localstack/localstack" rel="noopener  ugc nofollow" target="_blank"><div class="ji ab dw"><div class="jj ab jk cl cj jl"><h2 class="bd hj fi z dy jm ea eb jn ed ef hh bi translated">本地堆栈/本地堆栈</h2><div class="jo l"><h3 class="bd b fi z dy jm ea eb jn ed ef dx translated">LocalStack为开发云应用程序提供了一个易于使用的测试/模拟框架。目前，重点是…</h3></div><div class="jp l"><p class="bd b fp z dy jm ea eb jn ed ef dx translated">github.com</p></div></div><div class="jq l"><div class="jr l js jt ju jq jv jw jh"/></div></div></a></div><p id="632d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">docker-compose.yml文件如下所示</p><figure class="jx jy jz ka fd kb er es paragraph-image"><div role="button" tabindex="0" class="kc kd di ke bf kf"><div class="er es ca"><img src="../Images/883735bd289dd3fae9ba0326db45a62d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*n1fkTMNotqQjx6C69xeVnA.png"/></div></div><figcaption class="kh ki et er es kj kk bd b be z dx translated">docker-compose.yml</figcaption></figure><p id="b029" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">当我们启动应用程序时，所有可用的服务都将运行，如果需要，我们还可以选择特定的服务。阅读<a class="ae jd" href="https://github.com/localstack/localstack" rel="noopener ugc nofollow" target="_blank"> GitHub </a>的文档部分，了解更多可用服务的数量。默认端口是4566，所有服务都从4566端口路由。</p><p id="5111" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">配置AWS CLI: </strong>我们需要创建一个假的配置文件，我们可以使用AWS CLI来完成。所有AWS CLI命令也可以在localstack中工作，但是只需要做一些小的修改就可以将服务从实际的AWS指向localstack。使用以下命令创建一个配置文件</p><pre class="jx jy jz ka fd kl km kn ko aw kp bi"><span id="9199" class="kq kr hi km b fi ks kt l ku kv">aws configure --profile localstack</span></pre><p id="856f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这将提示输入AWS访问密钥、秘密访问密钥和AWS区域。我们可以为凭证提供任何虚拟值和一个有效的区域名，如us-east-1，但是不能将任何值留空。与AWS不同，LocalStack不验证这些凭证，但是如果没有设置配置文件，它会报错。到目前为止，它就像我们将用来处理LocalStack的任何其他AWS概要文件一样。</p><p id="c8b6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">到目前为止，我们已经讨论了localstack及其设置，让我们使用lambda、SNS和SQS等服务创建一个示例项目。</p><p id="bcf1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">一个示例项目:</strong>我已经创建了一个项目，它将使用<a class="ae jd" href="https://aws.amazon.com/sns/?whats-new-cards.sort-by=item.additionalFields.postDateTime&amp;whats-new-cards.sort-order=desc" rel="noopener ugc nofollow" target="_blank"> SNS </a>(简单通知服务)<a class="ae jd" href="https://aws.amazon.com/sqs/#:~:text=Amazon%20Simple%20Queue%20Service%20(SQS,distributed%20systems%2C%20and%20serverless%20applications.&amp;text=SQS%20FIFO%20queues%20are%20designed,order%20that%20they%20are%20sent." rel="noopener ugc nofollow" target="_blank"> SQS </a>(简单队列服务)和Lambda服务。</p><figure class="jx jy jz ka fd kb er es paragraph-image"><div role="button" tabindex="0" class="kc kd di ke bf kf"><div class="er es kw"><img src="../Images/e98853db9f120d5b30f72652fb1f1929.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*draEkv_oSJVOth-HUI713w.png"/></div></div><figcaption class="kh ki et er es kj kk bd b be z dx translated">项目流程图</figcaption></figure><p id="4170" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">SNS是一种通知服务，可用于向接收方发布消息，如电子邮件、短信、SQS、应用程序、移动应用程序和设备的EndpointArn以及lambda。我使用了SQS，一种队列服务来接收消息并将它们存储在队列中。然后我使用lambda服务来拉取消息，并将它们存储在输出文件中。如果我们想详细阅读SNS、SQS或任何其他服务的文档，请查阅AWS文档。</p><p id="e5da" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">创建项目的步骤:</strong>我们将使用AWS CLI来执行命令。我们可以使用稍加修改的AWS CLI命令，我们需要为每个命令提供localstack URL和region。</p><p id="597b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">步骤1: </strong>创建一个SNS话题。</p><p id="98d0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">AWS _ DEFAULT _ REGION = eu-east-1 AWS-endpoint-URL =<a class="ae jd" href="http://localhost:4566" rel="noopener ugc nofollow" target="_blank">http://localhost:4566</a>SNS create-topic-name SNS-publish-msgs</p><p id="0578" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">第二步:</strong>列出SNS话题</p><p id="fe03" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">AWS _ DEFAULT _ REGION = eu-east-1 AWS-endpoint-URL =<a class="ae jd" href="http://localhost:4566" rel="noopener ugc nofollow" target="_blank">http://localhost:4566</a>SNS list-topics</p><p id="e322" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">步骤3: </strong>创建一个SQS队列</p><p id="76c6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">AWS _ DEFAULT _ REGION = eu-east-1 AWS-endpoint-URL =<a class="ae jd" href="http://localhost:4566" rel="noopener ugc nofollow" target="_blank">http://localhost:4566</a>SQS create-queue-queue-name SQS _ queue</p><p id="67ed" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">步骤4: </strong>创建一个从SNS到SQS的订阅，这样每当SNS发布消息时，它们就会到达SQS队列。</p><p id="fcbd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">AWS _ DEFAULT _ REGION = eu-east-1 AWS-endpoint-URL =<a class="ae jd" href="http://localhost:4566" rel="noopener ugc nofollow" target="_blank">http://localhost:4566</a>SNS subscribe-topic-arn arn:AWS:SNS:us-east-1:00000000000:SNS-publish-msgs-protocol SQS-notification-endpoint<a class="ae jd" href="http://localhost:4566/000000000000/sqs_queue" rel="noopener ugc nofollow" target="_blank">http://localhost:4566/000000000000/SQS _ queue</a></p><p id="0692" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">第五步:</strong>从SNS发布消息</p><p id="e2ba" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">AWS _ DEFAULT _ REGION = eu-east-1 AWS—endpoint-URL =<a class="ae jd" href="http://localhost:4566" rel="noopener ugc nofollow" target="_blank">http://localhost:4566</a>SNS publish—Message“Test _ Message”—Subject Test _ Subject—topic-arn arn:AWS:SNS:us-east-1:00000000000:SNS-publish-msgs</p><p id="a8e7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">第六步:</strong>查看SQS队列中的消息</p><p id="5e90" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">AWS _ DEFAULT _ REGION = eu-east-1 AWS-endpoint-URL =<a class="ae jd" href="http://localhost:4566" rel="noopener ugc nofollow" target="_blank">http://localhost:4566</a>SQS receive-message-queue-URL<a class="ae jd" href="http://localhost:4566/000000000000/sqs_queue" rel="noopener ugc nofollow" target="_blank">http://localhost:4566/0000000000/SQS _ queue</a>—最大消息数10</p><p id="f23c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">第7步:</strong>创建一个lambda函数来拉消息，之后删除消息。</p><p id="4e62" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">AWS _ DEFAULT _ REGION = eu-east-1 AWS-endpoint-URL =<a class="ae jd" href="http://localhost:4566" rel="noopener ugc nofollow" target="_blank">http://localhost:4566</a>lambda create-function-function-name test _ lambda-zip-file b://python-new . zip-handler lambda-fn . lambda _ handler-runtime python 3.7-role arn:AWS:iam::0000000000:role/lambda-S3-time out 900</p><p id="c40d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这里，我使用python-new.zip创建了一个lambda函数。在zip中，我放置了一个名为lambda-fn.py的python文件。</p><pre class="jx jy jz ka fd kl km kn ko aw kp bi"><span id="5f3b" class="kq kr hi km b fi ks kt l ku kv">from __future__ import print_function<br/>import json<br/>import os<br/>import boto3<br/><br/><em class="kx"># Create SQS client<br/></em>sqs = boto3.client(<strong class="km hj">'sqs'</strong>,<br/>                   endpoint_url=<strong class="km hj">"http://{}:4566"</strong>.format(os.environ[<strong class="km hj">'LOCALSTACK_HOSTNAME'</strong>]),<br/>                   use_ssl=False<br/>                   )<br/><br/>queue_url = <strong class="km hj">'http://{}:4566/000000000000/sqs_queue'</strong>.format(os.environ[<strong class="km hj">'LOCALSTACK_HOSTNAME'</strong>])<br/><br/><br/>def lambda_handler(event, context):<br/>    <em class="kx"># Receive message from SQS queue<br/>    </em>response = sqs.receive_message(<br/>        QueueUrl=queue_url,<br/>        AttributeNames=[<br/>            <strong class="km hj">'SentTimestamp'<br/>        </strong>],<br/>        MaxNumberOfMessages=7,<br/>        MessageAttributeNames=[<br/>            <strong class="km hj">'All'<br/>        </strong>],<br/>        VisibilityTimeout=0,<br/>        WaitTimeSeconds=0<br/>    )<br/><br/>    res_list = []<br/>    if <strong class="km hj">"Messages" </strong>in response.keys():<br/>        for each_msg in response[<strong class="km hj">'Messages'</strong>]:<br/>            res_dict = {}<br/>            res_dict[<strong class="km hj">'Message Id'</strong>] = each_msg[<strong class="km hj">'MessageId'</strong>]<br/>            res_dict[<strong class="km hj">'Subject'</strong>] = json.loads(each_msg[<strong class="km hj">'Body'</strong>])[<strong class="km hj">'Subject'</strong>]<br/>            res_dict[<strong class="km hj">'Message Body'</strong>] = json.loads(each_msg[<strong class="km hj">'Body'</strong>])[<strong class="km hj">'Message'</strong>]<br/><br/>            res_list.append(res_dict)<br/><br/>            receipt_handle = each_msg[<strong class="km hj">'ReceiptHandle'</strong>]<br/><br/>            <em class="kx"># # Delete received message from queue<br/>            </em>sqs.delete_message(<br/>                QueueUrl=queue_url,<br/>                ReceiptHandle=receipt_handle<br/>            )<br/><br/>            print(<strong class="km hj">'Message deleted'</strong>, each_msg[<strong class="km hj">'MessageId'</strong>])<br/>    else:<br/>        return <strong class="km hj">'No message available in sqs service'<br/><br/>    </strong>return res_dict</span></pre><p id="daec" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">步骤8: </strong>调用lambda函数</p><p id="bb1f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">AWS _ DEFAULT _ REGION = eu-east-1 AWS-endpoint-URL =<a class="ae jd" href="http://localhost:4566" rel="noopener ugc nofollow" target="_blank">http://localhost:4566</a>lambda invoke-function-name arn:AWS:lambda:us-east-1:00000000000:function:test _ lambda-invocation-type request response outfile . txt</p><p id="765b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">第九步:</strong>查看输出。lambda函数的输出存储在outfile.txt文件中。使用下面的命令查看输出</p><p id="d9c6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">vi outfile.txt</p><p id="18ab" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">结论:</strong>当我们在部署之前学习、测试和试验AWS服务时，Localstack非常有用。如今，我们看到许多组织和专业人士花费大量的金钱来学习、测试和实验。Localstack也有一个非常好的活跃的开发社区，许多服务不断被添加进来。</p><p id="e8dc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">谷歌网站验证:google202f57a5f28bd783.html</p><p id="0a93" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">快乐学习😊…</p></div><div class="ab cl ky kz gp la" role="separator"><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld"/></div><div class="hb hc hd he hf"><p id="e7d2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">谷歌网站验证:google202f57a5f28bd783.html</p></div></div>    
</body>
</html>