<html>
<head>
<title>Advanced SQL Query: How to Get Week Number of The Month from Date in SQL</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">高级SQL查询:如何在SQL中从日期获得一个月中的第几周</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/advanced-sql-query-how-to-get-week-number-of-the-month-from-date-in-sql-9ffb2f94132f?source=collection_archive---------0-----------------------#2021-06-29">https://medium.com/analytics-vidhya/advanced-sql-query-how-to-get-week-number-of-the-month-from-date-in-sql-9ffb2f94132f?source=collection_archive---------0-----------------------#2021-06-29</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="b7ad" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">附有商业案例</h2></div><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es ix"><img src="../Images/f152a8ab5fb9b431a182ea1fff48a4b2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*L6EOT-Mc8aq61W_6TcBFEA.jpeg"/></div></div><figcaption class="jj jk et er es jl jm bd b be z dx translated">照片由<a class="ae jn" href="https://unsplash.com/@behy_studio?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">贝南·诺鲁齐</a>在<a class="ae jn" href="https://unsplash.com/s/photos/calendar?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</figcaption></figure><p id="cad5" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">讨论SQL查询课程的基础可能已经被很多人讨论过了，比如SELECT语句、分组、连接等等。因此，在这里我打算讨论一些很少被讨论或者很少被发现的东西，即如何在SQL中从日期中获取一个月的星期数。作为一名数据分析师，我经常在工作中使用这个查询来解决业务问题。</p></div><div class="ab cl kk kl gp km" role="separator"><span class="kn bw bk ko kp kq"/><span class="kn bw bk ko kp kq"/><span class="kn bw bk ko kp"/></div><div class="hb hc hd he hf"><h1 id="1f95" class="kr ks hi bd kt ku kv kw kx ky kz la lb io lc ip ld ir le is lf iu lg iv lh li bi translated">目录</h1><ol class=""><li id="2284" class="lj lk hi jq b jr ll ju lm jx ln kb lo kf lp kj lq lr ls lt bi translated">商业问题</li><li id="5986" class="lj lk hi jq b jr lu ju lv jx lw kb lx kf ly kj lq lr ls lt bi translated">处理从日期中提取的功能</li><li id="4d52" class="lj lk hi jq b jr lu ju lv jx lw kb lx kf ly kj lq lr ls lt bi translated">用子查询和CASE语句修改</li></ol></div><div class="ab cl kk kl gp km" role="separator"><span class="kn bw bk ko kp kq"/><span class="kn bw bk ko kp kq"/><span class="kn bw bk ko kp"/></div><div class="hb hc hd he hf"><h2 id="fe7d" class="lz ks hi bd kt ma mb mc kx md me mf lb jx mg mh ld kb mi mj lf kf mk ml lh mm bi translated">商业问题</h2><p id="6bd2" class="pw-post-body-paragraph jo jp hi jq b jr ll ij jt ju lm im jw jx mn jz ka kb mo kd ke kf mp kh ki kj hb bi translated">此时的业务问题是，例如，在一家从事零售的企业中，主管要求我们找出每个月每周每种产品的销售量，但周数不是从一天开始计算的，而是从日期数开始计算的，因此1–7是第一周，尽管第一周不是从星期一开始。如何用SQL回答上述业务问题？让我们在下一节讨论这个问题！。我们期望的输出是这样一个例子:</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div class="er es mq"><img src="../Images/4890803ee6e929c47ca50257bf4f1fcb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1390/format:webp/1*pyttDugT70v2NvwdZ6oEPQ.png"/></div></figure></div><div class="ab cl kk kl gp km" role="separator"><span class="kn bw bk ko kp kq"/><span class="kn bw bk ko kp kq"/><span class="kn bw bk ko kp"/></div><div class="hb hc hd he hf"><h2 id="1c9b" class="lz ks hi bd kt ma mb mc kx md me mf lb jx mg mh ld kb mi mj lf kf mk ml lh mm bi translated"><strong class="ak">处理从日期</strong>开始的提取功能</h2><p id="3f3b" class="pw-post-body-paragraph jo jp hi jq b jr ll ij jt ju lm im jw jx mn jz ka kb mo kd ke kf mp kh ki kj hb bi translated">事实上，我们最常用的日期提取函数是从日期/时间值中检索诸如年、月、周和日之类的字段。在继续之前，让我们回顾一下EXTRACT函数在常用字段中的用法。你可以在这里 下载数据<a class="ae jn" href="https://drive.google.com/file/d/1wPGQPIFoYiuT0AyH-m5_Mk14gkYdomwA/view?usp=sharing" rel="noopener ugc nofollow" target="_blank"> <strong class="jq hj">。</strong></a></p><p id="1ac3" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">让我们看看整列和前5名的数据:</p><pre class="iy iz ja jb fd mr ms mt mu aw mv bi"><span id="9877" class="lz ks hi ms b fi mw mx l my mz">SELECT * FROM sample<br/>LIMIT 5</span></pre><p id="cf72" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">结果如下:</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div class="er es na"><img src="../Images/2a6fa91e10462f38631aac969fabd9c1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1148/format:webp/1*46757ucrOfaDLaCQ7ec2uQ.png"/></div></figure><ul class=""><li id="44f8" class="lj lk hi jq b jr js ju jv jx nb kb nc kf nd kj ne lr ls lt bi translated"><strong class="jq hj">从</strong> <code class="du nf ng nh ms b">order_date</code> <strong class="jq hj">列中提取年份</strong></li></ul><pre class="iy iz ja jb fd mr ms mt mu aw mv bi"><span id="3411" class="lz ks hi ms b fi mw mx l my mz">SELECT order_date, EXTRACT(YEAR FROM order_date) AS year FROM sample</span></pre><p id="940f" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">结果如下:</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div class="er es ni"><img src="../Images/db0066b4eadbbadafaff01935a361fa0.png" data-original-src="https://miro.medium.com/v2/resize:fit:700/format:webp/1*rq_6u8FquUwGKZzXUDyzyQ.png"/></div></figure><p id="184b" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated"><code class="du nf ng nh ms b">YEAR</code>函数从检索的日期中返回年份值。</p><ul class=""><li id="9250" class="lj lk hi jq b jr js ju jv jx nb kb nc kf nd kj ne lr ls lt bi translated"><strong class="jq hj">从</strong> <code class="du nf ng nh ms b">order_date</code> <strong class="jq hj">列中提取月份</strong></li></ul><pre class="iy iz ja jb fd mr ms mt mu aw mv bi"><span id="a603" class="lz ks hi ms b fi mw mx l my mz">SELECT order_date, EXTRACT(MONTH FROM order_date) AS month FROM sample</span></pre><p id="2228" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">结果如下:</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div class="er es nj"><img src="../Images/f3cef907ef18deb2d2d03816f5b4c409.png" data-original-src="https://miro.medium.com/v2/resize:fit:694/format:webp/1*B_nJFvLgf31iR3dBXFl29g.png"/></div></figure><p id="49dd" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated"><code class="du nf ng nh ms b">MONTH</code>函数将返回指定日期的月份部分(从数字1到12)。</p><ul class=""><li id="240f" class="lj lk hi jq b jr js ju jv jx nb kb nc kf nd kj ne lr ls lt bi translated"><strong class="jq hj">从</strong> <code class="du nf ng nh ms b">order_date</code> <strong class="jq hj">列中提取周</strong></li></ul><pre class="iy iz ja jb fd mr ms mt mu aw mv bi"><span id="25f0" class="lz ks hi ms b fi mw mx l my mz">SELECT order_date, EXTRACT(WEEK FROM order_date) AS week FROM sample</span></pre><p id="480c" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">结果如下:</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div class="er es nk"><img src="../Images/e5e68c245a68a2e641e806e93585530b.png" data-original-src="https://miro.medium.com/v2/resize:fit:696/format:webp/1*ND-0YikNOK6pNO72XBv-Hg.png"/></div></figure><p id="2d51" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated"><code class="du nf ng nh ms b">WEEK</code>函数将返回指定日期的周数(从数字0到53)。</p><ul class=""><li id="0589" class="lj lk hi jq b jr js ju jv jx nb kb nc kf nd kj ne lr ls lt bi translated"><strong class="jq hj">从</strong> <code class="du nf ng nh ms b">order_date</code> <strong class="jq hj">列中提取日</strong></li></ul><pre class="iy iz ja jb fd mr ms mt mu aw mv bi"><span id="7af2" class="lz ks hi ms b fi mw mx l my mz">SELECT order_date, EXTRACT(DAY FROM order_date) AS day FROM sample</span></pre><p id="f442" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">结果如下:</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div class="er es nl"><img src="../Images/9fb13daf420386a139879d3d97cd68f3.png" data-original-src="https://miro.medium.com/v2/resize:fit:698/format:webp/1*6o7HdPROx3fNuYO83-sQSw.png"/></div></figure><p id="bf1f" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated"><code class="du nf ng nh ms b">DAY</code>函数将返回给定日期的天数(从1到31)。</p><p id="6f2e" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">至此，让我们来看看周数的取法。取星期号基本上是从年初开始取星期号(按照公历计算)，这样取日期2021–04–01就会得出星期号13。</p><p id="e5e4" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">那么如何从某一个月的某一天得到星期数而不与公历绑定呢？所以我们仍然认为1-7日是第一周，尽管第一周不是从周一开始。到目前为止，我还没有从SQL中找到可以返回这个结果的函数/命令，所以我们必须考虑如何在SQL中可用的函数/命令的帮助下修改语法来获得这个结果，这听起来可能很难，但实际上很容易，让我们在下一节讨论！</p></div><div class="ab cl kk kl gp km" role="separator"><span class="kn bw bk ko kp kq"/><span class="kn bw bk ko kp kq"/><span class="kn bw bk ko kp"/></div><div class="hb hc hd he hf"><h2 id="0df9" class="lz ks hi bd kt ma mb mc kx md me mf lb jx mg mh ld kb mi mj lf kf mk ml lh mm bi translated">用子查询和CASE语句修改</h2><p id="4cf6" class="pw-post-body-paragraph jo jp hi jq b jr ll ij jt ju lm im jw jx mn jz ka kb mo kd ke kf mp kh ki kj hb bi translated">为了获得我们在业务问题部分所期望的输出，我们需要使用子查询技术和一些CASE语句。我们必须完成两个步骤，即:</p><p id="9898" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">因此，我们首先需要做的是创建一个语法，该语法选择除customer_id列之外的所有列，然后从order_date列中提取日和月，语法如下:</p><p id="cb4c" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated"><strong class="jq hj"> 1。</strong>所以我们首先需要做的是创建一个语法，该语法选择除了<code class="du nf ng nh ms b">customer_id</code>列之外的所有列，然后从<code class="du nf ng nh ms b">order_date</code>列获取日期和月份，语法如下:</p><pre class="iy iz ja jb fd mr ms mt mu aw mv bi"><span id="cacb" class="lz ks hi ms b fi mw mx l my mz">SELECT product_name, <br/>quantity, <br/>order_date, <br/>EXTRACT(DAY FROM order_date) AS day, <br/>EXTRACT(MONTH FROM order_date) AS month<br/>FROM sample</span></pre><p id="bbca" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">结果如下:</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es nm"><img src="../Images/33bb225032076a0da44e33795f56590d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cDJJObUDP0mQFwjw3B1VCg.png"/></div></div></figure><p id="6ac3" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated"><strong class="jq hj"> 2。</strong>其次，我们要做的是用前面的语法创建一个子查询，它包含并提取:</p><ul class=""><li id="c0ab" class="lj lk hi jq b jr js ju jv jx nb kb nc kf nd kj ne lr ls lt bi translated"><code class="du nf ng nh ms b">product_name</code>列</li><li id="9a03" class="lj lk hi jq b jr lu ju lv jx lw kb lx kf ly kj ne lr ls lt bi translated">用于<code class="du nf ng nh ms b">quantity_total</code>列的<code class="du nf ng nh ms b">SUM</code>聚合函数</li><li id="1763" class="lj lk hi jq b jr lu ju lv jx lw kb lx kf ly kj ne lr ls lt bi translated"><code class="du nf ng nh ms b">CASE</code>通过提取<code class="du nf ng nh ms b">day</code>列生成<code class="du nf ng nh ms b">Week_of_month</code>列，第一个条件提取1–7日期，第二个条件提取8–14日期，第三个条件提取15–21日期，第四个条件是余数。</li><li id="b9cf" class="lj lk hi jq b jr lu ju lv jx lw kb lx kf ly kj ne lr ls lt bi translated"><code class="du nf ng nh ms b">month</code>列</li></ul><p id="3a4f" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">然后在语法的最后，我们对<code class="du nf ng nh ms b">product_name</code>、<code class="du nf ng nh ms b">quantity</code>、<code class="du nf ng nh ms b">Week_of_month</code>、dan <code class="du nf ng nh ms b">month</code>列使用<code class="du nf ng nh ms b">GROUP BY</code>语句。完整语法如下:</p><pre class="iy iz ja jb fd mr ms mt mu aw mv bi"><span id="6d8d" class="lz ks hi ms b fi mw mx l my mz">SELECT product_name,<br/>SUM(quantity) AS quantity_total,<br/>CASE <br/>WHEN day &lt; 8 THEN 'Week 1'<br/>WHEN day &lt; 15 THEN 'Week 2'<br/>WHEN day &lt; 22 THEN 'Week 3'<br/>ELSE 'Week 4'<br/>END AS week_of_month,<br/>month<br/>FROM<br/>(SELECT product_name, quantity, order_date, EXTRACT(DAY FROM order_date) AS day, <br/>EXTRACT(MONTH FROM order_date) AS month<br/>FROM sample) a<br/>GROUP BY product_name, quantity, week_of_month, month</span></pre><p id="f948" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">结果如下:</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div class="er es mq"><img src="../Images/4890803ee6e929c47ca50257bf4f1fcb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1390/format:webp/1*pyttDugT70v2NvwdZ6oEPQ.png"/></div></figure><p id="c144" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">耶！从上面的结果，我们可以得到我们期望的结果。</p><h1 id="4370" class="kr ks hi bd kt ku nn kw kx ky no la lb io np ip ld ir nq is lf iu nr iv lh li bi translated">结论</h1><p id="ad84" class="pw-post-body-paragraph jo jp hi jq b jr ll ij jt ju lm im jw jx mn jz ka kb mo kd ke kf mp kh ki kj hb bi translated">到目前为止，我们已经通过使用创造性的想法子查询和CASE语句成功地回答了业务问题，随着我们对查询有了创造性的想法，听起来很难的事情将变得容易，继续练习！</p></div></div>    
</body>
</html>