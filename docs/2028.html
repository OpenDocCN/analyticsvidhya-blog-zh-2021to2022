<html>
<head>
<title>Pytorch Regression model using Azure Machine learning</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Azure机器学习的Pytorch回归模型</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/pytorch-regression-model-using-azure-machine-learning-f820a8db253?source=collection_archive---------11-----------------------#2021-04-01">https://medium.com/analytics-vidhya/pytorch-regression-model-using-azure-machine-learning-f820a8db253?source=collection_archive---------11-----------------------#2021-04-01</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><h1 id="88cd" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated">使用pytorch和Azure ML运行回归</h1><p id="45d0" class="pw-post-body-paragraph jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ha bi translated">文章的目的是展示过程和它的假模型。</p><h1 id="3e63" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated">先决条件</h1><ul class=""><li id="9e11" class="ka kb hh je b jf jg jj jk jn kc jr kd jv ke jz kf kg kh ki bi translated">Azure帐户</li><li id="6537" class="ka kb hh je b jf kj jj kk jn kl jr km jv kn jz kf kg kh ki bi translated">资源组</li><li id="5019" class="ka kb hh je b jf kj jj kk jn kl jr km jv kn jz kf kg kh ki bi translated">Azure机器学习</li><li id="3182" class="ka kb hh je b jf kj jj kk jn kl jr km jv kn jz kf kg kh ki bi translated">Azure存储blob</li><li id="9b1d" class="ka kb hh je b jf kj jj kk jn kl jr km jv kn jz kf kg kh ki bi translated">下载Nasa预测维护数据集</li><li id="b5e6" class="ka kb hh je b jf kj jj kk jn kl jr km jv kn jz kf kg kh ki bi translated">请访问<a class="ae ko" href="https://ti.arc.nasa.gov/tech/dash/groups/pcoe/prognostic-data-repository/" rel="noopener ugc nofollow" target="_blank">https://ti . arc . NASA . gov/tech/dash/groups/pcoe/predictive-data-repository/</a></li><li id="7a17" class="ka kb hh je b jf kj jj kk jn kl jr km jv kn jz kf kg kh ki bi translated">向下滚动到涡扇发动机退化模拟数据集，点击下载涡扇发动机退化模拟数据集(68202下载)</li><li id="a956" class="ka kb hh je b jf kj jj kk jn kl jr km jv kn jz kf kg kh ki bi translated">在Azure ML中创建一个名为nasaPredMaint的数据集</li></ul><h1 id="ec54" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated">Azure Blob存储</h1><ul class=""><li id="d41f" class="ka kb hh je b jf jg jj jk jn kc jr kd jv ke jz kf kg kh ki bi translated">创建存储帐户</li><li id="2509" class="ka kb hh je b jf kj jj kk jn kl jr km jv kn jz kf kg kh ki bi translated">创建一个名为PredMaint的容器</li><li id="2624" class="ka kb hh je b jf kj jj kk jn kl jr km jv kn jz kf kg kh ki bi translated">上传下载的文件</li></ul><h1 id="2e34" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated">Azure机器学习</h1><ul class=""><li id="3a4e" class="ka kb hh je b jf jg jj jk jn kc jr kd jv ke jz kf kg kh ki bi translated">首先创建一个数据集</li></ul><figure class="kq kr ks kt fd ku er es paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="er es kp"><img src="../Images/49b479fbb14e27be52071b10ccf8ea87.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dZplJ-gbixiORCYkDtFPIg.jpeg"/></div></div></figure><ul class=""><li id="aae2" class="ka kb hh je b jf lb jj lc jn ld jr le jv lf jz kf kg kh ki bi translated">创建一个名为nasapredmaint的新数据存储</li></ul><figure class="kq kr ks kt fd ku er es paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="er es lg"><img src="../Images/30b9c51d6af971ce6a0ef7d9ae20b295.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dQ30EzGskASWye5Sz5YMKA.jpeg"/></div></div></figure><ul class=""><li id="22b8" class="ka kb hh je b jf lb jj lc jn ld jr le jv lf jz kf kg kh ki bi translated">现在让我们创建一个计算实例</li><li id="bc18" class="ka kb hh je b jf kj jj kk jn kl jr km jv kn jz kf kg kh ki bi translated">启动计算实例</li><li id="4940" class="ka kb hh je b jf kj jj kk jn kl jr km jv kn jz kf kg kh ki bi translated">创建新笔记本</li><li id="ba7d" class="ka kb hh je b jf kj jj kk jn kl jr km jv kn jz kf kg kh ki bi translated">选择python + AzureML</li><li id="8a5e" class="ka kb hh je b jf kj jj kk jn kl jr km jv kn jz kf kg kh ki bi translated">加载注册的数据集</li></ul><pre class="kq kr ks kt fd lh li lj lk aw ll bi"><span id="d707" class="lm if hh li b fi ln lo l lp lq"># azureml-core of version 1.0.72 or higher is required<br/># azureml-dataprep[pandas] of version 1.1.34 or higher is required<br/>from azureml.core import Workspace, Dataset<br/><br/>subscription_id = 'xxxxxxxxxxx'<br/>resource_group = 'rgname'<br/>workspace_name = 'mlworkspace'<br/><br/>workspace = Workspace(subscription_id, resource_group, workspace_name)<br/><br/>dataset = Dataset.get_by_name(workspace, name='nasaPredMaint')<br/>dataset.to_pandas_dataframe()</span></pre><ul class=""><li id="3ac6" class="ka kb hh je b jf lb jj lc jn ld jr le jv lf jz kf kg kh ki bi translated">将数据集转换为数据帧</li></ul><pre class="kq kr ks kt fd lh li lj lk aw ll bi"><span id="993a" class="lm if hh li b fi ln lo l lp lq">df = dataset.to_pandas_dataframe()</span></pre><ul class=""><li id="94e8" class="ka kb hh je b jf lb jj lc jn ld jr le jv lf jz kf kg kh ki bi translated">列出所有列</li></ul><pre class="kq kr ks kt fd lh li lj lk aw ll bi"><span id="e6d9" class="lm if hh li b fi ln lo l lp lq">df.columns</span></pre><ul class=""><li id="24eb" class="ka kb hh je b jf lb jj lc jn ld jr le jv lf jz kf kg kh ki bi translated">导入库</li></ul><pre class="kq kr ks kt fd lh li lj lk aw ll bi"><span id="f915" class="lm if hh li b fi ln lo l lp lq">import torch<br/>import torch.nn as nn<br/>import matplotlib.pyplot as plt<br/>import numpy as np<br/>import torch<br/>from torch.autograd import Variable</span></pre><ul class=""><li id="c22c" class="ka kb hh je b jf lb jj lc jn ld jr le jv lf jz kf kg kh ki bi translated">删除标签列和不需要的列</li></ul><pre class="kq kr ks kt fd lh li lj lk aw ll bi"><span id="fe41" class="lm if hh li b fi ln lo l lp lq">df1 = df.drop(columns=['timecycles','sensor22', 'sensor23'])</span></pre><ul class=""><li id="ca85" class="ka kb hh je b jf lb jj lc jn ld jr le jv lf jz kf kg kh ki bi translated">分割要素和标签</li></ul><pre class="kq kr ks kt fd lh li lj lk aw ll bi"><span id="c53b" class="lm if hh li b fi ln lo l lp lq">X = df1.iloc[:,:31]<br/>y = df[['timecycles']]</span></pre><ul class=""><li id="830e" class="ka kb hh je b jf lb jj lc jn ld jr le jv lf jz kf kg kh ki bi translated">显示数据帧</li></ul><pre class="kq kr ks kt fd lh li lj lk aw ll bi"><span id="b9c6" class="lm if hh li b fi ln lo l lp lq">df1.head()</span></pre><ul class=""><li id="07a8" class="ka kb hh je b jf lb jj lc jn ld jr le jv lf jz kf kg kh ki bi translated">现在导入新库</li></ul><pre class="kq kr ks kt fd lh li lj lk aw ll bi"><span id="7eb2" class="lm if hh li b fi ln lo l lp lq">#Let's get rid of some imports<br/>%matplotlib inline<br/>import matplotlib.pyplot as plt<br/>import numpy as np<br/>#Define the model <br/>import torch<br/>import torch.nn as nn<br/>import torch.nn.functional as F</span></pre><ul class=""><li id="d826" class="ka kb hh je b jf lb jj lc jn ld jr le jv lf jz kf kg kh ki bi translated">定义特征和标签</li></ul><pre class="kq kr ks kt fd lh li lj lk aw ll bi"><span id="43cd" class="lm if hh li b fi ln lo l lp lq">from sklearn.model_selection  import train_test_split<br/>X = df1.iloc[:, 0:29]<br/>y = df[['timecycles']]<br/><br/># Split the data into a training set and a test set<br/>X_train, X_test, y_train, y_test = train_test_split(X, y, test_size=0.3, random_state=0)<br/><br/>print(X_train.shape, X_test.shape, y_train.shape, y_test.shape)</span></pre><ul class=""><li id="c2e6" class="ka kb hh je b jf lb jj lc jn ld jr le jv lf jz kf kg kh ki bi translated">定义参数</li></ul><pre class="kq kr ks kt fd lh li lj lk aw ll bi"><span id="bd58" class="lm if hh li b fi ln lo l lp lq">#Define training hyperprameters.<br/>batch_size = 50<br/>num_epochs = 200<br/>learning_rate = 0.01<br/>size_hidden= 100<br/><br/>#Calculate some other hyperparameters based on data.  <br/>batch_no = len(X_train) // batch_size  #batches<br/>cols=X_train.shape[1] #Number of columns in input matrix<br/>n_output=1</span></pre><ul class=""><li id="f257" class="ka kb hh je b jf lb jj lc jn ld jr le jv lf jz kf kg kh ki bi translated">创建模型</li></ul><pre class="kq kr ks kt fd lh li lj lk aw ll bi"><span id="127f" class="lm if hh li b fi ln lo l lp lq">#Create the model<br/>device = torch.device("cuda:0" if torch.cuda.is_available() else "cpu")<br/># Assume that we are on a CUDA machine, then this should print a CUDA device:<br/>print("Executing the model on :",device)<br/>class Net(torch.nn.Module):<br/>    def __init__(self, n_feature, size_hidden, n_output):<br/>        super(Net, self).__init__()<br/>        self.hidden = torch.nn.Linear(cols, size_hidden)   # hidden layer<br/>        self.predict = torch.nn.Linear(size_hidden, n_output)   # output layer<br/><br/>    def forward(self, x):<br/>        x = F.relu(self.hidden(x))      # activation function for hidden layer<br/>        x = self.predict(x)             # linear output<br/>        return x<br/>net = Net(cols, size_hidden, n_output)</span></pre><ul class=""><li id="1287" class="ka kb hh je b jf lb jj lc jn ld jr le jv lf jz kf kg kh ki bi translated">配置优化程序</li></ul><pre class="kq kr ks kt fd lh li lj lk aw ll bi"><span id="1a09" class="lm if hh li b fi ln lo l lp lq">#Adam is a specific flavor of gradient decent which is typically better<br/>optimizer = torch.optim.Adam(net.parameters(), lr=learning_rate)<br/>#optimizer = torch.optim.SGD(net.parameters(), lr=0.2)<br/>criterion = torch.nn.MSELoss(size_average=False)  # this is for regression mean squared loss</span></pre><ul class=""><li id="f9c8" class="ka kb hh je b jf lb jj lc jn ld jr le jv lf jz kf kg kh ki bi translated">更改值</li></ul><pre class="kq kr ks kt fd lh li lj lk aw ll bi"><span id="7c74" class="lm if hh li b fi ln lo l lp lq">#Change to numpy arraay. <br/>X_train=X_train.values<br/>y_train=y_train.values<br/>X_test=X_test.values<br/>y_test=y_test.values</span></pre><figure class="kq kr ks kt fd ku er es paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="er es lr"><img src="../Images/8a422e8efb9bd12c49adb3fb4f8359a2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SLaQ2TX_s0JWCg1uMCEGGw.jpeg"/></div></div></figure><ul class=""><li id="fbd1" class="ka kb hh je b jf lb jj lc jn ld jr le jv lf jz kf kg kh ki bi translated">现在运行模型</li></ul><pre class="kq kr ks kt fd lh li lj lk aw ll bi"><span id="b587" class="lm if hh li b fi ln lo l lp lq">from sklearn.utils import shuffle<br/>from torch.autograd import Variable<br/>running_loss = 0.0<br/>for epoch in range(num_epochs):<br/>    #Shuffle just mixes up the dataset between epocs<br/>    X_train, y_train = shuffle(X_train, y_train)<br/>    # Mini batch learning<br/>    for i in range(batch_no):<br/>        start = i * batch_size<br/>        end = start + batch_size<br/>        inputs = Variable(torch.FloatTensor(X_train[start:end]))<br/>        labels = Variable(torch.FloatTensor(y_train[start:end]))<br/>        # zero the parameter gradients<br/>        optimizer.zero_grad()<br/><br/>        # forward + backward + optimize<br/>        outputs = net(inputs)<br/>        #print("outputs",outputs)<br/>        #print("outputs",outputs,outputs.shape,"labels",labels, labels.shape)<br/>        loss = criterion(outputs, torch.unsqueeze(labels,dim=1))<br/>        loss.backward()<br/>        optimizer.step()<br/><br/>        # print statistics<br/>        running_loss += loss.item()<br/>        <br/>    print('Epoch {}'.format(epoch+1), "loss: ",running_loss)<br/>    running_loss = 0.0</span></pre><figure class="kq kr ks kt fd ku er es paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="er es ls"><img src="../Images/811a780ce8e70fa5f14df8f9e0fb7c25.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*enhc9DIkR8f7iT7PwTX0Kw.jpeg"/></div></div></figure><ul class=""><li id="c77a" class="ka kb hh je b jf lb jj lc jn ld jr le jv lf jz kf kg kh ki bi translated">计算指标</li></ul><pre class="kq kr ks kt fd lh li lj lk aw ll bi"><span id="7161" class="lm if hh li b fi ln lo l lp lq">import pandas as pd<br/>from sklearn.metrics import r2_score<br/><br/>X = Variable(torch.FloatTensor(X_train)) <br/>result = net(X)<br/>pred=result.data[:,0].numpy()<br/>print(len(pred),len(y_train))<br/>r2_score(pred,y_train)</span></pre><ul class=""><li id="2a0e" class="ka kb hh je b jf lb jj lc jn ld jr le jv lf jz kf kg kh ki bi translated">寻找R2分数</li></ul><pre class="kq kr ks kt fd lh li lj lk aw ll bi"><span id="33b6" class="lm if hh li b fi ln lo l lp lq">import pandas as pd<br/>from sklearn.metrics import r2_score<br/>#This is a little bit tricky to get the resulting prediction.  <br/>def calculate_r2(x,y=[]):<br/>    """<br/>    This function will return the r2 if passed x and y or return predictions if just passed x. <br/>    """<br/>    # Evaluate the model with the test set. <br/>    X = Variable(torch.FloatTensor(x))  <br/>    result = net(X) #This outputs the value for regression<br/>    result=result.data[:,0].numpy()<br/>  <br/>    if len(y) != 0:<br/>        r2=r2_score(result, y)<br/>        print("R-Squared", r2)<br/>        #print('Accuracy {:.2f}'.format(num_right / len(y)), "for a total of ", len(y), "records")<br/>        return pd.DataFrame(data= {'actual': y, 'predicted': result})<br/>    else:<br/>        print("returning predictions")<br/>        return result</span></pre><ul class=""><li id="a102" class="ka kb hh je b jf lb jj lc jn ld jr le jv lf jz kf kg kh ki bi translated">运行线性模型</li></ul><pre class="kq kr ks kt fd lh li lj lk aw ll bi"><span id="5fd2" class="lm if hh li b fi ln lo l lp lq">from sklearn.linear_model import LinearRegression<br/>lm = LinearRegression()<br/>lm.fit( X_train, y_train )</span></pre><ul class=""><li id="8927" class="ka kb hh je b jf lb jj lc jn ld jr le jv lf jz kf kg kh ki bi translated">打印分数</li></ul><pre class="kq kr ks kt fd lh li lj lk aw ll bi"><span id="a08f" class="lm if hh li b fi ln lo l lp lq">print('R2 for Train)', lm.score( X_train, y_train ))<br/>print('R2 for Test (cross validation)', lm.score(X_test, y_test))</span></pre><p id="6bcc" class="pw-post-body-paragraph jc jd hh je b jf lb jh ji jj lc jl jm jn lt jp jq jr lu jt ju jv lv jx jy jz ha bi translated">【github.com】的samples 2021/pytorchregression . MD</p></div></div>    
</body>
</html>