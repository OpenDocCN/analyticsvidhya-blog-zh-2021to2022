<html>
<head>
<title>Flask Development Part 5: Register and Login Users</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Flask开发第5部分:注册和登录用户</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/flask-development-part-5-register-and-login-users-a79042c9368c?source=collection_archive---------6-----------------------#2021-04-03">https://medium.com/analytics-vidhya/flask-development-part-5-register-and-login-users-a79042c9368c?source=collection_archive---------6-----------------------#2021-04-03</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="fcea" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这是一系列文章的第5部分，通过开发和托管一个简单的CRUD应用程序，带您了解Flask Web开发的基础知识。</p><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="ji jj di jk bf jl"><div class="er es jc"><img src="../Images/0fdde0c5543c9946ee7ddef5cbbc1389.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*aWK6yDaBe7x5viez2VyeMw.jpeg"/></div></div></figure><h1 id="d4f6" class="jo jp hh bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">该系列分为6个部分:</h1><ol class=""><li id="aeb8" class="km kn hh ig b ih ko il kp ip kq it kr ix ks jb kt ku kv kw bi translated"><a class="ae kx" href="https://medium.com/p/69cbf9e83abc/edit" rel="noopener">一个简单的Hello World应用</a></li><li id="d74f" class="km kn hh ig b ih ky il kz ip la it lb ix lc jb kt ku kv kw bi translated"><a class="ae kx" href="https://medium.com/p/d10442121fdd/edit" rel="noopener">渲染HTML模板。</a></li><li id="1d06" class="km kn hh ig b ih ky il kz ip la it lb ix lc jb kt ku kv kw bi translated"><a class="ae kx" href="https://medium.com/p/68e3bf2f6642/edit" rel="noopener">构建可扩展的文件结构。</a></li><li id="58e7" class="km kn hh ig b ih ky il kz ip la it lb ix lc jb kt ku kv kw bi translated"><a class="ae kx" href="https://medium.com/p/648b11f708a5/edit" rel="noopener">配置数据库。</a></li><li id="5302" class="km kn hh ig b ih ky il kz ip la it lb ix lc jb kt ku kv kw bi translated"><a class="ae kx" href="https://medium.com/p/a79042c9368c/edit" rel="noopener"> <strong class="ig hi">处理用户登录和注册。</strong>T13】</a></li><li id="c1dd" class="km kn hh ig b ih ky il kz ip la it lb ix lc jb kt ku kv kw bi translated"><a class="ae kx" href="https://medium.com/p/d3413cd94363/edit" rel="noopener">增加CRUD(创建、读取、更新、删除)功能。</a></li></ol><h1 id="b3d3" class="jo jp hh bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">第5部分:处理用户登录和注册</h1><p id="3edf" class="pw-post-body-paragraph ie if hh ig b ih ko ij ik il kp in io ip ld ir is it le iv iw ix lf iz ja jb ha bi translated">在这一部分中，我们将使用在第4部分中在数据库中创建的用户对象来创建新用户，并允许他们登录和退出我们的应用程序。</p><h2 id="3372" class="lg jp hh bd jq lh li lj ju lk ll lm jy ip ln lo kc it lp lq kg ix lr ls kk lt bi translated">第一步。添加跨站点伪造保护和Bcrypt</h2><p id="7137" class="pw-post-body-paragraph ie if hh ig b ih ko ij ik il kp in io ip ld ir is it le iv iw ix lf iz ja jb ha bi translated">首先，我们将通过在我们的终端中运行这两行来安装另外3个flask扩展:</p><pre class="jd je jf jg fd lu lv lw lx aw ly bi"><span id="ea17" class="lg jp hh lv b fi lz ma l mb mc">pip install flask_wtf<br/>pip install email_validator<br/>pip install flask_bcrypt</span></pre><p id="ed1d" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">现在让我们将新的扩展导入到config.py文件中。我们还将添加操作系统，这将有助于我们稍后生成密钥。</p><pre class="jd je jf jg fd lu lv lw lx aw ly bi"><span id="f70c" class="lg jp hh lv b fi lz ma l mb mc">from flask import Flask<br/>from flask_sqlalchemy import SQLAlchemy<strong class="lv hi"><br/>from flask_wtf.csrf import CSRFProtect<br/>from flask_bcrypt import Bcrypt<br/>import os</strong></span><span id="7533" class="lg jp hh lv b fi md ma l mb mc">app = Flask(__name__,  template_folder='../templates')</span><span id="fb9e" class="lg jp hh lv b fi md ma l mb mc">app.config['SQLALCHEMY_DATABASE_URI'] = 'sqlite:///site.db'<br/>db = SQLAlchemy(app)</span><span id="5cba" class="lg jp hh lv b fi md ma l mb mc">class User(db.Model, UserMixin):</span><span id="c063" class="lg jp hh lv b fi md ma l mb mc">id = db.Column(db.Integer, <br/>               primary_key = True)<br/>    username = db.Column(db.String(20),<br/>                         unique = True, <br/>                         nullable = False)<br/>    email = db.Column(db.String(120), <br/>                      unique = True, <br/>                      nullable = False)<br/>    password = db.Column(db.String(60), <br/>                         nullable = False)</span></pre><p id="a7bc" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">然后，我们将添加几行来配置我们的CSRF令牌。</p><pre class="jd je jf jg fd lu lv lw lx aw ly bi"><span id="de2e" class="lg jp hh lv b fi lz ma l mb mc">from flask import Flask<br/>from flask_sqlalchemy import SQLAlchemy<br/>import os<br/>from flask_wtf.csrf import CSRFProtect</span><span id="d1fa" class="lg jp hh lv b fi md ma l mb mc">app = Flask(__name__,  template_folder='../templates')</span><span id="2867" class="lg jp hh lv b fi md ma l mb mc">app.config['SQLALCHEMY_DATABASE_URI'] = 'sqlite:///site.db'<br/>db = SQLAlchemy(app)</span><span id="9df1" class="lg jp hh lv b fi md ma l mb mc"><strong class="lv hi"><br/>SECRET_KEY = os.urandom(32)<br/>app.config['SECRET_KEY'] = SECRET_KEY<br/>csrf = CSRFProtect(app)<br/></strong></span><span id="578c" class="lg jp hh lv b fi md ma l mb mc">class User(db.Model, UserMixin):</span><span id="bcde" class="lg jp hh lv b fi md ma l mb mc">id = db.Column(db.Integer, <br/>               primary_key = True)<br/>    username = db.Column(db.String(20),<br/>                         unique = True, <br/>                         nullable = False)<br/>    email = db.Column(db.String(120), <br/>                      unique = True, <br/>                      nullable = False)<br/>    password = db.Column(db.String(60), <br/>                         nullable = False)</span></pre><p id="ed00" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">然后，我们将这一行添加到我们的配置文件中，以便在我们的应用程序中启用bcrypt散列实用程序。</p><pre class="jd je jf jg fd lu lv lw lx aw ly bi"><span id="e13d" class="lg jp hh lv b fi lz ma l mb mc">app = Flask(__name__,  template_folder='../templates')</span><span id="9f40" class="lg jp hh lv b fi md ma l mb mc"><strong class="lv hi">bcrypt = Bcrypt(app)</strong></span><span id="d9df" class="lg jp hh lv b fi md ma l mb mc">SECRET_KEY = os.urandom(32)<br/>app.config['SECRET_KEY'] = SECRET_KEY<br/>csrf = CSRFProtect(app)</span><span id="c454" class="lg jp hh lv b fi md ma l mb mc">app.config['SQLALCHEMY_DATABASE_URI'] = 'sqlite:///site.db'<br/>db = SQLAlchemy(app)</span><span id="c6d3" class="lg jp hh lv b fi md ma l mb mc">class User(db.Model, UserMixin):</span><span id="29f2" class="lg jp hh lv b fi md ma l mb mc">id = db.Column(db.Integer, <br/>               primary_key = True)<br/>    username = db.Column(db.String(20), <br/>                         unique = True, <br/>                         nullable = False)<br/>    email = db.Column(db.String(120), <br/>                      unique = True, <br/>                      nullable = False)<br/>    password = db.Column(db.String(60), <br/>                         nullable = False)</span></pre><p id="d0eb" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">有关烧瓶csrf保护的更多信息，请查看文档<a class="ae kx" href="https://flask-wtf.readthedocs.io/en/stable/csrf.html" rel="noopener ugc nofollow" target="_blank">这里</a>。</p><p id="d52a" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">有关flask的Bcrypt包的更多信息，请查看这里的文档<a class="ae kx" href="https://flask-bcrypt.readthedocs.io/en/latest/" rel="noopener ugc nofollow" target="_blank">。</a></p><h2 id="8259" class="lg jp hh bd jq lh li lj ju lk ll lm jy ip ln lo kc it lp lq kg ix lr ls kk lt bi translated">第二步。设置登录管理器</h2><p id="9208" class="pw-post-body-paragraph ie if hh ig b ih ko ij ik il kp in io ip ld ir is it le iv iw ix lf iz ja jb ha bi translated">首先，我们将安装另一个flask包。这将帮助我们完成登录任务。在您的终端中使用以下命令安装flask_login。</p><pre class="jd je jf jg fd lu lv lw lx aw ly bi"><span id="ecd8" class="lg jp hh lv b fi lz ma l mb mc">pip install flask_login</span></pre><p id="cf35" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">接下来，我们需要在index.py文件中添加一些导入来访问我们安装的新包。</p><pre class="jd je jf jg fd lu lv lw lx aw ly bi"><span id="a5df" class="lg jp hh lv b fi lz ma l mb mc">from config import app, db<br/>from flask import Flask, render_template<br/><strong class="lv hi">from flask_login import login_user, current_user, logout_user, login_required</strong></span><span id="81e3" class="lg jp hh lv b fi md ma l mb mc"><a class="ae kx" href="http://twitter.com/app" rel="noopener ugc nofollow" target="_blank">@app</a>.route('/')<br/><a class="ae kx" href="http://twitter.com/app" rel="noopener ugc nofollow" target="_blank">@app</a>.route('/index')<br/>def hello_world():</span><span id="3ac5" class="lg jp hh lv b fi md ma l mb mc">    return render_template('index.html')</span></pre><p id="3f29" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">然后，我们需要在config.py文件中添加一些代码来处理用户身份验证。</p><pre class="jd je jf jg fd lu lv lw lx aw ly bi"><span id="c6f0" class="lg jp hh lv b fi lz ma l mb mc">from flask import Flask<br/>from flask_login import UserMixin, current_user, login_manager<br/>from flask_login import LoginManager<br/>from flask_sqlalchemy import SQLAlchemy<br/>import os<br/>from flask_wtf.csrf import CSRFProtect</span><span id="29a3" class="lg jp hh lv b fi md ma l mb mc">app = Flask(__name__,  template_folder='../templates')</span><span id="26e8" class="lg jp hh lv b fi md ma l mb mc">CSRFProtect(app)<br/>SECRET_KEY = os.urandom(32)<br/>app.config['SECRET_KEY'] = SECRET_KEY<br/>csrf = CSRFProtect(app)<br/>csrf.init_app(app)</span><span id="f4d8" class="lg jp hh lv b fi md ma l mb mc"><strong class="lv hi">login_manager = LoginManager(app)<br/>login_manager.login_view = 'login'<br/>login_manager.login_message_category = 'info'<br/></strong><a class="ae kx" href="http://twitter.com/login_manager" rel="noopener ugc nofollow" target="_blank"><strong class="lv hi">@login_manager</strong></a><strong class="lv hi">.user_loader<br/>def load_user(user_id):<br/>    return User.query.get(int(user_id))</strong></span><span id="a562" class="lg jp hh lv b fi md ma l mb mc">app.config['SQLALCHEMY_DATABASE_URI'] = 'sqlite:///site.db'<br/>db = SQLAlchemy(app)</span><span id="3e61" class="lg jp hh lv b fi md ma l mb mc">class User(db.Model, UserMixin):</span><span id="11ca" class="lg jp hh lv b fi md ma l mb mc">    id = db.Column(db.Integer, <br/>                   primary_key = True)<br/>    username = db.Column(db.String(20),<br/>                         unique = True, <br/>                         nullable = False)<br/>    email = db.Column(db.String(120), <br/>                      unique = True, <br/>                      nullable = False)<br/>    password = db.Column(db.String(60), <br/>                         nullable = False)</span></pre><p id="367c" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">你不需要知道这到底是怎么回事。基本上，这只是设置了登录管理器，并让我们使用一些简洁的东西。例如了解当前用户及其状态的方法。完整的文档在这里。</p><h2 id="cc5a" class="lg jp hh bd jq lh li lj ju lk ll lm jy ip ln lo kc it lp lq kg ix lr ls kk lt bi translated">步骤3:创建经过身份验证和未经身份验证的视图</h2><p id="cb9f" class="pw-post-body-paragraph ie if hh ig b ih ko ij ik il kp in io ip ld ir is it le iv iw ix lf iz ja jb ha bi translated">现在，我们可以使用登录管理器为登录的用户构建一个单独的视图。</p><p id="5ac9" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">现在我们的index.html文件对每个人都是一样的:</p><pre class="jd je jf jg fd lu lv lw lx aw ly bi"><span id="ca02" class="lg jp hh lv b fi lz ma l mb mc">&lt;!DOCTYPE html&gt;<br/>&lt;html lang="en" dir="ltr"&gt;<br/>  &lt;head&gt;<br/>    &lt;meta charset="utf-8"&gt;<br/>    &lt;title&gt;&lt;/title&gt;<br/>  &lt;/head&gt;<br/>  &lt;body&gt;<br/>    &lt;p&gt;Hello, World (But with HTML)!&lt;/p&gt;<br/>  &lt;/body&gt;<br/>&lt;/html&gt;</span></pre><p id="516b" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我们将通过使用current_user创建一个经过身份验证和未经身份验证的视图来修改这个简单的消息。(这是我提到的登录管理器允许您做的一件好事。)</p><pre class="jd je jf jg fd lu lv lw lx aw ly bi"><span id="32e9" class="lg jp hh lv b fi lz ma l mb mc">&lt;!DOCTYPE html&gt;<br/>&lt;html lang="en" dir="ltr"&gt;<br/>  &lt;head&gt;<br/>    &lt;meta charset="utf-8"&gt;<br/>    &lt;title&gt;&lt;/title&gt;<br/>  &lt;/head&gt;<br/>  &lt;body&gt;<br/>      <strong class="lv hi">{% if current_user.is_authenticated %}<br/>        &lt;p&gt;Hello, authenticated user!&lt;/p&gt;<br/>      {% else %}<br/>        &lt;p&gt;Hello, unauthenticated user!&lt;/p&gt;<br/>      {% endif %}</strong><br/>  &lt;/body&gt;<br/>&lt;/html&gt;</span></pre><p id="2cbd" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">现在，如果用户已登录，第一条消息将显示在浏览器中，如果用户未登录，第二条消息将显示。(我们将在后面介绍如何让用户登录。)</p><p id="507e" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">让我们继续工作，为这两个视图创建新文件，并将它们导入到index.html文件中。随着它们变得越来越复杂，这将使它们更容易管理。</p><p id="914e" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">首先，我们将在模板&gt;视图中创建两个新文件。</p><figure class="jd je jf jg fd jh er es paragraph-image"><div class="er es me"><img src="../Images/664581e390b356f7687f04a60dab481c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1160/format:webp/1*G-x_2WsxJ5OsTIyl6hLmGw.png"/></div></figure><p id="dd11" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">authenticated.html内部传出这样的消息:</p><pre class="jd je jf jg fd lu lv lw lx aw ly bi"><span id="24e1" class="lg jp hh lv b fi lz ma l mb mc">&lt;p&gt;Hello, authenticated user!&lt;/p&gt;</span></pre><p id="c52d" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">unauthenticated.html内部传出这样的消息:</p><pre class="jd je jf jg fd lu lv lw lx aw ly bi"><span id="528f" class="lg jp hh lv b fi lz ma l mb mc">&lt;p&gt;Hello, unauthenticated user!&lt;/p&gt;</span></pre><p id="22f0" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">然后，我们将改变index.html进口这两个完整的观点。</p><pre class="jd je jf jg fd lu lv lw lx aw ly bi"><span id="9964" class="lg jp hh lv b fi lz ma l mb mc">&lt;!DOCTYPE html&gt;<br/>&lt;html lang="en" dir="ltr"&gt;<br/>  &lt;head&gt;<br/>    &lt;meta charset="utf-8"&gt;<br/>    &lt;title&gt;&lt;/title&gt;<br/>  &lt;/head&gt;<br/>  &lt;body&gt;<br/>      {% if current_user.is_authenticated %}<br/>        <strong class="lv hi">{% include 'views/authenticated.html' %}</strong><br/>      {% else %}<br/>        <strong class="lv hi">{% include 'views/unauthenticated.html' %}</strong><br/>      {% endif %}<br/>  &lt;/body&gt;<br/>&lt;/html&gt;</span></pre><p id="2a25" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">显然，这并没有真正简化我们的项目。但是当我们的html文件开始增长时，这种用一行代码包含整个HTML文件的方法变得更加简洁。</p><h2 id="c1bc" class="lg jp hh bd jq lh li lj ju lk ll lm jy ip ln lo kc it lp lq kg ix lr ls kk lt bi translated">步骤4:用Flask WTF创建登录和注册表单</h2><p id="fc06" class="pw-post-body-paragraph ie if hh ig b ih ko ij ik il kp in io ip ld ir is it le iv iw ix lf iz ja jb ha bi translated">首先，我们将安装另一个flask包:“wtforms”。通过在终端中运行以下pip命令来实现这一点。</p><pre class="jd je jf jg fd lu lv lw lx aw ly bi"><span id="800f" class="lg jp hh lv b fi lz ma l mb mc">pip install wtforms</span></pre><p id="b81a" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">现在我们可以继续构建我们的登录和注册表单。要创建这些表单，我们首先要编辑forms.py文件。</p><p id="f1c0" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我们将进口方盒。</p><pre class="jd je jf jg fd lu lv lw lx aw ly bi"><span id="d978" class="lg jp hh lv b fi lz ma l mb mc">from flask_wtf import FlaskForm</span></pre><p id="f42c" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">接下来，我们将从刚刚安装的新包中导入一些字段类型和验证器。</p><pre class="jd je jf jg fd lu lv lw lx aw ly bi"><span id="f640" class="lg jp hh lv b fi lz ma l mb mc">from wtforms import (StringField, PasswordField, SubmitField,              <br/>                     BooleanField)<br/>from wtforms.validators import DataRequired, Length, Email, EqualTo</span></pre><p id="4ca1" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">然后我们将创建两个类:一个用于登录表单，一个用于注册表单。</p><pre class="jd je jf jg fd lu lv lw lx aw ly bi"><span id="dae8" class="lg jp hh lv b fi lz ma l mb mc">from flask_wtf import FlaskForm<br/>from wtforms import (StringField, PasswordField, SubmitField,              <br/>                     BooleanField)<br/>from wtforms.validators import DataRequired, Length, Email, EqualTo</span><span id="7eab" class="lg jp hh lv b fi md ma l mb mc"><strong class="lv hi">class RegistrationForm(FlaskForm):</strong></span><span id="0e21" class="lg jp hh lv b fi md ma l mb mc"><strong class="lv hi">    username = StringField('Username',<br/>                           validators=[DataRequired(), <br/>                           Length(min=2, max=20)])</strong></span><span id="cc04" class="lg jp hh lv b fi md ma l mb mc"><strong class="lv hi">    email = StringField('Email',<br/>                        validators=[DataRequired(), <br/>                        Email()])</strong></span><span id="70f6" class="lg jp hh lv b fi md ma l mb mc"><strong class="lv hi">    password = PasswordField('Password',<br/>                             validators=[DataRequired()])</strong></span><span id="4934" class="lg jp hh lv b fi md ma l mb mc"><strong class="lv hi">    confirm_password = PasswordField('Confirm Password',<br/>                                     validators=[DataRequired(),<br/>                                     EqualTo('password')])<br/>    submit = SubmitField('Sign Up')</strong></span><span id="5c80" class="lg jp hh lv b fi md ma l mb mc"><strong class="lv hi">class LoginForm(FlaskForm):</strong></span><span id="154f" class="lg jp hh lv b fi md ma l mb mc"><strong class="lv hi">    email = StringField('Email',<br/>                        validators = [DataRequired(),<br/>                        Email()])</strong></span><span id="1642" class="lg jp hh lv b fi md ma l mb mc"><strong class="lv hi">    password = PasswordField('Password',<br/>                             validators = [DataRequired()])</strong></span><span id="b374" class="lg jp hh lv b fi md ma l mb mc"><strong class="lv hi">    remember = BooleanField('Remember Me')</strong></span><span id="855d" class="lg jp hh lv b fi md ma l mb mc"><strong class="lv hi">    submit = SubmitField('Login')</strong></span></pre><p id="5d92" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">请注意我们刚刚创建的RegistrationForm类和我们在第4部分中创建的用户模型类之间的相似性。还要注意，没有id字段，因为它是自动生成的。</p><p id="5f18" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我们的RegistrationForm类有5个字段:两个字符串字段、两个密码字段和一个提交字段。每个字段中的第一个参数是字段名。下一个参数是验证器列表。还记得数据库中的一些字段是如何被强制唯一的吗，比如用户名和电子邮件？或者我们如何设置字符串字段的最大和最小长度？出于这个原因，我们不希望表单能够提交任何无法保存到我们的数据库中的内容。</p><ol class=""><li id="3047" class="km kn hh ig b ih ii il im ip mf it mg ix mh jb kt ku kv kw bi translated">DataRequired() —如果此字段为空，则表单不会提交</li><li id="bae1" class="km kn hh ig b ih ky il kz ip la it lb ix lc jb kt ku kv kw bi translated">长度(最小值=2，最大值=20) —如果字段少于2个字符或多于20个字符，则表单不会提交。</li><li id="89e9" class="km kn hh ig b ih ky il kz ip la it lb ix lc jb kt ku kv kw bi translated">Email() —如果输入不是电子邮件，表单不会提交(例如，something@something.something)</li><li id="884d" class="km kn hh ig b ih ky il kz ip la it lb ix lc jb kt ku kv kw bi translated">EqualTo('name') —表单不会提交，除非此字段中的输入与【T0 ]' name '字段中的输入相同。</li></ol><p id="8603" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">登录表单有4个字段:字符串、密码、布尔值和提交。它们使用与注册表单相同的验证器来构造。</p><p id="22cf" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">关于长颈瓶形式的更多信息可以在文档<a class="ae kx" href="https://flask-wtf.readthedocs.io/en/stable/quickstart.html#creating-forms" rel="noopener ugc nofollow" target="_blank">这里</a>找到。</p><p id="b4bd" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">现在我们需要转到index.py文件来导入这些新表单。</p><pre class="jd je jf jg fd lu lv lw lx aw ly bi"><span id="e13e" class="lg jp hh lv b fi lz ma l mb mc">from config import app, db<br/>from flask import Flask, render_template<br/>from flask_login import login_user, current_user, logout_user, login_required<br/><strong class="lv hi">import forms</strong></span><span id="7187" class="lg jp hh lv b fi md ma l mb mc"><a class="ae kx" href="http://twitter.com/app" rel="noopener ugc nofollow" target="_blank">@app</a>.route('/')<br/><a class="ae kx" href="http://twitter.com/app" rel="noopener ugc nofollow" target="_blank">@app</a>.route('/index')<br/>def hello_world():</span><span id="2f80" class="lg jp hh lv b fi md ma l mb mc">    return render_template('index.html')</span></pre><p id="036b" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">此外，我们需要通过render_template函数将新表单作为参数传递，以便在前端访问它们。</p><pre class="jd je jf jg fd lu lv lw lx aw ly bi"><span id="a806" class="lg jp hh lv b fi lz ma l mb mc">from config import app, db<br/>from flask import Flask, render_template<br/>from flask_login import login_user, current_user, logout_user, login_required<br/>import forms</span><span id="7f4a" class="lg jp hh lv b fi md ma l mb mc"><a class="ae kx" href="http://twitter.com/app" rel="noopener ugc nofollow" target="_blank">@app</a>.route('/')<br/><a class="ae kx" href="http://twitter.com/app" rel="noopener ugc nofollow" target="_blank">@app</a>.route('/index')<br/>def hello_world():</span><span id="1f64" class="lg jp hh lv b fi md ma l mb mc">    return render_template('index.html',<br/>                           <strong class="lv hi">login_form = forms.LoginForm(),<br/>                           register_form = forms.RegistrationForm()</strong>)</span></pre><h2 id="3639" class="lg jp hh bd jq lh li lj ju lk ll lm jy ip ln lo kc it lp lq kg ix lr ls kk lt bi translated">第五步。将我们的表单添加到前端</h2><p id="0f78" class="pw-post-body-paragraph ie if hh ig b ih ko ij ik il kp in io ip ld ir is it le iv iw ix lf iz ja jb ha bi translated">我们创建了flask form类，将它们传递给我们的索引文件，然后在render_template函数中将它们作为参数传递。现在我们将着眼于前端来使用这些新的表单。</p><p id="9316" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">让我们从在未经身份验证的视图中构建一个前端注册表单开始。我们将通过在模板&gt;视图中向我们的unauthenticated.html文件添加以下代码来实现这一点。</p><pre class="jd je jf jg fd lu lv lw lx aw ly bi"><span id="780f" class="lg jp hh lv b fi lz ma l mb mc">&lt;form method="POST" action=""&gt;<br/>  {{ register_form.hidden_tag() }}<br/>    {{ register_form.username( placeholder = "Username") }}<br/>    {{ register_form.email( placeholder = "Email") }}<br/>    {{ register_form.password( placeholder = "Password") }}<br/>    {{ register_form.confirm_password( placeholder = "Confirm Password") }}<br/>    {{ register_form.submit() }}<br/>&lt;/form&gt;</span></pre><p id="cc78" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这段html代码是一个表单标签。点击了解更多关于表单标签<a class="ae kx" href="https://www.w3schools.com/html/html_forms.asp" rel="noopener ugc nofollow" target="_blank">的信息。</a></p><p id="0923" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">form标记内部是我们在上一步中创建的RegistrationForm类的每个元素。</p><p id="f9b3" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">register_form对象在render_template函数中定义为:</p><pre class="jd je jf jg fd lu lv lw lx aw ly bi"><span id="692a" class="lg jp hh lv b fi lz ma l mb mc">register_form = forms.RegistrationForm()</span></pre><p id="49fc" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这意味着我们可以在前端以register_form的形式引用forms.py文件中的表单。因此register_form.username()生成了表单文件中定义的用户名字段。</p><p id="1a45" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">您可以从我的代码中看到，我也给了这些字段一个占位符。这是在有任何输入之前将在输入字段中显示的内容。同样，您可以向这些输入添加样式和类，但这将在后面介绍。</p><p id="f6c3" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">还要注意，这个表单中的第一行是CSRF令牌。因为我们保护了我们的应用程序，所以每个表单都需要它。</p><p id="33a3" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">现在，如果我们运行我们的app.py文件，并在浏览器中转至<a class="ae kx" href="http://localhost:5000/" rel="noopener ugc nofollow" target="_blank"> http://localhost:5000/ </a>，我们将看到以下内容:</p><p id="a255" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">如果我们现在提交这个表单，我们会得到下面的错误。</p><figure class="jd je jf jg fd jh er es paragraph-image"><div class="er es mj"><img src="../Images/e21f89e177506a971893271443500093.png" data-original-src="https://miro.medium.com/v2/resize:fit:1356/format:webp/1*uiRr5xdoVzaKWviiv-MDTw.png"/></div></figure><p id="ee3f" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这是因为我们还没有配置后端来处理我们的post请求。点击了解更多关于各种HTTP请求<a class="ae kx" href="https://www.w3schools.com/tags/ref_httpmethods.asp" rel="noopener ugc nofollow" target="_blank">的信息。</a></p><h2 id="bb4a" class="lg jp hh bd jq lh li lj ju lk ll lm jy ip ln lo kc it lp lq kg ix lr ls kk lt bi translated">第六步。在后端处理表单提交post请求</h2><p id="1e39" class="pw-post-body-paragraph ie if hh ig b ih ko ij ik il kp in io ip ld ir is it le iv iw ix lf iz ja jb ha bi translated">首先，我们将更改允许的方法来处理来自表单的post请求。</p><p id="c5ac" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">现在我们的index.py文件应该是这样的:</p><pre class="jd je jf jg fd lu lv lw lx aw ly bi"><span id="46de" class="lg jp hh lv b fi lz ma l mb mc">from config import app, db<br/>from flask import Flask, render_template<br/>from flask_login import login_user, current_user, logout_user, login_required<br/>import forms</span><span id="ab76" class="lg jp hh lv b fi md ma l mb mc"><a class="ae kx" href="http://twitter.com/app" rel="noopener ugc nofollow" target="_blank">@app</a>.route('/')<br/><a class="ae kx" href="http://twitter.com/app" rel="noopener ugc nofollow" target="_blank">@app</a>.route('/index')<br/>def hello_world():</span><span id="aad2" class="lg jp hh lv b fi md ma l mb mc">return render_template('index.html',<br/>                           login_form = forms.LoginForm(),<br/>                           register_form = forms.RegistrationForm())</span></pre><p id="96f6" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">首先，我们将为app.route装饰器添加一个“方法”参数。</p><pre class="jd je jf jg fd lu lv lw lx aw ly bi"><span id="3ff2" class="lg jp hh lv b fi lz ma l mb mc">from config import app, db<br/>from flask import Flask, render_template<br/>from flask_login import login_user, current_user, logout_user, login_required<br/>import forms</span><span id="53dd" class="lg jp hh lv b fi md ma l mb mc"><a class="ae kx" href="http://twitter.com/app" rel="noopener ugc nofollow" target="_blank">@app</a>.route('/'<strong class="lv hi">, methods = ['GET','POST']</strong>)<br/><a class="ae kx" href="http://twitter.com/app" rel="noopener ugc nofollow" target="_blank">@app</a>.route('/index'<strong class="lv hi">, methods = ['GET','POST']</strong>)<br/>def hello_world():</span><span id="0cf3" class="lg jp hh lv b fi md ma l mb mc">    return render_template('index.html',<br/>                           login_form = forms.LoginForm(),<br/>                           register_form = forms.RegistrationForm())</span></pre><p id="668d" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">现在我们的路由可以处理post和get请求。</p><p id="c24e" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">接下来，我们将更新导入，以包含redirect和url_for flask方法。</p><pre class="jd je jf jg fd lu lv lw lx aw ly bi"><span id="fb84" class="lg jp hh lv b fi lz ma l mb mc">from config import app, db<br/>from flask import Flask, render_template<strong class="lv hi">, redirect, url_for</strong><br/>from flask_login import login_user, current_user, logout_user, login_required<br/>import forms</span><span id="9463" class="lg jp hh lv b fi md ma l mb mc"><a class="ae kx" href="http://twitter.com/app" rel="noopener ugc nofollow" target="_blank">@app</a>.route('/', methods = ['GET','POST'])<br/><a class="ae kx" href="http://twitter.com/app" rel="noopener ugc nofollow" target="_blank">@app</a>.route('/index', methods = ['GET','POST'])<br/>def hello_world():</span><span id="cada" class="lg jp hh lv b fi md ma l mb mc">    return render_template('index.html',<br/>                           login_form = forms.LoginForm(),<br/>                           register_form = forms.RegistrationForm())</span></pre><p id="240c" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">接下来，我们将添加一个“if”条件，如果注册表单被提交，并且我们在forms.py文件中的注册表单对象上设置的所有验证器都被验证，那么将输入该条件。</p><pre class="jd je jf jg fd lu lv lw lx aw ly bi"><span id="0997" class="lg jp hh lv b fi lz ma l mb mc">from config import app, db<br/>from flask import Flask, render_template, redirect, url_for<br/>from flask_login import login_user, current_user, logout_user, login_required<br/>import forms</span><span id="58fe" class="lg jp hh lv b fi md ma l mb mc"><a class="ae kx" href="http://twitter.com/app" rel="noopener ugc nofollow" target="_blank">@app</a>.route('/', methods = ['GET','POST'])<br/><a class="ae kx" href="http://twitter.com/app" rel="noopener ugc nofollow" target="_blank">@app</a>.route('/index', methods = ['GET','POST'])<br/>def hello_world():<br/>    <br/>   <strong class="lv hi"> if forms.RegistrationForm().validate_on_submit():</strong></span><span id="736d" class="lg jp hh lv b fi md ma l mb mc"><strong class="lv hi">        return redirect(url_for(</strong>'hello_world'<strong class="lv hi">))</strong></span><span id="c794" class="lg jp hh lv b fi md ma l mb mc">    return render_template('index.html',<br/>                           login_form = forms.LoginForm(),<br/>                           register_form = forms.RegistrationForm())</span></pre><p id="c65d" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">接下来，我们将更新index.py文件中的导入，以引入bcrypt对象。我们还将导入我们的用户对象，因此我们可以在这个文件中创建它的一个新实例。最后，我们还将从flask导入请求方法(我们将使用它从表单中获取信息)。</p><pre class="jd je jf jg fd lu lv lw lx aw ly bi"><span id="b432" class="lg jp hh lv b fi lz ma l mb mc">from config import app, db<strong class="lv hi">, bcrypt, User</strong><br/>from flask import Flask, render_template, redirect, url_for, <strong class="lv hi">request</strong><br/>from flask_login import login_user, current_user, logout_user, login_required<br/>import forms</span><span id="7a99" class="lg jp hh lv b fi md ma l mb mc"><a class="ae kx" href="http://twitter.com/app" rel="noopener ugc nofollow" target="_blank">@app</a>.route('/', methods = ['GET','POST'])<br/><a class="ae kx" href="http://twitter.com/app" rel="noopener ugc nofollow" target="_blank">@app</a>.route('/index', methods = ['GET','POST'])<br/>def hello_world():<br/>    <br/>    if forms.RegistrationForm().validate_on_submit():</span><span id="2b6b" class="lg jp hh lv b fi md ma l mb mc">        return redirect(url_for('hello_world'))</span><span id="32a0" class="lg jp hh lv b fi md ma l mb mc">return render_template('index.html',<br/>                           login_form = forms.LoginForm(),<br/>                           register_form = forms.RegistrationForm())</span></pre><p id="ac7e" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">现在，在if语句中，我们将添加一些代码来在数据库中创建新用户。</p><pre class="jd je jf jg fd lu lv lw lx aw ly bi"><span id="05a1" class="lg jp hh lv b fi lz ma l mb mc">from config import app, db, User<br/>from flask import Flask, render_template, redirect, url_for, request<br/>from flask_login import login_user, current_user, logout_user, login_required<br/>import forms</span><span id="9057" class="lg jp hh lv b fi md ma l mb mc"><a class="ae kx" href="http://twitter.com/app" rel="noopener ugc nofollow" target="_blank">@app</a>.route('/', methods = ['GET','POST'])<br/><a class="ae kx" href="http://twitter.com/app" rel="noopener ugc nofollow" target="_blank">@app</a>.route('/index', methods = ['GET','POST'])<br/>def hello_world():<br/>    <br/>    if forms.RegistrationForm().validate_on_submit():<br/>       </span><span id="03c3" class="lg jp hh lv b fi md ma l mb mc">        <strong class="lv hi">register_form = forms.RegistrationForm()   </strong>    <br/>        <strong class="lv hi">hashed_password =   bcrypt.generate_password_hash(register_form.password.data).decode('utf-8')<br/>        user = User(username = register_form.username.data,<br/>                    email = register_form.email.data,<br/>                    password = hashed_password)</strong></span><span id="05b0" class="lg jp hh lv b fi md ma l mb mc"><strong class="lv hi">        db.session.add(user)<br/>        db.session.commit()</strong></span><span id="e26b" class="lg jp hh lv b fi md ma l mb mc">        return redirect(url_for('hello_world')))</span><span id="d416" class="lg jp hh lv b fi md ma l mb mc">return render_template('index.html',<br/>                           login_form = forms.LoginForm(),<br/>                           register_form = forms.RegistrationForm())</span></pre><p id="0e96" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">最后，在数据库中创建新用户后，我们将添加几行代码来登录新用户。</p><pre class="jd je jf jg fd lu lv lw lx aw ly bi"><span id="d392" class="lg jp hh lv b fi lz ma l mb mc">from config import app, db, User<br/>from flask import Flask, render_template, redirect, url_for, request<br/>from flask_login import login_user, current_user, logout_user, login_required<br/>import forms</span><span id="a8f2" class="lg jp hh lv b fi md ma l mb mc"><a class="ae kx" href="http://twitter.com/app" rel="noopener ugc nofollow" target="_blank">@app</a>.route('/', methods = ['GET','POST'])<br/><a class="ae kx" href="http://twitter.com/app" rel="noopener ugc nofollow" target="_blank">@app</a>.route('/index', methods = ['GET','POST'])<br/>def hello_world():<br/>    <br/>    if forms.RegistrationForm().validate_on_submit():</span><span id="01cf" class="lg jp hh lv b fi md ma l mb mc">        register_form = forms.RegistrationForm()          <br/>        hashed_password =    bcrypt.generate_password_hash(register_form.password.data).decode('utf-8')<br/>        user = User(username = register_form.username.data,<br/>                    email = register_form.email.data,<br/>                    password = hashed_password)</span><span id="e6cf" class="lg jp hh lv b fi md ma l mb mc">        db.session.add(user)<br/>        db.session.commit()</span><span id="0b28" class="lg jp hh lv b fi md ma l mb mc"><strong class="lv hi">        user = User.query.filter_by(<br/>               email = forms.RegistrationForm().email.data).first()<br/>       <br/>        if user and bcrypt.check_password_hash(<br/>        user.password, forms.RegistrationForm().password.data):<br/>           <br/>           login_user(user)</strong></span><span id="94b0" class="lg jp hh lv b fi md ma l mb mc">        return redirect(url_for('hello_world')))</span><span id="f714" class="lg jp hh lv b fi md ma l mb mc">    return render_template('index.html',<br/>                           login_form = forms.LoginForm(),<br/>                           register_form = forms.RegistrationForm())</span></pre><p id="bd87" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">现在，当我们提交注册表单时，我们被重新路由到authenticated视图。</p><figure class="jd je jf jg fd jh er es paragraph-image"><div class="er es mk"><img src="../Images/1c2d001bde5028da76678864b1dafc52.png" data-original-src="https://miro.medium.com/v2/resize:fit:752/format:webp/1*j1J6L0pAtgbqluoQ9i4fnw.png"/></div></figure><p id="2132" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我将逐行解释这一点。如果你不在乎，现在跳到第7步。</p><pre class="jd je jf jg fd lu lv lw lx aw ly bi"><span id="a4a3" class="lg jp hh lv b fi lz ma l mb mc">register_form = forms.RegistrationForm()</span></pre><p id="f34e" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这一行只是将表单文件中的表单类定义为register_form，这样我们就可以在解析表单数据时引用它。你也可以称之为形式。如果您愿意，可以一直使用注册表()。</p><pre class="jd je jf jg fd lu lv lw lx aw ly bi"><span id="03e2" class="lg jp hh lv b fi lz ma l mb mc">hashed_password =    bcrypt.generate_password_hash(register_form.password.data).decode('utf-8')</span></pre><p id="7d74" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这是使用我们在本部分开始时安装的bcrypt扩展从密码字段创建散列密码。具体细节在这里。</p><pre class="jd je jf jg fd lu lv lw lx aw ly bi"><span id="fe1a" class="lg jp hh lv b fi lz ma l mb mc">user = User(username = register_form.username.data,<br/>            email = register_form.email.data,<br/>            password = hashed_password)</span></pre><p id="ba47" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这一行创建了我们的用户类的一个实例。它使用用户提交的register_form中的数据来填充每个字段。</p><pre class="jd je jf jg fd lu lv lw lx aw ly bi"><span id="f93f" class="lg jp hh lv b fi lz ma l mb mc">db.session.add(user)       </span></pre><p id="891c" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这一行将用户类的新实例添加到数据库中。</p><pre class="jd je jf jg fd lu lv lw lx aw ly bi"><span id="0d05" class="lg jp hh lv b fi lz ma l mb mc">db.session.commit()</span></pre><p id="5a1e" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这一行提交了更改。对数据库的每个更改都必须跟在commit()之后。</p><pre class="jd je jf jg fd lu lv lw lx aw ly bi"><span id="c5eb" class="lg jp hh lv b fi lz ma l mb mc">user = User.query.filter_by( email =     <br/>                forms.RegistrationForm().email.data).first()</span></pre><p id="863e" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这一行在数据库中查询我们刚刚创建的用户。我们使用filter_by()和first()方法来获取第一个电子邮件与注册表单中的数据相匹配的用户。由于我们的电子邮件都必须是唯一的，第一个用户将是我们当前的用户。</p><pre class="jd je jf jg fd lu lv lw lx aw ly bi"><span id="328e" class="lg jp hh lv b fi lz ma l mb mc">if user and bcrypt.check_password_hash(user.password, <br/>                            forms.RegistrationForm().password.data):<br/>           <br/>  login_user(user)</span></pre><p id="47d3" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这个块检查用户是否存在，以及我们从数据库中提取的用户密码是否与注册表单中的密码匹配。这当然每次都会匹配，因为我们刚刚创建了这个新用户。然后使用login_user()方法对用户进行身份验证。</p><h2 id="c9ce" class="lg jp hh bd jq lh li lj ju lk ll lm jy ip ln lo kc it lp lq kg ix lr ls kk lt bi translated">第七步。启用注销</h2><p id="4f81" class="pw-post-body-paragraph ie if hh ig b ih ko ij ik il kp in io ip ld ir is it le iv iw ix lf iz ja jb ha bi translated">现在，一旦我们对用户进行了身份验证，我们就无法撤销身份验证并使用不同的帐户登录。</p><p id="9938" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">为了解决这个问题，让我们在已验证的视图中添加一个注销按钮。</p><pre class="jd je jf jg fd lu lv lw lx aw ly bi"><span id="14d1" class="lg jp hh lv b fi lz ma l mb mc">&lt;form method="post"&gt;<br/>  &lt;input type="hidden" name="csrf_token" value="{{csrf_token()}}"/&gt;<br/>  &lt;input type="hidden" name="post_header" value="log out"&gt;<br/>  &lt;input type="submit"  value="Logout"&gt;<br/>&lt;/form&gt;</span></pre><p id="687a" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">上面的代码是我们的注销按钮。这是一个有3个输入的表单标签。</p><ol class=""><li id="0dd7" class="km kn hh ig b ih ii il im ip mf it mg ix mh jb kt ku kv kw bi translated">隐藏输入与我们的CSRF令牌。我们需要构造不同于前两种形式的令牌，因为我们没有为这种形式创建Flask Form类。不需要form类，因为我们不需要任何验证器。</li><li id="799c" class="km kn hh ig b ih ky il kz ip la it lb ix lc jb kt ku kv kw bi translated">带有文章标题的隐藏输入。这些将在我们的应用程序中使用。这种隐藏输入post标题的风格让我们可以很容易地决定表单提交时在后端做什么。</li><li id="297c" class="km kn hh ig b ih ky il kz ip la it lb ix lc jb kt ku kv kw bi translated">这是我们的可点击按钮，将提交表单。</li></ol><p id="6687" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">接下来，我们需要在index.py文件中添加一些代码来处理来自这个按钮的post请求。因为我们没有这个的flask表单，所以我们不能使用validate_on_submit方法。我们将从隐藏的输入中读取我们的post头。</p><pre class="jd je jf jg fd lu lv lw lx aw ly bi"><span id="3629" class="lg jp hh lv b fi lz ma l mb mc">if (request.method == "POST") &amp; <br/>   (request.form.get('post_header') == 'log out'):</span><span id="be36" class="lg jp hh lv b fi md ma l mb mc">    return redirect(url_for('hello_world'))</span></pre><p id="8cfc" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">最后，我们将在if条件中添加一些代码，以便在表单提交时注销用户。我们只需要从flask_login导入logout_user()方法。</p><pre class="jd je jf jg fd lu lv lw lx aw ly bi"><span id="7b33" class="lg jp hh lv b fi lz ma l mb mc">if (request.method == "POST") &amp; <br/>   (request.form.get('post_header') == 'log out'):<br/>  <br/>   <strong class="lv hi">logout_user()</strong></span><span id="9f86" class="lg jp hh lv b fi md ma l mb mc">   return redirect(url_for('hello_world'))</span></pre><h2 id="e509" class="lg jp hh bd jq lh li lj ju lk ll lm jy ip ln lo kc it lp lq kg ix lr ls kk lt bi translated"><strong class="ak">第八步。启用登录</strong></h2><p id="65f0" class="pw-post-body-paragraph ie if hh ig b ih ko ij ik il kp in io ip ld ir is it le iv iw ix lf iz ja jb ha bi translated">你会注意到，如果你再次尝试用相同的用户名或密码注册，将会出错。这是因为我们在创建用户数据库对象时创建了这些唯一的值。</p><p id="83c8" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">所以我们还需要一个表单来登录现有用户。让我们将它添加到我们的模板&gt;视图&gt;未认证的. html文件中。</p><pre class="jd je jf jg fd lu lv lw lx aw ly bi"><span id="94ad" class="lg jp hh lv b fi lz ma l mb mc">&lt;form method="POST" action=""&gt;<br/>  {{ register_form.hidden_tag() }}<br/>    {{ register_form.username( placeholder = "Username") }}<br/>    {{ register_form.email( placeholder = "Email") }}<br/>    {{ register_form.password( placeholder = "Password") }}<br/>    {{ register_form.confirm_password( placeholder = "Confirm Password") }}<br/>    {{ register_form.submit() }}<br/>&lt;/form&gt;</span><span id="9c83" class="lg jp hh lv b fi md ma l mb mc"><strong class="lv hi">&lt;form method="POST" action=""&gt;<br/>  {{ login_form.hidden_tag() }}<br/>    {{ login_form.email(placeholder = "Email") }}<br/>    {{ login_form.password(placeholder = "Password") }}<br/>    {{ login_form.submit() }}<br/>&lt;/form&gt;</strong></span></pre><p id="1ccc" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这个表单标签的构建方式与我们的注册表单相同，只是使用了login_form类。</p><p id="a71c" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">现在，当我们未登录时，我们的网页将如下所示:</p><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="ji jj di jk bf jl"><div class="er es ml"><img src="../Images/aa9b2e25a5687857046907c5edc33242.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ohamBQ-bLrkAdzZTfuP9rA.png"/></div></div></figure><p id="00c0" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">现在点击登录没有任何作用。这是因为当我们的登录表单类验证时，我们还没有配置我们的后端来做任何事情。因此，我们需要向index.py文件添加一些代码，类似于我们对注册表单所做的那样。</p><pre class="jd je jf jg fd lu lv lw lx aw ly bi"><span id="43b6" class="lg jp hh lv b fi lz ma l mb mc"><a class="ae kx" href="http://twitter.com/app" rel="noopener ugc nofollow" target="_blank">@app</a>.route('/', methods = ['GET','POST'])<br/><a class="ae kx" href="http://twitter.com/app" rel="noopener ugc nofollow" target="_blank">@app</a>.route('/index', methods = ['GET','POST'])<br/>def hello_world():</span><span id="a377" class="lg jp hh lv b fi md ma l mb mc">    if forms.RegistrationForm().validate_on_submit():<br/>    <br/>        register_form = forms.RegistrationForm()<br/>        hashed_password = bcrypt.generate_password_hash(register_form.password.data).decode('utf-8')<br/>        user = User(username = register_form.username.data,<br/>                    email = register_form.email.data,<br/>                    password = hashed_password)<br/>        db.session.add(user)<br/>        db.session.commit()<br/> <br/>        user = User.query.filter_by(email =  <br/>               forms.RegistrationForm().email.data).first()</span><span id="b931" class="lg jp hh lv b fi md ma l mb mc">        if user and bcrypt.check_password_hash(user.password,        <br/>           forms.RegistrationForm().password.data):</span><span id="2b3e" class="lg jp hh lv b fi md ma l mb mc">            login_user(user)</span><span id="5bc2" class="lg jp hh lv b fi md ma l mb mc">        return redirect(url_for('hello_world'))</span><span id="7662" class="lg jp hh lv b fi md ma l mb mc"><strong class="lv hi">    if forms.LoginForm().validate_on_submit():<br/>        <br/>        login_form = forms.LoginForm()<br/>        user = User.query.filter_by(email =  <br/>               login_form.email.data).first()<br/>        <br/>        if user and bcrypt.check_password_hash(user.password, <br/>           login_form.password.data):<br/>            <br/>            login_user(user, remember = login_form.remember.data)<br/>            <br/>        return redirect(url_for('hello_world'))</strong></span><span id="e303" class="lg jp hh lv b fi md ma l mb mc">    return render_template('index.html',<br/>                           login_form = forms.LoginForm(),<br/>                           register_form = forms.RegistrationForm())</span></pre><p id="2d0d" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">现在，使用与您创建的帐户相匹配的电子邮件和密码登录，您将进入已验证视图。</p><p id="e6c6" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">如果您不关心或者已经知道当登录表单提交时我们的python代码在做什么，那么您就完成了第5部分！如果你感兴趣，我会在下面一行一行地把它分解。</p><pre class="jd je jf jg fd lu lv lw lx aw ly bi"><span id="10f9" class="lg jp hh lv b fi lz ma l mb mc">if forms.LoginForm().validate_on_submit():</span></pre><p id="febe" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这是我们使用之前见过的validate_on_sbmit()方法来检查登录表单是否正在提交，以及在post请求期间是否有效。</p><pre class="jd je jf jg fd lu lv lw lx aw ly bi"><span id="32b6" class="lg jp hh lv b fi lz ma l mb mc">login_form = forms.LoginForm()</span></pre><p id="7ecb" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这只是从我们导入的表单文件中获取我们的登录表单。我们也可以继续把它称为表单。LoginForm，但是我发现那看起来很乱。</p><pre class="jd je jf jg fd lu lv lw lx aw ly bi"><span id="ef51" class="lg jp hh lv b fi lz ma l mb mc">user = User.query.filter_by(email = login_form.email.data).first()</span></pre><p id="ed01" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这是查询我们的数据库，并从数据库中获取与登录表单中提交的电子邮件相匹配的用户对象。</p><pre class="jd je jf jg fd lu lv lw lx aw ly bi"><span id="7132" class="lg jp hh lv b fi lz ma l mb mc">if user and bcrypt.check_password_hash(user.password,   <br/>                                       login_form.password.data):</span></pre><p id="0e91" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这是使用我们的bcrpyt包来检查存储在我们的用户对象上的密码是否与登录表单上提供的密码匹配。</p><pre class="jd je jf jg fd lu lv lw lx aw ly bi"><span id="d81c" class="lg jp hh lv b fi lz ma l mb mc">login_user(user, remember = login_form.remember.data)</span></pre><p id="d247" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这是使用我们的login_user方法在我们的登录管理器中更改我们的用户状态。这里的第二个参数是可选的。这将使浏览器记住用于登录的用户名和密码。要避免这种行为，您可以使用:</p><pre class="jd je jf jg fd lu lv lw lx aw ly bi"><span id="8e9f" class="lg jp hh lv b fi lz ma l mb mc">login_user(user)</span></pre><p id="630e" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">最后，</p><pre class="jd je jf jg fd lu lv lw lx aw ly bi"><span id="ea9e" class="lg jp hh lv b fi lz ma l mb mc">return redirect(url_for('hello_world'))</span></pre><p id="7fb8" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">将我们带到我们的主要“hello_world”路线。</p><p id="2515" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">第五部到此结束！这部分的源代码可以在我的GitHub <a class="ae kx" href="https://github.com/shawnhymers/FlaskApp/tree/Part-5" rel="noopener ugc nofollow" target="_blank">这里找到:</a></p><p id="795d" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在下一部分中，我们将创建一个新的数据库对象，并升级我们的应用程序，使其具有完整的CRUD(创建、读取、更新、删除)功能。</p></div></div>    
</body>
</html>