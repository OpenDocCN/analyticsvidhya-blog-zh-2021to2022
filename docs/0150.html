<html>
<head>
<title>Understanding SQL Window Functions</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">了解SQL窗口函数</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/understanding-sql-window-functions-32f21dba483d?source=collection_archive---------13-----------------------#2021-01-06">https://medium.com/analytics-vidhya/understanding-sql-window-functions-32f21dba483d?source=collection_archive---------13-----------------------#2021-01-06</a></blockquote><div><div class="es gk gl gm gn go"/><div class="gp gq gr gs gt"><div class=""/><p id="4d46" class="pw-post-body-paragraph ht hu gw hv b hw hx hy hz ia ib ic id ie if ig ih ii ij ik il im in io ip iq gp bi translated">SQL中的窗口函数为数据工程师提供了一个机会窗口，通过将SQL查询快速连接到业务计算，可以最大限度地减少工作量和时间。RDBMS中的窗口函数可以顺利地解决使用基本SQL查询难以解决的关键问题。窗口功能包括-</p><p id="1d84" class="pw-post-body-paragraph ht hu gw hv b hw hx hy hz ia ib ic id ie if ig ih ii ij ik il im in io ip iq gp bi translated">a)函数名，如<strong class="hv gx"> sum、avg、min、max、lead、lag、row_no、rank、dense_rank、ntile等。</strong></p><p id="1bdb" class="pw-post-body-paragraph ht hu gw hv b hw hx hy hz ia ib ic id ie if ig ih ii ij ik il im in io ip iq gp bi translated">b) <strong class="hv gx"> Over子句</strong>和within over子句是使用像<strong class="hv gx"> partition by、order by和行或行之间的范围这样的子句指定计算框架的地方。</strong></p><p id="d3bd" class="pw-post-body-paragraph ht hu gw hv b hw hx hy hz ia ib ic id ie if ig ih ii ij ik il im in io ip iq gp bi translated">c) <strong class="hv gx">分配给最终计算帧的别名</strong>。</p><p id="3942" class="pw-post-body-paragraph ht hu gw hv b hw hx hy hz ia ib ic id ie if ig ih ii ij ik il im in io ip iq gp bi translated">语法:<strong class="hv gx"> Window_Function_Name(参数)Over(Window _ Frame)AS Alias _ Name</strong></p><figure class="is it iu iv ek iw dy dz paragraph-image"><div class="dy dz ir"><img src="../Images/353d6557a7c23cfa87604c6f8062b1a6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1022/format:webp/1*QXO5QeCTJpPeQyQWAvDgQg.png"/></div><figcaption class="iz ja ea dy dz jb jc bd b be z ft translated"><strong class="bd jd">窗口功能的通用语法</strong></figcaption></figure><p id="c0cf" class="pw-post-body-paragraph ht hu gw hv b hw hx hy hz ia ib ic id ie if ig ih ii ij ik il im in io ip iq gp bi translated">下面我将带你浏览一些最常用的SQL窗口函数的概念和例子。</p></div><div class="ab cl je jf gd jg" role="separator"><span class="jh bw bk ji jj jk"/><span class="jh bw bk ji jj jk"/><span class="jh bw bk ji jj"/></div><div class="gp gq gr gs gt"><h2 id="ce9c" class="jl jm gw bd jd jn jo jp jq jr js jt ju ie jv jw jx ii jy jz ka im kb kc kd ke bi translated"><strong class="ak">考虑下面表格中两个部门“财务”和“销售”的5名员工及其相应的年龄和工资详细信息。</strong></h2><figure class="is it iu iv ek iw dy dz paragraph-image"><div role="button" tabindex="0" class="kg kh di ki bf kj"><div class="dy dz kf"><img src="../Images/2ea9a4e4ca54f87c59b6db54cddee6c3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Rr9maItXOM8KbfQdaCfDrw.png"/></div></div><figcaption class="iz ja ea dy dz jb jc bd b be z ft translated">员工表</figcaption></figure><p id="bc46" class="pw-post-body-paragraph ht hu gw hv b hw hx hy hz ia ib ic id ie if ig ih ii ij ik il im in io ip iq gp bi translated"><strong class="hv gx">例1:计算员工所在部门的最高工资</strong></p><p id="08a5" class="pw-post-body-paragraph ht hu gw hv b hw hx hy hz ia ib ic id ie if ig ih ii ij ik il im in io ip iq gp bi translated">现在，我们可以将上面计算的基本SQL写成—</p><figure class="is it iu iv ek iw dy dz paragraph-image"><div role="button" tabindex="0" class="kg kh di ki bf kj"><div class="dy dz kk"><img src="../Images/09a59ff5bf5a53360f32ef10a966e428.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wrq1-Jrc1RPdM7ZaVSaB8Q.png"/></div></div><figcaption class="iz ja ea dy dz jb jc bd b be z ft translated">使用基本SQL计算<strong class="bd jd">最大值</strong></figcaption></figure><p id="bfd1" class="pw-post-body-paragraph ht hu gw hv b hw hx hy hz ia ib ic id ie if ig ih ii ij ik il im in io ip iq gp bi translated">如果我们希望在一行中显示每个员工的最高工资，该怎么办？同样有两种方法——使用<strong class="hv gx"> join </strong>或<strong class="hv gx"> window function </strong>。使用<strong class="hv gx"> join </strong>可能会很棘手并且消耗内存，而<strong class="hv gx">窗口函数</strong>可以很容易地解决这个问题。</p><figure class="is it iu iv ek iw dy dz paragraph-image"><div role="button" tabindex="0" class="kg kh di ki bf kj"><div class="dy dz kl"><img src="../Images/1eab0e714bac1dd0221a1e2db5e82e74.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wycsInI3VDkkpW6uefr8OA.png"/></div></div><figcaption class="iz ja ea dy dz jb jc bd b be z ft translated">使用窗口函数计算<strong class="bd jd">最大值</strong></figcaption></figure><p id="d24d" class="pw-post-body-paragraph ht hu gw hv b hw hx hy hz ia ib ic id ie if ig ih ii ij ik il im in io ip iq gp bi translated"><strong class="hv gx">解释:</strong></p><ol class=""><li id="f233" class="km kn gw hv b hw hx ia ib ie ko ii kp im kq iq kr ks kt ku bi translated">员工表被解雇。</li><li id="6b40" class="km kn gw hv b hw kv ia kw ie kx ii ky im kz iq kr ks kt ku bi translated">财务和销售部门创建了两个分区。</li><li id="dd8b" class="km kn gw hv b hw kv ia kw ie kx ii ky im kz iq kr ks kt ku bi translated">在每个分区中，按薪水降序排序。</li><li id="3ead" class="km kn gw hv b hw kv ia kw ie kx ii ky im kz iq kr ks kt ku bi translated">如果未提及，则默认情况下，范围被视为无界的前一行和当前行。<em class="la">前面无界表示当前行以上的所有行，后面无界表示当前行以下的所有行</em>。还有其他范围的组合，比如—</li></ol><p id="eb05" class="pw-post-body-paragraph ht hu gw hv b hw hx hy hz ia ib ic id ie if ig ih ii ij ik il im in io ip iq gp bi translated"><em class="la">前无界与后无界之间的行数<br/>当前行与后无界之间的行数<br/>前n行与后n行之间的行数<br/>前n行与当前行之间的行数<br/>当前行与后n行之间的行数</em></p><p id="e0a8" class="pw-post-body-paragraph ht hu gw hv b hw hx hy hz ia ib ic id ie if ig ih ii ij ik il im in io ip iq gp bi translated">其中<strong class="hv gx"> n </strong>是帧中前面或下面的行数。根据需要使用它们。</p><p id="78a7" class="pw-post-body-paragraph ht hu gw hv b hw hx hy hz ia ib ic id ie if ig ih ii ij ik il im in io ip iq gp bi translated">5.Max是为每个分区从over子句中获得的数据框行计算的。</p><p id="b38b" class="pw-post-body-paragraph ht hu gw hv b hw hx hy hz ia ib ic id ie if ig ih ii ij ik il im in io ip iq gp bi translated">6.最后完成行的选择。</p><p id="59ac" class="pw-post-body-paragraph ht hu gw hv b hw hx hy hz ia ib ic id ie if ig ih ii ij ik il im in io ip iq gp bi translated"><strong class="hv gx">例2:计算员工表</strong>中所有员工的工资总额</p><figure class="is it iu iv ek iw dy dz paragraph-image"><div role="button" tabindex="0" class="kg kh di ki bf kj"><div class="dy dz lb"><img src="../Images/998ef4ad8f828a61e3da74af4e278ff8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8-7gcOQ5CroLb6vIoGo3RA.png"/></div></div><figcaption class="iz ja ea dy dz jb jc bd b be z ft translated">所有员工的工资总额</figcaption></figure><p id="9d91" class="pw-post-body-paragraph ht hu gw hv b hw hx hy hz ia ib ic id ie if ig ih ii ij ik il im in io ip iq gp bi translated"><strong class="hv gx">说明:</strong></p><ol class=""><li id="320d" class="km kn gw hv b hw hx ia ib ie ko ii kp im kq iq kr ks kt ku bi translated">员工表被解雇。</li><li id="bf75" class="km kn gw hv b hw kv ia kw ie kx ii ky im kz iq kr ks kt ku bi translated">读取Over子句，如果over子句中没有提及任何内容，它将作用于表中的所有行。</li><li id="36e5" class="km kn gw hv b hw kv ia kw ie kx ii ky im kz iq kr ks kt ku bi translated">计算所有行的总和。</li><li id="14ee" class="km kn gw hv b hw kv ia kw ie kx ii ky im kz iq kr ks kt ku bi translated">列的选择已完成。</li></ol><p id="e06b" class="pw-post-body-paragraph ht hu gw hv b hw hx hy hz ia ib ic id ie if ig ih ii ij ik il im in io ip iq gp bi translated"><strong class="hv gx">例3:计算每个员工的累计总数</strong></p><figure class="is it iu iv ek iw dy dz paragraph-image"><div role="button" tabindex="0" class="kg kh di ki bf kj"><div class="dy dz lc"><img src="../Images/582ff115ea1a6673a42d4aef1d741a0f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vSNrSO4gQt5KKHX7MMmD7Q.png"/></div></div><figcaption class="iz ja ea dy dz jb jc bd b be z ft translated">每个雇员的累计。</figcaption></figure><p id="3767" class="pw-post-body-paragraph ht hu gw hv b hw hx hy hz ia ib ic id ie if ig ih ii ij ik il im in io ip iq gp bi translated"><strong class="hv gx">注意:</strong>order by一放入over子句，默认范围就进入每行的画面。默认情况下，在over子句中，范围在前面的行和当前的行之间是无界的。其余说明与例2相同。</p><p id="4033" class="pw-post-body-paragraph ht hu gw hv b hw hx hy hz ia ib ic id ie if ig ih ii ij ik il im in io ip iq gp bi translated"><strong class="hv gx">例4:对各部门薪资最高的员工进行排名</strong></p><p id="42d7" class="pw-post-body-paragraph ht hu gw hv b hw hx hy hz ia ib ic id ie if ig ih ii ij ik il im in io ip iq gp bi translated">SQL有3个排名函数<strong class="hv gx"> row_number </strong>、<strong class="hv gx"> rank </strong>和<strong class="hv gx"> dense_rank </strong>。为了更好地理解，下面是所有3个的结果集。</p><p id="b06c" class="pw-post-body-paragraph ht hu gw hv b hw hx hy hz ia ib ic id ie if ig ih ii ij ik il im in io ip iq gp bi translated"><strong class="hv gx">步骤1 </strong> : <em class="la">让我们使用这些函数对员工进行排名。</em></p><figure class="is it iu iv ek iw dy dz paragraph-image"><div role="button" tabindex="0" class="kg kh di ki bf kj"><div class="dy dz ld"><img src="../Images/626e3e54f5bcdc9f0b74261d6f075cd9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*K8Qu8fnzR5HYTq31egl1RQ.png"/></div></div><figcaption class="iz ja ea dy dz jb jc bd b be z ft translated">员工排名</figcaption></figure><p id="da7e" class="pw-post-body-paragraph ht hu gw hv b hw hx hy hz ia ib ic id ie if ig ih ii ij ik il im in io ip iq gp bi translated"><strong class="hv gx">第二步</strong> : <em class="la">过滤掉排名最高的。由于两个雇员(Ramesh和Suresh)的最高工资相同，我们不能使用row_number，因为它给了他们不同的数字，所以我们将使用rank或dense_rank来获得这些雇员。</em></p><figure class="is it iu iv ek iw dy dz paragraph-image"><div role="button" tabindex="0" class="kg kh di ki bf kj"><div class="dy dz le"><img src="../Images/7171ab93ec85f9f4cd53890820e1820e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xXtfWcKEnceR7gKL9uSN0A.png"/></div></div><figcaption class="iz ja ea dy dz jb jc bd b be z ft translated">最高等级</figcaption></figure><p id="0d90" class="pw-post-body-paragraph ht hu gw hv b hw hx hy hz ia ib ic id ie if ig ih ii ij ik il im in io ip iq gp bi translated">正如我们所见，拉梅什、苏雷什和迪普在这三个部门的薪水最高。</p><p id="4269" class="pw-post-body-paragraph ht hu gw hv b hw hx hy hz ia ib ic id ie if ig ih ii ij ik il im in io ip iq gp bi translated"><strong class="hv gx">例5: </strong> <em class="la">计算各部门员工表中第二高的薪资。</em></p><p id="36cf" class="pw-post-body-paragraph ht hu gw hv b hw hx hy hz ia ib ic id ie if ig ih ii ij ik il im in io ip iq gp bi translated">现在这是一个棘手的问题，我们知道我们有3个排名函数，但使用哪一个来获得第二高。让我们看看Ex4步骤1的结果集，似乎dense_rank是更好的函数。</p><p id="1d02" class="pw-post-body-paragraph ht hu gw hv b hw hx hy hz ia ib ic id ie if ig ih ii ij ik il im in io ip iq gp bi translated"><strong class="hv gx">第一步</strong> : <em class="la">计算每个部门的dense _ rank</em>。</p><figure class="is it iu iv ek iw dy dz paragraph-image"><div role="button" tabindex="0" class="kg kh di ki bf kj"><div class="dy dz lf"><img src="../Images/a014201e25f2e16e9c711d10e21ae0cf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LzDMGSqgnhUR7NXZhn4L4A.png"/></div></div></figure><p id="6cf3" class="pw-post-body-paragraph ht hu gw hv b hw hx hy hz ia ib ic id ie if ig ih ii ij ik il im in io ip iq gp bi translated"><strong class="hv gx">第二步</strong> : <em class="la">过滤掉dense_rank 2 </em>的员工。</p><figure class="is it iu iv ek iw dy dz paragraph-image"><div role="button" tabindex="0" class="kg kh di ki bf kj"><div class="dy dz lg"><img src="../Images/8fe3e0b79047384cf8931e6e00f3c666.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KFBL92k-lw3P4r7_kctI4Q.png"/></div></div><figcaption class="iz ja ea dy dz jb jc bd b be z ft translated">第二高的薪水</figcaption></figure><p id="7e80" class="pw-post-body-paragraph ht hu gw hv b hw hx hy hz ia ib ic id ie if ig ih ii ij ik il im in io ip iq gp bi translated">我们可以看到，在员工表中，拉姆和帕拉德普的工资在各部门中排名第二。</p><p id="dd9d" class="pw-post-body-paragraph ht hu gw hv b hw hx hy hz ia ib ic id ie if ig ih ii ij ik il im in io ip iq gp bi translated">通过这些例子，我们可以观察到窗口函数是如何轻松地解决业务所需的各种任务的。</p><p id="e283" class="pw-post-body-paragraph ht hu gw hv b hw hx hy hz ia ib ic id ie if ig ih ii ij ik il im in io ip iq gp bi translated">暂时就这些了。希望你喜欢阅读。</p></div></div>    
</body>
</html>