<html>
<head>
<title>Spark streaming output modes</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">火花流输出模式</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/spark-streaming-output-modes-600c689b6bf9?source=collection_archive---------0-----------------------#2021-10-24">https://medium.com/analytics-vidhya/spark-streaming-output-modes-600c689b6bf9?source=collection_archive---------0-----------------------#2021-10-24</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div class="er es if"><img src="../Images/a91093c7d95d108b57f32d4c461a4396.png" data-original-src="https://miro.medium.com/v2/resize:fit:780/format:webp/0*VJh2S2gupfwFhi28.png"/></div><figcaption class="im in et er es io ip bd b be z dx translated">火花流</figcaption></figure><p id="d286" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">Apache Spark Streaming支持对来自kafka等数据源的数据流进行流处理，并将它们推送到filesystem等接收器。在这篇博客中，我们将关注spark流的输出模式。</p><p id="8243" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">输出模式决定了如何处理数据并将其推送到接收器。有三种输出模式:</p><p id="dfd8" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">追加模式:</strong></p><p id="d8ad" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">它只将新的传入数据写入接收器。因此，当只需要插入新数据而不需要更新以前的数据状态时，可以使用这种方法。这是默认的输出模式。它不支持聚合操作，因为聚合依赖于旧数据。</p><p id="2bbd" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">下面是一个使用案例示例:</p><p id="672f" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们正在流式传输用户的注册数据。每当用户在网站上注册时，就会有一个事件被推送到kafka。这个事件被spark流读取并放入结果表，结果表可以被sink读取。</p><p id="cb33" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">假设用户A、B和C注册，他们的事件在同一个批处理中处理。数据输出到结果表中，如下所示。</p><figure class="jp jq jr js fd ij er es paragraph-image"><div role="button" tabindex="0" class="jt ju di jv bf jw"><div class="er es jo"><img src="../Images/b33b61c627487dc75a962026fe6c80e5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2zSx8THmMqCZ2jBqWEBztQ.png"/></div></div><figcaption class="im in et er es io ip bd b be z dx translated">追加模式—第一批</figcaption></figure><p id="ca16" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">稍后，当用户D和E注册并且他们的事件在一个间隔之后被触发的下一批中被处理时，只有这些新事件被输出到结果表中。</p><figure class="jp jq jr js fd ij er es paragraph-image"><div role="button" tabindex="0" class="jt ju di jv bf jw"><div class="er es jx"><img src="../Images/de562115f7139c80d70789368764fdb0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nkeq869CRtoO2FBxLzTnAQ.png"/></div></div><figcaption class="im in et er es io ip bd b be z dx translated">附加模式—第二批</figcaption></figure><p id="6c58" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如我们所见，在这一批中写入的数据不涉及涉及用户A、B和c的旧数据。</p><p id="b966" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">但是，当应用水印时，聚合可以在事件时间列上发生。只有在水印时间过去后才会写入结果。</p><p id="e56e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">更新模式:</strong></p><p id="f57e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">它包括写入新的或旧值被更新的数据记录。因此，当需要使用“上插”操作模式进行某些聚合时，可以使用这种模式。如果没有应用聚合，更新模式与追加模式的工作方式相同。</p><p id="a2fa" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">下面是一个使用案例示例:</p><p id="c809" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们想分析网站上的订婚。因此，每当用户在网站上进行一些特定的交互时，就会有一个事件被推送到kafka。Spark streaming从kafka读取数据，汇总每个用户的交互次数，并输出到结果表。</p><p id="3f37" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在这个用例中，假设我们只想为当前批处理中有交互的用户输出数据。输出模式必须设置为“更新”。</p><p id="00f1" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在第一批中，用户A在网站上进行了2次交互，用户B在网站上进行了1次交互。该批用户的交互计数数据输出如下:</p><figure class="jp jq jr js fd ij er es paragraph-image"><div role="button" tabindex="0" class="jt ju di jv bf jw"><div class="er es jy"><img src="../Images/371a67a7afb60f52da383641cb51ca2a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WY_owr777iTZCd_clHT71g.png"/></div></div><figcaption class="im in et er es io ip bd b be z dx translated">更新模式—第一批</figcaption></figure><p id="09ca" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在第二批中，用户B在网站上进行了2次交互，用户C在网站上进行了5次交互。该批用户的交互计数数据输出如下:</p><figure class="jp jq jr js fd ij er es paragraph-image"><div role="button" tabindex="0" class="jt ju di jv bf jw"><div class="er es jz"><img src="../Images/c44172e5a9ad587b4f2e92d98d4e3b48.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Vm_aezABy6K8GH47SBLJmw.png"/></div></div><figcaption class="im in et er es io ip bd b be z dx translated">更新模式—第二批</figcaption></figure><p id="2b7f" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">正如我们所看到的，在第二批中写入的数据没有来自用户A的数据。这是因为来自用户A的交互事件没有在第二批中出现。</p><p id="d1c6" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如果应用水印，经过水印时间的数据的旧状态将被清除。</p><p id="fef3" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">完成模式:</strong></p><p id="bd29" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">它包括再次写入完整的数据。这意味着每次将全部数据写入结果表时。因此，当需要覆盖所有以前的数据时，可以使用这种模式。仅当应用聚合时，才能使用此模式。</p><p id="4dcd" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">让我们以更新模式中使用的相同示例为例。需求的变化是，我们希望为所有有交互的用户输出数据；而不仅仅是当前批次中的用户。</p><p id="ccc1" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在第一批中，用户A在网站上进行了2次交互，用户B在网站上进行了1次交互。该批用户的交互计数数据输出如下:</p><figure class="jp jq jr js fd ij er es paragraph-image"><div role="button" tabindex="0" class="jt ju di jv bf jw"><div class="er es ka"><img src="../Images/4655d53f2708a0987e5354611e25ffd2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Tfwjau9B7rbuTpVpHwvA1A.png"/></div></div><figcaption class="im in et er es io ip bd b be z dx translated">完整模式—第一批</figcaption></figure><p id="0008" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在第二批中，用户B在网站上进行了2次交互，用户C在网站上进行了5次交互。该批用户的交互计数数据输出如下:</p><figure class="jp jq jr js fd ij er es paragraph-image"><div role="button" tabindex="0" class="jt ju di jv bf jw"><div class="er es kb"><img src="../Images/e0e282eca9964acafa7acdd376e32e8c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*EHnP9v60MQIrx7L1dhsFXQ.png"/></div></div><figcaption class="im in et er es io ip bd b be z dx translated">完整模式—第二批</figcaption></figure><p id="9f7e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">正如我们所看到的，在第二批中写入的数据也包含来自用户A的数据，因为所有数据都写入了每一批。</p><p id="582c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">感谢阅读！</p><p id="72c7" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">参考文献</strong>:</p><p id="76a5" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><a class="ae kc" href="https://spark.apache.org/docs/latest/structured-streaming-programming-guide.html" rel="noopener ugc nofollow" target="_blank">星火流媒体文件</a></p></div></div>    
</body>
</html>