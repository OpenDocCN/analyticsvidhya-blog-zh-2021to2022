<html>
<head>
<title>Jenkins at scale</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">詹金斯秤</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/jenkins-at-scale-ff960e242dc9?source=collection_archive---------34-----------------------#2021-01-17">https://medium.com/analytics-vidhya/jenkins-at-scale-ff960e242dc9?source=collection_archive---------34-----------------------#2021-01-17</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="913a" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">2021年1月16日</p><figure class="jd je jf jg fd jh er es paragraph-image"><div class="er es jc"><img src="../Images/772e30cbd91f8094b126a7ec92cd0e6d.png" data-original-src="https://miro.medium.com/v2/resize:fit:318/format:webp/0*s2GQVdkq5ogmKEQx.png"/></div></figure><p id="9b78" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">(<em class="jk">原载于</em>【https://ish-ar.io/jenkins-at-scale/】<em class="jk"><a class="ae jl" href="https://ish-ar.io/jenkins-at-scale/" rel="noopener ugc nofollow" target="_blank">)</a></em></p><h1 id="61e1" class="jm jn hh bd jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj bi translated">介绍</h1><p id="d29d" class="pw-post-body-paragraph ie if hh ig b ih kk ij ik il kl in io ip km ir is it kn iv iw ix ko iz ja jb ha bi translated">本文介绍了一个大规模运行基于CI/CD Jenkins平台的解决方案。<br/>要大规模部署和管理Jenkins，自动化至关重要。更重要的是，自动化应该帮助你，而不是让你的生活更困难。对于詹金斯来说，自动化整个设置可能是痛苦的；通常，工程师会创建一些简单的解决方案，或者按照手动步骤让它“正常运行”。<br/>显然，我们希望尽可能避免这些情况。</p><h1 id="4c9c" class="jm jn hh bd jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj bi translated">原则</h1><p id="c15b" class="pw-post-body-paragraph ie if hh ig b ih kk ij ik il kl in io ip km ir is it kn iv iw ix ko iz ja jb ha bi translated">当我想到创建一个具有弹性和可伸缩性的CI/CD平台时，我决定列出一些我希望在实现过程中遵循的原则/要求。</p><p id="9149" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">要求:</p><ul class=""><li id="cbc3" class="kp kq hh ig b ih ii il im ip kr it ks ix kt jb ku kv kw kx bi translated">平台的供应应该尽可能简单和快速。</li><li id="0cdc" class="kp kq hh ig b ih ky il kz ip la it lb ix lc jb ku kv kw kx bi translated">自动处理多个微型平台比超级平台更好。</li><li id="253e" class="kp kq hh ig b ih ky il kz ip la it lb ix lc jb ku kv kw kx bi translated">应将管道定义为代码并进行测试。</li><li id="3207" class="kp kq hh ig b ih ky il kz ip la it lb ix lc jb ku kv kw kx bi translated">CI/CD平台基础设施应该被定义为代码并被自动测试。</li><li id="0fbe" class="kp kq hh ig b ih ky il kz ip la it lb ix lc jb ku kv kw kx bi translated">CI/CD平台必须安全。</li><li id="ba4c" class="kp kq hh ig b ih ky il kz ip la it lb ix lc jb ku kv kw kx bi translated">工程师应该乐于打破常规，因为他们知道他们总是可以回滚/重新配置整个堆栈。</li><li id="1214" class="kp kq hh ig b ih ky il kz ip la it lb ix lc jb ku kv kw kx bi translated">CI/CD平台必须导出关于自身的指标，工程师应该使用这些指标来做出决策。</li></ul><p id="afe4" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">现在，所有这些方面可能看起来非常高级，事实上，他们是，但最好从我们想要什么的清晰想法开始，然后设计“如何执行”。</p><h1 id="ad19" class="jm jn hh bd jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj bi translated">演示</h1><p id="b8b5" class="pw-post-body-paragraph ie if hh ig b ih kk ij ik il kl in io ip km ir is it kn iv iw ix ko iz ja jb ha bi translated">对于本文，我创建了一个小的<a class="ae jl" href="https://github.com/ish-xyz/jenkins-aws-platform" rel="noopener ugc nofollow" target="_blank">演示</a>来说明如何在AWS上自动配置Jenkins并进行大规模管理。在这一部分，我将讨论在演示中所采取的决策和实现的工具。<br/>虽然演示并不代表生产就绪平台，但这是一个很好的起点，它展示了有用的良好Jenkins特性和最佳实践。<br/>在开发演示时，我遵循了上面列出的要求，尽管我没有实现所有的要求。</p><h1 id="7c08" class="jm jn hh bd jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj bi translated">詹金斯组件</h1><p id="e4b8" class="pw-post-body-paragraph ie if hh ig b ih kk ij ik il kl in io ip km ir is it kn iv iw ix ko iz ja jb ha bi translated">先说詹金斯高层组件。我们可以说，詹金斯有两大类组成部分:主和代理。<br/><strong class="ig hi">代理</strong>(也称为构建机器)负责运行我们的管道。<br/>而<strong class="ig hi">詹金斯大师</strong>则负责:编排、用户管理、认证、授权、插件管理以及许多其他事情。<br/>基础设施的这两个部分的设置可能非常标准，也可能非常复杂。然而，我今天要向您展示的内容将为您提供自动化整个Jenkins设置的基础，并允许您大规模运行它，无论设置有多复杂。</p><h1 id="16da" class="jm jn hh bd jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj bi translated">履行</h1><p id="7243" class="pw-post-body-paragraph ie if hh ig b ih kk ij ik il kl in io ip km ir is it kn iv iw ix ko iz ja jb ha bi translated">让我们来谈谈我在我创建的<a class="ae jl" href="https://github.com/ish-xyz/jenkins-aws-platform" rel="noopener ugc nofollow" target="_blank"> Jenkins at scale demo </a>上使用的工具。</p><p id="f385" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">(<strong class="ig hi">小免责声明</strong>:我知道在Kubernetes上有很多关于如何自动化Jenkins设置的例子。然而，我觉得没有一个真正的“用例/场景”来说明如何在AWS实例上部署它)</p><p id="fb59" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi">阿米族创建</strong></p><p id="6287" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这里使用的方法是“不可变的基础设施”简而言之，我们将创建预先安装了软件的ami并进行部署，而不是提供EC2实例并在以后进行配置。<br/>使用不可变的基础设施将有助于我们的一致性和部署时间(除了我今天不打算讨论的许多其他优势之外)。</p><p id="6a04" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">为了创建ami，我决定使用Packer + Ansible。打包机的工作原理如下:</p><ol class=""><li id="40ef" class="kp kq hh ig b ih ii il im ip kr it ks ix kt jb ld kv kw kx bi translated">Packer将从源AMI创建一个临时EC2实例(在名为<a class="ae jl" href="https://github.com/ish-xyz/jenkins-aws-platform/blob/1/images/master/packer.json#L4" rel="noopener ugc nofollow" target="_blank"> packer.json </a>的文件中定义)</li><li id="54dd" class="kp kq hh ig b ih ky il kz ip la it lb ix lc jb ld kv kw kx bi translated">然后它将连接到实例(通过ssh)并运行Ansible</li><li id="223d" class="kp kq hh ig b ih ky il kz ip la it lb ix lc jb ld kv kw kx bi translated">然后Packer会将配置的实例保存为一个新的AMI，并将一些元数据输出到一个名为<a class="ae jl" href="https://github.com/ish-xyz/jenkins-aws-platform/blob/1/images/agents/default/manifest.json" rel="noopener ugc nofollow" target="_blank"> manifest.json. </a>的文件中</li></ol><p id="4dc2" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi"> JENKINS主机和作业供应/配置</strong></p><p id="5cdf" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">让我们先关注詹金斯大师。</p><p id="846a" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">现在我们已经有了Packer，它创建了一个带有Jenkins的AMI，并且已经安装了它的插件，对于我们来说…我们如何配置Jenkins呢？</p><p id="024b" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">简单回答:<strong class="ig hi">利用詹金斯CASC！</strong></p><p id="3614" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">詹金斯CASC(配置为代码)是一个插件，可以让你从一个<a class="ae jl" href="https://github.com/ish-xyz/jenkins-aws-platform/blob/1/terraform/templates/jenkins-casc.yaml.tpl" rel="noopener ugc nofollow" target="_blank"> YAML文件</a>中配置整个詹金斯主程序。</p><p id="1fb1" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">通过这个YAML文件，你也可以配置插件设置和<strong class="ig hi">创建任务</strong>。</p><p id="7a61" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这最后一部分对我来说至关重要。为了自动创建Jenkins作业，我使用了一个<strong class="ig hi">种子作业</strong>。种子作业是在CASC配置中定义的特定管道，它为我们创建其他Jenkins作业。</p><p id="c664" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">它是怎么做到的？<strong class="ig hi">使用DSL插件</strong>。(如果你不知道插件是什么，你应该看看这篇文章——&gt;<a class="ae jl" href="https://plugins.jenkins.io/job-dsl/" rel="noopener ugc nofollow" target="_blank">https://plugins.jenkins.io/job-dsl/</a>)</p><p id="d0bb" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">种子作业将下载包含基础设施代码的存储库，并在文件夹<code class="du le lf lg lh b">/jenkins-jobs</code>中提供文件；通过这样做，我们可以将所有的Jenkins工作定义为代码。</p><p id="1a3c" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">要了解种子作业的样子，请查看<a class="ae jl" href="https://github.com/ish-xyz/jenkins-aws-platform/blob/1/terraform/templates/jenkins-casc.yaml.tpl#L84" rel="noopener ugc nofollow" target="_blank"> CASC配置</a>。</p><p id="f4a3" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi">部署</strong></p><p id="cf46" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我们现在有一个Jenkins AMI，一个将配置我们的Jenkins Master的YAML文件，一个将为我们创建管道的种子作业，但是我们如何部署所有这些呢？<br/>在这个<a class="ae jl" href="https://github.com/ish-xyz/jenkins-aws-platform/tree/1" rel="noopener ugc nofollow" target="_blank">演示</a>中，我使用了<a class="ae jl" href="https://terraform.io" rel="noopener ugc nofollow" target="_blank"> Terraform </a>，因为我认为这是目前进行IAC的最佳选择。<br/>通过Terraform，我们将部署整个基础架构+ CASC文件。</p><p id="1015" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><em class="jk">我们通过Terraform而不是Packer部署CASC文件的原因是，它需要仅在供应时可用的元数据。</em></p><p id="32b1" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">具体来说，Terraform将执行以下操作:</p><p id="d8b9" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi">代理商拨备</strong></p><ul class=""><li id="ec03" class="kp kq hh ig b ih ii il im ip kr it ks ix kt jb ku kv kw kx bi translated">创建IAM角色+ IAM策略(这是Jenkins主服务器连接到AWS服务所必需的。例如秘密管理器、EC2等。)</li><li id="8f01" class="kp kq hh ig b ih ky il kz ip la it lb ix lc jb ku kv kw kx bi translated">创建PEM密钥(使用RSA算法)</li><li id="f172" class="kp kq hh ig b ih ky il kz ip la it lb ix lc jb ku kv kw kx bi translated">Save the early created keys to AWS Secret Manager.<br/> ( <strong class="ig hi">注意:使用Jenkins AWS凭证插件，代理的SSH密钥将自动创建为Jenkins内的凭证</strong>)</li><li id="b57f" class="kp kq hh ig b ih ky il kz ip la it lb ix lc jb ku kv kw kx bi translated">渲染并上传CASC文件(<code class="du le lf lg lh b">/terraform/templates/jenkins.yaml.tpl</code>)。<br/> <strong class="ig hi">注意:</strong>使用CASC的jenkins将创建一个名为“jenkins-agent-key-pair”的凭证，Jenkins云需要该凭证来自动配置代理。<br/>实际密钥的内容由Terraform本身存储在AWS Secret Manager中，Jenkins可以使用配置的IAM角色访问。<br/>然而，由于AWS Secret Manager中的密码名称在每次Terraform运行时都会改变，我需要对CASC配置进行模板化，使＄{ Jenkins-agent-key-pair }的值是动态的。</li><li id="5087" class="kp kq hh ig b ih ky il kz ip la it lb ix lc jb ku kv kw kx bi translated">提供所需的安全组。</li><li id="1038" class="kp kq hh ig b ih ky il kz ip la it lb ix lc jb ku kv kw kx bi translated">创建EC2实例来托管Jenkins Master，并在其中部署呈现的jenkins.yaml (CASC文件)。</li></ul><p id="74d3" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">詹金斯特工可以不费吹灰之力搞定。<br/>代理的映像创建使用与Jenkins主映像相同的工具和逻辑。<br/>药剂应该是一次性的；它们应该是你在需要的时候创造出来，然后丢弃的东西。Jenkins的“云”功能恰恰做到了这一点。<br/>云将允许您创建、管理和销毁代理。詹金斯只会在需要的时候产生代理。<br/>云配置只需要很少的参数，可以通过CASC进行配置。为了让您了解所需的CASC配置，请查看这个<a class="ae jl" href="https://github.com/ish-xyz/jenkins-aws-platform/blob/1/terraform/locals.tf#L3" rel="noopener ugc nofollow" target="_blank">示例</a>。</p><h1 id="a9af" class="jm jn hh bd jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj bi translated">结论</h1><p id="162e" class="pw-post-body-paragraph ie if hh ig b ih kk ij ik il kl in io ip km ir is it kn iv iw ix ko iz ja jb ha bi translated"><strong class="ig hi">教程:</strong>如果您想要部署本文中描述的基础设施，请遵循这里的教程<a class="ae jl" href="https://github.com/ish-xyz/jenkins-aws-platform/tree/1#tutorial" rel="noopener ugc nofollow" target="_blank"/>。</p><p id="536d" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">优点&amp; CONS :</p><p id="169d" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我不打算列出优点，因为在这一点上，它们应该足够清楚了:)</p><p id="c227" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">最后，请务必查看演示部分<a class="ae jl" href="https://github.com/ish-xyz/jenkins-aws-platform/tree/1#considerations" rel="noopener ugc nofollow" target="_blank">“注意事项”</a>。</p></div></div>    
</body>
</html>