<html>
<head>
<title>Vaccine Tracker: A telegram chat bot</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">疫苗追踪器:一个电报聊天机器人</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/vaccine-tracker-a-telegram-chat-bot-6bbf5ec66b18?source=collection_archive---------12-----------------------#2021-07-11">https://medium.com/analytics-vidhya/vaccine-tracker-a-telegram-chat-bot-6bbf5ec66b18?source=collection_archive---------12-----------------------#2021-07-11</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><figure class="ev ex if ig ih ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es ie"><img src="../Images/aba139aa6f150f54e4bb52b34b66cec6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-1OsZKqhvNen7-3_77dR0w.jpeg"/></div></div></figure><h1 id="27c4" class="ip iq hh bd ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm bi translated">介绍</h1><p id="602c" class="pw-post-body-paragraph jn jo hh jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ha bi translated">已经一年多了，因为世界正在新冠肺炎与一场不可预见的疫情战斗，尽早接种疫苗似乎是赢得这场战斗的最有效方式。为了缓解预订可用疫苗接种位置的困难，我决定开发一个交互式聊天机器人，用于根据密码、位置和剂量标准跟踪疫苗接种中心。</p><p id="98b8" class="pw-post-body-paragraph jn jo hh jp b jq kl js jt ju km jw jx jy kn ka kb kc ko ke kf kg kp ki kj kk ha bi translated"><strong class="jp hi">疫苗追踪器</strong>是一个电报机器人，使用以下方法检查可用的疫苗接种中心<br/>:</p><ol class=""><li id="fb8f" class="kq kr hh jp b jq kl ju km jy ks kc kt kg ku kk kv kw kx ky bi translated">pin码</li></ol><figure class="la lb lc ld fd ii er es paragraph-image"><div class="er es kz"><img src="../Images/a47a30b6055ca0e2c5f987178376aeec.png" data-original-src="https://miro.medium.com/v2/resize:fit:692/1*4la0hArkXPoU7CUPuRniPQ.gif"/></div></figure><p id="57a7" class="pw-post-body-paragraph jn jo hh jp b jq kl js jt ju km jw jx jy kn ka kb kc ko ke kf kg kp ki kj kk ha bi translated">2.位置</p><figure class="la lb lc ld fd ii er es paragraph-image"><div class="er es le"><img src="../Images/efaca4d1ef155f645c4d16c140d6bddb.png" data-original-src="https://miro.medium.com/v2/resize:fit:640/1*2UpoO7lCJcg_ydP6wsp6CQ.gif"/></div></figure></div><div class="ab cl lf lg go lh" role="separator"><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk"/></div><div class="ha hb hc hd he"><h1 id="9519" class="ip iq hh bd ir is lm iu iv iw ln iy iz ja lo jc jd je lp jg jh ji lq jk jl jm bi translated">创建一个电报机器人</h1><p id="8602" class="pw-post-body-paragraph jn jo hh jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ha bi translated">Telegram提供了一个自己的机器人，名为“<a class="ae lr" href="https://core.telegram.org/bots#6-botfather" rel="noopener ugc nofollow" target="_blank"> <strong class="jp hi">机器人之父</strong> </a>”，可用于创建和管理定制机器人。要创建一个新的机器人，键入命令<strong class="jp hi"> /newbot </strong>，并为新机器人提供一个公共名称和一个唯一的标识用户名。从<a class="ae lr" href="https://core.telegram.org/bots#6-botfather" rel="noopener ugc nofollow" target="_blank"> <strong class="jp hi">机器人父亲</strong> </a> <strong class="jp hi"> </strong>收到的令牌需要保持安全，因为我们将在聊天机器人应用程序中使用它。</p><figure class="la lb lc ld fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es ls"><img src="../Images/83a8e6d9da5e3a988fc7c78917569839.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xrtoeblZ8oLBNkMnluU1dg.png"/></div></div><figcaption class="lt lu et er es lv lw bd b be z dx translated">机器人父亲</figcaption></figure><h1 id="f4b8" class="ip iq hh bd ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm bi translated"><strong class="ak">构建疫苗追踪机器人</strong></h1><p id="be2a" class="pw-post-body-paragraph jn jo hh jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ha bi translated">为了开发<strong class="jp hi">疫苗跟踪器</strong> bot，我使用了<a class="ae lr" href="https://github.com/python-telegram-bot/python-telegram-bot" rel="noopener ugc nofollow" target="_blank"> python-telegram-bot </a>库来与Telegram Bot API交互。这个库包含了许多用于管理对话的有用的包装器，它有很好的文档记录，并且有一个活跃的开发社区。为了帮助更好地理解机器人，下面是对话流程:</p><figure class="la lb lc ld fd ii er es paragraph-image"><div class="er es lx"><img src="../Images/7223def80325094c742d728629cdeee5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1162/format:webp/1*m4l9m9GOxvY6uEUg2tn5Qg.png"/></div></figure></div><div class="ab cl lf lg go lh" role="separator"><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk"/></div><div class="ha hb hc hd he"><h1 id="c666" class="ip iq hh bd ir is lm iu iv iw ln iy iz ja lo jc jd je lp jg jh ji lq jk jl jm bi translated">深潜</h1><p id="f68e" class="pw-post-body-paragraph jn jo hh jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ha bi translated">该机器人旨在使用从<a class="ae lr" href="https://apisetu.gov.in/public/api/cowin" rel="noopener ugc nofollow" target="_blank">合作伙伴</a>公开的公共API检索可用的中心，并向用户提供对话体验。以下是可用于检索发送给bot的消息的两种方法:</p><ol class=""><li id="05fb" class="kq kr hh jp b jq kl ju km jy ks kc kt kg ku kk kv kw kx ky bi translated">投票</li><li id="f5ee" class="kq kr hh jp b jq ly ju lz jy ma kc mb kg mc kk kv kw kx ky bi translated">Webhook</li></ol><p id="e34d" class="pw-post-body-paragraph jn jo hh jp b jq kl js jt ju km jw jx jy kn ka kb kc ko ke kf kg kp ki kj kk ha bi translated">基于轮询的方法很简单，不需要任何额外的设置，因此应该仅用于测试目的。关于这一点，已经有很多可用的资源。然而，基于webhook的方法更具可伸缩性和成本效益，因为当没有任何数据可供处理时，不会浪费资源。疫苗追踪机器人使用基于webhook的方法来处理来自电报的输入事件。</p><p id="98af" class="pw-post-body-paragraph jn jo hh jp b jq kl js jt ju km jw jx jy kn ka kb kc ko ke kf kg kp ki kj kk ha bi translated"><strong class="jp hi">对话处理程序</strong></p><p id="1bd0" class="pw-post-body-paragraph jn jo hh jp b jq kl js jt ju km jw jx jy kn ka kb kc ko ke kf kg kp ki kj kk ha bi translated">设计对话机器人的核心方面是管理对话的不同层次和方面。为此，python-telegram-bot库公开了一个可用于管理对话的对话处理程序。每个会话在多个状态之间转换，这些状态需要在会话处理程序中指定，以及它们对应的处理程序实现。每个状态需要提供下一个适用的执行状态，如下所述:</p><figure class="la lb lc ld fd ii"><div class="bz dy l di"><div class="md me l"/></div><figcaption class="lt lu et er es lv lw bd b be z dx translated">对话处理程序</figcaption></figure><p id="dbd8" class="pw-post-body-paragraph jn jo hh jp b jq kl js jt ju km jw jx jy kn ka kb kc ko ke kf kg kp ki kj kk ha bi translated">对话处理器可配置为使用以下方式管理电报消息、回叫和命令:</p><p id="f5c0" class="pw-post-body-paragraph jn jo hh jp b jq kl js jt ju km jw jx jy kn ka kb kc ko ke kf kg kp ki kj kk ha bi translated"><strong class="jp hi">回调查询处理程序</strong></p><p id="2354" class="pw-post-body-paragraph jn jo hh jp b jq kl js jt ju km jw jx jy kn ka kb kc ko ke kf kg kp ki kj kk ha bi translated">回叫查询处理器被配置用于处理从电报接收的回叫事件。在大多数情况下，当自定义按钮可供用户选择时，会生成回调事件。例如，在这个机器人中，按下按钮产生的所有事件都需要一个回调处理程序来管理它们。</p><p id="dd2d" class="pw-post-body-paragraph jn jo hh jp b jq kl js jt ju km jw jx jy kn ka kb kc ko ke kf kg kp ki kj kk ha bi translated"><strong class="jp hi">消息处理程序</strong></p><p id="5f63" class="pw-post-body-paragraph jn jo hh jp b jq kl js jt ju km jw jx jy kn ka kb kc ko ke kf kg kp ki kj kk ha bi translated">消息处理器被配置用于处理从电报接收的消息事件。消息事件是用户键入或作为附件发送的任何内容。在这个bot中，从用户接收的pin码或位置数据需要一个消息处理程序来管理它们。</p><p id="bcb3" class="pw-post-body-paragraph jn jo hh jp b jq kl js jt ju km jw jx jy kn ka kb kc ko ke kf kg kp ki kj kk ha bi translated"><strong class="jp hi">命令处理程序</strong></p><p id="7e9e" class="pw-post-body-paragraph jn jo hh jp b jq kl js jt ju km jw jx jy kn ka kb kc ko ke kf kg kp ki kj kk ha bi translated">命令处理程序设计用于处理用户输入的命令。例如，如果用户键入<strong class="jp hi"> /start </strong>或<strong class="jp hi">/vaccined</strong>，<strong class="jp hi"> </strong>，那么它将被视为有效命令，并配置了相应的处理程序。</p><figure class="la lb lc ld fd ii"><div class="bz dy l di"><div class="md me l"/></div><figcaption class="lt lu et er es lv lw bd b be z dx translated">处理程序实现</figcaption></figure><h2 id="5859" class="mf iq hh bd ir mg mh mi iv mj mk ml iz jy mm mn jd kc mo mp jh kg mq mr jl ms bi translated">启用Webhooks</h2><p id="468b" class="pw-post-body-paragraph jn jo hh jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ha bi translated">为了理解webhook配置，理解什么是webhook是很重要的。webhook本质上是一个提供给telegram API的URL，只要收到用户的响应，就会被调用。</p><p id="b654" class="pw-post-body-paragraph jn jo hh jp b jq kl js jt ju km jw jx jy kn ka kb kc ko ke kf kg kp ki kj kk ha bi translated">因为我们的应用程序被期望通过webhook监听来自telegram API的事件，所以它需要在web服务器内部运行。为此，python-telegram-bot库提供了一个简单的解决方案，并使用以下代码启动一个HTTP服务器来监听webhook事件:</p><figure class="la lb lc ld fd ii"><div class="bz dy l di"><div class="md me l"/></div><figcaption class="lt lu et er es lv lw bd b be z dx translated">Webhook配置</figcaption></figure><p id="2378" class="pw-post-body-paragraph jn jo hh jp b jq kl js jt ju km jw jx jy kn ka kb kc ko ke kf kg kp ki kj kk ha bi translated">上面需要指出的重要一点是，webhook URL必须是唯一的<strong class="jp hi"> https </strong> URL。这是telegram API所要求的，因为它们将共享敏感数据，即来自用户的消息，因此，SSL/TLS加密在这里是必不可少的。对于使用https协议访问的任何URL，它需要拥有由任何公共信任的<a class="ae lr" href="https://www.ssl.com/faqs/what-is-a-certificate-authority/" rel="noopener ugc nofollow" target="_blank">认证机构(CA) </a>颁发的有效SSL/TLS证书。因为我们只计划测试我们的应用程序，所以一个更简单的方法是使用隧道通过公共URL访问我们的本地应用程序。<a class="ae lr" href="https://ngrok.com/" rel="noopener ugc nofollow" target="_blank"> Ngrok </a>可以用来实现这一点，因为它在<strong class="jp hi"> ngrok </strong>的子域上创建了一个公共URL。将流量传输到我们的本地网络服务器。对于Windows/Mac，从<a class="ae lr" href="https://ngrok.com/download" rel="noopener ugc nofollow" target="_blank">这里</a>下载ngrok并运行以下命令:</p><p id="4d98" class="pw-post-body-paragraph jn jo hh jp b jq kl js jt ju km jw jx jy kn ka kb kc ko ke kf kg kp ki kj kk ha bi translated"><strong class="jp hi">ngrok http&lt;port&gt;</strong>其中port是之前设置webhook时指定的端口。输出应该包含一个https URL，它可以用作我们的webhook URL，如下所示:</p><figure class="la lb lc ld fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es mt"><img src="../Images/8dfd11eda1cabe6361cfd6f107e4e401.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wUjYBsHQ6YfWjg-dY7qdPg.png"/></div></div></figure><h2 id="decf" class="mf iq hh bd ir mg mh mi iv mj mk ml iz jy mm mn jd kc mo mp jh kg mq mr jl ms bi translated">资源</h2><ol class=""><li id="e53c" class="kq kr hh jp b jq jr ju jv jy mu kc mv kg mw kk kv kw kx ky bi translated">试用疫苗追踪机器人:<a class="ae lr" href="http://t.me/cowin_vaccine_tracking_bot" rel="noopener ugc nofollow" target="_blank">http://t.me/cowin_vaccine_tracking_bot</a></li><li id="a2a6" class="kq kr hh jp b jq ly ju lz jy ma kc mb kg mc kk kv kw kx ky bi translated">了解更多电报机器人:<a class="ae lr" href="https://core.telegram.org/bots" rel="noopener ugc nofollow" target="_blank">https://core.telegram.org/bots</a></li><li id="091c" class="kq kr hh jp b jq ly ju lz jy ma kc mb kg mc kk kv kw kx ky bi translated">了解更多python电报bot库:<a class="ae lr" href="https://github.com/python-telegram-bot/python-telegram-bot" rel="noopener ugc nofollow" target="_blank">https://github.com/python-telegram-bot/python-telegram-bot</a></li></ol></div><div class="ab cl lf lg go lh" role="separator"><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk"/></div><div class="ha hb hc hd he"><p id="1368" class="pw-post-body-paragraph jn jo hh jp b jq kl js jt ju km jw jx jy kn ka kb kc ko ke kf kg kp ki kj kk ha bi translated">这个机器人的源代码可以在GitHub上找到。我希望这一信息将有助于开发和测试任何电报机器人。</p><p id="2b0d" class="pw-post-body-paragraph jn jo hh jp b jq kl js jt ju km jw jx jy kn ka kb kc ko ke kf kg kp ki kj kk ha bi translated">在下一篇文章中，我将重点介绍如何使用AWS和Heroku将telegram bot作为独立应用程序部署在云上。</p></div></div>    
</body>
</html>