<html>
<head>
<title>MLOps deployment in to AWS Fargate: II</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">MLOps部署到AWS Fargate: II</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/mlops-deployment-in-to-aws-fargate-ii-95321942b9e1?source=collection_archive---------8-----------------------#2021-01-07">https://medium.com/analytics-vidhya/mlops-deployment-in-to-aws-fargate-ii-95321942b9e1?source=collection_archive---------8-----------------------#2021-01-07</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/a838e5e44d63def6384ade0a0703889e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rdYTnHIljy7oBJeewD2pOQ.jpeg"/></div></div></figure><p id="4bd4" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">欢迎学习端到端MLOps的3部分教程，从培训、跟踪、部署和推理开始。</p><p id="10a0" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">第1部分:在AWS EC2上设置MLflow</p><p id="baa9" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">第2部分:在AWS Fargate上部署MLOps</p><p id="64cd" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">第3部分:AWS Fargate: II上的MLOps部署</p><p id="7b30" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">继续第3部分…</p><p id="394c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">你可以在这里找到所有使用过的代码<a class="ae jo" href="https://github.com/vaibhavsatpathy/psAI-clOps" rel="noopener ugc nofollow" target="_blank">的Github库！</a></p><p id="2bc3" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在上一部分中，我们已经设置了将模型部署到云环境中所需的所有基础设施。既然培训已经完成，我们已经有了工件，下一个具有挑战性的任务是创建API，创建一个包含所有必需内容的Docker映像，并将其设置到AWS中。</p><p id="dc03" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">为了避免手动创建Docker镜像及其所有依赖项的繁琐任务，我们将使用一个名为<a class="ae jo" href="https://www.bentoml.ai/" rel="noopener ugc nofollow" target="_blank"> BentoML </a>的Python框架。</p><p id="7a41" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">BentoML使开发和部署神经模型成为每个人的茶。让我们看看如何设置python脚本来获得想要的结果。</p><p id="70e0" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">创建API需要编写两个python脚本。第一个用来打包所有必需的工件，另一个用来声明所有必需的API和依赖项。</p><h2 id="3fbe" class="jp jq hi bd jr js jt ju jv jw jx jy jz jb ka kb kc jf kd ke kf jj kg kh ki kj bi translated">先决条件:</h2><ol class=""><li id="65cc" class="kk kl hi is b it km ix kn jb ko jf kp jj kq jn kr ks kt ku bi translated">系统上配置的AWS账号:<br/> CLI安装:<a class="ae jo" href="https://docs.aws.amazon.com/cli/latest/userguide/cli-chap-install.html" rel="noopener ugc nofollow" target="_blank">https://docs . AWS . Amazon . com/CLI/latest/user guide/CLI-chap-install . html</a>T7】账号配置:<a class="ae jo" href="https://docs.aws.amazon.com/cli/latest/userguide/cli-chap-configure.html" rel="noopener ugc nofollow" target="_blank">https://docs . AWS . Amazon . com/CLI/latest/user guide/CLI-chap-configure . html</a></li><li id="4ccf" class="kk kl hi is b it kv ix kw jb kx jf ky jj kz jn kr ks kt ku bi translated">系统上安装的Docker</li><li id="ad0c" class="kk kl hi is b it kv ix kw jb kx jf ky jj kz jn kr ks kt ku bi translated">AWS ecs-cli安装和配置<br/> CLI安装:<a class="ae jo" href="https://docs.aws.amazon.com/AmazonECS/latest/developerguide/ECS_CLI_installation.html" rel="noopener ugc nofollow" target="_blank">https://docs . AWS . Amazon . com/AmazonECS/latest/developer guide/ECS _ CLI _ installation . html</a></li></ol><p id="45ce" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">I .使用<a class="ae jo" href="https://docs.bentoml.org/en/latest/quickstart.html" rel="noopener ugc nofollow" target="_blank"> BentoML指南</a>开发必要的脚本。</p><ol class=""><li id="b809" class="kk kl hi is b it iu ix iy jb la jf lb jj lc jn kr ks kt ku bi translated">便当包装脚本需要给出工件的路径。现在，我们从S3下载文物到我们的本地系统，并给出了相应的路径</li></ol><figure class="le lf lg lh fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ld"><img src="../Images/e2a2423d7f915f9a5030e37b65ac79d3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QpgJvyhRdfImY310RlQPVg.png"/></div></div></figure><p id="d16e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">2.Bento预测脚本需要将所有的需求和API结构整合到AWS中。</p><p id="dbf5" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">让我们来看看剧本</p><figure class="le lf lg lh fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es li"><img src="../Images/08fcaaaf723e062594a52ee1e5bcacd1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XqhwDBRp-jA6bkzKuVPFmg.png"/></div></div></figure><p id="1107" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">decorator @bentoml.api帮助创建名为predict_image的api函数。API已经被构建为在其请求中接收字节格式的图像文件，作为回报，它将发送标签。</p><p id="c780" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如您所见，必要的人工制品是一个基于Tensorflow的模型和一个包含标签的Json文件。</p><p id="5361" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">decorator @bentoml.env有助于自动生成requirements.txt文件，以便根据脚本中导入的包构建Docker映像。</p><p id="2068" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">3.使用以下命令运行便当打包脚本</p><pre class="le lf lg lh fd lj lk ll lm aw ln bi"><span id="a703" class="jp jq hi lk b fi lo lp l lq lr">python3 bento_package.py</span></pre><p id="477c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">4.这将创建一个以UUID作为其文件夹名称的本地存储库，它将包含构建docker映像和测试其功能所需的所有数据。</p><figure class="le lf lg lh fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ls"><img src="../Images/c72a883c710c986fc588b3ea3611b193.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*EWI-jDbhESV7Bfl7FcFXdA.png"/></div></div></figure><p id="4e47" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">5.为了在本地测试结果，我们需要运行以下命令:</p><pre class="le lf lg lh fd lj lk ll lm aw ln bi"><span id="afda" class="jp jq hi lk b fi lo lp l lq lr">bentoml serve ImageClassifier:latest</span></pre><p id="a592" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">二。<a class="ae jo" href="https://docs.bentoml.org/en/latest/deployment/aws_ecs.html" rel="noopener ugc nofollow" target="_blank">将BentoML模型服务器装箱进行部署</a></p><ol class=""><li id="d25c" class="kk kl hi is b it iu ix iy jb la jf lb jj lc jn kr ks kt ku bi translated">为了创建ECS部署，需要对模型服务器进行容器化，并将其推送到容器注册中心(ECR)</li><li id="1f33" class="kk kl hi is b it kv ix kw jb kx jf ky jj kz jn kr ks kt ku bi translated">我们需要登录Docker</li></ol><pre class="le lf lg lh fd lj lk ll lm aw ln bi"><span id="6018" class="jp jq hi lk b fi lo lp l lq lr">aws ecr get-login-password --region us-east-2</span><span id="0adb" class="jp jq hi lk b fi lt lp l lq lr"><em class="lu"># Sample output (Authentication Token)</em><br/><br/>eyJ.................OOH</span></pre><p id="ac0e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">3.使用以下命令中的输出并添加您的帐户ID。</p><pre class="le lf lg lh fd lj lk ll lm aw ln bi"><span id="0fa0" class="jp jq hi lk b fi lo lp l lq lr">docker login -u AWS -p eyJ.................OOH https://account_id.dkr.ecr.us-west-2.amazonaws.com</span></pre><p id="83eb" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">4.创建AWS ECR存储库</p><pre class="le lf lg lh fd lj lk ll lm aw ln bi"><span id="bba7" class="jp jq hi lk b fi lo lp l lq lr">aws ecr create-repository --repository-name irisclassifier-ecs</span></pre><p id="3d7b" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">5.建立Docker形象</p><pre class="le lf lg lh fd lj lk ll lm aw ln bi"><span id="f705" class="jp jq hi lk b fi lo lp l lq lr">saved_path=<strong class="lk hj">$(</strong>bentoml get IrisClassifier:latest --print-location --quiet<strong class="lk hj">)</strong><br/><br/>docker build --tag=account_id.dkr.ecr.us-west-2.amazonaws.com/irisclassifier-ecs $saved_path</span></pre><p id="012f" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">6.推送docker图像</p><pre class="le lf lg lh fd lj lk ll lm aw ln bi"><span id="acb0" class="jp jq hi lk b fi lo lp l lq lr">docker push account_id.dkr.ecr.us-west-2.amazonaws.com/irisclassifier-ecs</span></pre><p id="89cf" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">7.为ECR部署准备AWS</p><pre class="le lf lg lh fd lj lk ll lm aw ln bi"><span id="7701" class="jp jq hi lk b fi lo lp l lq lr">$ cat task-execution-assume-role.json<br/><br/># Sample output<br/><br/>{<br/>  "Version": "2012-10-17",<br/>  "Statement": [<br/>    {<br/>      "Sid": "",<br/>      "Effect": "Allow",<br/>      "Principal": {<br/>        "Service": "ecs-tasks.amazonaws.com"<br/>      },<br/>      "Action": "sts:AssumeRole"<br/>    }<br/>  ]<br/>}</span></pre><p id="4375" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">8.创建IAM角色</p><pre class="le lf lg lh fd lj lk ll lm aw ln bi"><span id="ecb0" class="jp jq hi lk b fi lo lp l lq lr">aws iam --region us-west-2 create-role --role-name ecsTaskExecutionRole \<br/>  --assume-role-policy-document file://task-execution-assume-role.json<br/><br/># Sample output<br/><br/>{<br/>    "Role": {<br/>        "Path": "/",<br/>        "RoleName": "ecsTaskExecutionRole",<br/>        "RoleId": "AROASZNL76Z7C7Q7SZJ4D",<br/>        "Arn": "arn:aws:iam::192023623294:role/ecsTaskExecutionRole",<br/>        "CreateDate": "2019-12-17T01:04:08Z",<br/>        "AssumeRolePolicyDocument": {<br/>            "Version": "2012-10-17",<br/>            "Statement": [<br/>                {<br/>                    "Sid": "",<br/>                    "Effect": "Allow",<br/>                    "Principal": {<br/>                        "Service": "ecs-tasks.amazonaws.com"<br/>                    },<br/>                    "Action": "sts:AssumeRole"<br/>                }<br/>            ]<br/>        }<br/>    }<br/>}</span></pre><p id="6137" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">9.将策略AmazonECSTaskExecutionRolePolicy添加到角色ecsTaskExecutionRole</p><pre class="le lf lg lh fd lj lk ll lm aw ln bi"><span id="d206" class="jp jq hi lk b fi lo lp l lq lr">aws iam --region us-west-2 attach-role-policy --role-name ecsTaskExecutionRole <strong class="lk hj">\</strong><br/>  --policy-arn arn:aws:iam::aws:policy/service-role/AmazonECSTaskExecutionRolePolicy</span></pre><p id="b1e0" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">三。配置ECR配置文件</p><ol class=""><li id="4625" class="kk kl hi is b it iu ix iy jb la jf lb jj lc jn kr ks kt ku bi translated">创建ECR CLI配置文件</li></ol><pre class="le lf lg lh fd lj lk ll lm aw ln bi"><span id="9271" class="jp jq hi lk b fi lo lp l lq lr">ecs-cli configure profile --access-key $AWS_ACCESS_KEY_ID --secret-key $AWS_SECRET_ACCESS_KEY --profile-name docuedge-bentoml-profile</span></pre><p id="87e1" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">2.创建ECR集群配置文件配置</p><pre class="le lf lg lh fd lj lk ll lm aw ln bi"><span id="f483" class="jp jq hi lk b fi lo lp l lq lr">ecs-cli configure --cluster docuedge-bentoml-modelzoo --default-launch-type FARGATE --config-name docuedge-bentoml-config --region us-east-2</span></pre><p id="367e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">3.使用上面创建的配置文件创建一个集群</p><pre class="le lf lg lh fd lj lk ll lm aw ln bi"><span id="6f82" class="jp jq hi lk b fi lo lp l lq lr">ecs-cli up --vpc vpc-01b4edaf92e19af08 --subnets subnet-0345b051535c9625d, subnet-00e7bff093931a167 --cluster-config docuedge-bentoml-config --cluster docuedge-bentoml-modelzoo</span></pre><p id="3ef9" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">四。创造必要的。yaml文件</p><ol class=""><li id="c4e7" class="kk kl hi is b it iu ix iy jb la jf lb jj lc jn kr ks kt ku bi translated">创建docker-compose.yaml文件，使用前面步骤中的图像标记</li></ol><figure class="le lf lg lh fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lv"><img src="../Images/48a5a6d2592f6590e62f36232f4119df.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*AyGkDK31zVnF39UOZxSN-w.png"/></div></div></figure><p id="be72" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">2.使用您在本集的前一部分中使用的安全组和子网创建ecs-params.yaml。</p><figure class="le lf lg lh fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lw"><img src="../Images/f2884dab7255cb1900cc84109649a6f1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KPjOHJGzq7GT-0oe3SBTOw.png"/></div></div></figure><p id="6cf5" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><em class="lu">由于我们使用Tensorflow，docker图像的大小大于4GB，因此分配给任务的大小是8GB，CPU限制也是相同的。</em></p><p id="ae0f" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><em class="lu"> EFS是可选的，如果您在系统中设置了它，您可以如上所述将其添加到ecs-params.yaml中，或者将其从文件中删除。</em></p><p id="2af7" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">动词 （verb的缩写）将BentoService部署到Fargate</p><p id="0b5e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们按照在前面章节中设置的内容来设置目标组、集群配置文件和项目名称。</p><pre class="le lf lg lh fd lj lk ll lm aw ln bi"><span id="ea86" class="jp jq hi lk b fi lo lp l lq lr">ecs-cli compose --project-name docuedge-bentoml-modelzoo service up --target-groups targetGroupArn=arn:aws:elasticloadbalancing:us-east-2:142339138776:targetgroup/docuedgedev-bentoml/5743cdb7a5630ff9,containerName=web,containerPort=5000 --create-log-groups --cluster-config docuedge-bentoml-config --ecs-profile docuedge-bentoml-profile</span></pre><p id="c581" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">恭喜您，您已经成功地将模型部署到您的AWS云环境中。要查看Swagger文档或API套件，请导航到您的AWS仪表板并使用您的ALB的DNS。或者，如果您已经附加了SSL证书，请打开您在ACM证书中提到的HTTPS链接</p><p id="dfe0" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">你应该看到这样的东西！！！</p><figure class="le lf lg lh fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lx"><img src="../Images/cdfebd74b3bc16d609330c24eae59480.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sINkcT9UI_cw-tZ_heWVoQ.png"/></div></div></figure><p id="6387" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">要使用Python来使用API，只需复制链接并将其替换为下面的代码片段</p><figure class="le lf lg lh fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ly"><img src="../Images/50854ca36abc68c2b168e403f47f049e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nE9Ld5WiVt01tVeEs4j3Kw.png"/></div></div></figure><p id="bf2c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">希望你觉得这个教程有用。😁😁</p></div></div>    
</body>
</html>