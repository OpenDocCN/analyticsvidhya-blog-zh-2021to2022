<html>
<head>
<title>Transforming GeoJSON’s Geometric Features into BigQuery’s Polygon Format with Simple Python Script</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用简单的Python脚本将GeoJSON的几何要素转换为BigQuery的多边形格式</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/transforming-geometric-features-into-bigquerys-polygon-format-with-simple-python-script-bfd6d44dfc3f?source=collection_archive---------18-----------------------#2021-05-27">https://medium.com/analytics-vidhya/transforming-geometric-features-into-bigquerys-polygon-format-with-simple-python-script-bfd6d44dfc3f?source=collection_archive---------18-----------------------#2021-05-27</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><blockquote class="ie if ig"><p id="b146" class="ih ii ij ik b il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf ha bi translated"><em class="hh">将GeoJson.io中可用的几何数据纳入分析用例。</em></p></blockquote><figure class="jh ji jj jk fd jl er es paragraph-image"><div role="button" tabindex="0" class="jm jn di jo bf jp"><div class="er es jg"><img src="../Images/4a067d41e3dd81f5512ea8a8b5aea0f2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*hb4nENEI17JiIolW"/></div></div><figcaption class="js jt et er es ju jv bd b be z dx translated">由<a class="ae jw" href="https://unsplash.com/@delfidelarua7?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">德尔菲·德拉鲁阿</a>在<a class="ae jw" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><p id="da56" class="pw-post-body-paragraph ih ii hh ik b il im in io ip iq ir is jx iu iv iw jy iy iz ja jz jc jd je jf ha bi translated">在一家叫车技术公司的分析领域工作，我经常意识到空间/GIS格式的信息可以提供传统数据分析中容易错过的独特见解。例如，能够观察某些地理边界上的趋势，而不是在城市层面上观察时间序列，可以帮助我们定位异常并获得更好的见解(例如，在疫情期间，从购物中心到购物中心的旅行发生了什么？同样，长假期间居民的生活会发生什么变化？)</p><p id="1150" class="pw-post-body-paragraph ih ii hh ik b il im in io ip iq ir is jx iu iv iw jy iy iz ja jz jc jd je jf ha bi translated">虽然工程团队已经开发了<a class="ae jw" href="https://www.gojek.io/blog/appreciating-the-geo-s2-library" rel="noopener ugc nofollow" target="_blank"> s2库</a>，该库将空间地图划分为更小的矩形形状(这对<em class="ij">在某些位置近似</em>趋势非常有帮助)，但仍有一些情况下，我们更喜欢自由绘制边界的<em class="ij">灵活性。这是因为某个兴趣点的实际形状可能不一定是矩形的(如malls &amp; residentials示例)，并且根据粒度，强制s2库可能会覆盖或覆盖不到相关空间。</em></p><p id="d7dc" class="pw-post-body-paragraph ih ii hh ik b il im in io ip iq ir is jx iu iv iw jy iy iz ja jz jc jd je jf ha bi translated">幸运的是，<em class="ij">定位和标记地理边界</em>的灵活性被像<a class="ae jw" href="http://geojson.io/#map=2/20.0/0.0" rel="noopener ugc nofollow" target="_blank"> GeoJson.io </a>这样的工具很好地覆盖了，它为某些地理特征提供了<a class="ae jw" href="https://sumit-arora.medium.com/what-is-geojson-geojson-basics-visualize-geojson-open-geojson-using-qgis-open-geojson-3432039e336d" rel="noopener">视觉和GeoJSON r </a>表示。举例来说，假设我们想要生成雅加达<a class="ae jw" href="https://en.wikipedia.org/wiki/National_Monument_(Indonesia)" rel="noopener ugc nofollow" target="_blank">国家纪念碑</a>周围的地理要素:</p><figure class="jh ji jj jk fd jl er es paragraph-image"><div role="button" tabindex="0" class="jm jn di jo bf jp"><div class="er es ka"><img src="../Images/8d830bb9f7b65985f5be53a020768ce9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Q6_Rn0OVQdnZTf9A0Hr_mw.png"/></div></div><figcaption class="js jt et er es ju jv bd b be z dx translated">图片作者(来自<a class="ae jw" href="http://geojson.io/#map=15/-6.1756/106.8242" rel="noopener ugc nofollow" target="_blank"> Geojson.io </a>)</figcaption></figure><p id="148f" class="pw-post-body-paragraph ih ii hh ik b il im in io ip iq ir is jx iu iv iw jy iy iz ja jz jc jd je jf ha bi translated">我们从上面的截图中看到的是雅加达最受欢迎的城市标志之一<em class="ij">国家纪念碑</em>的视觉(左)和地理特征(右)。一旦我们可以在地图上找到雅加达的位置，就可以通过选择<em class="ij">“画多边形”</em>工具栏，并自己在目标区域绘制地图。很方便，不是吗？</p><p id="4839" class="pw-post-body-paragraph ih ii hh ik b il im in io ip iq ir is jx iu iv iw jy iy iz ja jz jc jd je jf ha bi translated">没那么快。尽管知道地理特征，这些信息还不能用于分析。也就是说，即使我们有指向和来自地图坐标的用户移动性的事务记录(即SQL/BigQuery中的数据库), GeoJSON要素格式仍需要进行解析，这可能会造成一些麻烦。</p><p id="ba9b" class="pw-post-body-paragraph ih ii hh ik b il im in io ip iq ir is jx iu iv iw jy iy iz ja jz jc jd je jf ha bi translated">例如，BigQuery有特定的规则<a class="ae jw" href="https://cloud.google.com/bigquery/docs/gis-data" rel="noopener ugc nofollow" target="_blank">用于GIS </a>。输入JSON片段必须由GeoJSON几何类型组成，仅包括<code class="du kb kc kd ke b">Point</code>、<code class="du kb kc kd ke b">MultiPoint</code>、<code class="du kb kc kd ke b">LineString</code>、<code class="du kb kc kd ke b">MultiLineString</code>、<code class="du kb kc kd ke b">Polygon</code>、<code class="du kb kc kd ke b">MultiPolygon</code>和<code class="du kb kc kd ke b">GeometryCollection</code>。GeoJSON <code class="du kb kc kd ke b">Feature</code>或<code class="du kb kc kd ke b">FeatureCollection</code>，比如我们在Geojson.io中看到的，如果不解析，将导致<strong class="ik hi">错误。</strong></p><p id="09a1" class="pw-post-body-paragraph ih ii hh ik b il im in io ip iq ir is jx iu iv iw jy iy iz ja jz jc jd je jf ha bi translated">在本文中，我们将使用简单的python脚本将GeoSJON <code class="du kb kc kd ke b">FeatureCollection</code>解析成<code class="du kb kc kd ke b">Polygon</code>。最终结果如下:<code class="du kb kc kd ke b">POLYGON((0 0, 0 2, 2 2, 0 2, 0 0))</code>其中括号中的值是从GeoJSON.io几何要素集合中获取的坐标。</p><h2 id="1109" class="kf kg hh bd kh ki kj kk kl km kn ko kp jx kq kr ks jy kt ku kv jz kw kx ky kz bi translated">步骤1:导入相关库&amp; <strong class="ak">复制粘贴</strong> GeoJSON特征集合到变量“<strong class="ak">result”</strong></h2><figure class="jh ji jj jk fd jl"><div class="bz dy l di"><div class="la lb l"/></div></figure><p id="9dd8" class="pw-post-body-paragraph ih ii hh ik b il im in io ip iq ir is jx iu iv iw jy iy iz ja jz jc jd je jf ha bi translated">第一步是加载json库，从GeoJSON.io复制粘贴值，这基本上是脚本中唯一需要的手动步骤。</p><h2 id="2feb" class="kf kg hh bd kh ki kj kk kl km kn ko kp jx kq kr ks jy kt ku kv jz kw kx ky kz bi translated">步骤2:遍历JSON，寻找相关的键值对</h2><figure class="jh ji jj jk fd jl"><div class="bz dy l di"><div class="la lb l"/></div></figure><p id="f077" class="pw-post-body-paragraph ih ii hh ik b il im in io ip iq ir is jx iu iv iw jy iy iz ja jz jc jd je jf ha bi translated">这种探索性的方法可以推广，特别是对于迭代较长的JSON非常有用，这种JSON通常是字典格式的。一个好的检查是首先确认JSON中每个嵌套元素的类型是否是一个字典(很可能是)。如果是，我们将继续检查它的键值对。</p><p id="04dd" class="pw-post-body-paragraph ih ii hh ik b il im in io ip iq ir is jx iu iv iw jy iy iz ja jz jc jd je jf ha bi translated">为了更好地理解正在发生的事情，下面是每个步骤的打印声明:</p><figure class="jh ji jj jk fd jl er es paragraph-image"><div role="button" tabindex="0" class="jm jn di jo bf jp"><div class="er es lc"><img src="../Images/72fc30328fbfadf4484dfae6466be2af.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bbw8gb_z4cgc7cL7cttXoA.png"/></div></div><figcaption class="js jt et er es ju jv bd b be z dx translated">作者图片</figcaption></figure><p id="85e8" class="pw-post-body-paragraph ih ii hh ik b il im in io ip iq ir is jx iu iv iw jy iy iz ja jz jc jd je jf ha bi translated">从步骤a我们发现有<em class="ij">【类型】</em>和<em class="ij">【特征】</em>键名。由于我们的预期值可以在<em class="ij">“功能”</em>中找到，接下来(在步骤b中)我们可以更深入地挖掘<em class="ij">“功能”</em>键。步骤c-d意味着在子键中发现更多的键，直到我们可以找到我们要找的东西。请注意，我们的相关键最终可以在步骤d中找到，其中<em class="ij">“geometry”</em>键指向存储在<em class="ij">“coordinates”</em>子键中的long lat值。</p><h2 id="d6f1" class="kf kg hh bd kh ki kj kk kl km kn ko kp jx kq kr ks jy kt ku kv jz kw kx ky kz bi translated">步骤3:从嵌套数据中检索相关值，并将其重新格式化为多边形字符串格式</h2><p id="0a6e" class="pw-post-body-paragraph ih ii hh ik b il ld in io ip le ir is jx lf iv iw jy lg iz ja jz lh jd je jf ha bi translated">在这一步中，我们将long lat值转换为BigQuery可解析多边形格式。这也是这个Python脚本的便利之处。</p><figure class="jh ji jj jk fd jl"><div class="bz dy l di"><div class="la lb l"/></div></figure><p id="90d4" class="pw-post-body-paragraph ih ii hh ik b il im in io ip iq ir is jx iu iv iw jy iy iz ja jz jc jd je jf ha bi translated">结果如下:</p><figure class="jh ji jj jk fd jl er es paragraph-image"><div role="button" tabindex="0" class="jm jn di jo bf jp"><div class="er es li"><img src="../Images/b2fea90a19cc7f90853b1e42bdf15be1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tA1baRVi0YFS0nKlYiqxhg.png"/></div></div><figcaption class="js jt et er es ju jv bd b be z dx translated">作者图片</figcaption></figure><p id="c84b" class="pw-post-body-paragraph ih ii hh ik b il im in io ip iq ir is jx iu iv iw jy iy iz ja jz jc jd je jf ha bi translated">完美！现在我们可以开始在SQL/BigQuery中使用多边形了。因此，让我们复制并粘贴打印字符串'多边形((…))'并在BQ中探索。</p><h2 id="fe52" class="kf kg hh bd kh ki kj kk kl km kn ko kp jx kq kr ks jy kt ku kv jz kw kx ky kz bi translated">第四步:在BigQuery中尝试一下，看看是否有效！</h2><p id="a25a" class="pw-post-body-paragraph ih ii hh ik b il ld in io ip le ir is jx lf iv iw jy lg iz ja jz lh jd je jf ha bi translated">一个有趣的(但可选的)检查多边形是否在BigQuery中工作的方法是通过<a class="ae jw" href="https://bigquerygeoviz.appspot.com/" rel="noopener ugc nofollow" target="_blank"> BigQueryGeoviz </a>并将多边形文本复制粘贴到其中。不要忘记使用<code class="du kb kc kd ke b">ST_GEOGFROMTEXT</code>将我们的多边形字符串转换成地理格式。点击运行，就可以了，一个和GeoJSON.io中一模一样的地图！</p><figure class="jh ji jj jk fd jl er es paragraph-image"><div role="button" tabindex="0" class="jm jn di jo bf jp"><div class="er es lj"><img src="../Images/2e955c1516cefda853a744f52a57330a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7TRCowUZZlmu4gIoTwBDfw.png"/></div></div><figcaption class="js jt et er es ju jv bd b be z dx translated">作者图片</figcaption></figure><p id="2250" class="pw-post-body-paragraph ih ii hh ik b il im in io ip iq ir is jx iu iv iw jy iy iz ja jz jc jd je jf ha bi translated">检查它是否有效的第二种方法是对照实际数据进行分析。例如，下面是在SQL上测试它的样子。</p><figure class="jh ji jj jk fd jl"><div class="bz dy l di"><div class="la lb l"/></div></figure><p id="ccab" class="pw-post-body-paragraph ih ii hh ik b il im in io ip iq ir is jx iu iv iw jy iy iz ja jz jc jd je jf ha bi translated">如果查询返回预期值，那么恭喜您已经成功地将几何要素转换为面。测试愉快！</p><p id="0a96" class="pw-post-body-paragraph ih ii hh ik b il im in io ip iq ir is jx iu iv iw jy iy iz ja jz jc jd je jf ha bi translated">注意:Python脚本和示例SQL代码的链接可以在<a class="ae jw" href="https://github.com/taufiqbashori/parse-geojson2polygon" rel="noopener ugc nofollow" target="_blank">这里</a>找到。</p></div></div>    
</body>
</html>