<html>
<head>
<title>PostgreSQL Streaming Replication</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">PostgreSQL流复制</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/postgresql-streaming-replication-4b4679b352f3?source=collection_archive---------0-----------------------#2021-12-23">https://medium.com/analytics-vidhya/postgresql-streaming-replication-4b4679b352f3?source=collection_archive---------0-----------------------#2021-12-23</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="5233" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在本主题中，我将简要介绍PostgreSQL流复制。</p><p id="1d01" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我将PotgreSQL版本14用于主系统和备用系统。</p><p id="3d41" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">对于源系统，我使用PostgreSQL最新的docker映像。对于目标系统，我使用了Debian最新的docker映像。</p><p id="82e0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">以便准备源系统；</p><blockquote class="jd je jf"><p id="2aa8" class="if ig jg ih b ii ij ik il im in io ip jh ir is it ji iv iw ix jj iz ja jb jc hb bi translated">postgres=# <strong class="ih hj">显示数据_目录；</strong></p><p id="e63a" class="if ig jg ih b ii ij ik il im in io ip jh ir is it ji iv iw ix jj iz ja jb jc hb bi translated">数据目录</p><p id="5d86" class="if ig jg ih b ii ij ik il im in io ip jh ir is it ji iv iw ix jj iz ja jb jc hb bi">— — — — — — — — — — — — —</p><p id="1dad" class="if ig jg ih b ii ij ik il im in io ip jh ir is it ji iv iw ix jj iz ja jb jc hb bi translated">/var/lib/postgresql/data</p><p id="41f0" class="if ig jg ih b ii ij ik il im in io ip jh ir is it ji iv iw ix jj iz ja jb jc hb bi translated">(1行)</p></blockquote><p id="8cb8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们需要在“postgresql.conf”文件的末尾添加以下行:</p><blockquote class="jd je jf"><p id="ba63" class="if ig jg ih b ii ij ik il im in io ip jh ir is it ji iv iw ix jj iz ja jb jc hb bi translated"><strong class="ih hj">沃尔_level =副本</strong></p><p id="dc2d" class="if ig jg ih b ii ij ik il im in io ip jh ir is it ji iv iw ix jj iz ja jb jc hb bi translated"><strong class="ih hj"> wal_log_hints = on </strong></p><p id="ce93" class="if ig jg ih b ii ij ik il im in io ip jh ir is it ji iv iw ix jj iz ja jb jc hb bi translated"><strong class="ih hj"> archive_mode = on #(更改需要重启)</strong></p><p id="0254" class="if ig jg ih b ii ij ik il im in io ip jh ir is it ji iv iw ix jj iz ja jb jc hb bi translated"><strong class="ih hj"> archive_command = 'test！-f/var/lib/PostgreSQL/pg _ log _ archive/main/% f&amp;&amp;CP % p/var/lib/PostgreSQL/pg _ log _ archive/main/% f '</strong></p><p id="0ba3" class="if ig jg ih b ii ij ik il im in io ip jh ir is it ji iv iw ix jj iz ja jb jc hb bi translated"><strong class="ih hj"> max_wal_senders = 10 </strong></p><p id="78f7" class="if ig jg ih b ii ij ik il im in io ip jh ir is it ji iv iw ix jj iz ja jb jc hb bi translated"><strong class="ih hj">热备用=开启</strong></p></blockquote><p id="a50f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后，</p><blockquote class="jd je jf"><p id="8341" class="if ig jg ih b ii ij ik il im in io ip jh ir is it ji iv iw ix jj iz ja jb jc hb bi translated"><strong class="ih hj">mkdir-p/var/lib/PostgreSQL/pg _ log _ archive/main/</strong></p><p id="d4aa" class="if ig jg ih b ii ij ik il im in io ip jh ir is it ji iv iw ix jj iz ja jb jc hb bi translated"><strong class="ih hj">create user-e-replication repl-W</strong># as postgres</p></blockquote><p id="b2a8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">此外，我们需要添加以下行来允许复制用户“repl”连接源数据库:</p><blockquote class="jd je jf"><p id="ee62" class="if ig jg ih b ii ij ik il im in io ip jh ir is it ji iv iw ix jj iz ja jb jc hb bi translated"><strong class="ih hj">主机复制repl 172.17.0.5/32 md5 </strong></p></blockquote><p id="2b1f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后重新启动PostgreSQL集群:</p><blockquote class="jd je jf"><p id="1abe" class="if ig jg ih b ii ij ik il im in io ip jh ir is it ji iv iw ix jj iz ja jb jc hb bi translated"><strong class="ih hj">选择pg _ create _ physical _ replication _ slot(' air ')；</strong></p><p id="bef4" class="if ig jg ih b ii ij ik il im in io ip jh ir is it ji iv iw ix jj iz ja jb jc hb bi translated">pg _创建_物理_复制_插槽</p><p id="a796" class="if ig jg ih b ii ij ik il im in io ip jh ir is it ji iv iw ix jj iz ja jb jc hb bi">— — — — — — — — — — — — — — — — — — -</p><p id="3197" class="if ig jg ih b ii ij ik il im in io ip jh ir is it ji iv iw ix jj iz ja jb jc hb bi translated">(空气)</p><p id="fafa" class="if ig jg ih b ii ij ik il im in io ip jh ir is it ji iv iw ix jj iz ja jb jc hb bi translated">(1行)</p><p id="e5da" class="if ig jg ih b ii ij ik il im in io ip jh ir is it ji iv iw ix jj iz ja jb jc hb bi translated"><strong class="ih hj">select * from pg _ replication _ slots；</strong></p></blockquote><figure class="jl jm jn jo fd jp er es paragraph-image"><div role="button" tabindex="0" class="jq jr di js bf jt"><div class="er es jk"><img src="../Images/63cae05c8aaed6d1ddd769799abd870f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KJ5bVVZY0gqtDDYvKRajfg.png"/></div></div></figure><p id="ede3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">由于wal文件的管理，我们使用“pg_replication_slots”。在PostgreSQL版本之前，我们通过“wal_keep_segments”参数来管理wal文件。当主节点和备用节点之间的通信出现问题时，如果我们的系统超出限制“wal _ keep _ segments ”, PostgreSQL将删除文件，除非我们创建一个复制槽。这就是我们在配置中使用复制插槽的原因。当然，也有一些缺点，比如我们需要足够的(很多/取决于系统)数据存储，以便在任何通信故障的情况下不停止生产系统。</p><p id="a795" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae jw" href="https://www.postgresql.org/docs/9.4/catalog-pg-replication-slots.html" rel="noopener ugc nofollow" target="_blank">https://www . PostgreSQL . org/docs/9.4/catalog-pg-replication-slots . html</a></p><p id="193e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae jw" href="https://hevodata.com/learn/postgresql-replication-slots/" rel="noopener ugc nofollow" target="_blank">https://hevodata.com/learn/postgresql-replication-slots/</a></p><p id="f5f0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在目标端配置；</p><p id="ba8f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">首先，我们需要安装PostgreSQL二进制文件:</p><div class="jx jy ez fb jz ka"><a href="https://www.postgresql.org/download/linux/ubuntu/" rel="noopener  ugc nofollow" target="_blank"><div class="kb ab dw"><div class="kc ab kd cl cj ke"><h2 class="bd hj fi z dy kf ea eb kg ed ef hh bi translated">Linux下载(Ubuntu)</h2><div class="kh l"><h3 class="bd b fi z dy kf ea eb kg ed ef dx translated">默认情况下，PostgreSQL在所有Ubuntu版本中都可用。然而，Ubuntu“快照”了PostgreSQL的一个特定版本…</h3></div><div class="ki l"><p class="bd b fp z dy kf ea eb kg ed ef dx translated">www.postgresql.org</p></div></div><div class="kj l"><div class="kk l kl km kn kj ko ju ka"/></div></div></a></div><blockquote class="jd je jf"><p id="0388" class="if ig jg ih b ii ij ik il im in io ip jh ir is it ji iv iw ix jj iz ja jb jc hb bi translated">#创建文件存储库配置:</p><p id="bf0d" class="if ig jg ih b ii ij ik il im in io ip jh ir is it ji iv iw ix jj iz ja jb jc hb bi translated">sudo sh-c ' echo " deb<a class="ae jw" href="http://apt.postgresql.org/pub/repos/apt" rel="noopener ugc nofollow" target="_blank">http://apt.postgresql.org/pub/repos/apt</a>$(LSB _ release-cs)-pgdg main "&gt;/etc/apt/sources . list . d/pgdg . list '</p><p id="284a" class="if ig jg ih b ii ij ik il im in io ip jh ir is it ji iv iw ix jj iz ja jb jc hb bi translated">#导入存储库签名密钥:</p><p id="b075" class="if ig jg ih b ii ij ik il im in io ip jh ir is it ji iv iw ix jj iz ja jb jc hb bi translated">https://www.postgresql.org/media/keys/ACCC4CF8.asc|须藤apt-key add -</p><p id="91ce" class="if ig jg ih b ii ij ik il im in io ip jh ir is it ji iv iw ix jj iz ja jb jc hb bi translated">#更新包列表:</p><p id="a604" class="if ig jg ih b ii ij ik il im in io ip jh ir is it ji iv iw ix jj iz ja jb jc hb bi translated">sudo apt-get更新</p><p id="0ee5" class="if ig jg ih b ii ij ik il im in io ip jh ir is it ji iv iw ix jj iz ja jb jc hb bi translated">#安装最新版本的PostgreSQL。</p><p id="ffd3" class="if ig jg ih b ii ij ik il im in io ip jh ir is it ji iv iw ix jj iz ja jb jc hb bi translated">#如果您需要特定的版本，请使用“postgresql-12”或类似的语言，而不是“postgresql”:</p><p id="2b2b" class="if ig jg ih b ii ij ik il im in io ip jh ir is it ji iv iw ix jj iz ja jb jc hb bi translated">sudo apt-get -y安装postgresql</p></blockquote><p id="b5b0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后，我检查复制用户是否可以连接到源数据库:</p><blockquote class="jd je jf"><p id="2199" class="if ig jg ih b ii ij ik il im in io ip jh ir is it ji iv iw ix jj iz ja jb jc hb bi translated"><strong class="ih hj">psql-h 172 . 17 . 0 . 4-U repl postgres</strong></p><p id="5681" class="if ig jg ih b ii ij ik il im in io ip jh ir is it ji iv iw ix jj iz ja jb jc hb bi translated"><strong class="ih hj">用户回复的密码:</strong></p><p id="c08d" class="if ig jg ih b ii ij ik il im in io ip jh ir is it ji iv iw ix jj iz ja jb jc hb bi translated"><strong class="ih hj">psql(14.1(Debian 14.1–1 . pgdg 110+1)，server 14.0(Debian 14.0–1 . pgdg 110+1))</strong></p><p id="d5a0" class="if ig jg ih b ii ij ik il im in io ip jh ir is it ji iv iw ix jj iz ja jb jc hb bi translated"><strong class="ih hj">键入“help”寻求帮助。</strong></p><p id="0def" class="if ig jg ih b ii ij ik il im in io ip jh ir is it ji iv iw ix jj iz ja jb jc hb bi translated"><strong class="ih hj"> postgres= &gt; </strong></p><p id="9b70" class="if ig jg ih b ii ij ik il im in io ip jh ir is it ji iv iw ix jj iz ja jb jc hb bi translated"><strong class="ih hj"> \q </strong></p></blockquote><p id="365c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们创建数据目录:</p><blockquote class="jd je jf"><p id="bdde" class="if ig jg ih b ii ij ik il im in io ip jh ir is it ji iv iw ix jj iz ja jb jc hb bi translated"><strong class="ih hj">mkdir-p/var/lib/PostgreSQL/data/</strong></p><p id="29d1" class="if ig jg ih b ii ij ik il im in io ip jh ir is it ji iv iw ix jj iz ja jb jc hb bi translated"><strong class="ih hj">chmod 700/var/lib/PostgreSQL/data</strong></p></blockquote><p id="eaa6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们开始对初始负载进行基本备份:</p><blockquote class="jd je jf"><p id="b7cb" class="if ig jg ih b ii ij ik il im in io ip jh ir is it ji iv iw ix jj iz ja jb jc hb bi translated"><strong class="ih hj">pg _ base backup-h 172 . 17 . 0 . 4-D ./-U repl-W-P-R-S航空-X stream -W </strong></p></blockquote><p id="b51d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，我们可以配置恢复参数，但PostgreSQL版本12之后没有“recovery.conf”文件。它是合并的“postgresql.conf”文件。为了将集群置于待机模式，我们需要创建一个名为“standby.signal”的空文件。</p><p id="ba98" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">仅更改了“触发器文件”参数的名称，现在称为“升级触发器文件”，并删除了“待机模式”。其余的保持原样。</p><p id="670c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">PostgreSQL版本12之前(recovery.conf):</p><blockquote class="jd je jf"><p id="d700" class="if ig jg ih b ii ij ik il im in io ip jh ir is it ji iv iw ix jj iz ja jb jc hb bi translated"><strong class="ih hj">restore _ command = ' CP/var/lib/PostgreSQL/pg _ log _ archive/replica 1/% f % p '</strong></p><p id="5658" class="if ig jg ih b ii ij ik il im in io ip jh ir is it ji iv iw ix jj iz ja jb jc hb bi translated"><strong class="ih hj">恢复目标时间线= '最新'</strong></p><p id="f36f" class="if ig jg ih b ii ij ik il im in io ip jh ir is it ji iv iw ix jj iz ja jb jc hb bi translated"><strong class="ih hj">primary _ conn info = ' user = repl host = 172 . 17 . 0 . 2 port = 5432 SSL mode = prefer SSL compression = 1 krbsrvname = postgres target _ session _ attrs = any '</strong></p><p id="164d" class="if ig jg ih b ii ij ik il im in io ip jh ir is it ji iv iw ix jj iz ja jb jc hb bi translated"><strong class="ih hj">archive _ clean up _ command = ' pg _ archive clean up/var/lib/PostgreSQL/pg _ log _ archive/replica 1% r '</strong></p><p id="aaa7" class="if ig jg ih b ii ij ik il im in io ip jh ir is it ji iv iw ix jj iz ja jb jc hb bi translated"><strong class="ih hj">trigger _ file =/tmp/trigger</strong></p></blockquote><p id="d50f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在PostgreSQL版本12(postgresql.conf)之后:</p><blockquote class="jd je jf"><p id="add6" class="if ig jg ih b ii ij ik il im in io ip jh ir is it ji iv iw ix jj iz ja jb jc hb bi translated"><strong class="ih hj">restore _ command = ' CP/var/lib/PostgreSQL/pg _ log _ archive/replica 1/% f % p '</strong></p><p id="3072" class="if ig jg ih b ii ij ik il im in io ip jh ir is it ji iv iw ix jj iz ja jb jc hb bi translated"><strong class="ih hj">恢复目标时间线= '最新'</strong></p><p id="b7f1" class="if ig jg ih b ii ij ik il im in io ip jh ir is it ji iv iw ix jj iz ja jb jc hb bi translated"><strong class="ih hj">primary _ conn info = ' user = repl host = 172 . 17 . 0 . 4 port = 5432 password = 123123 SSL mode = prefere SSL compression = 1 krbsrvname = postgres target _ session _ attrs = any '</strong></p><p id="d654" class="if ig jg ih b ii ij ik il im in io ip jh ir is it ji iv iw ix jj iz ja jb jc hb bi translated"><strong class="ih hj">archive _ clean up _ command = ' pg _ archive clean up/var/lib/PostgreSQL/pg _ log _ archive/replica 1% r '</strong></p><p id="654c" class="if ig jg ih b ii ij ik il im in io ip jh ir is it ji iv iw ix jj iz ja jb jc hb bi translated"><strong class="ih hj">promote _ trigger _ file = '/tmp/promote '</strong></p><p id="8140" class="if ig jg ih b ii ij ik il im in io ip jh ir is it ji iv iw ix jj iz ja jb jc hb bi translated"><strong class="ih hj">主插槽名称= '空气'</strong></p></blockquote><p id="4b59" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为备用节点和将数据库置于备用模式的文件创建归档目录。</p><blockquote class="jd je jf"><p id="8e62" class="if ig jg ih b ii ij ik il im in io ip jh ir is it ji iv iw ix jj iz ja jb jc hb bi translated"><strong class="ih hj">mkdir-p/var/lib/PostgreSQL/pg _ log _ archive/replica 1</strong></p><p id="4ee0" class="if ig jg ih b ii ij ik il im in io ip jh ir is it ji iv iw ix jj iz ja jb jc hb bi translated"><strong class="ih hj">touch/var/lib/PostgreSQL/data/stand by . signal</strong></p></blockquote><p id="684e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">最后，我们可以启动stanby集群:</p><blockquote class="jd je jf"><p id="054c" class="if ig jg ih b ii ij ik il im in io ip jh ir is it ji iv iw ix jj iz ja jb jc hb bi translated"><strong class="ih hj">/usr/lib/PostgreSQL/14/bin/pg _ CTL-D/var/lib/PostgreSQL/data/start</strong></p></blockquote><figure class="jl jm jn jo fd jp er es paragraph-image"><div role="button" tabindex="0" class="jq jr di js bf jt"><div class="er es kp"><img src="../Images/9a0ccedc17ed3d92ea96f9f869af3582.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*n-Od7gfth8qhuNauS3XxwA.png"/></div></div></figure><p id="1d19" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在源系统上:</p><figure class="jl jm jn jo fd jp er es paragraph-image"><div role="button" tabindex="0" class="jq jr di js bf jt"><div class="er es kq"><img src="../Images/d9cd0b7725a3888b14aa27695e40669f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*a9XRXvkJt5-9DD2B-B4w1g.png"/></div></div></figure><p id="3327" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在目标系统系统上:</p><figure class="jl jm jn jo fd jp er es paragraph-image"><div role="button" tabindex="0" class="jq jr di js bf jt"><div class="er es kr"><img src="../Images/490b8a03b3bbbcfef29d919892844734.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XvRSoxl1pWHCTsWWtaFDwQ.png"/></div></div></figure><p id="bd2a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们可以随时在目标系统上创建“/tmp/promote”文件，将其提升为主系统:</p><blockquote class="jd je jf"><p id="f03d" class="if ig jg ih b ii ij ik il im in io ip jh ir is it ji iv iw ix jj iz ja jb jc hb bi translated"><strong class="ih hj">触摸/tmp/提升</strong></p></blockquote><figure class="jl jm jn jo fd jp er es paragraph-image"><div role="button" tabindex="0" class="jq jr di js bf jt"><div class="er es ks"><img src="../Images/8bf7da13a6bc41895c19bdbbd5ce4478.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*O6ZYB5ijNEt5aYejxusfwQ.png"/></div></div></figure><p id="f23a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，我能够在“旧的”备用系统上创建新的数据库:</p><figure class="jl jm jn jo fd jp er es paragraph-image"><div role="button" tabindex="0" class="jq jr di js bf jt"><div class="er es kt"><img src="../Images/715607328eeb565a11fa5602c18176e8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8aAZJHKhdx86XkvD95XRQQ.png"/></div></div></figure><p id="d3f9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">同时，我在主系统上创建了另一个数据库:</p><figure class="jl jm jn jo fd jp er es paragraph-image"><div role="button" tabindex="0" class="jq jr di js bf jt"><div class="er es ku"><img src="../Images/58a5882b5b7751401217328e342a905a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*O6vle9J3lmAXSVd4CyJZpQ.png"/></div></div></figure><p id="925c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">哦不！我们破坏了我们的复制😊。是否可以从上一个成功的检查点继续复制，并与主系统保持同步？是的，我们有像向导一样的“pg_rewind”😊。</p><figure class="jl jm jn jo fd jp er es paragraph-image"><div class="er es kv"><img src="../Images/f794232e2a47d03450a2e836d1eb240a.png" data-original-src="https://miro.medium.com/v2/resize:fit:672/format:webp/1*ivAWCQjAWxlvpBXObLYsrA.png"/></div></figure><p id="51d7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">首先，在目标系统上，我们需要停止PostgreSQL集群:</p><blockquote class="jd je jf"><p id="bf79" class="if ig jg ih b ii ij ik il im in io ip jh ir is it ji iv iw ix jj iz ja jb jc hb bi translated"><strong class="ih hj">/usr/lib/PostgreSQL/14/bin/pg _ CTL-D/var/lib/PostgreSQL/data/stop</strong></p></blockquote><figure class="jl jm jn jo fd jp er es paragraph-image"><div role="button" tabindex="0" class="jq jr di js bf jt"><div class="er es kw"><img src="../Images/3dee87c72236981011f8d8e3fb4e5eb2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Vm29PdUDRkFPBb45Y-EGmA.png"/></div></div></figure><p id="c56b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后，我们可以通过执行以下命令来继续均衡源和目标数据目录:</p><blockquote class="jd je jf"><p id="bb13" class="if ig jg ih b ii ij ik il im in io ip jh ir is it ji iv iw ix jj iz ja jb jc hb bi translated"><strong class="ih hj">/usr/lib/PostgreSQL/14/bin/pg _ rewind—target-pg data =/var/lib/PostgreSQL/data/—source-server = " host = 172 . 17 . 0 . 4 port = 5432 user = postgres password = my secret password dbname = postgres "</strong></p></blockquote><figure class="jl jm jn jo fd jp er es paragraph-image"><div role="button" tabindex="0" class="jq jr di js bf jt"><div class="er es kx"><img src="../Images/0b6a7f591b54f50a330b5854bf93052c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OYi7UgEPJv_7uAWhgHlHzA.png"/></div></div></figure><p id="852f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然而，目标系统上的配置与主系统相同。因此，我们需要配置我们的“postgresql.conf”文件，并创建和清空“standby.signal”。我们需要在“postgresql.conf”文件的末尾添加以下行:</p><blockquote class="jd je jf"><p id="8676" class="if ig jg ih b ii ij ik il im in io ip jh ir is it ji iv iw ix jj iz ja jb jc hb bi translated"><strong class="ih hj">restore _ command = ' CP/var/lib/PostgreSQL/pg _ log _ archive/replica 1/% f % p '</strong></p><p id="892e" class="if ig jg ih b ii ij ik il im in io ip jh ir is it ji iv iw ix jj iz ja jb jc hb bi translated"><strong class="ih hj">恢复目标时间线= '最新'</strong></p><p id="81a8" class="if ig jg ih b ii ij ik il im in io ip jh ir is it ji iv iw ix jj iz ja jb jc hb bi translated"><strong class="ih hj">primary _ conn info = ' user = repl host = 172 . 17 . 0 . 4 port = 5432 password = 123123 SSL mode = prefere SSL compression = 1 krbsrvname = postgres target _ session _ attrs = any '</strong></p><p id="8ff5" class="if ig jg ih b ii ij ik il im in io ip jh ir is it ji iv iw ix jj iz ja jb jc hb bi translated"><strong class="ih hj">archive _ clean up _ command = ' pg _ archive clean up/var/lib/PostgreSQL/pg _ log _ archive/replica 1% r '</strong></p><p id="08a2" class="if ig jg ih b ii ij ik il im in io ip jh ir is it ji iv iw ix jj iz ja jb jc hb bi translated"><strong class="ih hj">promote _ trigger _ file = '/tmp/promote '</strong></p><p id="ed10" class="if ig jg ih b ii ij ik il im in io ip jh ir is it ji iv iw ix jj iz ja jb jc hb bi translated"><strong class="ih hj">主插槽名称= '空气'</strong></p></blockquote><p id="7046" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">和</p><blockquote class="jd je jf"><p id="5c17" class="if ig jg ih b ii ij ik il im in io ip jh ir is it ji iv iw ix jj iz ja jb jc hb bi translated"><strong class="ih hj">CD/var/lib/PostgreSQL/data/</strong></p><p id="5831" class="if ig jg ih b ii ij ik il im in io ip jh ir is it ji iv iw ix jj iz ja jb jc hb bi translated"><strong class="ih hj">触摸待机信号</strong></p></blockquote><p id="9f35" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们再次启动standy system，并尝试在其上创建数据库:</p><blockquote class="jd je jf"><p id="b9d4" class="if ig jg ih b ii ij ik il im in io ip jh ir is it ji iv iw ix jj iz ja jb jc hb bi translated"><strong class="ih hj">/usr/lib/PostgreSQL/14/bin/pg _ CTL-D/var/lib/PostgreSQL/data/start</strong></p><p id="9590" class="if ig jg ih b ii ij ik il im in io ip jh ir is it ji iv iw ix jj iz ja jb jc hb bi translated"><strong class="ih hj">创建数据库e；</strong></p></blockquote><figure class="jl jm jn jo fd jp er es paragraph-image"><div role="button" tabindex="0" class="jq jr di js bf jt"><div class="er es ky"><img src="../Images/23d274647ce3746d9391ec7992940d42.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QMzcxmyU6Jf_XQzTi2YAMw.png"/></div></div></figure><p id="6745" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">最后，我们可以检查复制的状态。</p><p id="7ee9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在主系统上:</p><figure class="jl jm jn jo fd jp er es paragraph-image"><div role="button" tabindex="0" class="jq jr di js bf jt"><div class="er es kz"><img src="../Images/6eee45375fbe39ca9777f65399d4e0ea.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0QfMnTxoIebnm2x43PXUKQ.png"/></div></div></figure><p id="27ee" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在备用系统上:</p><figure class="jl jm jn jo fd jp er es paragraph-image"><div role="button" tabindex="0" class="jq jr di js bf jt"><div class="er es la"><img src="../Images/52e9b7e64bc46d0a6df6bbaebb05679a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yeZ16zrySC5Rf6VVM7Nebw.png"/></div></div></figure><p id="c1d1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果有什么问题，请让我知道！</p><p id="dcc7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">谢谢！</p></div></div>    
</body>
</html>