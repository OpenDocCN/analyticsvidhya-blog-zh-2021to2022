<html>
<head>
<title>Monitor all input data flowing into your ML models with a single AWS Lambda</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用一个AWS Lambda监控所有流入ML模型的输入数据</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/monitor-all-input-data-flowing-into-your-ml-models-with-a-single-aws-lambda-e702c5d21c28?source=collection_archive---------8-----------------------#2021-06-25">https://medium.com/analytics-vidhya/monitor-all-input-data-flowing-into-your-ml-models-with-a-single-aws-lambda-e702c5d21c28?source=collection_archive---------8-----------------------#2021-06-25</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><div class=""><h2 id="200b" class="pw-subtitle-paragraph ie hg hh bd b if ig ih ii ij ik il im in io ip iq ir is it iu iv dx translated">我们在Instapro构建的一个简单应用程序，用于检测和报告输入数据中的异常。</h2></div><p id="3d44" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated"><em class="js">作者:</em> <a class="ae jt" href="https://www.linkedin.com/in/pauvilarribo/" rel="noopener ugc nofollow" target="_blank"> <em class="js">保罗·维拉</em> </a> <em class="js">，数据科学家:Instapro </em>  <em class="js">。</em></p><figure class="jv jw jx jy fd jz er es paragraph-image"><div role="button" tabindex="0" class="ka kb di kc bf kd"><div class="er es ju"><img src="../Images/d54c05bc2bd5491f624902a209b1c703.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*hS19fJUUuW-eza0G"/></div></div><figcaption class="kg kh et er es ki kj bd b be z dx translated">帕特里克·罗伯特·道尔在<a class="ae jt" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><p id="64c8" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">当你和你的团队将机器学习模型部署到生产中时，你满意吗？是的，这很有意义。但是，部署后工作完成了吗？不应该啊！</p><p id="093f" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">有时我们会忘记一个健康的ML项目生命周期的最后一步:<strong class="iy hi">监控和可观察性</strong>。这是一个很大的主题，不仅包括及时监控模型的性能，还包括监控其他事情，如模型偏差、数据漂移、数据中断等。监控你的模型用来训练的数据是保持你的ML项目健康的关键。我们需要数据来训练模型。这些数据很可能是从数据库中检索出来的，然后进行处理，以便对其进行清理和/或创建额外的特征。在这些步骤中，许多事情都可能出错，因此有一种机制来检测生成的数据中的异常非常重要。</p><p id="dbed" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">在这篇文章中，我们将重点关注<strong class="iy hi">监控数据</strong>的质量，这些数据用于重新训练我们的模型，以及用于进行推理的数据:<strong class="iy hi">输入数据</strong>。</p><blockquote class="kk"><p id="2da4" class="kl km hh bd kn ko kp kq kr ks kt jr dx translated"><em class="ku">目标是主动检测输入数据中的异常，这些异常最终会降低模型的性能</em>。</p></blockquote><h1 id="2fa4" class="kv kw hh bd kx ky kz la lb lc ld le lf in lg io lh iq li ir lj it lk iu ll lm bi translated">架构概述</h1><p id="7a25" class="pw-post-body-paragraph iw ix hh iy b iz ln ii jb jc lo il je jf lp jh ji jj lq jl jm jn lr jp jq jr ha bi translated">在Instapro，我们将与每个ML项目相关的所有文件存储在一个<strong class="iy hi"> S3桶</strong>中。这包括包含不同模型将用于训练和推断的数据的文件。在大多数项目中，这些数据是从ETL应用程序生成的CSV文件(通常由cron schedule表达式触发)。例如，如果我们决定每周重新训练一次某个模型，ETL应用程序将每周生成新的训练数据。这个新的训练数据将从通讯项目上传到S3桶。</p><p id="69fc" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">我们有兴趣对上传到S3的新数据进行评估。在<strong class="iy hi"> AWS Lambda </strong>中，您可以设置许多类型的触发器，其中一个触发器是将操作放入S3桶。这个PUT操作将向Lambda发送一个事件通知，应用程序将开始运行。</p><p id="f18d" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">Lambda函数包含用于生成我们称之为<em class="js">的数据质量报告</em>的代码，以及一组规则，如果违反了这些规则，就会触发警报。</p><figure class="jv jw jx jy fd jz er es paragraph-image"><div role="button" tabindex="0" class="ka kb di kc bf kd"><div class="er es ls"><img src="../Images/889eabfe63f68427b93a06154bafaecb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tl_JuNSZGNAq0acJufFlXA.png"/></div></div><figcaption class="kg kh et er es ki kj bd b be z dx translated">应用程序架构图</figcaption></figure><h1 id="5240" class="kv kw hh bd kx ky kz la lb lc ld le lf in lt io lh iq lu ir lj it lv iu ll lm bi translated">创造必要的资源</h1><p id="19f5" class="pw-post-body-paragraph iw ix hh iy b iz ln ii jb jc lo il je jf lp jh ji jj lq jl jm jn lr jp jq jr ha bi translated">对于这个应用程序，你只需要有一个S3桶，当你的数据生成时，它将被上传<strong class="iy hi"> </strong>和一个包含代码的Lambda函数。</p><p id="7c19" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">有三种方法可以创建这些资源:使用AWS CLI、使用AWS SDK for Python (Boto3)或直接从AWS控制台创建。在本练习中，为了简单起见，我们只从控制台显示内容，但是您可能希望使用CloudFormation这样的工具来管理您构建的所有资源。</p><p id="c640" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">在创建了S3桶和Lambda函数之后，让我们添加触发器。这些触发器是事件通知，它们会将一些信息传递给Lambda，然后它会被执行。</p><p id="bd55" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">以下是一个事件通知的示例:</p><pre class="jv jw jx jy fd lw lx ly lz aw ma bi"><span id="fe71" class="mb kw hh lx b fi mc md l me mf">{<br/>   "Records":[<br/>      {<br/>         "s3":{<br/>            "bucket":{<br/>               "name":"my-ml-project-bucket"<br/>            },<br/>            "object":{<br/>               "key":"input-training.csv"<br/>            }<br/>         }<br/>      }<br/>   ]<br/>}</span></pre><p id="045c" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">该事件采用JSON格式，包含触发该事件的存储桶的信息，以及上传到该存储桶的对象(CSV文件)的信息。</p><p id="707b" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">触发类型将是S3。然后，您可以指定存储桶名称。在事件类型中，我们指定了PUT操作，因为我们对在上传对象时触发Lambda感兴趣。我们可以添加一个前缀和一个后缀，这样Lambda只有在上传的对象匹配您的过滤器时才会被触发。我们对对应于不同ML项目的每个S3桶做同样的事情。</p><figure class="jv jw jx jy fd jz er es paragraph-image"><div role="button" tabindex="0" class="ka kb di kc bf kd"><div class="er es mg"><img src="../Images/aa6120facdda61ab99c02e7967bcea9e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CtvSLp2Lx19Cc2MvSWfkCg.png"/></div></div></figure><h1 id="edae" class="kv kw hh bd kx ky kz la lb lc ld le lf in lt io lh iq lu ir lj it lv iu ll lm bi translated">分步代码演练</h1><p id="cdb6" class="pw-post-body-paragraph iw ix hh iy b iz ln ii jb jc lo il je jf lp jh ji jj lq jl jm jn lr jp jq jr ha bi translated">如前所述，这个应用程序只是一个Lambda函数，所以所有代码都位于一个Python脚本中。</p><h2 id="5e79" class="mb kw hh bd kx mh mi mj lb mk ml mm lf jf mn mo lh jj mp mq lj jn mr ms ll mt bi translated">必需的库</h2><figure class="jv jw jx jy fd jz er es paragraph-image"><div role="button" tabindex="0" class="ka kb di kc bf kd"><div class="er es mu"><img src="../Images/75a8fd3365cc58152e4a2f7a1436258c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UCUkiqNzeVe1S_sJD3FvqQ.png"/></div></div></figure><h2 id="efa9" class="mb kw hh bd kx mh mi mj lb mk ml mm lf jf mn mo lh jj mp mq lj jn mr ms ll mt bi translated">主要功能</h2><p id="7244" class="pw-post-body-paragraph iw ix hh iy b iz ln ii jb jc lo il je jf lp jh ji jj lq jl jm jn lr jp jq jr ha bi translated">lambda处理函数(代码如下)以JSON格式接收来自S3事件通知的事件。我们从该事件中需要的信息是S3存储桶的名称和上传文件的密钥(文件路径和文件名)。根据这些信息，我们遵循以下步骤:</p><ol class=""><li id="fa9d" class="mv mw hh iy b iz ja jc jd jf mx jj my jn mz jr na nb nc nd bi translated">加载包含将要分析的数据的CSV文件。</li><li id="ded5" class="mv mw hh iy b iz ne jc nf jf ng jj nh jn ni jr na nb nc nd bi translated">生成包含数据中每个要素的描述性统计数据、缺失值信息和唯一值信息的报告。</li><li id="2584" class="mv mw hh iy b iz ne jc nf jf ng jj nh jn ni jr na nb nc nd bi translated">生成一条消息(字符串),包含数据检查过程中发现的见解。如果违反了任何数据质量规则，变量<code class="du nj nk nl lx b">notify </code>将采用一个<code class="du nj nk nl lx b">True</code>值。</li><li id="b34c" class="mv mw hh iy b iz ne jc nf jf ng jj nh jn ni jr na nb nc nd bi translated">如果在数据中检测到异常，将通知发布到松弛通道，以便团队可以进一步调查。</li><li id="d36e" class="mv mw hh iy b iz ne jc nf jf ng jj nh jn ni jr na nb nc nd bi translated">将生成的报表保存回同一个S3时段。</li></ol><figure class="jv jw jx jy fd jz"><div class="bz dy l di"><div class="nm nn l"/></div></figure><h2 id="4d26" class="mb kw hh bd kx mh mi mj lb mk ml mm lf jf mn mo lh jj mp mq lj jn mr ms ll mt bi translated">根据描述性统计数据、缺失值和唯一值生成包含要素级别信息的报告。</h2><p id="2dca" class="pw-post-body-paragraph iw ix hh iy b iz ln ii jb jc lo il je jf lp jh ji jj lq jl jm jn lr jp jq jr ha bi translated">我们现在定义一个名为<code class="du nj nk nl lx b">generate_report()</code>的函数，该函数为数据中的每个要素生成一个包含以下信息的数据集:</p><ul class=""><li id="2df8" class="mv mw hh iy b iz ja jc jd jf mx jj my jn mz jr no nb nc nd bi translated">数据中的行数</li><li id="ab81" class="mv mw hh iy b iz ne jc nf jf ng jj nh jn ni jr no nb nc nd bi translated">数据类型</li><li id="9b2a" class="mv mw hh iy b iz ne jc nf jf ng jj nh jn ni jr no nb nc nd bi translated">缺失值的数量和百分比</li><li id="5e18" class="mv mw hh iy b iz ne jc nf jf ng jj nh jn ni jr no nb nc nd bi translated">数字特征的描述性统计(平均值、标准差、最大值和最小值)。</li></ul><figure class="jv jw jx jy fd jz"><div class="bz dy l di"><div class="nm nn l"/></div></figure><p id="727f" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">在下图中，您可以看到由上述函数生成的报告(描述性统计数据中带有NaNs的要素是分类变量或字符串变量):</p><figure class="jv jw jx jy fd jz er es paragraph-image"><div role="button" tabindex="0" class="ka kb di kc bf kd"><div class="er es np"><img src="../Images/aab6d52ced8bd38e8cf83665aaaff69b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BaDkFEn8fMQbe102QPf7pw.png"/></div></div></figure><h2 id="a369" class="mb kw hh bd kx mh mi mj lb mk ml mm lf jf mn mo lh jj mp mq lj jn mr ms ll mt bi translated">定义质量规则，并创建一条包含检测到的任何中断信息的消息。</h2><p id="eedf" class="pw-post-body-paragraph iw ix hh iy b iz ln ii jb jc lo il je jf lp jh ji jj lq jl jm jn lr jp jq jr ha bi translated">您可以在这个函数中找到两个基本规则来检测:</p><ul class=""><li id="fc70" class="mv mw hh iy b iz ja jc jd jf mx jj my jn mz jr no nb nc nd bi translated"><strong class="iy hi">缺少值的列</strong>。在这里，我们检测是否有任何列超过了由<code class="du nj nk nl lx b">missing_values_threshold</code>定义的丢失值的允许百分比。</li><li id="2f43" class="mv mw hh iy b iz ne jc nf jf ng jj nh jn ni jr no nb nc nd bi translated"><strong class="iy hi">只有一个唯一值的列</strong>。例如，如果在某个时候缺失值被填充为0，就会发生这种情况，如果某个要素的所有缺失值现在都是0。</li></ul><p id="9739" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">从上一步生成的报告中，您已经可以看到有两个特性包含缺失值(<code class="du nj nk nl lx b">feautre_2</code>和<code class="du nj nk nl lx b">feature_5</code>)。另外，还有一个特性只有一个唯一的值(<code class="du nj nk nl lx b">feature_11</code>)。在下一个函数中，我们将运行一些检查，并检测这些情况。</p><figure class="jv jw jx jy fd jz"><div class="bz dy l di"><div class="nm nn l"/></div></figure><h2 id="2951" class="mb kw hh bd kx mh mi mj lb mk ml mm lf jf mn mo lh jj mp mq lj jn mr ms ll mt bi translated">如果违反了一条或多条规则，创建一条将在Slack中发布的消息。</h2><p id="ca2c" class="pw-post-body-paragraph iw ix hh iy b iz ln ii jb jc lo il je jf lp jh ji jj lq jl jm jn lr jp jq jr ha bi translated">在消息中，我们包括S3存储桶名称和从中检测到异常的CSV文件名。我们还提供了数据质量报告的链接，可用于调查问题的根源。</p><figure class="jv jw jx jy fd jz"><div class="bz dy l di"><div class="nm nn l"/></div></figure><p id="a2b8" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">下面是将发布到所选闲置渠道的通知示例。</p><figure class="jv jw jx jy fd jz er es paragraph-image"><div role="button" tabindex="0" class="ka kb di kc bf kd"><div class="er es nq"><img src="../Images/a9a114fef8502a5c46defa7ff56fca2b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gG7U143ujCJP9ubl4gNQ6A.png"/></div></div></figure></div><div class="ab cl nr ns go nt" role="separator"><span class="nu bw bk nv nw nx"/><span class="nu bw bk nv nw nx"/><span class="nu bw bk nv nw"/></div><div class="ha hb hc hd he"><h2 id="2189" class="mb kw hh bd kx mh mi mj lb mk ml mm lf jf mn mo lh jj mp mq lj jn mr ms ll mt bi translated"><em class="ku">其他注意事项</em></h2><ul class=""><li id="c802" class="mv mw hh iy b iz ln jc lo jf ny jj nz jn oa jr no nb nc nd bi translated">你的Lambda需要有<strong class="iy hi">权限</strong>才能访问S3并进行读写操作。</li><li id="66b4" class="mv mw hh iy b iz ne jc nf jf ng jj nh jn ni jr no nb nc nd bi translated">您可能需要在AWS Lambda中创建一个新的<strong class="iy hi">层</strong>,其中包含为运行Lambda函数的AMI Linux机器编译的依赖项。</li><li id="fda2" class="mv mw hh iy b iz ne jc nf jf ng jj nh jn ni jr no nb nc nd bi translated">细化<strong class="iy hi">规则</strong>并使其适应不同项目的要求。与PO和团队讨论为不同的项目或功能设置不同的缺失值<strong class="iy hi">阈值</strong>。</li><li id="ea70" class="mv mw hh iy b iz ne jc nf jf ng jj nh jn ni jr no nb nc nd bi translated"><a class="ae jt" href="https://api.slack.com/start/overview#creating" rel="noopener ugc nofollow" target="_blank">创建一个能够从Python发布消息的Slack应用</a>。<a class="ae jt" href="https://api.slack.com/messaging/sending" rel="noopener ugc nofollow" target="_blank">更多详情请登陆官方网站</a>。</li></ul></div><div class="ab cl nr ns go nt" role="separator"><span class="nu bw bk nv nw nx"/><span class="nu bw bk nv nw nx"/><span class="nu bw bk nv nw"/></div><div class="ha hb hc hd he"><p id="77d1" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">感谢阅读:)</p><p id="2e41" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated"><em class="js">如果你对我们在Instapro集团所做的ML工作有兴趣，请查看我们目前在不同国家的职位空缺:</em> <a class="ae jt" href="https://www.careersatwerkspot.com/vacancies/" rel="noopener ugc nofollow" target="_blank"> <em class="js">【荷兰】</em></a><em class="js"/><a class="ae jt" href="https://www.welcometothejungle.com/fr/companies/travaux-com/jobs" rel="noopener ugc nofollow" target="_blank"><em class="js">法国</em> </a> <em class="js">和</em> <a class="ae jt" href="https://myhammer.jobs.personio.de/" rel="noopener ugc nofollow" target="_blank"> <em class="js">德国</em> </a> <em class="js">。</em></p></div></div>    
</body>
</html>