<html>
<head>
<title>Azure Automated ML Rest API with probabilities of predicted classes</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Azure自动化ML Rest API，带有预测类的概率</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/azure-automated-ml-rest-api-with-probabilities-of-predicted-classes-21bf6fd298ab?source=collection_archive---------5-----------------------#2021-08-13">https://medium.com/analytics-vidhya/azure-automated-ml-rest-api-with-probabilities-of-predicted-classes-21bf6fd298ab?source=collection_archive---------5-----------------------#2021-08-13</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><h1 id="9637" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated">使用自定义分数脚本部署REST API</h1><h1 id="8920" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated">步伐</h1><ul class=""><li id="07dd" class="jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt bi translated">创建自动化的ML运行</li><li id="b6ab" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">现在导航到最佳模型</li><li id="1bd4" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">转到输出/日志，选择输出并下载model.pkl</li><li id="e4a8" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">也下载乐谱文件</li><li id="c9d8" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">编辑乐谱文件</li></ul><pre class="jz ka kb kc fd kd ke kf kg aw kh bi"><span id="2491" class="ki if hh ke b fi kj kk l kl km"># ---------------------------------------------------------<br/># Copyright (c) Microsoft Corporation. All rights reserved.<br/># ---------------------------------------------------------<br/>import json<br/>import logging<br/>import os<br/>import pickle<br/>import numpy as np<br/>import pandas as pd<br/>import joblib</span><span id="2729" class="ki if hh ke b fi kn kk l kl km">import azureml.automl.core<br/>from azureml.automl.core.shared import logging_utilities, log_server<br/>from azureml.telemetry import INSTRUMENTATION_KEY</span><span id="9831" class="ki if hh ke b fi kn kk l kl km">from inference_schema.schema_decorators import input_schema, output_schema<br/>from inference_schema.parameter_types.numpy_parameter_type import NumpyParameterType<br/>from inference_schema.parameter_types.pandas_parameter_type import PandasParameterType<br/>from inference_schema.parameter_types.standard_py_parameter_type import StandardPythonParameterType</span><span id="f70b" class="ki if hh ke b fi kn kk l kl km">data_sample = PandasParameterType(pd.DataFrame({"PassengerId": pd.Series([0], dtype="int64"), "Pclass": pd.Series([0], dtype="int64"), "Name": pd.Series(["example_value"], dtype="object"), "Sex": pd.Series(["example_value"], dtype="object"), "Age": pd.Series([0.0], dtype="float64"), "SibSp": pd.Series([0], dtype="int64"), "Parch": pd.Series([0], dtype="int64"), "Ticket": pd.Series(["example_value"], dtype="object"), "Fare": pd.Series([0.0], dtype="float64"), "Cabin": pd.Series(["example_value"], dtype="object"), "Embarked": pd.Series(["example_value"], dtype="object")}))<br/>input_sample = StandardPythonParameterType({'data': data_sample})</span><span id="8125" class="ki if hh ke b fi kn kk l kl km">result_sample = NumpyParameterType(np.array([0]))<br/>output_sample = StandardPythonParameterType({'Results':result_sample})</span><span id="f191" class="ki if hh ke b fi kn kk l kl km">try:<br/>    log_server.enable_telemetry(INSTRUMENTATION_KEY)<br/>    log_server.set_verbosity('INFO')<br/>    logger = logging.getLogger('azureml.automl.core.scoring_script_v2')<br/>except:<br/>    pass<br/></span><span id="7616" class="ki if hh ke b fi kn kk l kl km">def init():<br/>    global model<br/>    # This name is model.id of model that we want to deploy deserialize the model file back<br/>    # into a sklearn model<br/>    model_path = os.path.join(os.getenv('AZUREML_MODEL_DIR'), 'model.pkl')<br/>    path = os.path.normpath(model_path)<br/>    path_split = path.split(os.sep)<br/>    log_server.update_custom_dimensions({'model_name': path_split[-3], 'model_version': path_split[-2]})<br/>    try:<br/>        logger.info("Loading model from path.")<br/>        model = joblib.load(model_path)<br/>        logger.info("Loading successful.")     <br/>    except Exception as e:<br/>        logging_utilities.log_traceback(e, logger)<br/>        raise</span><span id="cc9f" class="ki if hh ke b fi kn kk l kl km">@input_schema('Inputs', input_sample)<br/>@output_schema(output_sample)<br/>def run(Inputs):<br/>    data = Inputs['data']<br/>    result = model.predict_proba(data)<br/>    return result.tolist()<br/></span></pre><ul class=""><li id="18b8" class="jc jd hh je b jf ko jh kp jj kq jl kr jn ks jp jq jr js jt bi translated">现在如果你想在jupyter笔记本上手动测试</li><li id="efe6" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">将model.pkl文件上传到jupyterlab文件夹</li><li id="b62f" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">创建一个样本titanic4.json文件，并在下面添加这些内容</li></ul><pre class="jz ka kb kc fd kd ke kf kg aw kh bi"><span id="3c36" class="ki if hh ke b fi kj kk l kl km">[{"PassengerId":"1","Pclass":"3","Name":"Braund Mr. Owen Harris","Sex":"male","Age":"40","SibSp":"1","Parch":"0","Ticket":"A/5 21171","Fare":"7.25","Cabin":"c","Embarked":"S"},<br/>{"PassengerId":"1","Pclass":"3","Name":"Braund Mr. Owen Harris","Sex":"female","Age":"40","SibSp":"1","Parch":"0","Ticket":"A/5 21171","Fare":"7.25","Cabin":"c","Embarked":"S"},<br/>{"PassengerId":"1","Pclass":"3","Name":"Braund Mr. Owen Harris","Sex":"male","Age":"40","SibSp":"1","Parch":"0","Ticket":"A/5 21171","Fare":"7.25","Cabin":"c","Embarked":"S"},<br/>{"PassengerId":"1","Pclass":"3","Name":"Braund Mr. Owen Harris","Sex":"female","Age":"40","SibSp":"1","Parch":"0","Ticket":"A/5 21171","Fare":"7.25","Cabin":"c","Embarked":"S"},<br/>{"PassengerId":"1","Pclass":"3","Name":"Braund Mr. Owen Harris","Sex":"male","Age":"40","SibSp":"1","Parch":"0","Ticket":"A/5 21171","Fare":"7.25","Cabin":"c","Embarked":"S"}]</span></pre><h1 id="82d3" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated">批量或手动评分</h1><ul class=""><li id="e781" class="jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt bi translated">创建新笔记本</li></ul><pre class="jz ka kb kc fd kd ke kf kg aw kh bi"><span id="6a89" class="ki if hh ke b fi kj kk l kl km">import json<br/>import logging<br/>import os<br/>import pickle<br/>import numpy as np<br/>import pandas as pd<br/>import joblib</span><span id="7139" class="ki if hh ke b fi kn kk l kl km">import azureml.automl.core<br/>from azureml.automl.core.shared import logging_utilities, log_server<br/>from azureml.telemetry import INSTRUMENTATION_KEY</span></pre><ul class=""><li id="3c00" class="jc jd hh je b jf ko jh kp jj kq jl kr jn ks jp jq jr js jt bi translated">加载模型</li></ul><pre class="jz ka kb kc fd kd ke kf kg aw kh bi"><span id="45b8" class="ki if hh ke b fi kj kk l kl km">model = joblib.load('model.pkl')</span></pre><ul class=""><li id="6f57" class="jc jd hh je b jf ko jh kp jj kq jl kr jn ks jp jq jr js jt bi translated">将json数据文件titanic4.json上传到jupyterlab目录</li></ul><pre class="jz ka kb kc fd kd ke kf kg aw kh bi"><span id="f281" class="ki if hh ke b fi kj kk l kl km">import pandas as pd<br/>data = pd.read_json ('titanic4.json')</span></pre><ul class=""><li id="15a9" class="jc jd hh je b jf ko jh kp jj kq jl kr jn ks jp jq jr js jt bi translated">预测产量</li></ul><pre class="jz ka kb kc fd kd ke kf kg aw kh bi"><span id="9104" class="ki if hh ke b fi kj kk l kl km">result = model.predict_proba(data)</span></pre><ul class=""><li id="c52e" class="jc jd hh je b jf ko jh kp jj kq jl kr jn ks jp jq jr js jt bi translated">现在将数据转换成数组</li></ul><pre class="jz ka kb kc fd kd ke kf kg aw kh bi"><span id="9e44" class="ki if hh ke b fi kj kk l kl km">df = data.to_numpy()</span></pre><ul class=""><li id="f051" class="jc jd hh je b jf ko jh kp jj kq jl kr jn ks jp jq jr js jt bi translated">现在显示所有的概率</li></ul><pre class="jz ka kb kc fd kd ke kf kg aw kh bi"><span id="b546" class="ki if hh ke b fi kj kk l kl km">for i in range(len(df)):<br/>    print("X=%s, Predicted=%s" % (df[i], result[i]))</span></pre><h1 id="8169" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated">RESP API部署</h1><ul class=""><li id="66f8" class="jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt bi translated">创建aks集群</li><li id="b5af" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">至少需要12个内核</li><li id="afe3" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">部署带有定制配置的自动化ML模型</li><li id="5200" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">乐谱环境和乐谱文件位于名为RESTScoreFiles文件夹中</li><li id="7a60" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">部署rest服务</li><li id="c8ab" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">将需要几分钟时间</li><li id="1fb0" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">部署成功后，测试服务</li><li id="0137" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">抽样资料</li></ul><pre class="jz ka kb kc fd kd ke kf kg aw kh bi"><span id="4e12" class="ki if hh ke b fi kj kk l kl km">PassengerId,Pclass,Name,Sex,Age,SibSp,Parch,Ticket,Fare,Cabin,Embarked<br/>1,3,Braund Mr. Owen Harris,male,22,1,0,A/5 21171,7.25,null,S</span></pre><ul class=""><li id="4a64" class="jc jd hh je b jf ko jh kp jj kq jl kr jn ks jp jq jr js jt bi translated">下图应该显示概率</li></ul><figure class="jz ka kb kc fd ku er es paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="er es kt"><img src="../Images/c0a1d8519a076c0356c36004bebfdfbe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*Y8biK0SXi_z0YuFl.jpg"/></div></div></figure><p id="74e0" class="pw-post-body-paragraph lb lc hh je b jf ko ld le jh kp lf lg jj lh li lj jl lk ll lm jn ln lo lp jp ha bi translated">原文—<a class="ae lq" href="https://github.com/balakreshnan/Samples2021/blob/main/AutoML/probscore.md" rel="noopener ugc nofollow" target="_blank">samples 2021/probscore . MD at main balakreshnan/samples 2021(github.com)</a></p></div></div>    
</body>
</html>