<html>
<head>
<title>Altair Interactive Multi-Line Chart</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">牛郎星交互式多线图</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/altair-interactive-multi-line-chart-59a29c9287d?source=collection_archive---------1-----------------------#2021-03-05">https://medium.com/analytics-vidhya/altair-interactive-multi-line-chart-59a29c9287d?source=collection_archive---------1-----------------------#2021-03-05</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="0e7f" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">将图例绑定到股票收盘价的多行显示。为选定的纸张添加工具提示行和文本。</h2></div><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es ix"><img src="../Images/5d2519a2150e41f3e359fcafe4dc82ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*Lqb2IhIud8kNuBQ6D0RtlQ.gif"/></div></div></figure><p id="4077" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">我最近看到BI elite的Parker Stevens用一个非常巧妙的技巧在Power BI中创建了一个股票图表。这里 可以看<a class="ae kf" href="https://www.youtube.com/watch?v=_GOIflxSlYI" rel="noopener ugc nofollow" target="_blank"> <strong class="jl hj">。我发现非常有趣的是，无论是在Power Query还是Power View中，Python库中用于清理和可视化数据的许多概念都可以转移到Power BI上，反之亦然。</strong></a></p><p id="2f6c" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">以上面在Altair (Python可视化库)中创建的图表为例。在Altair中，您可以分解图表的各种元素，在独立单元中基于底层数据构建它们，然后将它们分层并连接起来。你可以把它们放在一起或放在一起，就像放拼图玩具一样，直到它们合为一体。</p><p id="7259" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">在Altair中创建可视化效果最重要的一点是，你可以将图形的样式，无论是线形、散点形还是条形(称为标记),从数据的无可争议的编码中分离出来，这些编码可以是分类的(名义的或有序的),也可以是定量的或时间的等等。</p><p id="12e7" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">在Power BI中，您将看到Parker将一个可视化图形叠加在另一个图形上，根据可定制的选择一次突出显示一个股票折线图。其余的股票退入背景，因为他们是灰色的。由沿x轴滚动的工具提示行提供“<strong class="jl hj">按需细节”</strong>。我们将使用Pandas和Altair从本文中的原始数据生成这个非常生动的图形。</p><p id="e26d" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">在本文中，我们将对图表和文本、工具提示行和图像进行分层，并对它们进行定位，使它们紧密地结合在一起，形成如上图所示的图表。</p><p id="7951" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated"><strong class="jl hj">安装</strong></p><blockquote class="kg kh ki"><p id="020b" class="jj jk kj jl b jm jn ij jo jp jq im jr kk jt ju jv kl jx jy jz km kb kc kd ke hb bi translated">使用以下命令在<strong class="jl hj"> Jupyter笔记本</strong>单元格中检索用于创建图表的Python包及其版本:</p><p id="6435" class="jj jk kj jl b jm jn ij jo jp jq im jr kk jt ju jv kl jx jy jz km kb kc kd ke hb bi translated">% reload _ ext watermark<br/>% watermark-v-m-p熊猫，牛郎星，numpy，织女星_数据集</p></blockquote><pre class="iy iz ja jb fd kn ko kp kq aw kr bi"><span id="f7f8" class="ks kt hi ko b fi ku kv l kw kx">CPython 3.7.7<br/>IPython 7.19.0</span><span id="e952" class="ks kt hi ko b fi ky kv l kw kx">pandas 1.1.0<br/>altair 4.1.0<br/>numpy 1.19.1<br/>vega_datasets 0.8.0</span></pre><h2 id="d15b" class="ks kt hi bd kz la lb lc ld le lf lg lh js li lj lk jw ll lm ln ka lo lp lq lr bi translated"><strong class="ak">数据</strong></h2><p id="67a0" class="pw-post-body-paragraph jj jk hi jl b jm ls ij jo jp lt im jr js lu ju jv jw lv jy jz ka lw kc kd ke hb bi translated">数据由<a class="ae kf" href="https://www.marketwatch.com/investing/stock/msft?mod=mw_quote_switch" rel="noopener ugc nofollow" target="_blank"><strong class="jl hj">market watch</strong></a><strong class="jl hj">慷慨提供。</strong></p><pre class="iy iz ja jb fd kn ko kp kq aw kr bi"><span id="0ed7" class="ks kt hi ko b fi ku kv l kw kx">* Change ticker for every stock you want historical data for<br/>* In the menu, select Historic Quotes<br/>* Change calendar to retrieve data for up to one year<br/>* Update results<br/>* Download the CSV</span></pre><p id="ed00" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated"><strong class="jl hj">清理和准备数据的代码:</strong></p><p id="42e4" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">将下载的文件合并到一个名为data(相对路径)的文件夹后，Pandas用于读取excel文件。清理数据以设置正确的类型，并删除分析不需要的列。使用这里看到的代码添加了额外的必需列，如股票名称(使用正则表达式从文件名派生而来)和滚动平均值。</p><pre class="iy iz ja jb fd kn ko kp kq aw kr bi"><span id="6edc" class="ks kt hi ko b fi ku kv l kw kx">#Pick out the stock name from the filename<br/>pattern = “.*_(.*)\.csv”<br/>cpat = re.compile(pattern)<br/>stock = re.findall(cpat,filename)<br/>df = pd.read_csv(f”data\{filename}”)<br/> <br/>#Add the stock name to the dataframe<br/>df[‘stock’] = stock[0]</span></pre><figure class="iy iz ja jb fd jc"><div class="bz dy l di"><div class="lx ly l"/></div></figure><p id="a389" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated"><strong class="jl hj">注意</strong>:您可以在这里 找到关于滚动窗口功能<a class="ae kf" href="https://towardsdatascience.com/dont-miss-out-on-rolling-window-functions-in-pandas-850b817131db" rel="noopener" target="_blank"> <strong class="jl hj">使用的详细信息，</strong></a></p><p id="87e4" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">我们正在创建一个新的列“rolling_mean ”,它采用一个窗口内收盘价的移动平均值。为此，我们申请。滚动(2)。mean()到Close列，在这里我们指定窗口“2”并计算数据帧中每个窗口的平均值。每一行得到的“滚动平均值”等于其“关闭<em class="kj">”值加上前一行的“关闭</em>”除以2(窗口)。本质上就是移动Avg = ([t] + [t-1]) / 2。</p><p id="5c69" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">我们还将min_periods=1添加到该方法中，这将窗口中有效观察的最小所需数量从2减少到1。这有助于我们避免第一行中的NaN，否则窗口大小为2会导致NaN。</p><p id="0702" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated"><strong class="jl hj">最终数据帧</strong></p><figure class="iy iz ja jb fd jc er es paragraph-image"><div class="ab fe cl lz"><img src="../Images/6eed87eded28a9b8929b252e548638cc.png" data-original-src="https://miro.medium.com/v2/format:webp/1*8Vlr8Z1M00YuFupBuLWysw.png"/></div></figure><h2 id="6083" class="ks kt hi bd kz la lb lc ld le lf lg lh js li lj lk jw ll lm ln ka lo lp lq lr bi translated">牛郎星优化用<a class="ae kf" href="https://altair-viz.github.io/user_guide/data_transformers.html" rel="noopener ugc nofollow" target="_blank"> <strong class="ak"> JSON缓存</strong> </a></h2><blockquote class="kg kh ki"><p id="9f7c" class="jj jk kj jl b jm jn ij jo jp jq im jr kk jt ju jv kl jx jy jz km kb kc kd ke hb bi translated">alt . data _ transformers . enable(' JSON ')</p></blockquote><p id="3b36" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">在我们开始创建可视化之前，让我们先讨论一下包含这段代码所获得的性能。通过这段代码，我们使用的Pandas数据帧被净化、序列化并以json格式存储，如下所示。<a class="ae kf" href="https://altair-viz.github.io/" rel="noopener ugc nofollow" target="_blank"> Altair </a>毕竟是一个Python API，用于构建基于Vega-lites可视化语法的统计可视化。由于缓存，数据帧的转换加快了渲染过程。</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es ma"><img src="../Images/5d40a959a8c642741cb43fba01faac2b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*iKnHVINo5i8ZCwGPHQ8eIw.png"/></div></div></figure><h2 id="2905" class="ks kt hi bd kz la lb lc ld le lf lg lh js li lj lk jw ll lm ln ka lo lp lq lr bi translated"><strong class="ak">生成图表</strong></h2><p id="7fe1" class="pw-post-body-paragraph jj jk hi jl b jm ls ij jo jp lt im jr js lu ju jv jw lv jy jz ka lw kc kd ke hb bi translated">代码中点缀着注释，解释对数据进行编码的各种元素，并创建标记来绘制数据。值得注意的元素是折线图和代表股票选择的圆形图之间的结合。selection_multi函数的“fields”参数将这些联系在一起。</p><p id="ca2b" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">alt.condition Altair函数是“If”条件，我们需要在选择股票时选择性地显示颜色和价格的工具提示文本。Altair的transform_filters功能将数据框缩小到所选的股票和x轴上的“最近”日期。</p><figure class="iy iz ja jb fd jc"><div class="bz dy l di"><div class="lx ly l"/></div></figure><p id="fd6d" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">输出是在文章顶部看到的图表，其中只有选中的股票用彩色绘制，工具提示显示其价格，而其余的用灰色发送到背景。</p><p id="cfa3" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">分层运算符“+”或alt.layer，用“|”(管道运算符)或alt并排串联。HConcatChart和垂直串联“&amp;”或alt。VConcatChart都被用在一行代码中，将所有的元素放在一起！进一步学习的文档和例子在这里是<a class="ae kf" href="https://altair-viz.github.io/user_guide/compound_charts.html" rel="noopener ugc nofollow" target="_blank"> <strong class="jl hj">。</strong>T3】</a></p><h2 id="01d0" class="ks kt hi bd kz la lb lc ld le lf lg lh js li lj lk jw ll lm ln ka lo lp lq lr bi translated">用牛郎星还是熊猫进行数据操作？</h2><h2 id="cebc" class="ks kt hi bd kz la lb lc ld le lf lg lh js li lj lk jw ll lm ln ka lo lp lq lr bi translated">选择权在你！</h2><p id="9415" class="pw-post-body-paragraph jj jk hi jl b jm ls ij jo jp lt im jr js lu ju jv jw lv jy jz ka lw kc kd ke hb bi translated">在上面的代码中，我们通过使用“，”领略了Altair对数据集的操作。transform_filter(radio_select)”。数据框缩小到包含由选择指示的股票的行。但是Altair还有其他几个强大的转换功能。</p><p id="53e5" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">在下面的代码中，上面使用的选择元素被丢弃，取而代之的是悬停选择，它允许我们创建一个工具提示，显示工具提示所在的日期以及该日期所有股票的价格。这里我们看到了另一个Altair转换函数的强大之处——transform _ pivot，对于每只股票，它将收盘滚动平均值聚合到一个日期(工具提示沿x轴显示)。</p><p id="3b69" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">这些转换函数的优势在于，您不必为要在图表中显示的每个聚合创建额外的数据框架。</p><pre class="iy iz ja jb fd kn ko kp kq aw kr bi"><span id="07f6" class="ks kt hi ko b fi ku kv l kw kx">def createTooltip():<br/>    """<br/>        This function creates a tooltip containing the date and all stock prices displayed upon hover<br/>    <br/>    """<br/>    hover = alt.selection_single(<br/>        fields=["Date"],<br/>        nearest=True,<br/>        on="mouseover",<br/>        empty="none",<br/>        clear="mouseout",<br/>    )</span><span id="1d81" class="ks kt hi ko b fi ky kv l kw kx">    tooltips = alt.Chart(stock_df).transform_pivot(<br/>        "stock", "rolling_mean", groupby=["Date"]<br/>    ).mark_rule(strokeWidth=2,  color="red").encode(<br/>        x='Date:T',<br/>        opacity=alt.condition(hover, alt.value(1), alt.value(0)),<br/>        tooltip=["Date:T", "AAPL:Q", "MSFT:Q", "DIS:Q",<br/>                 "FB:Q",  "MSFT:Q", "NFLX:Q", "TSLA:Q"]<br/>    ).add_selection(hover)</span><span id="e250" class="ks kt hi ko b fi ky kv l kw kx">    return tooltips</span><span id="8a51" class="ks kt hi ko b fi ky kv l kw kx">tooltips =  createTooltip()<br/>img_layer &amp; (make_selector | alt.layer(highlight_stocks, tooltips ))</span></pre><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es mb"><img src="../Images/8d1935f4cbe33978c28446b6fde9fe9e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*5TCGoImkRbqUXntFAiSd2w.gif"/></div></div></figure><p id="d643" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated"><strong class="jl hj">最后..</strong></p><p id="e761" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">这篇文章通过Altair可视化数据的图形语法概述了我的发现之旅。元素通过分层、绑定和数据转换的相互作用用一个可视化来演示，这个可视化有简单的数据但有很多潜力。如果你有更多要补充的，请评论！</p></div></div>    
</body>
</html>