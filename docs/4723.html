<html>
<head>
<title>MLOps — Building End to End Pipeline using Sagemaker SDK &amp; AWS CodeCommit</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">MLOps —使用Sagemaker SDK和AWS CodeCommit构建端到端管道</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/mlops-building-end-to-end-pipeline-using-sagemaker-sdk-aws-codecommit-a4d15d7efdc3?source=collection_archive---------0-----------------------#2022-01-23">https://medium.com/analytics-vidhya/mlops-building-end-to-end-pipeline-using-sagemaker-sdk-aws-codecommit-a4d15d7efdc3?source=collection_archive---------0-----------------------#2022-01-23</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="4324" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在后covid时代，公司不断通过使用人工智能来实现业务流程的自动化。数据科学家和数据工程师一直需要支持业务需求的不断变化。人们通常将这称为人工智能热潮或现代数字时代。</p><p id="6339" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">随着这种变化，数据科学家不断寻找快速开发解决方案的方法，并将其部署在一个设备无关的平台上，该平台可以满足人们的需求，同时优化运营成本。一旦解决方案部署到生产就绪环境中，数据科学家需要收集模型性能的反馈，并不断完善模型以实现更高的准确性。这导致这些公司将他们的解决方案从本地服务器迁移到云环境，在云环境中，他们可以根据模型要求灵活地更改他们的计算资源，并根据使用情况付费，从而帮助这些公司降低运营成本，并帮助客户快速交付模型。</p><p id="63f7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在本文中，我们将介绍一个这样的云环境(Amazon Web Service)解决方案，它可以使用AWS Sagemaker &amp; AWS CodeCommit，只需点击一下，就可以帮助在单个工作流中自动化模型训练、部署和监控的完整过程。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es jd"><img src="../Images/0c1a5525b647ef6eae664cb7485559a4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KmslKiF-0Gf1hsr5eV5Isg.jpeg"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx translated"><a class="ae jt" href="https://aws.amazon.com/blogs/machine-learning/building-automating-managing-and-scaling-ml-workflows-using-amazon-sagemaker-pipelines/" rel="noopener ugc nofollow" target="_blank">https://AWS . Amazon . com/blogs/machine-learning/building-automating-management-and-scaling-ml-workflows-using-Amazon-sage maker-pipelines/</a></figcaption></figure><blockquote class="ju jv jw"><p id="6f5c" class="if ig jx ih b ii ij ik il im in io ip jy ir is it jz iv iw ix ka iz ja jb jc hb bi translated">使用的主要AWS资源:</p></blockquote><blockquote class="kb"><p id="d942" class="kc kd hi bd ke kf kg kh ki kj kk jc dx translated">AWS Sagemaker、AWS CodeCommit、亚马逊S3、AWS CodeBuild和亚马逊EventBridge</p></blockquote></div><div class="ab cl kl km gp kn" role="separator"><span class="ko bw bk kp kq kr"/><span class="ko bw bk kp kq kr"/><span class="ko bw bk kp kq"/></div><div class="hb hc hd he hf"><h1 id="c793" class="ks kt hi bd ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp bi translated">使用的数据集</h1><p id="70c2" class="pw-post-body-paragraph if ig hi ih b ii lq ik il im lr io ip iq ls is it iu lt iw ix iy lu ja jb jc hb bi translated">在这个示例方法中，我们将使用一个通常可用的数据集，称为“<a class="ae jt" href="https://www.kaggle.com/schirmerchad/bostonhoustingmlnd" rel="noopener ugc nofollow" target="_blank">波士顿住房数据集</a>，它用14个不同的要素和506个不同的条目表示马萨诸塞州波士顿的住房数据。一些共同特征包括通往高速公路、平均房间数量和靠近河流等。我们将尝试解决一个回归任务，即使用基于神经网络的算法，根据数据集中存在的13个不同特征来预测房屋的价格。</p><h1 id="b3a3" class="ks kt hi bd ku kv lv kx ky kz lw lb lc ld lx lf lg lh ly lj lk ll lz ln lo lp bi translated">Sagemaker管道</h1><p id="3d47" class="pw-post-body-paragraph if ig hi ih b ii lq ik il im lr io ip iq ls is it iu lt iw ix iy lu ja jb jc hb bi translated">所以，现在我们清楚了目的和解决问题的方法，我们将首先在AWS中建立sagemaker工作室。请参考下面的链接获取分步指南:</p><div class="ma mb ez fb mc md"><a href="https://docs.aws.amazon.com/sagemaker/latest/dg/onboard-quick-start.html" rel="noopener  ugc nofollow" target="_blank"><div class="me ab dw"><div class="mf ab mg cl cj mh"><h2 class="bd hj fi z dy mi ea eb mj ed ef hh bi translated">使用快速入门进入Amazon SageMaker域</h2><div class="mk l"><h3 class="bd b fi z dy mi ea eb mj ed ef dx translated">本主题介绍如何使用快速入门程序登录Amazon SageMaker域，该程序使用AWS身份…</h3></div><div class="ml l"><p class="bd b fp z dy mi ea eb mj ed ef dx translated">docs.aws.amazon.com</p></div></div></div></a></div><p id="9c8f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一旦我们登录到sagemaker studio jupyter实验室，我们将使用现有的sagemaker项目模板创建一个项目。请选择“用于模型构建、培训和部署的MLOps模板”模板，如下图所示</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es mm"><img src="../Images/83acf4d569f0d881a7a896f17ff4e3ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RoWfdS93TJAXf0N2JH9bsg.png"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx translated">AWS Sagemaker项目创建</figcaption></figure><p id="5864" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">既然项目已经成功建立，我们将深入到编码方面。但是在开始编写代码之前，我们首先将sagemaker SDK更新到最新版本:</p><pre class="je jf jg jh fd mn mo mp mq aw mr bi"><span id="1581" class="ms kt hi mo b fi mt mu l mv mw">!pip install sagemaker --upgrade</span></pre><p id="d43f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，我们将初始化sagemaker会话、区域和s3存储桶名称，我们希望在其中存储数据、实验日志和模型工件:</p><pre class="je jf jg jh fd mn mo mp mq aw mr bi"><span id="0891" class="ms kt hi mo b fi mt mu l mv mw"><strong class="mo hj">import</strong> boto3<br/><strong class="mo hj">import</strong> os<br/><strong class="mo hj">import</strong> sagemaker<br/><strong class="mo hj">import</strong> tensorflow <strong class="mo hj">as</strong> tf<br/><br/>sess <strong class="mo hj">=</strong> sagemaker<strong class="mo hj">.</strong>session<strong class="mo hj">.</strong>Session()<br/>bucket <strong class="mo hj">=</strong> sess<strong class="mo hj">.</strong>default_bucket() <br/>region <strong class="mo hj">=</strong> boto3<strong class="mo hj">.</strong>Session()<strong class="mo hj">.</strong>region_name</span></pre><h2 id="1068" class="ms kt hi bd ku mx my mz ky na nb nc lc iq nd ne lg iu nf ng lk iy nh ni lo nj bi translated">定义参数</h2><p id="1807" class="pw-post-body-paragraph if ig hi ih b ii lq ik il im lr io ip iq ls is it iu lt iw ix iy lu ja jb jc hb bi translated">一旦我们上传了定义的s3存储桶中的数据，我们将对pipeline.py文件进行一些编辑，该文件执行模型训练和注册的源代码。在这种情况下，我们需要首先参数化一些关键参数，这将使我们能够执行定制的管道和时间表，而不必修改管道定义。以下是代码:</p><pre class="je jf jg jh fd mn mo mp mq aw mr bi"><span id="2978" class="ms kt hi mo b fi mt mu l mv mw"><strong class="mo hj">from</strong> sagemaker.workflow.parameters <strong class="mo hj">import</strong> ParameterInteger, ParameterString<br/><br/><em class="jx"># package versions</em><br/>sklearn_version <strong class="mo hj">=</strong> ParameterString(name<strong class="mo hj">=</strong>"SKLearnVersion", default_value<strong class="mo hj">=</strong>"0.23-1")<br/>tensorflow_version <strong class="mo hj">=</strong> ParameterString(name<strong class="mo hj">=</strong>"TensorFlowVersion", default_value<strong class="mo hj">=</strong>"2.3.1")<br/>python_version <strong class="mo hj">=</strong> ParameterString(name<strong class="mo hj">=</strong>"PythonVersion", default_value<strong class="mo hj">=</strong>"py37")<br/><br/><em class="jx"># raw input data</em><br/>input_data <strong class="mo hj">=</strong> ParameterString(name<strong class="mo hj">=</strong>"InputData", default_value<strong class="mo hj">=</strong>s3_path)<br/><br/><em class="jx"># processing step parameters</em><br/>processing_instance_type <strong class="mo hj">=</strong> ParameterString(name<strong class="mo hj">=</strong>"ProcessingInstanceType", default_value<strong class="mo hj">=</strong>"ml.m5.xlarge")<br/>processing_instance_count <strong class="mo hj">=</strong> ParameterInteger(name<strong class="mo hj">=</strong>"ProcessingInstanceCount", default_value<strong class="mo hj">=3</strong>)<br/><br/><em class="jx"># training step parameters</em><br/>training_instance_type <strong class="mo hj">=</strong> ParameterString(name<strong class="mo hj">=</strong>"TrainingInstanceType", default_value<strong class="mo hj">=</strong>"ml.c5.2xlarge")<br/>training_instance_count <strong class="mo hj">=</strong> ParameterInteger(name<strong class="mo hj">=</strong>"TrainingInstanceCount", default_value<strong class="mo hj">=</strong>1)<br/><br/><em class="jx"># batch inference step parameters</em><br/>batch_instance_type <strong class="mo hj">=</strong> ParameterString(name<strong class="mo hj">=</strong>"BatchInstanceType", default_value<strong class="mo hj">=</strong>"ml.c5.xlarge")<br/>batch_instance_count <strong class="mo hj">=</strong> ParameterInteger(name<strong class="mo hj">=</strong>"BatchInstanceCount", default_value<strong class="mo hj">=</strong>1)</span></pre><h2 id="9cf7" class="ms kt hi bd ku mx my mz ky na nb nc lc iq nd ne lg iu nf ng lk iy nh ni lo nj bi translated">定义处理步骤</h2><p id="ebf8" class="pw-post-body-paragraph if ig hi ih b ii lq ik il im lr io ip iq ls is it iu lt iw ix iy lu ja jb jc hb bi translated">流水线的第一步是预处理输入数据。为此，我们将实例化一个SKLearnProcessor对象，该对象允许我们使用上面定义的参数指定作业的实例类型和计数，以及指定可分配给sagemaker培训作业和sagemaker端点以及用于成本分配和其他目的的标签。</p><pre class="je jf jg jh fd mn mo mp mq aw mr bi"><span id="d0c5" class="ms kt hi mo b fi mt mu l mv mw"><strong class="mo hj">from</strong> sagemaker.sklearn.processing <strong class="mo hj">import</strong> SKLearnProcessor<br/><strong class="mo hj">from</strong> sagemaker.processing <strong class="mo hj">import</strong> ProcessingInput, ProcessingOutput<br/><strong class="mo hj">from</strong> sagemaker.workflow.steps <strong class="mo hj">import</strong> ProcessingStep</span><span id="9b52" class="ms kt hi mo b fi nk mu l mv mw">processing_tags <strong class="mo hj">=</strong> [{'Key': 'pipeline-demo', 'Value': 'TFDemoProcessing'}]</span><span id="bdac" class="ms kt hi mo b fi nk mu l mv mw">sklearn_processor <strong class="mo hj">=</strong> SKLearnProcessor(<br/>    framework_version<strong class="mo hj">=</strong>sklearn_version<strong class="mo hj">.</strong>default_value,<br/>    instance_type<strong class="mo hj">=</strong>processing_instance_type,<br/>    instance_count<strong class="mo hj">=</strong>processing_instance_count,<br/>    base_job_name<strong class="mo hj">=</strong>"tensorflow-demo-process",<br/>    sagemaker_session<strong class="mo hj">=</strong>sess,<br/>    role<strong class="mo hj">=</strong>sagemaker<strong class="mo hj">.</strong>get_execution_role(),<br/>    tags<strong class="mo hj">=</strong>processing_tags)<br/><br/>step_process <strong class="mo hj">=</strong> ProcessingStep(<br/>    name<strong class="mo hj">=</strong>"TFDemo",<br/>    processor<strong class="mo hj">=</strong>sklearn_processor,<br/>    inputs<strong class="mo hj">=</strong>[<br/>        ProcessingInput(source<strong class="mo hj">=</strong>input_data, destination<strong class="mo hj">=</strong>"/opt/ml/processing/input", s3_data_distribution_type<strong class="mo hj">=</strong>'ShardedByS3Key'),<br/>    ],<br/>    outputs<strong class="mo hj">=</strong>[<br/>        ProcessingOutput(output_name<strong class="mo hj">=</strong>"train", source<strong class="mo hj">=</strong>"/opt/ml/processing/train"),<br/>        ProcessingOutput(output_name<strong class="mo hj">=</strong>"test", source<strong class="mo hj">=</strong>"/opt/ml/processing/test"),<br/>    ],<br/>    code<strong class="mo hj">=</strong>"./scripts/preprocessing.py" )</span></pre><p id="a2d8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用ShardedByS3Key分布类型，数据可以平均分布在上面定义的n个实例中，以将数据转换过程的速度提高n倍。</p><h2 id="6ae4" class="ms kt hi bd ku mx my mz ky na nb nc lc iq nd ne lg iu nf ng lk iy nh ni lo nj bi translated">定义培训、模型创建和模型注册步骤</h2><p id="d9aa" class="pw-post-body-paragraph if ig hi ih b ii lq ik il im lr io ip iq ls is it iu lt iw ix iy lu ja jb jc hb bi translated">以下代码将使用带有指定TensorFlow版本的预构建TensorFlow docker容器为培训作业设置管道步骤。</p><pre class="je jf jg jh fd mn mo mp mq aw mr bi"><span id="b795" class="ms kt hi mo b fi mt mu l mv mw"><strong class="mo hj">from</strong> sagemaker.tensorflow <strong class="mo hj">import</strong> TensorFlow<br/><strong class="mo hj">from</strong> sagemaker.inputs <strong class="mo hj">import</strong> TrainingInput<br/><strong class="mo hj">from</strong> sagemaker.workflow.steps <strong class="mo hj">import</strong> TrainingStep<br/><strong class="mo hj">from</strong> sagemaker.workflow.step_collections <strong class="mo hj">import</strong> RegisterModel<br/><br/>image_uri_train <strong class="mo hj">=</strong> sagemaker<strong class="mo hj">.</strong>image_uris<strong class="mo hj">.</strong>retrieve(framework<strong class="mo hj">=</strong>"tensorflow", region<strong class="mo hj">=</strong>region, version<strong class="mo hj">=</strong>tensorflow_version<strong class="mo hj">.</strong>default_value, py_version<strong class="mo hj">=</strong>python_version<strong class="mo hj">.</strong>default_value, instance_type<strong class="mo hj">=</strong>training_instance_type, image_scope<strong class="mo hj">=</strong>"training")</span></pre><p id="87de" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如需更多此类预建sagemaker图像，请参考以下链接:</p><div class="ma mb ez fb mc md"><a href="https://github.com/aws/deep-learning-containers/blob/master/available_images.md" rel="noopener  ugc nofollow" target="_blank"><div class="me ab dw"><div class="mf ab mg cl cj mh"><h2 class="bd hj fi z dy mi ea eb mj ed ef hh bi translated">深度学习容器/available _ images . MD at master AWS/deep-learning-containers</h2><div class="mk l"><h3 class="bd b fi z dy mi ea eb mj ed ef dx translated">下表列出了Amazon ECS将在任务定义中使用的Docker图像URL。替换和…</h3></div><div class="ml l"><p class="bd b fp z dy mi ea eb mj ed ef dx translated">github.com</p></div></div><div class="nl l"><div class="nm l nn no np nl nq jn md"/></div></div></a></div><p id="ac7d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">接下来，我们需要指定一个估计器对象，并基于默认的贝叶斯优化调优策略定义一个超参数调优器对象，以便对下面定义的参数运行超参数调优。</p><pre class="je jf jg jh fd mn mo mp mq aw mr bi"><span id="d85d" class="ms kt hi mo b fi mt mu l mv mw"><strong class="mo hj">import</strong> time<br/><br/>model_path <strong class="mo hj">=</strong> f"s3://{bucket}/TFDemoTrain"<br/>training_parameters <strong class="mo hj">=</strong> {'epochs': 20, 'batch_size': 64, 'learning_rate': 0.001, 'for_pipeline': 'true'}</span><span id="3981" class="ms kt hi mo b fi nk mu l mv mw">training_metrics <strong class="mo hj">=</strong> [<br/>   {<br/>       "Name": "training:loss",<br/>       "Regex": ".*step - loss: ([0-9\\.]+) - val_loss: [0-9\\.]+ - batch: [0-9\\.]+.*",<br/>    },<br/>    {<br/>        "Name": "validation:loss",<br/>        "Regex": ".*step - loss: [0-9\\.]+ - val_loss: ([0-9\\.]+) - batch: [0-9\\.]+.*",<br/>    }<br/>]</span><span id="c583" class="ms kt hi mo b fi nk mu l mv mw">training_tags <strong class="mo hj">=</strong> [{'Key': 'pipeline-demo', 'Value': 'TFDemoTrain'}]</span><span id="5339" class="ms kt hi mo b fi nk mu l mv mw">estimator <strong class="mo hj">=</strong> TensorFlow(<br/>    image_uri<strong class="mo hj">=</strong>image_uri_train,<br/>    metric_definitions<strong class="mo hj">=</strong>training_metrics,<br/>    tags<strong class="mo hj">=</strong>training_tags,<br/>    source_dir<strong class="mo hj">=</strong>'./scripts/',<br/>    entry_point<strong class="mo hj">=</strong>'train.py',<br/>    instance_type<strong class="mo hj">=</strong>training_instance_type,<br/>    instance_count<strong class="mo hj">=</strong>training_instance_count,<br/>    role<strong class="mo hj">=</strong>sagemaker<strong class="mo hj">.</strong>get_execution_role(),<br/>    base_job_name<strong class="mo hj">=</strong>"tensorflow-demo-train",<br/>    output_path<strong class="mo hj">=</strong>model_path,<br/>    hyperparameters<strong class="mo hj">=</strong>training_parameters )</span></pre><p id="a702" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">超参数调谐器定义:</p><pre class="je jf jg jh fd mn mo mp mq aw mr bi"><span id="1d62" class="ms kt hi mo b fi mt mu l mv mw"><strong class="mo hj">from</strong> sagemaker.tuner <strong class="mo hj">import</strong> IntegerParameter, CategoricalParameter, ContinuousParameter, HyperparameterTuner<br/><br/>hyperparameter_ranges <strong class="mo hj">=</strong> {<br/>  'learning_rate': ContinuousParameter(0.001, 0.2, scaling_type<strong class="mo hj">=</strong>"Logarithmic"),<br/>  'epochs': IntegerParameter(5, 30),<br/>  'batch_size': IntegerParameter(64, 256),<br/>}<br/><br/>metric_definitions <strong class="mo hj">=</strong> [{'Name': 'loss',<br/>                       'Regex': 'loss: ([0-9\\.]+)'},<br/>                     {'Name': 'val_loss',<br/>                       'Regex': 'val_loss: ([0-9\\.]+)'}]<br/><br/>tuning_tags <strong class="mo hj">=</strong> [{'Key': 'pipeline-demo', 'Value': 'TFDemoTuning'}]<br/>tuner <strong class="mo hj">=</strong> HyperparameterTuner(estimator,<br/>                            'val_loss',<br/>                            hyperparameter_ranges,<br/>                            metric_definitions,<br/>                            max_jobs<strong class="mo hj">=</strong>30,<br/>                            max_parallel_jobs<strong class="mo hj">=</strong>10,<br/>                            objective_type<strong class="mo hj">='</strong>Minimize',<br/>                            tags<strong class="mo hj">=</strong>tuning_tags)</span></pre><p id="8726" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">接下来，我们需要定义一个训练步骤，用来自前一个处理步骤的输入在管道中插入训练作业。</p><pre class="je jf jg jh fd mn mo mp mq aw mr bi"><span id="d262" class="ms kt hi mo b fi mt mu l mv mw">step_train <strong class="mo hj">=</strong> TrainingStep(<br/>    name<strong class="mo hj">=</strong>"TFDemoTrain",<br/>    estimator<strong class="mo hj">=</strong>estimator,<br/>    inputs<strong class="mo hj">=</strong>{<br/>        "train": TrainingInput( s3_data<strong class="mo hj">=</strong>step_process<strong class="mo hj">.</strong>properties<strong class="mo hj">.</strong>ProcessingOutputConfig<strong class="mo hj">.</strong>Outputs[<br/>                "train"<br/>            ]<strong class="mo hj">.</strong>S3Output<strong class="mo hj">.</strong>S3Uri<br/>        ),<br/>        "test": TrainingInput(<br/>            s3_data<strong class="mo hj">=</strong>step_process<strong class="mo hj">.</strong>properties<strong class="mo hj">.</strong>ProcessingOutputConfig<strong class="mo hj">.</strong>Outputs[<br/>                "test"<br/>            ]<strong class="mo hj">.</strong>S3Output<strong class="mo hj">.</strong>S3Uri<br/>        )<br/>    },<br/>)</span></pre><p id="ae27" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一旦定义了训练步骤，我们还将创建一个sagemaker模型对象来包装模型工件，并将它与一个单独的SageMaker预构建TensorFlow服务推理容器相关联，以便进行推理</p><pre class="je jf jg jh fd mn mo mp mq aw mr bi"><span id="9a52" class="ms kt hi mo b fi mt mu l mv mw"><strong class="mo hj">from</strong> sagemaker.model <strong class="mo hj">import</strong> Model<br/><strong class="mo hj">from</strong> sagemaker.inputs <strong class="mo hj">import</strong> CreateModelInput<br/><strong class="mo hj">from</strong> sagemaker.workflow.steps <strong class="mo hj">import</strong> CreateModelStep<br/><br/>image_uri_inference <strong class="mo hj">=</strong> sagemaker<strong class="mo hj">.</strong>image_uris<strong class="mo hj">.</strong>retrieve(framework<strong class="mo hj">=</strong>"tensorflow", region<strong class="mo hj">=</strong>region, version<strong class="mo hj">=</strong>tensorflow_version<strong class="mo hj">.</strong>default_value, py_version<strong class="mo hj">=</strong>python_version<strong class="mo hj">.</strong>default_value, instance_type<strong class="mo hj">=</strong>batch_instance_type, image_scope<strong class="mo hj">=</strong>"inference")</span><span id="96cc" class="ms kt hi mo b fi nk mu l mv mw">model <strong class="mo hj">=</strong> Model(image_uri<strong class="mo hj">=</strong>image_uri_inference, model_data<strong class="mo hj">=</strong>step_train<strong class="mo hj">.</strong>properties<strong class="mo hj">.</strong>ModelArtifacts<strong class="mo hj">.</strong>S3ModelArtifacts, sagemaker_session<strong class="mo hj">=</strong>sess, role<strong class="mo hj">=</strong>sagemaker<strong class="mo hj">.</strong>get_execution_role())<br/><br/>inputs_model <strong class="mo hj">=</strong> CreateModelInput(instance_type<strong class="mo hj">=</strong>batch_instance_type)<br/><br/>step_create_model <strong class="mo hj">=</strong> CreateModelStep(name<strong class="mo hj">=</strong>"TFDemoCreateModel", model<strong class="mo hj">=</strong>model, inputs<strong class="mo hj">=</strong>inputs_model)</span></pre><p id="2ce1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">最后一步是通过Sagemaker Model Registry注册一个模型，用于版本控制和改进的模型治理。使用模型注册中心，我们可以管理不同的模型版本，它也可以作为CI/CD工作流的一部分，用于将模型部署到Sagemaker端点</p><pre class="je jf jg jh fd mn mo mp mq aw mr bi"><span id="cbc6" class="ms kt hi mo b fi mt mu l mv mw"><strong class="mo hj">from</strong> sagemaker.workflow.step_collections <strong class="mo hj">import</strong> RegisterModel<br/><br/>step_register <strong class="mo hj">=</strong> RegisterModel(name<strong class="mo hj">=</strong>"TFDemoRegisterModel", estimator<strong class="mo hj">=</strong>estimator, model_data<strong class="mo hj">=</strong>step_train<strong class="mo hj">.</strong>properties<strong class="mo hj">.</strong>ModelArtifacts<strong class="mo hj">.</strong>S3ModelArtifacts, content_types<strong class="mo hj">=</strong>["text/csv"],<br/>response_types<strong class="mo hj">=</strong>["text/csv"],<br/>inference_instances<strong class="mo hj">=</strong>["ml.m5.xlarge"],<br/>transform_instances<strong class="mo hj">=</strong>["ml.c5.xlarge"],<br/>model_package_group_name<strong class="mo hj">=</strong>"TFDemoModelPackageGroup",<br/>image_uri<strong class="mo hj">=</strong>image_uri_inference)</span></pre><h2 id="5463" class="ms kt hi bd ku mx my mz ky na nb nc lc iq nd ne lg iu nf ng lk iy nh ni lo nj bi translated">定义管道</h2><p id="14b0" class="pw-post-body-paragraph if ig hi ih b ii lq ik il im lr io ip iq ls is it iu lt iw ix iy lu ja jb jc hb bi translated">除了所有这些步骤，我们还可以创建一个类似的步骤用于模型推断。最后，一旦定义了所有步骤，我们可以将这些步骤缝合到管道函数中，使其能够以自动化的方式运行。这个管道还与SageMaker实验集成在一起，让我们可以组织、跟踪、比较和评估ML实验。</p><pre class="je jf jg jh fd mn mo mp mq aw mr bi"><span id="77e1" class="ms kt hi mo b fi mt mu l mv mw"><strong class="mo hj">from</strong> sagemaker.workflow.pipeline <strong class="mo hj">import</strong> Pipeline, PipelineExperimentConfig<br/><strong class="mo hj">from</strong> sagemaker.workflow.execution_variables <strong class="mo hj">import</strong> ExecutionVariables<br/><br/>pipeline <strong class="mo hj">=</strong> Pipeline(<br/>    name<strong class="mo hj">=</strong>f"TFDemo",<br/>    parameters<strong class="mo hj">=</strong>[sklearn_version,<br/>                tensorflow_version,<br/>                python_version,<br/>                input_data,<br/>                processing_instance_type, <br/>                processing_instance_count, <br/>                training_instance_type, <br/>                training_instance_count,<br/>                batch_instance_type,<br/>                batch_instance_count],<br/>    steps<strong class="mo hj">=</strong>[step_process, <br/>           step_train, <br/>           step_create_model,<br/>           step_register,<br/>           step_batch<br/>          ],<br/>    pipeline_experiment_config<strong class="mo hj">=</strong>PipelineExperimentConfig("TFDemoExperiment", ExecutionVariables<strong class="mo hj">.</strong>PIPELINE_EXECUTION_ID),<br/>    sagemaker_session<strong class="mo hj">=</strong>sess)</span></pre><h2 id="b5c5" class="ms kt hi bd ku mx my mz ky na nb nc lc iq nd ne lg iu nf ng lk iy nh ni lo nj bi translated">自动化工作流执行</h2><p id="e57d" class="pw-post-body-paragraph if ig hi ih b ii lq ik il im lr io ip iq ls is it iu lt iw ix iy lu ja jb jc hb bi translated">现在，由于代码已经准备好执行，我们可以通过代码手动执行它:</p><pre class="je jf jg jh fd mn mo mp mq aw mr bi"><span id="434d" class="ms kt hi mo b fi mt mu l mv mw">pipeline_tags <strong class="mo hj">=</strong> [{'Key': 'pipeline-demo', 'Value': 'TFDemoPipeline'}]<br/>pipeline<strong class="mo hj">.</strong>upsert(role_arn<strong class="mo hj">=</strong>role, tags<strong class="mo hj">=</strong>pipeline_tags)<br/>execution <strong class="mo hj">=</strong> pipeline<strong class="mo hj">.</strong>start()<br/>execution<strong class="mo hj">.</strong>wait()<br/>execution<strong class="mo hj">.</strong>list_steps()</span></pre><p id="e513" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">或者，我们可以简单地git push AWS code commit中的已编辑代码，一旦模型经过训练并在Sagemaker注册表中注册，它将自动触发管道解决方案通过手动批准流程来构建、训练和部署模型。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es mm"><img src="../Images/29885364cbd02be24b028d4ca8ae2b75.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Iybg5HxWggFuaMppIDspVg.png"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx translated">通过AWS Sagemaker Studio资源管道执行管道部分</figcaption></figure><h1 id="ee65" class="ks kt hi bd ku kv lv kx ky kz lw lb lc ld lx lf lg lh ly lj lk ll lz ln lo lp bi translated">结论</h1><p id="6ea7" class="pw-post-body-paragraph if ig hi ih b ii lq ik il im lr io ip iq ls is it iu lt iw ix iy lu ja jb jc hb bi translated">AWS Sagemaker studio是一个很好的地方，可以通过AWS在Sagemaker资源中提供的交互式UI来自动化模型开发和部署的完整端到端过程。在管道部分，显示了所有的执行细节。新的执行可以通过一些参数更改和点击开始，其余的可以由AWS自动处理。如果我们深入单个执行，我们可以看到完整的管道流以及输入、输出和日志，如下图所示。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es mm"><img src="../Images/9f7d2541c091da4bf95eba68e717d476.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mKQQREmg6dbavAdnT39rBw.png"/></div></div></figure><p id="e74f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一旦模型被训练和注册，我们就可以根据它的验证分数来批准模型。在我们批准注册的模型之后，它将进入部署阶段。在这个阶段，如果我们对测试指标(比如蓝绿色测试或A/B测试)感到满意，我们可以进一步批准模型进行生产就绪部署。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es mm"><img src="../Images/c6da871a0ee3f386d5aa6492a4eb1cc8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*e9Wn7B9CqfQ2YlmMJwTotw.png"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx translated">通过手动批准的模型部署步骤</figcaption></figure><p id="0ca9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">敬请关注，了解我们在日常工作中使用的不同方法。在Linkedin上关注我来互动和分享想法:<a class="ae jt" href="https://www.linkedin.com/in/mdsharique0107/" rel="noopener ugc nofollow" target="_blank">https://www.linkedin.com/in/mdsharique0107/</a></p></div></div>    
</body>
</html>