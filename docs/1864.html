<html>
<head>
<title>Creating a Data Pipeline with EasyJobs &amp; FastAPI</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用EasyJobs &amp; FastAPI创建数据管道</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/creating-a-data-pipeline-with-easyjobs-fastapi-4e302556f05d?source=collection_archive---------3-----------------------#2021-03-23">https://medium.com/analytics-vidhya/creating-a-data-pipeline-with-easyjobs-fastapi-4e302556f05d?source=collection_archive---------3-----------------------#2021-03-23</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/d22fe68ed4709679c4245957930507bf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*Nqv8gXvH4CcuCdCi.png"/></div></div></figure></div><div class="ab cl iq ir gp is" role="separator"><span class="it bw bk iu iv iw"/><span class="it bw bk iu iv iw"/><span class="it bw bk iu iv"/></div><div class="hb hc hd he hf"><p id="4367" class="pw-post-body-paragraph ix iy hi iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hb bi translated">FastAPI很快在python社区中声名鹊起，因为它在为几乎任何东西开发RestAPI时都很容易使用。</p><p id="22b5" class="pw-post-body-paragraph ix iy hi iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hb bi translated">EasyJobs是一个为FastAPI构建的作业调度和任务分发库，它可以为几乎任何东西创建一个管道——带有内置的web挂钩。</p><h1 id="1b1c" class="jv jw hi bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">设置</h1><pre class="kt ku kv kw fd kx ky kz la aw lb bi"><span id="b148" class="lc jw hi ky b fi ld le l lf lg"><strong class="ky hj">$</strong> virtualenv -p python3.7 easy-job-env <strong class="ky hj"> <br/>$</strong> source easy-jobs-env/bin/activate <strong class="ky hj"> <br/>(easy-job-env)$</strong> pip install easyjobs</span></pre></div><div class="ab cl iq ir gp is" role="separator"><span class="it bw bk iu iv iw"/><span class="it bw bk iu iv iw"/><span class="it bw bk iu iv"/></div><div class="hb hc hd he hf"><h1 id="0ff3" class="jv jw hi bd jx jy lh ka kb kc li ke kf kg lj ki kj kk lk km kn ko ll kq kr ks bi translated"><strong class="ak"> ETL —提取—&gt;转换—&gt;加载</strong></h1><p id="d053" class="pw-post-body-paragraph ix iy hi iz b ja lm jc jd je ln jg jh ji lo jk jl jm lp jo jp jq lq js jt ju hb bi translated">数据管道是一个最常见的真实世界的例子，一个需要被调度、排序并且应该易于配置的过程。让我们看看数据管道最常见的例子:ETL(提取、转换、加载)。</p><h1 id="4cf0" class="jv jw hi bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">轻松工作经理</h1><p id="3d3f" class="pw-post-body-paragraph ix iy hi iz b ja lm jc jd je ln jg jh ji lo jk jl jm lp jo jp jq lq js jt ju hb bi translated">在开始之前，让我们首先配置EasyJobsManager，它将为我们的管道提供一个RestAPI。</p><pre class="kt ku kv kw fd kx ky kz la aw lb bi"><span id="2d05" class="lc jw hi ky b fi ld le l lf lg"># manager.py<br/>import asyncio, os<br/>from easyjobs.manager import EasyJobsManager<br/>from fastapi import FastAPI</span><span id="d737" class="lc jw hi ky b fi lr le l lf lg">server = FastAPI()</span><span id="7e7a" class="lc jw hi ky b fi lr le l lf lg"><a class="ae ls" href="http://twitter.com/server" rel="noopener ugc nofollow" target="_blank">@server</a>.on_event('startup')<br/>async def startup():<br/>    server.job_manager = await EasyJobsManager.create(<br/>        server,<br/>        server_secret='abcd1234'<br/>    )</span></pre><p id="aeca" class="pw-post-body-paragraph ix iy hi iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hb bi translated">要启动我们的管理器，只需运行:</p><pre class="kt ku kv kw fd kx ky kz la aw lb bi"><span id="ac58" class="lc jw hi ky b fi ld le l lf lg">uvicorn --host 0.0.0.0 --port 8220 manager:server</span></pre><figure class="kt ku kv kw fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lt"><img src="../Images/44f6fdaa42c5d2c71d066d213ba57b23.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0tMGVBclx6iX3cMCN6se2Q.png"/></div></div></figure><p id="193c" class="pw-post-body-paragraph ix iy hi iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hb bi translated">现在，我们可以看看我们的“经理/文档”页面，该页面目前只包含经理端点。</p></div><div class="ab cl iq ir gp is" role="separator"><span class="it bw bk iu iv iw"/><span class="it bw bk iu iv iw"/><span class="it bw bk iu iv"/></div><div class="hb hc hd he hf"><h1 id="1556" class="jv jw hi bd jx jy lh ka kb kc li ke kf kg lj ki kj kk lk km kn ko ll kq kr ks bi translated">轻松工作</h1><p id="92df" class="pw-post-body-paragraph ix iy hi iz b ja lm jc jd je ln jg jh ji lo jk jl jm lp jo jp jq lq js jt ju hb bi translated">接下来让我们配置我们的Worker，我们将把我们的ETL管道和逻辑添加到其中:</p><pre class="kt ku kv kw fd kx ky kz la aw lb bi"><span id="0c2b" class="lc jw hi ky b fi ld le l lf lg">import asyncio, os<br/>from fastapi import FastAPI<br/>from easyjobs.workers.worker import EasyJobsWorker</span><span id="8934" class="lc jw hi ky b fi lr le l lf lg">server = FastAPI()</span><span id="5567" class="lc jw hi ky b fi lr le l lf lg"><a class="ae ls" href="http://twitter.com/server" rel="noopener ugc nofollow" target="_blank">@server</a>.on_event('startup')<br/>async def setup():<br/>    worker = await EasyJobsWorker.create(<br/>        server,<br/>        server_secret='abcd1234',<br/>        manager_host='0.0.0.0',<br/>        manager_port=8220,<br/>        manager_secret='abcd1234',<br/>        jobs_queue='ETL',<br/>        max_tasks_per_worker=5<br/>    )</span><span id="3fc3" class="lc jw hi ky b fi lr le l lf lg">    every_minute = '* * * * *'<br/>    default_args = {'kwargs': {'url': ['<a class="ae ls" href="http://stats'" rel="noopener ugc nofollow" target="_blank">http://stats'</a>]}}</span></pre><p id="3df2" class="pw-post-body-paragraph ix iy hi iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hb bi translated">worker定义了一个将向其注册的JOBS_QUEUE。一旦工作人员注册了一些任务，就可以在工作人员上看到该队列。</p><p id="98c6" class="pw-post-body-paragraph ix iy hi iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hb bi translated">您可能还注意到，我们还利用了FastAPI的on_event startup，这是管理器和工作器如何挂钩到asyncio事件循环的方法。</p><pre class="kt ku kv kw fd kx ky kz la aw lb bi"><span id="ff5e" class="lc jw hi ky b fi ld le l lf lg">every_minute = '* * * * *'<br/>default_args = {'kwargs': {'url': ['<a class="ae ls" href="http://stats'" rel="noopener ugc nofollow" target="_blank">http://stats'</a>]}}</span></pre><p id="66a9" class="pw-post-body-paragraph ix iy hi iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hb bi translated">这是一个简单的cron计划，它定义了任务运行的频率。</p></div><div class="ab cl iq ir gp is" role="separator"><span class="it bw bk iu iv iw"/><span class="it bw bk iu iv iw"/><span class="it bw bk iu iv"/></div><div class="hb hc hd he hf"><h1 id="a52e" class="jv jw hi bd jx jy lh ka kb kc li ke kf kg lj ki kj kk lk km kn ko ll kq kr ks bi translated"><strong class="ak">摘录</strong></h1><p id="9a84" class="pw-post-body-paragraph ix iy hi iz b ja lm jc jd je ln jg jh ji lo jk jl jm lp jo jp jq lq js jt ju hb bi translated">我们管道的第一部分。</p><pre class="kt ku kv kw fd kx ky kz la aw lb bi"><span id="6469" class="lc jw hi ky b fi ld le l lf lg">    async def get_data(url):<br/>        print(f"get_data: {url}")<br/>        return {'a': 1, 'b': 2, 'c': 3}</span><span id="cedf" class="lc jw hi ky b fi lr le l lf lg">    <a class="ae ls" href="http://twitter.com/worker" rel="noopener ugc nofollow" target="_blank">@worker</a>.task(run_after=['transform'], schedule=every_minute,   default_args=default_args)<br/>    async def extract(url: str):<br/>        print(f"extract started")<br/>        data = await get_data(url)<br/>        print(f"extract finished")<br/>        return {'data': data}</span></pre><p id="8e53" class="pw-post-body-paragraph ix iy hi iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hb bi translated">两个方法，get_data()用于模拟数据提取，extract，任务以URL作为参数。</p><p id="2821" class="pw-post-body-paragraph ix iy hi iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hb bi translated">如果我们现在运行我们的worker，并等待大约30-45秒，您会注意到我们的Manager API上有一个新的端点可用:</p><pre class="kt ku kv kw fd kx ky kz la aw lb bi"><span id="74c8" class="lc jw hi ky b fi ld le l lf lg">uvicorn --host 0.0.0.0 --port 8221 job_worker:server --workers=5</span></pre><figure class="kt ku kv kw fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lu"><img src="../Images/5321d84582ebd654c88292ad43e00912.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tWiQPX0118NkF-v0zbS9_A.png"/></div></div></figure><p id="68fe" class="pw-post-body-paragraph ix iy hi iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hb bi translated">每一分钟，这个任务都应该使用提供的默认参数来触发，但是也可以从API手动触发。</p><figure class="kt ku kv kw fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lv"><img src="../Images/141c99a8c68703464e9e778aca97ffed.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ajO2Hy0_hf6FmcrXOCqmAA.png"/></div></div></figure><p id="d0fe" class="pw-post-body-paragraph ix iy hi iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hb bi translated">产生的request_id可用于管理器，查看作业结果:</p><figure class="kt ku kv kw fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lw"><img src="../Images/4d535dd70a1941555d78afe3fbd18063.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*38_1v415hZXl-8aq8qc-zw.png"/></div></div></figure><figure class="kt ku kv kw fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lx"><img src="../Images/1c9338ca8d512932ad5cd2120fd47a7a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RpaWnAHU_I17jKVwjqCIzQ.png"/></div></div></figure></div><div class="ab cl iq ir gp is" role="separator"><span class="it bw bk iu iv iw"/><span class="it bw bk iu iv iw"/><span class="it bw bk iu iv"/></div><div class="hb hc hd he hf"><h1 id="ff36" class="jv jw hi bd jx jy lh ka kb kc li ke kf kg lj ki kj kk lk km kn ko ll kq kr ks bi translated">转换、加载及更多</h1><p id="709b" class="pw-post-body-paragraph ix iy hi iz b ja lm jc jd je ln jg jh ji lo jk jl jm lp jo jp jq lq js jt ju hb bi translated">单个端点很难称为管道。EasyJobs的真正强大之处在于它能够链接相关任务，然后将这些任务分配给所有工作人员，以尽可能快的速度运行:</p><pre class="kt ku kv kw fd kx ky kz la aw lb bi"><span id="e28e" class="lc jw hi ky b fi ld le l lf lg">    <br/>    <a class="ae ls" href="http://twitter.com/worker" rel="noopener ugc nofollow" target="_blank">@worker</a>.task(run_after=['load'])<br/>    async def transform(data: dict):<br/>        print(f"transform started")<br/>        for k in data.copy():<br/>            data[k] = int(data[k]) + 2<br/>        print(f"transform finished")<br/>        return {'data': data}</span><span id="4fc3" class="lc jw hi ky b fi lr le l lf lg">    <a class="ae ls" href="http://twitter.com/worker" rel="noopener ugc nofollow" target="_blank">@worker</a>.task(on_failure='failure_notify', run_after=['compute'])<br/>    async def load(data):<br/>        print(f"load started")<br/>        await load_db(data)<br/>        print(f"load finished")<br/>        return {'data': data}</span><span id="293b" class="lc jw hi ky b fi lr le l lf lg">    <a class="ae ls" href="http://twitter.com/worker" rel="noopener ugc nofollow" target="_blank">@worker</a>.task()<br/>    async def failure_notify(job_failed):<br/>        await send_email('<a class="ae ls" href="mailto:admin@company.io" rel="noopener ugc nofollow" target="_blank">admin@company.io</a>', job_failed)<br/>        return job_failed</span><span id="f8ca" class="lc jw hi ky b fi lr le l lf lg">    <a class="ae ls" href="http://twitter.com/worker" rel="noopener ugc nofollow" target="_blank">@worker</a>.task()<br/>    async def deploy_environment():<br/>        print(f"deploy_environment - started")<br/>        await asyncio.sleep(5)<br/>        print(f"deploy_environment - completed")<br/>        return f"deploy_environment - completed"</span><span id="ac9e" class="lc jw hi ky b fi lr le l lf lg">    <a class="ae ls" href="http://twitter.com/worker" rel="noopener ugc nofollow" target="_blank">@worker</a>.task()<br/>    async def prepare_db():<br/>        print(f"prepare_db - started")<br/>        await asyncio.sleep(5)<br/>        print(f"prepare_db - completed")<br/>        return f"prepare_db - completed"<br/>    <a class="ae ls" href="http://twitter.com/worker" rel="noopener ugc nofollow" target="_blank">@worker</a>.task(run_before=['deploy_environment', 'prepare_db'])<br/>    async def configure_environment():<br/>        print(f"configure_environment - starting")<br/>        await asyncio.sleep(5)<br/>        print(f"configure_environment - finished")<br/>        return f"configure_environment - finished"</span><span id="019e" class="lc jw hi ky b fi lr le l lf lg">    os.environ['WORKER_TASK_DIR'] = '/home/josh/Documents/python/easyjobs'</span><span id="74bf" class="lc jw hi ky b fi lr le l lf lg">    <a class="ae ls" href="http://twitter.com/worker" rel="noopener ugc nofollow" target="_blank">@worker</a>.task(subprocess=True, run_before=['configure_environment'])<br/>    async def compute(data: dict):<br/>        pass<br/>    <br/>    <a class="ae ls" href="http://twitter.com/worker" rel="noopener ugc nofollow" target="_blank">@worker</a>.task()<br/>    async def pipeline():<br/>        print(f"pipeline started")<br/>        result = await compute(data={'test': 'data'})<br/>        print(f"pipeline - result is {result} - finished")<br/>        return result</span></pre><p id="c614" class="pw-post-body-paragraph ix iy hi iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hb bi translated">再次刷新worker &amp; /docs页面，您会看到一组新的端点</p><figure class="kt ku kv kw fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ly"><img src="../Images/48ee2e7edd5c58f2de0cc4bf2a4c2b88.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4hKAjq4Opnfw6KpV77zRBA.png"/></div></div></figure><h1 id="918d" class="jv jw hi bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">任务流程</h1><figure class="kt ku kv kw fd ij er es paragraph-image"><div class="er es lz"><img src="../Images/3c00908de83009c2770f05c5fe24c6fa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1292/format:webp/0*nUxIeNAUPqjTdmdy.png"/></div></figure><pre class="kt ku kv kw fd kx ky kz la aw lb bi"><span id="c516" class="lc jw hi ky b fi ld le l lf lg"># Worker Output<br/>extract started<br/>get_data: ['http://stats']<br/>extract finished<br/>transform started<br/>transform finished<br/>load started<br/>load finished<br/>prepare_db - started<br/>deploy_environment - started<br/>prepare_db - completed<br/>deploy_environment - completed<br/>configure_environment - starting<br/>configure_environment - finished<br/>task subprocess called with ['/home/josh/Documents/python/easyjobs/compute.py', '0.0.0.0', '8220', 'abcd1234', 'c3076f7f-8b5c-11eb-9cba-6f9cd5406680', '{"args": [], "kwargs": {"data": {"a": 3, "b": 4, "c": 5}}}']<br/>starting heavy computation on {'a': 3, 'b': 4, 'c': 5}</span></pre><h2 id="4f6c" class="lc jw hi bd jx ma mb mc kb md me mf kf ji mg mh kj jm mi mj kn jq mk ml kr mm bi translated">管道</h2><figure class="kt ku kv kw fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mn"><img src="../Images/9a7c1eaeae65e5b4747aea3e31fef0c4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*TH97y5N-7D7JmTtx.png"/></div></div></figure><pre class="kt ku kv kw fd kx ky kz la aw lb bi"><span id="a28f" class="lc jw hi ky b fi ld le l lf lg">pipeline started<br/>deploy_environment - started<br/>prepare_db - started<br/>deploy_environment - completed<br/>prepare_db - completed<br/>configure_environment - starting<br/>configure_environment - finished<br/>task subprocess called with ['/home/josh/Documents/python/easyjobs/compute.py', '0.0.0.0', '8220', 'abcd1234', '23970547-8b5d-11eb-9cba-6f9cd5406680', '{"args": [], "kwargs": {"data": {"test": "data"}}}']<br/>starting heavy computation on {'test': 'data'}<br/>pipeline - result is {'result': 'I slept for 5 seconds - blocking - with data', 'test': 'data'} - finished</span></pre><p id="f41d" class="pw-post-body-paragraph ix iy hi iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hb bi translated">pipeline()是嵌套依赖和使用<strong class="iz hj"> run_before </strong>并行化的依赖任务的一个很好的例子。</p></div><div class="ab cl iq ir gp is" role="separator"><span class="it bw bk iu iv iw"/><span class="it bw bk iu iv iw"/><span class="it bw bk iu iv"/></div><div class="hb hc hd he hf"><h1 id="3631" class="jv jw hi bd jx jy lh ka kb kc li ke kf kg lj ki kj kk lk km kn ko ll kq kr ks bi translated">结论</h1><p id="21da" class="pw-post-body-paragraph ix iy hi iz b ja lm jc jd je ln jg jh ji lo jk jl jm lp jo jp jq lq js jt ju hb bi translated">文档:<a class="ae ls" href="https://easyjobs.readthedocs.io/en/latest/#quick-start" rel="noopener ugc nofollow" target="_blank">https://easyjobs.readthedocs.io/en/latest/#quick-start</a></p><p id="f2be" class="pw-post-body-paragraph ix iy hi iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hb bi translated">源代码:<a class="ae ls" href="https://github.com/codemation/easyjobs" rel="noopener ugc nofollow" target="_blank">https://github.com/codemation/easyjobs</a></p></div></div>    
</body>
</html>