<html>
<head>
<title>Azure Machine Learning Notebook Code and run as pipeline</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Azure机器学习笔记本代码并作为管道运行</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/azure-machine-learning-notebook-code-and-run-as-pipeline-c339fbb99c8f?source=collection_archive---------0-----------------------#2021-06-02">https://medium.com/analytics-vidhya/azure-machine-learning-notebook-code-and-run-as-pipeline-c339fbb99c8f?source=collection_archive---------0-----------------------#2021-06-02</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><h1 id="453a" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">能够将笔记本代码作为管道运行</h1><h1 id="6618" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">先决条件</h1><ul class=""><li id="d9c1" class="jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju bi translated">Azure帐户</li><li id="cab8" class="jd je hi jf b jg jv ji jw jk jx jm jy jo jz jq jr js jt ju bi translated">Azure机器学习</li><li id="5395" class="jd je hi jf b jg jv ji jw jk jx jm jy jo jz jq jr js jt ju bi translated">创建计算实例</li><li id="141a" class="jd je hi jf b jg jv ji jw jk jx jm jy jo jz jq jr js jt ju bi translated">创建一个计算集群作为cpu集群</li><li id="d155" class="jd je hi jf b jg jv ji jw jk jx jm jy jo jz jq jr js jt ju bi translated">选择标准D系列版本</li><li id="33d4" class="jd je hi jf b jg jv ji jw jk jx jm jy jo jz jq jr js jt ju bi translated">创建训练文件来训练模型</li><li id="1512" class="jd je hi jf b jg jv ji jw jk jx jm jy jo jz jq jr js jt ju bi translated">创建一个管道文件来运行as管道</li></ul><h1 id="eca5" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">步伐</h1><h1 id="672f" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">将训练文件创建为train.py</h1><ul class=""><li id="6882" class="jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju bi translated">创建一个目录。/train_src</li><li id="8b23" class="jd je hi jf b jg jv ji jw jk jx jm jy jo jz jq jr js jt ju bi translated">创建一列火车. py</li><li id="7f6a" class="jd je hi jf b jg jv ji jw jk jx jm jy jo jz jq jr js jt ju bi translated">应该是python文件而不是笔记本</li></ul><pre class="ka kb kc kd fd ke kf kg kh aw ki bi"><span id="a831" class="kj ig hi kf b fi kk kl l km kn"># Copyright (c) Microsoft. All rights reserved.<br/># Licensed under the MIT license.<br/><br/>import argparse<br/>import os<br/>import pandas as pd<br/>import numpy as np<br/>from azureml.core import Workspace, Dataset<br/>from azureml.core import Dataset<br/>from azureml.data.dataset_factory import DataType<br/>from sklearn.preprocessing import LabelEncoder, OneHotEncoder<br/><br/>import sklearn as sk<br/>import pandas as pd<br/># import seaborn as sn<br/># import matplotlib.pyplot as plt<br/>from sklearn.preprocessing import StandardScaler<br/>from sklearn.linear_model import LogisticRegression<br/>from tqdm import tqdm<br/>from sklearn import preprocessing<br/>from sklearn.model_selection import train_test_split<br/>from sklearn.linear_model import LogisticRegression<br/>from sklearn.metrics import roc_auc_score<br/>from sklearn.metrics import f1_score<br/>from sklearn import metrics<br/>from sklearn.svm import SVC<br/>from sklearn.pipeline import make_pipeline<br/>from sklearn.preprocessing import StandardScaler<br/><br/>print("In train.py")<br/>print("As a data scientist, this is where I use my training code.")<br/><br/>parser = argparse.ArgumentParser("train")<br/><br/>parser.add_argument("--input_data", type=str, help="input data")<br/>parser.add_argument("--output_train", type=str, help="output_train directory")<br/><br/>args = parser.parse_args()<br/><br/>print("Argument 1: %s" % args.input_data)<br/>print("Argument 2: %s" % args.output_train)<br/><br/>if not (args.output_train is None):<br/>    os.makedirs(args.output_train, exist_ok=True)<br/>    print("%s created" % args.output_train)<br/>    <br/>web_path ='https://dprepdata.blob.core.windows.net/demo/Titanic.csv'<br/>titanic_ds = Dataset.Tabular.from_delimited_files(path=web_path, set_column_types={'Survived': DataType.to_bool()})<br/><br/># preview the first 3 rows of titanic_ds<br/>#titanic_ds.take(3).to_pandas_dataframe()<br/>    <br/>#df = args.input_data.to_pandas_dataframe()<br/><br/>df = titanic_ds.to_pandas_dataframe()<br/>df.head()<br/><br/>titanic_features = df.copy()<br/>titanic_labels = titanic_features.pop('Survived')<br/><br/>df1 = pd.get_dummies(df)<br/><br/>y = df1['Survived']<br/>X = df1<br/>X = X.drop(columns=['Survived'])<br/>X['Age'] = X['Age'].fillna(0)<br/>X = X.dropna()<br/><br/>X_train, X_test, y_train, y_test = train_test_split(X, y, test_size=0.33, random_state=42)<br/><br/>LR = LogisticRegression(random_state=0, solver='lbfgs', multi_class='ovr').fit(X, y)<br/>LR.predict(X.iloc[460:,:])<br/>round(LR.score(X,y), 4)<br/><br/>y_pred = LR.predict(X_test)<br/><br/>print(metrics.classification_report(y_test, y_pred))<br/><br/>print("roc_auc_score: ", roc_auc_score(y_test, y_pred))<br/>print("f1 score: ", f1_score(y_test, y_pred))<br/><br/>clf = make_pipeline(StandardScaler(), SVC(gamma='auto'))<br/><br/>clf.fit(X, y)<br/><br/>print(clf.predict(X_test))</span></pre><h1 id="4454" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">创建管道代码</h1><pre class="ka kb kc kd fd ke kf kg kh aw ki bi"><span id="44d2" class="kj ig hi kf b fi kk kl l km kn">import azureml.core<br/>from azureml.core import Workspace, Datastore<br/><br/>ws = Workspace.from_config()</span></pre><ul class=""><li id="8a4c" class="jd je hi jf b jg ko ji kp jk kq jm kr jo ks jq jr js jt ju bi translated">获取默认商店信息</li></ul><pre class="ka kb kc kd fd ke kf kg kh aw ki bi"><span id="1c61" class="kj ig hi kf b fi kk kl l km kn"># Default datastore <br/>def_data_store = ws.get_default_datastore()<br/><br/># Get the blob storage associated with the workspace<br/>def_blob_store = Datastore(ws, "workspaceblobstore")<br/><br/># Get file storage associated with the workspace<br/>def_file_store = Datastore(ws, "workspacefilestore")</span></pre><ul class=""><li id="0a25" class="jd je hi jf b jg ko ji kp jk kq jm kr jo ks jq jr js jt ju bi translated">创建计算集群</li></ul><pre class="ka kb kc kd fd ke kf kg kh aw ki bi"><span id="7bfd" class="kj ig hi kf b fi kk kl l km kn">from azureml.core.compute import ComputeTarget, AmlCompute<br/><br/>compute_name = "cpu-cluster"<br/>vm_size = "Standard_F16s_v2"<br/>if compute_name in ws.compute_targets:<br/>    compute_target = ws.compute_targets[compute_name]<br/>    if compute_target and type(compute_target) is AmlCompute:<br/>        print('Found compute target: ' + compute_name)<br/>else:<br/>    print('Creating a new compute target...')<br/>    provisioning_config = AmlCompute.provisioning_configuration(vm_size=vm_size,  # Standard_F16s_v2 is CPU-enabled<br/>                                                                min_nodes=0,<br/>                                                                max_nodes=4)<br/>    # create the compute target<br/>    compute_target = ComputeTarget.create(<br/>        ws, compute_name, provisioning_config)<br/><br/>    # Can poll for a minimum number of nodes and for a specific timeout.<br/>    # If no min node count is provided it will use the scale settings for the cluster<br/>    compute_target.wait_for_completion(<br/>        show_output=True, min_node_count=None, timeout_in_minutes=20)<br/><br/>    # For a more detailed view of current cluster status, use the 'status' property<br/>    print(compute_target.status.serialize())</span></pre><ul class=""><li id="9b7e" class="jd je hi jf b jg ko ji kp jk kq jm kr jo ks jq jr js jt ju bi translated">加载包</li></ul><pre class="ka kb kc kd fd ke kf kg kh aw ki bi"><span id="630b" class="kj ig hi kf b fi kk kl l km kn">from azureml.core.runconfig import RunConfiguration<br/>from azureml.core.conda_dependencies import CondaDependencies<br/>from azureml.core import Environment <br/><br/>aml_run_config = RunConfiguration()<br/># `compute_target` as defined in "Azure Machine Learning compute" section above<br/>aml_run_config.target = compute_target<br/><br/>USE_CURATED_ENV = True<br/>if USE_CURATED_ENV :<br/>    curated_environment = Environment.get(workspace=ws, name="AzureML-Tutorial")<br/>    aml_run_config.environment = curated_environment<br/>else:<br/>    aml_run_config.environment.python.user_managed_dependencies = False<br/>    <br/>    # Add some packages relied on by data prep step<br/>    aml_run_config.environment.python.conda_dependencies = CondaDependencies.create(<br/>        conda_packages=['pandas','scikit-learn','seaborn','tqdm'], <br/>        pip_packages=['azureml-sdk', 'azureml-dataprep[fuse,pandas]','seaborn','tqdm'], <br/>        pin_sdk_version=False)</span></pre><ul class=""><li id="9d02" class="jd je hi jf b jg ko ji kp jk kq jm kr jo ks jq jr js jt ju bi translated">准备要下载的数据</li></ul><pre class="ka kb kc kd fd ke kf kg kh aw ki bi"><span id="4167" class="kj ig hi kf b fi kk kl l km kn">from azureml.core import Dataset<br/>from azureml.data.dataset_factory import DataType<br/><br/># create a TabularDataset from a delimited file behind a public web url and convert column "Survived" to boolean<br/>web_path ='https://dprepdata.blob.core.windows.net/demo/Titanic.csv'<br/>my_dataset = Dataset.Tabular.from_delimited_files(path=web_path, set_column_types={'Survived': DataType.to_bool()})</span></pre><ul class=""><li id="9761" class="jd je hi jf b jg ko ji kp jk kq jm kr jo ks jq jr js jt ju bi translated">设置数据集</li></ul><pre class="ka kb kc kd fd ke kf kg kh aw ki bi"><span id="5769" class="kj ig hi kf b fi kk kl l km kn">from azureml.pipeline.steps import PythonScriptStep<br/>dataprep_source_dir = "./dataprep_src"<br/>#entry_point = "prepare.py"<br/># `my_dataset` as defined above<br/>ds_input = my_dataset.as_named_input('input1')</span></pre><ul class=""><li id="a078" class="jd je hi jf b jg ko ji kp jk kq jm kr jo ks jq jr js jt ju bi translated">将输出设置为可选</li></ul><pre class="ka kb kc kd fd ke kf kg kh aw ki bi"><span id="e961" class="kj ig hi kf b fi kk kl l km kn">from azureml.data import OutputFileDatasetConfig<br/>from azureml.core import Workspace, Datastore<br/><br/>datastore = ws.get_default_datastore()<br/><br/>output_data1 = OutputFileDatasetConfig(destination = (datastore, 'outputdataset/{run-id}'))<br/>output_data_dataset = output_data1.register_on_complete(name = 'titanic_output_data')</span></pre><ul class=""><li id="1a6f" class="jd je hi jf b jg ko ji kp jk kq jm kr jo ks jq jr js jt ju bi translated">设置管道培训运行步骤</li></ul><pre class="ka kb kc kd fd ke kf kg kh aw ki bi"><span id="2fa7" class="kj ig hi kf b fi kk kl l km kn">train_source_dir = "./train_src"<br/>train_entry_point = "train.py"<br/><br/>training_results = OutputFileDatasetConfig(name = "training_results",<br/>    destination = def_blob_store)<br/><br/>    <br/>train_step = PythonScriptStep(<br/>    script_name=train_entry_point,<br/>    source_directory=train_source_dir,<br/>    arguments=["--input_data", ds_input],<br/>    compute_target=compute_target, # , "--training_results", training_results<br/>    runconfig=aml_run_config,<br/>    allow_reuse=True<br/>)</span></pre><ul class=""><li id="3daf" class="jd je hi jf b jg ko ji kp jk kq jm kr jo ks jq jr js jt ju bi translated">设置管道配置</li></ul><pre class="ka kb kc kd fd ke kf kg kh aw ki bi"><span id="1fc1" class="kj ig hi kf b fi kk kl l km kn"># list of steps to run (`compare_step` definition not shown)<br/>compare_models = [train_step]<br/><br/>from azureml.pipeline.core import Pipeline<br/><br/># Build the pipeline<br/>pipeline1 = Pipeline(workspace=ws, steps=train_step)</span></pre><ul class=""><li id="4d5c" class="jd je hi jf b jg ko ji kp jk kq jm kr jo ks jq jr js jt ju bi translated">验证管道</li></ul><pre class="ka kb kc kd fd ke kf kg kh aw ki bi"><span id="6f4f" class="kj ig hi kf b fi kk kl l km kn">pipeline1.validate()<br/>print("Pipeline validation complete")</span></pre><ul class=""><li id="852f" class="jd je hi jf b jg ko ji kp jk kq jm kr jo ks jq jr js jt ju bi translated">现在是提交管道的时候了</li><li id="6a05" class="jd je hi jf b jg jv ji jw jk jx jm jy jo jz jq jr js jt ju bi translated">等待管道完成</li></ul><pre class="ka kb kc kd fd ke kf kg kh aw ki bi"><span id="bb78" class="kj ig hi kf b fi kk kl l km kn">from azureml.core import Experiment # Submit the pipeline to be run pipeline_run1 = Experiment(ws, 'Titanic_Pipeline_Notebook').submit(pipeline1) pipeline_run1.wait_for_completion()</span></pre><ul class=""><li id="799e" class="jd je hi jf b jg ko ji kp jk kq jm kr jo ks jq jr js jt ju bi translated">现在让我们发布管道</li><li id="fd24" class="jd je hi jf b jg jv ji jw jk jx jm jy jo jz jq jr js jt ju bi translated">每个发布者都将创建一个REST端点</li></ul><pre class="ka kb kc kd fd ke kf kg kh aw ki bi"><span id="f5d7" class="kj ig hi kf b fi kk kl l km kn">published_pipeline1 = pipeline_run1.publish_pipeline( name="Published_Titanic_Pipeline_Notebook", description="Titanic_Pipeline_Notebook Published Pipeline Description", version="1.0")</span></pre><ul class=""><li id="1f76" class="jd je hi jf b jg ko ji kp jk kq jm kr jo ks jq jr js jt ju bi translated">我登录了Azure ML Studio</li><li id="7ab7" class="jd je hi jf b jg jv ji jw jk jx jm jy jo jz jq jr js jt ju bi translated">转到左侧菜单中的管道</li></ul><figure class="ka kb kc kd fd ku er es paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="er es kt"><img src="../Images/85e9ef29e8010b51f1e390f63bb287cd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*hLQbAzQPxcG6X_8I.jpg"/></div></div></figure><ul class=""><li id="3f60" class="jd je hi jf b jg ko ji kp jk kq jm kr jo ks jq jr js jt ju bi translated">单击管道端点</li><li id="b97b" class="jd je hi jf b jg jv ji jw jk jx jm jy jo jz jq jr js jt ju bi translated">应该看到一个管道—已发布_泰坦尼克_管道_笔记本</li><li id="58de" class="jd je hi jf b jg jv ji jw jk jx jm jy jo jz jq jr js jt ju bi translated">单击提交，查看管线是否运行</li><li id="d2f8" class="jd je hi jf b jg jv ji jw jk jx jm jy jo jz jq jr js jt ju bi translated">现在转到ADF或Synapse Integrate</li><li id="2704" class="jd je hi jf b jg jv ji jw jk jx jm jy jo jz jq jr js jt ju bi translated">创建新管道</li><li id="fed0" class="jd je hi jf b jg jv ji jw jk jx jm jy jo jz jq jr js jt ju bi translated">名字是AzureMLPipelinetest</li><li id="5834" class="jd je hi jf b jg jv ji jw jk jx jm jy jo jz jq jr js jt ju bi translated">拖放Azure机器学习服务(仅用于运行发布的管道)</li><li id="7327" class="jd je hi jf b jg jv ji jw jk jx jm jy jo jz jq jr js jt ju bi translated">使用服务主体帐户创建Azure机器学习的新来源</li></ul><pre class="ka kb kc kd fd ke kf kg kh aw ki bi"><span id="8b91" class="kj ig hi kf b fi kk kl l km kn">Make sure you have service principal created and permission provided</span></pre><figure class="ka kb kc kd fd ku er es paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="er es lb"><img src="../Images/0509a674c4674e95c6d9c38dcc7be7a4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*k2cb630atjt7OWqlNvSwaw.jpeg"/></div></div></figure><ul class=""><li id="89e4" class="jd je hi jf b jg ko ji kp jk kq jm kr jo ks jq jr js jt ju bi translated">现在配置管道</li><li id="f225" class="jd je hi jf b jg jv ji jw jk jx jm jy jo jz jq jr js jt ju bi translated">您应该在下拉列表中看到这一点</li><li id="071b" class="jd je hi jf b jg jv ji jw jk jx jm jy jo jz jq jr js jt ju bi translated">选择第一个可用的管道ID</li></ul><figure class="ka kb kc kd fd ku er es paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="er es lc"><img src="../Images/51aaeb75782f33f375c01fb86a932d63.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*yp0mjmAMlIK2fSAU.jpg"/></div></div></figure><ul class=""><li id="c1df" class="jd je hi jf b jg ko ji kp jk kq jm kr jo ks jq jr js jt ju bi translated">提交或保存更改，然后单击调试运行</li><li id="4e60" class="jd je hi jf b jg jv ji jw jk jx jm jy jo jz jq jr js jt ju bi translated">等待调试完成，看看下面的图片</li></ul><figure class="ka kb kc kd fd ku er es paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="er es ld"><img src="../Images/150852003a9e74a313e61907f7235109.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*J1QuF5P80QMqS9Mg.jpg"/></div></div></figure><ul class=""><li id="533b" class="jd je hi jf b jg ko ji kp jk kq jm kr jo ks jq jr js jt ju bi translated">现在转到AzureML studio</li><li id="cd06" class="jd je hi jf b jg jv ji jw jk jx jm jy jo jz jq jr js jt ju bi translated">打开实验，点击泰坦尼克_管道_笔记本</li><li id="8c28" class="jd je hi jf b jg jv ji jw jk jx jm jy jo jz jq jr js jt ju bi translated">应该看到最新的运行</li></ul><figure class="ka kb kc kd fd ku er es paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="er es le"><img src="../Images/c0a6e3f8cc28b56029e1c509c63a135b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*7dKSofTi44P77QPy.jpg"/></div></div></figure><figure class="ka kb kc kd fd ku er es paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="er es lf"><img src="../Images/deecd681b1b05db273a506c7f3918a8f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*V4dKlXLSKqfyvb7Z.jpg"/></div></div></figure></div><div class="ab cl lg lh gp li" role="separator"><span class="lj bw bk lk ll lm"/><span class="lj bw bk lk ll lm"/><span class="lj bw bk lk ll"/></div><div class="hb hc hd he hf"><p id="d3b6" class="pw-post-body-paragraph ln lo hi jf b jg ko lp lq ji kp lr ls jk lt lu lv jm lw lx ly jo lz ma mb jq hb bi translated"><em class="mc">最初发表于</em><a class="ae md" href="https://github.com/balakreshnan/Samples2021/blob/main/AzureMLPipelineNotebook/notebookpipelineexec.md" rel="noopener ugc nofollow" target="_blank"><em class="mc">【https://github.com】</em></a><em class="mc">。</em></p></div></div>    
</body>
</html>