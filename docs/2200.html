<html>
<head>
<title>Geospatial data: A beginner’s guide to working with MS SQL Server Express in Python</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">地理空间数据:在Python中使用MS SQL Server Express的初学者指南</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/geospatial-data-a-beginners-guide-to-working-with-ms-sql-server-express-in-python-e5f83350f069?source=collection_archive---------0-----------------------#2021-04-12">https://medium.com/analytics-vidhya/geospatial-data-a-beginners-guide-to-working-with-ms-sql-server-express-in-python-e5f83350f069?source=collection_archive---------0-----------------------#2021-04-12</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="eb8a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">最近，我被分配了一项任务，制作一张交互式地图来展示一家公司的国际销售情况，这需要使用地理空间数据。对于可视化，我选择了Python的散景库，而客户端数据在<strong class="ih hj"> Microsoft SQL Server 2019中。因此，我第一次遇到了将地理空间数据从Python读取到Microsoft SQL Server以及从Python读取回来的挑战。</strong>事实证明这并不像看起来那么简单，所以在对堆栈溢出进行了大量的挖掘之后:)我决定将所有这些放在一个地方，以供任何可能遇到类似任务的人使用——所以我在这里写了我的第一篇技术文章！</p><p id="201e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">本文将带您了解:</p><ul class=""><li id="72eb" class="jd je hi ih b ii ij im in iq jf iu jg iy jh jc ji jj jk jl bi translated">正在Python geopandas数据帧中加载shapefile坐标；清理地理数据的示例</li><li id="375f" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">通过Python连接SQL Server Express 2019的两种方式:SQLAlchemy和pyodbc</li><li id="f735" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">将地理数据框导入SQL Server Express 2019</li><li id="5d01" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">将SQL Server表作为地理数据框架或普通数据框架读回Python</li></ul><p id="145e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在最初接受这个任务后，我很快发现了大量关于使用Python的sqlite、MySQL和postgreSQL数据库的优秀资源，但对于MS SQL Server、<em class="jr">而言，特别是在地理空间数据</em>的上下文中，就没有那么多了。这可能是因为MS SQL Server是一个付费的关系数据库管理系统，而其他的是开源和免费的。谢天谢地，客户端使用的是一个名为<a class="ae js" href="https://www.microsoft.com/en-us/sql-server/sql-server-downloads" rel="noopener ugc nofollow" target="_blank"><strong class="ih hj">MS SQL Server Express</strong></a><strong class="ih hj">的<strong class="ih hj">免费</strong>缩减版SQL Server。我用的是2019版。</strong></p><p id="b744" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">这篇文章会很有用</strong>:</p><ul class=""><li id="e241" class="jd je hi ih b ii ij im in iq jf iu jg iy jh jc ji jj jk jl bi translated"><strong class="ih hj">如果你以前没有SQL-Python连接的经验</strong></li><li id="e452" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">如果您/您的公司将您的(地理)数据存储在MS SQL Server中，但要求将其输入Python，例如用于数据可视化目的</li><li id="6938" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">如果您必须将MS SQL Server Express连接到Python并读取通用pandas数据帧。</li></ul><p id="3c45" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">本文假设:</strong></p><ul class=""><li id="1587" class="jd je hi ih b ii ij im in iq jf iu jg iy jh jc ji jj jk jl bi translated">已经安装并设置了MS SQL Server (Express)和Python</li><li id="fe92" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">Python的一些基础知识:模块导入，文件导入，熊猫数据探索，清理和操纵，定义函数和函数参数</li><li id="1c57" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">您已经知道为什么需要SQL Server，您计划如何处理SQL Server中的数据，以及如何找到您的SQL Server连接属性(连接驱动程序、数据库名称等)</li></ul><p id="7f64" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">它不包括SQL或t-SQL命令或使用SQL Server Management Studio中的表——它主要处理Python和SQL之间的数据连接和交互。</strong></p><h1 id="ad7f" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">将坐标输入Python</h1><h2 id="d5cf" class="kr ju hi bd jv ks kt ku jz kv kw kx kd iq ky kz kh iu la lb kl iy lc ld kp le bi translated">Shapefile</h2><p id="f6d7" class="pw-post-body-paragraph if ig hi ih b ii lf ik il im lg io ip iq lh is it iu li iw ix iy lj ja jb jc hb bi translated">shapefile(。shp)是一种地理空间数据格式，它使用多边形和多重多边形等矢量要素来表示地图上的国家。在我的情况下，我需要世界地图的坐标，不需要非常详细。为此，我从<a class="ae js" href="https://www.naturalearthdata.com/downloads/110m-cultural-vectors/" rel="noopener ugc nofollow" target="_blank">这里</a>(顶部绿色按钮)下载了shapefile。</p><p id="7ed5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">下载并解压后，将所有文件复制到脚本工作目录下的一个文件夹中，我的文件夹名为‘100m _ coords’。</p><h2 id="1ff6" class="kr ju hi bd jv ks kt ku jz kv kw kx kd iq ky kz kh iu la lb kl iy lc ld kp le bi translated">导入模块</h2><p id="051a" class="pw-post-body-paragraph if ig hi ih b ii lf ik il im lg io ip iq lh is it iu li iw ix iy lj ja jb jc hb bi translated">导入我们将在此会话中需要的包。</p><pre class="lk ll lm ln fd lo lp lq lr aw ls bi"><span id="61a5" class="kr ju hi lp b fi lt lu l lv lw">import pandas as pd<br/>import geopandas as gpd<br/>import pyodbc<br/>import sqlalchemy as sal<br/>from shapely import wkb</span></pre><p id="ca1d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果您没有安装任何一个，您可以在您的虚拟环境中使用<em class="jr">pip install[包名] </em>安装该模块，例如pip install pyodbc。</p><h2 id="9b69" class="kr ju hi bd jv ks kt ku jz kv kw kx kd iq ky kz kh iu la lb kl iy lc ld kp le bi translated">读取并清理坐标</h2><p id="21ac" class="pw-post-body-paragraph if ig hi ih b ii lf ik il im lg io ip iq lh is it iu li iw ix iy lj ja jb jc hb bi translated"><a class="ae js" href="https://geopandas.org/" rel="noopener ugc nofollow" target="_blank"><strong class="ih hj">geo pandas</strong></a><strong class="ih hj"/>是Python非常方便的处理地理空间数据的库。然而，似乎从MS SQL Server加载地理数据并不简单，因为geopandas方法是为postgreSQL数据库编写的(稍后将详细介绍)。</p><p id="b1df" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">的。读入geopandas的shp文件具有世界上所有国家的几何要素，每个国家都有90多个其他列-我们不需要所有这些列！请随意加载整个shapefile并浏览数据，然后决定您需要哪些数据。在我的例子中，我只对该国家的ISO Alpha 2代码感兴趣，因为这与我稍后将在SQL Server中对其进行分组的销售数据相匹配(本文未涉及)。</p><pre class="lk ll lm ln fd lo lp lq lr aw ls bi"><span id="bbb7" class="kr ju hi lp b fi lt lu l lv lw"># set the folder name + .shp  name that we want<br/>shapefile = ‘110m_coords/ne_110m_admin_0_countries.shp’</span><span id="9c98" class="kr ju hi lp b fi lx lu l lv lw"># read the entire shapefile first <br/>gdf = gpd.read_file(shapefile)</span><span id="7e28" class="kr ju hi lp b fi lx lu l lv lw"># read only the country name (ADMIN), geometry coordinates (geomtry) and the desired country code (in my case ISO_A2)<br/>gdf = gpd.read_file(shapefile)[['ADMIN', 'ISO_A2', 'geometry']]</span><span id="26aa" class="kr ju hi lp b fi lx lu l lv lw"># rename columns <br/>gdf.columns = ['country','ISOA2_code','geometry']</span></pre><p id="6b1f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您现在可能需要进行一些探索，因为地理数据可能需要“清理”。就我而言，快速浏览一下就能发现一些ISO代码并不符合要求——例如挪威:</p><figure class="lk ll lm ln fd lz er es paragraph-image"><div role="button" tabindex="0" class="ma mb di mc bf md"><div class="er es ly"><img src="../Images/78e96a2803bec4381fb82d6ad024e388.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*siVDub1QE-675x1dYt-RbA.png"/></div></div></figure><p id="ab2b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为了检查其余部分，我编写了一个快速函数来打印出所有带有整数(即假)iso代码的国家:</p><pre class="lk ll lm ln fd lo lp lq lr aw ls bi"><span id="e6bc" class="kr ju hi lp b fi lt lu l lv lw">for country,code in (zip(gdf['country'], gdf['ISOA2_code'])): <br/>    try: <br/>        checkint = int(code)<br/>        print(country, checkint)<br/>    except ValueError: <br/>        pass</span></pre><p id="f572" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我知道挪威、法国、北塞浦路斯和索马里兰有错误的ISO Alpha 2代码。实际上，索马里兰似乎没有自己的ISO alpha 2代码，尽管它的坐标占据了地图上的空间。删除该行将会破坏我的世界地图，因此为了我的数据可视化项目，我创建了一个独特的伪代码，它不会与任何其他国家代码冲突，而是添加了它(为了节省您的时间，我选择了YY作为伪代码)。为了用正确的代码替换错误的代码，我使用了<a class="ae js" href="https://www.iban.com/country-codes" rel="noopener ugc nofollow" target="_blank">这个网站</a>和(地理)熊猫。锁定方法。我再举一个挪威的例子:</p><pre class="lk ll lm ln fd lo lp lq lr aw ls bi"><span id="88f9" class="kr ju hi lp b fi lt lu l lv lw"># find index value for Norway <br/>gdf.loc[gdf['country'] == 'Norway']  # Norway index is 21</span><span id="802f" class="kr ju hi lp b fi lx lu l lv lw"># look up iso code online and replace <br/>gdf.loc[21, 'ISOA2_code'] = 'NO'</span></pre><p id="5706" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">最后，我按国家名称对这些值进行了排序:</p><pre class="lk ll lm ln fd lo lp lq lr aw ls bi"><span id="6e2b" class="kr ju hi lp b fi lt lu l lv lw">gdf = gdf.sort_values(by='country', ascending = True).reset_index()</span></pre><h1 id="3683" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">将地理数据导入SQL Server Express 2019</h1><h2 id="52cc" class="kr ju hi bd jv ks kt ku jz kv kw kx kd iq ky kz kh iu la lb kl iy lc ld kp le bi translated">连接到MS SQL Server Express (SQLAlchemy)</h2><p id="5804" class="pw-post-body-paragraph if ig hi ih b ii lf ik il im lg io ip iq lh is it iu li iw ix iy lj ja jb jc hb bi translated">为了将我们的SQL连接到Python，我们使用了一个数据库连接API，它只是我们像其他模块一样导入的一个模块。对于MS SQL Server，这可以通过pyodbc驱动程序或使用SQLAlchemy直接完成。</p><p id="ab6d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> Pyodbc </strong>是MS SQL Server的原生Python驱动程序——有了它，你可以直接与SQL交互。<strong class="ih hj"> SQL Alchemy </strong>是一个对象关系映射(ORM)工具，用于为您创建处理所有交互的模型。还有SQL炼金术核心，更接近传统SQL。对于像在Python和SQL之间加载表这样的简短任务，我只使用pyodbc。然而，一个棘手的问题是<strong class="ih hj"> geopandas方法不支持通过pyodbc直接连接MS SQL Server。</strong>为了将我们的地理数据框读入SQL Server，我们必须使用<strong class="ih hj"> SQL Alchemy。</strong></p><p id="6c97" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为了建立到数据库的连接，我们必须知道四件事情——我们的服务器名、数据库名(我们要添加表的地方)、认证方法和给定数据库的连接驱动程序。</p><p id="3865" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">当我下载并设置我的SQL Server时，我注意到我的<strong class="ih hj">服务器名</strong>是IVETS\SQLEXPRESS，我对数据库使用了Windows <strong class="ih hj">身份验证(</strong>即可信连接)和Native Client 11 <strong class="ih hj">连接驱动程序</strong>。</p><figure class="lk ll lm ln fd lz er es paragraph-image"><div class="er es mg"><img src="../Images/4876ff15027cc1c5c5184c944c849461.png" data-original-src="https://miro.medium.com/v2/resize:fit:1280/format:webp/1*V3L1VkNGMESaFZRQPKw3uQ.png"/></div></figure><p id="d5da" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">所有这些，以及<strong class="ih hj">数据库名称</strong>(在我的例子中是<em class="jr"> V05_ </em>)，都反映在我的连接字符串(<em class="jr">const</em>)中，然后我用它连接到我的SQLAlchemy引擎。</p><pre class="lk ll lm ln fd lo lp lq lr aw ls bi"><span id="fa67" class="kr ju hi lp b fi lt lu l lv lw">constr = 'mssql+pyodbc://IVETS\SQLEXPRESS/V05_?trusted_connection=yes&amp;driver=SQL+Server+Native+Client+11.0'</span><span id="7d70" class="kr ju hi lp b fi lx lu l lv lw">engine = sal.create_engine(constr)<br/>conn = engine.connect()</span></pre><p id="c6b1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果您有一个<strong class="ih hj"> SQL身份验证</strong>设置，您还必须在connectrion字符串中输入您的用户名和密码，它现在采用以下通用格式(<em class="jr">注意:我自己还没有尝试过这个</em>)。</p><pre class="lk ll lm ln fd lo lp lq lr aw ls bi"><span id="7156" class="kr ju hi lp b fi lt lu l lv lw">constr = 'mssql+pyodbc://user:password@server/database'</span></pre><p id="bca2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">请记住，在这种情况下，您可能<strong class="ih hj">而不是</strong>想要将这些硬编码到您的Python脚本中，因为它会带来安全问题。接下来我展示了一个参数化连接函数的例子；这篇文章详细解释了连接MS SQL Server的不同方式，这取决于我们需要的安全级别以及我们计划如何访问连接。</p><h2 id="b3d1" class="kr ju hi bd jv ks kt ku jz kv kw kx kd iq ky kz kh iu la lb kl iy lc ld kp le bi translated">将地理空间数据导入SQL Server数据库</h2><p id="2048" class="pw-post-body-paragraph if ig hi ih b ii lf ik il im lg io ip iq lh is it iu li iw ix iy lj ja jb jc hb bi translated">Pandas有一个方便的<strong class="ih hj"> <em class="jr"> to_sql </em> </strong>方法，可以直接将任何数据帧写入sql数据库表。然而，读取地理数据有点棘手。</p><p id="0b27" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您应该还记得，我们有一个geopandas数据帧，其中有一个“geometry”列，这是一个<strong class="ih hj">几何数据类型</strong>。在我们将数据插入SQL之前，我们必须将几何列转换成一种<strong class="ih hj">十六进制编码的</strong> <strong class="ih hj"> WKB </strong>(众所周知的二进制)数据格式。这是因为稍后我们将在geopandas中使用<em class="jr"> read_postgis </em>方法，该方法只接受WKB格式(非geometry格式)的几何数据，还因为SQL中的‘geometry’数据类型会导致分组操作出现问题。</p><pre class="lk ll lm ln fd lo lp lq lr aw ls bi"><span id="5e12" class="kr ju hi lp b fi lt lu l lv lw"># define a function to convert to wkb <br/>def wkb_hexer(line):<br/>    return line.wkb_hex</span><span id="50ab" class="kr ju hi lp b fi lx lu l lv lw"># apply to each row in the 'geometry' column<br/>gdf['geometry'] = gdf['geometry'].apply(wkb_hexer)</span><span id="1936" class="kr ju hi lp b fi lx lu l lv lw"># finally, insert the dataframe into a table called 'geocoords' <br/>gdf.to_sql('geocoords', con = engine, schema = 'dbo', if_exists = 'replace')</span></pre><p id="2d2d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">“Geocoords”是<strong class="ih hj">的表名</strong>。大多数新创建的数据库的<strong class="ih hj">模式</strong>是‘dbo’。请注意，我已经将<strong class="ih hj"><em class="jr">if _ exists</em></strong><em class="jr"/><strong class="ih hj"><em class="jr">= replace</em></strong><em class="jr"/>作为参数，因为我只打算导入此数据一次，或者通过完全替换它来更正现有数据。如果以后打算添加更多坐标，可以做<em class="jr"> if_exists = append </em>。</p><p id="1912" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，如果我们打开SQL Server Management Studio，刷新我们的数据库并选择表，我们应该会看到我们的新表dbo.geocoords。如果右键单击并选择“选择前100行”，您会看到几何列不再是多边形要素，而是WKB格式。</p><figure class="lk ll lm ln fd lz er es paragraph-image"><div role="button" tabindex="0" class="ma mb di mc bf md"><div class="er es mh"><img src="../Images/3198ed1a69bef5d64f13da626cb6bb39.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*U3FqZ9QVLnbCPvxV4UPt7A.png"/></div></div><figcaption class="mi mj et er es mk ml bd b be z dx translated">gecoords表</figcaption></figure><p id="3b70" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您还可以直接在Python中检查操作是否成功，方法是选择新表中的数据并只读取第一行:</p><pre class="lk ll lm ln fd lo lp lq lr aw ls bi"><span id="426b" class="kr ju hi lp b fi lt lu l lv lw">query = ‘SELECT * FROM geocoords‘</span><span id="166b" class="kr ju hi lp b fi lx lu l lv lw">engine.execute(query).fetchone()</span></pre><h1 id="8955" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated"><strong class="ak"> MS SQL Server Express工作</strong></h1><p id="a4f2" class="pw-post-body-paragraph if ig hi ih b ii lf ik il im lg io ip iq lh is it iu li iw ix iy lj ja jb jc hb bi translated">现在，您可以在SQL Server中操作您的数据，这取决于您最初为什么需要SQL中的数据。由于这不是一篇关于MS SQL Server的文章，所以我不会详细讨论这个问题。在我的例子中，我必须在一个<a class="ae js" href="https://docs.microsoft.com/en-us/sql/relational-databases/views/views?view=sql-server-ver15" rel="noopener ugc nofollow" target="_blank"> <strong class="ih hj">视图</strong> </a> <strong class="ih hj"> </strong>中将销售和地理坐标表组合在一起(类似于pandas中的<em class="jr">合并</em>方法)。很可能您的geocoords和您想要映射的数据之间存在一些差异，在这种情况下，您必须返回以进一步清理/修改您的geocoords数据，并再次在SQL中重新加载它(因此出现了上面的<em class="jr"> if_exist = Replace </em>语句)。</p><figure class="lk ll lm ln fd lz er es paragraph-image"><div role="button" tabindex="0" class="ma mb di mc bf md"><div class="er es mm"><img src="../Images/2424a903dbe3f0e48b75c9fc72246404.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vHFlbWmM5vkBTa0LLlTQ7w.png"/></div></div><figcaption class="mi mj et er es mk ml bd b be z dx translated">视角</figcaption></figure><h1 id="29a1" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">将SQL Server表读回Python</h1><h2 id="c4cb" class="kr ju hi bd jv ks kt ku jz kv kw kx kd iq ky kz kh iu la lb kl iy lc ld kp le bi translated">连接到MS SQL Server Express (pyodbc)</h2><p id="1d7a" class="pw-post-body-paragraph if ig hi ih b ii lf ik il im lg io ip iq lh is it iu li iw ix iy lj ja jb jc hb bi translated">在我们用SQL完成了我们需要的处理之后，让我们把数据读回Python来完成可视化任务！更具体地说，我将阅读我在上面创建的视图。</p><p id="8c9a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">之前，我必须通过SQLAlchemy连接到SQL，以便将地理数据框架读入SQL。这一次我将只使用<strong class="ih hj"> pyodbc </strong>驱动程序，这样我们可以看到一种不同的连接SQL数据库的方式。像SQLAlchemy一样，pyodbc也要求我们构造一个<strong class="ih hj">连接字符串。</strong></p><p id="03b9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在这里，我创建了一个相对灵活的函数，将(地理)数据从SQL读入Python。我已经用<strong class="ih hj">参数化了</strong>服务器名、数据库名和连接驱动程序，所以即使将来有任何更新，我也可以轻松使用这个功能。另外，至关重要是，如果我有SQL身份验证，我可能不希望我的用户名和密码被任何拿到我的Python脚本(或Jupyter笔记本)的人免费获得。</p><p id="873e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果您想读取熊猫的“普通”数据帧，可以通过传递<strong class="ih hj"> geodata = False </strong>来实现。默认选项是我们正在读取地理数据框架，其中我们的坐标列称为“几何”。注意，这里的连接字符串语法不同于上面传递给SQLAlchemy引擎的语法。</p><pre class="lk ll lm ln fd lo lp lq lr aw ls bi"><span id="e8a2" class="kr ju hi lp b fi lt lu l lv lw"># parametrised function that connects to SQL Server and reads data or geodata into pandas or geopandas, respectively</span><span id="309e" class="kr ju hi lp b fi lx lu l lv lw">def sql_data(table, server_name, database_name, driver, geodata = True): <br/>    constr= ("Driver={};"<br/>                "Server={};"<br/>                "Database={};"     <br/>               "Trusted_Connection=yes;").format(driver,server_name, database_name)  <br/>    conn = pyodbc.connect(constr)<br/>    query = 'SELECT * FROM ' + table<br/>    if geodata:<br/>        data = gpd.read_postgis(query, conn, geom_col='geometry')<br/>    else: <br/>        data = pd.read_sql(query, conn)<br/>    conn.close()<br/>    return data</span></pre><p id="c07d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">该函数通过传递参数来应用，我在下面的字典中将这些参数设置为关键字参数。请注意连接驱动程序周围的花括号(Native Client 11.0)。</p><pre class="lk ll lm ln fd lo lp lq lr aw ls bi"><span id="aa06" class="kr ju hi lp b fi lt lu l lv lw"># keys list has the function argument names <br/>keys = ['server_name', 'database_name', 'driver']</span><span id="f468" class="kr ju hi lp b fi lx lu l lv lw"># values list holds the arguments for the SQL connection<br/>values = ['IVETS\SQLEXPRESS', 'V05_', '{SQL Server Native Client 11.0}']</span><span id="61a3" class="kr ju hi lp b fi lx lu l lv lw"># zip the keys and values into a dictionary <br/>serverargs = dict(zip(keys,values))</span><span id="6bb1" class="kr ju hi lp b fi lx lu l lv lw"># in case of e.g. database update, you can change it one time using: <br/>serverargs['database_name'] = 'V06'</span><span id="1bc1" class="kr ju hi lp b fi lx lu l lv lw"># call function we created above: <br/>data = sql_data('View_1', **serverargs)</span></pre><p id="09e5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">最后一件事:空值通常是不需要的，例如由于与json不兼容，所以我用自己选择的字符串替换它们:</p><pre class="lk ll lm ln fd lo lp lq lr aw ls bi"><span id="4928" class="kr ju hi lp b fi lt lu l lv lw">data['SumOrder'].fillna('No data', inplace = True)</span></pre><p id="eb48" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果我们查看我们的新地理数据框架-geo pandas '<strong class="ih hj"><em class="jr">read _ postgis</em></strong>函数已将几何图形正确读取回几何图形格式，在此我们可以看到我们的面矢量要素。</p><figure class="lk ll lm ln fd lz er es paragraph-image"><div role="button" tabindex="0" class="ma mb di mc bf md"><div class="er es mn"><img src="../Images/2a91b774e5b601906428cd65e1883ec1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vh4lOyLhxWEVC7fvHl1vGg.png"/></div></div><figcaption class="mi mj et er es mk ml bd b be z dx translated">地理数据框架视图</figcaption></figure><p id="6cda" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在我终于有了我想要的Python格式的地理销售数据，我按照<a class="ae js" href="https://towardsdatascience.com/a-complete-guide-to-an-interactive-geographical-map-using-python-f4c5197e23e0" rel="noopener" target="_blank">这个</a>非常有用的教程创建了一个交互式散景地图，并且tah-tah:</p><figure class="lk ll lm ln fd lz er es paragraph-image"><div role="button" tabindex="0" class="ma mb di mc bf md"><div class="er es mo"><img src="../Images/ac3aa97a5784e27c97992d2b3885c29d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cL4wd_rVIaZPINrBc_jxXg.png"/></div></div></figure><p id="e3f7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我希望这篇文章(不是那么短)能对任何遇到和我类似挑战的初学者有用:)</p></div></div>    
</body>
</html>