<html>
<head>
<title>Use Correlation to predict Market Index</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用相关性预测市场指数</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/use-correlation-to-predict-market-index-dc16136bd28c?source=collection_archive---------6-----------------------#2021-01-01">https://medium.com/analytics-vidhya/use-correlation-to-predict-market-index-dc16136bd28c?source=collection_archive---------6-----------------------#2021-01-01</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="6e85" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">市场指数由主要公司股票价格列表组成。它们的价格之间应该有关联。这里我想用机器学习模型(LSTM)用某些股票的历史数据来预测市场指数。</p><h1 id="bc77" class="jc jd hh bd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz bi translated">数据收集</h1><p id="8803" class="pw-post-body-paragraph ie if hh ig b ih ka ij ik il kb in io ip kc ir is it kd iv iw ix ke iz ja jb ha bi translated">我使用python包<a class="ae kf" href="https://pypi.org/project/yfinance/" rel="noopener ugc nofollow" target="_blank"> yfinance </a>来获取每日股票价格。我下载了3年的数据，包括“开盘”、“收盘”、“高点”、“低点”和“成交量”</p><h1 id="2837" class="jc jd hh bd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz bi translated">数据预处理</h1><p id="7c43" class="pw-post-body-paragraph ie if hh ig b ih ka ij ik il kb in io ip kc ir is it kd iv iw ix ke iz ja jb ha bi translated">预测的目标变量是指数ETL第二天的收盘价收益率，定义为</p><pre class="kg kh ki kj fd kk kl km kn aw ko bi"><span id="6969" class="kp jd hh kl b fi kq kr l ks kt">target(t) = ( Close(t+1) - Close(t) )/Close(t) * 100%</span></pre><p id="19a7" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">由于股票卷的价值太大，我把它转换成:</p><pre class="kg kh ki kj fd kk kl km kn aw ko bi"><span id="2795" class="kp jd hh kl b fi kq kr l ks kt">log-volume = log(volume+1)</span></pre><p id="dddd" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">注:添加+1以避免对数为零。</p><h1 id="f078" class="jc jd hh bd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz bi translated">特征工程</h1><p id="1e04" class="pw-post-body-paragraph ie if hh ig b ih ka ij ik il kb in io ip kc ir is it kd iv iw ix ke iz ja jb ha bi translated">因为假设指数ETL的价格将取决于历史股票价格，所以我使用了数字:“开盘价”、“收盘价”、“最高价”、“最低价”和“成交量”来构建特征。</p><ol class=""><li id="c7bf" class="ku kv hh ig b ih ii il im ip kw it kx ix ky jb kz la lb lc bi translated">对于[“开盘”、“收盘”、“高”、“低”、“成交量”]中的每一列，我计算了5天的滞后期，这是前一天的数据(I的范围是1-5)。</li><li id="aeff" class="ku kv hh ig b ih ld il le ip lf it lg ix lh jb kz la lb lc bi translated">通过下式计算滞后-i-return:</li></ol><pre class="kg kh ki kj fd kk kl km kn aw ko bi"><span id="9264" class="kp jd hh kl b fi kq kr l ks kt">lag-i-return(t) = ( value(t) - value(t-i) )/ value(t-i) * 100%</span></pre><p id="2164" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">3.为[“打开”、“关闭”、“高”、“低”、“音量”](总共5*5个特征)中的所有滞后值构建PCA变换。</p><p id="5d4d" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">4.使用前3个PCA分量作为最终特征，因为前3个分量已经解释了总方差的80%以上。</p><h1 id="5b33" class="jc jd hh bd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz bi translated">模特培训</h1><p id="6af8" class="pw-post-body-paragraph ie if hh ig b ih ka ij ik il kb in io ip kc ir is it kd iv iw ix ke iz ja jb ha bi translated">我将3个主成分分析特征和目标变量输入LSTM模型，这是一个用于时间序列的常见递归神经网络。我们下载了3年的数据，将80%用于模型训练，20%用于模型测试。PyTorch-Lightning是我们用来编码LSTM模型的ML包。你可以在我的<a class="ae kf" href="https://github.com/iwasnothing/IndexCorTrade/blob/main/lstm_stock.py" rel="noopener ugc nofollow" target="_blank"> Git </a>和<a class="ae kf" href="https://github.com/iwasnothing/IndexCorTrade/blob/main/makes-index-prediction-using-correlation.ipynb" rel="noopener ugc nofollow" target="_blank">笔记本</a>里找到代码。</p><h1 id="fd17" class="jc jd hh bd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz bi translated">超参数调谐</h1><p id="f5ce" class="pw-post-body-paragraph ie if hh ig b ih ka ij ik il kb in io ip kc ir is it kd iv iw ix ke iz ja jb ha bi translated">我使用包<a class="ae kf" href="https://pytorch.org/tutorials/beginner/hyperparameter_tuning_tutorial.html?highlight=transformer" rel="noopener ugc nofollow" target="_blank">射线调整</a>为pytorch模型的超参数调整。超参数包括:</p><ol class=""><li id="5524" class="ku kv hh ig b ih ii il im ip kw it kx ix ky jb kz la lb lc bi translated">时间序列的序列长度</li><li id="bb1b" class="ku kv hh ig b ih ld il le ip lf it lg ix lh jb kz la lb lc bi translated">LSTM层中隐藏状态的数量</li><li id="57c3" class="ku kv hh ig b ih ld il le ip lf it lg ix lh jb kz la lb lc bi translated">模型训练的批量大小</li><li id="7c94" class="ku kv hh ig b ih ld il le ip lf it lg ix lh jb kz la lb lc bi translated">LSTM产出的辍学率</li><li id="ce16" class="ku kv hh ig b ih ld il le ip lf it lg ix lh jb kz la lb lc bi translated">模型训练的学习率(lr)</li><li id="7dd9" class="ku kv hh ig b ih ld il le ip lf it lg ix lh jb kz la lb lc bi translated">LSTM层数</li></ol><pre class="kg kh ki kj fd kk kl km kn aw ko bi"><span id="2586" class="kp jd hh kl b fi kq kr l ks kt">"seq_len": tune.choice([5, 10]),<br/>"hidden_size": tune.choice([10, 50, 100]),<br/>"batch_size": tune.choice([30,60]),<br/>"dropout": tune.choice([0.1, 0.2]),<br/>"lr": tune.loguniform(1e-4, 1e-1),<br/>"num_layers": tune.choice([2, 3, 4])</span></pre><h1 id="0345" class="jc jd hh bd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz bi translated">性能赋值</h1><p id="f4f3" class="pw-post-body-paragraph ie if hh ig b ih ka ij ik il kb in io ip kc ir is it kd iv iw ix ke iz ja jb ha bi translated">虽然模型的预测值是大盘指数的未来收益率，损失函数是MSE，但是我们只关注精度来评价业绩。</p><p id="ff14" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">是因为在真实的交易情况下，它只关心是否盈利或亏损。如果预测它会上涨，而它确实上涨了，交易就获利了。如果预测要跌，而且确实跌了，我们还是可以通过买入逆ETF获利。</p><p id="e6de" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">但是，对于MSE来说，+0.1%和-0.1%的差异很小，但实际上是交易的财务损失。如果方向(上涨/下跌)预测正确，比如说预测值是+0.3%，但实际上涨刚好是+0.1%，差额和前面的情况一样(0.2%)，但交易还是盈利的。</p><h1 id="1d55" class="jc jd hh bd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz bi translated">为训练和测试选择的股票</h1><p id="0880" class="pw-post-body-paragraph ie if hh ig b ih ka ij ik il kb in io ip kc ir is it kd iv iw ix ke iz ja jb ha bi translated">由于我的计算资源有限，我只选择了10只股票来预测市场指数。对于10只股票中的每一只，我将历史价格与市场指数相结合，然后运行模型训练、测试和超参数调整。</p><p id="760d" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我比较了香港市场和美国市场。</p><p id="2bad" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">对于恒生指数，选择的股票是:</p><figure class="kg kh ki kj fd lj er es paragraph-image"><div class="er es li"><img src="../Images/04318998014c4c79d78e26d20a4959c1.png" data-original-src="https://miro.medium.com/v2/resize:fit:664/format:webp/1*Jqck_Rx9x3yAsycffxGDPg.png"/></div></figure><p id="8855" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">对于美国市场，选择的股票是:</p><p id="df7c" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">' FB '，' AAPL '，' AMZN '，'谷歌'，' NFLX '，' SQ '，' MTCH '，' AYX '，' ROKU '，' TTD '</p><p id="3e08" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这是最终的结果。</p><ol class=""><li id="300d" class="ku kv hh ig b ih ii il im ip kw it kx ix ky jb kz la lb lc bi translated">用美团(3690)来预测恒指，最高可以达到58%的准确率。腾讯(700)和平安(2318)也能达到~56%的高准确率。</li><li id="eef1" class="ku kv hh ig b ih ld il le ip lf it lg ix lh jb kz la lb lc bi translated">对于美国市场，使用脸书(FB)和网飞(NFLX)可以分别达到约61%和58%的最高准确率。</li><li id="b32e" class="ku kv hh ig b ih ld il le ip lf it lg ix lh jb kz la lb lc bi translated">这里是HSI的测试数据(黄线)和使用美团(3960)数据的预测值(红线)的图表。</li></ol><figure class="kg kh ki kj fd lj er es paragraph-image"><div class="er es lm"><img src="../Images/f67e45a8d93c6d6b5fc2924b4602752d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1280/format:webp/1*8-2Fyc4tCy5To_GYWNQlJQ.png"/></div></figure><h1 id="43c1" class="jc jd hh bd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz bi translated">交易策略</h1><p id="ee99" class="pw-post-body-paragraph ie if hh ig b ih ka ij ik il kb in io ip kc ir is it kd iv iw ix ke iz ja jb ha bi translated">一个非常简单的交易策略可以是这样的:</p><ol class=""><li id="ac6e" class="ku kv hh ig b ih ii il im ip kw it kx ix ky jb kz la lb lc bi translated">对于10只选择的股票中的每一只，计算市场指数的预测未来回报率。</li><li id="fd41" class="ku kv hh ig b ih ld il le ip lf it lg ix lh jb kz la lb lc bi translated">对准确率&gt; 50%的股票结果进行短列表。</li><li id="5314" class="ku kv hh ig b ih ld il le ip lf it lg ix lh jb kz la lb lc bi translated">通过使用stock-i数据计算预测回报率的加权平均值，计算未来回报率的期望值。</li></ol><pre class="kg kh ki kj fd kk kl km kn aw ko bi"><span id="141d" class="kp jd hh kl b fi kq kr l ks kt">E(Return) = Sum of { accuracy * predicted value)/ sum(accuracy)</span></pre><p id="c9a7" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">4.如果预期收益&gt;预定义的阈值(如交易费的0.03%)，我们买入带止盈/止损(如0.5%)的指数ETF。</p><p id="e4a7" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">5.如果预期收益是负的，我们仍然可以用逆向ETF做同样的事情</p><p id="64cb" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">6.每天用最新的每日数据重复同样的策略。</p><p id="94f7" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">7.(可选)每天在市场结束时平仓所有头寸。</p><h1 id="e80e" class="jc jd hh bd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz bi translated">利润/损失回溯测试</h1><p id="84c2" class="pw-post-body-paragraph ie if hh ig b ih ka ij ik il kb in io ip kc ir is it kd iv iw ix ke iz ja jb ha bi translated">为简单起见，我使用ETF(7200.HK)作为目标收益率，并且也只对这个简化的交易策略进行回溯测试:</p><blockquote class="ln lo lp"><p id="f6b1" class="ie if lq ig b ih ii ij ik il im in io lr iq ir is ls iu iv iw lt iy iz ja jb ha bi translated">如果预期收益率(p[i][0])为正，我们将在开市时买入指数ETF，然后在当天的收盘时卖出，以实际收益率(y[i][0])为损益</p></blockquote><pre class="kg kh ki kj fd kk kl km kn aw ko bi"><span id="05b6" class="kp jd hh kl b fi kq kr l ks kt">for i in range(n):<br/>    if p[i][0] &gt; 0:<br/>        total = total + 1<br/>        if y[i][0] &gt; 0:<br/>            hit = hit + 1<br/>            delta = min(y[i][0],3)<br/>        else:<br/>            delta = max(y[i][0],-3)<br/><br/>        bal = bal + delta</span></pre><p id="e6e7" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">上面的代码是为了计算每日损益(delta)。假设执行的订单以3%的获利限价和止损限价为界。最后，它返回每日平均值(余额/总计)。</p><p id="956d" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">回溯测试的结果是:</p><blockquote class="ln lo lp"><p id="d67d" class="ie if lq ig b ih ii ij ik il im in io lr iq ir is ls iu iv iw lt iy iz ja jb ha bi translated">日均利润0.2% — 0.3%</p></blockquote></div></div>    
</body>
</html>