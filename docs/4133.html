<html>
<head>
<title>How to implement Responsible AI features using raiwidgets</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何使用raiwidgets实现负责任的AI特性</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/how-to-implement-responsible-ai-features-using-raiwidgets-9e7a5600ca5e?source=collection_archive---------7-----------------------#2021-08-30">https://medium.com/analytics-vidhya/how-to-implement-responsible-ai-features-using-raiwidgets-9e7a5600ca5e?source=collection_archive---------7-----------------------#2021-08-30</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><h1 id="db5a" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated">如何使用titanic数据集实现负责任的人工智能特性</h1><h1 id="af04" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated">介绍</h1><h1 id="e4ff" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated">先决条件</h1><ul class=""><li id="e8a3" class="jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt bi translated">Azure帐户</li><li id="fd29" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">Azure存储</li><li id="1ea9" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">Azure机器学习服务</li></ul><h1 id="8514" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated">代码示例</h1><ul class=""><li id="3bd6" class="jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt bi translated">使用笔记本代码执行负责任的人工智能功能</li><li id="e34f" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">可解释性</li><li id="d0e4" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">公平</li><li id="d97a" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">更多</li></ul><h1 id="a46f" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated">库安装</h1><pre class="jz ka kb kc fd kd ke kf kg aw kh bi"><span id="f8b3" class="ki if hh ke b fi kj kk l kl km">!pip install raiwidgets==0.9.2<br/>!pip install fairlearn==0.7.0</span></pre><ul class=""><li id="b58e" class="jc jd hh je b jf kn jh ko jj kp jl kq jn kr jp jq jr js jt bi translated">检查版本</li></ul><pre class="jz ka kb kc fd kd ke kf kg aw kh bi"><span id="d7cb" class="ki if hh ke b fi kj kk l kl km">!pip show fairlearn<br/>!pip show raiwidgets</span></pre><ul class=""><li id="5eb0" class="jc jd hh je b jf kn jh ko jj kp jl kq jn kr jp jq jr js jt bi translated">现在实际的代码</li><li id="40fd" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">从数据集或文件加载数据</li></ul><pre class="jz ka kb kc fd kd ke kf kg aw kh bi"><span id="af08" class="ki if hh ke b fi kj kk l kl km">from raiwidgets import ExplanationDashboard</span><span id="fc9c" class="ki if hh ke b fi ks kk l kl km">from azureml.core import Dataset<br/>from azureml.data.dataset_factory import DataType</span><span id="e04f" class="ki if hh ke b fi ks kk l kl km"># create a TabularDataset from a delimited file behind a public web url and convert column "Survived" to boolean<br/>web_path ='https://dprepdata.blob.core.windows.net/demo/Titanic.csv'<br/>titanic_ds = Dataset.Tabular.from_delimited_files(path=web_path, set_column_types={'Survived': DataType.to_bool()})</span><span id="7c83" class="ki if hh ke b fi ks kk l kl km"># preview the first 3 rows of titanic_ds<br/>titanic_ds.take(3).to_pandas_dataframe()<br/>from azureml.core import Workspace, Dataset</span><span id="f302" class="ki if hh ke b fi ks kk l kl km">import pandas as pd<br/>import numpy as np</span><span id="642c" class="ki if hh ke b fi ks kk l kl km">df = pd.read_csv('Titanic.csv')<br/>df.head()</span><span id="c95e" class="ki if hh ke b fi ks kk l kl km">df['id'] = df[['Name']].sum(axis=1).map(hash)</span><span id="f9eb" class="ki if hh ke b fi ks kk l kl km">titanic_features = df.copy()<br/>titanic_labels = titanic_features.pop('Survived')</span><span id="0082" class="ki if hh ke b fi ks kk l kl km">df.drop('Name', axis=1, inplace=True)</span><span id="79d5" class="ki if hh ke b fi ks kk l kl km">from sklearn.preprocessing import LabelEncoder, OneHotEncoder<br/>import sklearn as sk</span><span id="ceac" class="ki if hh ke b fi ks kk l kl km">df1 = pd.get_dummies(df)</span><span id="83bf" class="ki if hh ke b fi ks kk l kl km">y = df1['Survived']</span><span id="40da" class="ki if hh ke b fi ks kk l kl km">X = df1<br/>X = X.drop(columns=['Survived'])<br/>X['Age'] = X['Age'].fillna(0)<br/>X = X.dropna()</span><span id="c48b" class="ki if hh ke b fi ks kk l kl km">import pandas as pd<br/>import seaborn as sn<br/>import matplotlib.pyplot as plt<br/>from sklearn.preprocessing import StandardScaler<br/>from sklearn.linear_model import LogisticRegression<br/>from tqdm import tqdm<br/>from sklearn import preprocessing</span><span id="c489" class="ki if hh ke b fi ks kk l kl km">from sklearn.model_selection import train_test_split</span><span id="3256" class="ki if hh ke b fi ks kk l kl km">X_train, X_test, y_train, y_test = train_test_split(X, y, test_size=0.33, random_state=42)</span><span id="9bc3" class="ki if hh ke b fi ks kk l kl km">import sklearn as sk<br/>from sklearn.linear_model import LogisticRegression</span><span id="fa17" class="ki if hh ke b fi ks kk l kl km">LR = LogisticRegression(random_state=0, solver='lbfgs', multi_class='ovr').fit(X, y)<br/>LR.predict(X.iloc[460:,:])<br/>round(LR.score(X,y), 4)</span><span id="e10d" class="ki if hh ke b fi ks kk l kl km">y_pred = LR.predict(X_test)</span><span id="60b2" class="ki if hh ke b fi ks kk l kl km">from sklearn.metrics import roc_auc_score<br/>from sklearn.metrics import f1_score</span><span id="baad" class="ki if hh ke b fi ks kk l kl km">from sklearn import metrics<br/>print(metrics.classification_report(y_test, y_pred))</span><span id="2296" class="ki if hh ke b fi ks kk l kl km">from sklearn.datasets import load_breast_cancer<br/>from sklearn import svm</span><span id="a1bd" class="ki if hh ke b fi ks kk l kl km"># Explainers:<br/># 1. SHAP Tabular Explainer<br/>#from interpret.ext.blackbox import TabularExplainer<br/>from interpret.ext.blackbox import TabularExplainer</span><span id="ff2c" class="ki if hh ke b fi ks kk l kl km">classes = X_train.columns.tolist()</span><span id="97dc" class="ki if hh ke b fi ks kk l kl km">explainer = TabularExplainer(LR, <br/>                             X_train, <br/>                             features=X.columns, <br/>                             classes=['Sex_male', 'Sex_female'])</span><span id="e554" class="ki if hh ke b fi ks kk l kl km">from interpret.ext.blackbox import MimicExplainer</span><span id="79f8" class="ki if hh ke b fi ks kk l kl km"># you can use one of the following four interpretable models as a global surrogate to the black box model</span><span id="632f" class="ki if hh ke b fi ks kk l kl km">from interpret.ext.glassbox import LGBMExplainableModel<br/>from interpret.ext.glassbox import LinearExplainableModel<br/>from interpret.ext.glassbox import SGDExplainableModel<br/>from interpret.ext.glassbox import DecisionTreeExplainableModel</span><span id="9d09" class="ki if hh ke b fi ks kk l kl km"># "features" and "classes" fields are optional<br/># augment_data is optional and if true, oversamples the initialization examples to improve surrogate model accuracy to fit original model.  Useful for high-dimensional data where the number of rows is less than the number of columns. <br/># max_num_of_augmentations is optional and defines max number of times we can increase the input data size.<br/># LGBMExplainableModel can be replaced with LinearExplainableModel, SGDExplainableModel, or DecisionTreeExplainableModel<br/>explainer = MimicExplainer(LR, <br/>                           X_train, <br/>                           LGBMExplainableModel, <br/>                           augment_data=True, <br/>                           max_num_of_augmentations=10, <br/>                           features=X.columns, <br/>                           classes=['Sex_male', 'Sex_female'])</span><span id="c5fa" class="ki if hh ke b fi ks kk l kl km">global_explanation = explainer.explain_global(X_test)</span><span id="3f8b" class="ki if hh ke b fi ks kk l kl km">from raiwidgets import ExplanationDashboard</span><span id="7132" class="ki if hh ke b fi ks kk l kl km">ExplanationDashboard(global_explanation, LR, dataset=X_test, true_y=y_test)</span></pre><figure class="jz ka kb kc fd ku er es paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="er es kt"><img src="../Images/09fb0a39601a9df88cad593d1efc93c0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*ORZwMoyi7PSUJUMZ.jpg"/></div></div></figure><figure class="jz ka kb kc fd ku er es paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="er es lb"><img src="../Images/2c09d0c0f9750f19376086ce5692134e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*GVqw-fJqrveyoT29.jpg"/></div></div></figure><figure class="jz ka kb kc fd ku er es paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="er es lc"><img src="../Images/ce978527ea64f79d01934be2b3586a97.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*QX149Ah9-VNbNJ8E.jpg"/></div></div></figure><figure class="jz ka kb kc fd ku er es paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="er es ld"><img src="../Images/b275c4ab40a971f7d3975fc9b0c0ae3a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*ZQVDUxgkzs1G1S1I.jpg"/></div></div></figure><pre class="jz ka kb kc fd kd ke kf kg aw kh bi"><span id="ae26" class="ki if hh ke b fi kj kk l kl km"># Sorted SHAP values<br/>print('ranked global importance values: {}'.format(global_explanation.get_ranked_global_values()))<br/># Corresponding feature names<br/>print('ranked global importance names: {}'.format(global_explanation.get_ranked_global_names()))<br/># Feature ranks (based on original order of features)<br/>print('global importance rank: {}'.format(global_explanation.global_importance_rank))<br/><br/># Note: Do not run this cell if using PFIExplainer, it does not support per class explanations<br/># Per class feature names<br/>print('ranked per class feature names: {}'.format(global_explanation.get_ranked_per_class_names()))<br/># Per class feature importance values<br/>print('ranked per class feature values: {}'.format(global_explanation.get_ranked_per_class_values()))</span><span id="cb49" class="ki if hh ke b fi ks kk l kl km"># Print out a dictionary that holds the sorted feature importance names and values<br/>print('global importance rank: {}'.format(global_explanation.get_feature_importance_dict()))</span><span id="f6cb" class="ki if hh ke b fi ks kk l kl km">sex = df['Sex']<br/>sex.value_counts()</span><span id="a653" class="ki if hh ke b fi ks kk l kl km">y_true = y_test<br/>len(y_test)<br/>len(y_pred)</span><span id="05c9" class="ki if hh ke b fi ks kk l kl km">sensitivefeatures = X_test[['Sex_male', 'Sex_female']]<br/>sensitivefeatures</span><span id="572c" class="ki if hh ke b fi ks kk l kl km">print ("Confusion Matrix:")<br/>print (metrics.confusion_matrix(y_test, y_pred))</span><span id="f270" class="ki if hh ke b fi ks kk l kl km">gm = MetricFrame(metrics=accuracy_score, y_true=y_test, y_pred=y_pred, sensitive_features=sensitivefeatures)<br/>print(gm.overall)<br/>print(gm.by_group)</span><span id="6b87" class="ki if hh ke b fi ks kk l kl km">from fairlearn.metrics import selection_rate<br/>sr = MetricFrame(metrics=selection_rate, y_true=y_true, y_pred=y_pred, sensitive_features=sensitivefeatures)</span></pre><ul class=""><li id="27d0" class="jc jd hh je b jf kn jh ko jj kp jl kq jn kr jp jq jr js jt bi translated">公平</li></ul><pre class="jz ka kb kc fd kd ke kf kg aw kh bi"><span id="1d30" class="ki if hh ke b fi kj kk l kl km">from raiwidgets import FairnessDashboard<br/><br/># A_test contains your sensitive features (e.g., age, binary gender)<br/># y_true contains ground truth labels<br/># y_pred contains prediction labels<br/><br/>FairnessDashboard(sensitive_features=sensitivefeatures,<br/>                  y_true=y_test.tolist(),<br/>                  y_pred=y_pred)</span></pre><figure class="jz ka kb kc fd ku er es paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="er es le"><img src="../Images/4611aa300e8b87a6fbcc9616eb415d59.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*a3hf8j4uxP5eDncG.jpg"/></div></div></figure><figure class="jz ka kb kc fd ku er es paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="er es lf"><img src="../Images/26cb119663c990773e6796a6f75e6f64.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*EgmYz7IfnsntIf8n.jpg"/></div></div></figure><figure class="jz ka kb kc fd ku er es paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="er es lg"><img src="../Images/529e65ec40c0f0662685ce29dd6cea8e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*I1ah5UblMVQzE9Ux.jpg"/></div></div></figure><figure class="jz ka kb kc fd ku er es paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="er es lh"><img src="../Images/3613b1b328884e31722f5355775b2ba2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*KKlMpXEx7P73VSNI.jpg"/></div></div></figure><figure class="jz ka kb kc fd ku er es paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="er es li"><img src="../Images/d45e94f570df58ddf132a9a23d8f3f2f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*aZSvcHQ6quq-lNx_.jpg"/></div></div></figure><figure class="jz ka kb kc fd ku er es paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="er es lj"><img src="../Images/6cd7b04d7fceedc5d6b1b49c12293507.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*HtAasXxpyPvuW0ke.jpg"/></div></div></figure><figure class="jz ka kb kc fd ku er es paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="er es lk"><img src="../Images/d75ea3cd1bd42478f430865f87e88ac8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*R60SlfN_0T9Tvsua.jpg"/></div></div></figure></div><div class="ab cl ll lm go ln" role="separator"><span class="lo bw bk lp lq lr"/><span class="lo bw bk lp lq lr"/><span class="lo bw bk lp lq"/></div><div class="ha hb hc hd he"><p id="35ec" class="pw-post-body-paragraph ls lt hh je b jf kn lu lv jh ko lw lx jj ly lz ma jl mb mc md jn me mf mg jp ha bi translated"><em class="mh">最初发表于</em><a class="ae mi" href="https://github.com/balakreshnan/Samples2021/blob/main/ResponsibleAI/titanicrai.md" rel="noopener ugc nofollow" target="_blank"><em class="mh">【https://github.com】</em></a><em class="mh">。</em></p></div></div>    
</body>
</html>