<html>
<head>
<title>A CNN to Classify Pneumonia, Step by Step Using PyTorch</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">CNN用PyTorch一步一步对肺炎进行分类</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/a-cnn-to-classify-pneumonia-step-by-step-using-pytorch-13a90905abd7?source=collection_archive---------7-----------------------#2021-08-14">https://medium.com/analytics-vidhya/a-cnn-to-classify-pneumonia-step-by-step-using-pytorch-13a90905abd7?source=collection_archive---------7-----------------------#2021-08-14</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="6ab6" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">神经网络已经主导了机器学习领域大约十年了，并且一年比一年好。鉴于医学数据的重要性及其广泛应用，自然会看到神经网络被用于解决生物医学问题。在本文中，我们将使用MobileNetV3来解决医学领域中的一个分类问题。敬请期待！</p><p id="0d50" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">注:这个问题的代码可以通过<a class="ae jc" href="https://colab.research.google.com/drive/1Mo5wrQZB3Jpyf095TvGkmZF9nerXF7Iq?usp=sharing" rel="noopener ugc nofollow" target="_blank">这个Google Colab笔记本</a>、<a class="ae jc" href="https://www.kaggle.com/etfaret/mobilenetv3-transferlearning-train-in-20-mins" rel="noopener ugc nofollow" target="_blank">这个Kaggle内核</a>、<a class="ae jc" href="https://github.com/FeryET/pneumonia_analysis" rel="noopener ugc nofollow" target="_blank">这个GitHub repo </a>获得。本文总结了代码背后发生的事情。笔记本上描述了一步一步的过程。</p><h1 id="22ac" class="jd je hh bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">介绍</h1><p id="7880" class="pw-post-body-paragraph ie if hh ig b ih kb ij ik il kc in io ip kd ir is it ke iv iw ix kf iz ja jb ha bi translated">据<a class="ae jc" href="https://en.wikipedia.org/wiki/Pneumonia" rel="noopener ugc nofollow" target="_blank">维基百科</a>:</p><blockquote class="kg kh ki"><p id="0509" class="ie if kj ig b ih ii ij ik il im in io kk iq ir is kl iu iv iw km iy iz ja jb ha bi translated"><strong class="ig hi">肺炎</strong>是<a class="ae jc" href="https://en.wikipedia.org/wiki/Inflammation" rel="noopener ugc nofollow" target="_blank">肺部<a class="ae jc" href="https://en.wikipedia.org/wiki/Lung" rel="noopener ugc nofollow" target="_blank">的一种</a>炎症</a>，主要影响被称为<a class="ae jc" href="https://en.wikipedia.org/wiki/Pulmonary_alveolus" rel="noopener ugc nofollow" target="_blank">肺泡</a>的小气囊。典型的症状包括某种组合的<a class="ae jc" href="https://en.wikipedia.org/wiki/Phlegm" rel="noopener ugc nofollow" target="_blank">多产</a>或<a class="ae jc" href="https://en.wikipedia.org/wiki/Cough" rel="noopener ugc nofollow" target="_blank">干咳</a>、<a class="ae jc" href="https://en.wikipedia.org/wiki/Chest_pain" rel="noopener ugc nofollow" target="_blank">胸痛</a>、<a class="ae jc" href="https://en.wikipedia.org/wiki/Fever" rel="noopener ugc nofollow" target="_blank">发烧</a>和<a class="ae jc" href="https://en.wikipedia.org/wiki/Shortness_of_breath" rel="noopener ugc nofollow" target="_blank">呼吸困难</a>。病情的严重程度是可变的。</p></blockquote><p id="1fa9" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">医生用来确定患者是否患有肺炎的方法之一是分析他们的x光图像。使用这些图像中的信息，他们可以看到肺炎如何影响病人，它有多严重，以及肺部的哪个部分受其影响最大。您可以在图1中看到一个例子。</p><figure class="ko kp kq kr fd ks er es paragraph-image"><div role="button" tabindex="0" class="kt ku di kv bf kw"><div class="er es kn"><img src="../Images/996f538de3f4460ecb37ea48642e618c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*gSonAqcXVpuEDPir.jpg"/></div></div><figcaption class="kz la et er es lb lc bd b be z dx translated">图一。患有严重肺炎的肺部。患者是一名88岁的男子，他有一周的发烧、咳嗽和疲劳。测试表明，他正在对付甲型流感病毒和甲型流感嗜血杆菌。这种情况在肺的右上部分尤为明显。由维基百科提供。</figcaption></figure><h2 id="4845" class="le je hh bd jf lf lg lh jj li lj lk jn ip ll lm jr it ln lo jv ix lp lq jz lr bi translated">数据集</h2><p id="77ca" class="pw-post-body-paragraph ie if hh ig b ih kb ij ik il kc in io ip kd ir is it ke iv iw ix kf iz ja jb ha bi translated">我们针对这个问题使用的数据集是“<a class="ae jc" href="https://www.kaggle.com/paultimothymooney/chest-xray-pneumonia/code" rel="noopener ugc nofollow" target="_blank">胸部X线图像(肺炎)</a>”，最初由<a class="ae jc" href="https://www.cell.com/cell/fulltext/S0092-8674(18)30154-5" rel="noopener ugc nofollow" target="_blank">本文</a>介绍。它由大约5，863张正常和患病患者肺部的高质量x射线图像组成，这些患者具有不同的性别和年龄组，患病患者的病因被指示为细菌或病毒。它被分成三个不同的组，训练，测试和验证。训练子集的分布不均衡，肺炎患者占大多数(见图2)。数据集还包括不同维度的图像，这使得调整大小预处理步骤是必要的。(参见图3)。</p><figure class="ko kp kq kr fd ks er es paragraph-image"><div class="er es ls"><img src="../Images/a4bfd153c4c440a337ef51a73d8e4007.png" data-original-src="https://miro.medium.com/v2/resize:fit:762/format:webp/0*gQOQMQ-G32dsia8h.png"/></div><figcaption class="kz la et er es lb lc bd b be z dx translated">图二。列车组是不平衡的，大多数病例是处理肺炎的患者。</figcaption></figure><figure class="ko kp kq kr fd ks er es paragraph-image"><div class="er es lt"><img src="../Images/8d2ded3137dbf26b1858f74f5e64e564.png" data-original-src="https://miro.medium.com/v2/resize:fit:998/format:webp/1*wShV898nXpBY9PsD52qEVg.png"/></div><figcaption class="kz la et er es lb lc bd b be z dx translated">图3。列车子集中x射线图像的宽度、高度和纵横比的分布。</figcaption></figure><h1 id="5c38" class="jd je hh bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">预处理</h1><p id="2b98" class="pw-post-body-paragraph ie if hh ig b ih kb ij ik il kc in io ip kd ir is it ke iv iw ix kf iz ja jb ha bi translated">正如我上面提到的，图像大小在宽度和高度上都有所不同，没有唯一的纵横比。为了解决这个问题，我们应该选择一个基本尺寸，所有的图像都可以调整到这个尺寸，这样我们就可以给网络提供完全相同尺寸的图像。看看图3，我们可以得出结论，使用比大多数图像更小但仍能保持图像细节的尺寸是非常重要的一步。尺寸越大，我们拥有的细节就越多。考虑到这一点，我们仍然不能使输入图像的尺寸大于数据集的一个显著的块。因此，我选择了256x256。选择这个的一个原因是我们需要选择一个能被32整除的图像大小，因为MobileNetV3的架构。您可以在图4中看到调整后的训练集的示例。</p><figure class="ko kp kq kr fd ks er es paragraph-image"><div role="button" tabindex="0" class="kt ku di kv bf kw"><div class="er es lu"><img src="../Images/a1a6b94c00182abc0f226da138898728.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*iZwzX19PQ_qMaY2fsJZuQw.png"/></div></div><figcaption class="kz la et er es lb lc bd b be z dx translated">图4。数据集中两个类的样本，大小调整为256x256。</figcaption></figure><p id="21ca" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">由于数据集已经过预处理和质量控制，我们不需要进一步处理数据。x射线图像没有标准的尺寸、照明、对比度协议，进一步处理数据可能会给模型带来一定的隐含偏差。我们在训练阶段使用数据扩充，以使模型对输入域中的这些类型的变化具有鲁棒性。</p><h1 id="f89c" class="jd je hh bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">模型</h1><h2 id="02dd" class="le je hh bd jf lf lg lh jj li lj lk jn ip ll lm jr it ln lo jv ix lp lq jz lr bi translated">体系结构</h2><p id="46a7" class="pw-post-body-paragraph ie if hh ig b ih kb ij ik il kc in io ip kd ir is it ke iv iw ix kf iz ja jb ha bi translated">我们在这个项目中使用的模型是MobileNetV3。MobileNetV3是一个非常轻量级的CNN，适合在资源有限的手机中使用，这使得它对于缺乏良好的预训练基线和特定领域的问题非常有吸引力。另外，我们正在使用像Google Colab或Kaggle这样有时间限制的资源。因此，使用一个小而强大的CNN更有意义。我们将使用一个在图像网络上预先训练的移动网络，并将微调它后面的层。我们用的MobileNetV3是小版本，因为我们在尽量减少参数的数量。您可以在图5中看到该模型的架构。</p><figure class="ko kp kq kr fd ks er es paragraph-image"><div class="er es lv"><img src="../Images/53a2d4b278f28573bc2d2832d7e95276.png" data-original-src="https://miro.medium.com/v2/resize:fit:1260/0*i24rMuJk9CrbF3af"/></div><figcaption class="kz la et er es lb lc bd b be z dx translated">图5。MobileNetV3小版本的架构。由Howard等人提供，复制自MobileNetV3的原始论文。</figcaption></figure><p id="f26c" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我们使用模型的主干，即7x7池层之前的所有层，下一步，冻结主干中除最后一个瓶颈层和随后的conv2d层之外的所有层。我们冻结前两层的原因是，他们已经学习了输入图像的丰富的一般表示，并且已经拥有对输入空间的大量概括理解，可以将输入空间映射到非常复杂的非线性空间。后面几层创建了最终的“决定性”特性，这些特性通常更加针对具体的问题。此外，与我们自己引入的其他层相比，我们对这些未冻结层采用小得多的学习速率，从而微调最后两层，而不是重置它们。</p><p id="f1c3" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在主干之后，我们使用一个全局平均池层，它将8x8功能图映射到1x1，然后是一个dropout和一个使用Softmax激活的具有两个输出的线性层。最终模型的架构描述如下(使用torch-summary):</p><figure class="ko kp kq kr fd ks"><div class="bz dy l di"><div class="lw lx l"/></div><figcaption class="kz la et er es lb lc bd b be z dx translated">表1。肺炎网络架构。</figcaption></figure><p id="e94d" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">正如你所看到的，最后一个反向残差层和下面的ConvBNActivation层是我们微调的原始主干中仅有的两个层。</p><h2 id="8244" class="le je hh bd jf lf lg lh jj li lj lk jn ip ll lm jr it ln lo jv ix lp lq jz lr bi translated">失败</h2><p id="3516" class="pw-post-body-paragraph ie if hh ig b ih kb ij ik il kc in io ip kd ir is it ke iv iw ix kf iz ja jb ha bi translated">由于训练集中标签的不平衡，我们使用加权交叉熵损失来得到一个更加平衡的模型。计算损失权重的公式为:</p><pre class="ko kp kq kr fd ly lz ma mb aw mc bi"><span id="2e64" class="le je hh lz b fi md me l mf mg">weight[label] = n_total_samples/ (n_label_samples * num_labels)</span></pre><p id="5b4f" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">使用这个公式，我们可以确保少数类样本的权重大于多数类样本的权重，因此我们可以学习输入数据的平衡表示。</p><h1 id="fd6a" class="jd je hh bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">培养</h1><p id="a856" class="pw-post-body-paragraph ie if hh ig b ih kb ij ik il kc in io ip kd ir is it ke iv iw ix kf iz ja jb ha bi translated">为了训练模型，定义了一个训练师类，可以在笔记本上看到。所有训练参数都可以在笔记本的“常量”标题下找到。关于训练器类的一个值得注意的事情是使用早期停止作为正则化方案来避免过度拟合，并且对于最终的测试数据，只使用在验证数据上具有最佳性能的模型。</p><p id="38e1" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">而且我们用的优化器是AdamW，权重衰减5e-2。线性层的学习速率选择为1e-2，微调CNN后面层的学习速率选择为1e-6。要注意的另一件重要事情是，我们使用带有热重启的余弦退火方案，以便衰减两个参数组的学习速率。每次重新启动后，周期的长度也会变得更长，使得模型的学习性能在训练阶段结束时保持稳定。您可以在图6中看到模型的训练历史。</p><figure class="ko kp kq kr fd ks er es paragraph-image"><div class="er es mh"><img src="../Images/19ba2fbed08059bef58f0066b389c6b1.png" data-original-src="https://miro.medium.com/v2/resize:fit:868/format:webp/1*hWWx6kCrji4iZwhtdoOaOA.png"/></div><figcaption class="kz la et er es lb lc bd b be z dx translated">图6。肺炎链球菌的训练史。</figcaption></figure><p id="f50e" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">您可以在表2和图7中看到模型在测试集上的性能。</p><figure class="ko kp kq kr fd ks"><div class="bz dy l di"><div class="lw lx l"/></div><figcaption class="kz la et er es lb lc bd b be z dx translated">表二。试验数据上肺炎杆菌的性能。</figcaption></figure><figure class="ko kp kq kr fd ks er es paragraph-image"><div class="er es mi"><img src="../Images/679a8e67e7337e1515ce4bfec2014dba.png" data-original-src="https://miro.medium.com/v2/resize:fit:724/format:webp/1*QtNEk7JpT0HX2sD0WeTzeA.png"/></div><figcaption class="kz la et er es lb lc bd b be z dx translated">图7。肺炎的混淆矩阵。</figcaption></figure><p id="d747" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">从结果中可以明显看出，该模型在检测实际的肺炎病例时具有非常高的可信度，同时有将正常人归类为患病的趋势。虽然这在大多数情况下听起来不好，因为对疾病进行分类的重要性远远大于错误分类，但在这种情况下，这实际上并不是一件坏事。如您所见，该模型对于正常类具有非常高的精度，这意味着它在说患者健康时具有很高的可信度。88%的准确率和87%的加权f1分数，显示了这种轻量级模型的能力。</p><h1 id="1935" class="jd je hh bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">结论</h1><p id="7cfa" class="pw-post-body-paragraph ie if hh ig b ih kb ij ik il kc in io ip kd ir is it ke iv iw ix kf iz ja jb ha bi translated">在本文中，我们使用了一个经过预训练的MobileNetV3，一个非常轻量级的CNN，来对肺炎患者和健康人的x射线图像进行分类。通过微调MobileNetV3的后面几层，并使用早期停止和余弦退火方案来提高模型的学习能力，我们开发了一个稳健的模型，该模型具有非常好的性能，特别是风险调整后的性能。</p></div></div>    
</body>
</html>