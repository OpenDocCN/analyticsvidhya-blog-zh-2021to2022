<html>
<head>
<title>Serverless your Machine Learning Model with Pycaret and AWS Lambda</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Pycaret和AWS Lambda的无服务器机器学习模型</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/serverless-your-machine-learning-model-with-pycaret-and-aws-lambda-c33334ee6011?source=collection_archive---------4-----------------------#2021-08-08">https://medium.com/analytics-vidhya/serverless-your-machine-learning-model-with-pycaret-and-aws-lambda-c33334ee6011?source=collection_archive---------4-----------------------#2021-08-08</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><figure class="ev ex if ig ih ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es ie"><img src="../Images/ddaac80233fb2ff828a78566d9b7d3bc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9EQCMU_d_cejrCyh43I9mA.png"/></div></div></figure><p id="8795" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">机器学习工程师的生活并不简单。我们从不完整的需求和数据开始，设计许多实验。最后，构建一个高效、可扩展的推理过程。就机器学习而言，越来越多的人在谈论无服务器。我们希望打造高效、先进的解决方案，同时还应该灵活、易于实施。不可能？我想是这样的，但是我们专注于为商业创造有利可图的解决方案的策略在设计过程中给了我们很大的优势。机器学习环境中的无服务器架构似乎很理想，因为我们有:</p><ul class=""><li id="3653" class="jn jo hh ir b is it iw ix ja jp je jq ji jr jm js jt ju jv bi translated">没有对基础设施的管理</li><li id="72a8" class="jn jo hh ir b is jw iw jx ja jy je jz ji ka jm js jt ju jv bi translated">自动资源缩放</li><li id="66c6" class="jn jo hh ir b is jw iw jx ja jy je jz ji ka jm js jt ju jv bi translated">为我们使用的东西付费</li></ul><p id="afd3" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">如果你被这三个基本论点所说服——继续。在本文中，我们将基于无服务器架构构建一个简单的httpAPI。为此，我们将使用:</p><ul class=""><li id="1ecd" class="jn jo hh ir b is it iw ix ja jp je jq ji jr jm js jt ju jv bi translated">基于AutoML-py caret库构建的模型</li><li id="5070" class="jn jo hh ir b is jw iw jx ja jy je jz ji ka jm js jt ju jv bi translated">自动化架构构建的无服务器框架</li><li id="dad8" class="jn jo hh ir b is jw iw jx ja jy je jz ji ka jm js jt ju jv bi translated">AWS Lambda和API网关为我们的解决方案提供一个端点</li></ul><p id="591f" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated"><strong class="ir hi">走吧！</strong></p><figure class="kc kd ke kf fd ii er es paragraph-image"><div class="er es kb"><img src="../Images/10b0565deeb072e7538a0d3823092c2e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/1*eKK3ldHry_IwBZ6hErEdKA.gif"/></div></figure><h1 id="9e21" class="kg kh hh bd ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld bi translated">长话短说</h1><p id="f1da" class="pw-post-body-paragraph ip iq hh ir b is le iu iv iw lf iy iz ja lg jc jd je lh jg jh ji li jk jl jm ha bi translated">让我们假设一家基础设施完全基于AWS的成长型初创公司的CEO想要成为我们的客户。“AirRent”的商业价值是帮助在Airbnb上执行租赁过程。他们想创建一个快速的概念证明，并检查是否有可能估计在阿姆斯特丹租一套公寓的价格并增加房地产的维护费。目前，客户并不关心模型本身，而是关心成本和PoC的执行速度。我们承担这项工作，并制定最低计划:</p><ul class=""><li id="bf53" class="jn jo hh ir b is it iw ix ja jp je jq ji jr jm js jt ju jv bi translated">基于AutoML解决方案，使用EDA、特征工程、模型选择和可解释性创建简化的机器学习实验</li><li id="0d86" class="jn jo hh ir b is jw iw jx ja jy je jz ji ka jm js jt ju jv bi translated">用于开发实现无服务器机器学习架构的整个管道的无服务器框架</li><li id="3d09" class="jn jo hh ir b is jw iw jx ja jy je jz ji ka jm js jt ju jv bi translated">使用专用容器实现AWS Lambda，以进行价格预测和预报</li></ul></div><div class="ab cl lj lk go ll" role="separator"><span class="lm bw bk ln lo lp"/><span class="lm bw bk ln lo lp"/><span class="lm bw bk ln lo"/></div><div class="ha hb hc hd he"><p id="ab11" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">完整源代码可在<a class="ae lq" href="https://github.com/g0lemXIV/serverless-machine-learning" rel="noopener ugc nofollow" target="_blank"> <strong class="ir hi"> Github </strong> </a>上获得</p></div><div class="ab cl lj lk go ll" role="separator"><span class="lm bw bk ln lo lp"/><span class="lm bw bk ln lo lp"/><span class="lm bw bk ln lo"/></div><div class="ha hb hc hd he"><h1 id="927d" class="kg kh hh bd ki kj lr kl km kn ls kp kq kr lt kt ku kv lu kx ky kz lv lb lc ld bi translated">PyCaret AutoML</h1><figure class="kc kd ke kf fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es lw"><img src="../Images/6898c8fda5a1fd14ba1efdf9e9b33d80.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*q0DS1Cbs9jumHsjH4_1USA.png"/></div></div><figcaption class="lx ly et er es lz ma bd b be z dx translated"><a class="ae lq" href="https://pycaret.org/about/" rel="noopener ugc nofollow" target="_blank"> Pycaret模块</a></figcaption></figure><p id="1ab9" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">如果你不熟悉为低代码机器学习设计的PyCaret库。我强烈推荐查看Moez Ali的文章，他是这个伟大框架的主要创建者。</p><h2 id="4c24" class="md kh hh bd ki me mf mg km mh mi mj kq ja mk ml ku je mm mn ky ji mo mp lc mq bi translated">自动化探索性数据分析</h2><p id="13ac" class="pw-post-body-paragraph ip iq hh ir b is le iu iv iw lf iy iz ja lg jc jd je lh jg jh ji li jk jl jm ha bi translated">假设我们想要下载数据并创建一个简单的仪表板来进行探索性的数据分析。为此，最好的解决方案可能是<a class="ae lq" href="https://github.com/pandas-profiling/pandas-profiling" rel="noopener ugc nofollow" target="_blank">熊猫简介</a></p><figure class="kc kd ke kf fd ii"><div class="bz dy l di"><div class="mr ms l"/></div></figure><p id="8a09" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">脚本从I<a class="ae lq" href="http://insideairbnb.com/" rel="noopener ugc nofollow" target="_blank">nsideairbnb.com</a>下载数据并保存，生成基本EDA分析。现在，我们可以分析关于数据的基本信息，并决定哪些数据值得在以后的实验中使用。速度很快，对吧？</p><figure class="kc kd ke kf fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es mt"><img src="../Images/b35cd22d00ec5c572b669334f52bfeff.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*3svqMG6pwaGwvGvBUBsaSw.gif"/></div></div><figcaption class="lx ly et er es lz ma bd b be z dx translated">HTML小部件中熊猫概况的输出</figcaption></figure><p id="9e8f" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">我们可以得出结论，许多变量是无用的。毕竟一个典型的用户是没有<code class="du mu mv mw mx b">number of reviews</code>或者<code class="du mu mv mw mx b">reviews_per_month</code>的。我们必须从数据中删除这些信息。此外，价格似乎在0-25英镑和500-10000英镑之间。这不是我们的情况，我们专注于POC，所以我们决定放弃极端记录。再者，我们要从模型的角度去思考姿态和经度，是不是足够好的特征来描述特征空间中的位置？在我看来——不，因此我们将准备三个基于三角函数的附加属性(在<code class="du mu mv mw mx b">base_processing</code>内部)</p><h2 id="7e0a" class="md kh hh bd ki me mf mg km mh mi mj kq ja mk ml ku je mm mn ky ji mo mp lc mq bi translated">自动化机器学习模型开发</h2><p id="ca56" class="pw-post-body-paragraph ip iq hh ir b is le iu iv iw lf iy iz ja lg jc jd je lh jg jh ji li jk jl jm ha bi translated">我们已经到了建模的地步，正如我所说的，我们将使用PyCaret库中的半自动机制。首先，我们删除不必要的列，并在<code class="du mu mv mw mx b">setup</code>函数中创建多个特性。我真的鼓励你看看<a class="ae lq" href="https://pycaret.readthedocs.io/en/latest/" rel="noopener ugc nofollow" target="_blank"> PyCaret文档</a>来尝试不同的设置。为了清楚起见，我们创建了多个多项式、三角函数以及数字列之间的交互。组合分类级别，最后根据<a class="ae lq" href="https://www.analyticsvidhya.com/blog/2016/03/select-important-variables-boruta-package/" rel="noopener ugc nofollow" target="_blank"> Boruta算法</a>选择最重要的特征。最后，我们比较多个模型，选择最好的，优化超参数，并将最终的一个保存到S3。当然，我们需要某种程度的理解，所以我们将生成一些图来解释我们的模型。</p><figure class="kc kd ke kf fd ii"><div class="bz dy l di"><div class="mr ms l"/></div></figure><h2 id="6a42" class="md kh hh bd ki me mf mg km mh mi mj kq ja mk ml ku je mm mn ky ji mo mp lc mq bi translated">模型解释</h2><p id="9129" class="pw-post-body-paragraph ip iq hh ir b is le iu iv iw lf iy iz ja lg jc jd je lh jg jh ji li jk jl jm ha bi translated">不太好…我们的模型不能达到可接受的结果，而且有时我们低估了公寓的价格。有趣的是，在五个最重要的功能中，有三个是手动生成的。人类思维的力量是无价的。<strong class="ir hi">但请记住，这只是一个非常不寻常和具有挑战性的数据集的例子，只需要很少的工作。</strong></p><p id="a23c" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">在展示了第一批成果后，CEO决定部署该解决方案，因为要与投资者进行演示。艰难的开始上层生活并不容易😂</p><figure class="kc kd ke kf fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es my"><img src="../Images/9dec83b89fce629c276485c40cba4b0a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Iz2WmCfdi09xCH4P14Lahw.png"/></div></div><figcaption class="lx ly et er es lz ma bd b be z dx translated">第一次实验结果的解释</figcaption></figure><h1 id="130e" class="kg kh hh bd ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld bi translated">无服务器框架和AWS</h1><figure class="kc kd ke kf fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es mz"><img src="../Images/dd1afc35fa71d84eb77c728851c2a9af.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*iqe-9D8PlAk_vBr8VB85IA.gif"/></div></div><figcaption class="lx ly et er es lz ma bd b be z dx translated"><a class="ae lq" href="https://www.serverless.com/" rel="noopener ugc nofollow" target="_blank">无服务器框架</a></figcaption></figure><p id="3a20" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">无服务器框架是一个<a class="ae lq" href="https://github.com/serverless/serverless" rel="noopener ugc nofollow" target="_blank">开源</a>工具，用于自动化云基础设施的部署。如果不熟悉，可以随意看看<a class="ae lq" href="https://www.serverless.com/learn/" rel="noopener ugc nofollow" target="_blank">系列课程和教程</a>。基本上，该框架使其成为一个可能的原型，并快速开发云应用程序，将其与在GPU而不是CPU上训练深度学习模型进行比较。下面我描述了我们模型的架构图。因为lambda只能有<strong class="ir hi"> ~250Mb </strong>层。我决定创建一个包含自定义图像的容器，在其中安装PyCaret。为什么不呢？有了无服务器框架，用定制容器部署lambda相当容易，不管我们是想使用PyCaret、Tensorflow还是PyTorch。</p><figure class="kc kd ke kf fd ii er es paragraph-image"><div class="er es na"><img src="../Images/8e3ceb762e62a3032d938a903bc1191e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1326/format:webp/1*_uLbW8NPiul_5xxXCzb6uw.png"/></div><figcaption class="lx ly et er es lz ma bd b be z dx translated">架构图</figcaption></figure><h2 id="1049" class="md kh hh bd ki me mf mg km mh mi mj kq ja mk ml ku je mm mn ky ji mo mp lc mq bi translated">λ处理器</h2><p id="cbf0" class="pw-post-body-paragraph ip iq hh ir b is le iu iv iw lf iy iz ja lg jc jd je lh jg jh ji li jk jl jm ha bi translated">主要的lambda处理程序包含4行代码，不漂亮吗？我们决定使用<a class="ae lq" href="https://github.com/awslabs/aws-lambda-powertools-python" rel="noopener ugc nofollow" target="_blank"> aws_lambda_powertools </a>来适应输入/输出规则的定制功能。首先，加载来自S3的Pycaret模型。接下来，我们创建数据模型来捕捉事件。最后，主处理程序支持推理操作。</p><figure class="kc kd ke kf fd ii"><div class="bz dy l di"><div class="mr ms l"/></div></figure><h2 id="3413" class="md kh hh bd ki me mf mg km mh mi mj kq ja mk ml ku je mm mn ky ji mo mp lc mq bi translated">码头集装箱</h2><p id="ea04" class="pw-post-body-paragraph ip iq hh ir b is le iu iv iw lf iy iz ja lg jc jd je lh jg jh ji li jk jl jm ha bi translated">正如我所说的lambda <strong class="ir hi">可以处理低于250 Mb的层</strong>，所以我们必须创建一个预装PyCaret的定制docker容器。感谢容器化，我们可以把所有必要的库和自定义代码。记得将lambda处理程序放在<code class="du mu mv mw mx b">LAMBDA_TASK_ROOT</code>目录中。我们不需要构建容器并将其推送到ECR，无服务器框架会为我们做这件事(如果我们有适当的权限)。</p><figure class="kc kd ke kf fd ii"><div class="bz dy l di"><div class="mr ms l"/></div></figure><h2 id="cd35" class="md kh hh bd ki me mf mg km mh mi mj kq ja mk ml ku je mm mn ky ji mo mp lc mq bi translated">无服务器配置文件</h2><p id="91e1" class="pw-post-body-paragraph ip iq hh ir b is le iu iv iw lf iy iz ja lg jc jd je lh jg jh ji li jk jl jm ha bi translated">用无服务器构建基础设施相当容易。我们有两个感兴趣的基本区域。</p><ul class=""><li id="d4be" class="jn jo hh ir b is it iw ix ja jp je jq ji jr jm js jt ju jv bi translated"><code class="du mu mv mw mx b">provider</code> —用于拾取关于栈的所有信息，我们可以定义<code class="du mu mv mw mx b">runtime</code>、<code class="du mu mv mw mx b">environment variables</code>、<code class="du mu mv mw mx b">policy</code>和<strong class="ir hi"> docker图像名称，这些图像将被推送到ECR。</strong></li><li id="85ed" class="jn jo hh ir b is jw iw jx ja jy je jz ji ka jm js jt ju jv bi translated"><code class="du mu mv mw mx b">functions</code> —用于定义λ函数。我们可以设置<code class="du mu mv mw mx b">timeout</code>、<code class="du mu mv mw mx b">memorysize</code>、<code class="du mu mv mw mx b">events</code>来唤醒我们的lambda</li></ul><figure class="kc kd ke kf fd ii"><div class="bz dy l di"><div class="mr ms l"/></div></figure><p id="9f33" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">最后，在本地测试之后(我使用的是PyCharm的<a class="ae lq" href="https://aws.amazon.com/pycharm/" rel="noopener ugc nofollow" target="_blank"> AWS工具包</a>)，我们只需输入<code class="du mu mv mw mx b">sls deploy</code>就可以了！堆栈应该能够成功部署</p><figure class="kc kd ke kf fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es nb"><img src="../Images/21f487f9ca1602ab510d767e59d8a692.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TzI-vYxjTc1l6bbPNujeJg.png"/></div></div></figure><h1 id="44cb" class="kg kh hh bd ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld bi translated">摘要</h1><p id="4222" class="pw-post-body-paragraph ip iq hh ir b is le iu iv iw lf iy iz ja lg jc jd je lh jg jh ji li jk jl jm ha bi translated">最后，我们可以在AWS控制台中测试我们的lambda。第一次通话可能需要更长时间，因为我们必须从S3下载一个模型，但接下来的<strong class="ir hi">计费持续时间约为250毫秒/300毫秒。</strong>这意味着我们可以调用我们的lambda 100 000次，并支付大约3美元。我觉得值得去做！</p><figure class="kc kd ke kf fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es mt"><img src="../Images/6442012730bc46dac2bda018377567b0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*in7JTCrAc7_bklc1vkFbcw.gif"/></div></div></figure><p id="385d" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">可能模型还不够好，无法应用到生产环境中。但是随着更多的数据和更多的分析，我们可能会创造一个更好的模型，给出可靠的价格预测。重要的是，我们使用一个半自动的过程来部署一个机器学习模型，以最小的努力和非常好的每次预测价格(机器学习的良好指标)。</p><p id="30df" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">谢谢你到达文章的结尾！我认为无服务器可以在许多项目中有所帮助，在这些项目中，我们必须实现机器学习模型来完成一项特定的任务。阅读完本文后，您可能对如何处理大型lambda层、无服务器框架和PyCaret功能有了基本的了解。</p><h2 id="6478" class="md kh hh bd ki me mf mg km mh mi mj kq ja mk ml ku je mm mn ky ji mo mp lc mq bi translated">如果你喜欢它，请在<a class="ae lq" href="https://twitter.com/BodzionyRafal" rel="noopener ugc nofollow" target="_blank">@ bodzionrafal</a>留下拍手声或推特说hello✌️</h2></div></div>    
</body>
</html>