<html>
<head>
<title>Constructing heat map for Chi-square test of independence</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">构建独立性卡方检验的热图</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/constructing-heat-map-for-chi-square-test-of-independence-6d78aa2b140f?source=collection_archive---------2-----------------------#2021-03-16">https://medium.com/analytics-vidhya/constructing-heat-map-for-chi-square-test-of-independence-6d78aa2b140f?source=collection_archive---------2-----------------------#2021-03-16</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><div class=""><h2 id="446c" class="pw-subtitle-paragraph ie hg hh bd b if ig ih ii ij ik il im in io ip iq ir is it iu iv dx translated">如何在Python中构建卡方检验p值的相关矩阵类型热图</h2></div><figure class="ix iy iz ja fd jb er es paragraph-image"><div role="button" tabindex="0" class="jc jd di je bf jf"><div class="er es iw"><img src="../Images/2c8bef1252a2ea9b5b5965158047f97c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QtwWcbFmMTODvNaHH3EuSg.jpeg"/></div></div><figcaption class="ji jj et er es jk jl bd b be z dx translated">热图</figcaption></figure><p id="ae35" class="pw-post-body-paragraph jm jn hh jo b jp jq ii jr js jt il ju jv jw jx jy jz ka kb kc kd ke kf kg kh ha bi ki translated"><span class="l kj kk kl bm km kn ko kp kq di"> C </span>在机器学习中，卡方检验可用于检查分类变量之间的变量关联。基于测试结果，我们可以排除那些与响应变量没有很强关联的变量。或者，我们也可以检查独立变量之间的关联，并可以删除那些相互关联很强的变量。这个概念和皮尔逊的相关系数测试是一样的，但是区别是很明显的。</p><h2 id="be2f" class="kr ks hh bd kt ku kv kw kx ky kz la lb jv lc ld le jz lf lg lh kd li lj lk ll bi translated">相关性与卡方检验</h2><p id="2852" class="pw-post-body-paragraph jm jn hh jo b jp lm ii jr js ln il ju jv lo jx jy jz lp kb kc kd lq kf kg kh ha bi translated">皮尔逊相关系数用于说明两个连续变量之间的关系，如受教育年限和收入。独立性卡方检验确定两个分类变量之间是否存在关联，即变量是否独立或相关，例如某个国家的所有人的教育水平和婚姻状况是否相关。</p><h2 id="89c0" class="kr ks hh bd kt ku kv kw kx ky kz la lb jv lc ld le jz lf lg lh kd li lj lk ll bi translated">为什么要使用卡方p值的热图</h2><p id="f074" class="pw-post-body-paragraph jm jn hh jo b jp lm ii jr js ln il ju jv lo jx jy jz lp kb kc kd lq kf kg kh ha bi translated">在本文中，我将不讨论卡方检验及其性质，在互联网上有足够的关于卡方检验的资料。这篇文章是关于我们如何为独立性的卡方检验制作一个相关矩阵类型的热图。我最近遇到了这个问题，在将一些分类变量输入决策树算法之前，我必须丢弃它们。</p><blockquote class="lr ls lt"><p id="c61b" class="jm jn lu jo b jp jq ii jr js jt il ju lv jw jx jy lw ka kb kc lx ke kf kg kh ha bi translated"><strong class="jo hi">然而，无论是在R语言中还是在Python语言中，我都找不到任何函数可以为卡方检验p值生成类似矩阵的热图，就像我们得到的相关性检验一样。</strong></p></blockquote><p id="d835" class="pw-post-body-paragraph jm jn hh jo b jp jq ii jr js jt il ju jv jw jx jy jz ka kb kc kd ke kf kg kh ha bi translated">然而，两种语言都有使用卡方测试来测试变量关联的方法，但是考虑到列数(超过100个分类变量)，逐个检查每个变量是很麻烦的。</p><h2 id="8481" class="kr ks hh bd kt ku kv kw kx ky kz la lb jv lc ld le jz lf lg lh kd li lj lk ll bi translated">不要混淆“可变重要性”和卡方检验</h2><p id="d60a" class="pw-post-body-paragraph jm jn hh jo b jp lm ii jr js ln il ju jv lo jx jy jz lp kb kc kd lq kf kg kh ha bi translated">因为分类变量属于分类问题，所以大多数人不关心卡方检验，更喜欢决策树默认的“变量重要性”函数，该函数在决策树算法中可用，如随机森林。</p><blockquote class="lr ls lt"><p id="c5e8" class="jm jn lu jo b jp jq ii jr js jt il ju lv jw jx jy lw ka kb kc lx ke kf kg kh ha bi translated"><strong class="jo hi">请不要将决策树变量重要性函数与独立性的卡方检验相混淆，因为决策树变量重要性是根据每个节点分裂处的基尼系数计算的。而卡方检验是一种类似相关性的统计检验，但用于分类变量。</strong></p></blockquote><h2 id="f4c1" class="kr ks hh bd kt ku kv kw kx ky kz la lb jv lc ld le jz lf lg lh kd li lj lk ll bi translated">卡方检验先决条件</h2><p id="389e" class="pw-post-body-paragraph jm jn hh jo b jp lm ii jr js ln il ju jv lo jx jy jz lp kb kc kd lq kf kg kh ha bi translated">在运行卡方测试之前，有一些先决条件</p><p id="88d1" class="pw-post-body-paragraph jm jn hh jo b jp jq ii jr js jt il ju jv jw jx jy jz ka kb kc kd ke kf kg kh ha bi translated">您的数据必须满足以下要求:</p><ol class=""><li id="a834" class="ly lz hh jo b jp jq js jt jv ma jz mb kd mc kh md me mf mg bi translated">两个分类变量。</li><li id="4fae" class="ly lz hh jo b jp mh js mi jv mj jz mk kd ml kh md me mf mg bi translated">每个变量有两个或多个类别(组)。</li><li id="f577" class="ly lz hh jo b jp mh js mi jv mj jz mk kd ml kh md me mf mg bi translated">观察的独立性。</li></ol><ul class=""><li id="691f" class="ly lz hh jo b jp jq js jt jv ma jz mb kd mc kh mm me mf mg bi translated">各组受试者之间没有关系。</li><li id="0b6e" class="ly lz hh jo b jp mh js mi jv mj jz mk kd ml kh mm me mf mg bi translated">分类变量不以任何方式“配对”(例如测试前/测试后观察)。</li></ul><p id="cc48" class="pw-post-body-paragraph jm jn hh jo b jp jq ii jr js jt il ju jv jw jx jy jz ka kb kc kd ke kf kg kh ha bi translated">4.相对较大的样本量。</p><ul class=""><li id="972f" class="ly lz hh jo b jp jq js jt jv ma jz mb kd mc kh mm me mf mg bi translated">每个小区的预期频率至少为1。</li><li id="c6e2" class="ly lz hh jo b jp mh js mi jv mj jz mk kd ml kh mm me mf mg bi translated">大多数(80%)单元的预期频率至少应为5。</li></ul><h2 id="5593" class="kr ks hh bd kt ku kv kw kx ky kz la lb jv lc ld le jz lf lg lh kd li lj lk ll bi translated">用Python构建热图</h2><p id="7bf5" class="pw-post-body-paragraph jm jn hh jo b jp lm ii jr js ln il ju jv lo jx jy jz lp kb kc kd lq kf kg kh ha bi translated">以下代码可用于构建卡方检验p值的热图。</p><p id="c59c" class="pw-post-body-paragraph jm jn hh jo b jp jq ii jr js jt il ju jv jw jx jy jz ka kb kc kd ke kf kg kh ha bi translated">出于演示目的，数据集取自<a class="ae mn" href="https://www.kaggle.com/aljarah/xAPI-Edu-Data?select=xAPI-Edu-Data.csv" rel="noopener ugc nofollow" target="_blank">https://www.kaggle.com/aljarah/xAPI-Edu-Data?select=xAPI-Edu-Data.csv </a>。它有16个分类变量和一个响应变量“类别”。数据集描述可以在上面的链接中找到。我们没有加载所有的独立变量。</p><pre class="ix iy iz ja fd mo mp mq mr aw ms bi"><span id="f9fd" class="kr ks hh mp b fi mt mu l mv mw">import pandas as pd<br/>import numpy as np<br/>import os <br/>from sklearn.feature_selection import chi2<br/>from scipy import stats<br/>import seaborn as sns<br/>import matplotlib.pylab as plt</span><span id="b160" class="kr ks hh mp b fi mx mu l mv mw"># Loading file<br/>studentdf = pd.read_csv(“xAPI-Edu-Data.csv”,low_memory=’False’) #</span><span id="02cc" class="kr ks hh mp b fi mx mu l mv mw"># Extracting column names <br/>column_names=studentdf.columns</span><span id="0db9" class="kr ks hh mp b fi mx mu l mv mw"># Assiging column names to row indexs <br/>chisqmatrix=pd.DataFrame(studentdf,columns=column_names,index=column_names)<br/></span></pre><figure class="ix iy iz ja fd jb er es paragraph-image"><div role="button" tabindex="0" class="jc jd di je bf jf"><div class="er es my"><img src="../Images/123591fbce4e832a6ba06740fa3fc334.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XKoSAnjJS5vVBk80uFso-A.jpeg"/></div></div><figcaption class="ji jj et er es jk jl bd b be z dx translated">nxn行和列的矩阵</figcaption></figure><p id="8b1a" class="pw-post-body-paragraph jm jn hh jo b jp jq ii jr js jt il ju jv jw jx jy jz ka kb kc kd ke kf kg kh ha bi translated">上面我们已经构建了一个n列n行的矩阵。该矩阵用于填充卡方检验的p值。</p><pre class="ix iy iz ja fd mo mp mq mr aw ms bi"><span id="2598" class="kr ks hh mp b fi mt mu l mv mw"># Setting counters to zero<br/>outercnt=0<br/>innercnt=0</span><span id="3abf" class="kr ks hh mp b fi mx mu l mv mw">for icol in column_names: # Outer loop<br/> for jcol in column_names: # inner loop<br/> # Converting to cross tab as for CHi-square test we have<br/> # to first convert variables into contigency table<br/> mycrosstab=pd.crosstab(studentdf[icol],studentdf[jcol])<br/> #Getting p-value and other usefull information<br/> stat,p,dof,expected=stats.chi2_contingency(mycrosstab)<br/> # Rounding very small p-values to zero<br/> chisqmatrix.iloc[outercnt,innercnt]=round(p,5)</span><span id="bb51" class="kr ks hh mp b fi mx mu l mv mw"> # As mentioned above Expected frequencies should be at <br/> # least 5 for the majority (80%) of the cells.<br/> # Here we are checking expected frequency of each group</span><span id="dc37" class="kr ks hh mp b fi mx mu l mv mw"> cntexpected=expected[expected&lt;5].size</span><span id="e23f" class="kr ks hh mp b fi mx mu l mv mw"> #Getting percentage <br/>  perexpected=((expected.size-cntexpected)/expected.size)*100</span></pre><p id="7a8b" class="pw-post-body-paragraph jm jn hh jo b jp jq ii jr js jt il ju jv jw jx jy jz ka kb kc kd ke kf kg kh ha bi translated">如果两个变量之间频率组的预期频率小于5(20%)，我们将在目测热图时忽略这两个变量之间的p值。在这里，我们不是忽略变量，而是不相信它们之间的p值，因为频率很低，所以理想情况下，我们将保留这两个变量。我在这里给这些变量赋了一个不同的数值，值是“2”。</p><pre class="ix iy iz ja fd mo mp mq mr aw ms bi"><span id="ac91" class="kr ks hh mp b fi mt mu l mv mw">if perexpected&lt;20:<br/> chisqmatrix.iloc[outercnt,innercnt]=2 #Assigning 2<br/> <br/> if icol==jcol:<br/> chisqmatrix.iloc[outercnt,innercnt]=0.00<br/> innercnt=innercnt+1<br/> outercnt=outercnt+1<br/> innercnt=0</span></pre><figure class="ix iy iz ja fd jb er es paragraph-image"><div role="button" tabindex="0" class="jc jd di je bf jf"><div class="er es mz"><img src="../Images/bf77e6b8c679f1c3aa19c93037f673e9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Q9YPjT-_MVUBUV3Pm-XjJg.jpeg"/></div></div><figcaption class="ji jj et er es jk jl bd b be z dx translated">p值矩阵</figcaption></figure><p id="89bb" class="pw-post-body-paragraph jm jn hh jo b jp jq ii jr js jt il ju jv jw jx jy jz ka kb kc kd ke kf kg kh ha bi translated">上面我们可以看到基于卡方检验的p值矩阵</p><figure class="ix iy iz ja fd jb er es paragraph-image"><div role="button" tabindex="0" class="jc jd di je bf jf"><div class="er es na"><img src="../Images/7520b7ade54f3bbf40045a7b7d671626.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mz0xYgQqhZP7jHaaYXZ6mA.jpeg"/></div></div><figcaption class="ji jj et er es jk jl bd b be z dx translated">p值的热图</figcaption></figure><p id="df51" class="pw-post-body-paragraph jm jn hh jo b jp jq ii jr js jt il ju jv jw jx jy jz ka kb kc kd ke kf kg kh ha bi translated">上面我们可以看到一个类似热图的关联矩阵。“类别”是一个响应变量。</p><h2 id="2d54" class="kr ks hh bd kt ku kv kw kx ky kz la lb jv lc ld le jz lf lg lh kd li lj lk ll bi translated">无效假设和交替假设</h2><p id="33f0" class="pw-post-body-paragraph jm jn hh jo b jp lm ii jr js ln il ju jv lo jx jy jz lp kb kc kd lq kf kg kh ha bi translated">卡方检验的零假设(<em class="lu"> H </em> 0)和替代假设(<em class="lu"> H </em> 1)可以表示如下</p><p id="5bd5" class="pw-post-body-paragraph jm jn hh jo b jp jq ii jr js jt il ju jv jw jx jy jz ka kb kc kd ke kf kg kh ha bi translated"><em class="lu">H</em>0:“<em class="lu">变量1 </em>独立于<em class="lu">变量2</em>”<br/>H1:“<em class="lu">变量1 </em>不独立于<em class="lu">变量2 </em>”</p><p id="c390" class="pw-post-body-paragraph jm jn hh jo b jp jq ii jr js jt il ju jv jw jx jy jz ka kb kc kd ke kf kg kh ha bi translated">我们使用<em class="lu"> α </em> = 0.05，这将是95%的置信区间。根据上述热图，我们可以得出以下结论</p><h2 id="206b" class="kr ks hh bd kt ku kv kw kx ky kz la lb jv lc ld le jz lf lg lh kd li lj lk ll bi translated">基于p值的推断</h2><ol class=""><li id="55f1" class="ly lz hh jo b jp lm js ln jv nb jz nc kd nd kh md me mf mg bi translated">由于“性别”和“关系”之间的p值小于我们选择的显著性水平(<em class="lu"> α </em> = 0.05)，我们可以拒绝零假设。我们可以得出结论，有足够的证据表明性别和关系之间的联系。</li><li id="abe7" class="ly lz hh jo b jp mh js mi jv mj jz mk kd ml kh md me mf mg bi translated">由于“secionId”和“class”之间的p值大于我们选择的显著性水平(<em class="lu"> α </em> = 0.05)，我们不能拒绝零假设。我们可以得出结论，没有足够的证据表明性别和关系之间的联系。</li></ol><p id="03ba" class="pw-post-body-paragraph jm jn hh jo b jp jq ii jr js jt il ju jv jw jx jy jz ka kb kc kd ke kf kg kh ha bi translated">根据上面的热图得出结论，我们可以从最终变量列表中排除“StageId”和“SectionId ”,因为它们对响应变量没有意义。</p><h2 id="ca6f" class="kr ks hh bd kt ku kv kw kx ky kz la lb jv lc ld le jz lf lg lh kd li lj lk ll bi translated">如何避免预期频率低于20%的情况</h2><p id="2e84" class="pw-post-body-paragraph jm jn hh jo b jp lm ii jr js ln il ju jv lo jx jy jz lp kb kc kd lq kf kg kh ha bi translated">上面的值“2”被分配给那些预期频率低于20%的变量，因此我们不能对这些变量做出任何决定，为了安全起见，我们可以保留它们。当数据中有太多级别时，就会出现这种情况。避免这种情况的一种变通方法是通过在同一个类别变量中组合不同的级别来组合级别。比如“举手”有一个介于1和100之间的值，所以我们可以通过给每个类别分配10个值来将其减少到10个不同的类别。<br/>本文提到的代码没有经过优化。人们可以根据自己的需要改进和定制代码。</p></div></div>    
</body>
</html>