<html>
<head>
<title>Automated Machine learning for Vision</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">视觉的自动机器学习</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/automated-machine-learning-for-vision-5cad3b25759f?source=collection_archive---------6-----------------------#2021-10-13">https://medium.com/analytics-vidhya/automated-machine-learning-for-vision-5cad3b25759f?source=collection_archive---------6-----------------------#2021-10-13</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><h1 id="b31e" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated">面向视觉/深度学习的自动化ML</h1><h1 id="bcd9" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated">先决条件</h1><ul class=""><li id="0bf8" class="jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt bi translated">Azure帐户</li><li id="d47a" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">Azure存储</li><li id="6f7a" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">Azure机器学习服务</li><li id="7879" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">Github帐户和存储库</li><li id="a5d0" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">Azure服务主帐户</li><li id="cea3" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">向服务主要贡献者提供对机器学习资源的访问</li><li id="4cd1" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">Azure Keyvault存储秘密</li><li id="6888" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">用服务主体机密更新密钥库</li><li id="a992" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">这将自动化训练代码并注册模型</li></ul><h1 id="58d0" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated">步伐</h1><ul class=""><li id="8fd8" class="jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt bi translated">登录ml.azure.com</li><li id="c795" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">启动您计算实例</li><li id="c35f" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">去笔记本开始写代码</li></ul><pre class="jz ka kb kc fd kd ke kf kg aw kh bi"><span id="d375" class="ki if hh ke b fi kj kk l kl km">import azureml.core<br/>from azureml.core import Workspace<br/>from azureml.core import Keyvault<br/>import os<br/><br/>from azureml.core import Workspace, Experiment<br/>from azureml.train.automl import AutoMLImageConfig<br/>from azureml.train.hyperdrive import GridParameterSampling<br/>from azureml.train.hyperdrive import choice<br/><br/>from azureml.contrib.dataset.labeled_dataset import _LabeledDatasetFactory, LabeledDatasetTask<br/>from azureml.core import Dataset<br/><br/>from azureml.core.authentication import ServicePrincipalAuthentication<br/>from azureml.core.compute import AmlCompute, ComputeTarget<br/>from azureml.core import Experiment<br/><br/>from azureml.core import Workspace<br/>import os<br/>import urllib<br/>from zipfile import ZipFile</span></pre><ul class=""><li id="41c2" class="jc jd hh je b jf kn jh ko jj kp jl kq jn kr jp jq jr js jt bi translated">打印Azure ml sdk</li></ul><pre class="jz ka kb kc fd kd ke kf kg aw kh bi"><span id="0002" class="ki if hh ke b fi kj kk l kl km">print("SDK version:", azureml.core.VERSION)</span></pre><ul class=""><li id="dc9b" class="jc jd hh je b jf kn jh ko jj kp jl kq jn kr jp jq jr js jt bi translated">现在加载默认的工作空间</li></ul><pre class="jz ka kb kc fd kd ke kf kg aw kh bi"><span id="f149" class="ki if hh ke b fi kj kk l kl km">ws = Workspace.from_config()<br/>keyvault = ws.get_default_keyvault()</span></pre><ul class=""><li id="4404" class="jc jd hh je b jf kn jh ko jj kp jl kq jn kr jp jq jr js jt bi translated">打印工作区详细信息</li></ul><pre class="jz ka kb kc fd kd ke kf kg aw kh bi"><span id="2301" class="ki if hh ke b fi kj kk l kl km">ws.get_details()<br/>print('Workspace name: ' + ws.name, <br/>      'Azure region: ' + ws.location, <br/>      'Subscription id: ' + ws.subscription_id, <br/>      'Resource group: ' + ws.resource_group, sep = '\n')</span></pre><ul class=""><li id="65f2" class="jc jd hh je b jf kn jh ko jj kp jl kq jn kr jp jq jr js jt bi translated">现在创建一个计算集群来运行培训</li></ul><pre class="jz ka kb kc fd kd ke kf kg aw kh bi"><span id="1ed3" class="ki if hh ke b fi kj kk l kl km">cluster_name = "gpu-cluster"<br/><br/>try:<br/>    compute_target = ws.compute_targets[cluster_name]<br/>    print('Found existing compute target.')<br/>except KeyError:<br/>    print('Creating a new compute target...')<br/>    compute_config = AmlCompute.provisioning_configuration(vm_size='Standard_NC6', <br/>                                                           idle_seconds_before_scaledown=1800,<br/>                                                           min_nodes=0, <br/>                                                           max_nodes=4)<br/><br/>    compute_target = ComputeTarget.create(ws, cluster_name, compute_config)<br/># Can poll for a minimum number of nodes and for a specific timeout.<br/># If no min_node_count is provided, it will use the scale settings for the cluster.<br/>compute_target.wait_for_completion(show_output=True, min_node_count=None, timeout_in_minutes=20)</span></pre><ul class=""><li id="7c8c" class="jc jd hh je b jf kn jh ko jj kp jl kq jn kr jp jq jr js jt bi translated">命名你的实验</li></ul><pre class="jz ka kb kc fd kd ke kf kg aw kh bi"><span id="d586" class="ki if hh ke b fi kj kk l kl km">experiment_name = 'automl-image-notebook' <br/>experiment = Experiment(ws, name=experiment_name)</span></pre><ul class=""><li id="ecba" class="jc jd hh je b jf kn jh ko jj kp jl kq jn kr jp jq jr js jt bi translated">下载文件</li></ul><pre class="jz ka kb kc fd kd ke kf kg aw kh bi"><span id="99b0" class="ki if hh ke b fi kj kk l kl km"># download data<br/>download_url = 'https://cvbp-secondary.z19.web.core.windows.net/datasets/object_detection/odFridgeObjects.zip'<br/>data_file = './odFridgeObjects.zip'<br/>urllib.request.urlretrieve(download_url, filename=data_file)<br/><br/># extract files<br/>with ZipFile(data_file, 'r') as zip:<br/>    print('extracting files...')<br/>    zip.extractall()<br/>    print('done')<br/>    <br/># delete zip file<br/>os.remove(data_file)<br/><br/>from IPython.display import Image<br/>Image(filename='./odFridgeObjects/images/31.jpg')</span><span id="59ea" class="ki if hh ke b fi ks kk l kl km">import json<br/>import os<br/>import xml.etree.ElementTree as ET<br/><br/>src = "./odFridgeObjects/"<br/>train_validation_ratio = 5</span></pre><ul class=""><li id="c27b" class="jc jd hh je b jf kn jh ko jj kp jl kq jn kr jp jq jr js jt bi translated">检索数据集名称</li></ul><pre class="jz ka kb kc fd kd ke kf kg aw kh bi"><span id="9219" class="ki if hh ke b fi kj kk l kl km"># Retrieving default datastore that got automatically created when we setup a workspace<br/>workspaceblobstore = ws.get_default_datastore().name</span></pre><ul class=""><li id="5191" class="jc jd hh je b jf kn jh ko jj kp jl kq jn kr jp jq jr js jt bi translated">加载数据</li></ul><pre class="jz ka kb kc fd kd ke kf kg aw kh bi"><span id="8afd" class="ki if hh ke b fi kj kk l kl km"># Path to the annotations<br/>annotations_folder = os.path.join(src, "annotations")<br/><br/># Path to the training and validation files<br/>train_annotations_file = os.path.join(src, "train_annotations.jsonl")<br/>validation_annotations_file = os.path.join(src, "validation_annotations.jsonl")</span></pre><ul class=""><li id="df81" class="jc jd hh je b jf kn jh ko jj kp jl kq jn kr jp jq jr js jt bi translated">设置一个json示例文件</li></ul><pre class="jz ka kb kc fd kd ke kf kg aw kh bi"><span id="aea4" class="ki if hh ke b fi kj kk l kl km"># sample json line dictionary<br/>json_line_sample = \<br/>    {<br/>        "image_url": "AmlDatastore://" + workspaceblobstore + "/"<br/>                     + os.path.basename(os.path.dirname(src)) + "/" + "images",<br/>        "image_details": {"format": None, "width": None, "height": None},<br/>        "label": []<br/>    }</span></pre><ul class=""><li id="34f3" class="jc jd hh je b jf kn jh ko jj kp jl kq jn kr jp jq jr js jt bi translated">下载文件</li><li id="fc92" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">创建COCO文件</li></ul><pre class="jz ka kb kc fd kd ke kf kg aw kh bi"><span id="fa71" class="ki if hh ke b fi kj kk l kl km"># Read each annotation and convert it to jsonl line<br/>with open(train_annotations_file, 'w') as train_f:<br/>    with open(validation_annotations_file, 'w') as validation_f:<br/>        for i, filename in enumerate(os.listdir(annotations_folder)):<br/>            if filename.endswith(".xml"):<br/>                print("Parsing " + os.path.join(src, filename))<br/><br/>                root = ET.parse(os.path.join(annotations_folder, filename)).getroot()<br/><br/>                width = int(root.find('size/width').text)<br/>                height = int(root.find('size/height').text)<br/><br/>                labels = []<br/>                for object in root.findall('object'):<br/>                    name = object.find('name').text<br/>                    xmin = object.find('bndbox/xmin').text<br/>                    ymin = object.find('bndbox/ymin').text<br/>                    xmax = object.find('bndbox/xmax').text<br/>                    ymax = object.find('bndbox/ymax').text<br/>                    isCrowd = int(object.find('difficult').text)<br/>                    labels.append({"label": name,<br/>                                   "topX": float(xmin)/width,<br/>                                   "topY": float(ymin)/height,<br/>                                   "bottomX": float(xmax)/width,<br/>                                   "bottomY": float(ymax)/height,<br/>                                   "isCrowd": isCrowd})<br/>                # build the jsonl file<br/>                image_filename = root.find("filename").text<br/>                _, file_extension = os.path.splitext(image_filename)<br/>                json_line = dict(json_line_sample)<br/>                json_line["image_url"] = json_line["image_url"] + "/" + image_filename<br/>                json_line["image_details"]["format"] = file_extension[1:]<br/>                json_line["image_details"]["width"] = width<br/>                json_line["image_details"]["height"] = height<br/>                json_line["label"] = labels<br/><br/>                if i % train_validation_ratio == 0:<br/>                    # validation annotation<br/>                    validation_f.write(json.dumps(json_line) + "\n")<br/>                else:<br/>                    # train annotation<br/>                    train_f.write(json.dumps(json_line) + "\n")<br/>            else:<br/>                print("Skipping unknown file: {}".format(filename))<br/><br/>ds = ws.get_default_datastore()<br/>ds.upload(src_dir='./odFridgeObjects', target_path='odFridgeObjects')</span></pre><ul class=""><li id="db0d" class="jc jd hh je b jf kn jh ko jj kp jl kq jn kr jp jq jr js jt bi translated">创建培训和验证数据集</li></ul><pre class="jz ka kb kc fd kd ke kf kg aw kh bi"><span id="bf0e" class="ki if hh ke b fi kj kk l kl km">training_dataset_name = 'odFridgeObjectsTrainingDataset'<br/>if training_dataset_name in ws.datasets:<br/>    training_dataset = ws.datasets.get(training_dataset_name)<br/>    print('Found the training dataset', training_dataset_name)<br/>else:<br/>    # create training dataset<br/>    training_dataset = _LabeledDatasetFactory.from_json_lines(<br/>        task=LabeledDatasetTask.OBJECT_DETECTION, path=ds.path('odFridgeObjects/train_annotations.jsonl'))<br/>    training_dataset = training_dataset.register(workspace=ws, name=training_dataset_name)<br/>    <br/># create validation dataset<br/>validation_dataset_name = "odFridgeObjectsValidationDataset"<br/>if validation_dataset_name in ws.datasets:<br/>    validation_dataset = ws.datasets.get(validation_dataset_name)<br/>    print('Found the validation dataset', validation_dataset_name)<br/>else:<br/>    validation_dataset = _LabeledDatasetFactory.from_json_lines(<br/>        task=LabeledDatasetTask.OBJECT_DETECTION, path=ds.path('odFridgeObjects/validation_annotations.jsonl'))<br/>    validation_dataset = validation_dataset.register(workspace=ws, name=validation_dataset_name)<br/>    <br/>    <br/>print("Training dataset name: " + training_dataset.name)<br/>print("Validation dataset name: " + validation_dataset.name)</span></pre><ul class=""><li id="b76d" class="jc jd hh je b jf kn jh ko jj kp jl kq jn kr jp jq jr js jt bi translated">将数据集转换为熊猫</li></ul><pre class="jz ka kb kc fd kd ke kf kg aw kh bi"><span id="705a" class="ki if hh ke b fi kj kk l kl km">training_dataset.to_pandas_dataframe()</span></pre><ul class=""><li id="507b" class="jc jd hh je b jf kn jh ko jj kp jl kq jn kr jp jq jr js jt bi translated">设置自动视觉ml参数</li><li id="7192" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">设置算法</li><li id="e661" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">在这种情况下，我们使用yolov5</li></ul><pre class="jz ka kb kc fd kd ke kf kg aw kh bi"><span id="7e20" class="ki if hh ke b fi kj kk l kl km">image_config_yolov5 = AutoMLImageConfig(task='image-object-detection',<br/>                                        compute_target=compute_target,<br/>                                        training_data=training_dataset,<br/>                                        validation_data=validation_dataset,<br/>                                        hyperparameter_sampling=GridParameterSampling({'model_name': choice('yolov5')}))</span></pre><ul class=""><li id="5cd8" class="jc jd hh je b jf kn jh ko jj kp jl kq jn kr jp jq jr js jt bi translated">提交体验</li></ul><pre class="jz ka kb kc fd kd ke kf kg aw kh bi"><span id="6bdb" class="ki if hh ke b fi kj kk l kl km">automl_image_run = experiment.submit(image_config_yolov5)</span></pre><ul class=""><li id="78e2" class="jc jd hh je b jf kn jh ko jj kp jl kq jn kr jp jq jr js jt bi translated">等待运行完成</li></ul><pre class="jz ka kb kc fd kd ke kf kg aw kh bi"><span id="f3ed" class="ki if hh ke b fi kj kk l kl km">automl_image_run.wait_for_completion(wait_post_processing=True)</span></pre><ul class=""><li id="4c82" class="jc jd hh je b jf kn jh ko jj kp jl kq jn kr jp jq jr js jt bi translated">等待实验完成</li><li id="705f" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">现在你将有一个模型来验证和推断</li><li id="3d1b" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">要运行多个模型</li></ul><pre class="jz ka kb kc fd kd ke kf kg aw kh bi"><span id="6f15" class="ki if hh ke b fi kj kk l kl km">from azureml.train.automl import AutoMLImageConfig<br/>from azureml.train.hyperdrive import GridParameterSampling, RandomParameterSampling, BayesianParameterSampling<br/>from azureml.train.hyperdrive import BanditPolicy, HyperDriveConfig, PrimaryMetricGoal<br/>from azureml.train.hyperdrive import choice, uniform<br/><br/>parameter_space = {<br/>    'model': choice(<br/>        {<br/>            'model_name': choice('yolov5'),<br/>            'learning_rate': uniform(0.0001, 0.01),<br/>            #'model_size': choice('small', 'medium'), # model-specific<br/>            'img_size': choice(640, 704, 768), # model-specific<br/>        },<br/>        {<br/>            'model_name': choice('fasterrcnn_resnet50_fpn'),<br/>            'learning_rate': uniform(0.0001, 0.001),<br/>            #'warmup_cosine_lr_warmup_epochs': choice(0, 3),<br/>            'optimizer': choice('sgd', 'adam', 'adamw'),<br/>            'min_size': choice(600, 800), # model-specific<br/>        }<br/>    )<br/>}<br/><br/>tuning_settings = {<br/>    'iterations': 20, <br/>    'max_concurrent_iterations': 4, <br/>    'hyperparameter_sampling': RandomParameterSampling(parameter_space),  <br/>    'policy': BanditPolicy(evaluation_interval=2, slack_factor=0.2, delay_evaluation=6)<br/>}<br/><br/><br/>automl_image_config = AutoMLImageConfig(task='image-object-detection',<br/>                                        compute_target=compute_target,<br/>                                        training_data=training_dataset,<br/>                                        validation_data=validation_dataset,<br/>                                        primary_metric='mean_average_precision',<br/>                                        **tuning_settings)</span></pre><ul class=""><li id="695e" class="jc jd hh je b jf kn jh ko jj kp jl kq jn kr jp jq jr js jt bi translated">提交实验</li></ul><pre class="jz ka kb kc fd kd ke kf kg aw kh bi"><span id="4c0b" class="ki if hh ke b fi kj kk l kl km">automl_image_run = experiment.submit(automl_image_config)</span></pre><ul class=""><li id="ee59" class="jc jd hh je b jf kn jh ko jj kp jl kq jn kr jp jq jr js jt bi translated">等待实验运行</li></ul><pre class="jz ka kb kc fd kd ke kf kg aw kh bi"><span id="3ee7" class="ki if hh ke b fi kj kk l kl km">automl_image_run.wait_for_completion(wait_post_processing=True)</span></pre><ul class=""><li id="a087" class="jc jd hh je b jf kn jh ko jj kp jl kq jn kr jp jq jr js jt bi translated">获得最佳模型</li></ul><pre class="jz ka kb kc fd kd ke kf kg aw kh bi"><span id="1e9a" class="ki if hh ke b fi kj kk l kl km">from azureml.core import Run<br/>hyperdrive_run = Run(experiment=experiment, run_id=automl_image_run.id + '_HD')<br/>hyperdrive_run</span></pre><ul class=""><li id="3bbd" class="jc jd hh je b jf kn jh ko jj kp jl kq jn kr jp jq jr js jt bi translated">注册模型</li></ul><pre class="jz ka kb kc fd kd ke kf kg aw kh bi"><span id="6832" class="ki if hh ke b fi kj kk l kl km"># Register the model from the best run<br/><br/>best_child_run = automl_image_run.get_best_child()<br/>model_name = best_child_run.properties['model_name']<br/>model = best_child_run.register_model(model_name = model_name, model_path='outputs/model.pt')</span></pre><p id="7c46" class="pw-post-body-paragraph kt ku hh je b jf kn kv kw jh ko kx ky jj kz la lb jl lc ld le jn lf lg lh jp ha bi translated">原始帖子在<a class="ae li" href="https://github.com/balakreshnan/Samples2021/blob/main/AutoML/autovisionml.md" rel="noopener ugc nofollow" target="_blank"> Samples2021/autovisionml.md在主balakreshnan/samples 2021(github.com)</a></p></div></div>    
</body>
</html>