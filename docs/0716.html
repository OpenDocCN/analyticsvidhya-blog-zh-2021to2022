<html>
<head>
<title>Append Newline to Amazon Kinesis Firehose JSON Formatted Records with Python and AWS Lambda</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用Python和AWS Lambda向Amazon Kinesis Firehose JSON格式的记录添加新行</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/append-newline-to-amazon-kinesis-firehose-json-formatted-records-with-python-f58498d0177a?source=collection_archive---------0-----------------------#2021-01-28">https://medium.com/analytics-vidhya/append-newline-to-amazon-kinesis-firehose-json-formatted-records-with-python-f58498d0177a?source=collection_archive---------0-----------------------#2021-01-28</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div class="er es if"><img src="../Images/147f5c9de477a4afe7f8004751e4f066.png" data-original-src="https://miro.medium.com/v2/resize:fit:1272/0*XTWNW5WxUhDV65tN"/></div><figcaption class="im in et er es io ip bd b be z dx translated">我在墨西哥瓜纳华托</figcaption></figure><p id="16e6" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">简单吧？然而，这被证明是如此难以捉摸，至少对我来说，而且比我愿意承认的时间更长。</p><p id="84c9" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><em class="jo">如果你想跳过景区路线，直接进入解决方案，向下滚动到下面的代码；更好的是，ctrl+f“kine sis-FH-JSON-newline”否则，享受漫步。</em></p><p id="72c5" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><em class="jo">场景。我正在使用亚马逊DynamoDB (DDB)流。我有一个AWS Lambda函数，它将这些流推送到Kinesis Firehose。然后，消防软管将这些数据推送到S3。它很好地将我的记录作为JSON字符串输入S3，因为Firehose有助于控制数据流。</em></p><figure class="jq jr js jt fd ij er es paragraph-image"><div class="er es jp"><img src="../Images/ce8b693bd7e923fde1ce0b33b96864d8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1164/format:webp/1*ac10nNU006mjKl9_l8sUjQ.png"/></div><figcaption class="im in et er es io ip bd b be z dx translated">无消防软管转换的数据管道</figcaption></figure><p id="d4c1" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">到目前为止，我的(部分)数据管道工作得很好，除了一个问题。当每个JSON格式的记录保存到文件中时，它们被连续保存——每个记录被记录在一行或一行中，一个接一个。当您在记事本中打开这个文件时，您会看到每个记录在文件的顶部以菊花链的形式连接在一起。我不希望它像那样存储，因为它不直观，并且以后将很难处理。</p><p id="08d4" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我希望每条记录的结尾都有一个回车符，这样它们就可以垂直堆叠在一列中，而不是水平堆叠在一行中。</p><figure class="jq jr js jt fd ij er es paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="er es ju"><img src="../Images/eaff1cffccfc63d30db5d643abf0976f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xwNLMiC_V4wQ3JPr9C-h3Q.png"/></div></div><figcaption class="im in et er es io ip bd b be z dx translated">JSON记录:这是Kinesis Firehose将每个记录保存到文件的方式。</figcaption></figure><p id="fe14" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我从我的S3桶中下载了上图所示的文件。该文件演示了Kinesis Firehose如何将我的每个JSON记录保存到文件中。我对两件事感到惊讶，1) Kinesis Firehose没有一个简单的“复选框”来为我添加换行符，2)我不容易找到Python解决方案。</p><p id="b324" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">base64编码/解码</strong></p><p id="51b5" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在我的第一个Lambda中，这并不像将DDB <code class="du jz ka kb kc b">newImage</code>转换成一个字符串，然后添加<code class="du jz ka kb kc b">+ "\n"</code>，再将其转换回字典或JSON那么简单。我要么得到一个错误(当我使用<code class="du jz ka kb kc b">json_loads()</code>时)，要么什么都不会发生(当我使用<code class="du jz ka kb kc b">ast.literal_eval()</code>时)，所以我怀疑消防软管的<code class="du jz ka kb kc b">client.put_record()</code>正在剥离回车。消防水管流是用base64编码的，为了正确工作，我必须用Python中的T5把记录解码成一个字符串，然后再编码成utf-8。详见kinesis-fh-json-newline.py代码。</p><p id="3aaa" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><em class="jo">我是这样做的:</em></p><ol class=""><li id="a71b" class="ke kf hi is b it iu ix iy jb kg jf kh jj ki jn kj kk kl km bi translated">创建一个新的Lambda并使用下面的kinesis-fh-json-newline.py代码，或者使用下面的Node.js版本。</li><li id="24e5" class="ke kf hi is b it kn ix ko jb kp jf kq jj kr jn kj kk kl km bi translated">当你创建你的Kinesis消防水带流时，启用“用AWS Lambda转换<br/>源记录”(选择“启用”)。如果您已经创建了您的流，您仍然可以通过编辑现有的流来启用此功能。</li><li id="09e7" class="ke kf hi is b it kn ix ko jb kp jf kq jj kr jn kj kk kl km bi translated">为转换选择新创建的Lambda函数。这个转换lambda还可以做很多其他的事情，比如ETL。在我的例子中，我只需要在每个记录的末尾添加一个新行，这样当我在文本编辑器中打开文件并查看它时，每个条目都在一个单独的行上。</li></ol><p id="1174" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">下面是我用于第二个Lambda的Python和Node.js的测试解决方案代码:</p><p id="e2ba" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">添加换行符的Python解决方案:</p><figure class="jq jr js jt fd ij"><div class="bz dy l di"><div class="ks kt l"/></div></figure><p id="3bdc" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">添加换行符的Node.js解决方案:</p><figure class="jq jr js jt fd ij"><div class="bz dy l di"><div class="ks kt l"/></div></figure><p id="5f26" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">一些帮助我拼凑Python版本的好参考资料:</p><ul class=""><li id="87d2" class="ke kf hi is b it iu ix iy jb kg jf kh jj ki jn ku kk kl km bi translated">Kinesis消防软管演示(Node.js解决方案来源):<a class="ae kd" href="https://www.youtube.com/watch?v=wRGd2G82Opo&amp;t=242s" rel="noopener ugc nofollow" target="_blank">https://www.youtube.com/watch?v=wRGd2G82Opo&amp;t = 242s</a></li><li id="b2bc" class="ke kf hi is b it kn ix ko jb kp jf kq jj kr jn ku kk kl km bi translated">使用Python的亚马逊网络服务(AWS) Kinesis消防软管教程:<a class="ae kd" href="https://www.youtube.com/watch?v=6_03i26_DrQ" rel="noopener ugc nofollow" target="_blank">https://www.youtube.com/watch?v=6_03i26_DrQ</a></li><li id="1544" class="ke kf hi is b it kn ix ko jb kp jf kq jj kr jn ku kk kl km bi translated">了解无服务器web应用程序的数据库选项:<a class="ae kd" href="https://aws.amazon.com/blogs/compute/understanding-database-options-for-your-serverless-web-applications/" rel="noopener ugc nofollow" target="_blank">https://AWS . Amazon . com/blogs/compute/understanding-database-options-for-your-server less-web-applications/</a></li></ul><p id="30a0" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">在第一个Lambda中添加一个换行符，在Kinesis Firehose之前</strong></p><p id="24d3" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我也能在第一个Lambda(上面的数据管道图中的“流处理”)中实现这一点，而不是使用Kinesis Firehose转换源记录功能。我从DynamoDB流中获取新图像，并按照以下顺序执行:编码、解码、添加新行(" \n ")、编码、解码。可能有更干净的方法。然而，我选择使用第二个Lambda函数来转换源记录特性，因为此时它对我来说似乎更清晰。</p><p id="30f5" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在任何情况下，单个Lambda解决方案看起来都是这样的:</p><figure class="jq jr js jt fd ij"><div class="bz dy l di"><div class="ks kt l"/></div></figure><p id="6083" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">用AWS Lambda转换源记录</strong></p><p id="1d00" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在Python中创建新的Lambda之后，转到你的Kinesis数据Firehose交付流并编辑你的流。启用“用AWS Lambda转换源记录”部分中的“源记录转换”,并从列表中选择您新创建的Lambda，最后，保存您的更改。应该可以了！</p><figure class="jq jr js jt fd ij er es paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="er es kv"><img src="../Images/8d78c0fc0ebc8371860fdb756010ed57.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*twUiltERj7MZtidHS5EcKA.png"/></div></div><figcaption class="im in et er es io ip bd b be z dx translated">消防水带转换λ</figcaption></figure><p id="757c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">您的新数据管道流应该如下所示:</p><figure class="jq jr js jt fd ij er es paragraph-image"><div class="er es jp"><img src="../Images/2b70645c03396680143f98e131fb99ea.png" data-original-src="https://miro.medium.com/v2/resize:fit:1164/format:webp/1*tJ4qmE70kzD71C5XOxC_vA.png"/></div><figcaption class="im in et er es io ip bd b be z dx translated">用于添加换行符的带消防软管转换的数据管道。</figcaption></figure><p id="0aa9" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">重新测试你的Lambda函数，瞧！现在，每条记录都应该有一个回车符，并且是预期的、直观的格式。</p><figure class="jq jr js jt fd ij er es paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="er es kw"><img src="../Images/d746b7df75fa1af4fb645bc90a69679b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1Dia2Fe8SYh2GdIFRnk4iA.png"/></div></div><figcaption class="im in et er es io ip bd b be z dx translated">JSON记录:每条记录的末尾都有换行符。</figcaption></figure><p id="b48d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我想听听你的想法。您曾经需要连续保存记录吗？有没有我遗漏的更简单的解决方案？肯定有！欢迎评论、反馈和建议。</p><p id="5265" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><em class="jo">未来篇。</em>在未来的文章或系列文章中，我将详细介绍如何完成整个数据管道，以便我们可以将数据从DynamoDB导入Amazon RDS，从而为使用Amazon QuickSight进行数据分析做好准备。</p><p id="f1d0" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如果你喜欢这篇文章或者这个解决方案对你有帮助，请鼓掌。最多可以鼓掌50次，谢谢。</p></div></div>    
</body>
</html>