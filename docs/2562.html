<html>
<head>
<title>TPC-H SF10000 test with Azure Synapse workspace Spark using Spark SQL</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Spark SQL对Azure Synapse workspace Spark进行TPC-H SF10000测试</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/tpc-h-sf10000-test-with-azure-synapse-workspace-spark-using-spark-sql-8364051eae71?source=collection_archive---------11-----------------------#2021-05-02">https://medium.com/analytics-vidhya/tpc-h-sf10000-test-with-azure-synapse-workspace-spark-using-spark-sql-8364051eae71?source=collection_archive---------11-----------------------#2021-05-02</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><h1 id="9396" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated">用例</h1><ul class=""><li id="594f" class="jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt bi translated">使用Spark SQL运行TPC-H测试</li><li id="a285" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">使用设计火花标量数据框运行TPC-H测试</li><li id="e542" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">准备测试所需的数据</li><li id="5fe1" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">基于云的架构测试</li><li id="2f8e" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">存储和计算对比测试</li></ul><h1 id="ddcc" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated">先决条件</h1><h1 id="3e71" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated">集群大小</h1><ul class=""><li id="071e" class="jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt bi translated">Databricks运行时7.5毫升</li><li id="71d8" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">节点总数4</li><li id="e703" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">每个节点8个内核和28GB RAM</li><li id="b928" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">使用Spark 3.01</li><li id="4ac2" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">使用scala 2.12</li></ul><figure class="ka kb kc kd fd ke er es paragraph-image"><div class="er es jz"><img src="../Images/aa8f58ebd58924c3fd6baef66e822698.png" data-original-src="https://miro.medium.com/v2/resize:fit:1358/format:webp/0*WPu8ryly8HtDrCsI.jpg"/></div></figure><ul class=""><li id="694a" class="jc jd hh je b jf kh jh ki jj kj jl kk jn kl jp jq jr js jt bi translated">立即创建笔记本</li><li id="1857" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">首先获取主密钥的blob存储密钥库机密</li></ul><pre class="ka kb kc kd fd km kn ko kp aw kq bi"><span id="7ceb" class="kr if hh kn b fi ks kt l ku kv">val keyVaultName = "keyvaultname"; <br/>val secretName = "keyname"; <br/>val blobsecret = "keyname" <br/>val accbbstorekey = mssparkutils.credentials.getSecret(keyVaultName, blobsecret)</span></pre><ul class=""><li id="7c8e" class="jc jd hh je b jf kh jh ki jj kj jl kk jn kl jp jq jr js jt bi translated">配置blob存储以供spark访问</li></ul><pre class="ka kb kc kd fd km kn ko kp aw kq bi"><span id="5174" class="kr if hh kn b fi ks kt l ku kv">spark.conf.set(<br/>  "fs.azure.account.key.accbbstore.blob.core.windows.net",<br/>  accbbstorekey)</span></pre><ul class=""><li id="313c" class="jc jd hh je b jf kh jh ki jj kj jl kk jn kl jp jq jr js jt bi translated">让我们读取客户数据</li></ul><pre class="ka kb kc kd fd km kn ko kp aw kq bi"><span id="b3b6" class="kr if hh kn b fi ks kt l ku kv">val customer = spark.read.parquet("wasbs://containername@storagename.blob.core.windows.net/CUSTOMER/*.parquet")</span></pre><ul class=""><li id="1058" class="jc jd hh je b jf kh jh ki jj kj jl kk jn kl jp jq jr js jt bi translated">显示客户</li></ul><pre class="ka kb kc kd fd km kn ko kp aw kq bi"><span id="f06f" class="kr if hh kn b fi ks kt l ku kv">display(customer)</span></pre><ul class=""><li id="edcb" class="jc jd hh je b jf kh jh ki jj kj jl kk jn kl jp jq jr js jt bi translated">现在创建临时视图来运行sql命令</li></ul><pre class="ka kb kc kd fd km kn ko kp aw kq bi"><span id="3bf4" class="kr if hh kn b fi ks kt l ku kv">%sql<br/>CREATE TEMPORARY VIEW customer<br/>USING org.apache.spark.sql.parquet<br/>OPTIONS (<br/>  path "wasbs://containername@storagename.blob.core.windows.net/CUSTOMER/*.parquet"<br/>)</span></pre><ul class=""><li id="7259" class="jc jd hh je b jf kh jh ki jj kj jl kk jn kl jp jq jr js jt bi translated">让我们加载行项目</li></ul><pre class="ka kb kc kd fd km kn ko kp aw kq bi"><span id="0eab" class="kr if hh kn b fi ks kt l ku kv">val lineitem = spark.read.parquet("wasbs://containername@storagename.blob.core.windows.net/LINEITEM/*.parquet")</span></pre><ul class=""><li id="ff63" class="jc jd hh je b jf kh jh ki jj kj jl kk jn kl jp jq jr js jt bi translated">显示行项目</li></ul><pre class="ka kb kc kd fd km kn ko kp aw kq bi"><span id="f0cb" class="kr if hh kn b fi ks kt l ku kv">display(linetem)</span></pre><ul class=""><li id="ef8b" class="jc jd hh je b jf kh jh ki jj kj jl kk jn kl jp jq jr js jt bi translated">创建临时视图以运行sql</li></ul><pre class="ka kb kc kd fd km kn ko kp aw kq bi"><span id="01e4" class="kr if hh kn b fi ks kt l ku kv">%sql<br/>CREATE TEMPORARY VIEW lineitem<br/>USING org.apache.spark.sql.parquet<br/>OPTIONS (<br/>  path "wasbs://containername@storagename.blob.core.windows.net/LINEITEM/*.parquet"<br/>)</span></pre><ul class=""><li id="64c0" class="jc jd hh je b jf kh jh ki jj kj jl kk jn kl jp jq jr js jt bi translated">加载国家数据集</li></ul><pre class="ka kb kc kd fd km kn ko kp aw kq bi"><span id="a1fd" class="kr if hh kn b fi ks kt l ku kv">val nation = spark.read.parquet("wasbs://containername@storagename.blob.core.windows.net/NATION/*.parquet")</span></pre><ul class=""><li id="cfa6" class="jc jd hh je b jf kh jh ki jj kj jl kk jn kl jp jq jr js jt bi translated">展示民族</li></ul><pre class="ka kb kc kd fd km kn ko kp aw kq bi"><span id="3558" class="kr if hh kn b fi ks kt l ku kv">display(nation)</span></pre><ul class=""><li id="a1f2" class="jc jd hh je b jf kh jh ki jj kj jl kk jn kl jp jq jr js jt bi translated">现在创建临时视图</li></ul><pre class="ka kb kc kd fd km kn ko kp aw kq bi"><span id="ec90" class="kr if hh kn b fi ks kt l ku kv">%sql<br/>CREATE TEMPORARY VIEW nation<br/>USING org.apache.spark.sql.parquet<br/>OPTIONS (<br/>  path "wasbs://containername@storagename.blob.core.windows.net/NATION/*.parquet"<br/>)</span></pre><ul class=""><li id="9d15" class="jc jd hh je b jf kh jh ki jj kj jl kk jn kl jp jq jr js jt bi translated">将订单载入数据框</li></ul><pre class="ka kb kc kd fd km kn ko kp aw kq bi"><span id="0083" class="kr if hh kn b fi ks kt l ku kv">val orders = spark.read.parquet("wasbs://containername@storagename.blob.core.windows.net/ORDERS/*.parquet")</span></pre><ul class=""><li id="49ae" class="jc jd hh je b jf kh jh ki jj kj jl kk jn kl jp jq jr js jt bi translated">显示订单</li></ul><pre class="ka kb kc kd fd km kn ko kp aw kq bi"><span id="6896" class="kr if hh kn b fi ks kt l ku kv">display(orders)</span></pre><ul class=""><li id="4e29" class="jc jd hh je b jf kh jh ki jj kj jl kk jn kl jp jq jr js jt bi translated">现在创建临时视图来运行Spark SQL</li></ul><pre class="ka kb kc kd fd km kn ko kp aw kq bi"><span id="8603" class="kr if hh kn b fi ks kt l ku kv">val part = spark.read.parquet("wasbs://containername@storagename.blob.core.windows.net/PART/*.parquet")</span></pre><ul class=""><li id="ed48" class="jc jd hh je b jf kh jh ki jj kj jl kk jn kl jp jq jr js jt bi translated">现在让我们加载零件数据集</li></ul><pre class="ka kb kc kd fd km kn ko kp aw kq bi"><span id="6285" class="kr if hh kn b fi ks kt l ku kv">val part = spark.read.parquet("wasbs://containername@storagename.blob.core.windows.net/PART/*.parquet")</span></pre><ul class=""><li id="382a" class="jc jd hh je b jf kh jh ki jj kj jl kk jn kl jp jq jr js jt bi translated">显示零件数据集</li></ul><pre class="ka kb kc kd fd km kn ko kp aw kq bi"><span id="d3c9" class="kr if hh kn b fi ks kt l ku kv">display(part)</span></pre><ul class=""><li id="fe8d" class="jc jd hh je b jf kh jh ki jj kj jl kk jn kl jp jq jr js jt bi translated">现在让我们为spark SQL创建临时视图</li></ul><pre class="ka kb kc kd fd km kn ko kp aw kq bi"><span id="62e4" class="kr if hh kn b fi ks kt l ku kv">%sql<br/>CREATE TEMPORARY VIEW part<br/>USING org.apache.spark.sql.parquet<br/>OPTIONS (<br/>  path "wasbs://containername@storagename.blob.core.windows.net/PART/*.parquet"<br/>)</span></pre><ul class=""><li id="3d6a" class="jc jd hh je b jf kh jh ki jj kj jl kk jn kl jp jq jr js jt bi translated">让我们装载零件供应商</li></ul><pre class="ka kb kc kd fd km kn ko kp aw kq bi"><span id="e405" class="kr if hh kn b fi ks kt l ku kv">val partsupp = spark.read.parquet("wasbs://containername@storagename.blob.core.windows.net/PARTSUPP/*.parquet")</span></pre><ul class=""><li id="0846" class="jc jd hh je b jf kh jh ki jj kj jl kk jn kl jp jq jr js jt bi translated">显示零件供应商</li></ul><pre class="ka kb kc kd fd km kn ko kp aw kq bi"><span id="fbb0" class="kr if hh kn b fi ks kt l ku kv">display(partsupp)</span></pre><ul class=""><li id="3002" class="jc jd hh je b jf kh jh ki jj kj jl kk jn kl jp jq jr js jt bi translated">现在让我们为spark SQL创建临时视图</li></ul><pre class="ka kb kc kd fd km kn ko kp aw kq bi"><span id="7986" class="kr if hh kn b fi ks kt l ku kv">%sql<br/>CREATE TEMPORARY VIEW partsupp<br/>USING org.apache.spark.sql.parquet<br/>OPTIONS (<br/>  path "wasbs://containername@storagename.blob.core.windows.net/PARTSUPP/*.parquet"<br/>)</span></pre><ul class=""><li id="92ea" class="jc jd hh je b jf kh jh ki jj kj jl kk jn kl jp jq jr js jt bi translated">让我们加载区域数据集</li></ul><pre class="ka kb kc kd fd km kn ko kp aw kq bi"><span id="c152" class="kr if hh kn b fi ks kt l ku kv">val region = spark.read.parquet("wasbs://containername@storagename.blob.core.windows.net/REGION/*.parquet")</span></pre><ul class=""><li id="76fd" class="jc jd hh je b jf kh jh ki jj kj jl kk jn kl jp jq jr js jt bi translated">显示区域数据集</li></ul><pre class="ka kb kc kd fd km kn ko kp aw kq bi"><span id="9d75" class="kr if hh kn b fi ks kt l ku kv">display(region)</span></pre><ul class=""><li id="25f6" class="jc jd hh je b jf kh jh ki jj kj jl kk jn kl jp jq jr js jt bi translated">让我们为Spark SQL创建临时视图</li></ul><pre class="ka kb kc kd fd km kn ko kp aw kq bi"><span id="b07c" class="kr if hh kn b fi ks kt l ku kv">%sql<br/>CREATE TEMPORARY VIEW region<br/>USING org.apache.spark.sql.parquet<br/>OPTIONS (<br/>  path "wasbs://containername@storagename.blob.core.windows.net/REGION/*.parquet"<br/>)</span></pre><ul class=""><li id="083a" class="jc jd hh je b jf kh jh ki jj kj jl kk jn kl jp jq jr js jt bi translated">现在让我们加载供应商数据集</li></ul><pre class="ka kb kc kd fd km kn ko kp aw kq bi"><span id="8aa2" class="kr if hh kn b fi ks kt l ku kv">val supplier = spark.read.parquet("wasbs://containername@storagename.blob.core.windows.net/SUPPLIER/*.parquet")</span></pre><ul class=""><li id="3535" class="jc jd hh je b jf kh jh ki jj kj jl kk jn kl jp jq jr js jt bi translated">显示数据集</li></ul><pre class="ka kb kc kd fd km kn ko kp aw kq bi"><span id="580c" class="kr if hh kn b fi ks kt l ku kv">display(supplier)</span></pre><ul class=""><li id="08b7" class="jc jd hh je b jf kh jh ki jj kj jl kk jn kl jp jq jr js jt bi translated">让我们为spark sql创建临时视图</li></ul><pre class="ka kb kc kd fd km kn ko kp aw kq bi"><span id="f7b7" class="kr if hh kn b fi ks kt l ku kv">%sql<br/>CREATE TEMPORARY VIEW supplier<br/>USING org.apache.spark.sql.parquet<br/>OPTIONS (<br/>  path "wasbs://containername@storagename.blob.core.windows.net/SUPPLIER/*.parquet"<br/>)</span></pre><ul class=""><li id="8341" class="jc jd hh je b jf kh jh ki jj kj jl kk jn kl jp jq jr js jt bi translated">现在让我们运行一个TPC-H查询</li><li id="62de" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">找到表演</li></ul><pre class="ka kb kc kd fd km kn ko kp aw kq bi"><span id="3f21" class="kr if hh kn b fi ks kt l ku kv">%sql<br/><br/>select<br/>       l_returnflag,<br/>       l_linestatus,<br/>       sum(l_quantity) as sum_qty,<br/>       sum(l_extendedprice) as sum_base_price,<br/>       sum(l_extendedprice * (1-l_discount)) as sum_disc_price,<br/>       sum(l_extendedprice * (1-l_discount) * (1+l_tax)) as sum_charge,<br/>       avg(l_quantity) as avg_qty,<br/>       avg(l_extendedprice) as avg_price,<br/>       avg(l_discount) as avg_disc,<br/>       count(*) as count_order<br/> from<br/>       lineitem<br/> where<br/>       l_shipdate &lt;= date_add(to_date('1998-12-01'), -90)<br/> group by<br/>       l_returnflag,<br/>       l_linestatus<br/> order by<br/>       l_returnflag,<br/>       l_linestatus;</span></pre><figure class="ka kb kc kd fd ke er es paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="er es kw"><img src="../Images/f3ee328df0eeb1c78dbfac28506bdc67.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*WKG12waVoM7WrbKK.jpg"/></div></div></figure></div><div class="ab cl lb lc go ld" role="separator"><span class="le bw bk lf lg lh"/><span class="le bw bk lf lg lh"/><span class="le bw bk lf lg"/></div><div class="ha hb hc hd he"><p id="8afe" class="pw-post-body-paragraph li lj hh je b jf kh lk ll jh ki lm ln jj lo lp lq jl lr ls lt jn lu lv lw jp ha bi translated"><em class="lx">最初发表于</em><a class="ae ly" href="https://github.com/balakreshnan/tpchtest/blob/main/tpchtest/synapsespark.md" rel="noopener ugc nofollow" target="_blank"><em class="lx">【https://github.com】</em></a><em class="lx">。</em></p></div></div>    
</body>
</html>