<html>
<head>
<title>Azure Synapse Analytics — End to End for Automated ML using Azure Machine learning</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Azure Synapse Analytics —使用Azure机器学习的自动化ML的端到端</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/azure-synapse-analytics-end-to-end-for-automated-ml-using-azure-machine-learning-aa05e0f1df65?source=collection_archive---------1-----------------------#2021-11-27">https://medium.com/analytics-vidhya/azure-synapse-analytics-end-to-end-for-automated-ml-using-azure-machine-learning-aa05e0f1df65?source=collection_archive---------1-----------------------#2021-11-27</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><div class=""><h2 id="51c2" class="pw-subtitle-paragraph ie hg hh bd b if ig ih ii ij ik il im in io ip iq ir is it iu iv dx translated">使用Azure Synapse Analytics Workspace移动数据、处理数据、训练模型</h2></div><h1 id="5ad2" class="iw ix hh bd iy iz ja jb jc jd je jf jg in jh io ji iq jj ir jk it jl iu jm jn bi translated">为数据和数据科学生命周期管理提供统一的平台，以提高工作效率</h1><h1 id="14ed" class="iw ix hh bd iy iz ja jb jc jd je jf jg in jh io ji iq jj ir jk it jl iu jm jn bi translated">注意</h1><ul class=""><li id="bfa8" class="jo jp hh jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf bi translated">本文将展示这一功能</li></ul><h1 id="ad14" class="iw ix hh bd iy iz ja jb jc jd je jf jg in jh io ji iq jj ir jk it jl iu jm jn bi translated">先决条件</h1><ul class=""><li id="82a8" class="jo jp hh jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf bi translated">Azure帐户</li><li id="9c36" class="jo jp hh jq b jr kg jt kh jv ki jx kj jz kk kb kc kd ke kf bi translated">Azure synapse分析工作区</li><li id="7f69" class="jo jp hh jq b jr kg jt kh jv ki jx kj jz kk kb kc kd ke kf bi translated">Azure机器学习工作区</li><li id="06a9" class="jo jp hh jq b jr kg jt kh jv ki jx kj jz kk kb kc kd ke kf bi translated">Azure SQL数据库</li><li id="a168" class="jo jp hh jq b jr kg jt kh jv ki jx kj jz kk kb kc kd ke kf bi translated">Azure存储</li><li id="d561" class="jo jp hh jq b jr kg jt kh jv ki jx kj jz kk kb kc kd ke kf bi translated">从kaggel下载Covid19数据，并作为外部源模拟数据导入Azure SQL</li><li id="5664" class="jo jp hh jq b jr kg jt kh jv ki jx kj jz kk kb kc kd ke kf bi translated">创建一个表作为dbo.covid19data并上传数据</li></ul><figure class="km kn ko kp fd kq er es paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="er es kl"><img src="../Images/31be49df21e1eede546431d2eb7f3ab5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*LQlM6PIMBMmntez_.jpg"/></div></div></figure><ul class=""><li id="ba0f" class="jo jp hh jq b jr kx jt ky jv kz jx la jz lb kb kc kd ke kf bi translated">上述架构流程有3个组成部分</li><li id="93cd" class="jo jp hh jq b jr kg jt kh jv ki jx kj jz kk kb kc kd ke kf bi translated">复制活动以从外部源移动数据，并将其带到原始或输入区域</li><li id="c3e8" class="jo jp hh jq b jr kg jt kh jv ki jx kj jz kk kb kc kd ke kf bi translated">接下来是数据流活动，通过拖放ETL/ELT来转换或处理数据并最终完成</li><li id="c4b4" class="jo jp hh jq b jr kg jt kh jv ki jx kj jz kk kb kc kd ke kf bi translated">使用spark运行机器学习模型来运行自动化ML sdk的笔记本电脑</li><li id="427a" class="jo jp hh jq b jr kg jt kh jv ki jx kj jz kk kb kc kd ke kf bi translated">我们使用回归来预测covid 19导致的死亡</li><li id="2d8b" class="jo jp hh jq b jr kg jt kh jv ki jx kj jz kk kb kc kd ke kf bi translated">登录Azure Synapse工作区</li><li id="7a0c" class="jo jp hh jq b jr kg jt kh jv ki jx kj jz kk kb kc kd ke kf bi translated">创建管道/集成</li><li id="3ce4" class="jo jp hh jq b jr kg jt kh jv ki jx kj jz kk kb kc kd ke kf bi translated">拖放复制活动</li><li id="9539" class="jo jp hh jq b jr kg jt kh jv ki jx kj jz kk kb kc kd ke kf bi translated">对于源，选择上面的SQL server —(需要创建链接服务)</li></ul><figure class="km kn ko kp fd kq er es paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="er es lc"><img src="../Images/106f6a4dab3b6f37c064765afd9efb9d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*-igqG8IJmjM1H0fV.jpg"/></div></div></figure><figure class="km kn ko kp fd kq er es paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="er es ld"><img src="../Images/c5250b5cabe84af04dd4bf0de2a9b54b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*DBmXuWGDbgPJ4WLt.jpg"/></div></div></figure><figure class="km kn ko kp fd kq er es paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="er es le"><img src="../Images/8369e0e594aea88895088a0dccdec418.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*exU1RGAId_Rx3r18.jpg"/></div></div></figure><ul class=""><li id="d63a" class="jo jp hh jq b jr kx jt ky jv kz jx la jz lb kb kc kd ke kf bi translated">接下来创建一个数据流来处理数据</li><li id="a182" class="jo jp hh jq b jr kg jt kh jv ki jx kj jz kk kb kc kd ke kf bi translated">对于示例，我使用delta来简化CDC</li><li id="03f3" class="jo jp hh jq b jr kg jt kh jv ki jx kj jz kk kb kc kd ke kf bi translated">创建具有复制活动目标的来源</li></ul><figure class="km kn ko kp fd kq er es paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="er es lf"><img src="../Images/6fd2108f81fa71c5a41f629ce4b2d678.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*qTIWtrswQzDhK8bD.jpg"/></div></div></figure><ul class=""><li id="9d39" class="jo jp hh jq b jr kx jt ky jv kz jx la jz lb kb kc kd ke kf bi translated">我们可以恢复复制活动目的地链接服务本身</li><li id="0be7" class="jo jp hh jq b jr kg jt kh jv ki jx kj jz kk kb kc kd ke kf bi translated">现在拖动选择</li></ul><figure class="km kn ko kp fd kq er es paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="er es lg"><img src="../Images/16a7d32f6d368eb071cf8aa9f53b56ae.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*XxMKED1ViND1-lLi.jpg"/></div></div></figure><ul class=""><li id="4433" class="jo jp hh jq b jr kx jt ky jv kz jx la jz lb kb kc kd ke kf bi translated">选择所有列</li><li id="7fb6" class="jo jp hh jq b jr kg jt kh jv ki jx kj jz kk kb kc kd ke kf bi translated">启用调试并查看结果。这个数据集是开源的，所以没有PII</li></ul><figure class="km kn ko kp fd kq er es paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="er es lh"><img src="../Images/044ba2e425c163e674064ae9eb7b73cd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*vkd01eYZefV_F3Bb.jpg"/></div></div></figure><figure class="km kn ko kp fd kq er es paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="er es li"><img src="../Images/58f7d5c6cc72e4e728d054c6c4578add.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*_du9ZeuGBa0As7Wr.jpg"/></div></div></figure><figure class="km kn ko kp fd kq er es paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="er es lj"><img src="../Images/29d1db34ed56c91a1b2cf70915afc449.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*2lXLQVFUuHIGvgb3.jpg"/></div></div></figure><figure class="km kn ko kp fd kq er es paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="er es lk"><img src="../Images/236841d2def6e3277ee2e72501eaf6c8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*IyWuI032mBFFvMb6.jpg"/></div></div></figure><figure class="km kn ko kp fd kq er es paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="er es ll"><img src="../Images/2751252156108623e9c2d9f844bea893.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*aBzAxPlqe5tQfzP5.jpg"/></div></div></figure><ul class=""><li id="b8f6" class="jo jp hh jq b jr kx jt ky jv kz jx la jz lb kb kc kd ke kf bi translated">选择列</li><li id="64f8" class="jo jp hh jq b jr kg jt kh jv ki jx kj jz kk kb kc kd ke kf bi translated">查看调试以验证数据已处理</li></ul><figure class="km kn ko kp fd kq er es paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="er es lh"><img src="../Images/3ac324736bdaf68c28974c96058d2ec5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*XHIK57APmB_G0lFM.jpg"/></div></div></figure><figure class="km kn ko kp fd kq er es paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="er es lm"><img src="../Images/b4ad41348c3926e3e265073609afa936.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*TW6kwOP0aRJ1fmvm.jpg"/></div></div></figure><ul class=""><li id="409d" class="jo jp hh jq b jr kx jt ky jv kz jx la jz lb kb kc kd ke kf bi translated">现在谈谈机器学习</li><li id="5cf2" class="jo jp hh jq b jr kg jt kh jv ki jx kj jz kk kb kc kd ke kf bi translated">创建笔记本</li><li id="6fb1" class="jo jp hh jq b jr kg jt kh jv ki jx kj jz kk kb kc kd ke kf bi translated">访问上述汇数据集作为建模的输入</li><li id="feba" class="jo jp hh jq b jr kg jt kh jv ki jx kj jz kk kb kc kd ke kf bi translated">创建笔记本</li></ul><h1 id="a90a" class="iw ix hh bd iy iz ja jb jc jd je jf jg in jh io ji iq jj ir jk it jl iu jm jn bi translated">密码</h1><ul class=""><li id="8d19" class="jo jp hh jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf bi translated">加载数据</li></ul><pre class="km kn ko kp fd ln lo lp lq aw lr bi"><span id="7473" class="ls ix hh lo b fi lt lu l lv lw">%%pyspark<br/>df = spark.read.load('abfss://container@storageaccount.dfs.core.windows.net/covid19aggroutput/*.parquet', format='parquet')<br/>display(df.limit(10))</span></pre><figure class="km kn ko kp fd kq er es paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="er es lh"><img src="../Images/48a3b9ba9f0d14fcf6d00a26fd7feed5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*yEnOjOOQVwA5iJI7.jpg"/></div></div></figure><ul class=""><li id="4a21" class="jo jp hh jq b jr kx jt ky jv kz jx la jz lb kb kc kd ke kf bi translated">打印模式</li></ul><pre class="km kn ko kp fd ln lo lp lq aw lr bi"><span id="ef61" class="ls ix hh lo b fi lt lu l lv lw">df.printSchema</span></pre><ul class=""><li id="bc96" class="jo jp hh jq b jr kx jt ky jv kz jx la jz lb kb kc kd ke kf bi translated">需要进口</li></ul><pre class="km kn ko kp fd ln lo lp lq aw lr bi"><span id="1250" class="ls ix hh lo b fi lt lu l lv lw">from pyspark.sql.functions import *<br/>from pyspark.sql import *</span></pre><ul class=""><li id="08e2" class="jo jp hh jq b jr kx jt ky jv kz jx la jz lb kb kc kd ke kf bi translated">将日期转换为日期数据类型</li></ul><pre class="km kn ko kp fd ln lo lp lq aw lr bi"><span id="99cc" class="ls ix hh lo b fi lt lu l lv lw">df1 = df.withColumn("Date", to_date("ObservationDate", "MM/dd/yyyy")) <br/>display(df1)</span></pre><figure class="km kn ko kp fd kq er es paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="er es lh"><img src="../Images/9c12d625c74976683657b1296eaf346d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*wArM3S-VejYulLIE.jpg"/></div></div></figure><ul class=""><li id="c248" class="jo jp hh jq b jr kx jt ky jv kz jx la jz lb kb kc kd ke kf bi translated">创建新列</li></ul><pre class="km kn ko kp fd ln lo lp lq aw lr bi"><span id="6f80" class="ls ix hh lo b fi lt lu l lv lw">df2 = df1.withColumn("year", year(col("Date"))).withColumn("month", month(col("Date"))).withColumn("day", dayofmonth(col("Date")))</span></pre><figure class="km kn ko kp fd kq er es paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="er es lh"><img src="../Images/da21ae73200df7e7e93ed868a2cac8a9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*nmqgo0vdBz3bpLZG.jpg"/></div></div></figure><ul class=""><li id="aabe" class="jo jp hh jq b jr kx jt ky jv kz jx la jz lb kb kc kd ke kf bi translated">接下来是导入ML库</li></ul><pre class="km kn ko kp fd ln lo lp lq aw lr bi"><span id="66fe" class="ls ix hh lo b fi lt lu l lv lw">import azureml.core</span><span id="2737" class="ls ix hh lo b fi lx lu l lv lw">from azureml.core import Experiment, Workspace, Dataset, Datastore<br/>from azureml.train.automl import AutoMLConfig<br/>from azureml.data.dataset_factory import TabularDatasetFactory</span></pre><ul class=""><li id="8b83" class="jo jp hh jq b jr kx jt ky jv kz jx la jz lb kb kc kd ke kf bi translated">配置Azure机器学习工作区</li><li id="02b7" class="jo jp hh jq b jr kg jt kh jv ki jx kj jz kk kb kc kd ke kf bi translated">设置配置以访问自动机器学习</li></ul><pre class="km kn ko kp fd ln lo lp lq aw lr bi"><span id="c290" class="ls ix hh lo b fi lt lu l lv lw">subscription_id = "xxxxxxxx"<br/>resource_group = "xxxxxx"<br/>workspace_name = "workspacename"<br/>experiment_name = "nameofsynapse-covid19aggr-20210913"</span><span id="8b2c" class="ls ix hh lo b fi lx lu l lv lw">ws = Workspace(subscription_id = subscription_id, resource_group = resource_group, workspace_name = workspace_name)<br/>experiment = Experiment(ws, experiment_name)</span></pre><ul class=""><li id="7135" class="jo jp hh jq b jr kx jt ky jv kz jx la jz lb kb kc kd ke kf bi translated">仅获取必要的列</li></ul><pre class="km kn ko kp fd ln lo lp lq aw lr bi"><span id="a4f7" class="ls ix hh lo b fi lt lu l lv lw">dffinal = df2[["year","month", "day", "Confirmed", "Deaths", "Recovered"]]</span></pre><ul class=""><li id="eb28" class="jo jp hh jq b jr kx jt ky jv kz jx la jz lb kb kc kd ke kf bi translated">注册数据存储</li></ul><pre class="km kn ko kp fd ln lo lp lq aw lr bi"><span id="5f06" class="ls ix hh lo b fi lt lu l lv lw">datastore = Datastore.get_default(ws)<br/>dataset = TabularDatasetFactory.register_spark_dataframe(df, datastore, name = experiment_name + "-dataset")</span></pre><ul class=""><li id="13e3" class="jo jp hh jq b jr kx jt ky jv kz jx la jz lb kb kc kd ke kf bi translated">配置自动化ml</li></ul><pre class="km kn ko kp fd ln lo lp lq aw lr bi"><span id="8bf5" class="ls ix hh lo b fi lt lu l lv lw">automl_config = AutoMLConfig(spark_context = sc,<br/>                             task = "regression",<br/>                             training_data = dataset,<br/>                             label_column_name = "Deaths",<br/>                             primary_metric = "spearman_correlation",<br/>                             experiment_timeout_hours = 1,<br/>                             max_concurrent_iterations = 4,<br/>                             enable_onnx_compatible_models = False)</span></pre><ul class=""><li id="04df" class="jo jp hh jq b jr kx jt ky jv kz jx la jz lb kb kc kd ke kf bi translated">运行实验</li></ul><pre class="km kn ko kp fd ln lo lp lq aw lr bi"><span id="7912" class="ls ix hh lo b fi lt lu l lv lw">run = experiment.submit(automl_config)</span></pre><ul class=""><li id="f924" class="jo jp hh jq b jr kx jt ky jv kz jx la jz lb kb kc kd ke kf bi translated">等待完成</li></ul><pre class="km kn ko kp fd ln lo lp lq aw lr bi"><span id="6949" class="ls ix hh lo b fi lt lu l lv lw">run.wait_for_completion(show_output=False)</span></pre><ul class=""><li id="c27c" class="jo jp hh jq b jr kx jt ky jv kz jx la jz lb kb kc kd ke kf bi translated">显示输出</li></ul><pre class="km kn ko kp fd ln lo lp lq aw lr bi"><span id="5126" class="ls ix hh lo b fi lt lu l lv lw">displayHTML("&lt;a href={} target='_blank'&gt;Your experiment in Azure Machine Learning portal: {}&lt;/a&gt;".format(run.get_portal_url(), run.id))</span></pre><ul class=""><li id="4eb0" class="jo jp hh jq b jr kx jt ky jv kz jx la jz lb kb kc kd ke kf bi translated">运行实验并记录输出</li></ul><pre class="km kn ko kp fd ln lo lp lq aw lr bi"><span id="9a1b" class="ls ix hh lo b fi lt lu l lv lw">run.wait_for_completion()</span><span id="eb63" class="ls ix hh lo b fi lx lu l lv lw"># Install required dependency<br/>import pip<br/>pip.main(["install", "azure-storage-blob==12.5.0"])</span><span id="3d67" class="ls ix hh lo b fi lx lu l lv lw">import mlflow</span><span id="4574" class="ls ix hh lo b fi lx lu l lv lw"># Get best model from automl run<br/>best_run, non_onnx_model = run.get_output()</span><span id="e8fd" class="ls ix hh lo b fi lx lu l lv lw">artifact_path = experiment_name + "_artifact"</span><span id="433f" class="ls ix hh lo b fi lx lu l lv lw">mlflow.set_tracking_uri(ws.get_mlflow_tracking_uri())<br/>mlflow.set_experiment(experiment_name)</span><span id="8e01" class="ls ix hh lo b fi lx lu l lv lw">with mlflow.start_run() as run:<br/>    # Save the model to the outputs directory for capture<br/>    mlflow.sklearn.log_model(non_onnx_model, artifact_path)</span><span id="4b64" class="ls ix hh lo b fi lx lu l lv lw">    # Register the model to AML model registry<br/>    mlflow.register_model("runs:/" + run.info.run_id + "/" + artifact_path, "bbaccsynapse-covid19-20201217032226-Best")</span></pre><ul class=""><li id="b375" class="jo jp hh jq b jr kx jt ky jv kz jx la jz lb kb kc kd ke kf bi translated">保存管道并运行调试</li></ul><figure class="km kn ko kp fd kq er es paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="er es lh"><img src="../Images/a799648fd1a28bf3e69dd5387dbf827e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*bgQC7xwPUS43Bzfq.jpg"/></div></div></figure></div><div class="ab cl ly lz go ma" role="separator"><span class="mb bw bk mc md me"/><span class="mb bw bk mc md me"/><span class="mb bw bk mc md"/></div><div class="ha hb hc hd he"><p id="84eb" class="pw-post-body-paragraph mf mg hh jq b jr kx ii mh jt ky il mi jv mj mk ml jx mm mn mo jz mp mq mr kb ha bi translated"><em class="ms">最初发表于</em><a class="ae mt" href="https://github.com/balakreshnan/Samples2021/blob/main/Synapseworkspace/e2eautoml.md" rel="noopener ugc nofollow" target="_blank"><em class="ms">【https://github.com】</em></a><em class="ms">。</em></p></div></div>    
</body>
</html>