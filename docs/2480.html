<html>
<head>
<title>Containerizing python flask application</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">容器化python烧瓶应用程序</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/containerizing-python-flask-application-19faa9db031c?source=collection_archive---------12-----------------------#2021-04-26">https://medium.com/analytics-vidhya/containerizing-python-flask-application-19faa9db031c?source=collection_archive---------12-----------------------#2021-04-26</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="dac7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这篇文章是系列<a class="ae jd" rel="noopener" href="/@augustasberneckas/prepare-and-deploy-python-app-to-kubernetes-736b13fe4cef"> <strong class="ih hj">准备和部署python应用到Kubernetes </strong> </a>的一部分</p><p id="e267" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在这个系列的最后，我们将在Kubernetes中拥有一个完全可用的flask应用程序。我们正在使用的应用程序本身，可以在这里找到:<a class="ae jd" href="https://github.com/brnck/k8s-python-demo-app" rel="noopener ugc nofollow" target="_blank">https://github.com/brnck/k8s-python-demo-app</a></p></div><div class="ab cl je jf gp jg" role="separator"><span class="jh bw bk ji jj jk"/><span class="jh bw bk ji jj jk"/><span class="jh bw bk ji jj"/></div><div class="hb hc hd he hf"><h1 id="d78d" class="jl jm hi bd jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki bi translated">创建dockerfile文件</h1><p id="96d7" class="pw-post-body-paragraph if ig hi ih b ii kj ik il im kk io ip iq kl is it iu km iw ix iy kn ja jb jc hb bi translated">在我们开始编写Kubernetes清单之前，我们需要有容器化的应用程序。本指南假设您对<a class="ae jd" href="https://docs.docker.com/" rel="noopener ugc nofollow" target="_blank"> docker </a>以及如何<a class="ae jd" href="https://docs.docker.com/engine/reference/builder" rel="noopener ugc nofollow" target="_blank">构建图像</a>有一定的了解</p><p id="84f5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们从创建dockerfile开始:</p><pre class="ko kp kq kr fd ks kt ku kv aw kw bi"><span id="05c0" class="kx jm hi kt b fi ky kz l la lb">touch Dockerfile</span></pre><p id="977c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们的应用程序支持python 3.x，所以让我们从最新的稳定python(撰写本指南时为3.9.4)开始构建:</p><pre class="ko kp kq kr fd ks kt ku kv aw kw bi"><span id="9f82" class="kx jm hi kt b fi ky kz l la lb">FROM python:3.9.4-slim</span></pre><p id="a7eb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在你可能想知道标签末尾的单词<strong class="ih hj"> slim </strong>是干什么的。你可能还见过其他关键词，比如<strong class="ih hj">阿尔卑斯山</strong></p><p id="6abb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">有一个很好的解释贴<a class="ae jd" rel="noopener" href="/@geekgirl907">朱莉紫苏加西亚</a>。</p><p id="661d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">可以在这里查看:<a class="ae jd" rel="noopener" href="/swlh/alpine-slim-stretch-buster-jessie-bullseye-bookworm-what-are-the-differences-in-docker-62171ed4531d">阿尔卑斯、苗条、拉伸、巴斯特、杰西、靶心Docker形象有哪些不同？</a></p><p id="cd5a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">出于安全目的，我们不想以root用户身份运行我们的应用程序，因此让我们创建应用程序用户:</p><pre class="ko kp kq kr fd ks kt ku kv aw kw bi"><span id="47a8" class="kx jm hi kt b fi ky kz l la lb">RUN groupadd --gid 1000 app &amp;&amp; \<br/>    useradd --create-home --gid 1000 --uid 1000 app</span></pre><p id="8f2e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在让我们创建一个目录来存放我们的应用程序。有些人喜欢把一个应用放在<code class="du lc ld le kt b">/app</code>或者<code class="du lc ld le kt b">/appname</code>里。然而，我喜欢把应用程序放到<code class="du lc ld le kt b">/home/app/src</code>中，甚至不放在容器中，也放在硬件或虚拟机中。这提供了跨环境的某种标准化。因此，让我们创建一个目录，并将其作为工作目录:</p><pre class="ko kp kq kr fd ks kt ku kv aw kw bi"><span id="8c96" class="kx jm hi kt b fi ky kz l la lb">RUN mkdir -p /home/app/src</span><span id="eed9" class="kx jm hi kt b fi lf kz l la lb">WORKDIR /home/app/src</span></pre><p id="6d96" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">差不多结束了，环境准备好了。让我们继续复制源代码并安装依赖项:</p><pre class="ko kp kq kr fd ks kt ku kv aw kw bi"><span id="665a" class="kx jm hi kt b fi ky kz l la lb">COPY ./ /home/app/src<br/>RUN pip3 install -r requirements.txt</span></pre><p id="f685" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">最后，我们希望我们的应用程序作为用户<strong class="ih hj">应用程序</strong>运行，使用<strong class="ih hj"> flask </strong> <a class="ae jd" href="https://docs.docker.com/engine/reference/builder/#entrypoint" rel="noopener ugc nofollow" target="_blank">入口点</a>，而<strong class="ih hj"> run </strong>作为<a class="ae jd" href="https://docs.docker.com/engine/reference/builder/#cmd" rel="noopener ugc nofollow" target="_blank">命令</a></p><pre class="ko kp kq kr fd ks kt ku kv aw kw bi"><span id="f6ae" class="kx jm hi kt b fi ky kz l la lb">USER app</span><span id="8a75" class="kx jm hi kt b fi lf kz l la lb">ENTRYPOINT ["flask"]</span><span id="fc78" class="kx jm hi kt b fi lf kz l la lb">CMD ["run"]</span></pre><p id="f4a7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们完整的docker文件应该是这样的:</p><pre class="ko kp kq kr fd ks kt ku kv aw kw bi"><span id="684e" class="kx jm hi kt b fi ky kz l la lb">FROM python:3.9.4-slim</span><span id="f60a" class="kx jm hi kt b fi lf kz l la lb">RUN groupadd --gid 1000 app &amp;&amp; \<br/>    useradd --create-home --gid 1000 --uid 1000 app</span><span id="c30e" class="kx jm hi kt b fi lf kz l la lb">RUN mkdir -p /home/app/src</span><span id="e433" class="kx jm hi kt b fi lf kz l la lb">WORKDIR /home/app/src</span><span id="6677" class="kx jm hi kt b fi lf kz l la lb">COPY ./ /home/app/src<br/>RUN pip3 install -r requirements.txt</span><span id="d1a1" class="kx jm hi kt b fi lf kz l la lb">USER app</span><span id="2e5a" class="kx jm hi kt b fi lf kz l la lb">ENTRYPOINT ["flask"]</span><span id="0ace" class="kx jm hi kt b fi lf kz l la lb">CMD ["run"]</span></pre><h1 id="d099" class="jl jm hi bd jn jo lg jq jr js lh ju jv jw li jy jz ka lj kc kd ke lk kg kh ki bi translated">添加中。dockerignore</h1><p id="ab74" class="pw-post-body-paragraph if ig hi ih b ii kj ik il im kk io ip iq kl is it iu km iw ix iy kn ja jb jc hb bi translated">我们还希望防止将不必要的文件添加到docker映像中。那就是<a class="ae jd" href="https://docs.docker.com/engine/reference/builder/#dockerignore-file" rel="noopener ugc nofollow" target="_blank">的地方。dockerignore </a>进来了。它的工作原理类似于。gitignore通过忽略将构建到图像中的文件或文件夹。这有助于通过避免不必要地将大的或敏感的文件和目录发送到守护程序，以及潜在地使用<code class="du lc ld le kt b">ADD</code>或<code class="du lc ld le kt b">COPY</code>将它们添加到映像来减小映像大小</p><p id="05cc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们创建<code class="du lc ld le kt b">.dockerignore</code>文件并忽略不必要的文件:</p><pre class="ko kp kq kr fd ks kt ku kv aw kw bi"><span id="2104" class="kx jm hi kt b fi ky kz l la lb">.idea/<br/>.vscode/<br/>.git/<br/>.venv/<br/>__pycache__/<br/>.gitignore<br/>Dockerfile</span></pre><h1 id="e3a8" class="jl jm hi bd jn jo lg jq jr js lh ju jv jw li jy jz ka lj kc kd ke lk kg kh ki bi translated">构建和运行docker文件</h1><pre class="ko kp kq kr fd ks kt ku kv aw kw bi"><span id="315c" class="kx jm hi kt b fi ky kz l la lb">docker build -t python-demo-app:init .<br/>&lt;...&gt;<br/> =&gt; =&gt; naming to docker.io/library/python-demo-app:init</span></pre><p id="6be6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们运行我们的容器</p><pre class="ko kp kq kr fd ks kt ku kv aw kw bi"><span id="2b31" class="kx jm hi kt b fi ky kz l la lb">docker run --rm python-demo-app:init run --host 0.0.0.0 --port 5000<br/> * Environment: production<br/>   WARNING: This is a development server. Do not use it in a production deployment.<br/>   Use a production WSGI server instead.<br/> * Debug mode: off<br/> * Running on http://127.0.0.1:5000/ (Press CTRL+C to quit)</span></pre><p id="7bda" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">打开另一个终端会话并curl localhost</p><pre class="ko kp kq kr fd ks kt ku kv aw kw bi"><span id="1908" class="kx jm hi kt b fi ky kz l la lb">curl localhost:5000<br/>curl: (7) Failed to connect to localhost port 5000: Connection refused</span></pre><p id="77cd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">哎呀...端口不对主机公开。让我们用暴露的端口重新运行容器:</p><pre class="ko kp kq kr fd ks kt ku kv aw kw bi"><span id="a7cf" class="kx jm hi kt b fi ky kz l la lb">docker run --rm --publish 5000:5000 python-demo-app:init run --host 0.0.0.0 --port 5000<br/>curl 127.0.0.1:5000<br/>Hello, World!</span></pre><h1 id="f103" class="jl jm hi bd jn jo lg jq jr js lh ju jv jw li jy jz ka lj kc kd ke lk kg kh ki bi translated">切换到生产服务器</h1><p id="a4bb" class="pw-post-body-paragraph if ig hi ih b ii kj ik il im kk io ip iq kl is it iu km iw ix iy kn ja jb jc hb bi translated">您可能已经注意到，甚至flask本身也会打印一条警告:</p><pre class="ko kp kq kr fd ks kt ku kv aw kw bi"><span id="eb33" class="kx jm hi kt b fi ky kz l la lb">* Environment: production<br/>   WARNING: This is a development server. Do not use it in a production deployment.<br/>   Use a production WSGI server instead.</span></pre><p id="e479" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">因为我们正在为生产准备应用程序，所以让我们切换到WSGI服务器。在这种情况下，我们将使用<a class="ae jd" href="https://gunicorn.org/" rel="noopener ugc nofollow" target="_blank"> gunicorn </a></p><p id="ccd5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们通过添加<strong class="ih hj"> gunicorn </strong>来编辑我们的<strong class="ih hj"> requirements.txt </strong>文件:</p><pre class="ko kp kq kr fd ks kt ku kv aw kw bi"><span id="17e8" class="kx jm hi kt b fi ky kz l la lb">gunicorn==20.0.4</span></pre><p id="ba34" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">继续编辑Dockerfile并从<strong class="ih hj">烧瓶</strong>切换到<strong class="ih hj"> gunicorn </strong>:</p><p id="78b1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">转换</p><pre class="ko kp kq kr fd ks kt ku kv aw kw bi"><span id="4a68" class="kx jm hi kt b fi ky kz l la lb">ENTRYPOINT ["flask"]</span></pre><p id="2d3b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">到</p><pre class="ko kp kq kr fd ks kt ku kv aw kw bi"><span id="e04d" class="kx jm hi kt b fi ky kz l la lb">ENTRYPOINT ["gunicorn"]</span></pre><p id="2e7f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">还有，开关</p><pre class="ko kp kq kr fd ks kt ku kv aw kw bi"><span id="0c92" class="kx jm hi kt b fi ky kz l la lb">CMD ["run"]</span></pre><p id="502c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">到</p><pre class="ko kp kq kr fd ks kt ku kv aw kw bi"><span id="7eb7" class="kx jm hi kt b fi ky kz l la lb">CMD ["app:app"]</span></pre><p id="dcb0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们的docker文件现在应该是这样的:</p><pre class="ko kp kq kr fd ks kt ku kv aw kw bi"><span id="3abf" class="kx jm hi kt b fi ky kz l la lb">FROM python:3.9.4-slim</span><span id="5959" class="kx jm hi kt b fi lf kz l la lb">RUN groupadd --gid 1000 app &amp;&amp; \<br/>    useradd --create-home --gid 1000 --uid 1000 app</span><span id="6be2" class="kx jm hi kt b fi lf kz l la lb">RUN mkdir -p /home/app/src</span><span id="e378" class="kx jm hi kt b fi lf kz l la lb">WORKDIR /home/app/src</span><span id="7172" class="kx jm hi kt b fi lf kz l la lb">COPY ./ /home/app/src<br/>RUN pip3 install -r requirements.txt</span><span id="27a1" class="kx jm hi kt b fi lf kz l la lb">USER app</span><span id="1002" class="kx jm hi kt b fi lf kz l la lb">ENTRYPOINT ["gunicorn"]</span><span id="59c4" class="kx jm hi kt b fi lf kz l la lb">CMD ["app:app"]</span></pre><p id="d540" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们重新构建我们的容器并再次运行它:</p><pre class="ko kp kq kr fd ks kt ku kv aw kw bi"><span id="5e6e" class="kx jm hi kt b fi ky kz l la lb">docker build -t python-demo-app:init .</span></pre><p id="1bc3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">因为gunicorn默认运行在端口<code class="du lc ld le kt b">8000</code>上，所以让我们切换到它而不是<code class="du lc ld le kt b">5000</code>端口</p><pre class="ko kp kq kr fd ks kt ku kv aw kw bi"><span id="730c" class="kx jm hi kt b fi ky kz l la lb">docker run --rm --publish 8000:8000 python-demo-app:init --bind 0.0.0.0 app:app<br/>[2021-04-21 13:11:24 +0000] [1] [INFO] Starting gunicorn 20.0.4<br/>[2021-04-21 13:11:24 +0000] [1] [INFO] Listening at: http://0.0.0.0:8000 (1)<br/>[2021-04-21 13:11:24 +0000] [1] [INFO] Using worker: sync<br/>[2021-04-21 13:11:24 +0000] [7] [INFO] Booting worker with pid: 7</span><span id="6fd4" class="kx jm hi kt b fi lf kz l la lb">curl 127.0.0.1:8000<br/>Hello, World!</span></pre><h1 id="444d" class="jl jm hi bd jn jo lg jq jr js lh ju jv jw li jy jz ka lj kc kd ke lk kg kh ki bi translated">运行CLI脚本而不是web服务器</h1><p id="a1d5" class="pw-post-body-paragraph if ig hi ih b ii kj ik il im kk io ip iq kl is it iu km iw ix iy kn ja jb jc hb bi translated">我们可以选择只为python CLI脚本构建一个单独的映像，或者只通过更改<strong class="ih hj">入口点</strong>和<strong class="ih hj"> cmd </strong>来重用我们当前的映像。让我们将<strong class="ih hj">入口点</strong>切换到<strong class="ih hj"> python3 </strong>而不是<strong class="ih hj"> gunicorn </strong>并执行<strong class="ih hj"> cli.py </strong>脚本</p><pre class="ko kp kq kr fd ks kt ku kv aw kw bi"><span id="43cd" class="kx jm hi kt b fi ky kz l la lb">docker run --rm --entrypoint python3 python-demo-app:init cli.py<br/>Hello, world from CLI!</span></pre><h1 id="7fea" class="jl jm hi bd jn jo lg jq jr js lh ju jv jw li jy jz ka lj kc kd ke lk kg kh ki bi translated">结论</h1><p id="0295" class="pw-post-body-paragraph if ig hi ih b ii kj ik il im kk io ip iq kl is it iu km iw ix iy kn ja jb jc hb bi translated">在本指南中，我们已经创建了dockerfile，我们将使用它来部署和服务来自Kubernetes的应用程序。</p><p id="0959" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">最终的解决方案可以在这里找到:<a class="ae jd" href="https://github.com/brnck/k8s-python-demo-app/tree/docker" rel="noopener ugc nofollow" target="_blank">https://github.com/brnck/k8s-python-demo-app/tree/docker</a></p><p id="fed6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们转到下一个指南，为我们的应用程序创建Kubernetes清单。或者如果你不熟悉<code class="du lc ld le kt b">minikube</code>，在进入清单部分之前，查看<a class="ae jd" href="https://augustasberneckas.medium.com/getting-to-know-minikube-e93f9676dea7" rel="noopener">这个</a>帖子</p></div></div>    
</body>
</html>