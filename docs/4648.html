<html>
<head>
<title>Azure Automated Machine learning using test data set to validate</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Azure自动机器学习使用测试数据集进行验证</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/azure-automated-machine-learning-using-test-data-set-to-validate-220cafb1e4e8?source=collection_archive---------1-----------------------#2021-12-11">https://medium.com/analytics-vidhya/azure-automated-machine-learning-using-test-data-set-to-validate-220cafb1e4e8?source=collection_archive---------1-----------------------#2021-12-11</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><h1 id="1118" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated">Azure机器学习使用测试数据集来验证和组合输入和预测</h1><h1 id="2fdc" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated">用例</h1><ul class=""><li id="44a1" class="jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt bi translated">运行自动ML模式</li><li id="35cc" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">使用测试数据集验证模型</li><li id="3ae2" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">使用单独的测试数据集，这些数据集是模型在训练中没有见过的数据</li><li id="33a6" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">保存预测</li><li id="6f38" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">组合输入测试数据集和预测，以生成最终的验证输出</li></ul><h1 id="7b41" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated">密码</h1><ul class=""><li id="4441" class="jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt bi translated">使用python版</li><li id="5014" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">AutoML仅适用于此版本</li></ul><pre class="jz ka kb kc fd kd ke kf kg aw kh bi"><span id="4cbd" class="ki if hh ke b fi kj kk l kl km">import logging<br/><br/>from matplotlib import pyplot as plt<br/>import pandas as pd<br/>import os<br/><br/>import azureml.core<br/>from azureml.core.experiment import Experiment<br/>from azureml.core.workspace import Workspace<br/>from azureml.core.dataset import Dataset<br/>from azureml.train.automl import AutoMLConfig</span><span id="514f" class="ki if hh ke b fi kn kk l kl km">print("This notebook was created using version 1.29 of the Azure ML SDK")<br/>print("You are currently using version", azureml.core.VERSION, "of the Azure ML SDK")</span></pre><ul class=""><li id="4fb6" class="jc jd hh je b jf ko jh kp jj kq jl kr jn ks jp jq jr js jt bi translated">测试时的版本是1.28.0</li><li id="aab2" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">加载订阅信息</li></ul><pre class="jz ka kb kc fd kd ke kf kg aw kh bi"><span id="d273" class="ki if hh ke b fi kj kk l kl km">ws = Workspace.from_config()<br/> <br/># choose a name for experiment<br/>experiment_name = 'Titanic-automl_Test'<br/><br/>experiment=Experiment(ws, experiment_name)<br/><br/>output = {}<br/>output['Subscription ID'] = ws.subscription_id<br/>output['Workspace'] = ws.name<br/>output['Resource Group'] = ws.resource_group<br/>output['Location'] = ws.location<br/>output['Experiment Name'] = experiment.name<br/>pd.set_option('display.max_colwidth', -1)<br/>outputDf = pd.DataFrame(data = output, index = [''])<br/>outputDf.T</span><span id="b894" class="ki if hh ke b fi kn kk l kl km">from azureml.core.compute import ComputeTarget, AmlCompute<br/>from azureml.core.compute_target import ComputeTargetException<br/><br/># Choose a name for your CPU cluster<br/>cpu_cluster_name = "cpu-cluster"<br/><br/># Verify that cluster does not exist already<br/>try:<br/>    compute_target = ComputeTarget(workspace=ws, name=cpu_cluster_name)<br/>    print('Found existing cluster, use it.')<br/>except ComputeTargetException:<br/>    compute_config = AmlCompute.provisioning_configuration(vm_size='STANDARD_FS16_V2',<br/>                                                           max_nodes=6)<br/>    compute_target = ComputeTarget.create(ws, cpu_cluster_name, compute_config)<br/><br/>compute_target.wait_for_completion(show_output=True)</span><span id="476f" class="ki if hh ke b fi kn kk l kl km"># azureml-core of version 1.0.72 or higher is required<br/># azureml-dataprep[pandas] of version 1.1.34 or higher is required<br/>from azureml.core import Workspace, Dataset<br/><br/>subscription_id = 'xxxxxxxxxxxxxxxxxxxxxxxxxxxxxx'<br/>resource_group = 'rgname'<br/>workspace_name = 'workspacename'<br/><br/>workspace = Workspace(subscription_id, resource_group, workspace_name)<br/><br/>dataset = Dataset.get_by_name(workspace, name='titanic_ds')<br/>dataset.to_pandas_dataframe()</span></pre><ul class=""><li id="d995" class="jc jd hh je b jf ko jh kp jj kq jl kr jn ks jp jq jr js jt bi translated">创建培训和测试数据集</li><li id="15fe" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">还要配置标签列名</li></ul><pre class="jz ka kb kc fd kd ke kf kg aw kh bi"><span id="297c" class="ki if hh ke b fi kj kk l kl km">training_data, validation_data = dataset.random_split(percentage=0.8, seed=223)<br/>label_column_name = 'Survived'</span><span id="cb2f" class="ki if hh ke b fi kn kk l kl km">automl_settings = {<br/>    "n_cross_validations": 3,<br/>    "primary_metric": 'average_precision_score_weighted',<br/>    "enable_early_stopping": True,<br/>    "max_concurrent_iterations": 2, # This is a limit for testing purpose, please increase it as per cluster size<br/>    "experiment_timeout_hours": 0.25, # This is a time limit for testing purposes, remove it for real use cases, this will drastically limit ablity to find the best model possible<br/>    "verbosity": logging.INFO,<br/>}<br/><br/><br/>automl_config = AutoMLConfig(task = 'classification',<br/>                             debug_log = 'automl_errors.log',<br/>                             compute_target = compute_target,<br/>                             training_data = training_data,<br/>                             label_column_name = label_column_name,<br/>                             <br/>                             # Use train/test split<br/>                             test_size=0.2,<br/>                             <br/>                             **automl_settings<br/>                            )</span><span id="1ef7" class="ki if hh ke b fi kn kk l kl km">remote_run = experiment.submit(automl_config, show_output = False)</span><span id="97e7" class="ki if hh ke b fi kn kk l kl km">from azureml.widgets import RunDetails<br/>RunDetails(remote_run).show()</span><span id="e613" class="ki if hh ke b fi kn kk l kl km">remote_run.wait_for_completion(show_output=True)</span></pre><ul class=""><li id="5fd6" class="jc jd hh je b jf ko jh kp jj kq jl kr jn ks jp jq jr js jt bi translated">获得最佳模型</li></ul><pre class="jz ka kb kc fd kd ke kf kg aw kh bi"><span id="ca74" class="ki if hh ke b fi kj kk l kl km">best_run, fitted_model = remote_run.get_output()<br/>fitted_model</span></pre><ul class=""><li id="a396" class="jc jd hh je b jf ko jh kp jj kq jl kr jn ks jp jq jr js jt bi translated">现在运行测试运行</li></ul><pre class="jz ka kb kc fd kd ke kf kg aw kh bi"><span id="f8f3" class="ki if hh ke b fi kj kk l kl km">test_run = next(best_run.get_children(type='automl.model_test'))<br/>test_run.wait_for_completion(show_output=False, wait_post_processing=True)<br/>test_run</span></pre><ul class=""><li id="5ff9" class="jc jd hh je b jf ko jh kp jj kq jl kr jn ks jp jq jr js jt bi translated">打印测试指标</li></ul><pre class="jz ka kb kc fd kd ke kf kg aw kh bi"><span id="6ed3" class="ki if hh ke b fi kj kk l kl km">test_run_metrics = test_run.get_metrics()<br/>for name, value in test_run_metrics.items():<br/>    print(f"{name}: {value}")</span></pre><ul class=""><li id="27da" class="jc jd hh je b jf ko jh kp jj kq jl kr jn ks jp jq jr js jt bi translated">查看预测的输出</li></ul><pre class="jz ka kb kc fd kd ke kf kg aw kh bi"><span id="a9eb" class="ki if hh ke b fi kj kk l kl km">test_run_details = test_run.get_details()<br/>test_run_predictions = Dataset.get_by_id(ws, test_run_details['outputDatasets'][0]['identifier']['savedId'])<br/>test_run_predictions.to_pandas_dataframe().head()</span></pre><ul class=""><li id="4abd" class="jc jd hh je b jf ko jh kp jj kq jl kr jn ks jp jq jr js jt bi translated">现在加载测试数据集</li></ul><pre class="jz ka kb kc fd kd ke kf kg aw kh bi"><span id="133e" class="ki if hh ke b fi kj kk l kl km"># azureml-core of version 1.0.72 or higher is required<br/># azureml-dataprep[pandas] of version 1.1.34 or higher is required<br/>from azureml.core import Workspace, Dataset<br/><br/>subscription_id = 'c46a9435-c957-4e6c-a0f4-b9a597984773'<br/>resource_group = 'mlops'<br/>workspace_name = 'mlopsdev'<br/><br/>workspace = Workspace(subscription_id, resource_group, workspace_name)<br/><br/>validation_data = Dataset.get_by_name(workspace, name='titanictest')<br/>validation_data.to_pandas_dataframe()</span></pre><ul class=""><li id="53b8" class="jc jd hh je b jf ko jh kp jj kq jl kr jn ks jp jq jr js jt bi translated">创建要素和标签</li></ul><pre class="jz ka kb kc fd kd ke kf kg aw kh bi"><span id="f167" class="ki if hh ke b fi kj kk l kl km"># convert the test data to dataframe<br/>X_test_df = validation_data.drop_columns(columns=[label_column_name]).to_pandas_dataframe()<br/>y_test_df = validation_data.keep_columns(columns=[label_column_name], validate=True).to_pandas_dataframe()</span></pre><ul class=""><li id="7235" class="jc jd hh je b jf ko jh kp jj kq jl kr jn ks jp jq jr js jt bi translated">从上述模型运行预测</li></ul><pre class="jz ka kb kc fd kd ke kf kg aw kh bi"><span id="b63a" class="ki if hh ke b fi kj kk l kl km"># call the predict functions on the model<br/>y_pred = fitted_model.predict(X_test_df)<br/>y_pred</span></pre><ul class=""><li id="9962" class="jc jd hh je b jf ko jh kp jj kq jl kr jn ks jp jq jr js jt bi translated">打印混淆矩阵</li></ul><pre class="jz ka kb kc fd kd ke kf kg aw kh bi"><span id="30ec" class="ki if hh ke b fi kj kk l kl km">from sklearn.metrics import confusion_matrix<br/>import numpy as np<br/>import itertools<br/><br/>cf =confusion_matrix(y_test_df.values,y_pred)<br/>plt.imshow(cf,cmap=plt.cm.Blues,interpolation='nearest')<br/>plt.colorbar()<br/>plt.title('Confusion Matrix')<br/>plt.xlabel('Predicted')<br/>plt.ylabel('Actual')<br/>class_labels = ['False','True']<br/>tick_marks = np.arange(len(class_labels))<br/>plt.xticks(tick_marks,class_labels)<br/>plt.yticks([-0.5,0,1,1.5],['','False','True',''])<br/># plotting text value inside cells<br/>thresh = cf.max() / 2.<br/>for i,j in itertools.product(range(cf.shape[0]),range(cf.shape[1])):<br/>    plt.text(j,i,format(cf[i,j],'d'),horizontalalignment='center',color='white' if cf[i,j] &gt;thresh else 'black')<br/>plt.show()</span></pre><ul class=""><li id="be41" class="jc jd hh je b jf ko jh kp jj kq jl kr jn ks jp jq jr js jt bi translated">打印模型指标</li></ul><pre class="jz ka kb kc fd kd ke kf kg aw kh bi"><span id="631c" class="ki if hh ke b fi kj kk l kl km">from azureml.train.automl.model_proxy import ModelProxy<br/><br/>model_proxy = ModelProxy(best_run)<br/>predictions, test_run_metrics = model_proxy.test(validation_data)<br/><br/>print(predictions.to_pandas_dataframe().head())<br/>pd.DataFrame.from_dict(test_run_metrics, orient='index', columns=['Value'])</span></pre><ul class=""><li id="ef48" class="jc jd hh je b jf ko jh kp jj kq jl kr jn ks jp jq jr js jt bi translated">新方法</li><li id="26fd" class="jc jd hh je b jf ju jh jv jj jw jl jx jn jy jp jq jr js jt bi translated">获得预测</li></ul><pre class="jz ka kb kc fd kd ke kf kg aw kh bi"><span id="a3e6" class="ki if hh ke b fi kj kk l kl km">df = validation_data.to_pandas_dataframe()</span><span id="ed39" class="ki if hh ke b fi kn kk l kl km">predictions_df = predictions.to_pandas_dataframe()</span><span id="da06" class="ki if hh ke b fi kn kk l kl km">result = pd.concat(df, predictions_df, axis=1, join="inner")</span></pre></div><div class="ab cl kt ku go kv" role="separator"><span class="kw bw bk kx ky kz"/><span class="kw bw bk kx ky kz"/><span class="kw bw bk kx ky"/></div><div class="ha hb hc hd he"><p id="914d" class="pw-post-body-paragraph la lb hh je b jf ko lc ld jh kp le lf jj lg lh li jl lj lk ll jn lm ln lo jp ha bi translated"><em class="lp">最初发表于</em><a class="ae lq" href="https://github.com/balakreshnan/Samples2021/blob/main/AutoML/automltestds.md" rel="noopener ugc nofollow" target="_blank"><em class="lp">【https://github.com】</em></a><em class="lp">。</em></p></div></div>    
</body>
</html>