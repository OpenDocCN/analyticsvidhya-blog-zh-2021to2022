<html>
<head>
<title>8 Week SQL Challenge: Case Study #1 Danny’s Diner</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">8周SQL挑战:案例研究#1丹尼餐厅</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/8-week-sql-challenge-case-study-week-1-dannys-diner-2ba026c897ab?source=collection_archive---------0-----------------------#2021-07-15">https://medium.com/analytics-vidhya/8-week-sql-challenge-case-study-week-1-dannys-diner-2ba026c897ab?source=collection_archive---------0-----------------------#2021-07-15</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="025d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">感谢马得精彩的案例分析！你可以在这里找到<a class="ae jd" href="https://8weeksqlchallenge.com/case-study-1/" rel="noopener ugc nofollow" target="_blank">自己试试。</a></p><p id="aaa9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我也在<a class="ae jd" href="https://github.com/katiehuangx/8-Week-SQL-Challenge/tree/main/Case%20Study%20%231%20-%20Danny's%20Diner" rel="noopener ugc nofollow" target="_blank"> GitHub </a>上发布了解决方案和完整语法。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es je"><img src="../Images/ca1fdc680d2f1fbc0536a97145094306.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7vbHeSc5CN99Ud7n9vJu6Q.png"/></div></div><figcaption class="jq jr et er es js jt bd b be z dx translated">图片来源:【https://8weeksqlchallenge.com/case-study-1/ T4】</figcaption></figure><h1 id="2ae3" class="ju jv hi bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">介绍</h1><p id="a03e" class="pw-post-body-paragraph if ig hi ih b ii ks ik il im kt io ip iq ku is it iu kv iw ix iy kw ja jb jc hb bi translated">丹尼非常喜欢日本食物，所以在2021年初，他决定进行一次冒险，开了一家可爱的小餐馆，出售他最喜欢的3种食物:寿司、咖喱和拉面。</p><p id="e10a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Danny's Diner需要您的帮助来维持餐厅的运营——餐厅从几个月的运营中获得了一些非常基本的数据，但不知道如何使用这些数据来帮助他们经营业务。</p><h1 id="35e8" class="ju jv hi bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">问题陈述</h1><p id="3efd" class="pw-post-body-paragraph if ig hi ih b ii ks ik il im kt io ip iq ku is it iu kv iw ix iy kw ja jb jc hb bi translated">Danny希望使用这些数据来回答一些关于他的客户的简单问题，尤其是关于他们的</p><ul class=""><li id="4e5e" class="kx ky hi ih b ii ij im in iq kz iu la iy lb jc lc ld le lf bi translated"><strong class="ih hj">访问模式</strong>，</li><li id="39a2" class="kx ky hi ih b ii lg im lh iq li iu lj iy lk jc lc ld le lf bi translated">他们已经花了多少钱</li><li id="0b5e" class="kx ky hi ih b ii lg im lh iq li iu lj iy lk jc lc ld le lf bi translated"><strong class="ih hj">哪些菜单项是他们最喜欢的</strong>。</li></ul><p id="287d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">与客户建立更深层次的联系将有助于他<strong class="ih hj">为忠诚的客户提供更好、更个性化的体验</strong><strong class="ih hj"/>。</p><p id="aa77" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">他计划利用这些见解来帮助他<strong class="ih hj">决定是否应该扩展现有的客户忠诚度计划</strong> —此外，他需要帮助来生成一些基本数据集，以便他的团队可以轻松检查数据，而无需使用SQL。</p><p id="a452" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">数据集包含以下3个表，您可以参考下面的关系图来了解这种联系。</p><ul class=""><li id="c95d" class="kx ky hi ih b ii ij im in iq kz iu la iy lb jc lc ld le lf bi translated">销售</li><li id="1658" class="kx ky hi ih b ii lg im lh iq li iu lj iy lk jc lc ld le lf bi translated">成员</li><li id="905e" class="kx ky hi ih b ii lg im lh iq li iu lj iy lk jc lc ld le lf bi translated">菜单</li></ul><h1 id="1a57" class="ju jv hi bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">表关系</h1><figure class="jf jg jh ji fd jj er es paragraph-image"><div class="er es ll"><img src="../Images/ee5aa27056083b4c32b1f7b2aaa9c521.png" data-original-src="https://miro.medium.com/v2/resize:fit:1190/format:webp/1*fEmZXjnIof5BHL_sLGDVUg.png"/></div></figure></div><div class="ab cl lm ln gp lo" role="separator"><span class="lp bw bk lq lr ls"/><span class="lp bw bk lq lr ls"/><span class="lp bw bk lq lr"/></div><div class="hb hc hd he hf"><h1 id="3222" class="ju jv hi bd jw jx lt jz ka kb lu kd ke kf lv kh ki kj lw kl km kn lx kp kq kr bi translated"><strong class="ak">案例研究问题</strong></h1><ol class=""><li id="707d" class="kx ky hi ih b ii ks im kt iq ly iu lz iy ma jc mb ld le lf bi translated">每位顾客在餐厅消费的总额是多少？</li><li id="bc1d" class="kx ky hi ih b ii lg im lh iq li iu lj iy lk jc mb ld le lf bi translated">每位顾客光顾餐厅有多少天了？</li><li id="9779" class="kx ky hi ih b ii lg im lh iq li iu lj iy lk jc mb ld le lf bi translated">每位顾客从菜单上购买的第一个项目是什么？</li><li id="226f" class="kx ky hi ih b ii lg im lh iq li iu lj iy lk jc mb ld le lf bi translated">菜单上购买最多的项目是什么？所有顾客购买了多少次？</li><li id="df15" class="kx ky hi ih b ii lg im lh iq li iu lj iy lk jc mb ld le lf bi translated">每位顾客最喜欢的商品是什么？</li><li id="52f3" class="kx ky hi ih b ii lg im lh iq li iu lj iy lk jc mb ld le lf bi translated">顾客成为会员后最先购买的物品是什么？</li><li id="ebc6" class="kx ky hi ih b ii lg im lh iq li iu lj iy lk jc mb ld le lf bi translated">顾客在成为会员之前购买了哪件商品？</li><li id="50a4" class="kx ky hi ih b ii lg im lh iq li iu lj iy lk jc mb ld le lf bi translated">每位会员在成为会员前的总物品和消费金额是多少？</li><li id="1d00" class="kx ky hi ih b ii lg im lh iq li iu lj iy lk jc mb ld le lf bi translated">如果每消费1美元相当于10个积分，寿司有2倍的积分乘数——每个顾客会有多少个积分？</li><li id="71fc" class="kx ky hi ih b ii lg im lh iq li iu lj iy lk jc mb ld le lf bi translated">在客户加入计划后的第一周(包括他们的加入日期),他们在所有项目上都获得了2x积分，不仅仅是寿司——客户A和B在1月底获得了多少积分？</li></ol></div><div class="ab cl lm ln gp lo" role="separator"><span class="lp bw bk lq lr ls"/><span class="lp bw bk lq lr ls"/><span class="lp bw bk lq lr"/></div><div class="hb hc hd he hf"><h1 id="8dd9" class="ju jv hi bd jw jx lt jz ka kb lu kd ke kf lv kh ki kj lw kl km kn lx kp kq kr bi translated">解决办法</h1><p id="d767" class="pw-post-body-paragraph if ig hi ih b ii ks ik il im kt io ip iq ku is it iu kv iw ix iy kw ja jb jc hb bi translated">我使用的是微软SQL服务器和这些函数。</p><ul class=""><li id="c96a" class="kx ky hi ih b ii ij im in iq kz iu la iy lb jc lc ld le lf bi translated">聚合函数—总和、最小值、最大值</li><li id="faef" class="kx ky hi ih b ii lg im lh iq li iu lj iy lk jc lc ld le lf bi translated">数值函数—顶部</li><li id="db98" class="kx ky hi ih b ii lg im lh iq li iu lj iy lk jc lc ld le lf bi translated">连接-内部连接，左连接</li><li id="9396" class="kx ky hi ih b ii lg im lh iq li iu lj iy lk jc lc ld le lf bi translated">临时表(CTE)</li><li id="5517" class="kx ky hi ih b ii lg im lh iq li iu lj iy lk jc lc ld le lf bi translated">Windows功能</li></ul><ol class=""><li id="2b60" class="kx ky hi ih b ii ij im in iq kz iu la iy lb jc mb ld le lf bi translated"><strong class="ih hj">每位顾客在餐厅消费的总金额是多少？</strong></li></ol><p id="7378" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们使用SUM和GROUP BY函数来找出每个客户和JOIN函数的总支出，因为customer_id来自<em class="mc"> sales </em>表，而price来自<em class="mc"> menu </em>表。</p><pre class="jf jg jh ji fd md me mf mg aw mh bi"><span id="b4de" class="mi jv hi me b fi mj mk l ml mm">SELECT s.customer_id, SUM(price) AS total_sales<br/>FROM dbo.sales AS s<br/>JOIN dbo.menu AS m<br/>ON s.product_id = m.product_id<br/>GROUP BY customer_id; </span></pre><figure class="jf jg jh ji fd jj er es paragraph-image"><div class="er es mn"><img src="../Images/4726314b1e6d8a4709d14fba3c0fabfb.png" data-original-src="https://miro.medium.com/v2/resize:fit:352/format:webp/1*h8-x9A6HM17p0uQAYET0Rw.png"/></div></figure><p id="d64e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">回答:</p><ul class=""><li id="ed54" class="kx ky hi ih b ii ij im in iq kz iu la iy lb jc lc ld le lf bi translated">顾客A花了76美元。</li><li id="6f4e" class="kx ky hi ih b ii lg im lh iq li iu lj iy lk jc lc ld le lf bi translated">顾客B消费了74美元。</li><li id="40ce" class="kx ky hi ih b ii lg im lh iq li iu lj iy lk jc lc ld le lf bi translated">顾客C花了36美元。</li></ul><p id="d782" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> 2。每位顾客光顾餐厅有多少天了？</strong></p><p id="d049" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用DISTINCT和wrap with COUNT函数找出顾客光顾餐馆的天数。</p><p id="1755" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果我们不对order_date使用DISTINCT，则天数可能会重复。例如，如果客户A在“2021–01–07”两次光顾该餐厅，则天数可能会计为2天，而不是1天。</p><pre class="jf jg jh ji fd md me mf mg aw mh bi"><span id="0fec" class="mi jv hi me b fi mj mk l ml mm">SELECT customer_id, COUNT(DISTINCT(order_date)) AS visit_count<br/>FROM dbo.sales<br/>GROUP BY customer_id;</span></pre><figure class="jf jg jh ji fd jj er es paragraph-image"><div class="er es mo"><img src="../Images/8fa34db894550ef6e4ced290df19edf8.png" data-original-src="https://miro.medium.com/v2/resize:fit:354/format:webp/1*jOp0k-VJ-mJ6hdVIYl_WWA.png"/></div></figure><p id="765a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">回答:</p><ul class=""><li id="fe98" class="kx ky hi ih b ii ij im in iq kz iu la iy lb jc lc ld le lf bi translated">客户A访问了4次。</li><li id="998e" class="kx ky hi ih b ii lg im lh iq li iu lj iy lk jc lc ld le lf bi translated">客户B访问了6次。</li><li id="b26b" class="kx ky hi ih b ii lg im lh iq li iu lj iy lk jc lc ld le lf bi translated">客户C访问了2次。</li></ul><p id="aa1e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> 3。每位顾客从菜单上购买的第一个项目是什么？</strong></p><p id="dba8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">首先，我们必须使用WITH函数创建一个CTE。在<em class="mc">汇总</em> CTE中，我们使用DENSE _ RANK and OVER(PARTITION BY ORDER BY)基于<em class="mc"> order_date </em>创建一个新列<em class="mc"> rank </em>。</p><p id="3613" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我选择使用DENSE_RANK而不是ROW_NUMBER或RANK，因为order_date没有时间戳，因此，如果在同一天订购了2个或更多项目，我们不知道先订购哪个项目。</p><pre class="jf jg jh ji fd md me mf mg aw mh bi"><span id="098d" class="mi jv hi me b fi mj mk l ml mm">WITH ordered_sales_cte AS<br/>(<br/> SELECT customer_id, order_date, product_name,<br/>  DENSE_RANK() OVER(PARTITION BY s.customer_id<br/>  ORDER BY s.order_date) AS rank<br/> FROM dbo.sales AS s<br/> JOIN dbo.menu AS m<br/>  ON s.product_id = m.product_id<br/>)</span></pre><figure class="jf jg jh ji fd jj er es paragraph-image"><div class="er es mp"><img src="../Images/34e58835d229afe3cfb689b354070074.png" data-original-src="https://miro.medium.com/v2/resize:fit:614/format:webp/1*dWliJECI4ooDVBmCdkjdIA.png"/></div></figure><p id="a5b9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">随后，我们按列分组，只显示秩= 1。</p><pre class="jf jg jh ji fd md me mf mg aw mh bi"><span id="b7e5" class="mi jv hi me b fi mj mk l ml mm">SELECT customer_id, product_name<br/>FROM ordered_sales_cte<br/>WHERE rank = 1<br/>GROUP BY customer_id, product_name;</span></pre><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es mq"><img src="../Images/776f809e9ae5d4bc013d93eacb9f86e5.png" data-original-src="https://miro.medium.com/v2/resize:fit:386/format:webp/1*gNDeU0jF_MWGkt3kyD0Lfw.png"/></div></div></figure><p id="ae23" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">回答:</p><ul class=""><li id="c56f" class="kx ky hi ih b ii ij im in iq kz iu la iy lb jc lc ld le lf bi translated">顾客A的第一份订单是咖喱和寿司。</li><li id="c392" class="kx ky hi ih b ii lg im lh iq li iu lj iy lk jc lc ld le lf bi translated">顾客B的第一份订单是咖喱。</li><li id="bc69" class="kx ky hi ih b ii lg im lh iq li iu lj iy lk jc lc ld le lf bi translated">顾客C的第一单是拉面。</li></ul><p id="9f19" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> 4。菜单上购买最多的项目是什么？所有顾客购买了多少次？</strong></p><pre class="jf jg jh ji fd md me mf mg aw mh bi"><span id="6957" class="mi jv hi me b fi mj mk l ml mm">SELECT TOP 1 (COUNT(s.product_id)) AS most_purchased, product_name<br/>FROM dbo.sales AS s<br/>JOIN dbo.menu AS m<br/> ON s.product_id = m.product_id<br/>GROUP BY s.product_id, product_name<br/>ORDER BY most_purchased DESC;SC;</span></pre><figure class="jf jg jh ji fd jj er es paragraph-image"><div class="er es mr"><img src="../Images/6f34d4edd4406434192060eed33615e3.png" data-original-src="https://miro.medium.com/v2/resize:fit:444/format:webp/1*d5GdTMSZkmojlgqPEo3HHg.png"/></div></figure><p id="37c8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">回答:</p><ul class=""><li id="9897" class="kx ky hi ih b ii ij im in iq kz iu la iy lb jc lc ld le lf bi translated">菜单上购买最多的是拉面。好吃！</li></ul><p id="4303" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> 5。每位顾客最喜欢的商品是什么？</strong></p><p id="08ca" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">同样，我们创建了一个CTE，通过每个客户的DESC订单对每个产品的订单数量进行排序。</p><pre class="jf jg jh ji fd md me mf mg aw mh bi"><span id="7450" class="mi jv hi me b fi mj mk l ml mm">WITH fav_item_cte AS<br/>(<br/> SELECT s.customer_id, m.product_name, <br/>  COUNT(m.product_id) AS order_count,<br/>  DENSE_RANK() OVER(PARTITION BY s.customer_id<br/>  ORDER BY COUNT(s.customer_id) DESC) AS rank<br/>FROM dbo.menu AS m<br/>JOIN dbo.sales AS s<br/> ON m.product_id = s.product_id<br/>GROUP BY s.customer_id, m.product_name<br/>)</span></pre><figure class="jf jg jh ji fd jj er es paragraph-image"><div class="er es ms"><img src="../Images/77de8d386a22923f773040c51ebcc1d3.png" data-original-src="https://miro.medium.com/v2/resize:fit:612/format:webp/1*BENADhaZPGUfrSgiYP4qjQ.png"/></div></figure><p id="4c68" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后，我们生成产品排名= 1的结果，作为单个客户最受欢迎的产品。</p><pre class="jf jg jh ji fd md me mf mg aw mh bi"><span id="7b64" class="mi jv hi me b fi mj mk l ml mm">SELECT customer_id, product_name, order_count<br/>FROM fav_item_cte <br/>WHERE rank = 1;</span></pre><figure class="jf jg jh ji fd jj er es paragraph-image"><div class="er es mt"><img src="../Images/e6bc2d7c456959057bcf62a371eb7084.png" data-original-src="https://miro.medium.com/v2/resize:fit:546/format:webp/1*ukjTF2mTs5dFxBjEa4gZ_Q.png"/></div></figure><ul class=""><li id="cb42" class="kx ky hi ih b ii ij im in iq kz iu la iy lb jc lc ld le lf bi translated">顾客A和C最喜欢的食物是拉面。</li><li id="1ebb" class="kx ky hi ih b ii lg im lh iq li iu lj iy lk jc lc ld le lf bi translated">顾客B喜欢菜单中的所有项目。他/她是一个真正的美食家。</li></ul><p id="48bf" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">6。顾客成为会员后最先购买的物品是什么？</p><p id="0e37" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">是的，你能猜到！我们正在创造另一个CTE。</p><p id="d356" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在此CTE中，我们将order_date筛选为等于或晚于其join_date，然后按order_date对product_id进行排序。</p><pre class="jf jg jh ji fd md me mf mg aw mh bi"><span id="978e" class="mi jv hi me b fi mj mk l ml mm">WITH member_sales_cte AS <br/>(<br/> SELECT s.customer_id, m.join_date, s.order_date,   s.product_id,<br/>         DENSE_RANK() OVER(PARTITION BY s.customer_id<br/>  ORDER BY s.order_date) AS rank<br/>     FROM sales AS s<br/> JOIN members AS m<br/>  ON s.customer_id = m.customer_id<br/> WHERE s.order_date &gt;= m.join_date<br/>)</span></pre><figure class="jf jg jh ji fd jj er es paragraph-image"><div class="er es mu"><img src="../Images/a8a7f9b276235b0463d5a6d8fc2c3fee.png" data-original-src="https://miro.medium.com/v2/resize:fit:706/format:webp/1*Qqsj9mQp5lMgVqdbeDchyw.png"/></div></figure><p id="00f2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">接下来，我们通过rank = 1过滤该表，以显示客户购买的第一件商品。</p><pre class="jf jg jh ji fd md me mf mg aw mh bi"><span id="4b7e" class="mi jv hi me b fi mj mk l ml mm">SELECT s.customer_id, s.order_date, m2.product_name <br/>FROM member_sales_cte AS s<br/>JOIN menu AS m2<br/> ON s.product_id = m2.product_id<br/>WHERE rank = 1;</span></pre><figure class="jf jg jh ji fd jj er es paragraph-image"><div class="er es mv"><img src="../Images/ce2a9042403940ace98b66dfe22fca7e.png" data-original-src="https://miro.medium.com/v2/resize:fit:536/format:webp/1*y9GuGTWQOHGGpqG5haqHRQ.png"/></div></figure><p id="f543" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">回答:</p><ul class=""><li id="1401" class="kx ky hi ih b ii ij im in iq kz iu la iy lb jc lc ld le lf bi translated">顾客A成为会员后，他/她的第一份订单是咖喱，而顾客b的订单是寿司。</li></ul><p id="264f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">7。顾客在成为会员之前购买了哪件商品？</p><p id="f287" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">基本上这是问题#6的反转。创建一个CTE</p><ul class=""><li id="d223" class="kx ky hi ih b ii ij im in iq kz iu la iy lb jc lc ld le lf bi translated">通过将customer_id除以DESC order_date来创建新的列rank，以找出客户成为成员之前的order_date</li><li id="1329" class="kx ky hi ih b ii lg im lh iq li iu lj iy lk jc lc ld le lf bi translated">在加入日期之前筛选订单日期。</li></ul><pre class="jf jg jh ji fd md me mf mg aw mh bi"><span id="0c0a" class="mi jv hi me b fi mj mk l ml mm">WITH prior_member_purchased_cte AS <br/>(<br/> SELECT s.customer_id, m.join_date, s.order_date, s.product_id,<br/>         DENSE_RANK() OVER(PARTITION BY s.customer_id<br/>         ORDER BY s.order_date DESC) AS rank<br/> FROM sales AS s<br/> JOIN members AS m<br/>  ON s.customer_id = m.customer_id<br/> WHERE s.order_date &lt; m.join_date<br/>)</span></pre><figure class="jf jg jh ji fd jj er es paragraph-image"><div class="er es mw"><img src="../Images/6f5e56cab31655100a56a1e6cd3fc906.png" data-original-src="https://miro.medium.com/v2/resize:fit:714/format:webp/1*Lbnx1wCFnasy-ZquSuZsuQ.png"/></div></figure><p id="eb30" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后，拉动表格，显示客户在成为会员之前订购的最后一件商品。</p><pre class="jf jg jh ji fd md me mf mg aw mh bi"><span id="37aa" class="mi jv hi me b fi mj mk l ml mm">SELECT s.customer_id, s.order_date, m2.product_name <br/>FROM prior_member_purchased_cte AS s<br/>JOIN menu AS m2<br/> ON s.product_id = m2.product_id<br/>WHERE rank = 1;</span></pre><figure class="jf jg jh ji fd jj er es paragraph-image"><div class="er es mx"><img src="../Images/a8056f7fa3292f31c612ba01a533f781.png" data-original-src="https://miro.medium.com/v2/resize:fit:538/format:webp/1*J1t2_USIDdgYZ3nyWAvRYg.png"/></div></figure><p id="7549" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">回答:</p><ul class=""><li id="da19" class="kx ky hi ih b ii ij im in iq kz iu la iy lb jc lc ld le lf bi translated">顾客A在成为会员之前的订单是寿司和咖喱，顾客B的订单是寿司。那一定是一顿真正美味的寿司！</li></ul><p id="00fc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> 8。每位会员在成为会员前的总物品和消费金额是多少？</strong></p><p id="c3bc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">首先，在他们的加入日期之前过滤订单日期。然后，计算唯一的product_id，并合计成为会员之前的总花费。</p><pre class="jf jg jh ji fd md me mf mg aw mh bi"><span id="145a" class="mi jv hi me b fi mj mk l ml mm">SELECT s.customer_id, COUNT(DISTINCT s.product_id) AS unique_menu_item, SUM(mm.price) AS total_sales<br/>FROM sales AS s<br/>JOIN members AS m<br/> ON s.customer_id = m.customer_id<br/>JOIN menu AS mm<br/> ON s.product_id = mm.product_id<br/>WHERE s.order_date &lt; m.join_date<br/>GROUP BY s.customer_id;</span></pre><figure class="jf jg jh ji fd jj er es paragraph-image"><div class="er es my"><img src="../Images/c7f4400e355992ac54868fae2233c416.png" data-original-src="https://miro.medium.com/v2/resize:fit:566/format:webp/1*3v9m9HzoYjVNV6UCwSXnzw.png"/></div></figure><p id="0bd5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">答:在成为会员之前，</p><ul class=""><li id="5700" class="kx ky hi ih b ii ij im in iq kz iu la iy lb jc lc ld le lf bi translated">顾客A花了25美元买了两件商品。</li><li id="84ed" class="kx ky hi ih b ii lg im lh iq li iu lj iy lk jc lc ld le lf bi translated">顾客B花了40美元买了两件东西。</li></ul><p id="413b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> 9。如果每消费1美元相当于10个积分，寿司有2倍的积分乘数——每个顾客会有多少个积分？</strong></p><p id="311a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们来分解一下这个问题。</p><ul class=""><li id="cd6a" class="kx ky hi ih b ii ij im in iq kz iu la iy lb jc lc ld le lf bi translated">每花1美元= 10分。</li><li id="e63e" class="kx ky hi ih b ii lg im lh iq li iu lj iy lk jc lc ld le lf bi translated">但是，寿司(<em class="mc"> product_id </em> 1)可以获得2倍积分，这意味着每消费1美元= 20积分</li></ul><p id="3591" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">因此，我们使用CASE WHEN来创建条件语句</p><ul class=""><li id="c8d6" class="kx ky hi ih b ii ij im in iq kz iu la iy lb jc lc ld le lf bi translated">如果<em class="mc"> product_id </em> = 1，那么每1美元的价格乘以20点</li><li id="cbd3" class="kx ky hi ih b ii lg im lh iq li iu lj iy lk jc lc ld le lf bi translated">所有其他不为1的<em class="mc"> product_id </em>，将1美元乘以10点</li></ul><p id="1c9b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">所以，你可以看到下表中有新的列，<em class="mc">分</em>。</p><pre class="jf jg jh ji fd md me mf mg aw mh bi"><span id="37a0" class="mi jv hi me b fi mj mk l ml mm">WITH price_points AS<br/> (<br/> SELECT *, <br/> CASE<br/>  WHEN product_id = 1 THEN price * 20<br/>  ELSE price * 10<br/>  END AS points<br/> FROM menu<br/> )</span></pre><figure class="jf jg jh ji fd jj er es paragraph-image"><div class="er es mz"><img src="../Images/b5b952128eaeaa822764db0d33215a38.png" data-original-src="https://miro.medium.com/v2/resize:fit:554/format:webp/1*uZlqtANVdgd2yBHYIr2OKA.png"/></div></figure><p id="f685" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用上表，我们对价格求和，将其与<em class="mc"> product_id </em>匹配，并对<em class="mc"> total_points </em>求和。</p><pre class="jf jg jh ji fd md me mf mg aw mh bi"><span id="58d0" class="mi jv hi me b fi mj mk l ml mm">SELECT s.customer_id, SUM(p.points) AS total_points<br/>FROM price_points_cte AS p<br/>JOIN sales AS s<br/> ON p.product_id = s.product_id<br/>GROUP BY s.customer_id</span></pre><figure class="jf jg jh ji fd jj er es paragraph-image"><div class="er es na"><img src="../Images/6445780038c5cdc5d9b2b46043be87a0.png" data-original-src="https://miro.medium.com/v2/resize:fit:380/format:webp/1*wo98bRP7_SNsMnfo60HhNg.png"/></div></figure><p id="9e75" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">回答:</p><ul class=""><li id="e2c8" class="kx ky hi ih b ii ij im in iq kz iu la iy lb jc lc ld le lf bi translated">客户A、B和C的总积分分别为860、940和360。</li></ul><p id="cbf1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> 10。在客户加入计划后的第一周(包括他们的加入日期),他们在所有项目上都获得了2x积分，不仅仅是寿司——客户A和B在1月底获得了多少积分？</strong></p><p id="00ab" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们再一次分解这个问题。</p><ul class=""><li id="31b8" class="kx ky hi ih b ii ij im in iq kz iu la iy lb jc lc ld le lf bi translated">找出客户的有效日期(在<em class="mc"> join_date </em>之后6天，包括join_date)和2021年1月的最后一天(“2021–01–21”)。</li></ul><pre class="jf jg jh ji fd md me mf mg aw mh bi"><span id="31e0" class="mi jv hi me b fi mj mk l ml mm">WITH dates_cte AS <br/>(<br/> SELECT *, <br/>  DATEADD(DAY, 6, join_date) AS valid_date, <br/>  EOMONTH('2021-01-31') AS last_date<br/> FROM members AS m<br/>)</span></pre><figure class="jf jg jh ji fd jj er es paragraph-image"><div class="er es nb"><img src="../Images/76a948e105c1323b995c798e50bb96ed.png" data-original-src="https://miro.medium.com/v2/resize:fit:648/format:webp/1*lyJs0LalIx9jLHkC4ce0_A.png"/></div></figure><p id="6580" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后，使用按日期和<em class="mc">产品名称</em>分配积分的情况。</p><pre class="jf jg jh ji fd md me mf mg aw mh bi"><span id="74a2" class="mi jv hi me b fi mj mk l ml mm">SELECT d.customer_id, s.order_date, d.join_date, <br/> d.valid_date, d.last_date, m.product_name, m.price,<br/> SUM(CASE<br/>  WHEN m.product_name = 'sushi' THEN 2 * 10 * m.price<br/>  WHEN s.order_date BETWEEN d.join_date AND d.valid_date THEN 2 * 10 * m.price<br/>  ELSE 10 * m.price<br/>  END) AS points<br/>FROM dates_cte AS d<br/>JOIN sales AS s<br/> ON d.customer_id = s.customer_id<br/>JOIN menu AS m<br/> ON s.product_id = m.product_id<br/>WHERE s.order_date &lt; d.last_date<br/>GROUP BY d.customer_id, s.order_date, d.join_date, d.valid_date, d.last_date, m.product_name, m.price</span></pre><figure class="jf jg jh ji fd jj er es paragraph-image"><div class="er es nc"><img src="../Images/1ed2ad3ce6efff0decc07dc56efec7b7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1116/format:webp/1*O-p7nN67x-ZLNOSvSVdIYw.png"/></div></figure><p id="1d9e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们的假设是</p><ul class=""><li id="b2db" class="kx ky hi ih b ii ij im in iq kz iu la iy lb jc lc ld le lf bi translated">从第X天到第1天(顾客成为会员(<em class="mc"> join_date </em>)，每消费1美元可获得10点积分，对于寿司，每消费1美元可获得20点积分。</li><li id="8793" class="kx ky hi ih b ii lg im lh iq li iu lj iy lk jc lc ld le lf bi translated">第1天(<em class="mc"> join_date </em>)到第7天(<em class="mc"> valid_date </em>)，所有物品每消费1美元就是20积分。</li><li id="4d6c" class="kx ky hi ih b ii lg im lh iq li iu lj iy lk jc lc ld le lf bi translated">从第8天到2021年1月的最后一天(<em class="mc"> last_date </em>)，每消费1美元可获得10点积分，寿司可获得2点积分。</li></ul><p id="c9b6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">回答:</p><ul class=""><li id="3755" class="kx ky hi ih b ii ij im in iq kz iu la iy lb jc lc ld le lf bi translated">顾客A有1370分。</li><li id="5ded" class="kx ky hi ih b ii lg im lh iq li iu lj iy lk jc lc ld le lf bi translated">客户B有820分。</li></ul></div><div class="ab cl lm ln gp lo" role="separator"><span class="lp bw bk lq lr ls"/><span class="lp bw bk lq lr ls"/><span class="lp bw bk lq lr"/></div><div class="hb hc hd he hf"><h1 id="2421" class="ju jv hi bd jw jx lt jz ka kb lu kd ke kf lv kh ki kj lw kl km kn lx kp kq kr bi translated"><strong class="ak">加分题</strong></h1><h2 id="0c0c" class="mi jv hi bd jw nd ne nf ka ng nh ni ke iq nj nk ki iu nl nm km iy nn no kq np bi translated"><strong class="ak">加入所有的东西</strong></h2><p id="26e4" class="pw-post-body-paragraph if ig hi ih b ii ks ik il im kt io ip iq ku is it iu kv iw ix iy kw ja jb jc hb bi translated"><strong class="ih hj">使用以下内容重新创建表:客户标识、订单日期、产品名称、价格、成员(Y/N) </strong></p><pre class="jf jg jh ji fd md me mf mg aw mh bi"><span id="ce3d" class="mi jv hi me b fi mj mk l ml mm">SELECT s.customer_id, s.order_date, m.product_name, m.price,<br/>CASE<br/> WHEN mm.join_date &gt; s.order_date THEN 'N'<br/> WHEN mm.join_date &lt;= s.order_date THEN 'Y'<br/> ELSE 'N'<br/> END AS member<br/>FROM sales AS s<br/>LEFT JOIN menu AS m<br/> ON s.product_id = m.product_id<br/>LEFT JOIN members AS mm<br/> ON s.customer_id = mm.customer_id;</span></pre><figure class="jf jg jh ji fd jj er es paragraph-image"><div class="er es nq"><img src="../Images/ce5eddf2fc428412e21da67e355ad5f4.png" data-original-src="https://miro.medium.com/v2/resize:fit:716/format:webp/1*SJ0JDU5yD_v1wYQifqk3bA.png"/></div></figure><h2 id="46c3" class="mi jv hi bd jw nd ne nf ka ng nh ni ke iq nj nk ki iu nl nm km iy nn no kq np bi translated">对所有的事情进行排序</h2><p id="8a3c" class="pw-post-body-paragraph if ig hi ih b ii ks ik il im kt io ip iq ku is it iu kv iw ix iy kw ja jb jc hb bi translated">Danny还需要关于客户产品的<code class="du nr ns nt me b">ranking</code>的进一步信息，但是他故意不需要非会员购买的排名，所以他希望当客户还不是忠诚度计划的一部分时，记录的值为空<code class="du nr ns nt me b">ranking</code>。</p><pre class="jf jg jh ji fd md me mf mg aw mh bi"><span id="7682" class="mi jv hi me b fi mj mk l ml mm">WITH summary_cte AS <br/>(<br/> SELECT s.customer_id, s.order_date, m.product_name, m.price,<br/>  CASE<br/>  WHEN mm.join_date &gt; s.order_date THEN 'N'<br/>  WHEN mm.join_date &lt;= s.order_date THEN 'Y'<br/>  ELSE 'N' END AS member<br/> FROM sales AS s<br/> LEFT JOIN menu AS m<br/>  ON s.product_id = m.product_id<br/> LEFT JOIN members AS mm<br/>  ON s.customer_id = mm.customer_id<br/>)</span><span id="95c4" class="mi jv hi me b fi nu mk l ml mm">SELECT *, CASE<br/> WHEN member = 'N' then NULL<br/> ELSE<br/>  RANK () OVER(PARTITION BY customer_id, member<br/>  ORDER BY order_date) END AS ranking<br/>FROM summary_cte;</span></pre><figure class="jf jg jh ji fd jj er es paragraph-image"><div class="er es nv"><img src="../Images/dab1a62868680c0ed859dd2c451f3549.png" data-original-src="https://miro.medium.com/v2/resize:fit:824/format:webp/1*KlMq6i1I367OOBEh82aY5g.png"/></div></figure></div><div class="ab cl lm ln gp lo" role="separator"><span class="lp bw bk lq lr ls"/><span class="lp bw bk lq lr ls"/><span class="lp bw bk lq lr"/></div><div class="hb hc hd he hf"><h1 id="db34" class="ju jv hi bd jw jx lt jz ka kb lu kd ke kf lv kh ki kj lw kl km kn lx kp kq kr bi translated">洞察力</h1><p id="16e0" class="pw-post-body-paragraph if ig hi ih b ii ks ik il im kt io ip iq ku is it iu kv iw ix iy kw ja jb jc hb bi translated">从分析中，我们发现了一些有趣的见解，对丹尼肯定有用。</p><ul class=""><li id="2d85" class="kx ky hi ih b ii ij im in iq kz iu la iy lb jc lc ld le lf bi translated">客户B是最频繁的访问者，在2021年1月访问了6次。</li><li id="496a" class="kx ky hi ih b ii lg im lh iq li iu lj iy lk jc lc ld le lf bi translated">丹尼餐馆最受欢迎的食物是拉面，其次是咖喱和寿司。</li><li id="fb2f" class="kx ky hi ih b ii lg im lh iq li iu lj iy lk jc lc ld le lf bi translated">顾客A和C喜欢拉面，而顾客B似乎同样喜欢寿司、咖喱和拉面。谁知道呢，我可能是客户B！</li><li id="a9da" class="kx ky hi ih b ii lg im lh iq li iu lj iy lk jc lc ld le lf bi translated">顾客A是丹尼餐馆的第一位成员，他点的第一份菜是咖喱。必须满足他对咖喱的渴望！</li><li id="4840" class="kx ky hi ih b ii lg im lh iq li iu lj iy lk jc lc ld le lf bi translated">顾客A和B在成为会员前最后点的菜是寿司和咖喱。是不是说这两项都是决定性因素？他们报名成为会员一定是真的好吃！</li><li id="9d72" class="kx ky hi ih b ii lg im lh iq li iu lj iy lk jc lc ld le lf bi translated">在成为会员之前，顾客A和B分别消费了25美元和40美元。</li><li id="8160" class="kx ky hi ih b ii lg im lh iq li iu lj iy lk jc lc ld le lf bi translated">在整个2021年1月，客户A的积分为860，客户B为940，客户C为360。</li><li id="c2e5" class="kx ky hi ih b ii lg im lh iq li iu lj iy lk jc lc ld le lf bi translated">假设会员从成为会员的那一天起每周可以获得2x积分奖励寿司，到2021年1月底，客户A有660个积分，客户B有340个积分。</li></ul></div><div class="ab cl lm ln gp lo" role="separator"><span class="lp bw bk lq lr ls"/><span class="lp bw bk lq lr ls"/><span class="lp bw bk lq lr"/></div><div class="hb hc hd he hf"><p id="c98b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">谢谢大家！</p><p id="1b92" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在轮到你分享一些我的分析和1(或更多)的趣事了！)需要改进的地方。</p><p id="f748" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">干杯！(我渴望寿司和拉面现在:D)</p></div></div>    
</body>
</html>