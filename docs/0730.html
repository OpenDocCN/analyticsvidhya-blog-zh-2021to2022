<html>
<head>
<title>Building an Image Classifier Using Keras</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Keras构建图像分类器</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/building-an-image-classifier-using-keras-70f3be2ac44c?source=collection_archive---------14-----------------------#2021-01-28">https://medium.com/analytics-vidhya/building-an-image-classifier-using-keras-70f3be2ac44c?source=collection_archive---------14-----------------------#2021-01-28</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="6616" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">机器学习(ML)是一项颠覆性技术，席卷了整个世界。它是计算机在观察一些给定数据后学习做出预测的过程。仅举几个例子，它被用于计算机视觉、自然语言处理和股票价格预测。ML的领域非常广阔，而且只会越来越大。为了演示这种技术的一种用途，本文将讨论如何对复仇者联盟(即黑寡妇、钢铁侠、美国队长、绿巨人和雷神)的图片进行分类。</p><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="ji jj di jk bf jl"><div class="er es jc"><img src="../Images/b7b4e4934145ee33e399dc7400ad914c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*WXOTqlUMkQhMDDrE.jpg"/></div></div><figcaption class="jo jp et er es jq jr bd b be z dx translated">图片来源:谷歌</figcaption></figure><p id="dd86" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">首先，我们必须为我们的模型收集一些数据。为此，我们将从互联网上收集图片。我们将使用bing-image-downloader刮刀工具。要安装它，使用以下命令(所有代码都用Python 3编写) :</p><pre class="jd je jf jg fd js jt ju jv aw jw bi"><span id="50c5" class="jx jy hh jt b fi jz ka l kb kc">pip install bing-image-downloader</span></pre><p id="3c1d" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">然后导入库:</p><pre class="jd je jf jg fd js jt ju jv aw jw bi"><span id="92e8" class="jx jy hh jt b fi jz ka l kb kc">from bing_image_downloader import downloader</span></pre><p id="530b" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我们的数据中有五个职业，即黑寡妇、钢铁侠、美国队长、绿巨人和雷神。我们将下载每个班级的200张图片。</p><pre class="jd je jf jg fd js jt ju jv aw jw bi"><span id="79d3" class="jx jy hh jt b fi jz ka l kb kc">downloader.download('Iron Man MCU', limit = 200, output = 'datasets/Marvel Heroes/train', adult_filter_off = False, force_replace = False, timeout = 60)</span></pre><p id="bb98" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我们可以按照上面的代码，替换英雄名字，得到不同的图像。</p><p id="80bb" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">现在我们有了图像，我们将把图像分成三组:训练(85 %的数据)、验证(10 %的数据)和测试(5 %的数据)。</p><pre class="jd je jf jg fd js jt ju jv aw jw bi"><span id="d030" class="jx jy hh jt b fi jz ka l kb kc">train_dir = 'datasets/Marvel Heroes/train/'<br/>validation_dir = 'datasets/Marvel Heroes/validation/'<br/>test_dir = 'datasets/Marvel Heroes/test/'</span></pre><p id="ba30" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">训练集将用于训练我们的数据，验证集将用于指导测量我们的模型在训练期间的性能。最后，我们将输入看不见的图像，即测试集，看看我们的模型表现如何。下载的图像存储在。jpg格式，并遵循命名约定image_ <number> .jpg。我们创建各自的目录如下:</number></p><pre class="jd je jf jg fd js jt ju jv aw jw bi"><span id="102f" class="jx jy hh jt b fi jz ka l kb kc">import os<br/>import random #for splitting the data randomly<br/>classes = os.listdir('datasets/Marvel Heroes/train/')</span><span id="562c" class="jx jy hh jt b fi kd ka l kb kc">for hero in classes:<br/>   j=0<br/>   for i in random.randint(0,200):<br/>       os.replace(train_dir + 'image_' + i + '.jpg', validation_dir + 'image_' + i + '.jpg')<br/>       j=j+1<br/>       if(j==20): #10 % of the images<br/>          break</span><span id="3c9c" class="jx jy hh jt b fi kd ka l kb kc">for hero in classes:<br/>   j=0<br/>   for i in random.randint(0,200):<br/>       os.replace(train_dir + 'image_' + i + '.jpg', test_dir + 'image_' + i + '.jpg')<br/>       j=j+1<br/>       if(j==10): #5 % of the images<br/>          break</span></pre><p id="99a6" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在这一步之后，我们将开始对我们的数据建模。为了节省时间，我们将使用一种叫做迁移学习的技术。这是一种技术，我们利用预训练机器学习模型的学习，并将其用于我们的目的。这是计算机视觉领域的常用技术。我们将在Tensorflow之上使用Keras来完成这个任务。Keras是一个漂亮的API，在机器学习社区中被大量使用。我们将使用的预训练模型是ResNet50。</p><pre class="jd je jf jg fd js jt ju jv aw jw bi"><span id="2c3e" class="jx jy hh jt b fi jz ka l kb kc">from tensorflow.keras.layers import Dense<br/>from tensorflow.keras.models import Sequential<br/>from tensorflow.keras.applications.resnet50 import preprocess_input<br/>from tensorflow.keras.applications import RestNet50</span></pre><p id="66f4" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">让我们创建我们的模型:</p><pre class="jd je jf jg fd js jt ju jv aw jw bi"><span id="9420" class="jx jy hh jt b fi jz ka l kb kc">num_classes = 5<br/>model = Sequential()<br/>model.add(ResNet50(include_top = False, pooling='avg', weights = 'imagenet'))<br/>model.add(Dense(num_classes, activation = 'softmax'))<br/>model.layers[0].trainable=False <br/>#Don't train the top layer as this is we where will add our own classes </span></pre><p id="e7af" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我们可以看看我们的模型参数。</p><pre class="jd je jf jg fd js jt ju jv aw jw bi"><span id="0b87" class="jx jy hh jt b fi jz ka l kb kc">model.summary()</span></pre><p id="536c" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">它将给出以下输出:</p><pre class="jd je jf jg fd js jt ju jv aw jw bi"><span id="6a30" class="jx jy hh jt b fi jz ka l kb kc">Model: "sequential_1"<br/>_________________________________________________________________<br/>Layer (type)                 Output Shape              Param #   <br/>=================================================================<br/>resnet50 (Functional)        (None, 2048)              23587712  <br/>_________________________________________________________________<br/>dense (Dense)                (None, 5)                 10245     <br/>=================================================================<br/>Total params: 23,597,957<br/>Trainable params: 10,245<br/>Non-trainable params: 23,587,712<br/>_________________________________________________________________</span></pre><p id="b084" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我们现在将使用Adam优化器编译我们的模型，使用分类交叉熵计算损失，并使用准确性度量。</p><pre class="jd je jf jg fd js jt ju jv aw jw bi"><span id="6514" class="jx jy hh jt b fi jz ka l kb kc">model.compile(optimizer='adam',loss='categorical_crossentropy',metrics=['accuracy'])</span></pre><p id="e73c" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我们已经完成了模型的创建。现在我们必须输入模型数据。为此，我们将使用ImageDataGenerator，它也将帮助我们增加数据(向图像添加像水平翻转和旋转这样的噪声)。</p><pre class="jd je jf jg fd js jt ju jv aw jw bi"><span id="9c4b" class="jx jy hh jt b fi jz ka l kb kc">from tensorflow.keras.preprocessing.image import ImageDataGenerator</span><span id="0029" class="jx jy hh jt b fi kd ka l kb kc">train_datagen = ImageDataGenerator(preprocessing_function = preprocess_input, horizontal_flip = True, width_shift_range = 0.2 ,height_shift_range = 0.2)<br/>)<br/>val_datagen=ImageDataGenerator(preprocessing_function = preprocess_input)</span><span id="099a" class="jx jy hh jt b fi kd ka l kb kc">train_generator = train_datagen.flow_from_directory(train_dir, target_size=(224,224), batch_size=32, class_mode='categorical')</span><span id="98e9" class="jx jy hh jt b fi kd ka l kb kc">validation_generator = val_datagen.flow_from_directory( validation_dir, target_size=(224,224), batch_size=5, class_mode='categorical')</span></pre><p id="4bbf" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">它将生成以下输出:</p><pre class="jd je jf jg fd js jt ju jv aw jw bi"><span id="5a2b" class="jx jy hh jt b fi jz ka l kb kc">Found 850 images belonging to 5 classes.<br/>Found 100 images belonging to 5 classes.</span></pre><p id="a3ec" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">让我们安装模型。</p><pre class="jd je jf jg fd js jt ju jv aw jw bi"><span id="bc68" class="jx jy hh jt b fi jz ka l kb kc">history = model.fit(train_generator, epochs = 5, validation_data = validation_generator, verbose = 1)</span></pre><p id="fba0" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">该模型将生成类似于以下内容的输出(可能不相同):</p><pre class="jd je jf jg fd js jt ju jv aw jw bi"><span id="6d0a" class="jx jy hh jt b fi jz ka l kb kc">Epoch 1/5<br/>25/25 [==============================] - 322s 13s/step - loss: 1.7210 - accuracy: 0.3485 - val_loss: 0.7263 - val_accuracy: 0.7222<br/>Epoch 2/5<br/>25/25 [==============================] - 185s 7s/step - loss: 0.6220 - accuracy: 0.7889 - val_loss: 0.5590 - val_accuracy: 0.8000<br/>Epoch 3/5<br/>25/25 [==============================] - 177s 7s/step - loss: 0.4306 - accuracy: 0.8484 - val_loss: 0.4328 - val_accuracy: 0.8556<br/>Epoch 4/5<br/>25/25 [==============================] - 172s 7s/step - loss: 0.2794 - accuracy: 0.9271 - val_loss: 0.3850 - val_accuracy: 0.8667<br/>Epoch 5/5<br/>25/25 [==============================] - 167s 7s/step - loss: 0.2736 - accuracy: 0.9281 - val_loss: 0.3570 - val_accuracy: 0.8778</span></pre><p id="82c1" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">瞧啊。看起来我们在验证集上获得了大约88 %的准确率，在训练集上获得了大约93 %的准确率。还不错！让我们画出我们的结果。</p><pre class="jd je jf jg fd js jt ju jv aw jw bi"><span id="77d4" class="jx jy hh jt b fi jz ka l kb kc">import matplotlib.pyplot as plt<br/>acc = history.history['accuracy']<br/>val_acc = history.history['val_accuracy']</span><span id="8513" class="jx jy hh jt b fi kd ka l kb kc">loss = history.history['loss']<br/>val_loss = history.history['val_loss']</span><span id="6f8b" class="jx jy hh jt b fi kd ka l kb kc">epochs = range(len(acc))</span><span id="2320" class="jx jy hh jt b fi kd ka l kb kc">plt.plot(epochs, acc)<br/>plt.plot(epochs, val_acc)<br/>plt.title('Training and validation accuracy')<br/>plt.legend(['Train','Val'])<br/>plt.figure() #Train accuracy</span><span id="c069" class="jx jy hh jt b fi kd ka l kb kc">plt.plot(epochs, loss)<br/>plt.plot(epochs, val_loss)<br/>plt.title('Training and validation loss')<br/>plt.legend(['Train','Val']) #Train Loss</span></pre><p id="e7aa" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">它将生成以下图:</p><figure class="jd je jf jg fd jh er es paragraph-image"><div class="er es ke"><img src="../Images/72e015129b51ed655cf796f83d67a8bd.png" data-original-src="https://miro.medium.com/v2/resize:fit:796/format:webp/1*_QWytZ85F_dOdUYYukbT4Q.jpeg"/></div><figcaption class="jo jp et er es jq jr bd b be z dx translated">情节</figcaption></figure><p id="f9b2" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我们可以按如下方式保存模型:</p><pre class="jd je jf jg fd js jt ju jv aw jw bi"><span id="e3f2" class="jx jy hh jt b fi jz ka l kb kc">model.save('/Created Models/')</span></pre><p id="3675" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">现在来做一些预测吧。导入下列库。</p><pre class="jd je jf jg fd js jt ju jv aw jw bi"><span id="a600" class="jx jy hh jt b fi jz ka l kb kc">from keras.preprocessing.image import load_img<br/>from keras.preprocessing.image import img_to_array<br/>from keras.preprocessing.image import array_to_img</span></pre><p id="7c23" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">现在来预测一下。</p><pre class="jd je jf jg fd js jt ju jv aw jw bi"><span id="9a5a" class="jx jy hh jt b fi jz ka l kb kc">for im in os.listdir(test_dir):<br/>      image = load_img(os.path.join(test_dir,im),target_size=(224,224))<br/>      input_arr = img_to_array(image)<br/>      input_arr = np.expand_dims(input_arr,axis=0)<br/>      input_arr = preprocess_input(input_arr)<br/>      pred = model.predict(input_arr)<br/>      maxPosition = np.argmax(pred)<br/>      pred_label = classes[maxPosition]<br/>      display(image)<br/>      print(pred_label)<br/>      print()<br/>      print()</span></pre><p id="e0e0" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">一些预测如下:</p><figure class="jd je jf jg fd jh er es paragraph-image"><div class="er es kf"><img src="../Images/9ddad998e220a4984a7c17569a07fc99.png" data-original-src="https://miro.medium.com/v2/resize:fit:1392/format:webp/1*3tMl86BCaQnxvHFtbLJJFA.jpeg"/></div><figcaption class="jo jp et er es jq jr bd b be z dx translated">一些测试集。</figcaption></figure><p id="c167" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">文章到此结束。希望你喜欢。回头见！</p></div></div>    
</body>
</html>