<html>
<head>
<title>Multi-cloud Terraform remote state</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">多云平台远程状态</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/multicloud-terraform-states-b8686de20d60?source=collection_archive---------11-----------------------#2021-07-15">https://medium.com/analytics-vidhya/multicloud-terraform-states-b8686de20d60?source=collection_archive---------11-----------------------#2021-07-15</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><figure class="ev ex if ig ih ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es ie"><img src="../Images/1f9bc16bd7cb4dbbf92ac10d2d9e282f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZIWgxG7J02RfLYUL8_7orA.png"/></div></div></figure><h1 id="7a3c" class="ip iq hh bd ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm bi translated">概观</h1><p id="1f29" class="pw-post-body-paragraph jn jo hh jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ha bi translated">在Terraform中，状态文件用于跟踪基础设施的当前状态。如果您在团队中工作，使用本地状态文件会使Terraform的使用变得困难，因为每个用户都必须确保在运行Terraform之前拥有最新的状态数据，并确保没有其他人同时运行Terraform。因此，将状态文件存储在一个共享位置非常重要，这样团队就可以轻松地将文件放入和放入。这就是远程状态变得重要的地方。远程状态允许Terraform将状态文件存储在:</p><ul class=""><li id="c153" class="km kn hh jp b jq ko ju kp jy kq kc kr kg ks kk kt ku kv kw bi translated">AWS S3</li><li id="2165" class="km kn hh jp b jq kx ju ky jy kz kc la kg lb kk kt ku kv kw bi translated">DynamoDB</li><li id="d99a" class="km kn hh jp b jq kx ju ky jy kz kc la kg lb kk kt ku kv kw bi translated">开源代码库</li><li id="d16e" class="km kn hh jp b jq kx ju ky jy kz kc la kg lb kk kt ku kv kw bi translated">Azure存储帐户</li><li id="f5d8" class="km kn hh jp b jq kx ju ky jy kz kc la kg lb kk kt ku kv kw bi translated">Google存储帐户</li></ul><p id="c94b" class="pw-post-body-paragraph jn jo hh jp b jq ko js jt ju kp jw jx jy lc ka kb kc ld ke kf kg le ki kj kk ha bi translated"><strong class="jp hi">注意:</strong>就我个人而言，我不推荐使用Github进行远程状态，问题是你不想在每次部署后都进行修改，因为你可能还在构建环境。此外，您可能不希望在某人发布或执行部署后进行拉动或调整，因为您可能正在处理不同的组件。</p><p id="40cb" class="pw-post-body-paragraph jn jo hh jp b jq ko js jt ju kp jw jx jy lc ka kb kc ld ke kf kg le ki kj kk ha bi translated">对象存储是存储Terraform远程状态的最佳和推荐方法。我已经用了几年了，从来没有任何问题。它与CICD没有任何问题。</p><h1 id="bbd6" class="ip iq hh bd ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm bi translated">多云远程状态？</h1><p id="df85" class="pw-post-body-paragraph jn jo hh jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ha bi translated">在多云环境下，如何设计Terraform远程状态的布局？</p><p id="63bd" class="pw-post-body-paragraph jn jo hh jp b jq ko js jt ju kp jw jx jy lc ka kb kc ld ke kf kg le ki kj kk ha bi translated">三个选项:</p><ul class=""><li id="2b2c" class="km kn hh jp b jq ko ju kp jy kq kc kr kg ks kk kt ku kv kw bi translated">管理地形云中的状态。</li><li id="ffdb" class="km kn hh jp b jq kx ju ky jy kz kc la kg lb kk kt ku kv kw bi translated">将远程状态整合到一个云提供商。</li><li id="623e" class="km kn hh jp b jq kx ju ky jy kz kc la kg lb kk kt ku kv kw bi translated">管理每个云提供商的状态。</li></ul><p id="e035" class="pw-post-body-paragraph jn jo hh jp b jq ko js jt ju kp jw jx jy lc ka kb kc ld ke kf kg le ki kj kk ha bi translated"><strong class="jp hi">管理地形云中的状态:</strong></p><p id="42cd" class="pw-post-body-paragraph jn jo hh jp b jq ko js jt ju kp jw jx jy lc ka kb kc ld ke kf kg le ki kj kk ha bi translated">我还没有机会工作在Terraform云，但这应该工作得很好。</p><p id="ea04" class="pw-post-body-paragraph jn jo hh jp b jq ko js jt ju kp jw jx jy lc ka kb kc ld ke kf kg le ki kj kk ha bi translated"><strong class="jp hi">将远程状态整合到一个云提供商:</strong></p><p id="e9af" class="pw-post-body-paragraph jn jo hh jp b jq ko js jt ju kp jw jx jy lc ka kb kc ld ke kf kg le ki kj kk ha bi translated">在谷歌存储或S3中创建一个存储帐户，并存储所有terraform状态文件。这种方法的问题是，部署在AWS中的用户可能没有权限访问Google Storage，或者部署AWS的用户可能没有权限访问Azure Storage。随着组织的发展，将会有不同的团队管理不同的云提供商。所以，要做长远打算。</p><p id="b15a" class="pw-post-body-paragraph jn jo hh jp b jq ko js jt ju kp jw jx jy lc ka kb kc ld ke kf kg le ki kj kk ha bi translated"><strong class="jp hi">管理每个云提供商的状态:</strong></p><p id="976a" class="pw-post-body-paragraph jn jo hh jp b jq ko js jt ju kp jw jx jy lc ka kb kc ld ke kf kg le ki kj kk ha bi translated">这很简单。为每个云提供商创建存储。</p><ul class=""><li id="198e" class="km kn hh jp b jq ko ju kp jy kq kc kr kg ks kk kt ku kv kw bi translated">谷歌部署到谷歌存储。</li><li id="96ee" class="km kn hh jp b jq kx ju ky jy kz kc la kg lb kk kt ku kv kw bi translated">AWS部署到S3。</li><li id="97ff" class="km kn hh jp b jq kx ju ky jy kz kc la kg lb kk kt ku kv kw bi translated">Azure部署到Azure存储。</li></ul><h2 id="bea4" class="lf iq hh bd ir lg lh li iv lj lk ll iz jy lm ln jd kc lo lp jh kg lq lr jl ls bi translated">注意:</h2><ul class=""><li id="09b1" class="km kn hh jp b jq jr ju jv jy lt kc lu kg lv kk kt ku kv kw bi translated">为生产和非生产环境创建单独的存储桶。</li><li id="d3c8" class="km kn hh jp b jq kx ju ky jy kz kc la kg lb kk kt ku kv kw bi translated">确保存储桶版本化。</li></ul><h1 id="1642" class="ip iq hh bd ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm bi translated">首次展示</h1><p id="b0a0" class="pw-post-body-paragraph jn jo hh jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ha bi translated">我创建了一个python包来管理多云环境中的远程状态<strong class="jp hi">。</strong>阅读更多关于<a class="ae lw" href="https://github.com/tomarv2/tfremote" rel="noopener ugc nofollow" target="_blank"> <strong class="jp hi"> tf </strong> </a> <strong class="jp hi">。<em class="kl"> tf </em> </strong>是一个python包，用于管理GCP、AWS和Azure的Terraform远程状态。</p><p id="b484" class="pw-post-body-paragraph jn jo hh jp b jq ko js jt ju kp jw jx jy lc ka kb kc ld ke kf kg le ki kj kk ha bi translated"><code class="du lx ly lz ma b"><strong class="jp hi">pip install tfremote --upgrade</strong></code></p><p id="5819" class="pw-post-body-paragraph jn jo hh jp b jq ko js jt ju kp jw jx jy lc ka kb kc ld ke kf kg le ki kj kk ha bi translated">根据云提供商，设置以下环境变量:</p><h2 id="cd1a" class="lf iq hh bd ir lg lh li iv lj lk ll iz jy lm ln jd kc lo lp jh kg lq lr jl ls bi translated">AWS:</h2><pre class="mb mc md me fd mf ma mg mh aw mi bi"><span id="32c1" class="lf iq hh ma b fi mj mk l ml mm">export TF_AWS_BUCKET=&lt;remote_state_bucket_name&gt;<br/>export TF_AWS_PROFILE=default<br/>export TF_AWS_BUCKET_REGION=us-west-2</span></pre><h2 id="bc53" class="lf iq hh bd ir lg lh li iv lj lk ll iz jy lm ln jd kc lo lp jh kg lq lr jl ls bi translated">天蓝色:</h2><pre class="mb mc md me fd mf ma mg mh aw mi bi"><span id="af05" class="lf iq hh ma b fi mj mk l ml mm">export TF_AZURE_STORAGE_ACCOUNT=&lt;storage_account_name&gt;<br/>export TF_AZURE_CONTAINER=&lt;storage_container_name&gt;<br/>ARM_ACCESS_KEY=&lt;storage_access_key&gt;</span></pre><h2 id="d56d" class="lf iq hh bd ir lg lh li iv lj lk ll iz jy lm ln jd kc lo lp jh kg lq lr jl ls bi translated">GCP:</h2><pre class="mb mc md me fd mf ma mg mh aw mi bi"><span id="43f6" class="lf iq hh ma b fi mj mk l ml mm">export TF_GCLOUD_BUCKET=&lt;storage_bucket_name&gt;<br/>export TF_GCLOUD_CREDENTIALS=&lt;service_account.json&gt;</span></pre><p id="c6f8" class="pw-post-body-paragraph jn jo hh jp b jq ko js jt ju kp jw jx jy lc ka kb kc ld ke kf kg le ki kj kk ha bi translated">要查看可用选项，请运行<code class="du lx ly lz ma b">tf --help</code></p><figure class="mb mc md me fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es mn"><img src="../Images/976b958316ea24de5735cc551972bdb1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jGBN5loyeLcuVyL3o_bNWw.png"/></div></div></figure><p id="a570" class="pw-post-body-paragraph jn jo hh jp b jq ko js jt ju kp jw jx jy lc ka kb kc ld ke kf kg le ki kj kk ha bi translated">部署在谷歌云中。设置以下环境变量:</p><pre class="mb mc md me fd mf ma mg mh aw mi bi"><span id="fcf4" class="lf iq hh ma b fi mj mk l ml mm">export TF_GCLOUD_BUCKET= &lt;remote state bucket&gt;<br/>export TF_GCLOUD_CREDENTIALS= &lt;Path to google service account file&gt;</span></pre><p id="ad19" class="pw-post-body-paragraph jn jo hh jp b jq ko js jt ju kp jw jx jy lc ka kb kc ld ke kf kg le ki kj kk ha bi translated">为团队<strong class="jp hi"> demo-team </strong>项目<strong class="jp hi"> demo-app </strong>部署在工作区<strong class="jp hi"> demo-workspace: </strong></p><pre class="mb mc md me fd mf ma mg mh aw mi bi"><span id="779c" class="lf iq hh ma b fi mj mk l ml mm">tf -c=gcloud apply -var='teamid=<strong class="ma hi">demo-team</strong>' -var='prjid=<strong class="ma hi">demo-app</strong>' -w=<strong class="ma hi">demo-workspace</strong>'</span></pre><p id="f297" class="pw-post-body-paragraph jn jo hh jp b jq ko js jt ju kp jw jx jy lc ka kb kc ld ke kf kg le ki kj kk ha bi translated">当您进行部署时，它将在Google云存储中创建一个结构，名为<strong class="jp hi">Google bucket-&gt;demo-team-&gt;demo-app-&gt;demo-workspace。</strong></p><p id="06cb" class="pw-post-body-paragraph jn jo hh jp b jq ko js jt ju kp jw jx jy lc ka kb kc ld ke kf kg le ki kj kk ha bi translated">注意:如果没有提供<code class="du lx ly lz ma b">-w</code>，所有的部署都将转到<code class="du lx ly lz ma b">default </code>工作区。</p><figure class="mb mc md me fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es mo"><img src="../Images/95b7f67eaffb0b7f60ccac1341d15752.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5YfUCfyCdsvQeHrmlnIqxg.png"/></div></div></figure><h2 id="c6bd" class="lf iq hh bd ir lg lh li iv lj lk ll iz jy lm ln jd kc lo lp jh kg lq lr jl ls bi translated">AWS中的结构:</h2><ul class=""><li id="407c" class="km kn hh jp b jq jr ju jv jy lt kc lu kg lv kk kt ku kv kw bi translated"><strong class="jp hi">demo-team-&gt;demo-app-&gt;demo-workspace-&gt;demo-state-key . TF state</strong></li></ul><figure class="mb mc md me fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es mp"><img src="../Images/3385c509af5d2d918556e19c4ac7ee4a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KJgvQ4ZCrIztx0F85h7bzw.png"/></div></div></figure><p id="16b2" class="pw-post-body-paragraph jn jo hh jp b jq ko js jt ju kp jw jx jy lc ka kb kc ld ke kf kg le ki kj kk ha bi translated"><strong class="jp hi">注意:</strong>默认情况下，tfstate文件被命名为terraform.tfstate。如果您想要指定自定义名称，请使用<code class="du lx ly lz ma b">-s</code>标志。在工作区<strong class="jp hi">演示工作区:</strong>为团队<strong class="jp hi">演示团队</strong>项目<strong class="jp hi">演示应用</strong>部署</p><pre class="mb mc md me fd mf ma mg mh aw mi bi"><span id="a450" class="lf iq hh ma b fi mj mk l ml mm">tf -c=aws apply -var='teamid=<strong class="ma hi">demo-team</strong>' -var='prjid=<strong class="ma hi">demo-app</strong>' -w=<strong class="ma hi">demo-workspace</strong>' -s=<strong class="ma hi">demo-state</strong></span></pre><h2 id="09ff" class="lf iq hh bd ir lg lh li iv lj lk ll iz jy lm ln jd kc lo lp jh kg lq lr jl ls bi translated">Azure中的结构:</h2><ul class=""><li id="240b" class="km kn hh jp b jq jr ju jv jy lt kc lu kg lv kk kt ku kv kw bi translated"><strong class="jp hi">foo-team-&gt;bar-app-&gt;demo-workspace-&gt;tryme _ key . TF state</strong></li></ul><figure class="mb mc md me fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es mq"><img src="../Images/00ac5ffb19dc2c713e96d0f2bdd1d146.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CWKMccLqNl3HT5hWXl6--g.png"/></div></div></figure><h2 id="231d" class="lf iq hh bd ir lg lh li iv lj lk ll iz jy lm ln jd kc lo lp jh kg lq lr jl ls bi translated">github:<a class="ae lw" href="https://github.com/tomarv2/tfremote" rel="noopener ugc nofollow" target="_blank">T25】https://github.com/tomarv2/tfremoteT27】</a></h2></div></div>    
</body>
</html>