<html>
<head>
<title>Migrate Kubernetes from Docker to Containerd</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">将Kubernetes从Docker迁移到Containerd</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/migrate-kubernetes-from-docker-to-containerd-2fba80779280?source=collection_archive---------4-----------------------#2021-05-03">https://medium.com/analytics-vidhya/migrate-kubernetes-from-docker-to-containerd-2fba80779280?source=collection_archive---------4-----------------------#2021-05-03</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/b4c75e330d0a4bb0076093b9d24ccd89.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*c5XF6kThbwT7uvPt2b7xKw.jpeg"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">由<a class="ae iu" href="https://unsplash.com/@ventiviews?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">卡梅伦·文蒂</a>在<a class="ae iu" href="https://unsplash.com/s/photos/shipping-container?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><p id="35e3" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">正如大多数人可能知道的，Kubernetes决定在<strong class="ix hj"> v1.20 </strong>之后不再使用Docker作为容器运行时</p><p id="907c" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">关于Kubernetes为什么决定弃用Docker的解释可以在这里找到:<a class="ae iu" href="https://kubernetes.io/blog/2020/12/02/dont-panic-kubernetes-and-docker/" rel="noopener ugc nofollow" target="_blank">https://Kubernetes . io/blog/2020/12/02/don-panic-Kubernetes-and-Docker/</a></p><p id="459c" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这对我们终端用户来说意味着，无论如何，我们都必须迁移到另一个容器运行时。有几个容器运行时接口，但可能众所周知的有:</p><ul class=""><li id="6b0d" class="jt ju hi ix b iy iz jc jd jg jv jk jw jo jx js jy jz ka kb bi translated"><a class="ae iu" href="https://github.com/containerd" rel="noopener ugc nofollow" target="_blank">集装箱</a></li><li id="6004" class="jt ju hi ix b iy kc jc kd jg ke jk kf jo kg js jy jz ka kb bi translated"><a class="ae iu" href="https://cri-o.io/" rel="noopener ugc nofollow" target="_blank"> cri-o </a></li></ul><p id="129a" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在本文中，我们将把Kubernetes集群从Docker迁移到Containerd。这些更改将应用到群集中的所有节点。我建议从<code class="du kh ki kj kk b">worker</code>节点开始迁移。</p></div><div class="ab cl kl km gp kn" role="separator"><span class="ko bw bk kp kq kr"/><span class="ko bw bk kp kq kr"/><span class="ko bw bk kp kq"/></div><div class="hb hc hd he hf"><p id="63de" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我将迁移我的操场集群，它有3个主节点和3个工作节点，运行时使用Docker</p><pre class="ks kt ku kv fd kw kk kx ky aw kz bi"><span id="5e32" class="la lb hi kk b fi lc ld l le lf">NAME           STATUS   ROLES                  AGE   VERSION   INTERNAL-IP    EXTERNAL-IP   OS-IMAGE             KERNEL-VERSION     CONTAINER-RUNTIME<br/>k8s-master-1   Ready    control-plane,master   xxd   v1.20.6   xxx.xxx.x.xx   &lt;none&gt;        Ubuntu 20.04.x LTS   x.x.x-xx-generic   docker://19.03.6<br/>k8s-master-2   Ready    control-plane,master   xxd   v1.20.6   xxx.xxx.x.xx   &lt;none&gt;        Ubuntu 20.04.x LTS   x.x.x-xx-generic   docker://19.03.6<br/>k8s-master-3   Ready    control-plane,master   xxd   v1.20.6   xxx.xxx.x.xx   &lt;none&gt;        Ubuntu 20.04.x LTS   x.x.x-xx-generic   docker://19.03.6<br/>k8s-worker-1   Ready    worker                 xxd   v1.20.6   xxx.xxx.x.xx   &lt;none&gt;        Ubuntu 20.04.x LTS   x.x.x-xx-generic   docker://19.03.6<br/>k8s-worker-2   Ready    worker                 xxd   v1.20.6   xxx.xxx.x.xx   &lt;none&gt;        Ubuntu 20.04.x LTS   x.x.x-xx-generic   docker://19.03.6<br/>k8s-worker-3   Ready    worker                 xxd   v1.20.6   xxx.xxx.x.xx   &lt;none&gt;        Ubuntu 20.04.x LTS   x.x.x-xx-generic   docker://19.03.6</span></pre><h1 id="7e22" class="lg lb hi bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">准备节点</h1><p id="968d" class="pw-post-body-paragraph iv iw hi ix b iy md ja jb jc me je jf jg mf ji jj jk mg jm jn jo mh jq jr js hb bi translated">首先，必须禁用调度，并且必须清除所有不必要的工作负载，守护进程集除外。</p><p id="9428" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">从封锁节点开始</p><pre class="ks kt ku kv fd kw kk kx ky aw kz bi"><span id="4045" class="la lb hi kk b fi lc ld l le lf">kubectl cordon k8s-worker-3<br/>node/k8s-worker-3 cordoned</span></pre><p id="aa1f" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">漏极节点</p><pre class="ks kt ku kv fd kw kk kx ky aw kz bi"><span id="b254" class="la lb hi kk b fi lc ld l le lf">kubectl drain k8s-worker-3 --ignore-daemonsets --delete-emptydir-data<br/>node/k8s-worker-3 already cordoned<br/>&lt;...&gt;<br/>node/k8s-worker-3 evicted</span></pre><p id="0fb2" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">阻止库伯莱特和多克</p><pre class="ks kt ku kv fd kw kk kx ky aw kz bi"><span id="f233" class="la lb hi kk b fi lc ld l le lf">systemctl stop kubelet<br/>systemctl stop docker</span></pre><h1 id="bad3" class="lg lb hi bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">切换到容器d</h1><p id="ce72" class="pw-post-body-paragraph iv iw hi ix b iy md ja jb jc me je jf jg mf ji jj jk mg jm jn jo mh jq jr js hb bi translated">节点已准备好迁移到containerd。从移除docker开始，因为不再需要它了</p><pre class="ks kt ku kv fd kw kk kx ky aw kz bi"><span id="a5e5" class="la lb hi kk b fi lc ld l le lf">apt purge docker-ce docker-ce-cli</span></pre><p id="4482" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">确保安装了<code class="du kh ki kj kk b">containerd</code>:</p><pre class="ks kt ku kv fd kw kk kx ky aw kz bi"><span id="b270" class="la lb hi kk b fi lc ld l le lf">ctr -n moby container list</span></pre><p id="3916" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">确保<code class="du kh ki kj kk b">/etc/containerd/config.toml</code>中容器id的配置文件存在。您可以通过以下方式生成它</p><pre class="ks kt ku kv fd kw kk kx ky aw kz bi"><span id="0b9a" class="la lb hi kk b fi lc ld l le lf">sudo mkdir -p /etc/containerd<br/>containerd config default | sudo tee /etc/containerd/config.toml</span></pre><p id="d528" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">如果使用systemd作为cgroup驱动程序，必须在<code class="du kh ki kj kk b">containerd</code> config中进行配置。在<code class="du kh ki kj kk b">/etc/containerd/config.toml</code>添加</p><pre class="ks kt ku kv fd kw kk kx ky aw kz bi"><span id="ea13" class="la lb hi kk b fi lc ld l le lf">&lt;...&gt;<br/>[plugins."io.containerd.grpc.v1.cri".containerd.runtimes.runc]<br/>  &lt;...&gt;<br/>  [plugins."io.containerd.grpc.v1.cri".containerd.runtimes.runc.options]<br/>    SystemdCgroup = true # &lt;--- This line<br/>&lt;...&gt;</span></pre><p id="4be3" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">重新启动容器d</p><pre class="ks kt ku kv fd kw kk kx ky aw kz bi"><span id="c387" class="la lb hi kk b fi lc ld l le lf">systemctl restart containerd</span></pre><p id="8c36" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">通过添加容器运行时标志来编辑<code class="du kh ki kj kk b">/var/lib/kubelet/kubeadm-flags.env</code>文件</p><ul class=""><li id="202c" class="jt ju hi ix b iy iz jc jd jg jv jk jw jo jx js jy jz ka kb bi translated"><code class="du kh ki kj kk b">--container-runtime=remote</code></li><li id="3a8c" class="jt ju hi ix b iy kc jc kd jg ke jk kf jo kg js jy jz ka kb bi translated"><code class="du kh ki kj kk b">--container-runtime-endpoint=unix:///run/containerd/containerd.sock</code></li></ul><p id="fad9" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><code class="du kh ki kj kk b">kubeadm-flags.env</code>文件现在应该是这样的:</p><pre class="ks kt ku kv fd kw kk kx ky aw kz bi"><span id="dd54" class="la lb hi kk b fi lc ld l le lf">cat /var/lib/kubelet/kubeadm-flags.env <br/>KUBELET_KUBEADM_ARGS="--network-plugin=cni --pod-infra-container-image=k8s.gcr.io/pause:3.2 --container-runtime=remote --container-runtime-endpoint=unix:///run/containerd/containerd.sock"</span></pre><p id="a6a9" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">启动Kubelet</p><pre class="ks kt ku kv fd kw kk kx ky aw kz bi"><span id="3cc7" class="la lb hi kk b fi lc ld l le lf">systemctl start kubelet</span></pre><p id="4a5a" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">检查集群状态</p><pre class="ks kt ku kv fd kw kk kx ky aw kz bi"><span id="f13a" class="la lb hi kk b fi lc ld l le lf">NAME           STATUS                      ROLES                  AGE   VERSION   INTERNAL-IP    EXTERNAL-IP   OS-IMAGE             KERNEL-VERSION     CONTAINER-RUNTIME<br/>k8s-master-1   Ready                       control-plane,master   xxd   v1.20.6   xxx.xxx.x.xx   &lt;none&gt;        Ubuntu 20.04.x LTS   x.x.x-xx-generic   docker://19.03.6<br/>k8s-master-2   Ready                       control-plane,master   xxd   v1.20.6   xxx.xxx.x.xx   &lt;none&gt;        Ubuntu 20.04.x LTS   x.x.x-xx-generic   docker://19.03.6<br/>k8s-master-3   Ready                       control-plane,master   xxd   v1.20.6   xxx.xxx.x.xx   &lt;none&gt;        Ubuntu 20.04.x LTS   x.x.x-xx-generic   docker://19.03.6<br/>k8s-worker-1   Ready                       worker                 xxd   v1.20.6   xxx.xxx.x.xx   &lt;none&gt;        Ubuntu 20.04.x LTS   x.x.x-xx-generic   docker://19.03.6<br/>k8s-worker-2   Ready                       worker                 xxd   v1.20.6   xxx.xxx.x.xx   &lt;none&gt;        Ubuntu 20.04.x LTS   x.x.x-xx-generic   docker://19.03.6<br/>k8s-worker-3   Ready,SchedulingDisabled    worker                 xxd   v1.20.6   xxx.xxx.x.xx   &lt;none&gt;        Ubuntu 20.04.x LTS   x.x.x-xx-generic   containerd://1.4.4</span></pre><p id="eca2" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">正如你所看到的，这个工人开始使用<code class="du kh ki kj kk b">containerd</code>作为它的运行时。检查<code class="du kh ki kj kk b">daemonsets</code>是否运行正常。<code class="du kh ki kj kk b">Uncordon</code>一切看起来都很好的节点</p><pre class="ks kt ku kv fd kw kk kx ky aw kz bi"><span id="602a" class="la lb hi kk b fi lc ld l le lf">kubectl uncordon k8s-worker-3</span></pre><p id="79fd" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">对所有节点重复该过程(一个接一个)</p><h1 id="dc93" class="lg lb hi bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">迁移后</h1><p id="3385" class="pw-post-body-paragraph iv iw hi ix b iy md ja jb jc me je jf jg mf ji jj jk mg jm jn jo mh jq jr js hb bi translated">祝贺您将集群迁移到<code class="du kh ki kj kk b">containerd</code>。然而，要完全迁移，剩下的事情很少。让我们通过删除docker相关的文件夹来释放一些空间。不再需要它们了</p><pre class="ks kt ku kv fd kw kk kx ky aw kz bi"><span id="5f66" class="la lb hi kk b fi lc ld l le lf">rm -r /etc/docker<br/>rm -r /var/lib/docker<br/>rm -r /var/lib/dockershim</span></pre><p id="4f20" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">如果您使用<code class="du kh ki kj kk b">kubeadm</code>来管理集群初始化、加入和更新，您可能想要重新注释节点，这样在您下次更新时<code class="du kh ki kj kk b">kubeadm</code>就不会混淆您是使用<code class="du kh ki kj kk b">docker</code>还是<code class="du kh ki kj kk b">containterd</code>作为运行时:</p><pre class="ks kt ku kv fd kw kk kx ky aw kz bi"><span id="d7c0" class="la lb hi kk b fi lc ld l le lf">kubectl annotate node k8s-worker-3 --overwrite kubeadm.alpha.kubernetes.io/cri-socket=unix:///run/containerd/containerd.sock</span></pre><p id="d2e7" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">请注意，在将整个集群迁移到<code class="du kh ki kj kk b">containerd</code>并确保迁移成功后，必须在所有节点上执行删除和注释。</p></div></div>    
</body>
</html>