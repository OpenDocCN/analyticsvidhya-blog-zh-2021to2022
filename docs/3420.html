<html>
<head>
<title>Clearing the Black Box: Feature Importance with SHAP</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">清除黑匣子:SHAP的功能重要性</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/clearing-the-black-box-feature-importance-with-shap-afddfede5bf0?source=collection_archive---------8-----------------------#2021-06-30">https://medium.com/analytics-vidhya/clearing-the-black-box-feature-importance-with-shap-afddfede5bf0?source=collection_archive---------8-----------------------#2021-06-30</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/c5db871f2152ba9af15876c52a763386.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CHfbofmEuiMnM7JdVVAWZw.jpeg"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">安德里亚·皮亚卡迪奥在<a class="ae iu" href="https://www.pexels.com" rel="noopener ugc nofollow" target="_blank">像素</a>上拍摄的照片</figcaption></figure><h1 id="bd67" class="iv iw hi bd ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js bi translated">黑盒</h1><p id="dc83" class="pw-post-body-paragraph jt ju hi jv b jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq hb bi translated">机器和深度学习是创造预测的不可思议的工具。然而，随着它们变得越来越复杂，我们越来越不确定它们内部到底发生了什么。这就是“黑匣子”这个术语的由来。这是把一堆输入扔进一个盒子里，不知道里面发生了什么，然后让它抛出一个答案的想法。</p><p id="26a3" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">虽然收到回复是件好事，但具体发生了什么还不太清楚。例如，选择的特征如何影响模型？</p><p id="d28a" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">一个潜入黑盒子中寻找答案的图书馆是<a class="ae iu" href="https://github.com/slundberg/shap" rel="noopener ugc nofollow" target="_blank"> SHAP </a>。</p><h1 id="3cd1" class="iv iw hi bd ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js bi translated">管道和GridSearchCV的功能效果</h1><p id="31c4" class="pw-post-body-paragraph jt ju hi jv b jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq hb bi translated">我们在这个例子中要查看的数据集将是<a class="ae iu" href="https://www.kaggle.com/annavictoria/speed-dating-experiment" rel="noopener ugc nofollow" target="_blank">速配</a>上的<a class="ae iu" href="https://www.kaggle.com/" rel="noopener ugc nofollow" target="_blank"> Kaggle </a>数据集。我们将查看约会前获得的用户信息，以了解这些因素如何影响一个人是否约会的决定。</p><p id="6f6a" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">清理完数据后，我们将建立一个管道和GridSearch来测试几个逻辑回归超参数，并返回最佳模型。</p><figure class="kx ky kz la fd ij er es paragraph-image"><div class="er es kw"><img src="../Images/f1aa5b4d7215f8448b1b1697e9a3fc17.png" data-original-src="https://miro.medium.com/v2/resize:fit:1060/format:webp/1*DWg6Hjt0f0E_LlG3vS230g.png"/></div></figure><p id="f142" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">太好了！我们运行这个来缩放我们的数据，并找到用于逻辑回归模型的最佳参数。现在，也许我们要对每个特征如何影响目标做出推论。我们能从逻辑回归模型中得出什么？</p><p id="100b" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">系数！逻辑回归为每个特征分配一个系数，作为其在模型中的影响。在这里，我们提取这些值:</p><figure class="kx ky kz la fd ij er es paragraph-image"><div class="er es lb"><img src="../Images/8e78321e7cc041c7248476e97e578d06.png" data-original-src="https://miro.medium.com/v2/resize:fit:1084/format:webp/1*1cW1P-8mKN9Rmo4hPxsBIA.png"/></div><figcaption class="iq ir et er es is it bd b be z dx translated">检索系数</figcaption></figure><p id="66a1" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">好的，很好，我们有系数了。但是它们是什么意思呢？问题就在这里。这些系数表示该特征在模型<em class="lc">中相对于其他特征</em>的影响。这意味着添加或移除特征将改变这些系数，可能从正变为负。那么我们能看到什么呢？</p><p id="547d" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">我们唯一能从中看出的是系数的影响大小(系数的大小)以及它的方向(负的或正的)。但是，这都与模型中的每个特征有关。最后，我们对这些特性没有多少了解。</p><p id="4799" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">这就是SHAP的用武之地。</p><h1 id="f883" class="iv iw hi bd ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js bi translated">SHAP特色解说</h1><p id="c2ec" class="pw-post-body-paragraph jt ju hi jv b jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq hb bi translated">关于什么是SHAP值的解释可以在<a class="ae iu" href="https://christophm.github.io/interpretable-ml-book/shapley.html" rel="noopener ugc nofollow" target="_blank">这里</a>找到。但是，作为一个简单的解释，它通过查看与其他特征组合时的效果差异来计算该特征对目标的效果。</p><p id="b7e0" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">在我们的数据集的情况下，这将是一个特征对一个人是否同意约会的平均贡献。</p><p id="63d4" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">首先，我们检索SHAP值。</p><figure class="kx ky kz la fd ij er es paragraph-image"><div class="er es ld"><img src="../Images/ddbda901c0b174bdc624756ac43592a0.png" data-original-src="https://miro.medium.com/v2/resize:fit:784/format:webp/1*zUIMXEghtYj0RauYOpmtfA.png"/></div><figcaption class="iq ir et er es is it bd b be z dx translated">检索SHAP值</figcaption></figure><p id="ffab" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">注意:第一个参数是您的模型。在本例中，我们使用了GridSearchCV和管道。以下步骤解释了如何检索模型:</p><figure class="kx ky kz la fd ij er es paragraph-image"><div class="er es le"><img src="../Images/c1b1f6549883d3207db8dae0e66735ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:750/format:webp/1*d-UWKiNHVBaikGLzTDCXCw.png"/></div><figcaption class="iq ir et er es is it bd b be z dx translated">从GridSearchCV中检索最佳模型</figcaption></figure><p id="74dd" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">现在已经检索了SHAP值，我们可以看一下特征。</p><figure class="kx ky kz la fd ij er es paragraph-image"><div class="er es lf"><img src="../Images/3e7b01df66fd76cbf2f9104ce86e9967.png" data-original-src="https://miro.medium.com/v2/resize:fit:1274/format:webp/1*MEibLpVYiZIO98FtQrY42w.png"/></div></figure><p id="a69a" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">首先要注意的是，除了SHAP值(一种评估特性影响的方法)之外，我们还可以看到特性的价值。因此，我们可以看到特性本身的价值如何影响模型。</p><p id="cb1e" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">此外，功能按影响顺序列出。所以对于这个模型，attr2_1对Logistic回归模型的影响最大。</p><p id="e593" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">我们来看看前三个怎么样？</p><figure class="kx ky kz la fd ij er es paragraph-image"><div class="er es lg"><img src="../Images/f76101b8f988e490d558ecf92862d367.png" data-original-src="https://miro.medium.com/v2/resize:fit:1258/format:webp/1*RDSCxvdDLHqyFLxhzk9b2A.png"/></div></figure><p id="d8f5" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">首先，所有特性都以字符串“attr”开头在这些调查中，所有三栏都与身体吸引力有关。</p><p id="c23a" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">Attr2_1代表了个体认为异性如何看待身体吸引力。较高的评级表示较高的重要性。</p><p id="2533" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">由此，我们可以看出，人们越相信身体吸引力的重要性，他们就越有可能同意和某人约会。</p><p id="6780" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">另一方面，attr1_1和attr4_1分别是个人对身体吸引力的重要程度，以及个人认为大多数其他人寻找的东西。</p><p id="caad" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">我们可以看到，评分越低，模型就越倾向于预测个人会拒绝约会。</p><p id="0830" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">事实上，回到图像:</p><figure class="kx ky kz la fd ij er es paragraph-image"><div class="er es lf"><img src="../Images/3e7b01df66fd76cbf2f9104ce86e9967.png" data-original-src="https://miro.medium.com/v2/resize:fit:1274/format:webp/1*MEibLpVYiZIO98FtQrY42w.png"/></div></figure><p id="e3e4" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">我们可以看到，在前九个特性中,“2_1”部分出现得相当多。尽管该模型包含人们所寻找的属性评级，但该模型更受人们认为异性所寻找的属性评级的影响，正如数据的关键所示。</p><h1 id="6a39" class="iv iw hi bd ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js bi translated">洞察力</h1><p id="5b16" class="pw-post-body-paragraph jt ju hi jv b jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq hb bi translated">与查看系数列表相比，我们可以从SHAP的一个方面获得更多的洞察力。</p><p id="36bc" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">SHAP的力量不仅用于机器学习算法。它也可以用于深度学习，包括使用Keras进行图像识别。</p><figure class="kx ky kz la fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lh"><img src="../Images/46b88a746f7e715c1c6f01ed82b4c139.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OsqyFGmyr9lLE1kj7F5tTA.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">SHAP用来自<a class="ae iu" href="https://github.com/slundberg/shap" rel="noopener ugc nofollow" target="_blank"> SHAP仓库</a>的图像识别</figcaption></figure><p id="b932" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">在这里，我们可以看到Keras用来区分这两种动物的不同方面。</p><p id="c7eb" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">这凸显了SHAP的多面性。能够查看哪些特征(甚至是图像中的特征)是最重要的，这允许用户更好地量化他们的结果。</p><p id="5cd6" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">以下是可用于深入了解SHAP的资源:</p><ul class=""><li id="f85a" class="li lj hi jv b jw kr ka ks ke lk ki ll km lm kq ln lo lp lq bi translated"><a class="ae iu" href="https://github.com/slundberg/shap" rel="noopener ugc nofollow" target="_blank"> SHAP知识库</a></li><li id="64fb" class="li lj hi jv b jw lr ka ls ke lt ki lu km lv kq ln lo lp lq bi translated"><a class="ae iu" href="https://christophm.github.io/interpretable-ml-book/shap.html" rel="noopener ugc nofollow" target="_blank"> SHAP文档</a></li></ul></div></div>    
</body>
</html>